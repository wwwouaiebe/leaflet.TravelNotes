/**
 * 
 * @source: https://github.com/wwwouaiebe/leaflet.TravelNotes
 * 
 * @licstart  The following is the entire license notice for the
 * JavaScript code in this page.
 * 
 * leaflet.travelnotes - version 1.13.0
 * Build 00637 - 2020-12-20T13:11:07+0100 
 * Copyright 2017 2020 wwwouaiebe 
 * Contact: https://www.ouaie.be/
 * License: GPL-3.0
 * 
 * The JavaScript code in this page is free software: you can
 * redistribute it and/or modify it under the terms of the GNU
 * General Public License (GNU GPL) as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option)
 * any later version.  The code is distributed WITHOUT ANY WARRANTY;
 * without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.
 * 
 * As additional permission under GNU GPL version 3 section 7, you
 * may distribute non-source (e.g., minimized or compacted) forms of
 * that code without the copy of the GNU GPL normally required by
 * section 4, provided you include this license notice and a URL
 * through which recipients can access the Corresponding Source.
 * 
 * @licend  The above is the entire license notice
 * for the JavaScript code in this page.
 * 
 */


!function(){"use strict";
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file Config.js
	@copyright Copyright - 2017 2020 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/let e={autoLoad:!1,haveGlobals:!1,map:{center:{lat:50.50923,lng:5.49542},zoom:12},travelNotesToolbarUI:{contactMail:"https://github.com/wwwouaiebe/leaflet.TravelNotes/issues"},layersToolbarUI:{haveLayersToolbarUI:!0,toolbarTimeOut:1500,contactMail:"https://github.com/wwwouaiebe/leaflet.TravelNotes/issues",theDevil:{addButton:!1,title:"Reminder! The devil will know everything about you",text:"&#x1f47f;"}},mouseUI:{haveMouseUI:!0},errorUI:{timeOut:1e4,helpTimeOut:3e4,showError:!0,showWarning:!0,showInfo:!0,showHelp:!0},geoLocation:{color:"red",radius:11,zoomToPosition:!0,zoomFactor:17,options:{enableHighAccuracy:!1,maximumAge:0,timeout:1/0}},APIKeys:{showDialogButton:!0,saveToSessionStorage:!0,showAPIKeysInDialog:!0,dialogHaveUnsecureButtons:!0},contextMenu:{timeout:1500},routing:{auto:!0},language:"fr",itineraryPointMarker:{color:"red",weight:2,radius:7,fill:!1},searchPointMarker:{color:"green",weight:4,radius:20,fill:!1},searchPointPolyline:{color:"green",weight:4,radius:20,fill:!1},previousSearchLimit:{color:"green",fill:!1,weight:1},nextSearchLimit:{color:"red",fill:!1,weight:1},wayPoint:{reverseGeocoding:!1},route:{color:"#ff0000",width:3,dashArray:0,dashChoices:[{text:"——————",iDashArray:null},{text:"— — — — —",iDashArray:[4,2]},{text:"—‧—‧—‧—‧—",iDashArray:[4,2,0,2]},{text:"················",iDashArray:[0,2]}],elev:{smooth:!0,smoothCoefficient:.25,smoothPoints:3},showDragTooltip:3},note:{osmSearchNoteDialog:!1,reverseGeocoding:!1,grip:{size:10,opacity:0,moveOpacity:1},polyline:{color:"gray",weight:1},haveBackground:!1,style:"",svgIconWidth:200,svgAnleMaxDirection:{right:35,slightRight:80,continue:100,slightLeft:145,left:200,sharpLeft:270,sharpRight:340},svgZoom:17,svgAngleDistance:10,svgHamletDistance:200,svgVillageDistance:400,svgCityDistance:1200,svgTownDistance:1500,svgTimeOut:15e3,cityPrefix:'<span class="TravelNotes-NoteHtml-Address-City">',cityPostfix:"</span>",maxManeuversNotes:100},itineraryPointZoom:17,routeEditor:{displayEditionInHTMLPage:!0},travelEditor:{clearAfterSave:!0,startMinimized:!0,timeout:1e3,startupRouteEdition:!0},haveBeforeUnloadWarning:!0,overpassApiUrl:"https://lz4.overpass-api.de/api/interpreter",nominatim:{url:"https://nominatim.openstreetmap.org/",language:"*"},printRouteMap:{isEnabled:!0,maxTiles:240,paperWidth:287,paperHeight:200,pageBreak:!1,printNotes:!0,borderWidth:30,zoomFactor:15,entryPointMarker:{color:"green",weight:4,radius:10,fill:!0,fillOpacity:1},exitPointMarker:{color:"red",weight:4,radius:10,fill:!0,fillOpacity:1}},haveCrypto:!1,itineraryPane:{showNotes:!0,showManeuvers:!1},colorDialog:{haveSlider:!0,initialRed:0}};let t=new class{get autoLoad(){return e.autoLoad}get haveGlobals(){return e.haveGlobals}get map(){return e.map}get travelNotesToolbarUI(){return e.travelNotesToolbarUI}get layersToolbarUI(){return e.layersToolbarUI}get mouseUI(){return e.mouseUI}get errorUI(){return e.errorUI}get APIKeys(){return e.APIKeys}get contextMenu(){return e.contextMenu}get routing(){return e.routing}get language(){return e.language}get itineraryPointMarker(){return e.itineraryPointMarker}get searchPointMarker(){return e.searchPointMarker}get searchPointPolyline(){return e.searchPointPolyline}get previousSearchLimit(){return e.previousSearchLimit}get nextSearchLimit(){return e.nextSearchLimit}get wayPoint(){return e.wayPoint}get route(){return e.route}get note(){return e.note}get itineraryPointZoom(){return e.itineraryPointZoom}get routeEditor(){return e.routeEditor}get travelEditor(){return e.travelEditor}get haveBeforeUnloadWarning(){return e.haveBeforeUnloadWarning}get overpassApiUrl(){return e.overpassApiUrl}get nominatim(){return e.nominatim}get geoLocation(){return e.geoLocation}get printRouteMap(){return e.printRouteMap}get haveCrypto(){return e.haveCrypto}get itineraryPane(){return e.itineraryPane}get colorDialog(){return e.colorDialog}overload(t){!function e(t,a){if("object"==typeof t&&"object"==typeof a)try{for(let o in a)"object"==typeof a[o]?e(t[o],a[o]):a[o]=t[o]||a[o];for(let o in t)"object"==typeof t[o]?("[object Array]"===Object.prototype.toString.call(t[o])?a[o]=a[o]||[]:a[o]=a[o]||{},e(t[o],a[o])):a[o]=t[o]}catch(e){console.log(e||"Not possible to overload Config")}}(t,e),e=function e(t){for(let a in t)"object"==typeof t[a]&&(t[a]=e(t[a]));return Object.freeze(t)}(e)}};
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file HTMLElementsFactory.js
	@copyright Copyright - 2017 2020 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/const a=Object.freeze(new class{create(e,t,a){let o=null;return"text"===e.toLowerCase()?o=document.createTextNode(t.value||""):(o=document.createElement(e),t&&function(e,t){for(let a in t)try{e[a]=t[a]}catch(e){console.log("Invalid property : "+a)}}(o,t)),a&&a.appendChild(o),o}});const o=Object.freeze(new
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file HttpRequestBuilder.js
	@copyright Copyright - 2017 2020 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/
class{getTextPromise(e,t){return new Promise((function(a,o){let n=new XMLHttpRequest;n.timeout=4e4,n.ontimeout=function(){o("XMLHttpRequest TimeOut. File : "+n.responseURL)},n.onreadystatechange=function(){4===n.readyState&&(200===n.status?a(n.responseText):o("Error XMLHttpRequest - File : "+n.responseURL))},n.open("GET",e,!0),t&&t.forEach(e=>n.setRequestHeader(e.headerName,e.headerValue)),n.overrideMimeType("text/plain"),n.send(null)}))}getJsonPromise(e,t){return new Promise((function(a,o){let n=new XMLHttpRequest;n.timeout=4e4,n.ontimeout=function(){o("XMLHttpRequest TimeOut. File : "+n.responseURL)},n.onreadystatechange=function(){if(4===n.readyState)if(200===n.status){let e=null;try{e=JSON.parse(n.responseText)}catch(e){o(e.message+" File: "+n.responseURL)}a(e)}else o("Error XMLHttpRequest - File : "+n.responseURL)},n.open("GET",e,!0),t&&t.forEach(e=>n.setRequestHeader(e.headerName,e.headerValue)),n.overrideMimeType("application/json"),n.send(null)}))}getBinaryPromise(e,t){return new Promise((function(a,o){let n=new XMLHttpRequest;n.timeout=4e4,n.ontimeout=function(){o("XMLHttpRequest TimeOut. File : "+n.responseURL)},n.onload=function(){if(200===n.status){let e=n.response;e?a(e):o("Error XMLHttpRequest - File : "+n.responseURL)}else o("Error XMLHttpRequest - File : "+n.responseURL)},n.open("GET",e,!0),t&&t.forEach(e=>n.setRequestHeader(e.headerName,e.headerValue)),n.responseType="arraybuffer",n.send(null)}))}}),n=Object.freeze({fixed:2,invalid:-1,defaultValue:0}),r=Object.freeze({refusedByUser:-1,disabled:0,inactive:1,active:2}),i=Object.freeze({invalidPane:"43a6a53e-008a-4910-80a6-7a87d301ea15",itineraryPane:"8fbf0da7-4e6f-4bc7-8e20-1388461ccde7",travelNotesPane:"dffe782b-07df-4b81-a318-f287c0cf5ec6",searchPane:"228f00d7-43a8-4c13-897d-70400cb6dd58"}),l=Object.freeze({fixed:2,defaultValue:0}),s=Object.freeze({defaultValue:0,fixed:6}),d=Object.freeze({notEdited:0,editedNoChange:1,editedChanged:2}),c=Object.freeze({margin:100,height:500,width:1e3,yDeltaText:30,xDeltaText:10,vScales:[1,2,5,10,20,50,100,200,500,1e3,2e3,5e3],hScales:[1,2,5,10,20,50,100,200,500,1e3,2e3,5e3,1e4,2e4,5e4,1e5]}),u=Object.freeze({width:40,height:40}),g=[.3,10,1];
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file Constants.js
	@copyright Copyright - 2017 2020 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/let v=0;function p(){return++v,v}
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file Version.js
	@copyright Copyright - 2017 2020 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/function h(e){const t=e;return Object.seal(new class{get name(){return t}get version(){return"1.13.0"}get jsonObject(){return{name:t,version:"1.13.0"}}validate(e){if(!Object.getOwnPropertyNames(e).includes("name"))throw new Error("No name for "+t);if(t!==e.name)throw new Error("Invalid name for "+t);if(!Object.getOwnPropertyNames(e).includes("version"))throw new Error("No version for "+t)}})}function m(e){const t=e;let a=[];const o=function(){let e=t();if(!e.objType||!e.objType.name)throw new Error("invalid object name for collection");return e.objType.name}();function n(e){if(!e.objType||!e.objType.name||e.objType.name!==o)throw new Error("invalid object name for add function");a.push(e)}function r(){let e=-1;return Object.seal({get value(){return e<a.length?a[e]:null},get previous(){return 0>=e?null:a[e-1]},get next(){return e<a.length-1?a[e+1]:null},get done(){return++e>=a.length},get first(){return 0===e},get last(){return e>=a.length-1},get index(){return e}})}function i(e){return a.findIndex(t=>t.objId===e)}function l(e,t,o){let n=i(e);if(-1===n)throw new Error("invalid objId for next or previous function");if(1!==o&&-1!==o)throw new Error("invalid direction");let r=t;for(r||(r=()=>!0),n+=o;-1<n&&n<a.length&&!r(a[n]);)n+=o;return-1===n||a.length===n?null:a[n]}return Object.seal(new class{add(e){n(e)}forEach(e){let t=null,a=r();for(;!a.done;)t=e(a.value,t);return t}getAt(e){let t=i(e);return-1===t?null:a[t]}moveTo(e,t,o){let n=i(e),r=i(t);if(-1===n||-1===r)throw new Error("invalid objId for function  myMoveTo");o||r++,a.splice(r,0,a[n]),r<n&&n++,a.splice(n,1)}next(e,t){return l(e,t,1)}previous(e,t){return l(e,t,-1)}remove(e){if(-1===i(e))throw new Error("invalid objId for remove function");a.splice(i(e),1)}removeAll(e){e?a.splice(1,a.length-2):a.length=0}replace(e,t){let n=i(e);if(-1===n)throw new Error("invalid objId for replace function");if(!t.objType||!t.objType.name||t.objType.name!==o)throw new Error("invalid object name for replace function");a[n]=t}reverse(){a.reverse()}sort(e){a.sort(e)}swap(e,t){let o=i(e);if(-1===o||0===o&&t||a.length-1===o&&!t)throw new Error("invalid objId for swap function");let n=a[o];a[o]=a[o+(t?-1:1)],a[o+(t?-1:1)]=n}get first(){return a[0]}get iterator(){return r()}get last(){return a[a.length-1]}get length(){return a.length}get jsonObject(){let e=[],t=r();for(;!t.done;)e.push(t.value.jsonObject);return e}set jsonObject(e){a.length=0;let o=null;e.forEach(e=>{o=t(),o.jsonObject=e,n(o)})}})}
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file Translator.js
	@copyright Copyright - 2017 2020 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/let f=new Map;const b=Object.freeze(new class{setTranslations(e){e.forEach(e=>f.set(e.msgid,e.msgstr))}getText(e,t){let a=f.get(e);return t&&a&&Object.getOwnPropertyNames(t).forEach(e=>a=a.replace("{"+e+"}",t[e])),a||e}});const y=Object.freeze(new class{get UUID(){let e=new Uint16Array(8);const t=["","-","-","-","-","","",""];window.crypto.getRandomValues(e);let a="";for(let o=0;o<8;o++)a+=e[o].toString(16).padStart(4,"0")+t[o];return a}storageAvailable(e){try{let t=window[e],a="__storage_test__";return t.setItem(a,a),t.removeItem(a),!0}catch(e){return!1}}saveFile(e,t,a){try{let o=window.URL.createObjectURL(new File([t],e,{type:a||"text/plain"})),n=document.createElement("a");n.setAttribute("href",o),n.setAttribute("download",e),n.click(),window.URL.revokeObjectURL(o)}catch(e){console.log(e||"An error occurs when saving file")}}formatTime(e){let t=Math.floor(e);if(0===t)return"";let a=Math.floor(t/86400),o=Math.floor(t%86400/3600),n=Math.floor(t%3600/60),r=Math.floor(t%60);return 0<a?a+" "+b.getText("Utilities - Day")+" "+o+" "+b.getText("Utilities - Hour"):0<o?o+" "+b.getText("Utilities - Hour")+" "+n+" "+b.getText("Utilities - Minute"):0<n?n+" "+b.getText("Utilities - Minute"):r+" "+b.getText("Utilities - Second")}formatDistance(e){let t=Math.floor(e);return 0>=t?"0 km":Math.floor(t/1e3)+","+Math.floor(t%1e3/10).toFixed(0).padStart(2,"0").padEnd(3,"0")+" km"}formatLat(e){return e>0?e.toFixed(s.fixed)+" N":(-e).toFixed(s.fixed)+" S"}formatLng(e){return e>0?e.toFixed(s.fixed)+" E":(-e).toFixed(s.fixed)+" W"}formatLatLng(e){return 0===e[0]&&0===e[1]?"":this.formatLat(e[0])+" - "+this.formatLng(e[1])}}),T=h("WayPoint"),N=new WeakMap;class w{constructor(){this.name="",this.address="",this.lat=s.defaultValue,this.lng=s.defaultValue,N.set(this,p())}get fullName(){let e=""===this.name?this.address:this.name+", "+this.address;return""===e&&(e=y.formatLatLng([this.lat,this.lng])),e}get latLng(){return[this.lat,this.lng]}set latLng(e){this.lat=e[0],this.lng=e[1]}get objId(){return N.get(this)}get objType(){return T}get jsonObject(){return{name:this.name,address:this.address,lat:parseFloat(this.lat.toFixed(s.fixed)),lng:parseFloat(this.lng.toFixed(s.fixed)),objId:N.get(this),objType:T.jsonObject}}set jsonObject(e){let t=function(e){if(!Object.getOwnPropertyNames(e).includes("objType"))throw new Error("No objType for "+T.name);if(T.validate(e.objType),T.version!==e.objType.version)switch(e.objType.version){case"1.0.0":case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":case"1.5.0":case"1.6.0":case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":e.address=e.name,e.name="";case"1.12.0":e.objType.version="1.13.0";break;default:throw new Error("invalid version for "+T.name)}let t=Object.getOwnPropertyNames(e);return["address","name","lat","lng","objId"].forEach(e=>{if(!t.includes(e))throw new Error("No "+e+" for "+T.name)}),e}(e);this.address=t.address||"",this.name=t.name||"",this.lat=t.lat||s.defaultValue,this.lng=t.lng||s.defaultValue,N.set(this,p())}}function I(){return Object.seal(new w)}const x=h("ItineraryPoint"),A=new WeakMap;class j{constructor(){this.lat=s.defaultValue,this.lng=s.defaultValue,this.distance=n.defaultValue,this.elev=l.defaultValue,A.set(this,p())}get latLng(){return[this.lat,this.lng]}set latLng(e){this.lat=e[0],this.lng=e[1]}get objType(){return x}get objId(){return A.get(this)}get jsonObject(){return{lat:parseFloat(this.lat.toFixed(s.fixed)),lng:parseFloat(this.lng.toFixed(s.fixed)),distance:parseFloat(this.distance.toFixed(n.fixed)),elev:parseFloat(this.elev.toFixed(l.fixed)),objId:A.get(this),objType:x.jsonObject}}set jsonObject(e){let t=function(e){if(!Object.getOwnPropertyNames(e).includes("objType"))throw new Error("No objType for "+x.name);if(x.validate(e.objType),x.version!==e.objType.version)switch(e.objType.version){case"1.0.0":case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":case"1.5.0":case"1.6.0":e.elev=l.defaultValue;case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":case"1.12.0":e.objType.version="1.13.0";break;default:throw new Error("invalid version for "+x.name)}let t=Object.getOwnPropertyNames(e);return["lat","lng","distance","elev","objId"].forEach(e=>{if(!t.includes(e))throw new Error("No "+e+" for "+x.name)}),e}(e);this.lat=t.lat||s.defaultValue,this.lng=t.lng||s.defaultValue,this.distance=t.distance||n.defaultValue,this.elev=t.elev||l.defaultValue,A.set(this,p())}}function P(){return Object.seal(new j)}const E=h("Maneuver"),M=new WeakMap;class D{constructor(){this.iconName="",this.instruction="",this.itineraryPointObjId=-1,this.distance=n.defaultValue,this.duration=n.defaultValue,M.set(this,p())}get objType(){return E}get objId(){return M.get(this)}get jsonObject(){return{iconName:this.iconName,instruction:this.instruction,distance:parseFloat(this.distance.toFixed(n.fixed)),duration:this.duration,itineraryPointObjId:this.itineraryPointObjId,objId:M.get(this),objType:E.jsonObject}}set jsonObject(e){let t=function(e){if(!Object.getOwnPropertyNames(e).includes("objType"))throw new Error("No objType for "+E.name);if(E.validate(e.objType),E.version!==e.objType.version)switch(e.objType.version){case"1.0.0":case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":case"1.5.0":case"1.6.0":case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":"kArriveDefault"===e.iconName&&(e.distance=n.defaultValue);case"1.12.0":e.objType.version="1.13.0";break;default:throw new Error("invalid version for "+E.name)}let t=Object.getOwnPropertyNames(e);return["iconName","instruction","distance","duration","itineraryPointObjId","objId"].forEach(e=>{if(!t.includes(e))throw new Error("No "+e+" for "+E.name)}),e}(e);this.iconName=t.iconName||"",this.instruction=t.instruction||"",this.distance=t.distance||n.defaultValue,this.duration=t.duration||n.defaultValue,this.itineraryPointObjId=t.itineraryPointObjId||-1,M.set(this,p())}}function R(){return Object.seal(new D)}const O=h("Itinerary"),C=new WeakMap;class S{constructor(){this.hasProfile=!1,this.ascent=0,this.descent=0,this.provider="",this.transitMode="",this.itineraryPoints=m(P),this.maneuvers=m(R),C.set(this,p())}get objType(){return O}get objId(){return C.get(this)}get jsonObject(){return{hasProfile:this.hasProfile,ascent:this.ascent,descent:this.descent,itineraryPoints:this.itineraryPoints.jsonObject,maneuvers:this.maneuvers.jsonObject,provider:this.provider,transitMode:this.transitMode,objId:C.get(this),objType:O.jsonObject}}set jsonObject(e){let t=function(e){if(!Object.getOwnPropertyNames(e).includes("objType"))throw new Error("No objType for "+O.name);if(O.validate(e.objType),O.version!==e.objType.version)switch(e.objType.version){case"1.0.0":case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":case"1.5.0":case"1.6.0":e.hasProfile=!1,e.ascent=0,e.descent=0;case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":case"1.12.0":e.objType.version="1.13.0";break;default:throw new Error("invalid version for "+O.name)}let t=Object.getOwnPropertyNames(e);return["hasProfile","ascent","descent","itineraryPoints","maneuvers","provider","transitMode","objId"].forEach(e=>{if(!t.includes(e))throw new Error("No "+e+" for "+O.name)}),e}(e);this.hasProfile=t.hasProfile||!1,this.ascent=t.ascent||0,this.descent=t.descent||0,this.itineraryPoints.jsonObject=t.itineraryPoints||[],this.maneuvers.jsonObject=t.maneuvers||[],this.provider=t.provider||"",this.transitMode=t.transitMode||"",C.set(this,p());let a=new Map,o=0,n=this.itineraryPoints.iterator;for(;!n.done;)a.set(t.itineraryPoints[o].objId,n.value.objId),o++;let r=this.maneuvers.iterator;for(;!r.done;)r.value.itineraryPointObjId=a.get(r.value.itineraryPointObjId)}}function U(){return Object.seal(new S)}const k=h("Note"),H=new WeakMap;class B{constructor(){this.iconHeight=0,this.iconWidth=0,this.iconContent="",this.popupContent="",this.tooltipContent="",this.phone="",this.url="",this.address="",this.iconLat=s.defaultValue,this.iconLng=s.defaultValue,this.lat=s.defaultValue,this.lng=s.defaultValue,this.distance=n.invalid,this.chainedDistance=n.defaultValue,H.set(this,p())}get isRouteNote(){return this.distance!==n.invalid}get iconLatLng(){return[this.iconLat,this.iconLng]}set iconLatLng(e){this.iconLat=e[0],this.iconLng=e[1]}get latLng(){return[this.lat,this.lng]}set latLng(e){this.lat=e[0],this.lng=e[1]}get objType(){return k}get objId(){return H.get(this)}get jsonObject(){return{iconHeight:this.iconHeight,iconWidth:this.iconWidth,iconContent:this.iconContent,popupContent:this.popupContent,tooltipContent:this.tooltipContent,phone:this.phone,url:this.url,address:this.address,iconLat:parseFloat(this.iconLat.toFixed(s.fixed)),iconLng:parseFloat(this.iconLng.toFixed(s.fixed)),lat:parseFloat(this.lat.toFixed(s.fixed)),lng:parseFloat(this.lng.toFixed(s.fixed)),distance:parseFloat(this.distance.toFixed(n.fixed)),chainedDistance:parseFloat(this.chainedDistance.toFixed(n.fixed)),objId:H.get(this),objType:k.jsonObject}}set jsonObject(e){let t=function(e){if(!Object.getOwnPropertyNames(e).includes("objType"))throw new Error("No objType for "+k.name);if(k.validate(e.objType),k.version!==e.objType.version)switch(e.objType.version){case"1.0.0":case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":case"1.5.0":case"1.6.0":case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":case"1.12.0":e.objType.version="1.13.0";break;default:throw new Error("invalid version for "+k.name)}let t=Object.getOwnPropertyNames(e);return["iconHeight","iconWidth","iconContent","popupContent","tooltipContent","phone","url","address","iconLat","iconLng","lat","lng","distance","chainedDistance","objId"].forEach(e=>{if(!t.includes(e))throw new Error("No "+e+" for "+k.name)}),e}(e);this.iconHeight=t.iconHeight||0,this.iconWidth=t.iconWidth||0,this.iconContent=t.iconContent||"",this.popupContent=t.popupContent||"",this.tooltipContent=t.tooltipContent||"",this.phone=t.phone||"",this.url=t.url||"",this.address=t.address||"",this.iconLat=t.iconLat||s.defaultValue,this.iconLng=t.iconLng||s.defaultValue,this.lat=t.lat||s.defaultValue,this.lng=t.lng||s.defaultValue,this.distance=t.distance||n.invalid,this.chainedDistance=t.chainedDistance,H.set(this,p())}}function F(){return Object.seal(new B)}const V=h("Route"),W=new WeakMap;class z{constructor(){this.name="",this.wayPoints=m(I),this.wayPoints.add(I()),this.wayPoints.add(I()),this.notes=m(F),this.itinerary=U(),this.width=t.route.width,this.color=t.route.color,this.dashArray=t.route.dashArray,this.chain=!1,this.chainedDistance=n.defaultValue,this.distance=n.defaultValue,this.duration=n.defaultValue,this.editionStatus=d.notEdited,this.hidden=!1,W.set(this,p())}get computedName(){let e=this.name;return""===e&&(e=(""===this.wayPoints.first.fullName?"???":this.wayPoints.first.fullName)+" ⮞ "+(""===this.wayPoints.last.fullName?"???":this.wayPoints.last.fullName)),e}get objId(){return W.get(this)}get objType(){return V}get jsonObject(){return{name:this.name,wayPoints:this.wayPoints.jsonObject,notes:this.notes.jsonObject,itinerary:this.itinerary.jsonObject,width:this.width,color:this.color,dashArray:this.dashArray,chain:this.chain,distance:parseFloat(this.distance.toFixed(n.fixed)),duration:this.duration,editionStatus:this.editionStatus,hidden:this.hidden,chainedDistance:parseFloat(this.chainedDistance.toFixed(n.fixed)),objId:W.get(this),objType:V.jsonObject}}set jsonObject(e){let a=function(e){if(!Object.getOwnPropertyNames(e).includes("objType"))throw new Error("No objType for "+V.name);if(V.validate(e.objType),V.version!==e.objType.version)switch(e.objType.version){case"1.0.0":e.dashArray=0,e.hidden=!1;case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":e.edited=d.notEdited;case"1.5.0":case"1.6.0":case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":e.editionStatus=e.edited;case"1.12.0":e.objType.version="1.13.0";break;default:throw new Error("invalid version for "+V.name)}let t=Object.getOwnPropertyNames(e);return["name","wayPoints","notes","itinerary","width","color","dashArray","chain","distance","duration","editionStatus","hidden","chainedDistance","objId"].forEach(e=>{if(!t.includes(e))throw new Error("No "+e+" for "+V.name)}),e}(e);this.name=a.name||"",this.wayPoints.jsonObject=a.wayPoints||[],this.notes.jsonObject=a.notes||[],this.itinerary.jsonObject=a.itinerary||U().jsonObject,this.width=a.width||t.route.width,this.color=a.color||"#000000",this.dashArray=a.dashArray||0,this.chain=a.chain||!1,this.distance=a.distance,this.duration=a.duration,this.editionStatus=a.editionStatus||d.notEdited,this.hidden=a.hidden||!1,this.chainedDistance=a.chainedDistance,W.set(this,p())}}function K(){return Object.seal(new z)}const X=h("Travel"),Z=new WeakMap;class G{constructor(){this.editedRoute=K(),this.routes=m(K),this.notes=m(F),this.layerName="OSM - Color",this.name="TravelNotes",this.readOnly=!1,this.userData={},Z.set(this,p())}get objId(){return Z.get(this)}get objType(){return X}get jsonObject(){return{editedRoute:this.editedRoute.jsonObject,layerName:this.layerName,name:this.name,routes:this.routes.jsonObject,notes:this.notes.jsonObject,userData:this.userData,readOnly:this.readOnly,objId:Z.get(this),objType:X.jsonObject}}set jsonObject(e){let t=function(e){if(!Object.getOwnPropertyNames(e).includes("objType"))throw new Error("No objType for "+X.name);if(X.validate(e.objType),X.version!==e.objType.version)switch(e.objType.version){case"1.0.0":case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":e.editedRoute=K();case"1.5.0":if(e.userData.layerId){let t=[{layerId:"0",layerName:"OSM - Color"},{layerId:"1",layerName:"OSM - Black and White"},{layerId:"2",layerName:"Thunderforest - Transport"},{layerId:"3",layerName:"Thunderforest - OpenCycleMap"},{layerId:"4",layerName:"Thunderforest - Outdoors"},{layerId:"5",layerName:"Esri - Aerial view"},{layerId:"6",layerName:"Kartverket - Norway"},{layerId:"7",layerName:"IGN-NGI - Belgium now"},{layerId:"12",layerName:"Thunderforest - Landscape"},{layerId:"24",layerName:"Lantmäteriet - Sweden"},{layerId:"25",layerName:"Maanmittauslaitos - Finland"}].find(t=>t.layerId===e.userData.layerId);e.layerName=t?t.layerName:"OSM - Color"}else e.layerName="OSM - Color";case"1.6.0":case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":case"1.12.0":e.objType.version="1.13.0";break;default:throw new Error("invalid version for "+X.name)}let t=Object.getOwnPropertyNames(e);return["name","editedRoute","routes","userData","objId"].forEach(e=>{if(!t.includes(e))throw new Error("No "+e+" for "+X.name)}),e}(e);this.editedRoute.jsonObject=t.editedRoute,this.layerName=e.layerName||"OSM - Color",this.name=t.name||"",this.userData=t.userData||{},this.readOnly=t.readOnly||!1,this.routes.jsonObject=t.routes||[],this.notes.jsonObject=t.notes||[],Z.set(this,p())}}function J(){return Object.seal(new G)}let Y=new Map,q=new Map,Q=Object.seal({provider:"",transitMode:""}),_=y.UUID;const $=Object.seal(new class{constructor(){this.map=null,this.travel=J(),this.editedRouteObjId=-1,this.searchData=[]}get providers(){return Y}get mapObjects(){return q}get routing(){return Q}get UUID(){return _}});function ee(){let e=0,t=0,o=0,n=0,r=0,i=0,l=null,s=null,d=null,c=null,u=null,g=null,v=null,p=null,h=null,m=null,f=null,y=null,T=null,N=!0,L=null,w=null,I=null;function x(e){N&&("Escape"===e.key||"Esc"===e.key?y.click():"Enter"===e.key&&f.click())}function A(a){o+=a.screenX-e,n+=a.screenY-t,o=Math.min(Math.max(o,20),r-d.clientWidth-20),n=Math.max(n,20);let l=i-Math.max(n,0)-20;d.setAttribute("style","top:"+n+"px;left:"+o+"px;max-height:"+l+"px;")}function j(a){try{a.dataTransfer.setData("Text","1")}catch(e){console.log(e)}e=a.screenX,t=a.screenY}function P(){document.removeEventListener("keydown",x,!0),document.querySelector("body").removeChild(l)}function E(){P(),I("Canceled by user")}function M(){let e=null;T&&(e=T(),!e)||(f.removeEventListener("click",M,!1),P(),w(e))}function D(e,t){w=e,I=t,document.querySelector("body").appendChild(l),document.addEventListener("keydown",x,!0),r=l.clientWidth,i=l.clientHeight,function(){o=(r-d.clientWidth)/2,n=(i-d.clientHeight)/2,o=Math.min(Math.max(o,20),r-d.clientWidth-20),n=Math.max(n,20);let e=i-Math.max(n,0)-20;d.setAttribute("style","top:"+n+"px;left:"+o+"px;max-height:"+e+"px;")}(),L&&L()}l=a.create("div",{className:"TravelNotes-Background"}),l.addEventListener("dragover",()=>null,!1),l.addEventListener("drop",()=>null,!1),d=a.create("div",{className:"TravelNotes-BaseDialog-Container"},l),s=a.create("div",{className:"TravelNotes-BaseDialog-TopBar",draggable:!0},d),s.addEventListener("dragstart",j,!1),s.addEventListener("dragend",A,!1),y=a.create("div",{innerHTML:"&#x274c",className:"TravelNotes-BaseDialog-CancelButton",title:b.getText("BaseDialog - Cancel")},s),y.addEventListener("click",E,!1),c=a.create("div",{className:"TravelNotes-BaseDialog-HeaderDiv"},d),u=a.create("div",{className:"TravelNotes-BaseDialog-ContentDiv"},d),g=a.create("div",{className:"TravelNotes-BaseDialog-ErrorDiv TravelNotes-BaseDialog-Hidden"},d),v=a.create("div",{className:"TravelNotes-BaseDialog-WaitDiv"},d),m=a.create("div",{className:"TravelNotes-WaitAnimationBullet TravelNotes-BaseDialog-Hidden"},h=a.create("div",{className:"TravelNotes-WaitAnimation TravelNotes-BaseDialog-Hidden"},v)),p=a.create("div",{className:"TravelNotes-BaseDialog-FooterDiv"},d),f=a.create("div",{innerHTML:"&#x1f197;",className:"TravelNotes-BaseDialog-Button"},p),f.addEventListener("click",M,!1);return Object.seal(new class{set okButtonListener(e){T=e}set keyboardEventListenerEnabled(e){N=e}set onShow(e){L=e}set title(e){c.innerHTML=e}get content(){return u}get footer(){return p}get okButton(){return f}get cancelButton(){return y}showError(e){g.innerHTML=e,g.classList.remove("TravelNotes-BaseDialog-Hidden")}hideError(){g.innerHTML="",g.classList.add("TravelNotes-BaseDialog-Hidden")}showWait(){m.classList.remove("TravelNotes-BaseDialog-Hidden"),h.classList.remove("TravelNotes-BaseDialog-Hidden"),f.classList.add("TravelNotes-BaseDialog-Hidden")}hideWait(){m.classList.add("TravelNotes-BaseDialog-Hidden"),h.classList.add("TravelNotes-BaseDialog-Hidden"),f.classList.remove("TravelNotes-BaseDialog-Hidden")}show(){return new Promise(D)}})}function te(e){let t=null,o=null,n=null;function r(){return t.hideError(),!e||!(n.value.length<12)&&n.value.match(RegExp("[0-9]+"))&&n.value.match(RegExp("[a-z]+"))&&n.value.match(RegExp("[A-Z]+"))&&n.value.match(RegExp("[^0-9a-zA-Z]"))?(new window.TextEncoder).encode(n.value):(t.showError(b.getText("PasswordDialog - Password rules")),void n.focus())}return t=ee(),t.title=b.getText("PasswordDialog - password"),t.okButtonListener=r,o=a.create("div",null,t.content),n=a.create("input",{type:"password"},o),t.onShow=function(){n.focus()},t}
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file DataEncryptor.js
	@copyright Copyright - 2017 2020 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/function ae(){function e(e){return window.crypto.subtle.importKey("raw",e,{name:"PBKDF2"},!1,["deriveKey"])}function t(e){return window.crypto.subtle.deriveKey({name:"PBKDF2",salt:(new window.TextEncoder).encode("Tire la chevillette la bobinette cherra. Le Petit Chaperon rouge tira la chevillette."),iterations:1e6,hash:"SHA-256"},e,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}return Object.freeze(new class{encryptData(a,o,n,r){!function(a,o,n,r){let i=window.crypto.getRandomValues(new Uint8Array(16));r.then(e).then(t).then((function(e){return window.crypto.subtle.encrypt({name:"AES-GCM",iv:i},e,a)})).then((function(e){o(new Blob([i,new Uint8Array(e)],{type:"application/octet-stream"}))})).catch(n)}(a,o,n,r)}decryptData(a,o,n,r){!function(a,o,n,r){r.then(e).then(t).then((function(e){return window.crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(a.slice(0,16))},e,new Uint8Array(a.slice(16)))})).then(o).catch(n)}(a,o,n,r)}})}let oe=null,ne=null,re=null,ie=null,le=t.errorUI.showHelp;function se(){le=!re.checked}function de(){ne&&(clearTimeout(ne),ne=null),oe.classList.remove("TravelNotes-ErrorsUI-Error"),oe.classList.remove("TravelNotes-ErrorsUI-Warning"),oe.classList.remove("TravelNotes-ErrorsUI-Info"),oe.classList.remove("TravelNotes-ErrorsUI-Help"),oe.classList.add("TravelNotes-ErrorsUI-Hidden"),re&&(re.removeEventListener("change",se,!1),re=null,ie=null),oe.innerHTML=""}function ce(e,o){if("Error"===o&&!t.errorUI.showError||"Warning"===o&&!t.errorUI.showWarning||"Info"===o&&!t.errorUI.showInfo||"Help"===o&&!t.errorUI.showHelp||"Help"===o&&!le)return;ne&&de();let n=a.create("div",{id:"TravelNotes-ErrorsUI-Header"},oe);a.create("span",{id:"TravelNotes-ErrorsUI-CancelButton",innerHTML:"&#x274c"},n).addEventListener("click",de,!1),a.create("div",{id:"TravelNotes-ErrorsUI-Message",innerHTML:e},oe),oe.classList.add("TravelNotes-ErrorsUI-"+o);let r=t.errorUI.timeOut;"Help"===o&&(ie=a.create("div",{id:"TravelNotes-ErrorsUI-HelpInputDiv"},oe),re=a.create("input",{id:"TravelNotes-ErrorsUI-HelpInput",type:"checkbox"},ie),re.addEventListener("change",se,!1),a.create("label",{id:"TravelNotes-ErrorsUI-HelpInputLabel",for:"TravelNotes-ErrorsUI-HelpInput",innerHTML:b.getText("ErrorUI - Dont show again")},ie),r=t.errorUI.helpTimeOut),oe.classList.remove("TravelNotes-ErrorsUI-Hidden"),ne=setTimeout(de,r)}const ue=Object.freeze(new class{createUI(){oe||(oe=a.create("div",{id:"TravelNotes-ErrorsUI",className:"TravelNotes-ErrorsUI-Hidden"},document.querySelector("body")))}showError(e){ce(e,"Error")}showWarning(e){ce(e,"Warning")}showInfo(e){ce(e,"Info")}showHelp(e){ce(e,"Help")}});function ge(e){let n=null,r=null,i=null,l=null,s=null,d=null,c=null,u=null,g=null,v=null,p=null;function h(){let e=[],t=i.childNodes;for(let a=0;a<t.length;a++)e.push({providerName:t[a].childNodes[0].value,providerKey:t[a].childNodes[1].value});return e}function m(){let e=!0;n.hideError();let t=i.childNodes;for(let a=0;a<t.length;a++)e=e&&""!==t[a].childNodes[0].value,e=e&&""!==t[a].childNodes[1].value;return e||n.showError(b.getText("APIKeysDialog - empty API key name or value")),e}function f(e){e.stopPropagation(),e.target.parentNode.parentNode.removeChild(e.target.parentNode)}function T(e){let o=a.create("div",{className:"TravelNotes-APIKeysDialog-ApiKeyRow"},i);a.create("input",{className:"TravelNotes-APIKeysDialog-ApiKeyName TravelNotes-APIKeysDialog-Input",value:e.providerName,placeholder:b.getText("APIKeysDialog - provider name")},o),a.create("input",{className:"TravelNotes-APIKeysDialog-ApiKeyValue TravelNotes-APIKeysDialog-Input",value:e.providerKey,placeholder:b.getText("APIKeysDialog - API key"),type:t.APIKeys.showAPIKeysInDialog?"text":"password"},o),a.create("div",{className:"TravelNotes-BaseDialog-Button TravelNotes-APIKeysDialog-AtRightButton TravelNotes-APIKeysDialog-DeleteRowButton",title:b.getText("APIKeysDialog - delete API key"),innerHTML:"&#x274c"},o).addEventListener("click",f,!1)}function N(e){n.hideWait(),n.keyboardEventListenerEnabled=!0,e&&"Canceled by user"!==e&&n.showError(b.getText("APIKeysDialog - An error occurs when reading the file"))}function L(e){let t=null;try{t=JSON.parse((new TextDecoder).decode(e))}catch(e){return void N(e)}for(;i.firstChild;)i.removeChild(i.firstChild);t.forEach(e=>T(e)),n.hideWait(),n.hideError(),n.keyboardEventListenerEnabled=!0}function w(e){e.stopPropagation(),n.showWait(),n.keyboardEventListenerEnabled=!1,o.getBinaryPromise(window.location.href.substr(0,window.location.href.lastIndexOf("/")+1)+"APIKeys").then(e=>{ae().decryptData(e,L,N,te(!1).show())}).catch(()=>{n.showError(b.getText("APIKeysDialog - An error occurs when loading the APIKeys file")),n.hideWait(),n.keyboardEventListenerEnabled=!0})}function I(){n.showError(b.getText("APIKeysDialog - An error occurs when saving the keys")),n.hideWait(),n.keyboardEventListenerEnabled=!0}function x(e){n.hideError(),n.hideWait();let t=URL.createObjectURL(e),a=document.createElement("a");a.setAttribute("href",t),a.setAttribute("download","APIKeys"),a.style.display="none",document.body.appendChild(a),a.click(),document.body.removeChild(a),window.URL.revokeObjectURL(t),n.keyboardEventListenerEnabled=!0}function A(e){e.stopPropagation(),n.hideError(),m()&&(n.showWait(),n.keyboardEventListenerEnabled=!1,ae().encryptData((new window.TextEncoder).encode(JSON.stringify(h())),x,I,te(!0).show()))}function j(e){n.hideError(),n.showWait(),n.keyboardEventListenerEnabled=!1,e.stopPropagation();let t=new FileReader;t.onload=function(){ae().decryptData(t.result,L,N,te(!1).show())},t.readAsArrayBuffer(e.target.files[0])}function P(){l.click()}function E(e){e.stopPropagation(),T({providerName:"",providerKey:""})}function M(e){e.stopPropagation(),n.hideError(),m()&&y.saveFile("APIKeys.json",JSON.stringify(h()))}function D(e){e.stopPropagation(),n.hideError();let t=new FileReader;t.onload=function(){try{let e=JSON.parse(t.result);for(;i.firstChild;)i.removeChild(i.firstChild);e.forEach(e=>T(e))}catch(e){n.showError(e.message),console.log(e||"An error occurs when reading the file")}},t.readAsText(e.target.files[0])}function R(){s.click()}function O(){if(n.hideError(),m())return h()}return n=ee(),n.title=b.getText("APIKeysDialog - API keys"),n.okButtonListener=O,r=a.create("div",{className:"TravelNotes-APIKeysDialog-ToolbarDiv"},n.content),t.haveCrypto&&(d=a.create("div",{className:"TravelNotes-BaseDialog-Button",title:b.getText("APIKeysDialog - Reload from server"),innerHTML:"&#x1f504;"},r),d.addEventListener("click",w,!1),c=a.create("div",{className:"TravelNotes-BaseDialog-Button",title:b.getText("APIKeysDialog - Save to file"),innerHTML:"&#x1f4be;"},r),c.addEventListener("click",A,!1),l=a.create("input",{className:"TravelNotes-BaseDialog-OpenFileInput",type:"file"},r),l.addEventListener("change",j,!1),u=a.create("div",{className:"TravelNotes-BaseDialog-Button",title:b.getText("APIKeysDialog - Open file"),innerHTML:"&#x1F4C2;"},r),u.addEventListener("click",P,!1)),g=a.create("div",{className:"TravelNotes-BaseDialog-Button",title:b.getText("APIKeysDialog - new API key"),innerHTML:"+"},r),g.addEventListener("click",E,!1),t.APIKeys.dialogHaveUnsecureButtons&&(v=a.create("div",{className:"TravelNotes-BaseDialog-Button TravelNotes-APIKeysDialog-AtRightButton",title:b.getText("APIKeysDialog - Save to json file"),innerHTML:"&#x1f4be;"},r),v.addEventListener("click",M,!1),s=a.create("input",{className:"TravelNotes-BaseDialog-OpenFileInput",type:"file"},r),s.addEventListener("change",D,!1),p=a.create("div",{className:"TravelNotes-BaseDialog-Button",title:b.getText("APIKeysDialog - Open json file"),innerHTML:"&#x1F4C2;"},r),p.addEventListener("click",R,!1)),i=a.create("div",{id:"TravelNotes-APIKeysDialog-DataDiv"},n.content),e.forEach(e=>T(e)),ue.showHelp(b.getText("Help - Complete the APIKeys")),n}const ve=Object.freeze(new class{dispatch(e,t){let a=function(e){return-1<["showitinerary","updateitinerary","showtravelnotes","updatetravelnotes","showsearch","updatesearch","setrouteslist","setprovider","providersadded","travelnameupdated","settransitmode"].indexOf(e)?document.getElementById("TravelNotes-UI-MainDiv"):-1<["removeobject","removeallobjects","zoomto","additinerarypointmarker","addsearchpointmarker","addrectangle","addwaypoint","layerchange","geolocationstatuschanged","geolocationpositionchanged","routeupdated","routepropertiesupdated","noteupdated","roadbookupdate","profileclosed"].indexOf(e)?document:null}(e);if(a){let o=new Event(e);t&&(o.data=t),a.dispatchEvent(o)}}});let pe=new Map;function he(e){return pe.get(e.toLowerCase())}function me(e,t){pe.set(e.toLowerCase(),t)}function fe(e){sessionStorage.clear(),pe.clear();let a=y.storageAvailable("sessionStorage")&&t.APIKeys.saveToSessionStorage;e.forEach(e=>{a&&sessionStorage.setItem(e.providerName.toLowerCase()+"ProviderKey",btoa(e.providerKey)),me(e.providerName,e.providerKey)}),$.providers.forEach(e=>{e.providerKey=he(e.name)||""}),ve.dispatch("providersadded")}function be(e){fe(JSON.parse((new TextDecoder).decode(e)))}function ye(e){console.log(e||"An error occurs when reading the APIKeys file"),e&&"Canceled by user"!==e&&ue.showError(b.getText("APIKeysManager - An error occurs when reading the APIKeys file")),ue.showHelp(b.getText("Help - Continue with interface"))}function Te(e){ae().decryptData(e,be,ye,te(!1).show())}const Ne=Object.seal(new class{getKey(e){return he(e)}setKeysFromServerFile(){0===function(){let e=0;for(let t=0;t<sessionStorage.length;t++){let a=sessionStorage.key(t);"ProviderKey"===a.substr(a.length-"ProviderKey".length)&&(me(a.substr(0,a.length-"ProviderKey".length),atob(sessionStorage.getItem(a))),e++)}return $.providers.forEach(e=>{e.providerKey=he(e.name)||""}),e}()?t.haveCrypto&&o.getBinaryPromise(window.location.href.substr(0,window.location.href.lastIndexOf("/")+1)+"APIKeys").then(Te).catch(e=>console.log(e||"APIKeys not found on server")):ve.dispatch("providersadded")}setKeyFromUrl(e){let a=e.indexOf("=");if(-1<a){let o=e.substr(0,a);o=o.substr(0,o.length-"ProviderKey".length).toLowerCase();let n=e.substr(a+1);try{atob(n),y.storageAvailable("sessionStorage")&&t.APIKeys.saveToSessionStorage&&sessionStorage.setItem(o+"ProviderKey",n),me(o,n);let e=$.providers.get(o);e&&(e.providerKey=n)}catch(e){console.log(e||"Invalid base64 encoded provider key")}}}setKeysFromDialog(){let e=[];pe.forEach((t,a)=>e.push({providerName:a,providerKey:t})),e.sort((e,t)=>e.providerName.localeCompare(t.providerName)),ge(e).show().then(e=>fe(e)).catch(e=>console.log(e||"canceled by user"))}addProvider(e){let t=e.name.toLowerCase(),a=he(t);e.providerKeyNeeded&&!a&&y.storageAvailable("sessionStorage")&&(a=sessionStorage.getItem(t),a&&(a=atob(a))),e.providerKeyNeeded&&a&&(e.providerKey=a),$.providers.set(e.name.toLowerCase(),e)}});const Le=Object.seal(new class{getRoute(e){let t=null;return t=$.travel.routes.getAt(e),t||e===$.travel.editedRoute.objId&&(t=$.travel.editedRoute),t}getNoteAndRoute(e){let t=null,a=null;if(t=$.travel.notes.getAt(e),!t){let o=$.travel.routes.iterator;for(;!o.done&&!t;)t=o.value.notes.getAt(e),t&&(a=o.value);t||(t=$.travel.editedRoute.notes.getAt(e),t&&(a=$.travel.editedRoute))}return Object.freeze({note:t,route:a})}getWayPoint(e){let t=$.travel.editedRoute.wayPoints.getAt(e);if(!t){let a=$.travel.routes.iterator;for(;!a.done&&!t;)t=a.value.wayPoints.getAt(e)}return t}});function we(){let e="",t="",a=null;function o(o){a=Le.getRoute(o),a&&(t='time="'+(new Date).toISOString()+'" ',e='<?xml version="1.0"?>\n',e+='<gpx xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd" version="1.1" creator="leaflet.TravelNotes">',function(){let o=a.wayPoints.iterator;for(;!o.done;)e+='\n\t<wpt lat="'+o.value.lat+'" lon="'+o.value.lng+'" '+t+"/>"}(),function(){e+="\n\t<rte>";let o=a.itinerary.maneuvers.iterator;for(;!o.done;){let n=a.itinerary.itineraryPoints.getAt(o.value.itineraryPointObjId),r=o.value.instruction.replace("&","&amp;").replace('"',"&apos;").replace('"',"&quote;").replace(">","&gt;").replace("<","&lt;");e+='\n\t\t<rtept lat="'+n.lat+'" lon="'+n.lng+'" '+t+'desc="'+r+'" />'}e+="\n\t</rte>"}(),function(){e+="\n\t<trk>",e+="\n\t\t<trkseg>";let o=a.itinerary.itineraryPoints.iterator;for(;!o.done;)e+='\n\t\t\t<trkpt lat="'+o.value.lat+'" lon="'+o.value.lng+'" '+t+" />";e+="\n\t\t</trkseg>",e+="\n\t</trk>"}(),e+="\n</gpx>",function(){let t=a.computedName;""===t&&(t="TravelNote"),t+=".gpx",y.saveFile(t,e)}())}return Object.seal(new class{routeToGpx(e){o(e)}})}class Ie{constructor(e,t,a){this.red=("number"==typeof e?e:255)%256,this.green=("number"==typeof t?t:255)%256,this.blue=("number"==typeof a?a:255)%256}get cssColor(){return"#"+this.red.toString(16).padStart(2,"0")+this.green.toString(16).padStart(2,"0")+this.blue.toString(16).padStart(2,"0")}set cssColor(e){this.red=parseInt(e.substr(1,2),16),this.green=parseInt(e.substr(3,2),16),this.blue=parseInt(e.substr(5,2),16)}clone(){return new Ie(this.red,this.green,this.blue)}copyTo(e){e.red=this.red,e.green=this.green,e.blue=this.blue}}function xe(e){let o=null,n=null,r=null,i=null,l=null,s=null;function d(){return e.color=document.getElementById("TravelNotes-ColorDialog-ColorSampleDiv").color.cssColor,e.computedName!==r.value&&(e.name=r.value),e.width=parseInt(i.value),e.chain=l.checked,e.dashArray=s.selectedIndex,e}return o=function(e){let o=null,n=new Ie;n.cssColor=e;let r=null,i=[],l=null,s=null,d=null,c=null;function u(e){n=e.target.color.clone(),l.value=n.red,s.value=n.green,d.value=n.blue,c.setAttribute("style","background-color:"+n.cssColor+";"),c.color=n}function g(e){for(let t=0;t<6;++t)for(let a=0;a<6;++a){let o=i[6*t+a];o.color.red=e,o.setAttribute("style","background-color:"+o.color.cssColor)}}function v(e){g(Math.ceil(2.55*e.target.valueAsNumber))}function p(e){g(255-e.target.color.blue)}function h(){n.red=parseInt(l.value),n.green=parseInt(s.value),n.blue=parseInt(d.value),c.setAttribute("style","background-color:"+n.cssColor+";"),c.color=n}return o=ee(),o.title=b.getText("ColorDialog - Colors"),r=a.create("div",{id:"TravelNotes-ColorDialog-ColorDiv"},o.content),function(){let e=a.create("div",null,r),o=new Ie(t.colorDialog.initialRed,0,0);for(let t=0;t<6;++t){let t=a.create("div",{className:"TravelNotes-ColorDialog-RowColorDiv"},e);o.green=0;for(let e=0;e<6;++e){let e=a.create("div",{className:"TravelNotes-ColorDialog-CellColorDiv"},t);e.color=o.clone(),e.setAttribute("style","background-color:"+o.cssColor),e.addEventListener("click",u,!1),o.green+=51,i.push(e)}o.blue+=51}}(),t.colorDialog.haveSlider?function(){let e=a.create("div",null,r),o=Math.ceil(t.colorDialog.initialRed*(100/255)),n=a.create("input",{type:"range",className:"TravelNotes-ColorDialog-SliderInput",value:o,min:0,max:100,step:20},e);n.addEventListener("input",v,!1),n.focus()}():function(){let e=a.create("div",null,r),t=new Ie(255,0,0),o=a.create("div",{className:"TravelNotes-ColorDialog-RowColorDiv",id:"TravelNotes-ColorDialog-RedButtonsRowDiv"},e);for(let e=0;e<6;++e){let e=a.create("div",{className:"TravelNotes-ColorDialog-CellColorDiv"},o);e.color=t.clone(),e.setAttribute("style","background-color:"+e.color.cssColor),e.addEventListener("click",p,!1),t.green+=51,t.blue+=51}}(),function(){let e=a.create("div",null,r);a.create("text",{value:b.getText("ColorDialog - Red")},e),l=a.create("input",{type:"number",className:"TravelNotes-ColorDialog-NumberInput",value:n.red,min:0,max:255},e),l.addEventListener("input",h,!1),a.create("text",{value:b.getText("ColorDialog - Green")},e),s=a.create("input",{type:"number",className:"TravelNotes-ColorDialog-NumberInput",value:n.green,min:0,max:255},e),s.addEventListener("input",h,!1),a.create("text",{value:b.getText("ColorDialog - Blue")},e),d=a.create("input",{type:"number",className:"TravelNotes-ColorDialog-NumberInput",value:n.blue,min:0,max:255},e),d.addEventListener("input",h,!1)}(),c=a.create("div",{id:"TravelNotes-ColorDialog-ColorSampleDiv"},r),c.setAttribute("style","background-color:"+n.cssColor+";"),c.color=n,o}(e.color),o.title=b.getText("RoutePropertiesDialog - Route properties"),o.okButtonListener=d,n=a.create("div",{id:"TravelNotes-RoutePropertiesDialog-MainDataDiv"}),o.content.insertBefore(n,o.content.firstChild),function(){let t=a.create("div",null,n);a.create("div",{innerHTML:b.getText("RoutePropertiesDialog - Name")},t);let o=a.create("div",{className:"TravelNotes-RoutePropertiesDialog-DataDiv",id:"TravelNotes-RoutePropertiesDialog-NameInputDiv"},t);r=a.create("input",{type:"text",id:"TravelNotes-RoutePropertiesDialog-NameInput",value:e.computedName},o)}(),function(){let t=a.create("div",{className:"TravelNotes-RoutePropertiesDialog-DataDiv",innerHTML:"<span>"+b.getText("RoutePropertiesDialog - Width")+"</span>"},n);i=a.create("input",{type:"number",id:"TravelNotes-RoutePropertiesDialog-WidthInput",value:e.width,min:1,max:40},t)}(),function(){let o=a.create("div",{className:"TravelNotes-RoutePropertiesDialog-DataDiv",innerHTML:"<span>"+b.getText("RoutePropertiesDialog - Linetype")+"</span>"},n);s=a.create("select",null,o);let r=t.route.dashChoices;for(let e=0;e<r.length;e++)s.add(a.create("option",{text:r[e].text}));s.selectedIndex=e.dashArray<r.length?e.dashArray:0}(),function(){let t=a.create("div",{className:"TravelNotes-RoutePropertiesDialog-DataDiv",id:"TravelNotes-RoutePropertiesDialog-ChainDiv",innerHTML:"<span>"+b.getText("RoutePropertiesDialog - Chained route")+"</span>"},n);l=a.create("input",{type:"checkbox",checked:e.chain},t)}(),a.create("div",{innerHTML:b.getText("RoutePropertiesDialog - Color"),id:"TravelNotes-RoutePropertiesDialog-ColorHeaderDiv"},n),o}const Ae=Math.PI/180;function je(e){return(e+540)%360-180}const Pe=Object.freeze(new class{getLatLngElevAtDist(e,t){if(e.distance<=t||0>=t)return null;let a=0,o=e.itinerary.itineraryPoints.iterator;for(;a<t&&!o.done;)a+=o.value.distance;let n=o.value;o.done;let r=(n.distance-a+t)/n.distance;return Object.freeze({latLng:[n.lat+(o.value.lat-n.lat)*r,n.lng+(o.value.lng-n.lng)*r],elev:n.elev+(o.value.elev-n.elev)*r,ascent:100*(o.value.elev-n.elev)/n.distance,routeDistance:t})}getClosestLatLngDistance(e,t){if(0===e.itinerary.itineraryPoints.length)return null;let a=e.itinerary.itineraryPoints.iterator;a.done;let o=Number.MAX_VALUE,r=L.Projection.SphericalMercator.project(L.latLng(t[0],t[1])),i=L.Projection.SphericalMercator.project(L.latLng(a.value.lat,a.value.lng)),l=null,s=n.defaultValue,d=a.value.distance;for(;!a.done;){let e=L.Projection.SphericalMercator.project(L.latLng(a.value.lat,a.value.lng)),t=L.LineUtil.pointToSegmentDistance(r,i,e);t<o&&(o=t,l=L.Projection.SphericalMercator.unproject(L.LineUtil.closestPointOnSegment(r,i,e)),s=d-l.distanceTo(L.latLng(a.value.lat,a.value.lng))),d+=a.value.distance,i=e}return Object.freeze({latLng:[l.lat,l.lng],distance:s})}getLatLngBounds(e){let t=L.latLng([90,180]),a=L.latLng([-90,-180]);return e.forEach(e=>{t.lat=Math.min(t.lat,e[0]),t.lng=Math.min(t.lng,e[1]),a.lat=Math.max(a.lat,e[0]),a.lng=Math.max(a.lng,e[1])}),L.latLngBounds(t,a)}pointsDistance(e,t){if(e[0]===t[0]&&e[1]===t[1])return 0;let a=e[0]*Ae,o=t[0]*Ae,n=(je(t[1])-je(e[1]))*Ae;return 6371e3*Math.acos(Math.sin(a)*Math.sin(o)+Math.cos(a)*Math.cos(o)*Math.cos(n))}getSquareBoundingBox(e,t){let a=t/6371e3/Ae,o=e[0]*Ae,n=Math.acos((Math.cos(t/6371e3)-Math.sin(o)**2)/Math.cos(o)**2)/Ae;return L.latLngBounds(L.latLng([e[0]-a,e[1]-n]),L.latLng([e[0]+a,e[1]+n]))}project(e,t){let a=$.map.project(L.latLng(e),t);return[a.x,a.y]}screenCoordToLatLng(e,t){let a=$.map.containerPointToLatLng(L.point(e,t));return[a.lat,a.lng]}addPoints(e,t){return[e[0]+t[0],e[1]+t[1]]}subtrackPoints(e,t){return[e[0]-t[0],e[1]-t[1]]}});function Ee(){let e=[];function t(t){e.push(t.latLng),e.push(t.iconLatLng)}function a(a){a.itinerary.itineraryPoints.forEach(t=>e.push(t.latLng)),a.notes.forEach(e=>t(e))}return Object.seal(new class{zoomToLatLng(e){ve.dispatch("zoomto",{latLng:e})}zoomToManeuver(e){let t=$.travel.editedRoute.itinerary.maneuvers.getAt(e).itineraryPointObjId,a=$.travel.editedRoute.itinerary.itineraryPoints.getAt(t).latLng;ve.dispatch("zoomto",{latLng:a})}zoomToNote(a){e=[],t(Le.getNoteAndRoute(a).note),ve.dispatch("zoomto",{geometry:[e]})}zoomToRoute(t){e=[],a(Le.getRoute(t)),ve.dispatch("zoomto",{geometry:[e]})}zoomToTravel(){e=[],$.travel.routes.forEach(e=>a(e)),-1!==$.travel.editedRouteObjId&&a($.travel.editedRoute),$.travel.notes.forEach(e=>t(e)),ve.dispatch("zoomto",{geometry:[e]})}zoomToPoi(e){ve.dispatch("zoomto",e)}})}
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file FloatWindow.js
	@copyright Copyright - 2017 2020 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/function Me(){let e=null,t=null,o=null,n=0,r=0,i=0,l=0,s=0,d=0,c=null;function u(e){try{e.dataTransfer.setData("Text","1")}catch(e){console.log(e)}n=e.screenX,r=e.screenY}function g(t){i+=t.screenX-n,l+=t.screenY-r,i=Math.min(Math.max(i,20),s-e.clientWidth-20),l=Math.max(l,20);let a=d-Math.max(l,0)-20;e.setAttribute("style","top:"+l+"px;left:"+i+"px;max-height:"+a+"px;")}function v(){c&&c(),document.querySelector("body").removeChild(e)}return new class{createWindow(){s=$.map.getContainer().clientWidth,d=$.map.getContainer().clientHeight,e=a.create("div",{className:"TravelNotes-FloatWindow-Container"},document.querySelector("body")),function(){let t=a.create("div",{className:"TravelNotes-FloatWindow-TopBar",draggable:!0},e);t.addEventListener("dragstart",u,!1),t.addEventListener("dragend",g,!1),a.create("div",{innerHTML:"&#x274c",className:"TravelNotes-FloatWindow-CancelButton",title:b.getText("FloatWindow - Close")},t).addEventListener("click",v,!1)}(),t=a.create("div",{className:"TravelNotes-FloatWindow-HeaderDiv"},e),o=a.create("div",{className:"TravelNotes-FloatWindow-ContentDiv"},e)}close(){v()}set onClose(e){c=e}get header(){return t}get content(){return o}}}let De=null,Re=s.defaultValue,Oe=s.defaultValue,Ce=null,Se=null,Ue=-1,ke=-1,He=-1,Be=[],Fe=null,Ve=null;function We(e){-1!==He&&Ce.childNodes[He+1].firstChild.classList.remove("TravelNotes-ContextMenu-ItemSelected"),e?(Ce.childNodes[Ue+1].firstChild.classList.add("TravelNotes-ContextMenu-ItemSelected"),He=Ue):(Ce.childNodes[ke+1].firstChild.classList.add("TravelNotes-ContextMenu-ItemSelected"),He=ke,Ue=ke)}function ze(e){Ce&&("Escape"===e.key||"Esc"===e.key?(e.stopPropagation(),Fe.click()):"ArrowDown"===e.key||"ArrowRight"===e.key||"Tab"===e.key?(e.stopPropagation(),Ue=-1===Ue||Be.length-1===Ue?0:++Ue,We(!0)):"ArrowUp"===e.key||"ArrowLeft"===e.key?(e.stopPropagation(),Ue=-1===Ue||0===Ue?Be.length-1:--Ue,We(!0)):"Home"===e.key?(e.stopPropagation(),Ue=0,We(!0)):"End"===e.key?(e.stopPropagation(),Ue=Be.length-1,We(!0)):"Enter"===e.key&&Ue>=0&&Be[Ue].action&&(e.stopPropagation(),We(!0),Ce.childNodes[He+1].firstChild.click()))}function Ke(e){e.stopPropagation();let t=Be[e.target.menuItem];Fe.click(),t.param?t.action.call(t.context,t.param):t.action.call(t.context)}function Xe(e){ke=e.target.objId,We(!1)}function Ze(){Se&&(clearTimeout(Se),Se=null),document.removeEventListener("keydown",ze,!0),Ve.removeChild(Ce),De=null,Re=s.defaultValue,Oe=s.defaultValue,Ce=null,Ue=-1,ke=-1,He=-1,Be=[],Fe=null,Ve=null}function Ge(e,o,n){function r(){if(De=e,De.fromUI||De.latlng.lat!==Re||De.latlng.lng!==Oe){if(Re=De.latlng.lat,Oe=De.latlng.lng,Ce)return Se&&(clearTimeout(Se),Se=null),void Ze();Ce=null,Ue=-1,ke=-1,He=-1,Fe=null,Ve=n||document.querySelector("body"),Be=o,Ce=a.create("div",{id:"TravelNotes-ContextMenu-Container",className:"TravelNotes-ContextMenu-Container"},Ve),0<t.contextMenu.timeout&&(Ce.addEventListener("mouseenter",()=>{Se&&(clearTimeout(Se),Se=null)},!1),Ce.addEventListener("mouseleave",()=>{Se=setTimeout(Ze,t.contextMenu.timeout)},!1)),Fe=a.create("div",{innerHTML:"&#x274c",className:"TravelNotes-ContextMenu-CloseButton",title:b.getText("ContextMenu - Close")},Ce),Fe.addEventListener("click",Ze,!1),function(){let e=0;Be.forEach(t=>{let o=a.create("div",{className:"TravelNotes-ContextMenu-ItemContainer"},Ce),n=a.create("div",{innerHTML:t.name,id:"TravelNotes-ContextMenu-Item"+e,objId:e,className:t.action?"TravelNotes-ContextMenu-Item":"TravelNotes-ContextMenu-Item TravelNotes-ContextMenu-ItemDisabled"},o);n.addEventListener("mouseenter",Xe,!1),t.action&&n.addEventListener("click",Ke,!1),n.menuItem=e,++e})}(),function(){let e=document.querySelector("body"),t=a.create("div",{className:"TravelNotes-ContextMenu-Panel"},e),o=t.clientWidth,r=t.clientHeight;e.removeChild(t);let i=Math.min(De.originalEvent.clientY,r-Ce.clientHeight-20),l=Math.min(De.originalEvent.clientX,o-Ce.clientWidth-20);n?Ce.setAttribute("style","top:"+i+"px;right:20px;"):Ce.setAttribute("style","top:"+i+"px;left:"+l+"px;")}(),document.addEventListener("keydown",ze,!0)}}return new class{show(){r()}}}let Je=!1;function Ye(){let e=Object.seal({latLng:[s.defaultValue,s.defaultValue],distance:n.defaultValue}),a=null,r=null,i={},l=new Map,d=new Map,c=[],u=null,g="",v=null,p=0,h=[0,0],m=0,f=null,y=t.note.svgZoom,T=t.note.svgAngleDistance,N=" ",L="",w="";function I(e){let t=!1;return r.wayPoints.forEach(a=>{Math.abs(e.lat-a.lat)<1e-5&&Math.abs(e.lng-a.lng)<1e-5&&(t=!0)}),!t&&(a.lat!==e.lat||a.lng!==e.lng)}function x(x,A){Je?A("A request is already running"):(Je=!0,i={},v=null,g="",N=" ",L="",w="",function(){let t=Number.MAX_VALUE,o=n.defaultValue;r.itinerary.itineraryPoints.forEach(n=>{let r=Pe.pointsDistance(e.latLng,n.latLng);t>r&&(t=r,a=n,e.distance=o),o+=n.distance}),e.latLng=a.latLng}(),o.getJsonPromise(function(){let a=e.latLng[0].toFixed(s.fixed)+","+e.latLng[1].toFixed(s.fixed);return t.overpassApiUrl+"?data=[out:json][timeout:"+t.note.svgTimeOut+"];way[highway](around:"+(1.5*t.note.svgIconWidth).toFixed(0)+","+a+")->.a;(.a >;.a;)->.a;.a out;is_in("+a+')->.e;area.e[admin_level="2"][name="United Kingdom"]->.f;area.e[admin_level="8"]->.g;area.e[admin_level="10"]->.h;if(f.count(deriveds)==0){.g->.i;}else{if(h.count(deriveds)==0){.g->.i;}else{.h->.i;}}.i out;(node(area.i)[place="village"];node(area.i)[place="hamlet"];node(area.i)[place="city"];node(area.i)[place="town"];)->.k;( node(around:'+t.note.svgHamletDistance+","+a+')[place="hamlet"];node(around:'+t.note.svgVillageDistance+","+a+')[place="village"];node(around:'+t.note.svgCityDistance+","+a+')[place="city"];node(around:'+t.note.svgTownDistance+","+a+')[place="town"];)->.l;node.k.l->.m;.m out;'}()).then((function(o){i=o,l.clear(),d.clear(),i.elements.forEach(e=>{switch(e.type){case"area":e.tags&&e.tags.boundary&&e.tags.name&&(g=e.tags.name);break;case"way":e.nodesIds=e.nodes,delete e.nodes,l.set(e.id,e);break;case"node":d.set(e.id,e),e.tags&&e.tags.place&&["town","city","village","hamlet"].includes(e.tags.place)&&c.push(e)}}),v=document.createElementNS("http://www.w3.org/2000/svg","svg"),v.setAttributeNS(null,"viewBox",String(t.note.svgIconWidth/4)+" "+t.note.svgIconWidth/4+" "+t.note.svgIconWidth/2+" "+t.note.svgIconWidth/2),v.setAttributeNS(null,"class","TravelNotes-SvgIcon"),function(){let e=Number.MAX_VALUE;c.forEach(t=>{let o=Pe.pointsDistance(a.latLng,[t.lat,t.lon]);e>o&&(e=o,u=t.tags.name)})}(),h=Pe.subtrackPoints([t.note.svgIconWidth/2,t.note.svgIconWidth/2],Pe.project(e.latLng,y)),function(){let t=n.defaultValue,o=r.itinerary.itineraryPoints.first,i=r.itinerary.itineraryPoints.last,l=!1;r.itinerary.itineraryPoints.forEach(a=>{e.distance-t>T&&(o=a),t-e.distance>T&&!l&&(i=a,l=!0),t+=a.distance});let s=Pe.addPoints(Pe.project(e.latLng,y),h);if(a.objId!==r.itinerary.itineraryPoints.first.objId){let e=Pe.addPoints(Pe.project(o.latLng,y),h);m=180*Math.atan((s[1]-e[1])/(e[0]-s[0]))/Math.PI,0>m&&(m+=360),m-=270,0>e[0]-s[0]&&(m+=180)}if(a.objId!==r.itinerary.itineraryPoints.last.objId){let e=Pe.addPoints(Pe.project(i.latLng,y),h);for(f=180*Math.atan((s[1]-e[1])/(e[0]-s[0]))/Math.PI,0>e[0]-s[0]&&(f+=180),f-=m;0>f;)f+=360;for(;360<f;)f-=360}a.objId===r.itinerary.itineraryPoints.first.objId&&(m=-f-90,f=null,p=-1),e.latLng[0]===r.itinerary.itineraryPoints.last.lat&&e.latLng[1]===r.itinerary.itineraryPoints.last.lng&&(f=null,p=1)}(),null!==f&&(f<t.note.svgAnleMaxDirection.right?(L=b.getText("SvgIconFromOsmFactory - Turn right"),N="&#x1f882;"):f<t.note.svgAnleMaxDirection.slightRight?(L=b.getText("SvgIconFromOsmFactory - Turn slight right"),N="&#x1f885;"):f<t.note.svgAnleMaxDirection.continue?(L=b.getText("SvgIconFromOsmFactory - Continue"),N="&#x1f881;"):f<t.note.svgAnleMaxDirection.slightLeft?(L=b.getText("SvgIconFromOsmFactory - Turn slight left"),N="&#x1f884;"):f<t.note.svgAnleMaxDirection.left?(L=b.getText("SvgIconFromOsmFactory - Turn left"),N="&#x1f880;"):f<t.note.svgAnleMaxDirection.sharpLeft?(L=b.getText("SvgIconFromOsmFactory - Turn sharp left"),N="&#x1f887;"):f<t.note.svgAnleMaxDirection.sharpRight?(L=b.getText("SvgIconFromOsmFactory - Turn sharp right"),N="&#x1f886;"):(L=b.getText("SvgIconFromOsmFactory - Turn right"),N="&#x1f882;")),-1===p?L=b.getText("SvgIconFromOsmFactory - Start"):1===p&&(L=b.getText("SvgIconFromOsmFactory - Stop")),function(){let e=r.itinerary.itineraryPoints.previous(a.objId,I),t=r.itinerary.itineraryPoints.next(a.objId,I),o=-1,i=-1,s=-1,c=Number.MAX_VALUE,u=Number.MAX_VALUE,g=Number.MAX_VALUE,v=n.defaultValue;d.forEach(n=>{a&&(v=Pe.pointsDistance([n.lat,n.lon],a.latLng),v<c&&(o=n.id,c=v)),e&&(v=Pe.pointsDistance([n.lat,n.lon],e.latLng),v<u&&(i=n.id,u=v)),t&&(v=Pe.pointsDistance([n.lat,n.lon],t.latLng),v<g&&(s=n.id,g=v))});let h=d.get(o),m=h&&h.tags&&h.tags.highway&&"mini_roundabout"===h.tags.highway,f="",y="",T=!1,x=!1;l.forEach(e=>{if(!e.nodesIds.includes(o))return;let t=function(e){return(e.tags.name?e.tags.name:"")+(e.tags.name&&e.tags.ref?" ":"")+(e.tags.ref?"["+e.tags.ref+"]":"")}(e),a=""!==t,n=e.nodesIds.includes(i),r=e.nodesIds.includes(s),l=2*e.nodesIds.filter(e=>e===o).length;if(e.nodesIds[0]===o&&l--,e.nodesIds[e.nodesIds.length-1]===o&&l--,n&&(f=a?t:"???",l--,e.tags.junction&&"roundabout"===e.tags.junction&&(x=!0)),0!==l&&(r&&(y=a?t:"???",l--,e.tags.junction&&"roundabout"===e.tags.junction&&(T=!0)),0!==l&&a))for(;0!==l;)w=""===w?t:w+" &#x2AA5; "+t,l--}),w=-1===p?"&#x1F7E2; "+y:1===p?f+" &#x1F534;":f+(""===w?"":" &#x2AA5; "+w)+" "+N+" "+y,T&&!x?L+=b.getText("SvgIconFromOsmFactory - entry roundabout"):!T&&x?L+=b.getText("SvgIconFromOsmFactory - exit roundabout"):T&&x&&(L+=b.getText("SvgIconFromOsmFactory - continue roundabout")),m&&(L+=b.getText("SvgIconFromOsmFactory - at the small roundabout on the ground"))}(),function(){let e=-1,a=-1,o=-1,n=[];if(r.itinerary.itineraryPoints.forEach(r=>{e++;let i=Pe.addPoints(Pe.project(r.latLng,y),h);n.push(i),i[0]>=0&&i[1]>=0&&i[0]<=t.note.svgIconWidth&&i[1]<=t.note.svgIconWidth&&(-1===a&&(a=e),o=e)}),-1!==a&&-1!==o){0<a&&a--,r.itinerary.itineraryPoints.length-1>o&&o++;let i="";for(e=a;e<=o;e++)i+=n[e][0].toFixed(0)+","+n[e][1].toFixed(0)+" ";let l=document.createElementNS("http://www.w3.org/2000/svg","polyline");l.setAttributeNS(null,"points",i),l.setAttributeNS(null,"class","TravelNotes-OSM-Itinerary"),l.setAttributeNS(null,"transform","rotate("+m+","+t.note.svgIconWidth/2+","+t.note.svgIconWidth/2+")"),v.appendChild(l)}}(),l.forEach(e=>{let a=-1,o=-1,n=-1,r=[];if(e.nodesIds.forEach(e=>{n++;let i=d.get(e),l=Pe.addPoints(Pe.project([i.lat,i.lon],y),h);r.push(l),l[0]>=0&&l[1]>=0&&l[0]<=t.note.svgIconWidth&&l[1]<=t.note.svgIconWidth&&(-1===a&&(a=n),o=n)}),-1!==a&&-1!==o){0<a&&a--,e.nodesIds.length-1>o&&o++;let i="";for(n=a;n<=o;n++)i+=r[n][0].toFixed(0)+","+r[n][1].toFixed(0)+" ";let l=document.createElementNS("http://www.w3.org/2000/svg","polyline");l.setAttributeNS(null,"points",i),l.setAttributeNS(null,"class","TravelNotes-OSM-Highway TravelNotes-OSM-Highway-"+e.tags.highway),l.setAttributeNS(null,"transform","rotate("+m+","+t.note.svgIconWidth/2+","+t.note.svgIconWidth/2+")"),v.appendChild(l)}}),Je=!1,x(Object.freeze({svg:v,tooltip:L,city:g,place:u,streets:w,latLng:a.latLng}))})).catch(e=>{Je=!1,A(e)}))}return Object.seal(new class{getPromiseIconAndAdress(t,a){return e.latLng=t,r=Le.getRoute(a),new Promise(x)}})}function qe(){return Object.seal(new class{parseResponse(e){let t="",a="",o="";return e.error||(e.address.house_number&&(t+=e.address.house_number+" "),e.address.road?t+=e.address.road+" ":e.address.pedestrian&&(t+=e.address.pedestrian+" "),e.address.village?o=e.address.village:e.address.town?o=e.address.town:e.address.city&&(o=e.address.city),""===t&&""===o&&(t=e.address.country),a=e.namedetails.name||"",(t.includes(a)||o.includes(a))&&(a="")),Object.seal({name:a,street:t,city:o})}getPromiseAddress(e){let a=t.nominatim.url+"reverse?format=json&lat="+e[0]+"&lon="+e[1]+"&zoom=18&addressdetails=1&namedetails=1",n=t.nominatim.language;n&&"*"!==n&&(a+="&accept-language="+n);let r=null;return n&&"*"===n&&(r=[{headerName:"accept-language",headerValue:""}]),o.getJsonPromise(a,r)}})}let Qe=[],_e=[],$e=null,et=null,tt=null,at=null,ot=null;function nt(){_e.forEach(e=>et.add(a.create("option",{text:e.name}))),et.selectedIndex=-1}function rt(){Qe.forEach(e=>{a.create("button",{type:"button",innerHTML:e.title||"?",htmlBefore:e.htmlBefore||"",htmlAfter:e.htmlAfter||"",className:"TravelNotes-NoteDialog-EditorButton"},$e).addEventListener("click",ot,!1)})}function it(e){let t=new FileReader;t.onload=function(){try{let e=JSON.parse(t.result);Qe=Qe.concat(e.editionButtons),_e=_e.concat(e.preDefinedIconsList),_e.sort((e,t)=>e.name.localeCompare(t.name)),document.querySelectorAll(".TravelNotes-NoteDialog-EditorButton").forEach(e=>{e.removeEventListener("click",ot,!1),$e.removeChild(e)}),rt();for(let e=et.length-1;e>=0;e--)et.remove(e);nt()}catch(e){console.log(e||"An error occurs when opening the file")}},t.readAsText(e.target.files[0])}function lt(){tt.click()}const st=Object.seal(new class{set selectOptions(e){_e=_e.concat(e),_e.sort((e,t)=>e.name.localeCompare(t.name))}set buttons(e){Qe=Qe.concat(e)}getIconData(e){return _e[e]}getIconDataFromName(e){let t=_e.find(t=>t.name===e);return t?t.icon:null}createToolbar(e,t){return at=e,ot=t,$e=a.create("div",{className:"TravelNotes-NoteDialog-ToolbarDiv",id:"TravelNotes-NoteDialog-ToolbarDiv"}),et=a.create("select",{className:"TravelNotes-NoteDialog-Select",id:"TravelNotes-NoteDialog-IconSelect"},$e),et.addEventListener("change",at,!1),nt(),tt=a.create("input",{className:"TravelNotes-BaseDialog-OpenFileInput",type:"file"},$e),tt.addEventListener("change",it,!1),a.create("div",{className:"TravelNotes-BaseDialog-Button",title:b.getText("NoteDialog - Open a configuration file"),innerHTML:"&#x1F4C2;"},$e).addEventListener("click",lt,!1),rt(),$e}});function dt(){let e=null,t=null;return Object.freeze(new class{createUI(){if(document.getElementById("TravelNotes-WaitUI"))return;e=a.create("div",{className:"TravelNotes-Background"},document.querySelector("body"));let o=a.create("div",{id:"TravelNotes-WaitUI"},e);t=a.create("div",{id:"TravelNotes-WaitUI-MessageDiv"},o),a.create("div",{className:"TravelNotes-WaitAnimationBullet"},a.create("div",{className:"TravelNotes-WaitAnimation"},o))}showInfo(e){t.innerHTML=e}close(){document.querySelector("body").removeChild(e),e=null}})}let ct=null,ut=0,gt=0,vt=t.note.osmSearchNoteDialog;function pt(e,a){let o=F();o.iconContent=e.svg.outerHTML,o.popupContent="",o.iconWidth=u.width,o.iconHeight=u.height,o.tooltipContent=e.tooltip,o.address=e.streets,""!==e.city&&(o.address+=" "+t.note.cityPrefix+e.city+t.note.cityPostfix),e.place&&e.place!==e.city&&(o.address+=" ("+e.place+")"),o.latLng=e.latLng,o.iconLatLng=e.latLng,o.distance=Pe.getClosestLatLngDistance(a,o.latLng).distance,o.chainedDistance=a.chainedDistance,a.notes.add(o),ve.dispatch("noteupdated",{removedNoteObjId:-1,addedNoteObjId:o.objId}),ve.dispatch("roadbookupdate")}function ht(e,t,a){if(a)if(-1===t)$.travel.notes.add(e),ve.dispatch("showtravelnotes");else{let a=Le.getRoute(t);a.notes.add(e),e.chainedDistance=a.chainedDistance,a.notes.sort((e,t)=>e.distance-t.distance),ve.dispatch("showitinerary")}else-1===t?ve.dispatch("updatetravelnotes"):ve.dispatch("updateitinerary");ve.dispatch("noteupdated",{removedNoteObjId:e.objId,addedNoteObjId:e.objId}),ve.dispatch("roadbookupdate")}function mt(e,o,n){(function(e,o,n){let r=null,i=qe(),l=e.latLng,d="",c="",g=null,v=null,p=null,h=null,m=null,f=null,y=null,T=null,N=null,L=null;function w(){if(0!==p.value.length)return e.iconWidth=h.value,e.iconHeight=m.value,e.iconContent=p.value,e.popupContent=f.value,e.tooltipContent=y.value,e.address=T.value,e.url=N.value,e.phone=L.value,e.latLng=l,e;g.showError(b.getText("Notedialog - The icon content cannot be empty"))}function I(a){let o=i.parseResponse(a);d=o.street,""!==o.city&&(d+=" "+t.note.cityPrefix+o.city+t.note.cityPostfix),c=o.city,t.note.reverseGeocoding&&""===e.address&&n&&(T.value=d)}function x(e){g.showError(b.getText("Notedialog - an error occurs when searching the adress")),console.log(e||"an error occurs when searching the adress.")}function A(e){p.value=e.svg.outerHTML,y.value=e.tooltip;let a=e.streets,o=""===e.city?c:e.city;""!==o&&(a+=" "+t.note.cityPrefix+o+t.note.cityPostfix),e.place&&e.place!==o&&(a+=" ("+e.place+")"),T.value=a,l=e.latLng,g.hideWait()}function j(e){g.hideWait(),g.showError(b.getText("Notedialog - an error occurs when creating the SVG icon")),console.log(e||"an error occurs when creating the SVG icon.")}function P(t){let a=st.getIconData(t.target.selectedIndex);"SvgIcon"===a.icon?-1===o?g.showError(b.getText("Notedialog - not possible to create a SVG icon for a travel note")):(g.showWait(),Ye().getPromiseIconAndAdress(e.latLng,o).then(A).catch(j)):(g.hideError(),h.value=a.width,m.value=a.height,p.value=a.icon,y.value=a.tooltip)}function E(e){if(!r)return;let t=e.target;for(;!t.htmlBefore;)t=t.parentNode;let a=t.htmlAfter&&0<t.htmlAfter.length,o=r.selectionStart,n=r.selectionEnd,i=r.value;r.value=i.substring(0,o)+(a?t.htmlBefore+i.substring(o,n)+t.htmlAfter:t.htmlBefore)+i.substring(n),r.setSelectionRange(a||o===n?o+t.htmlBefore.length:o,(a?n:o)+t.htmlBefore.length),r.focus()}function M(){T.value=d}function D(e){r=e.target}return g=ee(),g.title=b.getText("NoteDialog - Note"),g.okButtonListener=w,v=a.create("div",{id:"TravelNotes-NoteDialog-MainDataDiv"},g.content),v.appendChild(st.createToolbar(P,E)),function(){let t=a.create("div",{className:"TravelNotes-NoteDialog-DataDiv"},v);a.create("text",{value:b.getText("NoteDialog - Icon width")},t),h=a.create("input",{type:"number",className:"TravelNotes-NoteDialog-NumberInput",value:0===e.iconWidth?u.width:e.iconWidth},t),a.create("text",{value:b.getText("NoteDialog - Icon height")},t),m=a.create("input",{type:"number",className:"TravelNotes-NoteDialog-NumberInput",value:0===e.iconHeight?u.height:e.iconHeight},t)}(),a.create("div",{className:"TravelNotes-NoteDialog-DataDiv",innerHTML:b.getText("NoteDialog - Icon content")},v),p=a.create("textarea",{className:"TravelNotes-NoteDialog-TextArea",value:e.iconContent},v),p.addEventListener("focus",D,!1),a.create("div",{className:"TravelNotes-NoteDialog-DataDiv",innerHTML:b.getText("NoteDialog - Text")},v),f=a.create("textarea",{className:"TravelNotes-NoteDialog-TextArea",value:e.popupContent},v),f.addEventListener("focus",D,!1),a.create("div",{className:"TravelNotes-NoteDialog-DataDiv",innerHTML:b.getText("NoteDialog - Tooltip content")},v),y=a.create("input",{type:"text",className:"TravelNotes-NoteDialog-InputText",value:e.tooltipContent},v),y.addEventListener("focus",D,!1),function(){let t=a.create("div",{className:"TravelNotes-NoteDialog-DataDiv"},v);a.create("div",{className:"TravelNotes-BaseDialog-Button",title:b.getText("NoteDialog - Reset address"),innerHTML:"&#x1f504;"},t).addEventListener("click",M,!1),a.create("text",{value:b.getText("NoteDialog - Address")},t),T=a.create("input",{type:"text",value:e.address,className:"TravelNotes-NoteDialog-InputText"},a.create("div",{className:"TravelNotes-NoteDialog-DataDiv"},v)),T.addEventListener("focus",D,!1),i.getPromiseAddress(e.latLng).then(I).catch(x)}(),function(){let o=a.create("div",{className:"TravelNotes-NoteDialog-DataDiv"},v);t.note.theDevil.addButton&&a.create("div",{className:"TravelNotes-BaseDialog-Button",title:"Home",innerHTML:'<a href="https://www.google.com/maps/@'+e.lat.toFixed(s.fixed)+","+e.lng.toFixed(s.fixed)+","+t.note.theDevil.noteZoom+'z" target="_blank" title="'+t.note.theDevil.title+'" >'+t.note.theDevil.text+"</a> "},o),a.create("text",{value:b.getText("NoteDialog - Link")},o),N=a.create("input",{type:"text",className:"TravelNotes-NoteDialog-InputText",value:e.url},v),N.addEventListener("focus",()=>{r=null},!1)}(),a.create("div",{className:"TravelNotes-NoteDialog-DataDiv",innerHTML:b.getText("NoteDialog - Phone")},v),L=a.create("input",{type:"text",className:"TravelNotes-NoteDialog-InputText",value:e.phone},v),L.addEventListener("focus",D,!1),g})(e,o,n).show().then(()=>{ht(e,o,n)}).catch(e=>console.log(e||"An error occurs in the note dialog"))}function ft(e){let t=F();return t.latLng=e,t.iconLatLng=e,t}const bt=Object.seal(new class{get osmSearchNoteDialog(){return vt}changeOsmSearchNoteDialog(){vt=!vt}addAllManeuverNotes(e){let o=Le.getRoute(e),n=o.itinerary.maneuvers.iterator;for(gt=0;!n.done;)"kDepartDefault"===n.value.iconName&&!n.first||"kArriveDefault"===n.value.iconName&&!n.last||gt++;t.note.maxManeuversNotes<gt?ue.showError(b.getText("NoteEditor - max maneuvers notes reached {maneuversLength}{maxManeuversNotes}",{maneuversLength:gt,maxManeuversNotes:t.note.maxManeuversNotes})):function(e){let t=null;return function(){if(t=ee(),t.footer.classList.add("TravelNotes-TwoButtonsDialog-FooterDiv"),t.title=e.title||"",t.okButton.classList.add("TravelNotes-TwoButtonsDialog-Button"),e.okButtonContent&&(t.okButton.innerHTML=e.okButtonContent),e.secondButtonContent){a.create("div",{innerHTML:e.secondButtonContent,className:"TravelNotes-BaseDialog-Button TravelNotes-TwoButtonsDialog-Button"},t.footer).addEventListener("click",()=>t.cancelButton.click(),!0)}e.textContent&&a.create("div",{id:"TravelNotes-TwoButtonsDialog-MessageDiv",innerHTML:e.textContent},t.content)}(),t}({title:b.getText("NoteEditor - Add a note for each maneuver"),textContent:b.getText("NoteEditor - Add a note for each maneuver. Are you sure?",{noteLength:gt}),secondButtonContent:"&#x274C"}).show().then(()=>{n=o.itinerary.maneuvers.iterator,n.done||(ct=dt(),ct.createUI(),ut=1,function e(t,a){function o(){t.done?(a.notes.sort((e,t)=>e.distance-t.distance),ve.dispatch("updateitinerary"),ve.dispatch("roadbookupdate"),ct.close(),ct=null):e(t,a)}if(ct.showInfo(b.getText("NoteEditor - Creating note",{noteNumber:ut,notesLength:gt})),"kDepartDefault"===t.value.iconName&&!t.first||"kArriveDefault"===t.value.iconName&&!t.last)o();else{ut++;let e=a.itinerary.itineraryPoints.getAt(t.value.itineraryPointObjId).latLng;Ye().getPromiseIconAndAdress(e,a.objId).then(e=>{pt(e,a),o()}).catch(e=>{console.log(e||"an error occurs when creating the SVG icon."),o()})}}(n,o))}).catch(e=>console.log(e||"An error occurs in the note dialog"))}newRouteNote(e){let t=Le.getRoute(e.routeObjId),a=Pe.getClosestLatLngDistance(t,[e.lat,e.lng]),o=ft(a.latLng);o.distance=a.distance,mt(o,t.objId,!0)}newSearchNote(e){let t=[e.osmElement.lat,e.osmElement.lon],a=[e.osmElement.lat,e.osmElement.lon],o=-1,n=Number.MAX_VALUE;function r(e){if(e.objId!==$.editedRouteObjId){let r=Pe.getClosestLatLngDistance(e,t);if(r){let i=Pe.pointsDistance(t,r.latLng);i<n&&(o=e.objId,n=i,a=r.latLng)}}}e.isTravelNote||($.travel.routes.forEach(r),-1!==$.editedRouteObjId&&r($.travel.editedRoute));let i=F();i.latLng=a,i.iconLatLng=t,i.iconHeight=u.height,i.iconWidth=u.width,e.osmElement.tags.rcn_ref?i.iconContent="<div class='TravelNotes-MapNote TravelNotes-MapNoteCategory-0073'><svg viewBox='0 0 20 20'><text x='10' y='14'>"+e.osmElement.tags.rcn_ref+"</text></svg></div>":i.iconContent=st.getIconDataFromName(e.osmElement.description)||"",i.address=(e.osmElement.tags["addr:housenumber"]?e.osmElement.tags["addr:housenumber"]+" ":"")+(e.osmElement.tags["addr:street"]?e.osmElement.tags["addr:street"]+" ":"")+(e.osmElement.tags["addr:postcode"]?e.osmElement.tags["addr:postcode"]+" ":"")+(e.osmElement.tags["addr:city"]?e.osmElement.tags["addr:city"]+" ":""),i.url=e.osmElement.tags.website||"",i.phone=e.osmElement.tags.phone||"",i.tooltipContent=e.osmElement.description||"",i.popupContent=e.osmElement.tags.name||"",e.isTravelNote||-1!==o?vt||""===i.iconContent?mt(i,o,!0):ht(i,o,!0):ue.showError(b.getText("NoteEditor - No route was found"))}newManeuverNote(e){ct=dt(),ct.createUI();let t=$.travel.editedRoute,a=t.itinerary.maneuvers.getAt(e),o=t.itinerary.itineraryPoints.getAt(a.itineraryPointObjId).latLng;Ye().getPromiseIconAndAdress(o,t.objId).then(a=>{pt(a,t),t.notes.sort((e,t)=>e.distance-t.distance),t.itinerary.maneuvers.remove(e),ve.dispatch("showitinerary"),ve.dispatch("roadbookupdate"),ct.close(),ct=null}).catch(e=>{console.log(e||"an error occurs when creating the SVG icon."),ct.close(),ct=null})}newTravelNote(e){mt(ft(e),-1,!0)}editNote(e){let t=Le.getNoteAndRoute(e),a=null===t.route?-1:t.route.objId;mt(t.note,a,!1)}removeNote(e){let t=Le.getNoteAndRoute(e);t.route?(t.route.notes.remove(e),ve.dispatch("updateitinerary")):($.travel.notes.remove(e),ve.dispatch("updatetravelnotes")),ve.dispatch("noteupdated",{removedNoteObjId:e,addedNoteObjId:-1}),ve.dispatch("roadbookupdate")}hideNotes(){let e=$.travel.notes.iterator;for(;!e.done;)ve.dispatch("removeobject",{objId:e.value.objId});let t=$.travel.routes.iterator;for(;!t.done;)for(e=t.value.notes.iterator;!e.done;)ve.dispatch("removeobject",{objId:e.value.objId});if(-1!==$.editedRouteObjId)for(e=$.travel.editedRoute.notes.iterator;!e.done;)ve.dispatch("removeobject",{objId:e.value.objId})}showNotes(){this.hideNotes();let e=$.travel.notes.iterator;for(;!e.done;)ve.dispatch("noteupdated",{removedNoteObjId:-1,addedNoteObjId:e.value.objId});let t=$.travel.routes.iterator;for(;!t.done;)t.value.hidden||ve.dispatch("routeupdated",{removedRouteObjId:t.value.objId,addedRouteObjId:t.value.objId})}attachNoteToRoute(e){let t=Le.getNoteAndRoute(e),a=Number.MAX_VALUE,o=null,n=null,r=null;$.travel.routes.forEach(e=>{let i=Pe.getClosestLatLngDistance(e,t.note.latLng);if(i){let l=Pe.pointsDistance(t.note.latLng,i.latLng);l<a&&(a=l,o=e,n=i.latLng,r=i.distance)}}),o&&($.travel.notes.remove(e),t.note.distance=r,t.note.latLng=n,t.note.chainedDistance=o.chainedDistance,o.notes.add(t.note),o.notes.sort((e,t)=>e.distance-t.distance),ve.dispatch("noteupdated",{removedNoteObjId:e,addedNoteObjId:e}),ve.dispatch("updateitinerary"),ve.dispatch("updatetravelnotes"),ve.dispatch("roadbookupdate"))}detachNoteFromRoute(e){let t=Le.getNoteAndRoute(e);t.route.notes.remove(e),t.note.distance=n.invalid,t.note.chainedDistance=n.defaultValue,$.travel.notes.add(t.note),ve.dispatch("updateitinerary"),ve.dispatch("updatetravelnotes"),ve.dispatch("roadbookupdate")}travelNoteDropped(e,t,a){$.travel.notes.moveTo(e,t,a),ve.dispatch("updatetravelnotes"),ve.dispatch("roadbookupdate")}});function yt(){let e=null,a=1,o=1,n=Number.MAX_VALUE,r=0,i=0,l=null,s=0,d=t.route.elev.smoothCoefficient,u=t.route.elev.smoothPoints;function g(){let e=function(){let e=0,t=0,a=[],o=l.itinerary.itineraryPoints.iterator,n=0,r=o.done;for(a.push({distance:e,elev:o.value.elev}),n+=o.value.distance,r=o.done;!r;){for(e+=s;e>=n&&!r;)n+=o.value.distance,r=o.done;if(!r){let r=(o.value.elev-o.previous.elev)/o.previous.distance;t=o.value.elev-(n-e)*r,a.push({distance:e,elev:t})}}return a.push({distance:n,elev:l.itinerary.itineraryPoints.last.elev}),a}(),t=new Map,a=(e[u].elev-e[0].elev)/u,o=0;for(o=0;o<u;o++)t.set(o*s,{distance:o*s,elev:e[0].elev+a*o});for(o=u;o<e.length-u;o++){let a=0;for(let t=o-u;o+u>=t;t++)a+=e[t].elev;t.set(e[o].distance,{distance:e[o].distance,elev:a/(2*u+1)})}return o--,a=s*(e[e.length-1].elev-e[e.length-1-u].elev)/(e[e.length-1].distance-e[e.length-1-u].distance),t.set(e[o].distance+s,{distance:e[o].distance+s,elev:e[o].elev+a}),t.set(e[o].distance+2*s,{distance:e[o].distance+2*s,elev:e[o].elev+2*a}),t}function v(t){return l=t,n=Number.MAX_VALUE,r=0,l.itinerary.itineraryPoints.forEach(e=>{r=Math.max(r,e.elev),n=Math.min(n,e.elev)}),i=r-n,a=c.height/i,o=c.width/l.distance,e=document.createElementNS("http://www.w3.org/2000/svg","svg"),e.setAttributeNS(null,"viewBox","0 0 "+(c.width+2*c.margin)+" "+(c.height+2*c.margin)),e.setAttributeNS(null,"class","TravelNotes-SvgProfile"),function(){let t="",n=0,i=0,s=0;l.itinerary.itineraryPoints.forEach(e=>{i=(c.margin+o*n).toFixed(0),s=(c.margin+a*(r-e.elev)).toFixed(0),t+=i+","+s+" ",n+=e.distance});let d=document.createElementNS("http://www.w3.org/2000/svg","polyline");d.setAttributeNS(null,"points",t),d.setAttributeNS(null,"class","TravelNotes-SvgProfile-profilePolyline"),e.appendChild(d)}(),function(){const t=c.margin.toFixed(0),a=(c.margin+c.height).toFixed(0),o=(c.margin+c.width).toFixed(0),n=c.margin.toFixed(0);let r=t+","+n+" "+t+","+a+" "+o+","+a+" "+o+","+n,i=document.createElementNS("http://www.w3.org/2000/svg","polyline");i.setAttributeNS(null,"points",r),i.setAttributeNS(null,"class","TravelNotes-SvgProfile-framePolyline"),e.appendChild(i)}(),function(){let t=Number.MAX_VALUE,o=0;c.vScales.forEach(e=>{let a=Math.abs(i/4-e);a<t&&(t=a,o=e)});let l=Math.ceil(n/o)*o;const s=(c.margin+c.width+c.xDeltaText).toFixed(0),d=(c.margin-c.xDeltaText).toFixed(0);for(;l<r;){let t=c.margin+(r-l)*a,n=document.createElementNS("http://www.w3.org/2000/svg","text");n.appendChild(document.createTextNode(l.toFixed(0))),n.setAttributeNS(null,"class","TravelNotes-SvgProfile-elevLegend"),n.setAttributeNS(null,"x",s),n.setAttributeNS(null,"y",t),n.setAttributeNS(null,"text-anchor","start"),e.appendChild(n);let i=document.createElementNS("http://www.w3.org/2000/svg","text");i.appendChild(document.createTextNode(l.toFixed(0))),i.setAttributeNS(null,"class","TravelNotes-SvgProfile-elevLegend"),i.setAttributeNS(null,"x",d),i.setAttributeNS(null,"y",t),i.setAttributeNS(null,"text-anchor","end"),e.appendChild(i),l+=o}}(),function(){const t=c.margin+c.height+c.margin/2;let a=Number.MAX_VALUE,n=0;c.hScales.forEach(e=>{let t=Math.abs(l.distance/8-e);t<a&&(a=t,n=e)});let r=Math.ceil(l.chainedDistance/n)*n;for(;r<l.distance+l.chainedDistance;){let a=document.createElementNS("http://www.w3.org/2000/svg","text");a.appendChild(document.createTextNode(1e3<n||0<l.chainedDistance?r/1e3+" km":r+" m ")),a.setAttributeNS(null,"class","TravelNotes-SvgProfile-distLegend"),a.setAttributeNS(null,"x",c.margin+(r-l.chainedDistance)*o),a.setAttributeNS(null,"y",t),a.setAttributeNS(null,"text-anchor","start"),e.appendChild(a),r+=n}}(),e}return Object.seal(new class{smooth(e){!function(e){l=e;let t=l.itinerary.itineraryPoints.iterator,a=0,o=0;for(;!t.done;)a+=t.value.distance,o+=t.next?Math.abs(t.value.elev-t.next.elev):0;if(s=10*Math.floor(d/(o/a)),a<=2*u*s)return;let n=g();t=l.itinerary.itineraryPoints.iterator,t.done;let r=t.value.distance;for(;!t.done;){let e=n.get(Math.floor(r/s)*s),a=n.get(Math.ceil(r/s)*s);if(e&&a){let o=r-e.distance,n=(a.elev-e.elev)/(a.distance-e.distance);t.value.elev=e.elev+o*n}r+=t.value.distance}}(e)}createSvg(e){return v(e)}})}
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file ProfileWindow.js
	@copyright Copyright - 2017 2020 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/function Tt(){let e=p(),t=null,o=null,n=null,r=null,i=null,l=null,s=null,d=null;function u(e){let a=t.getBoundingClientRect(),o=(e.clientX-a.x-c.margin/(2*c.margin+c.width)*a.width)/(c.width/(2*c.margin+c.width)*a.width)*d.distance;return Pe.getLatLngElevAtDist(d,o)}function g(e){e.preventDefault(),e.stopPropagation();let t=u(e);t&&(e.routeObjId=d.objId,e.latlng={lat:t.latLng[0],lng:t.latLng[1]},e.originalEvent={clientX:e.clientX,clientY:e.clientY},function(e){let t=Ee(),a=Ge(e,[{context:bt,name:b.getText("ProfileContextMenu - Add a note to the route at this point"),action:bt.newRouteNote,param:{routeObjId:e.routeObjId,lat:e.latlng.lat,lng:e.latlng.lng}},{context:t,name:b.getText("ProfileContextMenu - Zoom to this point"),action:t.zoomToLatLng,param:[e.latlng.lat,e.latlng.lng]}]);return Object.seal(a)}(e).show())}function v(){ve.dispatch("removeobject",{objId:e})}function h(a){let l=t.getBoundingClientRect(),s=u(a);if(s){const u=3;ve.dispatch("removeobject",{objId:e}),ve.dispatch("additinerarypointmarker",{objId:e,latLng:s.latLng}),o&&(t.removeChild(o),t.removeChild(i),t.removeChild(n),t.removeChild(r));let g=(2*c.margin+c.width)*(a.clientX-l.x)/l.width,v=c.margin+c.height;o=document.createElementNS("http://www.w3.org/2000/svg","polyline"),o.setAttributeNS(null,"points",String(g)+","+c.margin+" "+g+","+v),o.setAttributeNS(null,"class","TravelNotes-SvgProfile-markerPolyline"),t.appendChild(o);let p=s.routeDistance>d.distance/2?"end":"start",h=s.routeDistance>d.distance/2?-c.xDeltaText:c.xDeltaText;i=document.createElementNS("http://www.w3.org/2000/svg","text"),i.appendChild(document.createTextNode(y.formatDistance(s.routeDistance))),i.setAttributeNS(null,"class","TravelNotes-SvgProfile-elevText"),i.setAttributeNS(null,"x",g+h),i.setAttributeNS(null,"y",c.margin+c.yDeltaText),i.setAttributeNS(null,"text-anchor",p),t.appendChild(i),n=document.createElementNS("http://www.w3.org/2000/svg","text"),n.appendChild(document.createTextNode("Alt. "+s.elev.toFixed(0)+" m.")),n.setAttributeNS(null,"class","TravelNotes-SvgProfile-elevText"),n.setAttributeNS(null,"x",g+h),n.setAttributeNS(null,"y",c.margin+2*c.yDeltaText),n.setAttributeNS(null,"text-anchor",p),t.appendChild(n),r=document.createElementNS("http://www.w3.org/2000/svg","text"),r.appendChild(document.createTextNode("Pente "+s.ascent.toFixed(0)+" % ")),r.setAttributeNS(null,"class","TravelNotes-SvgProfile-elevText"),r.setAttributeNS(null,"x",g+h),r.setAttributeNS(null,"y",c.margin+c.yDeltaText*u),r.setAttributeNS(null,"text-anchor",p),t.appendChild(r)}}function m(){t&&(t.removeEventListener("contextmenu",g,!1),t.removeEventListener("mousemove",h,!1),t.removeEventListener("mouseleave",v,!1),ve.dispatch("removeobject",{objId:e}),l.content.removeChild(s),l.content.removeChild(t)),t=null,o=null,r=null,i=null,n=null,s=null}return l=Me(),l.createWindow(),l.onClose=function(){m(),ve.dispatch("profileclosed",{objId:d.objId})},l.update=function(e){m(),d=e,t=yt().createSvg(e),l.header.innerHTML=b.getText("ProfileWindow - Profile {name}",d),l.content.appendChild(t),t.addEventListener("contextmenu",g,!1),t.addEventListener("mousemove",h,!1),t.addEventListener("mouseleave",v,!1),s=a.create("div",{className:"TravelNotes-ProfileWindow-Ascent",innerHTML:b.getText("ProfileWindow - Ascent: {ascent} m. - Descent: {descent} m. - Distance: {distance}",{ascent:d.itinerary.ascent.toFixed(0),descent:d.itinerary.descent.toFixed(0),distance:y.formatDistance(d.distance)})}),l.content.appendChild(s)},Object.seal(l)}let Nt=new Map,Lt=yt();const wt=Object.seal(new class{createProfile(e){let a=Nt.get(e.objId);if(e.itinerary.hasProfile){t.route.elev.smooth&&Lt.smooth(e),e.itinerary.ascent=0,e.itinerary.descent=0;let o=e.itinerary.itineraryPoints.first.elev;e.itinerary.itineraryPoints.forEach(t=>{let a=t.elev-o;0>a?e.itinerary.descent-=a:e.itinerary.ascent+=a,o=t.elev}),a&&a.update(e)}else a&&a.close()}updateProfile(e,t){let a=Nt.get(e);a&&(Nt.delete(e),t&&t.itinerary.hasProfile?(a.update(t),Nt.set(t.objId,a)):a.close())}deleteProfile(e){let t=Nt.get(e);t&&t.close()}deleteAllProfiles(){Nt.forEach(e=>e.close())}showProfile(e){let t=Nt.get(e);t||(t=Tt());let a=Le.getRoute(e);t.update(a),Nt.set(e,t)}onProfileClosed(e){Nt.delete(e)}});const It=Object.seal(new class{createUI(){a.create("div",{id:"TravelNotes-AttributionsUI"},document.querySelector("body")),this.attributions=""}set attributions(e){document.getElementById("TravelNotes-AttributionsUI").innerHTML='&copy; <a href="http://leafletjs.com/" target="_blank" title="Leaflet">Leaflet</a> | &copy; <a href="http://www.openstreetmap.org/copyright" target="_blank" title="OpenStreetMap contributors">OpenStreetMap contributors</a> '+e+'| &copy; <a href="https://github.com/wwwouaiebe" target="_blank" title="https://github.com/wwwouaiebe">Travel & Notes</a> '}});let xt=[{service:"wmts",url:"https://{s}.tile.osm.org/{z}/{x}/{y}.png",name:"OSM - Color",toolbar:{text:"OSM",color:"red",backgroundColor:"white"},providerName:"OSM",providerKeyNeeded:!1,attribution:""}],At=null,jt=null,Pt=null,Et=0,Mt=0,Dt=0,Rt=0;function Ot(e){e.target.setAttribute("style","color:"+e.target.layer.toolbar.backgroundColor+";background-color:"+e.target.layer.toolbar.color)}function Ct(e){e.target.setAttribute("style","color:"+e.target.layer.toolbar.color+";background-color:"+e.target.layer.toolbar.backgroundColor)}function St(e){e.target.classList.add("TravelNotes-LayersToolbarUI-LinkButton-Enter"),e.target.classList.remove("TravelNotes-LayersToolbarUI-LinkButton-Leave")}function Ut(e){ve.dispatch("layerchange",{layer:e.target.layer}),It.attributions=e.target.layer.attribution,$.travel.layerName=e.target.layer.name}function kt(e){e.target.classList.add("TravelNotes-LayersToolbarUI-LinkButton-Leave"),e.target.classList.remove("TravelNotes-LayersToolbarUI-LinkButton-Enter")}function Ht(e){e.deltaY&&(Et-=e.deltaY*g[e.deltaMode],Et=Et>Rt?Rt:Et,Et=Et<Rt-Dt+3*Mt?Rt-Dt+3*Mt:Et,Pt.style.marginTop=String(Et)+"px"),e.stopPropagation()}function Bt(){let e=Pt.childNodes;for(let t=0;t<e.length;t++)"layer"===e[t].type?(e[t].removeEventListener("mouseenter",Ot,!1),e[t].removeEventListener("mouseleave",Ct,!1),e[t].removeEventListener("click",Ut,!1)):(e[t].removeEventListener("mouseenter",St,!1),e[t].removeEventListener("mouseleave",St,!1));Pt.removeEventListener("wheel",Ht,!1),jt.removeChild(Pt),At=null}function Ft(){At=setTimeout(Bt,t.layersToolbarUI.toolbarTimeOut)}function Vt(){if(At)return clearTimeout(At),void(At=null);Pt=a.create("div",{id:"TravelNotes-LayersToolbarUI-Buttons"},jt),Rt=jt.clientHeight,Dt=0,xt.forEach(e=>function(e){if(e.providerKeyNeeded&&!Ne.getKey(e.providerName.toLowerCase()))return;let t=a.create("div",{type:"layer",className:"TravelNotes-LayersToolbarUI-Button",title:e.name,layer:e,innerHTML:e.toolbar.text,style:"color:"+e.toolbar.color+";background-color:"+e.toolbar.backgroundColor},Pt);t.addEventListener("mouseenter",Ot,!1),t.addEventListener("mouseleave",Ct,!1),t.addEventListener("click",Ut,!1),Mt=t.clientHeight,Dt+=Mt}(e)),t.layersToolbarUI.theDevil&&t.layersToolbarUI.theDevil.addButton&&function(e,t,o){let n=a.create("div",{type:"link",className:"TravelNotes-LayersToolbarUI-Button TravelNotes-LayersToolbarUI-LinkButton-Leave",innerHTML:'<a href="'+e+'" title="'+t+'" target="_blank">'+o+"</a>"},Pt);n.addEventListener("mouseenter",St,!1),n.addEventListener("mouseleave",kt,!1),Dt+=n.clientHeight}("https://www.google.com/maps/@"+$.map.getCenter().lat+","+$.map.getCenter().lng+","+$.map.getZoom()+"z",t.layersToolbarUI.theDevil.title,t.layersToolbarUI.theDevil.text),Rt+=Mt,Et=Rt,Pt.style.marginTop=String(Et)+"px",Pt.addEventListener("wheel",Ht,!1)}const Wt=Object.freeze(new class{createUI(){jt=a.create("div",{id:"TravelNotes-LayersToolbarUI"},document.querySelector("body")),a.create("div",{id:"TravelNotes-LayersToolbarUI-Header",innerHTML:b.getText("LayersToolbarUI - Layers")},jt),jt.addEventListener("mouseenter",Vt,!1),jt.addEventListener("mouseleave",Ft,!1),ve.dispatch("layerchange",{layer:xt[0]}),It.attributions=xt[0].attribution}getLayer(e){let t=xt.find(t=>t.name===e)||xt[0];if(t.providerKeyNeeded){Ne.getKey(t.providerName.toLowerCase())||(t=xt[0])}return t}setLayer(e){let t=xt.find(t=>t.name===e)||xt[0];if(t.providerKeyNeeded){Ne.getKey(t.providerName.toLowerCase())||(t=xt[0])}ve.dispatch("layerchange",{layer:t}),It.attributions=t.attribution,$.travel.layerName=t.name}addLayers(e){xt=xt.concat(e)}});function zt(){let e=null,o=null,n=null,r=[],i=0,l=null,s=document.querySelector("body"),d=0;function c(){for(;0<document.getElementsByClassName("TravelNotes-routeViewDiv").length;)s.removeChild(document.getElementsByClassName("TravelNotes-routeViewDiv")[0]);document.getElementById("TravelNotes-PrintToolbar-PrintButton").removeEventListener("click",()=>window.print(),!1),document.getElementById("TravelNotes-PrintToolbar-CancelButton").removeEventListener("click",c,!1),s.removeChild(document.getElementById("TravelNotes-PrintToolbar"));let e=s.children;for(let t=0;t<e.length;t++)e.item(t).classList.remove("TravelNotes-PrintViews-Hidden");$.map.invalidateSize(!1),window.removeEventListener("afterprint",c,!0)}function u(e,t,a){let o=function(e,t,a){if(e.bottomLeft.lat===e.upperRight.lat&&e.bottomLeft.lng===e.upperRight.lng){let e=Math.min(Math.abs(n[0]/(a.lat-t.lat)),Math.abs(n[1]/(a.lng-t.lng)));return{lat:t.lat+e*(a.lat-t.lat),lng:t.lng+e*(a.lng-t.lng)}}return null}(e,t,a);if(o)return o;if(o=function(e,t){return t.lat-e.bottomLeft.lat<1e-6||e.upperRight.lat-t.lat<1e-6||t.lng-e.bottomLeft.lng<1e-6||e.upperRight.lng-t.lng<1e-6?{lat:t.lat,lng:t.lng}:null}(e,t),o)return o;if(o=function(e,t,a){return t.lng===a.lng?{lat:t.lat>a.lat?e.bottomLeft.lat:e.upperRight.lat,lng:t.lng}:t.lat===a.lat?{lat:t.lat,lng:t.lng<a.lng?e.upperRight.lng:e.bottomLeft.lng}:null}(e,t,a),o)return o;let r=(t.lat-a.lat)/(t.lng-a.lng),i=t.lat-r*t.lng;if(o={lat:r*e.upperRight.lng+i,lng:e.upperRight.lng},o.lat<=e.upperRight.lat&&o.lat>=e.bottomLeft.lat&&o.lng<a.lng)return o;if(o={lat:e.upperRight.lat,lng:(e.upperRight.lat-i)/r},o.lng>=e.bottomLeft.lng&&o.lng<=e.upperRight.lng&&o.lat<a.lat)return o;if(o={lat:r*e.bottomLeft.lng+i,lng:e.bottomLeft.lng},o.lat<=e.upperRight.lat&&o.lat>=e.bottomLeft.lat&&o.lng>a.lng)return o;if(o={lat:e.bottomLeft.lat,lng:(e.bottomLeft.lat-i)/r},o.lng>=e.bottomLeft.lng&&o.lng<=e.upperRight.lng&&o.lat>a.lat)return o;throw new Error("intermediate point not found")}function g(n){i++;let r="TravelNotes-RouteViewDiv"+i,d=a.create("div",{className:"TravelNotes-routeViewDiv",id:r},s);e.pageBreak&&d.classList.add("TravelNotes-PrintPageBreak"),d.setAttribute("style","width:"+e.paperWidth+"mm;height:"+e.paperHeight+"mm;");let c=e.printNotes?function(){let e=[];return o.notes.forEach(a=>{let o=L.divIcon({iconSize:[a.iconWidth,a.iconHeight],iconAnchor:[a.iconWidth/2,a.iconHeight/2],popupAnchor:[0,-a.iconHeight/2],html:a.iconContent,className:"TravelNotes-AllNotes "+t.note.style});let n=L.marker(a.iconLatLng,{zIndexOffset:100,icon:o,draggable:!0});e.push(n)}),e}():[];c.push(function(){let e=Wt.getLayer($.travel.layerName),t=e.url;if(e.providerKeyNeeded){let a=Ne.getKey(e.providerName.toLowerCase());t=t.replace("{providerKey}",a)}let a=null;return a="wmts"===e.service.toLowerCase()?L.tileLayer(t):L.tileLayer.wms(t,e.wmsOptions),a.options.attribution=' &copy; <a href="http://www.openstreetmap.org/copyright" target="_blank" title="OpenStreetMap contributors">OpenStreetMap contributors</a> '+e.attribution+'| &copy; <a href="https://github.com/wwwouaiebe" target="_blank" title="https://github.com/wwwouaiebe">Travel & Notes</a> ',a}()),c.push(L.circleMarker([n.entryPoint.lat,n.entryPoint.lng],t.printRouteMap.entryPointMarker)),c.push(L.circleMarker([n.exitPoint.lat,n.exitPoint.lng],t.printRouteMap.exitPointMarker)),c.push(l),L.map(r,{attributionControl:!0,zoomControl:!1,center:[(n.bottomLeft.lat+n.upperRight.lat)/2,(n.bottomLeft.lng+n.upperRight.lng)/2],zoom:e.zoomFactor,minZoom:e.zoomFactor,maxZoom:e.zoomFactor,layers:c})}function v(){let e=s.children;for(let t=0;t<e.length;t++)e.item(t).classList.add("TravelNotes-PrintViews-Hidden");!function(){let e=a.create("div",{id:"TravelNotes-PrintToolbar"},s);a.create("div",{id:"TravelNotes-PrintToolbar-PrintButton",className:"TravelNotes-UI-Button",title:b.getText("PrintFactory - Print"),innerHTML:"&#x1F5A8;&#xFE0F;"},e).addEventListener("click",()=>window.print(),!1),a.create("div",{id:"TravelNotes-PrintToolbar-CancelButton",className:"TravelNotes-UI-Button",title:b.getText("PrintFactory - Cancel print"),innerHTML:"&#x274c;"},e).addEventListener("click",c,!1)}(),window.addEventListener("afterprint",c,!0);let t=[],n=o.itinerary.itineraryPoints.iterator;for(;!n.done;)t.push(n.value.latLng);l=L.polyline(t,{color:o.color,weight:o.width}),i=0,r.forEach(g)}return Object.freeze(new class{print(i,l){o=Le.getRoute(l),o&&(e=i,function(){let t=document.querySelector("body"),o=a.create("div",{},t);o.setAttribute("style","position:absolute;top:0,left:0;width:"+(e.paperWidth-2*e.borderWidth)+"mm;height:"+(e.paperHeight-2*e.borderWidth)+"mm;"),d=Math.ceil(o.clientWidth/256)*Math.ceil(o.clientHeight/256);let r=Pe.screenCoordToLatLng(0,0),i=Pe.screenCoordToLatLng(o.clientWidth,o.clientHeight);t.removeChild(o);let l=$.map.getZoomScale($.map.getZoom(),e.zoomFactor);n=[Math.abs(r[0]-i[0])*l,Math.abs(r[1]-i[1])*l]}(),function(){r=[];let e=o.itinerary.itineraryPoints.iterator,a=e.done,i={bottomLeft:{lat:e.value.lat,lng:e.value.lng},upperRight:{lat:e.value.lat,lng:e.value.lng}},l={lat:e.value.lat,lng:e.value.lng},s=e.value;a=e.done;let c=e.value;for(;!a;){let o={bottomLeft:{lat:Math.min(i.bottomLeft.lat,c.lat),lng:Math.min(i.bottomLeft.lng,c.lng)},upperRight:{lat:Math.max(i.upperRight.lat,c.lat),lng:Math.max(i.upperRight.lng,c.lng)}},g=[o.upperRight.lat-o.bottomLeft.lat,o.upperRight.lng-o.bottomLeft.lng];n[0]>g[0]&&n[1]>g[1]?(i=o,s=e.value,a=e.done,c=e.value,a&&(i.entryPoint=l,i.exitPoint=s,r.push(i))):(s=u(i,s,c),i.bottomLeft={lat:Math.min(i.bottomLeft.lat,s.lat),lng:Math.min(i.bottomLeft.lng,s.lng)},i.upperRight={lat:Math.max(i.upperRight.lat,s.lat),lng:Math.max(i.upperRight.lng,s.lng)},i.entryPoint=l,i.exitPoint=s,r.push(i),i={bottomLeft:{lat:s.lat,lng:s.lng},upperRight:{lat:s.lat,lng:s.lng}},l={lat:s.lat,lng:s.lng}),t.printRouteMap.maxTiles<r.length*d&&(a=!0)}}(),t.printRouteMap.maxTiles<r.length*d?ue.showError(b.getText("PrintFactory - The maximum of allowed pages is reached.")):v())}})}let Kt=!1,Xt=!1;function Zt(){let e=$.travel.routes.iterator,t=n.defaultValue;for(;!e.done;){e.value.chain?(e.value.chainedDistance=t,t+=e.value.distance):e.value.chainedDistance=n.defaultValue;let a=e.value.notes.iterator;for(;!a.done;)a.value.chainedDistance=e.value.chainedDistance}}function Gt(e){let t=!0;return e.wayPoints.forEach(e=>{t=t&&s.defaultValue!==e.lat&&s.defaultValue!==e.lng}),t}function Jt(e){Xt=!1,ue.showError(e),console.log(e||"An error occurs when asking the route to the provider")}function Yt(){if(Xt=!1,function(e){let t=e.itinerary.itineraryPoints.iterator,a=e.itinerary.maneuvers.iterator;for(t.done,a.done,a.value.distance=n.defaultValue,a.done,e.distance=n.defaultValue,e.duration=n.defaultValue;!t.done;)t.previous.distance=Pe.pointsDistance(t.previous.latLng,t.value.latLng),e.distance+=t.previous.distance,a.previous.distance+=t.previous.distance,a.value.itineraryPointObjId===t.value.objId&&(e.duration+=a.previous.duration,a.value.distance=n.defaultValue,a.next&&a.value.itineraryPointObjId===a.next.itineraryPointObjId&&(a.done,a.value.distance=n.defaultValue),a.done)}($.travel.editedRoute),"circle"!==$.travel.editedRoute.itinerary.transitMode){let e=$.travel.editedRoute.wayPoints.iterator;for(;!e.done;)e.first?e.value.latLng=$.travel.editedRoute.itinerary.itineraryPoints.first.latLng:e.last?e.value.latLng=$.travel.editedRoute.itinerary.itineraryPoints.last.latLng:e.value.latLng=Pe.getClosestLatLngDistance($.travel.editedRoute,e.value.latLng).latLng}let e=$.travel.editedRoute.notes.iterator;for(;!e.done;){let t=Pe.getClosestLatLngDistance($.travel.editedRoute,e.value.latLng);e.value.latLng=t.latLng,e.value.distance=t.distance}Zt(),$.travel.editedRoute.notes.sort((e,t)=>e.distance-t.distance),Kt&&Ee().zoomToRoute($.travel.editedRoute.objId),wt.createProfile($.travel.editedRoute),ve.dispatch("routeupdated",{removedRouteObjId:$.travel.editedRoute.objId,addedRouteObjId:$.travel.editedRoute.objId}),ve.dispatch("roadbookupdate"),ve.dispatch("showitinerary")}const qt=Object.seal(new class{addRoute(){let e=K();$.travel.routes.add(e),d.editedChanged===$.travel.editedRoute.editionStatus?(Zt(),ve.dispatch("setrouteslist"),ve.dispatch("roadbookupdate")):this.editRoute(e.objId)}editRoute(e){if(d.editedChanged===$.travel.editedRoute.editionStatus)return void ue.showError(b.getText("RouteEditor - Not possible to edit a route without a save or cancel"));let t=Le.getRoute(e),a=t.itinerary.provider,o=$.providers.get(a.toLowerCase());if(a&&""!==a&&(!o||o.providerKeyNeeded&&!Ne.getKey(a)))return void ue.showError(b.getText("RouteEditor - Not possible to edit a route created with this provider",{provider:a}));-1!==$.editedRouteObjId&&this.cancelEdition(),a&&""!==a&&ve.dispatch("setprovider",{provider:a});let n=t.itinerary.transitMode;n&&""!==n&&ve.dispatch("settransitmode",{transitMode:n}),$.travel.editedRoute=K(),t.editionStatus=d.editedNoChange,$.travel.editedRoute.jsonObject=t.jsonObject,$.editedRouteObjId=t.objId,$.travel.editedRoute.hidden=!1,t.hidden=!1,wt.updateProfile($.editedRouteObjId,$.travel.editedRoute),Zt(),ve.dispatch("routeupdated",{removedRouteObjId:t.objId,addedRouteObjId:$.travel.editedRoute.objId}),ve.dispatch("roadbookupdate"),ve.dispatch("showitinerary"),ve.dispatch("setrouteslist")}removeRoute(e){let t=e;if(t===$.editedRouteObjId||t===$.travel.editedRoute.objId){if(d.editedChanged===$.travel.editedRoute.editionStatus)return void ue.showError(b.getText("TravelEditor - Cannot remove an edited route"));t=$.editedRouteObjId,this.cancelEdition()}ve.dispatch("routeupdated",{removedRouteObjId:t,addedRouteObjId:-1}),$.travel.routes.remove(t),wt.deleteProfile(t),Zt(),ve.dispatch("roadbookupdate"),ve.dispatch("setrouteslist")}removeManeuver(e){($.travel.editedRoute.itinerary.maneuvers.previous(e,e=>n.defaultValue<e.distance)||$.travel.editedRoute.itinerary.maneuvers.first).distance+=$.travel.editedRoute.itinerary.maneuvers.getAt(e).distance,$.travel.editedRoute.itinerary.maneuvers.remove(e),ve.dispatch("showitinerary"),ve.dispatch("roadbookupdate")}saveGpx(e){we().routeToGpx(e)}chainRoutes(){Zt()}startRouting(){if(t.routing.auto&&!Xt&&Gt($.travel.editedRoute)){Kt=0===$.travel.editedRoute.itinerary.itineraryPoints.length,Xt=!0;let e=$.providers.get($.routing.provider.toLowerCase());$.travel.editedRoute.itinerary.provider=e.name,$.travel.editedRoute.itinerary.transitMode=$.routing.transitMode,e.getPromiseRoute($.travel.editedRoute,null).then(Yt).catch(Jt)}}saveEdition(){let e=K();e.jsonObject=$.travel.editedRoute.jsonObject,$.travel.routes.replace($.editedRouteObjId,e),$.editedRouteObjId=e.objId,this.cancelEdition()}cancelEdition(){let e=Le.getRoute($.editedRouteObjId);e.editionStatus=d.notEdited,wt.updateProfile($.travel.editedRoute.objId,e),ve.dispatch("routeupdated",{removedRouteObjId:$.travel.editedRoute.objId,addedRouteObjId:$.editedRouteObjId}),$.editedRouteObjId=-1,$.travel.editedRoute=K(),Zt(),ve.dispatch("roadbookupdate"),ve.dispatch("setrouteslist"),ve.dispatch("showitinerary")}routeProperties(e){let t=Le.getRoute(e);xe(t).show().then(()=>{Zt(),Gt(t)&&ve.dispatch("routepropertiesupdated",{routeObjId:t.objId}),ve.dispatch("roadbookupdate"),ve.dispatch("setrouteslist"),ve.dispatch("updateitinerary")}).catch(e=>console.log(e||"An error occurs in the route properties dialog"))}printRouteMap(e){(function(){let e=null,o=null,n=null,r=null,i=null,l=null,s=null,d=null;function c(){return Object.seal({paperWidth:parseInt(n.value),paperHeight:parseInt(r.value),borderWidth:parseInt(i.value),zoomFactor:parseInt(d.value),pageBreak:l.checked,printNotes:s.checked})}return e=ee(),e.title=b.getText("PrintRouteMapDialog - Print"),e.okButtonListener=c,o=a.create("div",{id:"TravelNotes-PrintRouteMapDialog-MainDataDiv"},e.content),function(){let e=a.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv"},o);a.create("text",{value:b.getText("PrintRouteMapDialog - Paper width")},e),n=a.create("input",{type:"number",className:"TravelNotes-PrintRouteMapDialog-NumberInput"},e),n.value=t.printRouteMap.paperWidth,a.create("text",{value:b.getText("PrintRouteMapDialog - Paper width units")},e)}(),function(){let e=a.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv"},o);a.create("text",{value:b.getText("PrintRouteMapDialog - Paper height")},e),r=a.create("input",{type:"number",className:"TravelNotes-PrintRouteMapDialog-NumberInput",value:t.printRouteMap.paperHeight},e),a.create("text",{value:b.getText("PrintRouteMapDialog - Paper height units")},e)}(),function(){let e=a.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv"},o);a.create("text",{value:b.getText("PrintRouteMapDialog - Border width")},e),i=a.create("input",{type:"number",className:"TravelNotes-PrintRouteMapDialog-NumberInput",id:"TravelNotes-PrintRouteMapDialog-BorderWidthNumberInput",value:t.printRouteMap.borderWidth},e),a.create("text",{value:b.getText("PrintRouteMapDialog - Border width units")},e)}(),function(){let e=a.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv",id:"TravelNotes-PrintRouteMapDialog-ZoomFactorDataDiv"},o);a.create("text",{value:b.getText("PrintRouteMapDialog - Zoom factor")},e),d=a.create("input",{type:"number",className:"TravelNotes-PrintRouteMapDialog-NumberInput",value:Math.min(t.printRouteMap.zoomFactor,15),min:$.map.getMinZoom(),max:Math.min($.map.getMaxZoom(),15)},e)}(),function(){let e=a.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv",id:"TravelNotes-PrintRouteMapDialog-PageBreakDataDiv"},o);l=a.create("input",{type:"checkbox",id:"TravelNotes-PrintRouteMapDialog-PageBreakInput",checked:t.printRouteMap.pageBreak},e),a.create("text",{value:b.getText("PrintRouteMapDialog - Page break")},e)}(),function(){let e=a.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv",id:"TravelNotes-PrintRouteMapDialog-PrintNotesDataDiv"},o);s=a.create("input",{type:"checkbox",id:"TravelNotes-PrintRouteMapDialog-PrintNotesInput",checked:t.printRouteMap.printNotes},e),a.create("text",{value:b.getText("PrintRouteMapDialog - Print notes")},e)}(),e})().show().then(t=>zt().print(t,e)).catch(e=>console.log(e||"An error occurs in the route properties dialog"))}showRoute(e){Le.getRoute(e).hidden=!1,ve.dispatch("routeupdated",{removedRouteObjId:-1,addedRouteObjId:e}),ve.dispatch("setrouteslist")}hideRoute(e){Le.getRoute(e).hidden=!0,ve.dispatch("routeupdated",{removedRouteObjId:e,addedRouteObjId:-1}),ve.dispatch("setrouteslist")}showRoutes(){let e=$.travel.routes.iterator;for(;!e.done;)e.value.hidden&&(e.value.hidden=!1,ve.dispatch("routeupdated",{removedRouteObjId:-1,addedRouteObjId:e.value.objId}));ve.dispatch("setrouteslist")}hideRoutes(){let e=$.travel.routes.iterator;for(;!e.done;)e.value.hidden||e.value.objId===$.editedRouteObjId||(e.value.hidden=!0,ve.dispatch("routeupdated",{removedRouteObjId:e.value.objId,addedRouteObjId:-1}));ve.dispatch("setrouteslist")}});function Qt(e,a){if(!t.wayPoint.reverseGeocoding)return;let o=qe();o.getPromiseAddress(e).then(e=>{let t=o.parseResponse(e),n=t.street;""!==t.city&&(n+=" "+t.city),function(e,t){$.travel.editedRoute.editionStatus=d.editedChanged;let a=$.travel.editedRoute.wayPoints.getAt(t);a.name=e.name,a.address=e.address,ve.dispatch("setrouteslist"),ve.dispatch("showitinerary"),ve.dispatch("roadbookupdate")}(Object.seal({name:t.name,address:n}),a)}).catch(e=>console.log(e||"An error occurs in the geoCoder"))}const _t=Object.seal(new class{addWayPoint(e){$.travel.editedRoute.editionStatus=d.editedChanged;let t=I();t.latLng=e,Qt(e,t.objId),$.travel.editedRoute.wayPoints.add(t),ve.dispatch("addwaypoint",{wayPoint:$.travel.editedRoute.wayPoints.last,letter:$.travel.editedRoute.wayPoints.length-2}),$.travel.editedRoute.wayPoints.swap(t.objId,!0),qt.startRouting()}addWayPointOnRoute(e,t){let a=Pe.getClosestLatLngDistance($.travel.editedRoute,e).distance;$.travel.editedRoute.editionStatus=d.editedChanged;let o=I();o.latLng=t,Qt(t,o.objId),$.travel.editedRoute.wayPoints.add(o),ve.dispatch("addwaypoint",{wayPoint:$.travel.editedRoute.wayPoints.last,letter:$.travel.editedRoute.wayPoints.length-2});let n=$.travel.editedRoute.wayPoints.iterator;for(;!n.done;){if(a<Pe.getClosestLatLngDistance($.travel.editedRoute,n.value.latLng).distance){$.travel.editedRoute.wayPoints.moveTo(o.objId,n.value.objId,!0);break}}qt.startRouting()}reverseWayPoints(){$.travel.editedRoute.editionStatus=d.editedChanged;let e=$.travel.editedRoute.wayPoints.iterator;for(;!e.done;)ve.dispatch("removeobject",{objId:e.value.objId});for($.travel.editedRoute.wayPoints.reverse(),e=$.travel.editedRoute.wayPoints.iterator;!e.done;)ve.dispatch("addwaypoint",{wayPoint:e.value,letter:e.first?"A":e.last?"B":e.index});ve.dispatch("setrouteslist"),ve.dispatch("showitinerary"),ve.dispatch("roadbookupdate"),qt.startRouting()}removeWayPoint(e){$.travel.editedRoute.editionStatus=d.editedChanged,ve.dispatch("removeobject",{objId:e}),$.travel.editedRoute.wayPoints.remove(e),qt.startRouting()}setStartPoint(e){$.travel.editedRoute.editionStatus=d.editedChanged,s.defaultValue!==$.travel.editedRoute.wayPoints.first.lat&&ve.dispatch("removeobject",{objId:$.travel.editedRoute.wayPoints.first.objId}),$.travel.editedRoute.wayPoints.first.latLng=e,t.wayPoint.reverseGeocoding&&Qt(e,$.travel.editedRoute.wayPoints.first.objId),ve.dispatch("addwaypoint",{wayPoint:$.travel.editedRoute.wayPoints.first,letter:"A"}),qt.startRouting()}setEndPoint(e){$.travel.editedRoute.editionStatus=d.editedChanged,s.defaultValue!==$.travel.editedRoute.wayPoints.last.lat&&ve.dispatch("removeobject",{objId:$.travel.editedRoute.wayPoints.last.objId}),$.travel.editedRoute.wayPoints.last.latLng=e,t.wayPoint.reverseGeocoding&&Qt(e,$.travel.editedRoute.wayPoints.last.objId),ve.dispatch("addwaypoint",{wayPoint:$.travel.editedRoute.wayPoints.last,letter:"B"}),qt.startRouting()}wayPointDragEnd(e){$.travel.editedRoute.editionStatus=d.editedChanged,t.wayPoint.reverseGeocoding&&Qt($.travel.editedRoute.wayPoints.getAt(e).latLng,e),qt.startRouting()}wayPointProperties(e){(function(e){let o=null,n=null,r=null,i=null;function l(){return e.name=r.value,e.address=i.value,e}function s(a){if(a.stopPropagation(),!t.wayPoint.reverseGeocoding)return;let o=qe();o.getPromiseAddress(e.latLng).then(e=>{let t=o.parseResponse(e),a=t.street;""!==t.city&&(a+=" "+t.city),i.value=a}).catch(e=>console.log(e||"An error occurs in the geoCoder"))}return o=ee(),o.title=b.getText("WayPointPropertiesDialog - Waypoint properties"),o.okButtonListener=l,n=a.create("div",{id:"TravelNotes-WayPointPropertiesDialog-DataDiv"},o.content),a.create("div",{innerHTML:b.getText("WayPointPropertiesDialog - Name")},n),r=a.create("input",{type:"text",value:e.name,className:"TravelNotes-WayPointPropertiesDialog-Input"},a.create("div",null,n)),function(){let t=a.create("div",null,n);a.create("div",{className:"TravelNotes-BaseDialog-Button",title:b.getText("WayPointPropertiesDialog - Reset address"),innerHTML:"&#x1f504;"},t).addEventListener("click",s,!1),a.create("text",{value:b.getText("WayPointPropertiesDialog - Address")},t),i=a.create("input",{type:"text",value:e.address,className:"TravelNotes-WayPointPropertiesDialog-Input"},a.create("div",null,n))}(),o})($.travel.editedRoute.wayPoints.getAt(e)).show().then(()=>{ve.dispatch("setrouteslist"),ve.dispatch("showitinerary"),ve.dispatch("roadbookupdate")}).catch(e=>console.log(e||"An error occurs in the waypoint properties dialog"))}});function $t(e,a){let o=e.target.objId,n=Le.getRoute(o),r=Ee();let i=Ge(e,function(){let a=[{context:qt,name:b.getText("RouteContextMenu - Edit this route"),action:o===$.travel.editedRoute.objId||d.editedChanged===$.travel.editedRoute.editionStatus?null:qt.editRoute,param:o},{context:qt,name:b.getText("RouteContextMenu - Delete this route"),action:o===$.travel.editedRoute.objId&&d.editedChanged===$.travel.editedRoute.editionStatus?null:qt.removeRoute,param:o},n.hidden?{context:qt,name:b.getText("RouteContextMenu - Show this route"),action:qt.showRoute,param:o}:{context:qt,name:b.getText("RouteContextMenu - Hide this route"),action:$.travel.editedRoute.objId===o?null:qt.hideRoute,param:o},{context:qt,name:b.getText("RouteContextMenu - Properties"),action:n.hidden?null:qt.routeProperties,param:o},{context:r,name:b.getText("RouteContextMenu - Zoom to route"),action:r.zoomToRoute,param:o},{context:wt,name:b.getText("RouteContextMenu - View the elevation"),action:n.itinerary.hasProfile?wt.showProfile:null,param:o}];return t.printRouteMap.isEnabled&&a.push({context:qt,name:b.getText("RouteContextMenu - Print route map"),action:qt.printRouteMap,param:o}),a=a.concat([{context:qt,name:b.getText("RouteContextMenu - Save this route in a GPX file"),action:0<n.itinerary.itineraryPoints.length?qt.saveGpx:null,param:o},{context:_t,name:b.getText("RouteContextMenu - Invert waypoints"),action:$.travel.editedRoute.objId===o?_t.reverseWayPoints:null},{context:bt,name:b.getText("RouteContextMenu - Add a note on the route"),action:e.fromUI?null:bt.newRouteNote,param:{routeObjId:o,lat:e.latlng.lat,lng:e.latlng.lng}},{context:bt,name:b.getText("RouteContextMenu - Create a note for each route maneuver"),action:n.hidden?null:bt.addAllManeuverNotes,param:o},{context:qt,name:b.getText("RouteContextMenu - Save modifications on this route"),action:$.travel.editedRoute.objId===o?qt.saveEdition:null},{context:qt,name:b.getText("RouteContextMenu - Cancel modifications on this route"),action:$.travel.editedRoute.objId===o?qt.cancelEdition:null}]),a}(),a);return Object.seal(i)}function ea(e,t){let a=e.noteObjId||e.target.objId,o=Ee();let n=Ge(e,function(){let e=Le.getNoteAndRoute(a).route;return[{context:bt,name:b.getText("NoteContextMenu - Edit this note"),action:bt.editNote,param:a},{context:bt,name:b.getText("NoteContextMenu - Delete this note"),action:bt.removeNote,param:a},{context:o,name:b.getText("NoteContextMenu - Zoom to note"),action:o.zoomToNote,param:a},{context:bt,name:e?b.getText("NoteContextMenu - Detach note from route"):b.getText("NoteContextMenu - Attach note to route"),action:0!==$.travel.routes.length&&-1===$.editedRouteObjId?e?bt.detachNoteFromRoute:bt.attachNoteToRoute:null,param:a}]}(),t);return Object.seal(n)}function ta(e,t){let o=t.note,n=a.create("div");if(0!==o.tooltipContent.length&&a.create("div",{className:e+"NoteHtml-TooltipContent",innerHTML:o.tooltipContent},n),0!==o.popupContent.length&&a.create("div",{className:e+"NoteHtml-PopupContent",innerHTML:o.popupContent},n),0!==o.address.length&&a.create("div",{className:e+"NoteHtml-Address",innerHTML:b.getText("HTMLViewsFactory - Address")+o.address},n),0!==o.phone.length&&a.create("div",{className:e+"NoteHtml-Phone",innerHTML:b.getText("HTMLViewsFactory - Phone")+o.phone},n),0!==o.url.length&&a.create("a",{href:o.url,target:"_blank",innerHTML:o.url.substr(0,40)+"..."},a.create("div",{className:e+"NoteHtml-Url",innerHTML:b.getText("HTMLViewsFactory - Link")},n)),a.create("div",{className:e+"NoteHtml-LatLng",innerHTML:b.getText("HTMLViewsFactory - Latitude Longitude",{lat:y.formatLat(o.lat),lng:y.formatLng(o.lng)})},n),t.route){t.route.chain&&a.create("div",{className:e+"NoteHtml-Distance",innerHTML:b.getText("HTMLViewsFactory - Distance from start of travel",{distance:y.formatDistance(o.chainedDistance+o.distance)})},n),a.create("div",{className:e+"NoteHtml-Distance",innerHTML:b.getText("HTMLViewsFactory - Distance from start of route",{distance:y.formatDistance(o.distance)})},n);let r=t.route.notes.next(o.objId);if(r){let t=r.distance-o.distance;9<t&&a.create("div",{className:e+"NoteHtml-NextDistance",innerHTML:b.getText("HTMLViewsFactory - Next note after&nbsp;:&nbsp;{distance}",{distance:y.formatDistance(t)})},n)}}return n}function aa(e,o){let n=a.create("div"),r=a.create("div",{className:e+"Travel-Notes-IconCell",innerHTML:o.note.iconContent},n);"svg"===r.firstChild.tagName&&"TravelNotes-Roadbook-"===e&&r.firstChild.setAttributeNS(null,"viewBox","0 0 "+t.note.svgIconWidth+" "+t.note.svgIconWidth);let i=ta(e,o);return i.className=e+"Travel-Notes-Cell",n.appendChild(i),n.noteObjId=o.note.objId,n}function oa(e){let t=a.create("div",{className:e+"Travel-Notes"}),o=$.travel.notes.iterator;for(;!o.done;){let a=aa(e,{note:o.value,route:null});a.className=e+"Travel-Notes-Row",t.appendChild(a)}return t}function na(e,t){let o=a.create("div",{className:e+"Route-Header",id:"route"+t.objId});return a.create("div",{className:e+"Route-Header-Name",innerHTML:t.computedName},o),0!==t.distance&&a.create("div",{className:e+"Route-Header-Distance",innerHTML:b.getText("HTMLViewsFactory - Distance",{distance:y.formatDistance(t.distance)})},o),$.travel.readOnly||"bike"===t.itinerary.transitMode||a.create("div",{className:e+"Route-Header-Duration",innerHTML:b.getText("HTMLViewsFactory - Duration",{duration:y.formatTime(t.duration)})},o),t.itinerary.hasProfile&&(a.create("div",{className:e+"Route-Header-Ascent",innerHTML:b.getText("HTMLViewsFactory - Ascent",{ascent:t.itinerary.ascent.toFixed(0)})},o),a.create("div",{className:e+"Route-Header-Descent",innerHTML:b.getText("HTMLViewsFactory - Descent",{descent:t.itinerary.descent.toFixed(0)})},o)),o}function ra(e,t){let o=a.create("div");a.create("div",{className:e+"Route-ManeuversAndNotes-IconCell TravelNotes-ManeuverNote-"+t.maneuver.iconName},o);let r=a.create("div",{className:e+"Route-ManeuversAndNotes-Cell"},o);return a.create("div",{innerHTML:t.maneuver.instruction},r),t.route.chain&&a.create("div",{innerHTML:b.getText("HTMLViewsFactory - Distance from start of travel",{distance:y.formatDistance(t.route.chainedDistance+t.maneuverDistance)})},r),a.create("div",{innerHTML:b.getText("HTMLViewsFactory - Distance from start of route",{distance:y.formatDistance(t.maneuverDistance)})},r),n.defaultValue<t.maneuver.distance&&a.create("div",{innerHTML:b.getText("HTMLViewsFactory - Next maneuver after&nbsp;:&nbsp;{distance}",{distance:y.formatDistance(t.maneuver.distance)})},r),o}function ia(e,t){let o=[],n=t.notes.iterator;for(;!n.done;){let a=aa(e,{note:n.value,route:t});a.className=e+"Route-Notes-Row",a.objId=p(),a.latLng=n.value.latLng,a.noteObjId=n.value.objId,a.distance=n.value.distance,o.push(a)}let r=t.itinerary.maneuvers.iterator,i=0;for(;!r.done;){let a=ra(e,{route:t,maneuver:r.value,maneuverDistance:i});a.className=e+"Route-Maneuvers-Row",a.objId=p(),a.latLng=t.itinerary.itineraryPoints.getAt(r.value.itineraryPointObjId).latLng,a.maneuverObjId=r.value.objId,a.distance=i,o.push(a),i+=r.value.distance}o.sort((e,t)=>e.distance-t.distance);let l=a.create("div",{className:e+"Route-ManeuversAndNotes"});return o.forEach(e=>l.appendChild(e)),l}function la(e,t){let o="";return""!==t.itinerary.provider&&""!==t.itinerary.transitMode&&(o=b.getText("HTMLViewsFactory - Itinerary computed by {provider} and optimized for {transitMode}",{provider:t.itinerary.provider,transitMode:b.getText("HTMLViewsFactory - TransitMode "+t.itinerary.transitMode)})),a.create("div",{className:e+"RouteFooter",innerHTML:o})}function sa(e,t){let o=a.create("div",{className:e+"RouteProfile",innerHTML:b.getText("HTMLViewsFactory - Profile")});return o.appendChild(yt().createSvg(t)),o}function da(e){let o=a.create("div",{className:e+"Travel"});o.appendChild(function(e){let o=a.create("div",{className:e+"Travel-Header"});a.create("div",{className:e+"Travel-Header-Name",innerHTML:$.travel.name},o);let r=n.defaultValue,i=0,l=0,s=$.travel.routes.iterator;for(;!s.done;){let n=s.value.objId===$.editedRouteObjId&&t.routeEditor.displayEditionInHTMLPage?$.travel.editedRoute:s.value,d=a.create("div",{className:e+"Travel-Header-RouteName"},o);a.create("a",{href:"#route"+n.objId,innerHTML:n.computedName},d),a.create("text",{value:" : "+y.formatDistance(n.distance)+"."},d),n.chain&&(r+=n.distance,i+=n.itinerary.ascent,l+=n.itinerary.descent)}return a.create("div",{className:e+"Travel-Header-TravelDistance",innerHTML:b.getText("HTMLViewsFactory - Travel distance&nbsp;:&nbsp;{distance}",{distance:y.formatDistance(r)})},o),0!==i&&a.create("div",{className:e+"Travel-Header-TravelAscent",innerHTML:b.getText("HTMLViewsFactory - Travel ascent&nbsp;:&nbsp;{ascent}",{ascent:i.toFixed(0)})},o),0!==l&&a.create("div",{className:e+"Travel-Header-TravelDescent",innerHTML:b.getText("HTMLViewsFactory - Travel descent&nbsp;:&nbsp;{descent}",{descent:l.toFixed(0)})},o),o}(e)),o.appendChild(oa(e));let r=$.travel.routes.iterator;for(;!r.done;){let a=t.routeEditor.displayEditionInHTMLPage&&r.value.objId===$.editedRouteObjId?$.travel.editedRoute:r.value;o.appendChild(na(e,a)),a.itinerary.hasProfile&&o.appendChild(sa(e,a)),o.appendChild(ia(e,a)),o.appendChild(la(e,a))}return o.appendChild(function(e){return a.create("div",{className:e+"TravelFooter",innerHTML:b.getText("HTMLViewsFactory - Travel footer")})}(e)),o}const ca=Object.freeze(new class{getTravelHTML(e){return da(e)}getNoteTextHTML(e,t){return ta(e,t)}getEditedRouteManeuversAndNotesHTML(e){return ia(e,$.travel.editedRoute)}getTravelNotesHTML(e){return oa(e)}getRouteHeaderHTML(e,t){return na(e,t)}});let ua=null,ga=null;function va(e){let t=Le.getRoute(e.target.objId),a=Pe.getClosestLatLngDistance(t,[e.latlng.lat,e.latlng.lng]).distance;a+=t.chainedDistance,a=y.formatDistance(a);let o=$.mapObjects.get(e.target.objId);o.closeTooltip();let n=t.computedName;$.travel.readOnly||(n+=0===n.length?"":" - ",n+=a),o.setTooltipContent(n),o.openTooltip(e.latlng)}function pa(e,t){t.objId=e,t.addTo($.map),$.mapObjects.set(e,t)}function ha(e){let a=Le.getNoteAndRoute(e).note,o=L.marker(a.latLng,{icon:L.divIcon({iconSize:[t.note.grip.size,t.note.grip.size],iconAnchor:[t.note.grip.size/2,t.note.grip.size/2],html:"<div></div>",className:"TravelNotes-Note-Bullet"}),opacity:t.note.grip.opacity,draggable:!$.travel.readOnly});o.objId=a.objId;let n=L.divIcon({iconSize:[a.iconWidth,a.iconHeight],iconAnchor:[a.iconWidth/2,a.iconHeight/2],popupAnchor:[0,-a.iconHeight/2],html:a.iconContent,className:"TravelNotes-AllNotes "+t.note.style});let r=L.marker(a.iconLatLng,{zIndexOffset:100,icon:n,draggable:!$.travel.readOnly});r.objId=a.objId,r.bindPopup(e=>ca.getNoteTextHTML("TravelNotes-",Le.getNoteAndRoute(e.objId))),0!==a.tooltipContent.length&&(r.bindTooltip(e=>Le.getNoteAndRoute(e.objId).note.tooltipContent),r.getTooltip().options.offset[0]=a.iconWidth/2);let i=L.polyline([a.latLng,a.iconLatLng],t.note.polyline);i.objId=a.objId;let l=L.layerGroup([r,i,o]);return l.markerId=L.Util.stamp(r),l.polylineId=L.Util.stamp(i),l.bulletId=L.Util.stamp(o),pa(a.objId,l),t.note.haveBackground&&document.querySelectorAll(".TravelNotes-MapNote,.TravelNotes-SvgIcon").forEach(e=>e.classList.add("TravelNotes-MapNote-Background")),Object.freeze({marker:r,polyline:i,bullet:o})}function ma(e){e.dashArray>=t.route.dashChoices.length&&(e.dashArray=0);let a=t.route.dashChoices[e.dashArray].iDashArray;if(a){let t="",o=0;for(o=0;o<a.length-1;o++)t+=a[o]*e.width+",";return t+=a[o]*e.width,t}return null}const fa=Object.seal(new class{addRoute(e){let t=Le.getRoute(e),a=[],o=t.itinerary.itineraryPoints.iterator;for(;!o.done;)a.push(o.value.latLng);let n=L.polyline(a,{color:t.color,weight:t.width,dashArray:ma(t)});pa(t.objId,n),d.notEdited===t.editionStatus&&(n.bindTooltip(t.computedName,{sticky:!0,direction:"right"}),n.on("mouseover",va),n.on("mousemove",va)),n.bindPopup(e=>{let t=Le.getRoute(e.objId);return ca.getRouteHeaderHTML("TravelNotes-UI-",t)}),L.DomEvent.on(n,"click",e=>e.target.openPopup(e.latlng));let r=t.notes.iterator;for(;!r.done;)ha(r.value.objId);return t}addNote(e){return ha(e)}getDashArray(e){return ma(e)}zoomTo(e,a){if(a){let e=[];a.forEach(t=>e=e.concat(t)),$.map.fitBounds(Pe.getLatLngBounds(e))}else $.map.setView(e,t.itineraryPointZoom)}setLayer(e){let t=null;t="wmts"===e.service.toLowerCase()?L.tileLayer(e.url):L.tileLayer.wms(e.url,e.wmsOptions),ua&&$.map.removeLayer(ua),$.map.addLayer(t),ua=t,$.travel.readOnly||($.map.getZoom()<(e.minZoom||0)&&$.map.setZoom(e.minZoom||0),$.map.setMinZoom(e.minZoom||0),$.map.getZoom()>(e.maxZoom||18)&&$.map.setZoom(e.maxZoom||18),$.map.setMaxZoom(e.maxZoom||18),e.bounds?($.map.getBounds().intersects(e.bounds)&&!$.map.getBounds().contains(e.bounds)||($.map.setMaxBounds(null),$.map.fitBounds(e.bounds),$.map.setZoom(e.minZoom||0)),$.map.setMaxBounds(e.bounds)):$.map.setMaxBounds(null)),$.map.fire("baselayerchange",t)}onGeolocationStatusChanged(e){r.active!==e&&ga&&($.map.removeLayer(ga),ga=null)}onGeolocationPositionChanged(e){let a=t.geoLocation.zoomToPosition;ga&&($.map.removeLayer(ga),a=!1),ga=L.circleMarker(L.latLng(e.coords.latitude,e.coords.longitude),{radius:t.geoLocation.radius,color:t.geoLocation.color}).bindTooltip(y.formatLatLng([e.coords.latitude,e.coords.longitude])).addTo($.map),a&&$.map.setView(L.latLng(e.coords.latitude,e.coords.longitude),t.geoLocation.zoomFactor)}});let ba=null,ya=null,Ta=1;function Na(){ba&&(L.DomEvent.off(ba),$.map.removeLayer(ba),ba=null)}function La(){L.DomEvent.off(ba,"mouseout",Na)}function wa(e){e.latlng.lat=ya[0],e.latlng.lng=ya[1],e.target.objId=$.travel.editedRoute.objId,$t(e).show()}function Ia(e){_t.addWayPointOnRoute(ya,[e.target.getLatLng().lat,e.target.getLatLng().lng]),ba&&(L.DomEvent.off(ba,"dragstart",La),L.DomEvent.off(ba,"dragend",Ia),L.DomEvent.off(ba,"contextmenu",wa),$.map.removeLayer(ba),ba=null)}function xa(e){let t=Le.getNoteAndRoute(e.target.objId),a=t.note,o=t.route,n=$.mapObjects.get(e.target.objId);if(null===o)a.latLng=[e.target.getLatLng().lat,e.target.getLatLng().lng],ve.dispatch("updatetravelnotes");else{let t=Pe.getClosestLatLngDistance(o,[e.target.getLatLng().lat,e.target.getLatLng().lng]);a.latLng=t.latLng,a.distance=t.distance,o.notes.sort((e,t)=>e.distance-t.distance),n.getLayer(n.bulletId).setLatLng(t.latLng),ve.dispatch("updateitinerary")}n.getLayer(n.polylineId).setLatLngs([a.latLng,a.iconLatLng]),ve.dispatch("roadbookupdate")}function Aa(e){let t=Le.getNoteAndRoute(e.target.objId).note,a=$.mapObjects.get(e.target.objId);a.getLayer(a.polylineId).setLatLngs([[e.latlng.lat,e.latlng.lng],t.iconLatLng])}function ja(e){e.originalEvent.target.style.opacity=t.note.grip.moveOpacity}function Pa(e){e.originalEvent.target.style.opacity=t.note.grip.opacity}function Ea(e){ea(e).show()}function Ma(e){let t=Le.getNoteAndRoute(e.target.objId).note;t.iconLatLng=[e.target.getLatLng().lat,e.target.getLatLng().lng];let a=$.mapObjects.get(e.target.objId);a.getLayer(a.polylineId).setLatLngs([t.latLng,t.iconLatLng])}function Da(e){let t=Le.getNoteAndRoute(e.target.objId).note,a=$.mapObjects.get(e.target.objId);a.getLayer(a.polylineId).setLatLngs([t.latLng,[e.latlng.lat,e.latlng.lng]])}function Ra(e){let a=Le.getRoute(e.target.objId);if(d.notEdited!==a.editionStatus)if(ya=[e.latlng.lat,e.latlng.lng],ba)ba.setLatLng(e.latlng);else{let a='<div class="TravelNotes-WayPoint TravelNotes-WayPointTmp"></div><div class="TravelNotes-WayPointText">?</div>';ba=L.marker(e.latlng,{icon:L.divIcon({iconSize:[40,40],iconAnchor:[20,40],html:a,className:"TravelNotes-WayPointStyle"}),draggable:!0}),(-1===t.route.showDragTooltip||Ta<=t.route.showDragTooltip)&&(Ta++,ba.bindTooltip(b.getText("MapEditor - Drag and drop to add a waypoint")),ba.getTooltip().options.offset=[0,0]),ba.addTo($.map),L.DomEvent.on(ba,"mouseout",Na),L.DomEvent.on(ba,"dragstart",La),L.DomEvent.on(ba,"dragend",Ia),L.DomEvent.on(ba,"contextmenu",wa)}}function Oa(e){$t(e).show()}function Ca(e){(function(e){let t=e.target.objId,a=Ge(e,function(){let e=$.travel.editedRoute.wayPoints.first.objId!==t&&$.travel.editedRoute.wayPoints.last.objId!==t;return[{context:_t,name:b.getText("WayPointContextMenu - Delete this waypoint"),action:e?_t.removeWayPoint:null,param:t},{context:_t,name:b.getText("WayPointContextMenu - Modify properties"),action:_t.wayPointProperties,param:t}]}());return Object.seal(a)})(e).show()}function Sa(e){$.travel.editedRoute.wayPoints.getAt(e.target.objId).latLng=[e.target.getLatLng().lat,e.target.getLatLng().lng],_t.wayPointDragEnd(e.target.objId)}function Ua(e,t){t.objId=e,t.addTo($.map),$.mapObjects.set(e,t)}function ka(e){let t=$.mapObjects.get(e);t&&(L.DomEvent.off(t),$.map.removeLayer(t),$.mapObjects.delete(e))}function Ha(e,t){if(s.defaultValue===e.lat&&s.defaultValue===e.lng)return;let a='<div class="TravelNotes-WayPoint TravelNotes-WayPoint'+("A"===t?"Start":"B"===t?"End":"Via")+'"></div><div class="TravelNotes-WayPointText">'+t+"</div>",o=L.marker(e.latLng,{icon:L.divIcon({iconSize:[40,40],iconAnchor:[20,40],html:a,className:"TravelNotes-WayPointStyle"}),draggable:!0});o.bindTooltip(e=>Le.getWayPoint(e.objId).fullName),o.getTooltip().options.offset=[20,-20],L.DomEvent.on(o,"contextmenu",Ca),o.objId=e.objId,Ua(e.objId,o),L.DomEvent.on(o,"dragend",Sa)}const Ba=Object.seal(new class{updateRoute(e,t){-1!==e&&function(e){let t=Le.getRoute(e);ka(t.objId);let a=t.notes.iterator;for(;!a.done;)ka(a.value.objId);let o=t.wayPoints.iterator;for(;!o.done;)ka(o.value.objId)}(e),-1!==t&&function(e){let t=fa.addRoute(e),a=$.mapObjects.get(e);if(!$.travel.readOnly){L.DomEvent.on(a,"contextmenu",Oa),L.DomEvent.on(a,"mouseover",Ra);let e=t.notes.iterator;for(;!e.done;){let t=$.mapObjects.get(e.value.objId),a=t.getLayer(t.markerId),o=t.getLayer(t.bulletId);L.DomEvent.on(o,"dragend",xa),L.DomEvent.on(o,"drag",Aa),L.DomEvent.on(o,"mouseenter",ja),L.DomEvent.on(o,"mouseleave",Pa),L.DomEvent.on(a,"contextmenu",Ea),L.DomEvent.on(a,"dragend",Ma),L.DomEvent.on(a,"drag",Da)}}if(!$.travel.readOnly&&d.notEdited!==t.editionStatus){let e=$.travel.editedRoute.wayPoints.iterator;for(;!e.done;)Ha(e.value,e.first?"A":e.last?"B":e.index)}}(t)}updateRouteProperties(e){let t=$.mapObjects.get(e),a=Le.getRoute(e);t.setStyle({color:a.color,weight:a.width,dashArray:fa.getDashArray(a)})}updateNote(e,t){let a=!1;if(-1!==e){let t=$.mapObjects.get(e);t&&(a=t.getLayer(t.markerId).isPopupOpen()),ka(e)}-1!==t&&function(e,t){let a=fa.addNote(e);t&&a.marker.openPopup(),$.travel.readOnly||(L.DomEvent.on(a.bullet,"dragend",xa),L.DomEvent.on(a.bullet,"drag",Aa),L.DomEvent.on(a.bullet,"mouseenter",ja),L.DomEvent.on(a.bullet,"mouseleave",Pa),L.DomEvent.on(a.marker,"contextmenu",Ea),L.DomEvent.on(a.marker,"dragend",Ma),L.DomEvent.on(a.marker,"drag",Da))}(t,a)}removeObject(e){ka(e)}removeAllObjects(){$.mapObjects.forEach(e=>{L.DomEvent.off(e),$.map.removeLayer(e)}),$.mapObjects.clear()}addWayPoint(e,t){Ha(e,t)}addItineraryPointMarker(e,a){Ua(e,L.circleMarker(a,t.itineraryPointMarker))}addSearchPointMarker(e,a,o){let n=!1;if(o){let e=[];o.forEach(t=>{e=e.concat(t)});let t=Pe.getLatLngBounds(e),a=$.map.getBounds();n=(t.getEast()-t.getWest())/(a.getEast()-a.getWest())>.01&&(t.getNorth()-t.getSouth())/(a.getNorth()-a.getSouth())>.01}Ua(e,n?L.polyline(o,t.searchPointPolyline):L.circleMarker(a,t.searchPointMarker))}addRectangle(e,t,a){Ua(e,L.rectangle(t,a))}setLayer(e){let t=e.url;if(e.providerKeyNeeded){let a=Ne.getKey(e.providerName.toLowerCase());if(!a)return;t=t.replace("{providerKey}",a)}e.url=t,fa.setLayer(e)}});var Fa={};function Va(e){return Math.floor(Math.abs(e)+.5)*(e>=0?1:-1)}function Wa(e,t,a){var o=(e=Va(e*a))-(t=Va(t*a));o<<=1,e-t<0&&(o=~o);for(var n="";o>=32;)n+=String.fromCharCode(63+(32|31&o)),o>>=5;return n+=String.fromCharCode(o+63)}function za(e){for(var t=[],a=0;a<e.length;a++){var o=e[a].slice();t.push([o[1],o[0]])}return t}function Ka(){function e(e){let t={};0!==e.itinerary.itineraryPoints.length&&(t=e.itinerary.itineraryPoints[0].objType);let a={latLngs:[],distances:[],elevs:[],objIds:[],objType:t};e.itinerary.itineraryPoints.forEach(e=>{a.latLngs.push([e.lat,e.lng]),a.distances.push(e.distance),a.elevs.push(e.elev),a.objIds.push(e.objId)}),a.latLngs=Fa.encode(a.latLngs,6),e.itinerary.itineraryPoints=a}function t(e){e.itinerary.itineraryPoints.latLngs=Fa.decode(e.itinerary.itineraryPoints.latLngs,6);let t=[],a=0;e.itinerary.itineraryPoints.latLngs.forEach(o=>{let n={};n.lat=o[0],n.lng=o[1],n.distance=e.itinerary.itineraryPoints.distances[a],e.itinerary.itineraryPoints.elevs?n.elev=e.itinerary.itineraryPoints.elevs[a]:n.elev=l.defaultValue,n.objId=e.itinerary.itineraryPoints.objIds[a],n.objType=e.itinerary.itineraryPoints.objType,t.push(n),a++}),e.itinerary.itineraryPoints=t}function a(e){e.routes.forEach(t),e.editedRoute&&t(e.editedRoute)}return Object.seal(new class{decompress(e){a(e),$.travel.jsonObject=e,$.editedRouteObjId=-1,$.travel.routes.forEach(e=>{d.notEdited!==e.editionStatus&&($.editedRouteObjId=e.objId)})}decompressMerge(e){a(e);let t=J();t.jsonObject=e;let o=t.routes.iterator;for(;!o.done;)$.travel.routes.add(o.value);let n=t.notes.iterator;for(;!n.done;)$.travel.notes.add(n.value)}compress(){let t=$.travel.jsonObject;return t.routes.forEach(e),e(t.editedRoute),t}})}Fa.decode=function(e,t){for(var a,o=0,n=0,r=0,i=[],l=0,s=0,d=null,c=Math.pow(10,Number.isInteger(t)?t:5);o<e.length;){d=null,l=0,s=0;do{s|=(31&(d=e.charCodeAt(o++)-63))<<l,l+=5}while(d>=32);a=1&s?~(s>>1):s>>1,l=s=0;do{s|=(31&(d=e.charCodeAt(o++)-63))<<l,l+=5}while(d>=32);n+=a,r+=1&s?~(s>>1):s>>1,i.push([n/c,r/c])}return i},Fa.encode=function(e,t){if(!e.length)return"";for(var a=Math.pow(10,Number.isInteger(t)?t:5),o=Wa(e[0][0],0,a)+Wa(e[0][1],0,a),n=1;n<e.length;n++){var r=e[n],i=e[n-1];o+=Wa(r[0],i[0],a),o+=Wa(r[1],i[1],a)}return o},Fa.fromGeoJSON=function(e,t){if(e&&"Feature"===e.type&&(e=e.geometry),!e||"LineString"!==e.type)throw new Error("Input must be a GeoJSON LineString");return Fa.encode(za(e.coordinates),t)},Fa.toGeoJSON=function(e,t){return{type:"LineString",coordinates:za(Fa.decode(e,t))}},"object"==typeof module&&module.exports&&(module.exports=Fa);const Xa=Object.seal(new class{routeDropped(e,t,a){$.travel.routes.moveTo(e,t,a),qt.chainRoutes(),ve.dispatch("setrouteslist"),ve.dispatch("roadbookupdate")}saveTravel(){let e=$.travel.routes.iterator;for(;!e.done;)e.value.hidden=!1;let t=Ka().compress($.travel);y.saveFile(t.name+".trv",JSON.stringify(t))}clear(){window.confirm(b.getText("TravelEditor - This page ask to close; data are perhaps not saved."))&&(wt.deleteAllProfiles(),ve.dispatch("removeallobjects"),$.travel.editedRoute=K(),$.editedRouteObjId=-1,$.travel=J(),$.travel.routes.add(K()),ve.dispatch("setrouteslist"),ve.dispatch("showitinerary"),ve.dispatch("roadbookupdate"),ve.dispatch("travelnameupdated"),t.travelEditor.startupRouteEdition&&qt.editRoute($.travel.routes.first.objId))}});function Za(){return Object.seal(new class{openDistantFile(e){Ka().decompress(e),$.travel.readOnly=!0,this.display()}display(){let e=$.travel.routes.iterator;for(;!e.done;)d.notEdited===e.value.editionStatus&&ve.dispatch("routeupdated",{removedRouteObjId:-1,addedRouteObjId:e.value.objId});-1!==$.editedRouteObjId&&ve.dispatch("routeupdated",{removedRouteObjId:-1,addedRouteObjId:$.travel.editedRoute.objId});let t=$.travel.notes.iterator;for(;!t.done;)ve.dispatch("noteupdated",{removedNoteObjId:-1,addedNoteObjId:t.value.objId});Ee().zoomToTravel()}})}function Ga(){function e(e,t){let a=new FileReader;a.onload=function(){let e={};try{e=JSON.parse(a.result)}catch(e){console.log(e||"An error occurs when reading the file")}t?Ka().decompressMerge(e):(wt.deleteAllProfiles(),Ka().decompress(e)),function(){if(ve.dispatch("removeallobjects"),Za().display(),Wt.setLayer($.travel.layerName),ve.dispatch("setrouteslist"),-1!==$.editedRouteObjId){let e=$.travel.editedRoute.itinerary.provider;if(e&&""!==e&&!$.providers.get(e.toLowerCase()))ue.showError(b.getText("FileLoader - Not possible to select as provider",{provider:e}));else{let t=$.travel.editedRoute.itinerary.transitMode;ve.dispatch("setprovider",{provider:e}),t&&""!==t&&ve.dispatch("settransitmode",{transitMode:t})}}qt.chainRoutes(),ve.dispatch("travelnameupdated"),ve.dispatch("showitinerary"),ve.dispatch("roadbookupdate")}()},a.readAsText(e.target.files[0])}return Object.seal(new class{openLocalFile(t){e(t,!1)}mergeLocalFile(t){e(t,!0)}})}let Ja=null,Ya=null,qa=null,Qa=0,_a=null,$a=null,eo=null,to=null;function ao(e){e.deltaY&&(e.target.scrollTop+=e.deltaY*g[e.deltaMode]),e.stopPropagation()}function oo(e){$.travel.name=e.target.value,ve.dispatch("roadbookupdate")}function no(e){e.stopPropagation(),Xa.clear()}function ro(e){e.stopPropagation(),Xa.saveTravel()}function io(e){e.stopPropagation(),Ga().openLocalFile(e)}function lo(){window.confirm(b.getText("TravelEditor - This page ask to close; data are perhaps not saved."))&&$a.click()}function so(e){e.stopPropagation(),Ga().mergeLocalFile(e)}function co(){-1===$.editedRouteObjId?eo.click():ue.showError(b.getText("TravelUI - Not possible to merge a travel when a route is edited"))}function uo(){_a=a.create("div",{className:"TravelNotes-UI-FlexRowDiv"},qa),a.create("div",{className:"TravelNotes-UI-Button",title:b.getText("TravelUI - Cancel travel"),innerHTML:"&#x274c;"},_a).addEventListener("click",no,!1),a.create("div",{className:"TravelNotes-UI-Button",title:b.getText("TravelUI - Save travel"),innerHTML:"&#x1f4be;"},_a).addEventListener("click",ro,!1),$a=a.create("input",{className:"TravelNotes-TravelUI-OpenFileInput",type:"file",accept:".trv"},_a),$a.addEventListener("change",io,!1),a.create("div",{className:"TravelNotes-UI-Button",title:b.getText("TravelUI - Open travel"),innerHTML:"&#x1F4C2;"},_a).addEventListener("click",lo,!1),eo=a.create("input",{className:"TravelNotes-TravelUI-OpenFileInput",type:"file",accept:".trv,.map"},_a),eo.addEventListener("change",so,!1),a.create("div",{className:"TravelNotes-UI-Button",title:b.getText("TravelUI - Import travel"),innerHTML:"&#x1F30F;"},_a).addEventListener("click",co,!1),a.create("div",{className:"TravelNotes-UI-Button",title:b.getText("TravelUI - Open travel roadbook"),innerHTML:'<a class="TravelNotes-UI-LinkButton" href="TravelNotesRoadbook.html?lng='+t.language+"&page="+$.UUID+'" target="_blank">&#x1F4CB;</a>'},_a)}function go(e){e.stopPropagation(),Ja.classList.toggle("TravelNotes-TravelUI-HiddenRouteList");let t=Ja.classList.contains("TravelNotes-TravelUI-HiddenRouteList");e.target.innerHTML=t?"&#x25b6;":"&#x25bc;",e.target.title=t?b.getText("TravelUI - Show"):b.getText("TravelUI - Hide")}function vo(e){e.stopPropagation(),qt.addRoute()}function po(){to=a.create("div",{className:"TravelNotes-UI-FlexRowDiv"},qa),a.create("div",{innerHTML:"&#x25bc;",className:"TravelNotes-TravelUI-RouteList-ExpandButton"},to).addEventListener("click",go,!1),a.create("span",{innerHTML:b.getText("TravelUI - Travel routes")},to),a.create("div",{className:"TravelNotes-UI-Button TravelNotes-UI-FlexRow-RightButton",title:b.getText("TravelUI - Add a route"),innerHTML:"+"},to).addEventListener("click",vo,!1)}function ho(e){e.stopPropagation();try{e.dataTransfer.setData("Text",e.target.objId),e.dataTransfer.dropEffect="move",e.dataTransfer.routeObjId=e.target.objId}catch(e){console.log(e)}Qa=e.target.objId}function mo(e){e.preventDefault()}function fo(e){e.preventDefault();let t=e.target;for(;!t.objId;)t=t.parentElement;let a=t.getBoundingClientRect();Xa.routeDropped(Qa,t.objId,e.clientY-a.top<a.bottom-e.clientY)}function bo(e){e.stopPropagation(),e.preventDefault(),e.latlng={lat:s.defaultValue,lng:s.defaultValue},e.fromUI=!0,e.originalEvent={clientX:e.clientX,clientY:e.clientY},$t(e,qa).show()}const yo=Object.freeze(new class{createUI(e){qa||(qa=e,function(){let e=a.create("div",{className:"TravelNotes-UI-FlexRowDiv"},qa);a.create("span",{innerHTML:b.getText("TravelUI - Travel")},e),Ya=a.create("input",{id:"TravelNotes-TravelUI-InputTravelName",type:"text",placeholder:"TravelNotes",value:$.travel.name},e),Ya.addEventListener("change",oo,!1)}(),uo(),po(),Ja=a.create("div",{className:"TravelNotes-TravelUI-RoutesListDiv"},qa),Ja.addEventListener("drop",fo,!1),Ja.addEventListener("dragover",mo,!1),Ja.addEventListener("wheel",ao,!1))}setRoutesList(){for(;Ja.firstChild;)Ja.firstChild.removeEventListener("dragstart",ho,!1),Ja.firstChild.removeEventListener("contextmenu",bo,!1),Ja.removeChild(Ja.firstChild);let e=$.travel.routes.iterator;for(;!e.done;){let t=e.value.objId===$.editedRouteObjId?$.travel.editedRoute:e.value,o=(e.value.objId===$.editedRouteObjId?"&#x1f534;&nbsp;":"")+(t.chain?"&#x26d3;&nbsp;":"")+t.computedName,n=a.create("div",{draggable:!0,className:"TravelNotes-TravelUI-RoutesList-Item TravelNotes-UI-MoveCursor"+(e.value.hidden?" TravelNotes-TravelUI-RoutesList-HiddenItem":""),objId:e.value.objId===$.editedRouteObjId?$.travel.editedRoute.objId:e.value.objId,canDrag:!0,innerHTML:o},Ja);n.addEventListener("dragstart",ho,!1),n.addEventListener("contextmenu",bo,!1)}}setTravelName(){Ya.value=$.travel.name}});let To=i.invalidPane,No=new Map,Lo=null,wo=null;function Io(e){i.invalidPane!==To&&(No.get(To).remove(),Lo.innerHTML=""),To=e,No.get(To).add(),document.querySelectorAll(".TravelNotes-DataPaneUI-PaneButton").forEach(e=>{e.paneId===To?e.classList.add("TravelNotes-DataPaneUI-ActivePaneButton"):e.classList.remove("TravelNotes-DataPaneUI-ActivePaneButton")})}function xo(e){Io(e.target.paneId)}function Ao(e){e.deltaY&&(e.target.scrollTop+=e.deltaY*g[e.deltaMode]),e.stopPropagation()}const jo=Object.freeze(new class{createUI(e){if(Lo)return;let t=a.create("div",{className:"TravelNotes-UI-FlexRowDiv"},e);wo=a.create("div",{id:"TravelNotes-PanesManagerUI-PaneControlsDiv"},e),Lo=a.create("div",{id:"TravelNotes-PanesManagerUI-PaneDataDiv"},e),Lo.addEventListener("wheel",Ao,!1),No.forEach(e=>{a.create("div",{innerHTML:e.getButtonText(),className:"TravelNotes-DataPaneUI-PaneButton",paneId:e.getId()},t).addEventListener("click",xo,!1),e.setPaneDivs(Lo,wo)})}addPane(e){No.set(e.getId(),e)}showPane(e){Io(e)}updatePane(e){e===To&&Io(e)}});let Po=null,Eo=!1;const Mo=["bike","pedestrian","car","train","line","circle"];let Do={bike:null,pedestrian:null,car:null,train:null,line:null,circle:null},Ro=null;const Oo={bike:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAIAAAC0Ujn1AAAABmJLR0QAAAAzAJlWvctWAAAACXBIWX\t\tMAAA7EAAAOxAGVKw4bAAAAB3RJTUUH5AEIChYTLGSDtAAAA65JREFUSMftVl1sk1UYfs53vnZft4/R/W+hHaUrbshcQch06VCGWd\t\tBohmNRCRiXKXphZCOacCEYBeOFXHhDlHDjQDEBdKIx9sL4Q8bqtEPqLAOE/YDrGPspa2m7bt/Xr8eLr3WddFuJ88b4Xp285z1P3v\t\tOe533eQ9xud3FxMcdxmMMURWGMUUoJIUjNFEUZHBwkPp8vovBnHVfB7gghACNIsgEQQgjAwBjiAfFIQqqrLBpNhKeU/to9Vr/fic\t\tWzbw6iqrKEQ/Ks/pkxAODwr9n/0HcHLWq5uoqlXMqMTjR+nj2bKWPlcrH9t4komyHRmgLt3pcq0gQNGOr2dSJZMyycteNaSJKjlk\t\tIh0dk9KjnO3QhORtrsV+YmXjzreW576qfxlrrlJUXCrUkWlBgDlmgJI+Tn7pvHfvTOeYzEodncTfP8xoIu93h7XzDR+Vx1vj8kVx\t\toEp2fqrlvGWihsseoFnggCv2JZRql+1pNMK+xL10T5yiyeI6/UFuzbalydq12YIbWW9CMt1u2bDeVm8VCzdZUl+1j7yEPr8wmBlh\t\tJTJg+AEgBI1+L4Gw9OSez8ldsv1JvfbbonKUNi1U6jZNuW0p3vuVRG1K8P6wUc2G4++OlAU03Rh98PV63OKvNNXR8K2oxCqTn747\t\taLgVCkfSBkv+Bvqs5985kV+08OzGTNEoi192lTm71XdTSs1RMl2trhzczUBWXm6vG2PGHcue2+xzeZHNfDWx81vX308tcX/BbTEp\t\tX0rR3jOdnpswqSKPAZomC/FABQadA1PlX+uWsCAM8xAK4Rqb7WvMlmebZhzQ5bXl6u+MC9WS9uzM/R6z7ac796fHJa+XtB/sKOSJ\t\tEqg9DpmXJ6wnWvd8RGRjS273TdqFxnvnh5+BPH2Nqy7N/7/F/5ZABArAiiQNUFpRwATlEUhmnVdeiz/saGWa/xWJkoyxF1vefo1Y\t\twNrR8c7wbQ+kX/q42rEiN3bS76Y+i2uo5GGQCeUhplkuryhJROp+fIbmuXa9h9LfTkw0WimNZ8uGeGrwxDo2EAPV75bOfg4eaK8b\t\tFAKCQtM+i9t8JvneiPQ0cBkEAgcO6XkZrXvksYe3j5kYK8HN2ZrtEz/ZPza1CNRczP0p4+PyEpM3Swv7Nug62UBwBCZ7USw/vfjq\t\tQobz/0BpNoHs8voHzzik9SsUtZVFNH+Y8NMMqRxQWllAdA/H6/RqPr7bvJGBYcgSz28wIhJK49SR7WUlIoy2HidruNRiOldBGzVr\t\t+TfwLXzWMKJ+iQhAAAAABJRU5ErkJggg==",pedestrian:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAIAAAC0Ujn1AAAABmJLR0QAAAAzAJlWvctWAAAACXBIWX\t\tMAAA7EAAAOxAGVKw4bAAAAB3RJTUUH5AEICholT2tZIQAAAyxJREFUSMetll1IFFEUx/93PtZ13cykJNvWNDXEMkgoyYKICCJISK\t\tkIIYjqpU98kB77loogjCzKCvoQkqigh8ioKKS01NS2grDwY7ddLa3dNVt37r1ze5haLXVzV8/TmTN3fufMYeacP3E4HCkpKZIkYX\t\twmhCCEhD/DOXc6ncTr9TKu1D5vgxj7LCEQYvglAYQQnOuSTAiMTAQGgpDlSzNUlSmyLLe0fl1/6BUmzx6exNIl6RLwV7kygUomzB\t\tYA8G+LuQD9kyoxRrqxf9HFvQtIVMmUMPeqDuevWZUNgDJ917n3kaLDfRhZmUmGE2dRo6g6HLr6bmtQY+5u78kr7ycZ3fCmlzGdUj\t\t01yTyZ6MOb0q6dLYyzmObYE29VFp3Ykjk56HXZU0p2rrDE/m6xJda0c1v+yjTLeIgyCYveujHb0+MfCLBQxOsPHi1dNh40F2HRVm\t\tvMz4AW1IbQZyrrF8637S+wT7QhVovKGedMD0U8Xwau3mzYsyM/XpUmhDaZVKHrus5DEVUmu8+/8/T4LpbmGpFjxelvb6zLSjRFhl\t\tZUhTGu86GqzSYJwL6Dz3Lm21ZnWgEkxMfYbdP8QT0ydMWluoorjRrlnAtKdQCKTAC8cAXKymsvn1p752Desry0/h+D+ZnWyNCVtX\t\t3XG7yDQdbU3F52+nEIDaDq1bfj5c/efei1z060JSdUnS86snluxH+jRjkIqMYAmIZNkXNPejpc/dOmxgLo6PpeVLDQqkiRoRnjBM\t\tTbTwEoyl+Dtbgw25i0U+PNJQce5SSbx0SPOpB1ziVJcvdp/xyYZVEW56YaftJ0K+Woc/4cEz3qXqSUg8DVpwEAGXq/HJv53v0Wd7\t\tfvZVNXp/PbjAQ14l4HBhkAt4/+2bS/rabtR/GJlt6+gYZmV3tnb3XT92jQhBBPvyYEMGKJCcBsVijTo1lg92rarHGqLkRQ46NpD/\t\tHZ4/d0+6NBX3jaYzhOt3f4FDSs8XXXg+fuetdgNOiQzdtwe2Rwe7nj/+NJlqJXHqM+KcsKAOLz+VQ19uOnbiEwht4gMGSZGJJp4S\t\t0jfSalAeJwOOx2uyzLYfTjCAU4Ljn5C1w5SWBHSm1MAAAAAElFTkSuQmCC",car:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAIAAAC0Ujn1AAAABmJLR0QAAAAzAJlWvctWAAAACXBIWX\t\tMAAA7EAAAOxAGVKw4bAAAAB3RJTUUH5AEICh4hLGpYPAAAAlZJREFUSMfdlk1oE0EUx/+zszEx3UhD0zZYkn5ksfWjlVgrVk1RQV\t\tR6EMFaK9qjggdBRO1NvSiIB8/iyQ/akxepSKteRPxoETXamkQtJAbbBN0ky0boZne8FIu23exqKuhjDgMz78ef/3u8GRIOh/1+P8\t\tdxKF1ompZIJEgmkylo/KPHMTBL6QQzCXM2hGxpF222Ak8pffkqvff88xKqHrqE9g0BDrAo10wwAOCwaPFvovmFDo6Gak4f3+x0gj\t\tHoOjQNTIfOoOvQ9dn93aF3p268tobu3R9sqC+XJACgdGbxPCgFIbPXHPYWa+gKWtbS7M3nIe669VVTfjm1aRUC53AtwYObHXW1rr\t\tZK90haMuv1mZ4VgsBFYlNzuQBU+kUiybiajMYmeR69e0QLZdwW8gMYGU0ZF+rp6GcArcHlZg3Z5K1avaqKMUwkpGNbawzQ2VxB09\t\tDU6Gl0lUVkpQj6xA7xwtntdjsjBBfPdZhpMnc5fXL7wO5DA8+mFCND1gddDgcA8nFCVtUi0OlpRKKyrsPtphuby015PTYuB7r67w\t\t3HjdH3H8abDva/eStZKGOt33n9ZNu6tZXG6NagZ6AvVF+3zEJfCwI93BMs6nJ1tbN730rTM+R3JyxjxVQfuRztu5IaG+4UBORyWL\t\tNz0AD34k6nx4NCAYHQ4Cc1XQStMEVRlR8SEmrSjOT4fNf++lBNpfR8npNlzThZlmG3Y6H2nx8tdl8zo6uh6+p/94AtMppypLRQSn\t\tkAJJvN2mxL33+YZOynR+9PQgx4VfUbCYfDPp+PUlry7+R3HyvZuSYHFFYAAAAASUVORK5CYII=",train:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAIAAAC0Ujn1AAAABmJLR0QAAAAzAJlWvctWAAAACXBIWX\t\tMAAA7EAAAOxAGVKw4bAAAAB3RJTUUH5AEICiI23EqkBAAABQpJREFUSMetVm1QVFUYfs+55+4u+zEsshK0iuy6iuAHbaSwJhkZNp\t\tWjaWn2oQ2Zk1lmpjMllmNqDYZjM+Y0TdkIg8WYHwU6KjqUIzl8KGhihcgCu8Auu3uBXXfZT+89/cBAYFex8f1173nOfea973ne5z\t\t2oqrouNUWHMYb7CUqBAkWAEAqD8jxvMplRd08vpWzlhRtA74scwe0PRjwgNMegIyRERCypq3cs/qwWHlyc+RIyZ2oxAASCXniwQQ\t\tEAMAB4ff6wG6Yr4YMcVaoi+D/IEUIEAFhCwsL5G6elTEnc8A6RSgnP05vuQOP1juXbrnjpqM4cA4BIxIbFnv/0mnbpyQlLyo6VXU\t\tEIHfn1kiYpLjlmtIkTACAMGwleZZAumK8bo5SFQoGxseyhXxqezkyYYnFVXPPYb5F7UyMU/gfzX43f+P5z5L9yvZWrHoACgUDlhb\t\t9e23LRHkJ3o4Zw6LIZUevW5HCcc++354/+Zp6YIDPoVZN1YxPiY5TRoujo6NSUpIL3uNw9RgExkalHhAwLX3ySTQizeUd5YU0fgL\t\tTJSE8ZHQCOYTvTov1/3pRFpKZ0eCMeLzBoNeofiioKa/p2r4yfnjpeLGb9gWCfx2/nvOZOd7vFIxETsZg0Gb2Tgu4bfkWErKlwxz\t\tt/umD2E3OmHSg+t3Zfc+m2tIULDHc/LquVe2TJ0ZFFx/367n/JfAguFz2TMVOXv+dETb2t6cjCe/ICQEKC6utNqeF1jQADwJsGeW\t\tnh0lDo1surD6VNjdtX8GJS0sOjlPCz8/UaqRAx68na2IMl52+6AysWa2ama1mWHX1bKxTyzbmTwioEAYBCRlSxyrlZ08tOVAGAz+\t\tezO1wWa4+5vcfY2t3U6q66xjl9vEpGdGq5LmmMNIpixDMYE4IZBndYXBHF12J2tpgFrudsZY3l8311tZxoRHJSALB74O/rPFwfrk\t\tI5+BlgeRjUOBlQXnl1t8kVctNeAAAQ3a/VeUCiZjydvHyQemAEbV2rX7QgzcE5u2xOk7nncoOl+LTN5B/SafvXaV56YZYgCEU/VW\t\t840N6/uH6efOVyvcXqXLOjFvjhBaEA8H1Jg9frmZ2p06fp0vV4ySLY+lGoo8PeZHRUXzR9d9xiCTJFx0xPZiXHKOUK2aDt3DD7lU\t\tolBUSGDkrkdrsv1TuyPzw7sDRvAlm1LPFR/WTdRDXDMAN+1GnhzO2cg+tze0L9Zi+RiAiDCRNSKhVJibElR+q2HOoCgDO7MgwZE8\t\tN4SIXplre4dT3GbSabIPCPpSePVcWIxWKtRq3VqCPVus1k3f6z5baaB3U9wvqquujyXc2m9t6sOTNaWjr3Hyj/p7E1GIw4ybju3m\t\t27KgJDp8/d7Pztb9r+qLXtyMuZmqotOXzhqdxTr2SrtBOUcSoFYXiEkVgkkkhoe4fr3b3GPgGPylQHoviS7+Sy0oPb01e9Me/xTN\t\t3HO899dcbZD2XEwabVU+dm6bPnRs3OnFJxrjG/sPlORTF5eXkWq7eo3BiJ3SegHyusgt0cJcGJCezvF7kgMADQ2QeHKx2nTzTIWb\t\tfb7ZPLRbNSotoabbYAWZEzbvy4MQQAGIzu2RE7Szko5QAAYIi31HP09d1NdyxIAIBhCAAgl8vFslHNxi5KASGgdPhkGHmto/T2Fk\t\toppVSgFCggBBhjQMBgPEkXHwr50NWrDYmJ4zFmYMilDwECBEBppBsM9KcSNniebzOZ/gWOPRAUHy2iQwAAAABJRU5ErkJggg==",line:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAIAAAC0Ujn1AAAABmJLR0QAAAAzAJlWvctWAAAACXBIWX\t\tMAAA7EAAAOxAGVKw4bAAAAB3RJTUUH5AEICiINbUFNIAAAAfZJREFUSMdjvHz5spycHBMTEwP1wN+/fx8/fsz44cOHP39ZDh+9zf\t\tCfJO2MDFANGAxGRhtLFVbWPyzMzMwXLr4ObDxFRVfv6mKwNFNmYmAg0bnEgP8MDAwMZAZxoqXgomJd/GrIMdpCkq270SMi1Iz6Rs\t\t9sdxIW4l2x+hSVjV5UrKunI3fpyqO43svUNDrfVSwi1Oztu8/plfsIKmYiKYhrS50ZGBiau/eeeP6LmkbDg3ji7lfEqGeiehCTZj\t\tRJQYzTaMb/bBQGMU6j/zOia57f60ZSEBMbIBsbTTXUpI6dvE18EMMBCx65mgBpT3e9Fy8/FLccxZUcE4OUv//4XTD3DglGW0iyle\t\tY7MTAwVLXsRgtiiIl21srKSuKsLMyPn7wlzej5vW58vJyz5h+ef/w9VhN///l7997LQ0fvzl93l4QAgQdx+tTrAVrcUQFqxoZysr\t\tIiaCbiTzAsuIL40+fvb958ubvaX0lRnIGB4fv3X9dvPD1x+iFBE3EaDQliVhZmVl5OP2/D799/nTl3/+jJ+1hDkzSjixK1+Xg5v3\t\t//dfX6U/JMxGl03/yrl669atnwlPIKEt3oE89/naCGueRXu4PAaGYmRuoayszMwsDAwPjx40dWVs47d1/8/8/ASCUrVJQlfv/+zn\t\tj58mVZWVlmZmaqNycB+D3rTYmxQpEAAAAASUVORK5CYII=",circle:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAIAAAC0Ujn1AAAABmJLR0QAAAAzAJlWvctWAAAACXBIWX\t\tMAAA7EAAAOxAGVKw4bAAAAB3RJTUUH5AEICiEaxb+bJAAAAqNJREFUSMdjvHz5spycHBMTEwP1wN+/fx8/fsz44cOHP39ZDh+9zf\t\tCfJO2MDFANGAxGRhtLFVbWPyzMzMwXLr4ObDxFRVfv6mKwNFNmYmAg0bnEgP8MDAwMTAw0Ayz4pS0k2RKDlO2slUVFeIWFeBkYGN\t\t6++/z6zedDR+/OX3f3xPNfZBo9M1szIsTk48dvBw7fOnvp5cTdrxgYGPJdxYz1xD1dtWIjzBevOJk+9TrJRu/vszUyVJg6+1DVso\t\tfI4hN3v2LY/Yqh93JNgHRpvpOOloR19n6sJjDhMldZSSw+ex2aucigZcNT96iVstJCR6c6Emv0zGxNI0OFvKodG659xR8TJ57/Cs\t\tvcrKMlMzNbk7DRFpJssRHm3RP3ETQXbnr3xH2xEeYWkmwEjE4MUn7z9nPLhqfEJ7KWDU/fvP2cFaVOwGg7a+UDh2+RmoS3775mai\t\txPwGhREd6zl16SavSJcy+kJAUJGC0sxAtJvySB+cff8/FyEpX4qALQjf70+Xu+qxippiRaCn76/J2A0c+evzfWEyfVaAsjiWfP3x\t\tMw+vTZhw62aqQabWetfPrsQwJGT1t2U0SYty1KnnhzawKk5WVFpi27ScDoE89/LV5xMjvVDjN34Sp1S/OdFq84iVnAYkkh6VOvX7\t\tn2ZNV0X4KmW0iyrZrue+XaE6xFK/bEZ529//HTdzuXhdcESOMJh53Lwh8/fYerUMVZXltn75+ZrVlV7JoY/X7PgVsnzr2Yf/w9JJ\t\t1ZGEm4OKhJSgiSWRVAQmb+urtZUep21soRISbzeDkhCf/Z8/dHT9ybtuwm+RUYJFZP9F5mYLhMhdxI5YzOzMRIXUOZmVkYGBgYP3\t\t78yMrKeefui///GRipZIWKssTv398ZL1++LCsry8zMTPXmJADJwQv2CCSQygAAAABJRU5ErkJggg=="};function Co(e){$.routing.transitMode=e;let t=document.querySelector(".TravelNotes-ProvidersToolbarUI-ActiveTransitModeImgButton");t&&t.classList.remove("TravelNotes-ProvidersToolbarUI-ActiveTransitModeImgButton"),document.getElementById("TravelNotes-ProvidersToolbarUI-"+e+"ImgButton").classList.add("TravelNotes-ProvidersToolbarUI-ActiveTransitModeImgButton")}function So(e){e.stopPropagation(),Co(e.target.transitMode),qt.startRouting()}function Uo(e){$.routing.provider=e;let t=document.querySelector(".TravelNotes-ProvidersToolbarUI-ActiveProviderImgButton");t&&t.classList.remove("TravelNotes-ProvidersToolbarUI-ActiveProviderImgButton"),document.getElementById("TravelNotes-ProvidersToolbarUI-"+e+"ImgButton").classList.add("TravelNotes-ProvidersToolbarUI-ActiveProviderImgButton");let a=$.providers.get(e.toLowerCase());if(Mo.forEach(e=>{a.transitModes[e]?Do[e].classList.remove("TravelNotes-ProvidersToolbarUI-InactiveImgButton"):Do[e].classList.add("TravelNotes-ProvidersToolbarUI-InactiveImgButton")}),!a.transitModes[$.routing.transitMode]){let e=null;Mo.forEach(t=>{a.transitModes[t]&&(e=e||t)}),Co(e)}}function ko(e){e.stopPropagation(),Uo(e.target.provider),qt.startRouting()}function Ho(e){if(0===e.providerKey)return;let t=a.create("img",{src:e.icon,id:"TravelNotes-ProvidersToolbarUI-"+e.name+"ImgButton",className:"TravelNotes-ProvidersToolbarUI-ImgButton",title:e.name,provider:e.name},Po);if(t.addEventListener("click",ko,!1),!Eo){t.classList.add("TravelNotes-ProvidersToolbarUI-ActiveProviderImgButton"),$.routing.provider=t.provider,Eo=!0;let a=null;Mo.forEach(t=>{e.transitModes[t]&&(a=a||t)}),Do[a].classList.add("TravelNotes-ProvidersToolbarUI-ActiveTransitModeImgButton"),$.routing.transitMode=a,Mo.forEach(t=>{e.transitModes[t]||Do[t].classList.add("TravelNotes-ProvidersToolbarUI-InactiveImgButton")})}}const Bo=Object.freeze(new class{createUI(e){Ro=e,Po=a.create("div",{className:"TravelNotes-UI-FlexRowDiv TravelNotes-ProvidersToolbarUI-ImgButtonsDiv"},e),Mo.forEach(e=>{Do[e]=a.create("img",{src:Oo[e],id:"TravelNotes-ProvidersToolbarUI-"+e+"ImgButton",className:"TravelNotes-ProvidersToolbarUI-ImgButton",title:b.getText("ProvidersToolbarUI - "+e),transitMode:e},Po),Do[e].addEventListener("click",So,!1)}),$.providers&&(Eo=!1,$.providers.forEach(Ho))}set provider(e){Uo(e)}set transitMode(e){Co(e)}providersAdded(){Ro.removeChild(Po),this.createUI(Ro)}});let Fo="geolocation"in navigator?r.inactive:r.disabled,Vo=null;function Wo(e){ve.dispatch("geolocationpositionchanged",{position:e})}function zo(){r.active===Fo&&(Fo=r.inactive),ve.dispatch("geolocationstatuschanged",{status:Fo}),navigator.geolocation.clearWatch(Vo),Vo=null}function Ko(e){1===e.code&&(Fo=r.refusedByUser),zo()}const Xo=Object.seal(new class{get status(){return Fo}switch(){switch(Fo){case r.inactive:Fo=r.active,ve.dispatch("geolocationstatuschanged",{status:Fo}),navigator.geolocation.getCurrentPosition(Wo,Ko,t.geoLocation.options),Vo=navigator.geolocation.watchPosition(Wo,Ko,t.geoLocation.options);break;case r.active:zo()}return Fo}});let Zo=null,Go=null,Jo=null,Yo=null,qo=!1;function Qo(){Go&&(clearTimeout(Go),Go=null),Yo.classList.remove("TravelNotes-UI-MainDiv-Minimize"),Yo.classList.add("TravelNotes-UI-MainDiv-Maximize")}function _o(){Yo.classList.remove("TravelNotes-UI-MainDiv-Maximize"),Yo.classList.add("TravelNotes-UI-MainDiv-Minimize")}function $o(){Go=setTimeout(_o,t.travelEditor.timeout)}function en(e){e.stopPropagation(),Ne.setKeysFromDialog()}function tn(e){e.stopPropagation(),Xo.switch()}function an(e){qo?(e.target.innerHTML="&#x1f4cc;",Yo.addEventListener("mouseenter",Qo,!1),Yo.addEventListener("mouseleave",$o,!1)):(e.target.innerHTML="&#x274c;",Yo.removeEventListener("mouseenter",Qo,!1),Yo.removeEventListener("mouseleave",$o,!1)),qo=!qo}const on=Object.freeze(new class{createUI(e){Yo=e,Jo=a.create("div",{className:"TravelNotes-UI-FlexRowDiv"},e),a.create("div",{className:"TravelNotes-UI-Button",title:"Home",innerHTML:'<a class="TravelNotes-UI-LinkButton" href="'+window.location.origin+'" target="_blank">&#x1f3e0;</a>'},Jo),a.create("div",{className:"TravelNotes-UI-Button",title:"Help",innerHTML:'<a class="TravelNotes-UI-LinkButton" href="https://github.com/wwwouaiebe/leaflet.TravelNotes/tree/gh-pages/TravelNotesGuides" target="_blank">?</a>'},Jo),a.create("div",{className:"TravelNotes-UI-Button",title:"Contact",innerHTML:'<a class="TravelNotes-UI-LinkButton" href="'+(t.travelNotesToolbarUI.contactMail||window.location.origin)+'" target="_blank">@</a>'},Jo),t.APIKeys.showDialogButton&&a.create("div",{className:"TravelNotes-UI-Button",title:b.getText("TravelNotesToolbarUI - API keys"),innerHTML:"&#x1f511;"},Jo).addEventListener("click",en,!1),r.disabled<Xo.status&&(Zo=a.create("div",{className:"TravelNotes-UI-Button",title:b.getText("TravelNotesToolbarUI - Geo location"),innerHTML:"&#x1f310;"},Jo),Zo.addEventListener("click",tn,!1)),function(){let e=a.create("div",{innerHTML:"&#x274c;",className:"TravelNotes-UI-Button TravelNotes-UI-FlexRow-RightButton"},Jo);e.addEventListener("click",an,!1),t.travelEditor.startMinimized?(e.innerHTML="&#x1f4cc;",Yo.addEventListener("mouseenter",Qo,!1),Yo.addEventListener("mouseleave",$o,!1),Yo.classList.add("TravelNotes-UI-MainDiv-Minimize")):(Yo.classList.add("TravelNotes-UI-MainDiv-Maximize"),qo=!0)}()}geoLocationStatusChanged(e){switch(e){case r.inactive:Zo.classList.remove("TravelNotes-TravelNotesToolbarUI-GeoLocationButton-Striked");break;case r.active:Zo.classList.add("TravelNotes-TravelNotesToolbarUI-GeoLocationButton-Striked");break;default:Zo&&(Zo.parentNode.removeChild(Zo),Zo=null)}}});function nn(){let e=t.itineraryPane.showNotes,o=t.itineraryPane.showManeuvers,n=null,r=null,l=null,d=null,c=null,u=null;function g(e){e.stopPropagation(),e.preventDefault();let t=e.target;for(;!t.latLng;)t=t.parentNode;e.latlng={lat:s.defaultValue,lng:s.defaultValue},e.fromUI=!0,e.originalEvent={clientX:e.clientX,clientY:e.clientY,latLng:t.latLng},t.maneuverObjId?(e.maneuverObjId=t.maneuverObjId,function(e,t){let a=e.maneuverObjId,o=Ee(),n=Ge(e,[{context:o,name:b.getText("ManeuverContextMenu - Zoom to this maneuver"),action:o.zoomToManeuver,param:a}],t);return Object.seal(n)}(e,n.parentNode).show()):t.noteObjId&&(e.noteObjId=t.noteObjId,ea(e,n.parentNode).show())}function v(e){e.stopPropagation(),ve.dispatch("additinerarypointmarker",{objId:e.target.objId,latLng:e.target.latLng})}function p(e){e.stopPropagation(),ve.dispatch("removeobject",{objId:e.target.objId})}function h(t){e=t.target.checked,document.querySelectorAll(".TravelNotes-UI-Route-Notes-Row").forEach(e=>{e.classList.toggle("TravelNotes-UI-Route-Notes-Row-Hidden")})}function m(e){o=e.target.checked,document.querySelectorAll(".TravelNotes-UI-Route-Maneuvers-Row").forEach(e=>{e.classList.toggle("TravelNotes-UI-Route-Maneuvers-Row-Hidden")})}return Object.freeze(new class{remove(){!function(){document.querySelectorAll(".TravelNotes-UI-Route-Notes-Row, .TravelNotes-UI-Route-Maneuvers-Row").forEach(e=>{e.removeEventListener("contextmenu",g,!1),e.removeEventListener("mouseenter",v,!1),e.removeEventListener("mouseleave",p,!1)});let e=document.querySelector(".TravelNotes-UI-Route-ManeuversAndNotes");e&&n.removeChild(e)}(),l&&(u&&(u.removeEventListener("click",m,!1),l.removeChild(u),u=null),c&&(c.removeEventListener("click",h,!1),l.removeChild(c),c=null),r.removeChild(l),l=null),d&&(r.removeChild(d),d=null)}add(){-1!==$.editedRouteObjId&&(l=a.create("div",null,r),a.create("text",{value:b.getText("ItineraryPaneUI - Show notes")},l),c=a.create("input",{type:"checkbox",id:"TravelNotes-ItineraryPane-ShowNotesInput",checked:e},l),c.addEventListener("click",h,!1),a.create("text",{value:b.getText("ItineraryPaneUI - Show maneuvers")},l),u=a.create("input",{type:"checkbox",id:"TravelNotes-ItineraryPane-ShowManeuversInput",checked:o},l),u.addEventListener("click",m,!1),d=ca.getRouteHeaderHTML("TravelNotes-UI-",$.travel.editedRoute),r.appendChild(d),n.appendChild(ca.getEditedRouteManeuversAndNotesHTML("TravelNotes-UI-")),document.querySelectorAll(".TravelNotes-UI-Route-Notes-Row, .TravelNotes-UI-Route-Maneuvers-Row").forEach(e=>{e.addEventListener("contextmenu",g,!1),e.addEventListener("mouseenter",v,!1),e.addEventListener("mouseleave",p,!1)}),e||document.querySelectorAll(".TravelNotes-UI-Route-Notes-Row").forEach(e=>{e.classList.toggle("TravelNotes-UI-Route-Notes-Row-Hidden")}),o||document.querySelectorAll(".TravelNotes-UI-Route-Maneuvers-Row").forEach(e=>{e.classList.toggle("TravelNotes-UI-Route-Maneuvers-Row-Hidden")}))}getId(){return i.itineraryPane}getButtonText(){return b.getText("PanesManagerUI - Itinerary")}setPaneDivs(e,t){n=e,r=t}})}let rn=-1,ln=-1,sn=!1;let dn=null,cn=null,un=null,gn=[];class vn{constructor(e,t){this.name=e,this.items=[],this.filterTagsArray=[],this.elementTypes=["node","way","relation"],this.isSelected=!1,this.isExpanded=!1,this.isRoot=!1,t&&(this.isExpanded=!0,this.isRoot=!0)}}function pn(){-1===ln?ln=p():ve.dispatch("removeobject",{objId:ln});let e=$.map.getCenter();cn=$.map.getBounds();let a=Pe.getSquareBoundingBox([e.lat,e.lng],5e3);cn.getSouthWest().lat=Math.max(cn.getSouthWest().lat,a.getSouthWest().lat),cn.getSouthWest().lng=Math.max(cn.getSouthWest().lng,a.getSouthWest().lng),cn.getNorthEast().lat=Math.min(cn.getNorthEast().lat,a.getNorthEast().lat),cn.getNorthEast().lng=Math.min(cn.getNorthEast().lng,a.getNorthEast().lng),ve.dispatch("addrectangle",{objId:ln,bounds:cn,properties:t.nextSearchLimit})}function hn(e){e.isSelected&&0<e.filterTagsArray.length&&(gn=gn.concat(e)),e.items.forEach(hn)}function mn(e,t){gn.forEach(a=>{a.filterTagsArray.forEach(o=>{(function(e,t){let a=!0;for(const[o,n]of Object.entries(t))a=a&&e.tags[o]&&(e.tags[o]===n||"*"===n);return a})(e,o)&&(e.description=a.name,t.set(e.id,e))})})}function fn(e){let t=new Map,a=new Map,o=new Map,n=new Map;function r(e){e.geometry=[[]],e.lat=s.defaultValue,e.lon=s.defaultValue;let t=0;e.nodes.forEach(o=>{let n=a.get(o);e.geometry[0].push([n.lat,n.lon]),e.lat+=n.lat,e.lon+=n.lon,t++}),0!==t&&(e.lat/=t,e.lon/=t)}e.forEach(e=>{switch(e.type){case"node":a.set(e.id,e);break;case"way":o.set(e.id,e);break;case"relation":n.set(e.id,e)}e.tags&&mn(e,t)}),t.forEach(e=>{switch(e.type){case"way":r(e);break;case"relation":!function(e){e.geometry=[[]],e.lat=s.defaultValue,e.lon=s.defaultValue;let t=0;e.members.forEach(a=>{if("way"===a.type){let n=o.get(a.ref);r(n),e.geometry.push(n.geometry[0]),e.lat+=n.lat,e.lon+=n.lon,t++}}),0!==t&&(e.lat/=t,e.lon/=t)}(e)}}),$.searchData=Array.from(t.values()).sort((e,t)=>e.description>t.description?1:e.description<t.description?-1:0),sn=!1,ve.dispatch("showsearch")}function bn(e){let t=[];e.forEach(e=>{"fulfilled"===e.status?t=t.concat(e.value.elements):console.log(e.reason)}),fn(t)}const yn=Object.seal(new class{get dictionary(){return un}search(){sn||(sn=!0,gn=[],hn(un),Promise.allSettled(function(){let e=[];dn=cn;let a={node:new Map,way:new Map,relation:new Map};gn.forEach(e=>{e.elementTypes.forEach(t=>{e.filterTagsArray.forEach(e=>{a[t].set(e,e)})})});let n={node:"",way:"",relation:""},r="("+cn.getSouthWest().lat.toFixed(s.fixed)+","+cn.getSouthWest().lng.toFixed(s.fixed)+","+cn.getNorthEast().lat.toFixed(s.fixed)+","+cn.getNorthEast().lng.toFixed(s.fixed)+")";for(const[e,t]of Object.entries(a))t.forEach(t=>{let[a,o]=Object.entries(t)[0];n[e]+=e+"["+a+("*"===o?"":"="+o)+"]"+r+";"});for(const[a,r]of Object.entries(n))if(""!==r){let n=t.overpassApiUrl+"?data=[out:json][timeout:20];("+r+");"+("node"===a?"":"(._;>;);")+"out;";e.push(o.getJsonPromise(n))}return e}()).then(bn))}show(){$.map.on("zoom",pn),$.map.on("move",pn),pn(),dn&&(-1===rn?rn=p():ve.dispatch("removeobject",{objId:rn}),ve.dispatch("addrectangle",{objId:rn,bounds:[[dn.getSouthWest().lat,dn.getSouthWest().lng],[dn.getNorthEast().lat,dn.getNorthEast().lng]],properties:t.previousSearchLimit}))}hide(){let e=ve;$.map.off("zoom",pn),$.map.off("move",pn),-1!==ln&&(e.dispatch("removeobject",{objId:ln}),ln=-1),-1!==rn&&(e.dispatch("removeobject",{objId:rn}),rn=-1)}parseDictionary(e){un=new vn("All",!0);let t=[un.items],a=null,o=null;e.split(/\r\n|\r|\n/).forEach(e=>{""!==e&&function(e){let n=e.split(";");for(;""===n[n.length-1];)n.pop();let r=0,i=null;n.forEach(e=>{if(""!==e)if(-1===e.indexOf("="))o=new vn(e),t[r].push(o),t[r+1]=o.items,a=o.filterTagsArray;else{let t=e.split("=");"element"===t[0]?o.elementTypes=[t[1]]:(i=i||{},i[t[0]]=t[1])}r++}),i&&a.push(i)}(e)})}});function Tn(){let e=null,t=null,o=null,n=null,r=null,l=-1,d=0;function c(t){t.stopPropagation(),t.preventDefault();let a=t.target;for(;!a.osmElement;)a=a.parentNode;t.latlng={lat:s.defaultValue,lng:s.defaultValue},t.fromUI=!0,t.originalEvent={clientX:t.clientX,clientY:t.clientY,latLng:[a.osmElement.lat,a.osmElement.lon],osmElement:a.osmElement,geometry:a.osmElement.geometry},function(e,t){let a=Ee(),o=Ge(e,function(){let t=e.originalEvent.latLng;return[{context:_t,name:b.getText("MapContextMenu - Select this point as start point"),action:-1!==$.editedRouteObjId&&s.defaultValue===$.travel.editedRoute.wayPoints.first.lat?_t.setStartPoint:null,param:t},{context:_t,name:b.getText("MapContextMenu - Select this point as way point"),action:-1===$.editedRouteObjId?null:_t.addWayPoint,param:t},{context:_t,name:b.getText("MapContextMenu - Select this point as end point"),action:-1!==$.editedRouteObjId&&s.defaultValue===$.travel.editedRoute.wayPoints.last.lat?_t.setEndPoint:null,param:t},{context:bt,name:b.getText("OsmSearchContextMenu - Create a route note with this result"),action:bt.newSearchNote,param:{osmElement:e.originalEvent.osmElement,isTravelNote:!1}},{context:bt,name:b.getText("OsmSearchContextMenu - Create a travel note with this result"),action:bt.newSearchNote,param:{osmElement:e.originalEvent.osmElement,isTravelNote:!0}},{context:bt,name:bt.osmSearchNoteDialog?b.getText("OsmSearchContextMenu - Hide note dialog"):b.getText("OsmSearchContextMenu - Show note dialog"),action:bt.changeOsmSearchNoteDialog},{context:a,name:b.getText("OsmSearchContextMenu - Zoom to this result"),action:a.zoomToPoi,param:{latLng:e.originalEvent.latLng,geometry:e.originalEvent.geometry}}]}(),t);return Object.seal(o)}(t,e).show()}function u(e){e.stopPropagation(),l=e.target.objId,ve.dispatch("addsearchpointmarker",{objId:e.target.objId,latLng:[e.target.osmElement.lat,e.target.osmElement.lon],geometry:e.target.osmElement.geometry})}function v(e){e.stopPropagation(),ve.dispatch("removeobject",{objId:e.target.objId})}function h(){document.querySelectorAll(".TravelNotes-OsmSearchPaneUI-SearchResult").forEach(t=>{t.removeEventListener("contextmenu",c,!1),t.removeEventListener("mouseenter",u,!1),t.removeEventListener("mouseleave",v,!1),e.removeChild(t)})}function m(e){d++;let t=a.create("div",{className:"TravelNotes-SearchPaneUI-SearchItem TravelNotes-SearchPaneUI-SearchItemMargin"+d,dictItem:e},r);if(!e.isRoot){a.create("input",{type:"checkbox",checked:e.isSelected},t).addEventListener("change",(function(e){!function e(t,a){t.isSelected=a,t.items.forEach(t=>{e(t,a)})}(e.target.parentNode.dictItem,e.target.checked),r.innerHTML="",m(yn.dictionary)}),!1)}if(0===e.filterTagsArray.length){a.create("div",{className:"TravelNotes-UI-Button TravelNotes-OsmSearchPaneUI-TreeArrow",innerHTML:e.isExpanded?"▼":"▶"},t).addEventListener("click",(function(e){e.target.parentNode.dictItem.isExpanded=!e.target.parentNode.dictItem.isExpanded,r.innerHTML="",m(yn.dictionary)}),!1)}a.create("text",{value:e.name},t),e.isExpanded&&e.items.forEach(m),d--}function f(){h(),yn.dictionary.isExpanded=!1,r.innerHTML="",m(yn.dictionary),n=a.create("div",{className:"TravelNotes-WaitAnimation"},t),a.create("div",{className:"TravelNotes-WaitAnimationBullet"},n),yn.search()}function y(e){e.items.forEach(y),e.isSelected=!1}function T(){y(yn.dictionary),r.innerHTML="",m(yn.dictionary)}function N(e){e.items.forEach(N),e.isExpanded=!0}function L(){N(yn.dictionary),r.innerHTML="",m(yn.dictionary)}function w(e){e.items.forEach(w),e.isRoot||(e.isExpanded=!1)}function I(){w(yn.dictionary),r.innerHTML="",m(yn.dictionary)}function x(e){e.deltaY&&(e.target.scrollTop+=e.deltaY*g[e.deltaMode]),e.stopPropagation()}function A(e,t){t&&a.create("div",{innerHTML:t},e)}function j(t){let o=a.create("div",{className:"TravelNotes-OsmSearchPaneUI-SearchResult-Row",osmElement:t,objId:p()},e),n="";n=t.tags.rcn_ref?"<div class='TravelNotes-MapNote TravelNotes-MapNoteCategory-0073'><svg viewBox='0 0 20 20'><text x='10' y='14'>"+t.tags.rcn_ref+"</text></svg></div>":st.getIconDataFromName(t.description)||"",a.create("div",{className:"TravelNotes-OsmSearchPaneUI-SearchResult-IconCell",innerHTML:n},o);let r=a.create("div",{className:"TravelNotes-OsmSearchPaneUI-SearchResult-Cell"},o);A(r,t.description),A(r,t.tags.name),A(r,t.tags.rcn_ref),A(r,function(e){let t=(e.tags["addr:street"]?(e.tags["addr:housenumber"]?e.tags["addr:housenumber"]+" ":"")+e.tags["addr:street"]+" ":"")+(e.tags["addr:city"]?(e.tags["addr:postcode"]?e.tags["addr:postcode"]+" ":"")+e.tags["addr:city"]:"");return""===t?null:t}(t)),t.tags.phone&&A(r,"☎️ : "+t.tags.phone),t.tags.email&&a.create("a",{href:"mailto:"+t.tags.email,innerHTML:t.tags.email},a.create("div",{innerHTML:"📧 : "},r)),t.tags.website&&a.create("a",{href:t.tags.website,target:"_blank",innerHTML:t.tags.website},a.create("div",null,r)),o.title="";for(const[e,a]of Object.entries(t.tags))o.title+=e+"="+a+"\n";o.addEventListener("contextmenu",c,!1),o.addEventListener("mouseenter",u,!1),o.addEventListener("mouseleave",v,!1)}return Object.freeze(new class{remove(){yn.hide(),h(),r&&(t.removeChild(r),r=null),o&&t.removeChild(o),n&&(t.removeChild(n),n=null),ve.dispatch("removeobject",{objId:l})}add(){yn.show(),o=a.create("div",null,t),a.create("div",{className:"TravelNotes-UI-Button",title:b.getText("OsmSearchPaneUI - Search OpenStreetMap"),innerHTML:"🔎"},o).addEventListener("click",f,!1),a.create("div",{className:"TravelNotes-UI-Button",title:b.getText("OsmSearchPaneUI - Expand tree"),innerHTML:"▼"},o).addEventListener("click",L,!1),a.create("div",{className:"TravelNotes-UI-Button",title:b.getText("OsmSearchPaneUI - Collapse tree"),innerHTML:"▶"},o).addEventListener("click",I,!1),a.create("div",{id:"TravelNotes-OsmSearchPaneUI-ClearAllButton",className:"TravelNotes-UI-Button",title:b.getText("OsmSearchPaneUI - Clear tree"),innerHTML:"❌"},o).addEventListener("click",T,!1),r=a.create("div",{id:"TravelNotes-OsmSearchPaneUI-SearchTree"},t),r.addEventListener("wheel",x,!1),yn.dictionary.name="",m(yn.dictionary),$.searchData.forEach(j)}getId(){return i.searchPane}getButtonText(){return b.getText("PanesManagerUI - Search")}setPaneDivs(a,o){e=a,t=o}})}let Nn=null;const Ln=Object.freeze(new class{createUI(e){Nn||(Nn=a.create("div",{id:"TravelNotes-UI-MainDiv"},e),a.create("div",{id:"TravelNotes-UI-MainDiv-Title",innerHTML:"Travel&nbsp;&amp;&nbsp;Notes"},Nn),on.createUI(Nn),yo.createUI(Nn),jo.addPane(nn()),jo.addPane(function(){let e=0,t=null,a=null;function o(t){t.stopPropagation();try{t.dataTransfer.setData("Text",t.target.dataObjId),t.dataTransfer.dropEffect="move"}catch(e){console.log(e)}e=t.target.noteObjId}function n(e){e.preventDefault()}function r(t){t.preventDefault();let a=t.target;for(;!a.noteObjId;)a=a.parentElement;let o=a.getBoundingClientRect();bt.travelNoteDropped(e,a.noteObjId,t.clientY-o.top<o.bottom-t.clientY)}function l(e){e.stopPropagation(),e.preventDefault();let a=e.target;for(;!a.noteObjId;)a=a.parentNode;e.latlng={lat:s.defaultValue,lng:s.defaultValue},e.fromUI=!0,e.originalEvent={clientX:e.clientX,clientY:e.clientY,latLng:a.latLng},a.noteObjId&&(e.noteObjId=a.noteObjId,ea(e,t.parentNode).show())}return Object.freeze(new class{remove(){a&&(a.childNodes.forEach(e=>{e.removeEventListener("contextmenu",l,!1),e.removeEventListener("dragstart",o,!1)}),t.removeChild(a)),a=null}add(){a=ca.getTravelNotesHTML("TravelNotes-UI-"),a.addEventListener("drop",r,!1),a.addEventListener("dragover",n,!1),t.appendChild(a),a.childNodes.forEach(e=>{e.draggable=!0,e.addEventListener("contextmenu",l,!1),e.addEventListener("dragstart",o,!1),e.classList.add("TravelNotes-UI-MoveCursor")})}getId(){return i.travelNotesPane}getButtonText(){return b.getText("PanesManagerUI - Travel notes")}setPaneDivs(e){t=e}})}()),jo.addPane(Tn()),jo.createUI(Nn),Bo.createUI(Nn),Nn.addEventListener("travelnameupdated",()=>yo.setTravelName(),!1),Nn.addEventListener("setrouteslist",()=>yo.setRoutesList(),!1),Nn.addEventListener("showitinerary",()=>jo.showPane(i.itineraryPane),!1),Nn.addEventListener("updateitinerary",()=>jo.updatePane(i.itineraryPane),!1),Nn.addEventListener("showtravelnotes",()=>jo.showPane(i.travelNotesPane),!1),Nn.addEventListener("updatetravelnotes",()=>jo.updatePane(i.travelNotesPane),!1),Nn.addEventListener("showsearch",()=>jo.showPane(i.searchPane),!1),Nn.addEventListener("updatesearch",()=>jo.updatePane(i.searchPane),!1),Nn.addEventListener("providersadded",()=>Bo.providersAdded(),!1),Nn.addEventListener("setprovider",e=>{e.data&&e.data.provider&&(Bo.provider=e.data.provider)},!1),Nn.addEventListener("settransitmode",e=>{e.data&&e.data.provider&&(Bo.transitMode=e.data.transitMode)},!1),document.addEventListener("geolocationstatuschanged",e=>{on.geoLocationStatusChanged(e.data.status)},!1),Nn.addEventListener("click",e=>{e.target.id&&"TravelNotes-UI-MainDiv"===e.target.id&&(e.stopPropagation(),e.preventDefault())},!1),Nn.addEventListener("dblclick",e=>{e.stopPropagation(),e.preventDefault()},!1),Nn.addEventListener("contextmenu",e=>{e.stopPropagation(),e.preventDefault()},!1),Nn.addEventListener("wheel",e=>{e.stopPropagation(),e.preventDefault()},!1))}});function wn(){let e=ee();e.title=b.getText("AboutDialog - About Travel & Notes"),a.create("div",{id:"TravelNotes-AboutDialog-AboutDiv",innerHTML:'<p>This  program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 3 of the License, or any later version.</p><p>Copyright - 2017 2020 - wwwouaiebe</p><p>Contact : <a href="https://www.ouaie.be/blog/pages/Contact" target="_blank">https://www.ouaie.be/</a></p><p>GitHub : <a href="https://github.com/wwwouaiebe/leaflet.TravelNotes" target="_blank">https://github.com/wwwouaiebe/leaflet.TravelNotes</a></p><p>Version : 1.13.0.<p>This program uses: <a href="https://leafletjs.com/" target="_blank">leaflet</a>, <a href="https://github.com/mapbox/polyline" target="_blank">mapbox/polyline</a>, <a href="https://github.com/Project-OSRM/osrm-text-instructions" target="_blank">Project-OSRM/osrm-text-instructions</a> and  <a href="https://github.com/drolbr/Overpass-API" target="_blank">the Overpass API</a></p>'},e.content),e.show().then().catch(e=>console.log(e||"An error occurs in the dialog"))}let In=null;const xn=Object.freeze(new class{getOpenPromise(){return new Promise((function(e,t){if(In)return void e();let a=window.indexedDB.open("TravelNotesDb",1);a.onerror=function(){In=null,t(new Error("Not possible to open the db"))},a.onsuccess=function(t){In=t.target.result,e()},a.onupgradeneeded=function(e){In=e.target.result,In.createObjectStore("Travels",{keyPath:"UUID"})}}))}getReadPromise(e){return new Promise((function(t,a){if(!In)return void a(new Error("Database not opened"));let o=In.transaction(["Travels"],"readonly");o.onerror=function(){a(new Error("Transaction error"))},o.objectStore("Travels").get(e).onsuccess=function(e){t(e.target.result?e.target.result.data:null)}}))}getWritePromise(e,t){return new Promise((function(a,o){if(!In)return void o(new Error("Database not opened"));let n=null;try{n=In.transaction(["Travels"],"readwrite")}catch(e){return void o(e)}n.onerror=function(){o(new Error("Transaction error"))},n.objectStore("Travels").put({UUID:e,data:t}).onsuccess=function(){a()}}))}closeDb(e){if(!In)return;if(!e)return In.close(),void(In=null);let t=In.transaction(["Travels"],"readwrite");t.onerror=function(){};let a=t.objectStore("Travels").delete(e);a.onerror=function(){In.close(),In=null},a.onsuccess=function(){In.close(),In=null}}});let An=null,jn=null,Pn=null;function En(){An.innerHTML="<span>"+jn+"&nbsp;-&nbsp;Zoom&nbsp;:&nbsp;"+Pn+"</span>"}function Mn(e){jn=y.formatLat(e.latlng.lat)+"&nbsp;-&nbsp;"+y.formatLng(e.latlng.lng),En()}function Dn(){Pn=$.map.getZoom(),En()}const Rn=Object.freeze(new class{createUI(){Pn=$.map.getZoom();let e=$.map.getCenter();jn=y.formatLat(e.lat)+"&nbsp;-&nbsp;"+y.formatLng(e.lng),An=a.create("div",{id:"TravelNotes-MouseUI"},document.querySelector("body")),$.map.on("mousemove",Mn),$.map.on("zoomend",Dn)}});let On=!1;function Cn(){document.addEventListener("routeupdated",e=>{e.data&&Ba.updateRoute(e.data.removedRouteObjId,e.data.addedRouteObjId)},!1),document.addEventListener("routepropertiesupdated",e=>{e.data&&Ba.updateRouteProperties(e.data.routeObjId)},!1),document.addEventListener("noteupdated",e=>{e.data&&Ba.updateNote(e.data.removedNoteObjId,e.data.addedNoteObjId)},!1),document.addEventListener("removeobject",e=>{e.data&&Ba.removeObject(e.data.objId)},!1),document.addEventListener("removeallobjects",()=>Ba.removeAllObjects(),!1),document.addEventListener("zoomto",e=>{e.data&&fa.zoomTo(e.data.latLng,e.data.geometry)},!1),document.addEventListener("additinerarypointmarker",e=>{e.data&&Ba.addItineraryPointMarker(e.data.objId,e.data.latLng)},!1),document.addEventListener("addsearchpointmarker",e=>{e.data&&Ba.addSearchPointMarker(e.data.objId,e.data.latLng,e.data.geometry)},!1),document.addEventListener("addrectangle",e=>{e.data&&Ba.addRectangle(e.data.objId,e.data.bounds,e.data.properties)},!1),document.addEventListener("addwaypoint",e=>{e.data&&Ba.addWayPoint(e.data.wayPoint,e.data.letter)},!1),document.addEventListener("layerchange",e=>{e.data&&Ba.setLayer(e.data.layer)}),document.addEventListener("geolocationpositionchanged",e=>{e.data&&fa.onGeolocationPositionChanged(e.data.position)},!1),document.addEventListener("geolocationstatuschanged",e=>{e.data&&fa.onGeolocationStatusChanged(e.data.status)},!1),document.addEventListener("roadbookupdate",()=>{y.storageAvailable("localStorage")&&xn.getOpenPromise().then(()=>{xn.getWritePromise($.UUID,ca.getTravelHTML("TravelNotes-Roadbook-").outerHTML)}).then(()=>localStorage.setItem($.UUID,Date.now())).catch(e=>console.log(e||"An error occurs when writing the content"))},!1),document.addEventListener("profileclosed",e=>{e.data&&wt.onProfileClosed(e.data.objId)},!1)}function Sn(e){$.travel.readOnly||function(e){let t=[e.latlng.lat,e.latlng.lng],a=Ee(),o=Ge(e,[{context:_t,name:b.getText("MapContextMenu - Select this point as start point"),action:-1!==$.editedRouteObjId&&s.defaultValue===$.travel.editedRoute.wayPoints.first.lat?_t.setStartPoint:null,param:t},{context:_t,name:b.getText("MapContextMenu - Select this point as way point"),action:-1===$.editedRouteObjId?null:_t.addWayPoint,param:t},{context:_t,name:b.getText("MapContextMenu - Select this point as end point"),action:-1!==$.editedRouteObjId&&s.defaultValue===$.travel.editedRoute.wayPoints.last.lat?_t.setEndPoint:null,param:t},{context:qt,name:b.getText("MapContextMenu - Add a route"),action:qt.addRoute},{context:qt,name:b.getText("MapContextMenu - Hide all routes"),action:qt.hideRoutes},{context:qt,name:b.getText("MapContextMenu - Show all routes"),action:qt.showRoutes},{context:bt,name:b.getText("MapContextMenu - New travel note"),action:bt.newTravelNote,param:t},{context:bt,name:b.getText("MapContextMenu - Hide all notes"),action:bt.hideNotes},{context:bt,name:b.getText("MapContextMenu - Show all notes"),action:bt.showNotes},{context:a,name:b.getText("MapContextMenu - Zoom to travel"),action:a.zoomToTravel},{context:null,name:b.getText("MapContextMenu - About Travel & Notes"),action:wn}]);return Object.seal(o)}
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file IndexedDb.js
	@copyright Copyright - 2017 2020 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/(e).show()}const Un=Object.seal(new class{addReadOnlyMap(e,t){On||(On=!0,Cn(),e&&($.map=e),It.createUI(),Wt.setLayer("OSM - Color"),o.getJsonPromise(t).then(e=>{Za().openDistantFile(e)}).catch(e=>{console.log(e||"Not possible to load the .trv file"),$.map.setView([s.defaultValue,s.defaultValue],2)}))}addControl(e,a){On||(On=!0,Cn(),window.addEventListener("unload",()=>{localStorage.removeItem($.UUID)}),window.addEventListener("beforeunload",e=>(xn.closeDb($.UUID),e.returnValue="x","x")),e&&($.map=e,$.map.on("contextmenu",Sn)),$.travel=J(),$.travel.routes.add(K()),Ln.createUI(document.getElementById(a)),It.createUI(),Ne.setKeysFromServerFile(),t.layersToolbarUI.haveLayersToolbarUI&&Wt.createUI(),t.mouseUI.haveMouseUI&&Rn.createUI(),t.travelEditor.startupRouteEdition&&qt.editRoute($.travel.routes.first.objId),ve.dispatch("setrouteslist"),ve.dispatch("roadbookupdate"),$.map.setView([t.map.center.lat,t.map.center.lng],t.map.zoom),ue.showHelp(b.getText("Help - Continue with interface")))}addProvider(e){Ne.addProvider(e)}showInfo(e){ue.showInfo(e)}get baseDialog(){return ee()}get userData(){return $.travel.userData}set userData(e){$.travel.userData=e}get map(){return $.map}get maneuver(){return R()}get itineraryPoint(){return P()}get version(){return"1.13.0"}});(function(){let e=null,n=null,r="",i=!1;function l(a){var o,n,l,s,d,c,u;("fulfilled"===a[0].status&&(i=!0),r=function(a){if("fulfilled"===a.status){if(a.value.language=e,a.value.haveCrypto=i,"wwwouaiebe.github.io"===window.location.hostname){a.value.layersToolbarUI.theDevil.addButton=!1,a.value.errorUI.showHelp=!0;const e=120;a.value.printRouteMap.maxTiles=e;const t=10;a.value.note.maxManeuversNotes=t,a.value.note.haveBackground=!0,a.value.APIKeys.dialogHaveUnsecureButtons=!0}return t.overload(a.value),""}return"Not possible to load the TravelNotesConfig.json file. "}(a[1]),r)?ue.showError(r):($.providers.forEach(e=>{e.userLanguage=t.language}),o=a[2],n=a[5],r="fulfilled"===o.status?(b.setTranslations(o.value),""):"fulfilled"===n.status?(b.setTranslations(n.value),"Not possible to load the TravelNotes"+e.toUpperCase()+".json file. English will be used. "):"Not possible to load the translations. ",r+=(l=a[4],s=a[6],"fulfilled"===l.status?(st.selectOptions=l.value.preDefinedIconsList,st.buttons=l.value.editionButtons,""):"fulfilled"===s.status?(st.selectOptions=s.value.preDefinedIconsList,st.buttons=s.value.editionButtons,"Not possible to load the TravelNotesNoteDialog"+e.toUpperCase()+".json file. English will be used. "):"Not possible to load the translations for the note dialog. "),r+="fulfilled"===(d=a[3]).status?(Wt.addLayers(d.value),""):"Not possible to load the TravelNotesLayers.json file. Only the OpenStreetMap background will be available. ",r+=(c=a[7],u=a[8],"fulfilled"===c.status?(yn.parseDictionary(c.value),""):"fulfilled"===u.status?(yn.parseDictionary(u.value),"Not possible to load the TravelNotesSearchDictionary"+e.toUpperCase()+".csv file. English will be used. "):"Not possible to load the search dictionary. OSM search will not be available."),""!==r&&(ue.showWarning(r),r=""))}return Object.freeze(new class{start(){window.L.travelNotes=Un,function(){let t="?";decodeURI(window.location.search).substr(1).split("&").forEach(a=>{-1===a.indexOf("ProviderKey")?("fil="===a.substr(0,4).toLowerCase()?n=decodeURIComponent(escape(atob(a.substr(4)))):"lng="===a.substr(0,4).toLowerCase()&&(e=a.substr(4).toLowerCase()),t+="?"===t?"":"&",t+=a):Ne.setKeyFromUrl(a)}),history.replaceState({index:"bar"},"page",t)}(),e=e||t.language,ue.createUI(),Promise.allSettled(function(){let t=window.location.origin+window.location.pathname+"TravelNotes";return[window.crypto&&window.crypto.subtle&&window.crypto.subtle.importKey&&window.isSecureContext?window.crypto.subtle.importKey("raw",(new window.TextEncoder).encode("hoho"),{name:"PBKDF2"},!1,["deriveKey"]):Promise.reject(new Error("Invalid crypto functions or unsecure context")),o.getJsonPromise(t+"Config.json"),o.getJsonPromise(t+e.toUpperCase()+".json"),o.getJsonPromise(t+"Layers.json"),o.getJsonPromise(t+"NoteDialog"+e.toUpperCase()+".json"),o.getJsonPromise(t+"EN.json"),o.getJsonPromise(t+"NoteDialogEN.json"),o.getTextPromise(t+"SearchDictionary"+e.toUpperCase()+".csv"),o.getTextPromise(t+"SearchDictionaryEN.csv")]}()).then(e=>{l(e),function(){if(t.autoLoad&&""===r){a.create("div",{id:"Map"},document.querySelector("body")),a.create("div",{id:"TravelNotes"},document.querySelector("body"));let e=window.L.map("Map",{attributionControl:!1,zoomControl:!1}).setView([s.defaultValue,s.defaultValue],0);n?Un.addReadOnlyMap(e,n):Un.addControl(e,"TravelNotes")}}()})}})})().start()}();