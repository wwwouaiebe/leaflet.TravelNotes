/**
 * 
 * @source: https://github.com/wwwouaiebe/leaflet.TravelNotes
 * 
 * @licstart  The following is the entire license notice for the
 * JavaScript code in this page.
 * 
 * leaflet.travelnotes - version 3.0.0
 * Build 02783 - 2021-09-09T15:34:56+0200 
 * Copyright 2017 2021 wwwouaiebe 
 * Contact: https://www.ouaie.be/
 * License: GPL-3.0
 * 
 * The JavaScript code in this page is free software: you can
 * redistribute it and/or modify it under the terms of the GNU
 * General Public License (GNU GPL) as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option)
 * any later version.  The code is distributed WITHOUT ANY WARRANTY;
 * without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.
 * 
 * As additional permission under GNU GPL version 3 section 7, you
 * may distribute non-source (e.g., minimized or compacted) forms of
 * that code without the copy of the GNU GPL normally required by
 * section 4, provided you include this license notice and a URL
 * through which recipients can access the Corresponding Source.
 * 
 * @licend  The above is the entire license notice
 * for the JavaScript code in this page.
 * 
 */


!function(){"use strict";
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file Config.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/let e={APIKeys:{saveToSessionStorage:!0},APIKeysDialog:{haveUnsecureButtons:!0,showAPIKeys:!0,showButton:!0},contextMenu:{timeout:1500},errorsUI:{helpTimeOut:3e4,showError:!0,showHelp:!0,showInfo:!0,showWarning:!0,timeOut:1e4},geoCoder:{distances:{city:1200,hamlet:200,town:1500,village:400},osmCityAdminLevel:{DEFAULT:"8",GB:"10"}},geoLocation:{marker:{color:"#ff0000",radius:11},options:{enableHighAccuracy:!1,maximumAge:0,timeout:1/0},zoomFactor:17,zoomToPosition:!0},itineraryPaneUI:{showManeuvers:!1,showNotes:!0},itineraryPoint:{marker:{color:"#ff0000",fill:!1,radius:7,weight:2},zoomFactor:17},layersToolbarUI:{haveLayersToolbarUI:!0,toolbarTimeOut:1500,theDevil:{addButton:!1}},map:{center:{lat:50.50923,lng:5.49542},zoom:12},mouseUI:{haveMouseUI:!0},nominatim:{url:"https://nominatim.openstreetmap.org/",language:"*"},note:{grip:{size:10,opacity:0,moveOpacity:1},haveBackground:!1,maxManeuversNotes:100,polyline:{color:"#808080",weight:1},reverseGeocoding:!1,svgIcon:{angleDistance:10,angleDirection:{right:35,slightRight:80,continue:100,slightLeft:145,left:200,sharpLeft:270,sharpRight:340},rcnRefDistance:20,roadbookFactor:1,zoom:17}},noteDialog:{areaHeight:{icon:2,popupContent:8},mask:{iconsDimension:!0,iconTextArea:!1,tooltip:!1,popupContent:!1,address:!1,link:!1,phone:!0},theDevil:{addButton:!1,zoomFactor:17}},osmSearch:{nextSearchLimit:{color:"#ff0000",fill:!1,weight:1},previousSearchLimit:{color:"#006400",fill:!1,weight:1},searchPointMarker:{color:"#006400",fill:!1,radius:20,weight:4},searchPointPolyline:{color:"#006400",fill:!1,weight:4},showSearchNoteDialog:!1},overpassApi:{useNwr:!0,timeOut:40,url:"https://lz4.overpass-api.de/api/interpreter"},printRouteMap:{isEnabled:!0,maxTiles:240,paperWidth:287,paperHeight:200,pageBreak:!1,printNotes:!0,borderWidth:30,zoomFactor:15,entryPointMarker:{color:"#00ff00",weight:4,radius:10,fill:!0,fillOpacity:1},exitPointMarker:{color:"#ff0000",weight:4,radius:10,fill:!0,fillOpacity:1}},route:{color:"#ff0000",dashArray:0,dashChoices:[{text:"â€”â€”â€”â€”â€”â€”",iDashArray:[0]},{text:"â€” â€” â€” â€” â€”",iDashArray:[4,2]},{text:"â€”â€§â€”â€§â€”â€§â€”â€§â€”",iDashArray:[4,2,0,2]},{text:"Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·",iDashArray:[0,2]}],elev:{smooth:!0,smoothCoefficient:.25,smoothPoints:3},showDragTooltip:3,width:3},routeEditor:{showEditedRouteInRoadbook:!0},travelEditor:{startMinimized:!0,startupRouteEdition:!0,timeout:1e3},travelNotes:{autoLoad:!0,haveBeforeUnloadWarning:!0,language:"fr"},travelNotesToolbarUI:{contactMail:{url:"https://github.com/wwwouaiebe/leaflet.TravelNotes/issues"}},wayPoint:{reverseGeocoding:!1,geocodingIncludeName:!1}};
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file Constants.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/const t=Object.freeze({minColorValue:0,maxColorValue:255,rowsNumber:6,cellsNumber:6,deltaColor:51,sliderMaxValue:100,sliderStep:20,initialRed:0}),o=Object.freeze({notSaved:"ðŸ”´",modified:"ðŸŸ¡",saved:"ðŸŸ¢"}),n=Object.freeze({fixed:2,invalid:-1,defaultValue:0,metersInKm:1e3}),a=Object.freeze({refusedByUser:-1,disabled:0,inactive:1,active:2}),s=Object.freeze({invalidPane:"43a6a53e-008a-4910-80a6-7a87d301ea15",itineraryPane:"8fbf0da7-4e6f-4bc7-8e20-1388461ccde7",travelNotesPane:"dffe782b-07df-4b81-a318-f287c0cf5ec6",searchPane:"228f00d7-43a8-4c13-897d-70400cb6dd58"}),i=Object.freeze({fixed:2,defaultValue:0}),r=Object.freeze({defaultValue:0,fixed:6,maxLat:90,minLat:-90,maxLng:180,minLng:-180}),l=Object.freeze({notEdited:0,editedNoChange:1,editedChanged:2}),d=Object.freeze({margin:100,height:500,width:1e3,yDeltaText:30,xDeltaText:10,vScales:[1,2,5,10,20,50,100,200,500,1e3,2e3,5e3],hScales:[1,2,5,10,20,50,100,200,500,1e3,2e3,5e3,1e4,2e4,5e4,1e5]}),h=Object.freeze({width:40,height:40,svgViewboxDim:200}),c=Object.freeze({d0:0,d90:90,d180:180,d270:270,d360:360,d540:540,toRadians:Math.PI/180,fromRadians:180/Math.PI}),u=Object.freeze({atStart:-1,onRoute:0,atEnd:1}),v=[.3,10,1],_=-1,p=-1,m=16,g=200,y="http://www.w3.org/2000/svg",b=6371e3,I=20,w=20;class L{static _objId=0;static get nextObjId(){return++L._objId}}
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file Version.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/const T="2.3.0",D="v3.0.0";class E{_objTypeName="";_validObjTypeNames=["Itinerary","ItineraryPoint","Maneuver","Note","Route","Travel","WayPoint"];constructor(e){if(p===this._validObjTypeNames.indexOf(e))throw new Error("Invalid ObjType name : "+e);this._objTypeName=e}get name(){return this._objTypeName}get version(){return T}get jsonObject(){return{name:this._objTypeName,version:T}}validate(e){if(!Object.getOwnPropertyNames(e).includes("name"))throw new Error("No name for "+this._objTypeName);if(this._objTypeName!==e.name)throw new Error("Invalid name for "+this._objTypeName);if(!Object.getOwnPropertyNames(e).includes("version"))throw new Error("No version for "+this._objTypeName)}}class f{_collection=null;_index=p;constructor(e){this._collection=e}get value(){return this._index<this._collection.length?this._collection.at(this._index):null}get previous(){return 0>=this._index?null:this._collection.at(this._index-1)}get next(){return this._index<this._collection.length-1?this._collection.at(this._index+1):null}get done(){return++this._index>=this._collection.length}get first(){return 0===this._index}get last(){return this._index>=this._collection.length-1}get index(){return this._index}}class N{_array=[];_objName="";_classCollection=null;_indexOfObjId(e){return this._array.findIndex((t=>t.objId===e))}_nextOrPrevious(e,t,o){let n=this._indexOfObjId(e);if(p===n)throw new Error("invalid objId for next or previous function");if(1!==o&&-1!==o)throw new Error("invalid direction");let a=t;for(a||(a=()=>!0),n+=o;p<n&&n<this._array.length&&!a(this._array[n]);)n+=o;return p===n||this._array.length===n?null:this._array[n]}constructor(e){this._classCollection=e;let t=new e;if(!t.objType||!t.objType.name)throw new Error("invalid object name for collection");this._objName=t.objType.name}add(e){if(!e.objType||!e.objType.name||e.objType.name!==this._objName)throw new Error("invalid object name for add function");this._array.push(e)}at(e){return e<this._array.length&&e>p?this._array[e]:null}forEach(e){let t=null,o=this.iterator;for(;!o.done;)t=e(o.value,t);return t}getAt(e){let t=this._indexOfObjId(e);return p===t?null:this._array[t]}moveTo(e,t,o){let n=this._indexOfObjId(e),a=this._indexOfObjId(t);if(p===n||p===a)throw new Error("invalid objId for function  myMoveTo");o||a++,this._array.splice(a,0,this._array[n]),a<n&&n++,this._array.splice(n,1)}next(e,t){return this._nextOrPrevious(e,t,1)}previous(e,t){return this._nextOrPrevious(e,t,-1)}remove(e){let t=this._indexOfObjId(e);if(p===t)throw new Error("invalid objId for remove function");this._array.splice(this._indexOfObjId(e),1)}removeAll(e){e?this._array.splice(1,this._array.length-2):this._array.length=0}replace(e,t){let o=this._indexOfObjId(e);if(p===o)throw new Error("invalid objId for replace function");if(!t.objType||!t.objType.name||t.objType.name!==this._objName)throw new Error("invalid object name for replace function");this._array[o]=t}reverse(){this._array.reverse()}sort(e){this._array.sort(e)}swap(e,t){let o=this._indexOfObjId(e);if(p===o||0===o&&t||this._array.length-1===o&&!t)throw new Error("invalid objId for swap function");let n=this._array[o];this._array[o]=this._array[o+(t?-1:1)],this._array[o+(t?-1:1)]=n}get first(){return this._array[0]}get iterator(){return new f(this)}get last(){return this._array[this._array.length-1]}get length(){return this._array.length}get jsonObject(){let e=[],t=this.iterator;for(;!t.done;)e.push(t.value.jsonObject);return e}set jsonObject(e){this._array.length=0;let t=null;e.forEach((e=>{t=new this._classCollection,t.jsonObject=e,this.add(t)}))}}const x=Object.freeze(new class{_validityMap=new Map;_parser=new DOMParser;_addHtmlEntities(e){return e.replaceAll(/</g,"&lt;").replaceAll(/>/g,"&gt;").replaceAll(/"/g,"&quot;").replaceAll(/\u0027/g,"&apos;").replaceAll(/\u0a00/g,"&nbsp;")}_stringify(e){let t="",o="",n=e.childNodes;for(let a=0;a<n.length;a++){let n=e.childNodes[a],s=n.nodeName.toLowerCase(),i=this._validityMap.get(s);if(i){i=i.concat(["id","class","dir","title","tanwidth","tanheight"]);let e="svg"===s||"text"===s||"polyline"===s;t+="<"+s,n.hasAttribute("target")&&(t+=' rel="noopener noreferrer"'),i.forEach((a=>{if(e)n.hasAttributeNS(null,a)&&(t+=" "+a+'="'+this._addHtmlEntities(n.getAttribute(a))+'"',n.removeAttribute(a));else if(n.hasAttribute(a))if("href"===a||"src"===a){let e=this.sanitizeToUrl(n.getAttribute(a),a).url;""===e?o+="\nAn invalid url ("+n.getAttribute(a)+") was removed from a "+a+" attribute":t+=" "+a+'="'+e+'"',n.removeAttribute(a)}else t+=" "+a+'="'+this._addHtmlEntities(n.getAttribute(a))+'"',n.removeAttribute(a)})),t+=">";let a="",r="";[a,r]=this._stringify(n),t+=a,o+=r,t+="</"+s+">"}else"#text"===s?t+=this._addHtmlEntities(n.nodeValue):o+="\nAn invalid tag "+s+" was removed";if(n.hasAttributes)for(let e=0;e<n.attributes.length;e++)"rel"!==n.attributes[e].name&&(o+="\nAn unsecure attribute "+n.attributes[e].name+'="'+n.attributes[e].value+'" was removed.')}return[t,o]}_cloneNode(e,t){let o=e.childNodes;for(let n=0;n<o.length;n++){let o=e.childNodes[n],a=o.nodeName.toLowerCase(),s=this._validityMap.get(a);if(s){s=s.concat(["id","class","dir","title","tanwidth","tanheight"]);let e="svg"===a||"text"===a||"polyline"===a,n=e?document.createElementNS(y,a):document.createElement(a);if(s.forEach((t=>{if(e)o.hasAttributeNS(null,t)&&(n.setAttributeNS(null,t,o.getAttribute(t)),o.removeAttributeNS(null,t));else if(o.hasAttribute(t))if("href"===t||"src"===t){let e=this.sanitizeToUrl(o.getAttribute(t),t).url;""!==e&&n.setAttribute(t,e)}else n.setAttribute(t,o.getAttribute(t))})),o.hasAttribute("style")){o.getAttribute("style").split(";").forEach((e=>{let t=e.split(":");2!==t.length||"width"!==t[0].trim()&&"height"!==t[0].trim()||(n.style[t[0].trim()]=t[1].trim())}))}o.hasAttribute("target")&&n.setAttribute("rel","noopener noreferrer"),t.appendChild(n),this._cloneNode(o,n)}else"#text"===a&&t.appendChild(document.createTextNode(o.nodeValue))}}constructor(){this._validityMap.set("a",["href","target"]),this._validityMap.set("div",[]),this._validityMap.set("del",[]),this._validityMap.set("em",[]),this._validityMap.set("figcaption",[]),this._validityMap.set("figure",[]),this._validityMap.set("h1",[]),this._validityMap.set("h2",[]),this._validityMap.set("h3",[]),this._validityMap.set("h4",[]),this._validityMap.set("h5",[]),this._validityMap.set("h6",[]),this._validityMap.set("hr",[]),this._validityMap.set("img",["src","alt","width","height"]),this._validityMap.set("ins",[]),this._validityMap.set("li",[]),this._validityMap.set("mark",[]),this._validityMap.set("ol",[]),this._validityMap.set("p",[]),this._validityMap.set("s",[]),this._validityMap.set("small",[]),this._validityMap.set("strong",[]),this._validityMap.set("span",[]),this._validityMap.set("sub",[]),this._validityMap.set("sup",[]),this._validityMap.set("ul",[]),this._validityMap.set("svg",["xmlns","viewBox","class"]),this._validityMap.set("text",["x","y","text-anchor"]),this._validityMap.set("polyline",["points","class","transform"])}sanitizeToColor(e){let t=e.match(/^\u0023[0-9,A-F,a-f]{6}$/);return t?t[0]:null}sanitizeToUrl(e,t="href"){let o=this._parser.parseFromString("<div>"+e+"</div>","text/html");if(!o||"#document"!==o.nodeName)return{url:"",errorsString:"Parsing error"};let n=o.body.firstChild,a="";for(let e=0;e<n.childNodes.length;e++){if("#text"!==n.childNodes[e].nodeName)return{url:"",errorsString:"Invalid characters found in the url"};a+=n.childNodes[e].nodeValue}if(a=a.replaceAll(/</g,"").replaceAll(/>/g,"").replaceAll(/"/g,"").replaceAll(/\u0027/g,"").replaceAll(/&lt;/g,"").replaceAll(/&gt;/g,"").replaceAll(/&quot;/g,"").replaceAll(/&apos;/g,"").replaceAll(/%3C/g,"").replaceAll(/%3c/g,"").replaceAll(/%3E/g,"").replaceAll(/%3e/g,"").replaceAll(/%22/g,"").replaceAll(/%27/g,""),a!==e)return{url:"",errorsString:"Invalid characters found in the url"};let s=["https:"];if("http:"!==window.location.protocol&&"href"!==t||s.push("http:"),"href"===t){s.push("mailto:"),s.push("sms:"),s.push("tel:");let e=a.match(/^\u0023\w*/);if(e&&a===e[0])return{url:a,errorsString:""}}"src"===t&&s.push("data:");let i=null;try{i=new URL(a)}catch(e){return{url:"",errorsString:"Invalid url string"}}if(p===s.indexOf(i.protocol))return{url:"",errorsString:"Invalid protocol "+i.protocol};if(p!==["sms:","tel:"].indexOf(i.protocol)&&i.pathname.match(/^\+[0-9,*,\u0023]*$/))return{url:a,errorsString:""};try{encodeURIComponent(i.href)}catch(e){return{url:"",errorsString:"Invalid character in url"}}return{url:a,errorsString:""}}sanitizeToJsString(e){let t=this._parser.parseFromString("<div>"+e+"</div>","text/html");if(!t||"#document"!==t.nodeName)return"";let o=t.body.firstChild,n="";for(let e=0;e<o.childNodes.length;e++){if("#text"!==o.childNodes[e].nodeName)return"";n+=o.childNodes[e].nodeValue}return n=n.replaceAll(/</g,"â‰º").replaceAll(/>/g,"â‰»").replaceAll(/"/g,"â€³").replaceAll(/\u0027/g,"â€²"),n}sanitizeToHtmlElement(e,t){let o=this._parser.parseFromString("<div>"+e+"</div>","text/html");o&&"#document"===o.nodeName?this._cloneNode(o.body.firstChild,t):t.textContent=""}clone(e){let t=document.createElement(e.tagName);return this._cloneNode(e,t),t}sanitizeToHtmlString(e){let t="",o="",n=this._parser.parseFromString("<div>"+e.replace("&nbsp;","à¨€")+"</div>","text/html");return n&&"#document"===n.nodeName?([t,o]=this._stringify(n.body.firstChild,o),{htmlString:t,errorsString:o}):{htmlString:"",errorsString:"Parsing error"}}});const M=new class{_translations=new Map;constructor(){}setTranslations(e){e.forEach((e=>this._translations.set(e.msgid,x.sanitizeToJsString(e.msgstr))))}getText(e,t){let o=this._translations.get(e);return t&&o&&Object.getOwnPropertyNames(t).forEach((e=>o=o.replace("{"+e+"}",t[e]))),o||e}};const P=new class{constructor(){}get UUID(){let e=new Uint8Array(16);const t=["","","","-","","-","","-","","-","","","","","",""];window.crypto.getRandomValues(e),e[6]=15&e[6]|64,e[8]=63&e[8]|128;let o="";for(let n=0;n<16;n++)o+=e[n].toString(m).padStart(2,"0")+t[n];return o}storageAvailable(e){try{let t=window[e],o="__storage_test__";return t.setItem(o,o),t.removeItem(o),!0}catch(e){return!1}}openFile(e,t){let o=document.createElement("input");o.type="file",t&&(o.accept=t),o.addEventListener("change",e,!1),o.click()}saveFile(e,t,o){try{let n=null;n=o?window.URL.createObjectURL(new File([t],e,{type:o})):URL.createObjectURL(t);let a=document.createElement("a");a.setAttribute("href",n),a.setAttribute("download",e),a.click(),window.URL.revokeObjectURL(n)}catch(e){e instanceof Error&&console.error(e)}}formatTime(e){let t=Math.floor(e);if(0===t)return"";let o=Math.floor(t/86400),n=Math.floor(t%86400/3600),a=Math.floor(t%3600/60),s=Math.floor(t%60);return 0<o?o+"Â "+M.getText("Utilities - Day")+"Â "+n+"Â "+M.getText("Utilities - Hour"):0<n?n+"Â "+M.getText("Utilities - Hour")+"Â "+a+"Â "+M.getText("Utilities - Minute"):0<a?a+"Â "+M.getText("Utilities - Minute"):s+"Â "+M.getText("Utilities - Second")}formatDistance(e){let t=Math.floor(e);return 0>=t?"0Â km":Math.floor(t/n.metersInKm)+","+Math.floor(t%n.metersInKm/10).toFixed(0).padStart(2,"0").padEnd(3,"0")+"Â km"}formatLat(e){return e>0?e.toFixed(r.fixed)+"Â N":(-e).toFixed(r.fixed)+"Â S"}formatLng(e){return e>0?e.toFixed(r.fixed)+"Â E":(-e).toFixed(r.fixed)+"Â W"}formatLatLng(e){return 0===e[0]&&0===e[1]?"":this.formatLat(e[0])+"Â -Â "+this.formatLng(e[1])}},C=new E("WayPoint");class j{_objId=_;_upgradeObject(e){switch(e.objType.version){case"1.0.0":case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":case"1.5.0":case"1.6.0":case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":e.address=e.name,e.name="";case"1.12.0":case"1.13.0":case"2.0.0":case"2.1.0":case"2.2.0":e.objType.version="2.3.0";break;default:throw new Error("invalid version for "+C.name)}}_validateObject(e){if(!Object.getOwnPropertyNames(e).includes("objType"))throw new Error("No objType for "+C.name);C.validate(e.objType),C.version!==e.objType.version&&this._upgradeObject(e);let t=Object.getOwnPropertyNames(e);return["address","name","lat","lng","objId"].forEach((e=>{if(!t.includes(e))throw new Error("No "+e+" for "+C.name)})),e}constructor(){this.name="",this.address="",this.lat=r.defaultValue,this.lng=r.defaultValue,this._objId=L.nextObjId}get fullName(){let e=""===this.name?this.address:this.name+", "+this.address;return""===e&&(e=P.formatLatLng([this.lat,this.lng])),e}get latLng(){return[this.lat,this.lng]}set latLng(e){this.lat=e[0],this.lng=e[1]}get objId(){return this._objId}get objType(){return C}get jsonObject(){return{name:this.name,address:this.address,lat:parseFloat(this.lat.toFixed(r.fixed)),lng:parseFloat(this.lng.toFixed(r.fixed)),objId:this._objId,objType:C.jsonObject}}set jsonObject(e){let t=this._validateObject(e);this.address=t.address||"",this.name=t.name||"",this.lat=t.lat||r.defaultValue,this.lng=t.lng||r.defaultValue,this._objId=L.nextObjId,this.validateData()}validateData(){"string"==typeof this.address?this.address=x.sanitizeToJsString(this.address):this.address="","string"==typeof this.name?this.name=x.sanitizeToJsString(this.name):this.name="","number"!=typeof this.lat&&(this.lat=r.defaultValue),"number"!=typeof this.lng&&(this.lng=r.defaultValue)}}const A=new E("ItineraryPoint");class S{_objId=_;_upgradeObject(e){switch(e.objType.version){case"1.0.0":case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":case"1.5.0":case"1.6.0":e.elev=i.defaultValue;case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":case"1.12.0":case"1.13.0":case"2.0.0":case"2.1.0":case"2.2.0":e.objType.version="2.3.0";break;default:throw new Error("invalid version for "+A.name)}}_validateObject(e){if(!Object.getOwnPropertyNames(e).includes("objType"))throw new Error("No objType for "+A.name);A.validate(e.objType),A.version!==e.objType.version&&this._upgradeObject(e);let t=Object.getOwnPropertyNames(e);return["lat","lng","distance","elev","objId"].forEach((e=>{if(!t.includes(e))throw new Error("No "+e+" for "+A.name)})),e}constructor(){this.lat=r.defaultValue,this.lng=r.defaultValue,this.distance=n.defaultValue,this.elev=i.defaultValue,this._objId=L.nextObjId}get latLng(){return[this.lat,this.lng]}set latLng(e){this.lat=e[0],this.lng=e[1]}get objType(){return A}get objId(){return this._objId}get jsonObject(){return{lat:parseFloat(this.lat.toFixed(r.fixed)),lng:parseFloat(this.lng.toFixed(r.fixed)),distance:parseFloat(this.distance.toFixed(n.fixed)),elev:parseFloat(this.elev.toFixed(i.fixed)),objId:this._objId,objType:A.jsonObject}}set jsonObject(e){let t=this._validateObject(e);this.lat=t.lat||r.defaultValue,this.lng=t.lng||r.defaultValue,this.distance=t.distance||n.defaultValue,this.elev=t.elev||i.defaultValue,this._objId=L.nextObjId,this.validateData()}validateData(){"number"!=typeof this.lat&&(this.lat=r.defaultValue),"number"!=typeof this.lng&&(this.lng=r.defaultValue),"number"!=typeof this.distance&&(this.distance=n.defaultValue),"number"!=typeof this.elev&&(this.elev=i.defaultValue)}}const O=new E("Maneuver");class k{_objId=_;_upgradeObject(e){switch(e.objType.version){case"1.0.0":case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":case"1.5.0":case"1.6.0":case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":"kArriveDefault"===e.iconName&&(e.distance=n.defaultValue);case"1.12.0":case"1.13.0":case"2.0.0":case"2.1.0":case"2.2.0":e.objType.version="2.3.0";break;default:throw new Error("invalid version for "+O.name)}}_validateObject(e){if(!Object.getOwnPropertyNames(e).includes("objType"))throw new Error("No objType for "+O.name);O.validate(e.objType),O.version!==e.objType.version&&this._upgradeObject(e);let t=Object.getOwnPropertyNames(e);return["iconName","instruction","distance","duration","itineraryPointObjId","objId"].forEach((e=>{if(!t.includes(e))throw new Error("No "+e+" for "+O.name)})),e}constructor(){this.iconName="",this.instruction="",this.itineraryPointObjId=_,this.distance=n.defaultValue,this.duration=n.defaultValue,this._objId=L.nextObjId}get objType(){return O}get objId(){return this._objId}get jsonObject(){return{iconName:this.iconName,instruction:this.instruction,distance:parseFloat(this.distance.toFixed(n.fixed)),duration:this.duration,itineraryPointObjId:this.itineraryPointObjId,objId:this._objId,objType:O.jsonObject}}set jsonObject(e){let t=this._validateObject(e);this.iconName=t.iconName||"",this.instruction=t.instruction||"",this.distance=t.distance||n.defaultValue,this.duration=t.duration||n.defaultValue,this.itineraryPointObjId=t.itineraryPointObjId||_,this._objId=L.nextObjId,this.validateData()}validateData(){"string"==typeof this.iconName?this.iconName=x.sanitizeToJsString(this.iconName):this.iconName="","string"==typeof this.instruction?this.instruction=x.sanitizeToJsString(this.instruction):this.instruction="","number"!=typeof this.distance&&(this.distance=n.defaultValue),"number"!=typeof this.duration&&(this.duration=n.defaultValue),"number"!=typeof this.itineraryPointObjId&&(this.itineraryPointObjId=_)}}const R=new E("Itinerary");class H{_objId=_;_upgradeObject(e){switch(e.objType.version){case"1.0.0":case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":case"1.5.0":case"1.6.0":e.hasProfile=!1,e.ascent=0,e.descent=0;case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":case"1.12.0":case"1.13.0":case"2.0.0":case"2.1.0":case"2.2.0":e.objType.version="2.3.0";break;default:throw new Error("invalid version for "+R.name)}}_validateObject(e){if(!Object.getOwnPropertyNames(e).includes("objType"))throw new Error("No objType for "+R.name);R.validate(e.objType),R.version!==e.objType.version&&this._upgradeObject(e);let t=Object.getOwnPropertyNames(e);return["hasProfile","ascent","descent","itineraryPoints","maneuvers","provider","transitMode","objId"].forEach((e=>{if(!t.includes(e))throw new Error("No "+e+" for "+R.name)})),e}constructor(){this.hasProfile=!1,this.ascent=0,this.descent=0,this.provider="",this.transitMode="",this.itineraryPoints=new N(S),this.maneuvers=new N(k),this._objId=L.nextObjId}get objType(){return R}get objId(){return this._objId}get jsonObject(){return{hasProfile:this.hasProfile,ascent:this.ascent,descent:this.descent,itineraryPoints:this.itineraryPoints.jsonObject,maneuvers:this.maneuvers.jsonObject,provider:this.provider,transitMode:this.transitMode,objId:this._objId,objType:R.jsonObject}}set jsonObject(e){let t=this._validateObject(e);this.hasProfile=t.hasProfile||!1,this.ascent=t.ascent||0,this.descent=t.descent||0,this.itineraryPoints.jsonObject=t.itineraryPoints||[],this.maneuvers.jsonObject=t.maneuvers||[],this.provider=t.provider||"",this.transitMode=t.transitMode||"",this._objId=L.nextObjId;let o=new Map,n=0,a=this.itineraryPoints.iterator;for(;!a.done;)o.set(t.itineraryPoints[n].objId,a.value.objId),n++;let s=this.maneuvers.iterator;for(;!s.done;)s.value.itineraryPointObjId=o.get(s.value.itineraryPointObjId);this.validateData()}validateData(){"boolean"!=typeof this.hasProfile&&(this.hasProfile=!1),"number"!=typeof this.ascent&&(this.ascent=0),"number"!=typeof this.descent&&(this.descent=0),"string"==typeof this.provider?this.provider=x.sanitizeToJsString(this.provider):this.provider="","string"==typeof this.transitMode?this.transitMode=x.sanitizeToJsString(this.transitMode):this.transitMode=""}}const B=new E("Note");class U{_objId=_;_UpdateStyles(e){return e.replaceAll(/style='color:white;background-color:red'/g,"class='TravelNotes-Note-WhiteRed'").replaceAll(/style='color:white;background-color:green'/g,"class='TravelNotes-Note-WhiteGreen'").replaceAll(/style='color:white;background-color:blue'/g,"class='TravelNotes-Note-WhiteBlue'").replaceAll(/style='color:white;background-color:brown'/g,"class='TravelNotes-Note-WhiteBrown'").replaceAll(/style='color:white;background-color:black'/g,"class='TravelNotes-Note-WhiteBlack'").replaceAll(/style='border:solid 0.1em'/g,"class='TravelNotes-Note-BlackWhite'").replaceAll(/style='background-color:white;'/g,"class='TravelNotes-Note-Knooppunt'").replaceAll(/style='fill:green;font:bold 120px sans-serif;'/g,"").replaceAll(/style='fill:none;stroke:green;stroke-width:10;'/g,"")}_upgradeObject(e){switch(e.objType.version){case"1.0.0":case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":case"1.5.0":case"1.6.0":case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":case"1.12.0":case"1.13.0":"string"==typeof e.iconHeight&&(e.iconHeight=Number.parseInt(e.iconHeight)),"string"==typeof e.iconWidth&&(e.iconWidth=Number.parseInt(e.iconWidth)),e.iconContent=this._UpdateStyles(e.iconContent),e.popupContent=this._UpdateStyles(e.popupContent),e.tooltipContent=this._UpdateStyles(e.tooltipContent),e.phone=this._UpdateStyles(e.phone),e.address=this._UpdateStyles(e.address);case"2.0.0":case"2.1.0":case"2.2.0":e.objType.version="2.3.0";break;default:throw new Error("invalid version for "+B.name)}}_validateObject(e){if(!Object.getOwnPropertyNames(e).includes("objType"))throw new Error("No objType for "+B.name);B.validate(e.objType),B.version!==e.objType.version&&this._upgradeObject(e);let t=Object.getOwnPropertyNames(e);return["iconHeight","iconWidth","iconContent","popupContent","tooltipContent","phone","url","address","iconLat","iconLng","lat","lng","distance","chainedDistance","objId"].forEach((e=>{if(!t.includes(e))throw new Error("No "+e+" for "+B.name)})),e}constructor(){this.iconHeight=h.height,this.iconWidth=h.width,this.iconContent="",this.popupContent="",this.tooltipContent="",this.phone="",this.url="",this.address="",this.iconLat=r.defaultValue,this.iconLng=r.defaultValue,this.lat=r.defaultValue,this.lng=r.defaultValue,this.distance=n.invalid,this.chainedDistance=n.defaultValue,this._objId=L.nextObjId}get isRouteNote(){return this.distance!==n.invalid}get iconLatLng(){return[this.iconLat,this.iconLng]}set iconLatLng(e){this.iconLat=e[0],this.iconLng=e[1]}get latLng(){return[this.lat,this.lng]}set latLng(e){this.lat=e[0],this.lng=e[1]}get objType(){return B}get objId(){return this._objId}get jsonObject(){return{iconHeight:this.iconHeight,iconWidth:this.iconWidth,iconContent:this.iconContent,popupContent:this.popupContent,tooltipContent:this.tooltipContent,phone:this.phone,url:this.url,address:this.address,iconLat:parseFloat(this.iconLat.toFixed(r.fixed)),iconLng:parseFloat(this.iconLng.toFixed(r.fixed)),lat:parseFloat(this.lat.toFixed(r.fixed)),lng:parseFloat(this.lng.toFixed(r.fixed)),distance:parseFloat(this.distance.toFixed(n.fixed)),chainedDistance:parseFloat(this.chainedDistance.toFixed(n.fixed)),objId:this._objId,objType:B.jsonObject}}set jsonObject(e){let t=this._validateObject(e);this.iconHeight=t.iconHeight||h.height,this.iconWidth=t.iconWidth||h.width,this.iconContent=t.iconContent||"",this.popupContent=t.popupContent||"",this.tooltipContent=t.tooltipContent||"",this.phone=t.phone||"",this.url=t.url||"",this.address=t.address||"",this.iconLat=t.iconLat||r.defaultValue,this.iconLng=t.iconLng||r.defaultValue,this.lat=t.lat||r.defaultValue,this.lng=t.lng||r.defaultValue,this.distance=t.distance||n.invalid,this.chainedDistance=t.chainedDistance||n.defaultValue,this._objId=L.nextObjId,this.validateData(!0)}validateData(e){if("number"!=typeof this.iconHeight&&(this.iconHeight=h.height),"number"!=typeof this.iconWidth&&(this.iconWidth=h.width),"string"==typeof this.iconContent){let t=x.sanitizeToHtmlString(this.iconContent);e&&""!==t.errorsString&&console.log(t.errorsString+" ("+this.iconContent+")"),this.iconContent=t.htmlString}else this.iconContent="";if("string"==typeof this.popupContent){let t=x.sanitizeToHtmlString(this.popupContent);e&&""!==t.errorsString&&console.log(t.errorsString+" ("+this.popupContent+")"),this.popupContent=t.htmlString}else this.popupContent="";if("string"==typeof this.tooltipContent){let t=x.sanitizeToHtmlString(this.tooltipContent);e&&""!==t.errorsString&&console.log(t.errorsString+" ("+this.tooltipContent+")"),this.tooltipContent=t.htmlString}else this.tooltipContent="";if("string"==typeof this.phone){let t=x.sanitizeToHtmlString(this.phone);e&&""!==t.errorsString&&console.log(t.errorsString+" ("+this.phone+")"),this.phone=t.htmlString}else this.phone="";if("string"==typeof this.url&&""!==this.url){let t=x.sanitizeToUrl(this.url);e&&""!==t.errorsString&&console.log(t.errorsString+" ("+this.url+")"),this.url=encodeURI(t.url)}else this.url="";"string"==typeof this.address?this.address=x.sanitizeToHtmlString(this.address).htmlString:this.address="","number"!=typeof this.iconLat&&(this.iconLat=r.defaultValue),"number"!=typeof this.iconLng&&(this.iconLng=r.defaultValue),"number"!=typeof this.lat&&(this.lat=r.defaultValue),"number"!=typeof this.lng&&(this.lng=r.defaultValue),"number"!=typeof this.distance&&(this.distance=n.invalid),"number"!=typeof this.chainedDistance&&(this.chainedDistance=n.defaultValue)}}const K=new E("Route");class F{_objId=_;_upgradeObject(e){switch(e.objType.version){case"1.0.0":e.dashArray=0,e.hidden=!1;case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":e.edited=l.notEdited;case"1.5.0":case"1.6.0":case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":e.editionStatus=e.edited;case"1.12.0":case"1.13.0":case"2.0.0":case"2.1.0":case"2.2.0":e.objType.version="2.3.0";break;default:throw new Error("invalid version for "+K.name)}}_validateObject(e){if(!Object.getOwnPropertyNames(e).includes("objType"))throw new Error("No objType for "+K.name);K.validate(e.objType),K.version!==e.objType.version&&this._upgradeObject(e);let t=Object.getOwnPropertyNames(e);return["name","wayPoints","notes","itinerary","width","color","dashArray","chain","distance","duration","editionStatus","hidden","chainedDistance","objId"].forEach((e=>{if(!t.includes(e))throw new Error("No "+e+" for "+K.name)})),e}constructor(){this.name="",this.wayPoints=new N(j),this.wayPoints.add(new j),this.wayPoints.add(new j),this.notes=new N(U),this.itinerary=new H,this.width=e.route.width,this.color=e.route.color,this.dashArray=e.route.dashArray,this.chain=!0,this.chainedDistance=n.defaultValue,this.distance=n.defaultValue,this.duration=n.defaultValue,this.editionStatus=l.notEdited,this.hidden=!1,this._objId=L.nextObjId}get computedName(){let e=this.name;return""===e&&(e=(""===this.wayPoints.first.fullName?"???":this.wayPoints.first.fullName)+" â®ž "+(""===this.wayPoints.last.fullName?"???":this.wayPoints.last.fullName)),e}get objId(){return this._objId}get objType(){return K}haveValidWayPoints(){let e=!0;return this.wayPoints.forEach((t=>{e=e&&r.defaultValue!==t.lat&&r.defaultValue!==t.lng})),e}get jsonObject(){return{name:this.name,wayPoints:this.wayPoints.jsonObject,notes:this.notes.jsonObject,itinerary:this.itinerary.jsonObject,width:this.width,color:this.color,dashArray:this.dashArray,chain:this.chain,distance:parseFloat(this.distance.toFixed(n.fixed)),duration:this.duration,editionStatus:this.editionStatus,hidden:this.hidden,chainedDistance:parseFloat(this.chainedDistance.toFixed(n.fixed)),objId:this._objId,objType:K.jsonObject}}set jsonObject(t){let o=this._validateObject(t);this.name=o.name||"",this.wayPoints.jsonObject=o.wayPoints||[],this.notes.jsonObject=o.notes||[],this.itinerary.jsonObject=o.itinerary||(new H).jsonObject,this.width=o.width||e.route.width,this.color=o.color||"#000000",this.dashArray=o.dashArray||0,this.chain=o.chain||!1,this.distance=o.distance,this.duration=o.duration,this.editionStatus=o.editionStatus||l.notEdited,this.hidden=o.hidden||!1,this.chainedDistance=o.chainedDistance,this._objId=L.nextObjId,this.validateData()}validateData(){"string"==typeof this.name?this.name=x.sanitizeToJsString(this.name):this.name="","number"!=typeof this.width&&(this.width=e.route.width),"string"==typeof this.color?this.color=x.sanitizeToColor(this.color)||e.route.color:this.color=e.route.color,"number"!=typeof this.dashArray&&(this.dashArray=0),this.dashArray>=e.route.dashChoices.length&&(this.dashArray=0),"boolean"!=typeof this.chain&&(this.chain=!1),"number"!=typeof this.distance&&(this.distance=n.defaultValue),"number"!=typeof this.duration&&(this.duration=n.defaultValue),"number"!=typeof this.editionStatus&&(this.editionStatus=l.notEdited),"boolean"!=typeof this.hidden&&(this.hidden=!1),"number"!=typeof this.chainedDistance&&(this.chainedDistance=n.defaultValue)}}const V=new E("Travel");class W{_objId=_;_upgradeObject(e){switch(e.objType.version){case"1.0.0":case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":e.editedRoute=new F;case"1.5.0":if(e.userData.layerId){let t=[{layerId:"0",layerName:"OSM - Color"},{layerId:"1",layerName:"OSM - Black and White"},{layerId:"2",layerName:"Thunderforest - Transport"},{layerId:"3",layerName:"Thunderforest - OpenCycleMap"},{layerId:"4",layerName:"Thunderforest - Outdoors"},{layerId:"5",layerName:"Esri - Aerial view"},{layerId:"6",layerName:"Kartverket - Norway"},{layerId:"7",layerName:"IGN-NGI - Belgium now"},{layerId:"12",layerName:"Thunderforest - Landscape"},{layerId:"24",layerName:"LantmÃ¤teriet - Sweden"},{layerId:"25",layerName:"Maanmittauslaitos - Finland"}].find((t=>t.layerId===e.userData.layerId));e.layerName=t?t.layerName:"OSM - Color"}else e.layerName="OSM - Color";case"1.6.0":case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":case"1.12.0":case"1.13.0":case"2.0.0":case"2.1.0":case"2.2.0":e.objType.version="2.3.0";break;default:throw new Error("invalid version for "+V.name)}}_validateObject(e){if(!Object.getOwnPropertyNames(e).includes("objType"))throw new Error("No objType for "+V.name);V.validate(e.objType),V.version!==e.objType.version&&this._upgradeObject(e);let t=Object.getOwnPropertyNames(e);return["name","editedRoute","routes","objId"].forEach((e=>{if(!t.includes(e))throw new Error("No "+e+" for "+V.name)})),e}constructor(){this.editedRoute=new F,this.routes=new N(F),this.notes=new N(U),this.layerName="OSM - Color",this.name="",this.readOnly=!1,this._objId=L.nextObjId}get objId(){return this._objId}get objType(){return V}get jsonObject(){return{editedRoute:this.editedRoute.jsonObject,layerName:this.layerName,name:this.name,routes:this.routes.jsonObject,notes:this.notes.jsonObject,readOnly:this.readOnly,objId:this._objId,objType:V.jsonObject}}set jsonObject(e){let t=this._validateObject(e);this.editedRoute.jsonObject=t.editedRoute,this.layerName=e.layerName||"OSM - Color",this.name=t.name||"",this.readOnly=t.readOnly||!1,this.routes.jsonObject=t.routes||[],this.notes.jsonObject=t.notes||[],this._objId=L.nextObjId,this.validateData()}validateData(){"string"==typeof this.layerName?this.layerName=x.sanitizeToJsString(this.layerName):this.layerName="OSM - Color","string"==typeof this.name?this.name=x.sanitizeToJsString(this.name):this.name="TravelNotes","boolean"!=typeof this.readOnly&&(this.readOnly=!0)}}const z=new class{_providers=new Map;_mapObjects=new Map;_routing=Object.seal({provider:"",transitMode:""});_UUID=P.UUID;constructor(){this.map=null,this.travel=new W,this.editedRouteObjId=_,this.searchData=[]}get providers(){return this._providers}get mapObjects(){return this._mapObjects}get routing(){return this._routing}get UUID(){return this._UUID}};const G=new class{constructor(){}getLatLngElevAtDist(e,t){if(e.distance<=t||0>=t)return null;let o=0,n=e.itinerary.itineraryPoints.iterator;for(;o<t&&!n.done;)o+=n.value.distance;let a=n.value;n.done;let s=(a.distance-o+t)/a.distance;return Object.freeze({latLng:[a.lat+(n.value.lat-a.lat)*s,a.lng+(n.value.lng-a.lng)*s],elev:a.elev+(n.value.elev-a.elev)*s,ascent:100*(n.value.elev-a.elev)/a.distance,routeDistance:t})}getClosestLatLngDistance(e,t){if(0===e.itinerary.itineraryPoints.length)return null;let o=e.itinerary.itineraryPoints.iterator;o.done;let a=Number.MAX_VALUE,s=window.L.Projection.SphericalMercator.project(window.L.latLng(t[0],t[1])),i=window.L.Projection.SphericalMercator.project(window.L.latLng(o.value.lat,o.value.lng)),r=null,l=n.defaultValue,d=o.value.distance;for(;!o.done;){let e=window.L.Projection.SphericalMercator.project(window.L.latLng(o.value.lat,o.value.lng)),t=window.L.LineUtil.pointToSegmentDistance(s,i,e);t<a&&(a=t,r=window.L.Projection.SphericalMercator.unproject(window.L.LineUtil.closestPointOnSegment(s,i,e)),l=d-r.distanceTo(window.L.latLng(o.value.lat,o.value.lng))),d+=o.value.distance,i=e}return Object.freeze({latLng:[r.lat,r.lng],distance:l})}getLatLngBounds(e){let t=window.L.latLng([r.maxLat,r.maxLng]),o=window.L.latLng([r.minLat,r.minLng]);return e.forEach((e=>{t.lat=Math.min(t.lat,e[0]),t.lng=Math.min(t.lng,e[1]),o.lat=Math.max(o.lat,e[0]),o.lng=Math.max(o.lng,e[1])})),window.L.latLngBounds(t,o)}getSquareBoundingBox(e,t){let o=t/b*c.fromRadians,n=e[0]*c.toRadians,a=Math.acos((Math.cos(t/b)-Math.sin(n)**2)/Math.cos(n)**2)*c.fromRadians;return window.L.latLngBounds(window.L.latLng([e[0]-o,e[1]-a]),window.L.latLng([e[0]+o,e[1]+a]))}project(e,t){let o=z.map.project(window.L.latLng(e),t);return[o.x,o.y]}screenCoordToLatLng(e,t){let o=z.map.containerPointToLatLng(window.L.point(e,t));return[o.lat,o.lng]}addPoints(e,t){return[e[0]+t[0],e[1]+t[1]]}subtrackPoints(e,t){return[e[0]-t[0],e[1]-t[1]]}};const X=new class{_normalizeLng(e){return(e+c.d540)%c.d360-c.d180}constructor(){}arcFromSummitArcArc(e,t,o){return Math.acos(Math.cos(t)*Math.cos(o)+Math.sin(t)*Math.sin(o)*Math.cos(e))}summitFromArcArcArc(e,t,o){return Math.acos((Math.cos(o)-Math.cos(e)*Math.cos(t))/(Math.sin(e)*Math.sin(t)))}pointsDistance(e,t){if(e[0]===t[0]&&e[1]===t[1])return 0;let o=e[0]*c.toRadians,n=t[0]*c.toRadians,a=(this._normalizeLng(t[1])-this._normalizeLng(e[1]))*c.toRadians;return Math.acos(Math.sin(o)*Math.sin(n)+Math.cos(o)*Math.cos(n)*Math.cos(a))*b}};const Z=new class{_setNearestRouteData(e,t,o){if(e.objId!==z.editedRouteObjId){let n=G.getClosestLatLngDistance(e,t);if(n){let a=X.pointsDistance(t,n.latLng);a<o.distance&&(o.route=e,o.distance=a,o.latLngOnRoute=n.latLng,o.distanceOnRoute=n.distance)}}}constructor(){}getNearestRouteData(e){let t={distance:Number.MAX_VALUE,route:null,distanceOnRoute:0,latLngOnRoute:[r.defaultValue,r.defaultValue]};return z.travel.routes.forEach((o=>this._setNearestRouteData(o,e,t))),_!==z.editedRouteObjId&&this._setNearestRouteData(z.travel.editedRoute,e,t),Object.freeze(t)}getRoute(e){let t=null;return t=z.travel.routes.getAt(e),t||e===z.travel.editedRoute.objId&&(t=z.travel.editedRoute),t}getNoteAndRoute(e){let t=null,o=null;if(t=z.travel.notes.getAt(e),!t){let n=z.travel.routes.iterator;for(;!n.done&&!t;)t=n.value.notes.getAt(e),t&&(o=n.value);t||(t=z.travel.editedRoute.notes.getAt(e),t&&(o=z.travel.editedRoute))}return Object.freeze({note:t,route:o})}getWayPoint(e){let t=z.travel.editedRoute.wayPoints.getAt(e);if(!t){let o=z.travel.routes.iterator;for(;!o.done&&!t;)t=o.value.wayPoints.getAt(e)}return t}};
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file HTMLElementsFactory.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/const Y=new class{_addProperties(e,t){for(let o in t)try{if("dataset"===o){let o=t.dataset;for(let t in o)e.dataset["tan"+t]=o[t]}else e[o]=t[o]}catch(e){e instanceof Error&&console.error(e)}e.target&&(e.rel="noopener noreferrer")}constructor(){}create(e,t,o){let n=null;return"text"===e.toLowerCase()?n=document.createTextNode(t.value||""):(n="select"===e.toLowerCase()?document.createElement(e):Object.seal(document.createElement(e)),t&&this._addProperties(n,t)),o&&o.appendChild(n),n}};class J{_baseDialog=null;constructor(e){this._baseDialog=e}destructor(){this._baseDialog=null}handleEvent(){this._baseDialog.onOk()}}class q{_baseDialog=null;constructor(e){this._baseDialog=e}destructor(){this._baseDialog=null}handleEvent(){this._baseDialog.onCancel()}}class Q{_dragData=null;constructor(e){this._dragData=e}destructor(){this._dragData=null}handleEvent(e){this._dragData.dragStartX=e.screenX,this._dragData.dragStartY=e.screenY,e.dataTransfer.dropEffect="move",e.dataTransfer.effectAllowed="move"}}class ${_dragData=null;_containerDiv=null;_backgroundDiv=null;constructor(e,t,o){this._dragData=e,this._containerDiv=t,this._backgroundDiv=o}destructor(){this._dragData=null,this._containerDiv=null,this._backgroundDiv=null}handleEvent(e){this._dragData.dialogX+=e.screenX-this._dragData.dragStartX,this._dragData.dialogX=Math.min(Math.max(this._dragData.dialogX,w),this._backgroundDiv.clientWidth-this._containerDiv.clientWidth-w),this._dragData.dialogY+=e.screenY-this._dragData.dragStartY,this._dragData.dialogY=Math.max(this._dragData.dialogY,w);let t=this._backgroundDiv.clientHeight-Math.max(this._dragData.dialogY,0)-w;this._containerDiv.style.left=String(this._dragData.dialogX)+"px",this._containerDiv.style.top=String(this._dragData.dialogY)+"px",this._containerDiv.style["max-height"]=String(t)+"px"}}class ee{_baseDialog=null;constructor(e){this._baseDialog=e}destructor(){this._baseDialog=null}handleEvent(e){this._baseDialog.keyboardELEnabled&&("Escape"===e.key||"Esc"===e.key?this._baseDialog.onCancel():"Enter"===e.key&&this._baseDialog.onOk())}}class te{_mapCenter=[r.defaultValue,r.defaultValue];constructor(){}handleEvent(e){if("start"===e.action)return void(this._mapCenter=z.map.getCenter());let t=G.screenCoordToLatLng(e.startX,e.startY),o=G.screenCoordToLatLng(e.endX,e.endY);z.map.panTo([this._mapCenter.lat+t[0]-o[0],this._mapCenter.lng+t[1]-o[1]])}}class oe{_initialZoom=0;_startPoint=null;constructor(){}handleEvent(e){if("start"===e.action)return this._initialZoom=z.map.getZoom(),void(this._startPoint=window.L.point(e.clientX,e.clientY));let t=Math.floor(this._initialZoom+(e.startY-e.endY)/50);t=Math.min(z.map.getMaxZoom(),t),t=Math.max(z.map.getMinZoom(),t),z.map.setZoomAround(this._startPoint,t)}}class ne{constructor(){}handleEvent(e){if("TravelNotes-Background"!==e.target.id)return;let t=z.map.getZoom()+(0>e.deltaY?1:-1);t=Math.min(z.map.getMaxZoom(),t),t=Math.max(z.map.getMinZoom(),t),z.map.setZoomAround(window.L.point(e.clientX,e.clientY),t)}}class ae{constructor(){}handleEvent(e){e.preventDefault()}}class se{constructor(){}handleEvent(e){e.preventDefault()}}class ie{_panOngoing=!1;_startPanX=0;_startPanY=0;_target=null;_button=0;_eventType="";_dispatchEvent(e,t){let o=new Event(this._eventType);o.startX=this._startPanX,o.startY=this._startPanY,o.endX=e.screenX,o.endY=e.screenY,o.clientX=e.clientX,o.clientY=e.clientY,o.action=t,this._target.dispatchEvent(o)}constructor(e,t){switch(this._target=e,this._button=t,t){case 0:this._eventType="leftpan";break;case 1:this._eventType="middlepan";break;case 2:this._eventType="rightpan";break;default:this._button=p}}handleEvent(e){switch(e.type){case"mousedown":e.button===this._button&&e.target===this._target&&(this._startPanX=e.screenX,this._startPanY=e.screenY,this._panOngoing=!0,this._dispatchEvent(e,"start"));break;case"mouseup":e.button!==this._button||!this._panOngoing||this._startPanX===e.screenX&&this._startPanY===e.screenY||this._dispatchEvent(e,"end"),this._panOngoing=!1;break;case"mousemove":this._panOngoing&&(document.selection?document.selection.empty():window.getSelection().removeAllRanges(),this._dispatchEvent(e,"move"))}}}class re{static get LEFT_BUTTON(){return 0}static get MIDDLE_BUTTON(){return 1}static get RIGHT_BUTTON(){return 2}_target=null;_eventListener=null;constructor(e,t=0){this._target=e,this._eventListener=new ie(e,t),this._target.addEventListener("mousedown",this._eventListener),this._target.addEventListener("mouseup",this._eventListener),this._target.addEventListener("mousemove",this._eventListener)}detach(){this._target.removeEventListener("mousedown",this._eventListener),this._target.removeEventListener("mouseup",this._eventListener),this._target.removeEventListener("mousemove",this._eventListener),this._eventListener=null,this._target=null}}class le{_backgroundDiv={};_containerDiv={};_errorDiv={};_waitDiv={};_okButton={};_cancelButton={};_topBar={};_secondButton=null;_leftPanEventDispatcher=null;_rightPanEventDispatcher=null;_keyboardELEnabled=!0;_dragData=Object.seal({dragStartX:0,dragStartY:0,dialogX:0,dialogY:0});_eventListeners={onKeydown:null,onTopBarDragStart:null,onTopBarDragEnd:null,onCancelButtonClick:null,onOkButtonClick:null,onLeftPan:null,onRightPan:null,onWheel:null,onContextMenu:null,onDragOver:null};_options=null;_onPromiseOkFct=null;_onPromiseErrorFct=null;_createBackgroundDiv(){this._backgroundDiv=Y.create("div",{id:"TravelNotes-Background",className:"TravelNotes-Background"}),this._leftPanEventDispatcher=new re(this._backgroundDiv,re.LEFT_BUTTON),this._rightPanEventDispatcher=new re(this._backgroundDiv,re.RIGHT_BUTTON),this._eventListeners.onLeftPan=new te,this._backgroundDiv.addEventListener("leftpan",this._eventListeners.onLeftPan,!1),this._eventListeners.onRightPan=new oe,this._backgroundDiv.addEventListener("rightpan",this._eventListeners.onRightPan,!1),this._eventListeners.onDragOver=new se,this._backgroundDiv.addEventListener("dragover",this._eventListeners.onDragOver,!1),this._eventListeners.onWheel=new ne,this._backgroundDiv.addEventListener("wheel",this._eventListeners.onWheel,!1),this._eventListeners.onContextMenu=new ae,this._backgroundDiv.addEventListener("contextmenu",this._eventListeners.onContextMenu,!1)}_createContainerDiv(){this._containerDiv=Y.create("div",{className:"TravelNotes-BaseDialog-Container"},this._backgroundDiv)}_createTopBar(){this._topBar=Y.create("div",{className:"TravelNotes-BaseDialog-TopBar",draggable:!0},this._containerDiv),this._eventListeners.onTopBarDragStart=new Q(this._dragData),this._eventListeners.onTopBarDragEnd=new $(this._dragData,this._containerDiv,this._backgroundDiv),this._topBar.addEventListener("dragstart",this._eventListeners.onTopBarDragStart,!1),this._topBar.addEventListener("dragend",this._eventListeners.onTopBarDragEnd,!1),this._eventListeners.onCancelButtonClick=new q(this),this._cancelButton=Y.create("div",{textContent:"âŒ",className:"TravelNotes-BaseDialog-CancelButton",title:M.getText("BaseDialog - Cancel")},this._topBar),this._cancelButton.addEventListener("click",this._eventListeners.onCancelButtonClick,!1)}_createHeaderDiv(){Y.create("text",{value:this.title},Y.create("div",{className:"TravelNotes-BaseDialog-HeaderDiv"},this._containerDiv))}_createContentDiv(){let e=Y.create("div",{className:"TravelNotes-BaseDialog-ContentDiv"},this._containerDiv);this.contentHTMLElements.forEach((t=>e.appendChild(t)))}_createErrorDiv(){this._errorDiv=Y.create("div",{className:"TravelNotes-BaseDialog-ErrorDiv TravelNotes-Hidden"},this._containerDiv)}_createWaitDiv(){Y.create("div",{className:"TravelNotes-WaitAnimationBullet"},Y.create("div",{className:"TravelNotes-WaitAnimation"},this._waitDiv=Y.create("div",{className:"TravelNotes-BaseDialog-WaitDiv  TravelNotes-Hidden"},this._containerDiv)))}_createFooterDiv(){let e=Y.create("div",{className:"TravelNotes-BaseDialog-FooterDiv"},this._containerDiv);this._okButton=Y.create("div",{textContent:this._options.firstButtonText||"ðŸ†—",className:"TravelNotes-BaseDialog-Button"},e),this._eventListeners.onOkButtonClick=new J(this),this._okButton.addEventListener("click",this._eventListeners.onOkButtonClick,!1),this._options.secondButtonText&&(this._secondButton=Y.create("div",{textContent:this._options.secondButtonText,className:"TravelNotes-BaseDialog-Button"},e),this._secondButton.addEventListener("click",this._eventListeners.onCancelButtonClick,!1)),this.footerHTMLElements.forEach((t=>e.appendChild(t)))}_createHTML(){this._createBackgroundDiv(),this._createContainerDiv(),this._createTopBar(),this._createHeaderDiv(),this._createContentDiv(),this._createErrorDiv(),this._createWaitDiv(),this._createFooterDiv()}_centerDialog(){this._dragData.dialogX=(this._backgroundDiv.clientWidth-this._containerDiv.clientWidth)/2,this._dragData.dialogY=(this._backgroundDiv.clientHeight-this._containerDiv.clientHeight)/2,this._dragData.dialogX=Math.min(Math.max(this._dragData.dialogX,w),this._backgroundDiv.clientWidth-this._containerDiv.clientWidth-w),this._dragData.dialogY=Math.max(this._dragData.dialogY,w);let e=this._backgroundDiv.clientHeight-Math.max(this._dragData.dialogY,0)-w;this._containerDiv.style.left=String(this._dragData.dialogX)+"px",this._containerDiv.style.top=String(this._dragData.dialogY)+"px",this._containerDiv.style["max-height"]=String(e)+"px"}_show(e,t){this._onPromiseOkFct=e,this._onPromiseErrorFct=t,this._createHTML(),document.body.appendChild(this._backgroundDiv),this._centerDialog(),document.addEventListener("keydown",this._eventListeners.onKeydown,{capture:!0}),this.onShow()}constructor(e={}){this._options=e,this._eventListeners.onKeydown=new ee(this),this._keyboardELEnabled=!0}_BaseDialogDestructor(){this._backgroundDiv.removeEventListener("dragover",this._eventListeners.onDragOver,!1),this._backgroundDiv.removeEventListener("leftpan",this._eventListeners.onLeftPan,!1),this._backgroundDiv.removeEventListener("rightpan",this._eventListeners.onRightPan,!1),this._backgroundDiv.removeEventListener("wheel",this._eventListeners.onWheel,!1),this._backgroundDiv.removeEventListener("contextmenu",this._eventListeners.onContextMenu,!1),document.removeEventListener("keydown",this._eventListeners.onKeydown,{capture:!0}),this._topBar.removeEventListener("dragstart",this._eventListeners.onTopBarDragStart,!1),this._topBar.removeEventListener("dragend",this._eventListeners.onTopBarDragEnd,!1),this._cancelButton.removeEventListener("click",this._eventListeners.onCancelButtonClick,!1),this._okButton.removeEventListener("click",this._eventListeners.onOkButtonClick,!1),this._options.secondButtonText&&this._secondButton.removeEventListener("click",this._eventListeners.onCancelButtonClick,!1),document.removeEventListener("keydown",this._eventListeners.onKeydown,{capture:!0}),this._eventListeners.onKeydown.destructor(),this._eventListeners.onTopBarDragStart.destructor(),this._eventListeners.onTopBarDragEnd.destructor(),this._eventListeners.onCancelButtonClick.destructor(),this._eventListeners.onOkButtonClick.destructor(),this._leftPanEventDispatcher.detach(),this._rightPanEventDispatcher.detach(),document.body.removeChild(this._backgroundDiv)}onCancel(){this._BaseDialogDestructor(),this._onPromiseErrorFct("Canceled by user")}canClose(){return!0}onOk(e){return!!this.canClose()&&(this._BaseDialogDestructor(),this._onPromiseOkFct(e),!0)}onShow(){}get title(){return""}get contentHTMLElements(){return[]}get footerHTMLElements(){return[]}show(){return new Promise(((e,t)=>this._show(e,t)))}showWait(){this._waitDiv.classList.remove("TravelNotes-Hidden"),this._okButton.classList.add("TravelNotes-Hidden")}hideWait(){this._waitDiv.classList.add("TravelNotes-Hidden"),this._okButton.classList.remove("TravelNotes-Hidden")}showError(e){this._errorDiv.textContent="",x.sanitizeToHtmlElement(e,this._errorDiv),this._errorDiv.classList.remove("TravelNotes-Hidden")}hideError(){this._errorDiv.textContent="",this._errorDiv.classList.add("TravelNotes-Hidden")}get keyboardELEnabled(){return this._keyboardELEnabled}set keyboardELEnabled(e){this._keyboardELEnabled=e}}
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file PasswordDialogEventListeners.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/class de{_passwordInput=null;constructor(e){this._passwordInput=e}destructor(){this._passwordInput=null}handleEvent(e){e.stopPropagation,this._passwordInput.type="text"}}class he{_passwordInput=null;constructor(e){this._passwordInput=e}destructor(){this._passwordInput=null}handleEvent(e){e.stopPropagation,this._passwordInput.type="password",this._passwordInput.focus()}}class ce extends le{_passwordDiv=null;_passwordInput=null;_eyeSpan=null;_verifyPassword=!1;_onMouseDownEyeEventListener=null;_onMouseUpEyeEventListener=null;constructor(e){super(),this._verifyPassword=e,this._passwordDiv=Y.create("div",{id:"TravelNotes-PasswordDialog-PasswordDiv"}),this._passwordInput=Y.create("input",{type:"password"},this._passwordDiv),this._onMouseDownEyeEventListener=new de(this._passwordInput),this._onMouseUpEyeEventListener=new he(this._passwordInput),this._eyeSpan=Y.create("span",{id:"TravelNotes-PasswordDialog-EyeSpan",textContent:"ðŸ‘ï¸"},this._passwordDiv),this._eyeSpan.addEventListener("mousedown",this._onMouseDownEyeEventListener,!1),this._eyeSpan.addEventListener("mouseup",this._onMouseUpEyeEventListener,!1)}_destructor(){this._eyeSpan.removeEventListener("mousedown",this._onMouseDownEyeEventListener,!1),this._eyeSpan.removeEventListener("mouseup",this._onMouseUpEyeEventListener,!1),this._onMouseDownEyeEventListener.destructor(),this._onMouseUpEyeEventListener.destructor()}canClose(){return this.hideError(),!(this._verifyPassword&&(this._passwordInput.value.length<12||!this._passwordInput.value.match(/[0-9]+/)||!this._passwordInput.value.match(/[a-z]+/)||!this._passwordInput.value.match(/[A-Z]+/)||!this._passwordInput.value.match(/[^0-9a-zA-Z]/)))||(this.showError("<p>"+M.getText("PasswordDialog - Password rules1")+"</p><ul><li>"+M.getText("PasswordDialog - Password rules2")+"</li><li>"+M.getText("PasswordDialog - Password rules3")+"</li><li>"+M.getText("PasswordDialog - Password rules4")+"</li><li>"+M.getText("PasswordDialog - Password rules5")+"</li><li>"+M.getText("PasswordDialog - Password rules6")+"</li></ul>"),this._passwordInput.focus(),!1)}onCancel(){this._destructor(),super.onCancel()}onOk(){this._destructor(),super.onOk((new window.TextEncoder).encode(this._passwordInput.value))}onShow(){this._passwordInput.focus()}get contentHTMLElements(){return[this._passwordDiv]}get title(){return M.getText("PasswordDialog - password")}}
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file DataEncryptor.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/class ue{_salt=null;_importKey(e){return window.crypto.subtle.importKey("raw",e,{name:"PBKDF2"},!1,["deriveKey"])}_deriveKey(e,t){return window.crypto.subtle.deriveKey({name:"PBKDF2",salt:(new window.TextEncoder).encode(t),iterations:1e6,hash:"SHA-256"},e,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}_decrypt(e,t){return window.crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(t.slice(0,16))},e,new Uint8Array(t.slice(16)))}_encrypt(e,t,o){return window.crypto.subtle.encrypt({name:"AES-GCM",iv:t},e,o)}constructor(e){this._salt=e||"Tire la chevillette la bobinette cherra. Le Petit Chaperon rouge tira la chevillette."}encryptData(e,t,o,n){let a=window.crypto.getRandomValues(new Uint8Array(16));n.then(this._importKey).then((e=>this._deriveKey(e,this._salt))).then((t=>this._encrypt(t,a,e))).then((e=>{t(new Blob([a,new Uint8Array(e)],{type:"application/octet-stream"}))})).catch(o)}decryptData(e,t,o,n){n.then(this._importKey).then((e=>this._deriveKey(e,this._salt))).then((t=>this._decrypt(t,e))).then(t).catch(o)}}class ve{constructor(){}handleEvent(e){e.stopPropagation();let t=new Event("apikeydeleted");t.data={objId:Number.parseInt(e.target.dataset.tanObjId)},e.target.parentNode.parentNode.dispatchEvent(t)}}class _e{_rootHTMLElement=null;_providerNameInput=null;_providerKeyInput=null;_objId=_;constructor(t){this._objId=L.nextObjId,this._rootHTMLElement=Y.create("div",{className:"TravelNotes-APIKeysDialog-ApiKeyRow"}),this._providerNameInput=Y.create("input",{className:"TravelNotes-APIKeysDialog-ApiKeyName TravelNotes-APIKeysDialog-Input",value:t.providerName,placeholder:M.getText("APIKeysDialog - provider name")},this._rootHTMLElement),this._providerKeyInput=Y.create("input",{className:"TravelNotes-APIKeysDialog-ApiKeyValue TravelNotes-APIKeysDialog-Input",value:t.providerKey,placeholder:M.getText("APIKeysDialog - API key"),type:e.APIKeysDialog.showAPIKeys?"text":"password"},this._rootHTMLElement),Y.create("div",{className:"TravelNotes-BaseDialog-Button TravelNotes-APIKeysDialog-AtRightButton TravelNotes-APIKeysDialog-DeleteRowButton",title:M.getText("APIKeysDialog - delete API key"),textContent:"âŒ",dataset:{ObjId:this._objId}},this._rootHTMLElement).addEventListener("click",new ve,!1)}get objId(){return this._objId}get HTMLElements(){return[this._rootHTMLElement]}get providerName(){return this._providerNameInput.value}get providerKey(){return this._providerKeyInput.value}get APIKey(){return Object.seal({providerName:this._providerNameInput.value,providerKey:this._providerKeyInput.value})}}class pe{_APIKeysDialog=null;constructor(e){this._APIKeysDialog=e}destructor(){this._APIKeysDialog=null}onErrorDecrypt(e){this._APIKeysDialog.hideWait(),this._APIKeysDialog.keyboardELEnabled=!0,e&&"Canceled by user"!==e&&this._APIKeysDialog.showError(M.getText("APIKeysDialog - An error occurs when reading the file"))}onOkDecrypt(e){try{this._APIKeysDialog.addAPIKeys(JSON.parse((new TextDecoder).decode(e)))}catch(e){return void this.onErrorDecrypt(e)}this._APIKeysDialog.hideWait(),this._APIKeysDialog.hideError(),this._APIKeysDialog.keyboardELEnabled=!0}onOkEncrypt(e){this._APIKeysDialog.hideError(),this._APIKeysDialog.hideWait(),P.saveFile("APIKeys",e),this._APIKeysDialog.keyboardELEnabled=!0}onErrorEncrypt(){this._APIKeysDialog.showError(M.getText("APIKeysDialog - An error occurs when saving the keys")),this._APIKeysDialog.hideWait(),this._APIKeysDialog.keyboardELEnabled=!0}}class me{_APIKeysControls=null;constructor(e){this._APIKeysControls=e}destructor(){this._APIKeysControls=null}getAPIKeysJsonString(){let e=[];return this._APIKeysControls.forEach((t=>{e.push(t.APIKey)})),JSON.stringify(e)}}class ge{_APIKeysDialog=null;_APIKeysControls=null;constructor(e,t){this._APIKeysDialog=e,this._APIKeysControls=t}destructor(){this._APIKeysDialog=null,this._APIKeysControls=null}handleEvent(e){e.stopPropagation(),this._APIKeysControls.delete(e.data.objId),this._APIKeysDialog.refreshAPIKeys()}}class ye{_APIKeysDialog=null;constructor(e){this._APIKeysDialog=e}destructor(){this._APIKeysDialog=null}handleEvent(e){e.stopPropagation();let t=new FileReader;t.onload=()=>{try{this._APIKeysDialog.addAPIKeys(JSON.parse(t.result))}catch(e){this._APIKeysDialog.showError(e.message),e instanceof Error&&console.error(e)}},t.readAsText(e.target.files[0])}}class be{_APIKeysDialog=null;_openUnsecureFileInputEventListener=null;constructor(e){this._APIKeysDialog=e,this._openUnsecureFileInputEventListener=new ye(this._APIKeysDialog)}destructor(){this._APIKeysDialog=null,this._openUnsecureFileInputEventListener.destructor()}handleEvent(e){e.stopPropagation(),this._APIKeysDialog.hideError(),P.openFile(this._openUnsecureFileInputEventListener,".json")}}class Ie{_APIKeysDialog=null;_dataEncryptorHandlers=null;constructor(e){this._APIKeysDialog=e,this._dataEncryptorHandlers=new pe(this._APIKeysDialog)}destructor(){this._APIKeysDialog=null,this._dataEncryptorHandlers.destructor()}handleEvent(e){e.stopPropagation(),this._APIKeysDialog.hideError(),this._APIKeysDialog.showWait(),this._APIKeysDialog.keyboardELEnabled=!1,fetch(window.location.href.substr(0,window.location.href.lastIndexOf("/")+1)+"APIKeys").then((e=>{g===e.status&&e.ok?e.arrayBuffer().then((e=>{(new ue).decryptData(e,(e=>{this._dataEncryptorHandlers.onOkDecrypt(e)}),(e=>{this._dataEncryptorHandlers.onErrorDecrypt(e)}),new ce(!1).show())})):this._dataEncryptorHandlers.onErrorDecrypt(new Error("Invalid http status"))})).catch((e=>{this._dataEncryptorHandlers.onErrorDecrypt(e),e instanceof Error&&console.error(e)}))}}class we{_APIKeysDialog=null;_dataEncryptorHandlers=null;constructor(e){this._APIKeysDialog=e,this._dataEncryptorHandlers=new pe(this._APIKeysDialog)}destructor(){this._APIKeysDialog=null,this._dataEncryptorHandlers.destructor()}handleEvent(e){e.stopPropagation(),this._APIKeysDialog.showWait(),this._APIKeysDialog.keyboardELEnabled=!1;let t=new FileReader;t.onload=()=>{(new ue).decryptData(t.result,(e=>{this._dataEncryptorHandlers.onOkDecrypt(e)}),(e=>{this._dataEncryptorHandlers.onErrorDecrypt(e)}),new ce(!1).show())},t.readAsArrayBuffer(e.target.files[0])}}class Le{_APIKeysDialog=null;_openSecureFileInputEventListener=null;constructor(e){this._APIKeysDialog=e,this._openSecureFileInputEventListener=new we(this._APIKeysDialog)}destructor(){this._APIKeysDialog=null,this._openSecureFileInputEventListener.destructor()}handleEvent(e){e.stopPropagation(),this._APIKeysDialog.hideError(),P.openFile(this._openSecureFileInputEventListener)}}class Te{_APIKeysDialog=null;_APIKeysControls=null;_saveAPIKeysHelper=null;_dataEncryptorHandlers=null;constructor(e,t){this._APIKeysDialog=e,this._APIKeysControls=t,this._saveAPIKeysHelper=new me(this._APIKeysControls),this._dataEncryptorHandlers=new pe(this._APIKeysDialog)}destructor(){this._APIKeysDialog=null,this._APIKeysControls=null,this._saveAPIKeysHelper.destructor(),this._dataEncryptorHandlers.destructor()}handleEvent(e){e.stopPropagation(),this._APIKeysDialog.validateAPIKeys()&&(this._APIKeysDialog.showWait(),this._APIKeysDialog.keyboardELEnabled=!1,(new ue).encryptData((new window.TextEncoder).encode(this._saveAPIKeysHelper.getAPIKeysJsonString()),(e=>this._dataEncryptorHandlers.onOkEncrypt(e)),(()=>this._dataEncryptorHandlers.onErrorEncrypt()),new ce(!0).show()))}}class De{_APIKeysDialog=null;_APIKeysControls=null;_saveAPIKeysHelper=null;constructor(e,t){this._APIKeysDialog=e,this._APIKeysControls=t,this._saveAPIKeysHelper=new me(this._APIKeysControls)}destructor(){this._APIKeysDialog=null,this._APIKeysControls=null,this._saveAPIKeysHelper.destructor()}handleEvent(e){e.stopPropagation(),this._APIKeysDialog.validateAPIKeys()&&P.saveFile("APIKeys.json",this._saveAPIKeysHelper.getAPIKeysJsonString(),"application/json")}}class Ee{_APIKeysDialog=null;_APIKeysControls=null;constructor(e,t){this._APIKeysDialog=e,this._APIKeysControls=t}destructor(){this._APIKeysDialog=null,this._APIKeysControls=null}handleEvent(e){e.stopPropagation();let t=Object.seal({providerName:"",providerKey:""}),o=new _e(t);this._APIKeysControls.set(o.objId,o),this._APIKeysDialog.refreshAPIKeys()}}class fe{_APIKeysDialog=null;_APIKeysControls=null;_haveAPIKeysFile=!1;_rootHTMLElement=null;_reloadKeysFromServerButton=null;_saveKeysToSecureFileButton=null;_restoreKeysFromSecureFileButton=null;_newAPIKeyButton=null;_saveKeysToUnsecureFileButton=null;_restoreKeysFromUnsecureFileButton=null;_reloadKeysFromServerButtonEventListener=null;_saveKeysToSecureFileButtonEventListener=null;_restoreKeysFromSecureFileButtonEventListener=null;_newAPIKeyButtonEventListener=null;_saveKeysToUnsecureFileButtonEventListener=null;_restoreKeysFromUnsecureFileButtonEventListener=null;_createReloadKeysFromServerButton(){this._reloadKeysFromServerButton=Y.create("div",{className:"TravelNotes-BaseDialog-Button",title:M.getText("APIKeysDialog - Reload from server"),textContent:"ðŸ”„"},this._rootHTMLElement),this._reloadKeysFromServerButtonEventListener=new Ie(this._APIKeysDialog),this._reloadKeysFromServerButton.addEventListener("click",this._reloadKeysFromServerButtonEventListener,!1)}_createSaveKeysToSecureFileButton(){this._saveKeysToSecureFileButton=Y.create("div",{className:"TravelNotes-BaseDialog-Button",title:M.getText("APIKeysDialog - Save to file"),textContent:"ðŸ’¾"},this._rootHTMLElement),this._saveKeysToSecureFileButtonEventListener=new Te(this._APIKeysDialog,this._APIKeysControls),this._saveKeysToSecureFileButton.addEventListener("click",this._saveKeysToSecureFileButtonEventListener,!1)}_createRestoreKeysFromSecureFileButton(){this._restoreKeysFromSecureFileButton=Y.create("div",{className:"TravelNotes-BaseDialog-Button",title:M.getText("APIKeysDialog - Open file"),textContent:"ðŸ“‚"},this._rootHTMLElement),this._restoreKeysFromSecureFileButtonEventListener=new Le(this._APIKeysDialog),this._restoreKeysFromSecureFileButton.addEventListener("click",this._restoreKeysFromSecureFileButtonEventListener,!1)}_createNewAPIKeyButton(){this._newAPIKeyButton=Y.create("div",{className:"TravelNotes-BaseDialog-Button",title:M.getText("APIKeysDialog - new API key"),textContent:"+"},this._rootHTMLElement),this._newAPIKeyButtonEventListener=new Ee(this._APIKeysDialog,this._APIKeysControls),this._newAPIKeyButton.addEventListener("click",this._newAPIKeyButtonEventListener,!1)}_createSaveKeysToUnsecureFileButton(){this._saveKeysToUnsecureFileButton=Y.create("div",{className:"TravelNotes-BaseDialog-Button TravelNotes-APIKeysDialog-AtRightButton",title:M.getText("APIKeysDialog - Save to json file"),textContent:"ðŸ’¾"},this._rootHTMLElement),this._saveKeysToUnsecureFileButtonEventListener=new De(this._APIKeysDialog,this._APIKeysControls),this._saveKeysToUnsecureFileButton.addEventListener("click",this._saveKeysToUnsecureFileButtonEventListener,!1)}_createRestoreKeysFromUnsecureFileButton(){this._restoreKeysFromUnsecureFileButton=Y.create("div",{className:"TravelNotes-BaseDialog-Button",title:M.getText("APIKeysDialog - Open json file"),textContent:"ðŸ“‚"},this._rootHTMLElement),this._restoreKeysFromUnsecureFileButtonEventListener=new be(this._APIKeysDialog),this._restoreKeysFromUnsecureFileButton.addEventListener("click",this._restoreKeysFromUnsecureFileButtonEventListener,!1)}_addToolbarButtons(){window.crypto&&window.crypto.subtle&&window.crypto.subtle.importKey&&window.isSecureContext&&(this._haveAPIKeysFile&&this._createReloadKeysFromServerButton(),this._createSaveKeysToSecureFileButton(),this._createRestoreKeysFromSecureFileButton()),this._createNewAPIKeyButton(),e.APIKeysDialog.haveUnsecureButtons&&(this._createSaveKeysToUnsecureFileButton(),this._createRestoreKeysFromUnsecureFileButton())}constructor(e,t,o){this._APIKeysDialog=e,this._APIKeysControls=t,this._haveAPIKeysFile=o,this._rootHTMLElement=Y.create("div",{id:"TravelNotes-APIKeysDialog-ToolbarDiv"}),this._addToolbarButtons()}destructor(){this._reloadKeysFromServerButton&&(this._reloadKeysFromServerButton.removeEventListener("click",this._reloadKeysFromServerButtonEventListener,!1),this._reloadKeysFromServerButtonEventListener.destructor()),this._saveKeysToSecureFileButton&&(this._saveKeysToSecureFileButton.removeEventListener("click",this._saveKeysToSecureFileButtonEventListener,!1),this._saveKeysToSecureFileButtonEventListener.destructor()),this._restoreKeysFromSecureFileButton&&(this._restoreKeysFromSecureFileButton.removeEventListener("click",this._restoreKeysFromSecureFileButtonEventListener,!1),this._restoreKeysFromSecureFileButtonEventListener.destructor()),this._newAPIKeyButton&&(this._newAPIKeyButton.removeEventListener("click",this._newAPIKeyButtonEventListener,!1),this._newAPIKeyButtonEventListener.destructor()),this._saveKeysToUnsecureFileButton&&(this._saveKeysToUnsecureFileButton.removeEventListener("click",this._saveKeysToUnsecureFileButtonEventListener,!1),this._saveKeysToUnsecureFileButtonEventListener.destructor()),this._restoreKeysFromUnsecureFileButton&&(this._restoreKeysFromUnsecureFileButton.removeEventListener("click",this._restoreKeysFromUnsecureFileButtonEventListener,!1),this._restoreKeysFromUnsecureFileButtonEventListener.destructor())}get rootHTMLElement(){return this._rootHTMLElement}}class Ne extends le{_APIKeysControls=new Map;_toolbar=null;_APIKeysControlsContainer=null;_onAPIKeyDeletedEventListener=null;_createAPIKeysControlsContainer(){this._APIKeysControlsContainer=Y.create("div"),this._onAPIKeyDeletedEventListener=new ge(this,this._APIKeysControls),this._APIKeysControlsContainer.addEventListener("apikeydeleted",this._onAPIKeyDeletedEventListener,!1)}constructor(e,t){super(),this._toolbar=new fe(this,this._APIKeysControls,t),this._createAPIKeysControlsContainer(),this.addAPIKeys(e)}_destructor(){this._toolbar.destructor(),this._APIKeysControlsContainer.removeEventListener("apikeydeleted",this._onAPIKeyDeletedEventListener,!1),this._onAPIKeyDeletedEventListener.destructor()}validateAPIKeys(){this.hideError();let e=!1,t=[];this._APIKeysControls.forEach((o=>{e=e||""===o.providerName||""===o.providerKey,t.push(o.providerName)}));let o=!1;return t.forEach((e=>{o=o||t.indexOf(e)!==t.lastIndexOf(e)})),e?(this.showError(M.getText("APIKeysDialog - empty API key name or value")),!1):!o||(this.showError(M.getText("APIKeysDialog - duplicate API key name found")),!1)}addAPIKeys(e){this._APIKeysControls.clear(),e.forEach((e=>{let t=new _e(e);this._APIKeysControls.set(t.objId,t)})),this.refreshAPIKeys()}refreshAPIKeys(){for(;this._APIKeysControlsContainer.firstChild;)this._APIKeysControlsContainer.removeChild(this._APIKeysControlsContainer.firstChild);this._APIKeysControls.forEach((e=>{this._APIKeysControlsContainer.appendChild(e.HTMLElements[0])}))}canClose(){return this.validateAPIKeys()}onCancel(){this._destructor(),super.onCancel()}onOk(){let e=[];this._APIKeysControls.forEach((t=>e.push(t.APIKey))),super.onOk(e)&&this._destructor()}get title(){return M.getText("APIKeysDialog - API keys")}get contentHTMLElements(){return[this._toolbar.rootHTMLElement,this._APIKeysControlsContainer]}}
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file EventDispatcher.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/const xe=new class{constructor(){}dispatch(e,t){let o=new Event(e);t&&(o.data=t),document.dispatchEvent(o)}};const Me=new class{_mainHTMLElement=null;_messageHTMLElement=null;_timerId=null;_showHelpInput=null;_showHelpHTMLElement=null;_showHelp=e.errorsUI.showHelp;_onHelpInputChange(){this._showHelp=!this._showHelpInput.checked}_hide(){this._timerId&&(clearTimeout(this._timerId),this._timerId=null),this._mainHTMLElement.classList.remove("TravelNotes-ErrorsUI-Error"),this._mainHTMLElement.classList.remove("TravelNotes-ErrorsUI-Warning"),this._mainHTMLElement.classList.remove("TravelNotes-ErrorsUI-Info"),this._mainHTMLElement.classList.remove("TravelNotes-ErrorsUI-Help"),this._mainHTMLElement.classList.add("TravelNotes-Hidden"),this._showHelpHTMLElement.classList.add("TravelNotes-Hidden"),this._messageHTMLElement.textContent=""}_show(t,o){if("Error"===o&&!e.errorsUI.showError||"Warning"===o&&!e.errorsUI.showWarning||"Info"===o&&!e.errorsUI.showInfo||"Help"===o&&!e.errorsUI.showHelp||"Help"===o&&!this._showHelp)return;this._timerId&&(clearTimeout(this._timerId),this._timerId=null),x.sanitizeToHtmlElement(t,this._messageHTMLElement),this._mainHTMLElement.classList.add("TravelNotes-ErrorsUI-"+o),this._mainHTMLElement.classList.remove("TravelNotes-Hidden");let n=e.errorsUI.timeOut;"Help"===o&&(this._showHelpHTMLElement.classList.remove("TravelNotes-Hidden"),n=e.errorsUI.helpTimeOut),this._timerId=setTimeout((()=>this._hide()),n)}constructor(){}createUI(){if(this._mainHTMLElement)return;this._mainHTMLElement=Y.create("div",{id:"TravelNotes-ErrorsUI",className:"TravelNotes-Hidden"},document.body);let e=Y.create("div",null,this._mainHTMLElement);Y.create("span",{id:"TravelNotes-ErrorsUI-CancelButton",textContent:"âŒ"},e).addEventListener("click",(()=>this._hide()),!1),this._messageHTMLElement=Y.create("div",{id:"TravelNotes-ErrorsUI-Message"},this._mainHTMLElement),this._showHelpHTMLElement=Y.create("div",{id:"TravelNotes-ErrorsUI-HelpInputDiv",className:"TravelNotes-Hidden"},this._mainHTMLElement),this._showHelpInput=Y.create("input",{id:"TravelNotes-ErrorsUI-HelpInput",type:"checkbox"},this._showHelpHTMLElement),this._showHelpInput.addEventListener("change",(()=>this._onHelpInputChange()),!1),Y.create("label",{id:"TravelNotes-ErrorsUI-HelpInputLabel",htmlFor:"TravelNotes-ErrorsUI-HelpInput",textContent:M.getText("ErrorUI - Dont show again")},this._showHelpHTMLElement)}showError(e){this._show(e,"Error")}showWarning(e){this._show(e,"Warning")}showInfo(e){this._show(e,"Info")}showHelp(e){this._show(e,"Help")}};const Pe=new class{_haveAPIKeysFile=!1;_APIKeysMap=new Map;_onOkDecryptServerFile(e){let t=JSON.parse((new TextDecoder).decode(e));this._resetAPIKeys(t)}_onErrorDecryptServerFile(e){e instanceof Error&&console.error(e),e&&"Canceled by user"!==e&&Me.showError(M.getText("APIKeysManager - An error occurs when reading the APIKeys file"))}_onServerFileFound(e){window.isSecureContext&&window.crypto&&window.crypto.subtle&&window.crypto.subtle.importKey&&(new ue).decryptData(e,(e=>this._onOkDecryptServerFile(e)),(e=>this._onErrorDecryptServerFile(e)),new ce(!1).show())}_getAPIKey(e){return this._APIKeysMap.get(e.toLowerCase())}_setAPIKey(e,t){this._APIKeysMap.set(e.toLowerCase(),t)}_setAPIKeysFromSessionStorage(){let e=0;for(let t=0;t<sessionStorage.length;t++){let o=sessionStorage.key(t);"ProviderKey"===o.substr(o.length-"ProviderKey".length)&&(this._setAPIKey(o.substr(0,o.length-"ProviderKey".length),atob(sessionStorage.getItem(o))),e++)}return z.providers.forEach((e=>{e.providerKey=this._getAPIKey(e.name)||""})),e}_resetAPIKeys(t){sessionStorage.clear(),this._APIKeysMap.clear();let o=P.storageAvailable("sessionStorage")&&e.APIKeys.saveToSessionStorage;t.forEach((e=>{o&&sessionStorage.setItem(e.providerName.toLowerCase()+"ProviderKey",btoa(e.providerKey)),this._setAPIKey(e.providerName,e.providerKey)})),z.providers.forEach((e=>{e.providerKey=this._getAPIKey(e.name)||""})),xe.dispatch("providersadded")}constructor(){}hasKey(e){return this._APIKeysMap.has(e.toLowerCase())}getUrl(e){if(e.providerKeyNeeded){let t=this._APIKeysMap.get(e.providerName.toLowerCase());return t?e.url.replace("{providerKey}",t):null}return e.url}setKeysFromServerFile(){let e=!1;0!==this._setAPIKeysFromSessionStorage()&&(xe.dispatch("providersadded"),e=!0),fetch(window.location.href.substr(0,window.location.href.lastIndexOf("/")+1)+"APIKeys").then((t=>{g===t.status&&t.ok&&(this._haveAPIKeysFile=!0,e||t.arrayBuffer().then((e=>this._onServerFileFound(e))))})).catch((e=>{e instanceof Error&&console.error(e)}))}setKeysFromDialog(){let e=[];this._APIKeysMap.forEach(((t,o)=>{e.push(Object.seal({providerName:o,providerKey:t}))})),e.sort(((e,t)=>e.providerName.localeCompare(t.providerName))),new Ne(e,this._haveAPIKeysFile).show().then((e=>this._resetAPIKeys(e))).catch((e=>{e instanceof Error&&console.error(e)}))}addProvider(e){let t=new e,o=t.name.toLowerCase(),n=this._getAPIKey(o);t.providerKeyNeeded&&!n&&P.storageAvailable("sessionStorage")&&(n=sessionStorage.getItem(o),n&&(n=atob(n))),t.providerKeyNeeded&&n&&(t.providerKey=n),z.providers.set(t.name.toLowerCase(),t)}},Ce=d.margin.toFixed(0),je=(d.margin+d.height).toFixed(0),Ae=(d.margin+d.width).toFixed(0),Se=d.margin.toFixed(0),Oe=(d.margin+d.width+d.xDeltaText).toFixed(0),ke=(d.margin-d.xDeltaText).toFixed(0),Re=d.margin+d.height+d.margin/2;class He{_route=null;_smoothDistance=0;_smoothPoints=e.route.elev.smoothPoints;_svg=null;_VScale=1;_HScale=1;_minElev=Number.MAX_VALUE;_maxElev=0;_deltaElev=0;_createTmpPoints(){let e=0,t=0,o=[],n=this._route.itinerary.itineraryPoints.iterator,a=0,s=n.done;for(o.push({distance:e,elev:n.value.elev}),a+=n.value.distance,s=n.done;!s;){for(e+=this._smoothDistance;e>=a&&!s;)a+=n.value.distance,s=n.done;if(!s){let s=(n.value.elev-n.previous.elev)/n.previous.distance;t=n.value.elev-(a-e)*s,o.push({distance:e,elev:t})}}return o.push({distance:a,elev:this._route.itinerary.itineraryPoints.last.elev}),o}_createSmoothPoints(){let e=this._createTmpPoints(),t=new Map,o=(e[this._smoothPoints].elev-e[0].elev)/this._smoothPoints,n=0;for(n=0;n<this._smoothPoints;n++)t.set(n*this._smoothDistance,{distance:n*this._smoothDistance,elev:e[0].elev+o*n});for(n=this._smoothPoints;n<e.length-this._smoothPoints;n++){let o=0;for(let t=n-this._smoothPoints;n+this._smoothPoints>=t;t++)o+=e[t].elev;t.set(e[n].distance,{distance:e[n].distance,elev:o/(2*this._smoothPoints+1)})}return n--,o=this._smoothDistance*(e[e.length-1].elev-e[e.length-1-this._smoothPoints].elev)/(e[e.length-1].distance-e[e.length-1-this._smoothPoints].distance),t.set(e[n].distance+this._smoothDistance,{distance:e[n].distance+this._smoothDistance,elev:e[n].elev+o}),t.set(e[n].distance+2*this._smoothDistance,{distance:e[n].distance+2*this._smoothDistance,elev:e[n].elev+2*o}),t}_createProfilePolyline(){let e="",t=0,o=0,n=0;this._route.itinerary.itineraryPoints.forEach((a=>{o=(d.margin+this._HScale*t).toFixed(0),n=(d.margin+this._VScale*(this._maxElev-a.elev)).toFixed(0),e+=o+","+n+" ",t+=a.distance}));let a=document.createElementNS(y,"polyline");a.setAttributeNS(null,"points",e),a.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-profilePolyline"),this._svg.appendChild(a)}_createFramePolyline(){let e=Ce+","+Se+" "+Ce+","+je+" "+Ae+","+je+" "+Ae+","+Se,t=document.createElementNS(y,"polyline");t.setAttributeNS(null,"points",e),t.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-framePolyline"),this._svg.appendChild(t)}_createDistanceTexts(){let e=Number.MAX_VALUE,t=0;d.hScales.forEach((o=>{let n=Math.abs(this._route.distance/8-o);n<e&&(e=n,t=o)}));let o=Math.ceil(this._route.chainedDistance/t)*t;for(;o<this._route.distance+this._route.chainedDistance;){let e=document.createElementNS(y,"text");e.appendChild(document.createTextNode(n.metersInKm<t||0<this._route.chainedDistance?o/n.metersInKm+" km":o+" m ")),e.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-distLegend"),e.setAttributeNS(null,"x",d.margin+(o-this._route.chainedDistance)*this._HScale),e.setAttributeNS(null,"y",Re),e.setAttributeNS(null,"text-anchor","start"),this._svg.appendChild(e),o+=t}}_createElevTexts(){let e=Number.MAX_VALUE,t=0;d.vScales.forEach((o=>{let n=Math.abs(this._deltaElev/4-o);n<e&&(e=n,t=o)}));let o=Math.ceil(this._minElev/t)*t;for(;o<this._maxElev;){let e=d.margin+(this._maxElev-o)*this._VScale,n=document.createElementNS(y,"text");n.appendChild(document.createTextNode(o.toFixed(0))),n.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-elevLegend"),n.setAttributeNS(null,"x",Oe),n.setAttributeNS(null,"y",e),n.setAttributeNS(null,"text-anchor","start"),this._svg.appendChild(n);let a=document.createElementNS(y,"text");a.appendChild(document.createTextNode(o.toFixed(0))),a.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-elevLegend"),a.setAttributeNS(null,"x",ke),a.setAttributeNS(null,"y",e),a.setAttributeNS(null,"text-anchor","end"),this._svg.appendChild(a),o+=t}}_createSvgElement(){this._svg=document.createElementNS(y,"svg"),this._svg.setAttributeNS(null,"viewBox","0 0 "+(d.width+2*d.margin)+" "+(d.height+2*d.margin)),this._svg.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile")}constructor(){}smooth(t){this._route=t;let o=this._route.itinerary.itineraryPoints.iterator,n=0,a=0;for(;!o.done;)n+=o.value.distance,a+=o.next?Math.abs(o.value.elev-o.next.elev):0;if(this._smoothDistance=10*Math.floor(e.route.elev.smoothCoefficient/(a/n)),n<=2*this._smoothPoints*this._smoothDistance)return;let s=this._createSmoothPoints();o=this._route.itinerary.itineraryPoints.iterator,o.done;let i=o.value.distance;for(;!o.done;){let e=s.get(Math.floor(i/this._smoothDistance)*this._smoothDistance),t=s.get(Math.ceil(i/this._smoothDistance)*this._smoothDistance);if(e&&t){let n=i-e.distance,a=(t.elev-e.elev)/(t.distance-e.distance);o.value.elev=e.elev+n*a}i+=o.value.distance}}createSvg(e){return this._route=e,this._minElev=Number.MAX_VALUE,this._maxElev=0,this._route.itinerary.itineraryPoints.forEach((e=>{this._maxElev=Math.max(this._maxElev,e.elev),this._minElev=Math.min(this._minElev,e.elev)})),this._deltaElev=this._maxElev-this._minElev,this._VScale=d.height/this._deltaElev,this._HScale=d.width/this._route.distance,this._createSvgElement(),this._createProfilePolyline(),this._createFramePolyline(),this._createElevTexts(),this._createDistanceTexts(),this._svg}}const Be=new class{constructor(){}getNoteTextAndIconHTML(t,o){let n=Y.create("div",{dataset:{ObjId:o.note.objId}}),a=Y.create("div",{className:t+(o.route?"Route-ManeuversAndNotes-IconCell":"Travel-Notes-IconCell")},n),s=1;x.sanitizeToHtmlElement(o.note.iconContent,a),"TravelNotes-Roadbook-"===t&&a.firstChild?("svg"===a.firstChild.tagName?(a.firstChild.setAttributeNS(null,"viewBox","0 0 "+h.svgViewboxDim+" "+h.svgViewboxDim),s=e.note.svgIcon.roadbookFactor):a.firstChild.classList.contains("TravelNotes-MapNoteCategory-0073")&&(s=e.note.svgIcon.roadbookFactor),a.setAttribute("tanwidth",String(o.note.iconWidth*s)+"px"),a.setAttribute("tanheight",String(o.note.iconWidth*s)+"px")):(a.style.width=String(o.note.iconWidth)+"px",a.style.height=String(o.note.iconHeight)+"px");let i=this.getNoteTextHTML(t,o);return i.className=t+(o.route?"Route-ManeuversAndNotes-Cell":"Travel-Notes-Cell"),n.appendChild(i),n}getNoteTextHTML(e,t){let o=t.note,n=Y.create("div");if(0!==o.tooltipContent.length&&x.sanitizeToHtmlElement(o.tooltipContent,Y.create("div",{className:e+"NoteHtml-TooltipContent"},n)),0!==o.popupContent.length&&x.sanitizeToHtmlElement(o.popupContent,Y.create("div",{className:e+"NoteHtml-PopupContent"},n)),0!==o.address.length&&x.sanitizeToHtmlElement("<span>"+M.getText("NoteHTMLViewsFactory - Address")+"</span>Â :Â "+o.address,Y.create("div",{className:e+"NoteHtml-Address"},n)),0!==o.url.length&&x.sanitizeToHtmlElement("<span>"+M.getText("NoteHTMLViewsFactory - Link")+"</span><a href="+o.url+' target="_blank" >'+o.url.substr(0,40)+"...</a>",Y.create("div",{className:e+"NoteHtml-Url"},n)),0!==o.phone.length){let t=o.phone;if(o.phone.match(/^\+[0-9, ,*,\u0023]*$/)){let e=o.phone.replaceAll(/\u0020/g,""),n=o.phone.replaceAll(/\u0020/g,"Â ");t=M.getText("NoteHTMLViewsFactory - Phone")+"Â :Â "+M.getText("NoteHTMLViewsFactory - call")+'<a target="_blank" href="tel:'+e+'" >'+n+"</a>"+M.getText("NoteHTMLViewsFactory - Send a sms to")+'<a target="_blank" href="sms:'+e+'" >'+n+"</a>"}else t=M.getText("NoteHTMLViewsFactory - Phone")+"Â :Â "+o.phone;x.sanitizeToHtmlElement(t,Y.create("div",{className:e+"NoteHtml-Phone"},n))}if(x.sanitizeToHtmlElement(P.formatLatLng(o.latLng),Y.create("div",{className:e+"NoteHtml-LatLng"},n)),t.route){t.route.chain&&x.sanitizeToHtmlElement("<span>"+M.getText("NoteHTMLViewsFactory - Distance from start of travel")+"</span>Â :Â "+P.formatDistance(o.chainedDistance+o.distance),Y.create("div",{className:e+"NoteHtml-Distance"},n)),x.sanitizeToHtmlElement("<span>"+M.getText("NoteHTMLViewsFactory - Distance from start of route")+"</span>Â :Â "+P.formatDistance(o.distance),Y.create("div",{className:e+"NoteHtml-Distance"},n));let a=t.route.notes.next(o.objId);if(a){let t=a.distance-o.distance;9<t&&x.sanitizeToHtmlElement("<span>"+M.getText("NoteHTMLViewsFactory - Next note after")+"</span>Â :Â "+P.formatDistance(t),Y.create("div",{className:e+"NoteHtml-NextDistance"},n))}}return n}getTravelNotesHTML(e){let t=Y.create("div",{className:e+"Travel-Notes"}),o=z.travel.notes.iterator;for(;!o.done;){let n=this.getNoteTextAndIconHTML(e,{note:o.value,route:null});n.className=e+"Travel-Notes-Row",t.appendChild(n)}return t}};const Ue=new class{_getManeuverHTML(e,t){let o=Y.create("div");Y.create("div",{className:e+"Route-ManeuversAndNotes-IconCell TravelNotes-ManeuverNote-"+t.maneuver.iconName},o);let a=Y.create("div",{className:e+"Route-ManeuversAndNotes-Cell"},o);return x.sanitizeToHtmlElement(t.maneuver.instruction,Y.create("div",null,a)),t.route.chain&&x.sanitizeToHtmlElement("<span>"+M.getText("RouteHTMLViewsFactory - Distance from start of travel")+"</span>Â :Â "+P.formatDistance(t.route.chainedDistance+t.maneuverDistance),Y.create("div",{className:e+"Route-Maneuver-Distance"},a)),x.sanitizeToHtmlElement("<span>"+M.getText("RouteHTMLViewsFactory - Distance from start of route")+"</span>Â :Â "+P.formatDistance(t.maneuverDistance),Y.create("div",{className:e+"Route-Maneuver-Distance"},a)),n.defaultValue<t.maneuver.distance&&x.sanitizeToHtmlElement("<span>"+M.getText("RouteHTMLViewsFactory - Next maneuver after")+"</span>Â :Â "+P.formatDistance(t.maneuver.distance),Y.create("div",{className:e+"Route-Maneuver-Distance"},a)),o}constructor(){}getRouteProfileHTML(e,t){let o=Y.create("div",{className:e+"RouteProfile"});return x.sanitizeToHtmlElement(M.getText("RouteHTMLViewsFactory - Profile"),o),o.appendChild((new He).createSvg(t)),o}getRouteManeuversAndNotesHTML(e,t,o){let n=[],a=t.notes.iterator;for(;!a.done;)n.push({data:a.value,distance:a.value.distance});let s=t.itinerary.maneuvers.iterator,i=0;for(;!s.done;)n.push({data:s.value,distance:i}),i+=s.value.distance;n.sort(((e,t)=>e.distance-t.distance));let r=Y.create("div",{className:e+"Route-ManeuversAndNotes"});return n.forEach((n=>{let a=null;"Note"===n.data.objType.name?(a=Be.getNoteTextAndIconHTML(e,{note:n.data,route:t}),a.className=e+"Route-Notes-Row"):(a=this._getManeuverHTML(e,{route:t,maneuver:n.data,maneuverDistance:n.distance}),a.className=e+"Route-Maneuvers-Row"),o&&(a.dataset.tanObjId=n.data.objId,a.dataset.tanMarkerObjId=L.nextObjId,a.dataset.tanObjType=n.data.objType.name),r.appendChild(a)})),r}getRouteHeaderHTML(e,t){let o=Y.create("div",{className:e+"Route-Header",id:"route"+t.objId});return x.sanitizeToHtmlElement(t.computedName,Y.create("div",{className:e+"Route-Header-Name"},o)),0!==t.distance&&x.sanitizeToHtmlElement("<span>"+M.getText("RouteHTMLViewsFactory - Route distance")+"</span>Â :Â "+P.formatDistance(t.distance),Y.create("div",{className:e+"Route-Header-Distance"},o)),z.travel.readOnly||"bike"===t.itinerary.transitMode||x.sanitizeToHtmlElement("<span>"+M.getText("RouteHTMLViewsFactory - Duration")+"</span>Â :Â "+P.formatTime(t.duration),Y.create("div",{className:e+"Route-Header-Duration"},o)),t.itinerary.hasProfile&&(x.sanitizeToHtmlElement("<span>"+M.getText("RouteHTMLViewsFactory - Ascent")+"</span>Â :Â "+String(t.itinerary.ascent.toFixed(0))+" m.",Y.create("div",{className:e+"Route-Header-Ascent"},o)),x.sanitizeToHtmlElement("<span>"+M.getText("RouteHTMLViewsFactory - Descent")+"</span>Â :Â "+String(t.itinerary.descent.toFixed(0))+" m.",Y.create("div",{className:e+"Route-Header-Descent"},o))),o}getRouteFooterHTML(e,t){let o="";""!==t.itinerary.provider&&""!==t.itinerary.transitMode&&(o=M.getText("RouteHTMLViewsFactory - Itinerary computed by {provider} and optimized for {transitMode}",{provider:t.itinerary.provider,transitMode:M.getText("RouteHTMLViewsFactory - TransitMode "+t.itinerary.transitMode)}));let n=Y.create("div",{className:e+"RouteFooter"});return x.sanitizeToHtmlElement(o,n),n}};
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file BaseContextMenuEventListeners.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/class Ke{_menuOperator=null;constructor(e){this._menuOperator=e}destructor(){this._menuOperator=null}handleEvent(e){e.stopPropagation(),this._menuOperator.onKeydownKeyboard(e.key)}}class Fe{_menuOperator=null;constructor(e){this._menuOperator=e}destructor(){this._menuOperator=null}handleEvent(e){e.stopPropagation(),this._menuOperator.onCancelMenu()}}class Ve{_menuOperator=null;constructor(e){this._menuOperator=e}destructor(){this._menuOperator=null}handleEvent(e){e.stopPropagation(),this._menuOperator.onMouseLeaveMenuItem(e.target)}}class We{_menuOperator=null;constructor(e){this._menuOperator=e}destructor(){this._menuOperator=null}handleEvent(e){e.stopPropagation(),this._menuOperator.onMouseEnterMenuItem(e.target)}}class ze{_menuOperator=null;constructor(e){this._menuOperator=e}destructor(){this._menuOperator=null}handleEvent(e){e.stopPropagation(),this._menuOperator.selectItem(Number.parseInt(e.target.dataset.tanObjId))}}class Ge{_menuOperator=null;constructor(e){this._menuOperator=e}destructor(){this._menuOperator=null}handleEvent(e){e.stopPropagation(),this._menuOperator.onMouseLeaveContainer()}}class Xe{_menuOperator=null;constructor(e){this._menuOperator=e}destructor(){this._menuOperator=null}handleEvent(e){e.stopPropagation(),this._menuOperator.onMouseEnterContainer()}}class Ze{_contextMenu=null;_eventListeners={onKeydownKeyboard:null,onMouseLeaveContainer:null,onMouseEnterContainer:null,onMouseClickCancelButton:null,onClickMenuItem:null,onMouseLeaveMenuItem:null,onMouseEnterMenuItem:null};_keyboardSelectedItem=p;_timerId=null;_unselectItems(){this._contextMenu.htmlElements.menuItemHTMLElements.forEach((e=>{e.classList.remove("TravelNotes-ContextMenu-ItemSelected")}))}_changeKeyboardSelectedItem(e){switch(this._unselectItems(),e){case p:case 1:this._keyboardSelectedItem+=e,p===this._keyboardSelectedItem&&(this._keyboardSelectedItem=this._contextMenu.htmlElements.menuItemHTMLElements.length-1),this._contextMenu.htmlElements.menuItemHTMLElements.length===this._keyboardSelectedItem&&(this._keyboardSelectedItem=0);break;case 0:this._keyboardSelectedItem=0;break;default:this._keyboardSelectedItem=this._contextMenu.htmlElements.menuItemHTMLElements.length-1}this._contextMenu.htmlElements.menuItemHTMLElements[this._keyboardSelectedItem].classList.add("TravelNotes-ContextMenu-ItemSelected")}constructor(e){this._contextMenu=e,this._eventListeners.onKeydownKeyboard=new Ke(this),this._eventListeners.onMouseLeaveContainer=new Ge(this),this._eventListeners.onMouseEnterContainer=new Xe(this),this._eventListeners.onMouseClickCancelButton=new Fe(this),this._eventListeners.onClickMenuItem=new ze(this),this._eventListeners.onMouseLeaveMenuItem=new Ve(this),this._eventListeners.onMouseEnterMenuItem=new We(this),document.addEventListener("keydown",this._eventListeners.onKeydownKeyboard,!0),this._contextMenu.htmlElements.container.addEventListener("mouseleave",this._eventListeners.onMouseLeaveContainer),this._contextMenu.htmlElements.container.addEventListener("mouseenter",this._eventListeners.onMouseEnterContainer),this._contextMenu.htmlElements.cancelButton.addEventListener("click",this._eventListeners.onMouseClickCancelButton),this._contextMenu.htmlElements.menuItemHTMLElements.forEach((e=>{e.addEventListener("click",this._eventListeners.onClickMenuItem),e.addEventListener("mouseleave",this._eventListeners.onMouseLeaveMenuItem),e.addEventListener("mouseenter",this._eventListeners.onMouseEnterMenuItem)}))}destructor(){this._timerId&&(clearTimeout(this._timerId),this._timerId=null),document.removeEventListener("keydown",this._eventListeners.onKeydownKeyboard,!0),this._contextMenu.htmlElements.container.removeEventListener("mouseleave",this._eventListeners.onMouseLeaveContainer),this._contextMenu.htmlElements.container.removeEventListener("mouseenter",this._eventListeners.onMouseEnterContainer),this._contextMenu.htmlElements.cancelButton.removeEventListener("click",this._eventListeners.onMouseClickCancelButton),this._contextMenu.htmlElements.menuItemHTMLElements.forEach((e=>{e.removeEventListener("click",this._eventListeners.onClickMenuItem),e.removeEventListener("mouseleave",this._eventListeners.onMouseLeaveMenuItem),e.removeEventListener("mouseenter",this._eventListeners.onMouseEnterMenuItem)}));for(const e in this._eventListeners)this._eventListeners[e].destructor();this._contextMenu.htmlElements.parentNode.removeChild(this._contextMenu.htmlElements.container),this._contextMenu=null}onMouseLeaveContainer(){this._timerId=setTimeout((()=>this.onCancelMenu()),e.contextMenu.timeout)}onMouseEnterContainer(){this._timerId&&(clearTimeout(this._timerId),this._timerId=null)}onKeydownKeyboard(e){switch(e){case"Escape":case"Esc":this.onCancelMenu();break;case"ArrowDown":case"ArrowRight":case"Tab":this._changeKeyboardSelectedItem(1);break;case"ArrowUp":case"ArrowLeft":this._changeKeyboardSelectedItem(p);break;case"Home":this._changeKeyboardSelectedItem(0);break;case"End":this._changeKeyboardSelectedItem(2);break;case"Enter":if(p===this._keyboardSelectedItem||this._contextMenu.htmlElements.menuItemHTMLElements[this._keyboardSelectedItem].classList.contains("TravelNotes-ContextMenu-ItemDisabled"))return;this._contextMenu.onOk(this._keyboardSelectedItem)}}onCancelMenu(){this._contextMenu.onCancel("Canceled by user")}selectItem(e){this._contextMenu.htmlElements.menuItemHTMLElements[e].classList.contains("TravelNotes-ContextMenu-ItemDisabled")||this._contextMenu.onOk(e)}onMouseLeaveMenuItem(e){e.classList.remove("TravelNotes-ContextMenu-ItemSelected")}onMouseEnterMenuItem(e){this._unselectItems(),this._keyboardSelectedItem=Number.parseInt(e.dataset.tanObjId),e.classList.add("TravelNotes-ContextMenu-ItemSelected")}}class Ye{static _currentMenu=null;_onPromiseOk=null;_onPromiseError=null;_htmlElements={parentNode:null,container:null,cancelButton:null,menuItemHTMLElements:[]};_eventData={clientX:0,clientY:0,lat:r.defaultValue,lng:r.defaultValue,targetObjId:_,haveParentNode:!1};_menuOperator=null;_createContainer(){this._htmlElements.container=Y.create("div",{className:"TravelNotes-ContextMenu-Container"},this._htmlElements.parentNode)}_createCancelButton(){this._htmlElements.cancelButton=Y.create("div",{textContent:"âŒ",className:"TravelNotes-ContextMenu-CloseButton",title:M.getText("ContextMenu - Close")},this._htmlElements.container)}_createMenuItemsHTMLElements(){let e=0;this.menuItems.forEach((t=>{let o=Y.create("div",{textContent:t.itemText,className:"TravelNotes-ContextMenu-Item",dataset:{ObjId:String(e++)}},this._htmlElements.container);t.isActive||o.classList.add("TravelNotes-ContextMenu-ItemDisabled"),this._htmlElements.menuItemHTMLElements.push(o)}))}_moveContainer(){let e=z.map.getContainer().clientWidth,t=z.map.getContainer().clientHeight,o=Math.min(this._eventData.clientY,t-this._htmlElements.container.clientHeight-20),n=Math.min(this._eventData.clientX,e-this._htmlElements.container.clientWidth-20);this._htmlElements.container.style.top=String(o)+"px",this._eventData.haveParentNode?this._htmlElements.container.style.right=String(20)+"px":this._htmlElements.container.style.left=String(n)+"px"}_createMenu(e,t){this._onPromiseOk=e,this._onPromiseError=t,this._createContainer(),this._createCancelButton(),this._createMenuItemsHTMLElements(),this._moveContainer(),this._menuOperator=new Ze(this)}constructor(e,t){Ye._currentMenu?Ye._currentMenu.onCancel():(this._eventData.clientX=e.clientX||e.originalEvent.clientX||0,this._eventData.clientY=e.clientY||e.originalEvent.clientY||0,this._eventData.lat=e.latlng?e.latlng.lat:r.defaultValue,this._eventData.lng=e.latlng?e.latlng.lng:r.defaultValue,e.target.objId?this._eventData.targetObjId=e.target.objId:e.currentTarget&&e.currentTarget.dataset&&e.currentTarget.dataset.tanObjId&&(this._eventData.targetObjId=Number.parseInt(e.currentTarget.dataset.tanObjId)),this._eventData.haveParentNode=null!==t,Object.freeze(this._eventData),this._htmlElements.parentNode=t||document.body,Ye._currentMenu=this)}onOk(e){this._menuOperator.destructor(),Ye._currentMenu=null,this._onPromiseOk(e)}onCancel(){this._menuOperator.destructor(),Ye._currentMenu=null,this._onPromiseError()}show(){Ye._currentMenu&&new Promise(((e,t)=>{this._createMenu(e,t)})).then((e=>this.doAction(e))).catch((e=>{e&&console.error(e)}))}get menuItems(){return[]}get htmlElements(){return this._htmlElements}get eventData(){return this._eventData}}const Je=new class{_editionButtons=[];_preDefinedIconsMap=new Map;_preDefinedIcons=[];constructor(){}get buttons(){return this._editionButtons}get icons(){return this._preDefinedIcons}getIconData(e){return this._preDefinedIcons[e][1]}getIconContentFromName(e){let t=this._preDefinedIconsMap.get(e);return t?t.icon:""}loadJson(e){e.editionButtons&&(this._editionButtons=this._editionButtons.concat(e.editionButtons)),e.preDefinedIconsList.forEach((e=>{e.name=x.sanitizeToJsString(e.name)||"?",e.icon=x.sanitizeToHtmlString(e.icon).htmlString||"?",e.tooltip=x.sanitizeToJsString(e.tooltip)||"?",e.width=e.width||h.width,e.height=e.height||h.height,this._preDefinedIconsMap.set(e.name,e)})),this._preDefinedIcons=Array.from(this._preDefinedIconsMap).sort(((e,t)=>e[0].localeCompare(t[0])))}};class qe{_route=null;_overpassAPIDataLoader=null;_MapIconData=null;_svgElement=null;_createSvg(){this._svgElement=document.createElementNS(y,"svg"),this._svgElement.setAttributeNS(null,"viewBox",String(h.svgViewboxDim/4)+" "+h.svgViewboxDim/4+" "+h.svgViewboxDim/2+" "+h.svgViewboxDim/2),this._svgElement.setAttributeNS(null,"class","TravelNotes-SvgIcon")}_createRoute(){let t=-1,o=p,n=p,a=[];if(this._route.itinerary.itineraryPoints.forEach((s=>{t++;let i=G.addPoints(G.project(s.latLng,e.note.svgIcon.zoom),this._MapIconData.translation);a.push(i),i[0]>=0&&i[1]>=0&&i[0]<=h.svgViewboxDim&&i[1]<=h.svgViewboxDim&&(p===o&&(o=t),n=t)})),p!==o&&p!==n){0<o&&o--,this._route.itinerary.itineraryPoints.length-1>n&&n++;let e="";for(t=o;t<=n;t++)e+=a[t][0].toFixed(0)+","+a[t][1].toFixed(0)+" ";let s=document.createElementNS(y,"polyline");s.setAttributeNS(null,"points",e),s.setAttributeNS(null,"class","TravelNotes-OSM-Itinerary"),s.setAttributeNS(null,"transform","rotate("+this._MapIconData.rotation+","+h.svgViewboxDim/2+","+h.svgViewboxDim/2+")"),this._svgElement.appendChild(s)}}_createWays(){this._overpassAPIDataLoader.ways.forEach((t=>{let o=p,n=p,a=-1,s=[];if(t.nodes.forEach((t=>{a++;let i=this._overpassAPIDataLoader.nodes.get(t),r=G.addPoints(G.project([i.lat,i.lon],e.note.svgIcon.zoom),this._MapIconData.translation);s.push(r),r[0]>=0&&r[1]>=0&&r[0]<=h.svgViewboxDim&&r[1]<=h.svgViewboxDim&&(p===o&&(o=a),n=a)})),p!==o&&p!==n){0<o&&o--,t.nodes.length-1>n&&n++;let e="";for(a=o;a<=n;a++)e+=s[a][0].toFixed(0)+","+s[a][1].toFixed(0)+" ";let i=document.createElementNS(y,"polyline");i.setAttributeNS(null,"points",e),i.setAttributeNS(null,"class","TravelNotes-OSM-Highway TravelNotes-OSM-Highway-"+t.tags.highway),i.setAttributeNS(null,"transform","rotate("+this._MapIconData.rotation+","+h.svgViewboxDim/2+","+h.svgViewboxDim/2+")"),this._svgElement.appendChild(i)}}))}_createRcnRef(){if(""===this._MapIconData.rcnRef)return;let e=document.createElementNS(y,"text");e.textContent=this._MapIconData.rcnRef,e.setAttributeNS(null,"x",String(h.svgViewboxDim/2)),e.setAttributeNS(null,"y",String(.6*h.svgViewboxDim)),e.setAttributeNS(null,"class","TravelNotes-OSM-RcnRef"),this._svgElement.appendChild(e)}constructor(){}buildSvg(e,t,o){return this._route=e,this._overpassAPIDataLoader=t,this._MapIconData=o,this._createSvg(),this._createRoute(),this._createWays(),this._createRcnRef(),this._svgElement}}class Qe{_options={searchPlaces:!0,searchWays:!0,searchRelations:!0,setGeometry:!0};_nodes=new Map;_ways=new Map;_relations=new Map;_adminNames=null;_osmCityAdminLevel=null;_place=null;_places=null;_latLngDistance=Object.seal({latLng:[r.defaultValue,r.defaultValue],distance:n.defaultValue});_city=null;_statusOk=!0;_setGeometry(){this._ways.forEach((e=>{e.geometry=[[]],e.lat=r.defaultValue,e.lon=r.defaultValue;let t=0;e.nodes.forEach((o=>{let n=this._nodes.get(o);e.geometry[0].push([n.lat,n.lon]),e.lat+=n.lat,e.lon+=n.lon,t++})),0!==t&&(e.lat/=t,e.lon/=t)})),this._relations.forEach((e=>{e.geometry=[[]],e.lat=r.defaultValue,e.lon=r.defaultValue;let t=0;e.members.forEach((o=>{if("way"===o.type){let n=this._ways.get(o.ref);e.geometry.push(n.geometry[0]),e.lat+=n.lat,e.lon+=n.lon,t++}})),0!==t&&(e.lat/=t,e.lon/=t)}))}_parseData(t){t.forEach((t=>{switch(t.type){case"node":if(this._nodes.set(t.id,t),t.tags&&this._options.searchPlaces&&t.tags.place&&this._places[t.tags.place]&&t.tags.name){let e=X.pointsDistance(this._latLngDistance.latLng,[t.lat,t.lon]),o=this._places[t.tags.place];o.maxDistance>e&&o.distance>e&&(o.distance=e,o.name=t.tags.name)}break;case"way":this._options.searchWays&&this._ways.set(t.id,t);break;case"relation":this._options.searchRelations&&this._relations.set(t.id,t);break;case"area":if(this._options.searchPlaces){let o=t.tags.name;e.nominatim.language&&"*"!==e.nominatim.language&&t.tags["name:"+e.nominatim.language]&&(o=t.tags["name:"+e.nominatim.language]),this._adminNames[Number.parseInt(t.tags.admin_level)]=o,"2"===t.tags.admin_level&&(this._osmCityAdminLevel=e.geoCoder.osmCityAdminLevel[t.tags["ISO3166-1"]]||this._osmCityAdminLevel)}}})),this._options.setGeometry&&this._setGeometry(),this._options.searchPlaces&&this._setPlaceAndCity()}_setPlaceAndCity(){let e=null;for(let t=2;t<this._adminNames.length;t++)void 0!==this._adminNames[t]&&(this._osmCityAdminLevel>=t?this._city=this._adminNames[t]:e=this._adminNames[t]);let t=Number.MAX_VALUE;Object.values(this._places).forEach((e=>{e.distance<t&&(t=e.distance,this._place=e.name)})),this._place=e||this._place,this._place===this._city&&(this._place=null)}async _parseSearchResults(e){for(let t=0;t<e.length;t++)if("fulfilled"===e[t].status&&g===e[t].value.status&&e[t].value.ok){let o=await e[t].value.json();this._parseData(o.elements),this._statusOk=this._statusOk&&!0}else this._statusOk=!1,console.error("An error occurs when calling theOverpassAPI: "),console.error(e[t])}constructor(e){if(e)for(const[t,o]of Object.entries(e))this._options[t]=o}async loadData(t,o){this._statusOk=!0,this._adminNames=[],this._osmCityAdminLevel=e.geoCoder.osmCityAdminLevel.DEFAULT,this._place=null,this._places={hamlet:{name:null,distance:Number.MAX_VALUE,maxDistance:e.geoCoder.distances.hamlet},village:{name:null,distance:Number.MAX_VALUE,maxDistance:e.geoCoder.distances.village},city:{name:null,distance:Number.MAX_VALUE,maxDistance:e.geoCoder.distances.city},town:{name:null,distance:Number.MAX_VALUE,maxDistance:e.geoCoder.distances.town}},this._latLngDistance.latLng=o,this._latLngDistance.distance=n.defaultValue,this._city=null,this._nodes.clear(),this._ways.clear(),this._relations.clear();let a=[];t.forEach((t=>{a.push(fetch(e.overpassApi.url+"?data=[out:json][timeout:"+e.overpassApi.timeOut+"];"+t))})),await Promise.allSettled(a).then((e=>this._parseSearchResults(e)))}get nodes(){return this._nodes}get ways(){return this._ways}get relations(){return this._relations}get place(){return this._place}get city(){return this._city}get country(){return this._adminNames[2]}get statusOk(){return this._statusOk}}class $e{_overpassAPIDataLoader=null;_computeData=null;_mapIconData=null;_rcnRefNode=null;_svgPointId=p;_incomingNodeId=p;_outgoingNodeId=p;_iconNode=null;_incomingStreet="";_outgoingStreet="";_roundabout={isMini:!1,isEntry:!1,isExit:!1};_getWayName(e){return(e.tags.name?e.tags.name:"")+(e.tags.name&&e.tags.ref?" ":"")+(e.tags.ref?"["+e.tags.ref+"]":"")}_latLngCompare(e){const t=5e-6;let o=!1;return this._computeData.route.wayPoints.forEach((n=>{Math.abs(e.lat-n.lat)<t&&Math.abs(e.lng-n.lng)<t&&(o=!0)})),!o&&(this._computeData.mapIconPosition.latLng[0]!==e.lat||this._computeData.mapIconPosition.latLng[1]!==e.lng)}_findNodes(){let e=this._computeData.route.itinerary.itineraryPoints.previous(this._computeData.mapIconPosition.nearestItineraryPointObjId,(e=>this._latLngCompare(e))),t=this._computeData.route.itinerary.itineraryPoints.next(this._computeData.mapIconPosition.nearestItineraryPointObjId,(e=>this._latLngCompare(e))),o=Number.MAX_VALUE,a=Number.MAX_VALUE,s=Number.MAX_VALUE,i=n.defaultValue;this._overpassAPIDataLoader.nodes.forEach((n=>{"bike"===this._computeData.route.itinerary.transitMode&&n.tags&&n.tags.rcn_ref&&(this._rcnRefNode=n),_!==this._computeData.mapIconPosition.nearestItineraryPointObjId&&(i=X.pointsDistance([n.lat,n.lon],this._computeData.mapIconPosition.latLng),i<o&&(this._svgPointId=n.id,o=i)),e&&(i=X.pointsDistance([n.lat,n.lon],e.latLng),i<a&&(this._incomingNodeId=n.id,a=i)),t&&(i=X.pointsDistance([n.lat,n.lon],t.latLng),i<s&&(this._outgoingNodeId=n.id,s=i))})),this._iconNode=this._overpassAPIDataLoader.nodes.get(this._svgPointId)}_moveIconToRcnRef(){if(this._rcnRefNode){let t=X.pointsDistance([this._rcnRefNode.lat,this._rcnRefNode.lon],[this._iconNode.lat,this._iconNode.lon]);e.note.svgIcon.rcnRefDistance>t&&(this._iconNode=this._rcnRefNode)}}_findMiniRoundabout(){this._roundabout.isMini=this._iconNode&&this._iconNode.tags&&this._iconNode.tags.highway&&"mini_roundabout"===this._iconNode.tags.highway}_addRcnRefNumber(){"bike"===this._computeData.route.itinerary.transitMode&&this._iconNode&&this._iconNode.tags&&this._iconNode.tags.rcn_ref&&this._iconNode.tags["network:type"]&&"node_network"===this._iconNode.tags["network:type"]&&(this._mapIconData.rcnRef=this._iconNode.tags.rcn_ref,this._mapIconData.tooltip+=M.getText("MapIconDataBuilder - rcnRef",{rcnRef:this._mapIconData.rcnRef}))}_findStreets(){this._overpassAPIDataLoader.ways.forEach((e=>{if(!e.nodes.includes(this._svgPointId))return;let t=this._getWayName(e),o=""!==t,n=e.nodes.includes(this._incomingNodeId),a=e.nodes.includes(this._outgoingNodeId),s=2*e.nodes.filter((e=>e===this._svgPointId)).length;if(e.nodes[0]===this._svgPointId&&s--,e.nodes[e.nodes.length-1]===this._svgPointId&&s--,n&&(this._incomingStreet=o?t:"???",s--,e.tags.junction&&"roundabout"===e.tags.junction&&(this._roundabout.isExit=!0)),0!==s&&(a&&(this._outgoingStreet=o?t:"???",s--,e.tags.junction&&"roundabout"===e.tags.junction&&(this._roundabout.isEntry=!0)),0!==s&&o))for(;0!==s;)this._mapIconData.streets=""===this._mapIconData.streets?t:this._mapIconData.streets+" âª¥  "+t,s--}))}_addStreetInfo(){u.atStart===this._computeData.positionOnRoute?this._mapIconData.streets="ðŸŸ¢ "+this._outgoingStreet:u.atEnd===this._computeData.positionOnRoute?this._mapIconData.streets=this._incomingStreet+" ðŸ”´ ":this._mapIconData.streets=this._incomingStreet+(""===this._mapIconData.streets?"":" âª¥  "+this._mapIconData.streets)+" "+this._computeData.directionArrow+" "+this._outgoingStreet}_addRoundaboutInfo(){this._roundabout.isEntry&&!this._roundabout.isExit?this._mapIconData.tooltip+=M.getText("MapIconDataBuilder - entry roundabout"):!this._roundabout.isEntry&&this._roundabout.isExit?this._mapIconData.tooltip+=M.getText("MapIconDataBuilder - exit roundabout"):this._roundabout.isEntry&&this._roundabout.isExit&&(this._mapIconData.tooltip+=M.getText("MapIconDataBuilder - continue roundabout")),this._roundabout.isMini&&(this._mapIconData.tooltip+=M.getText("MapIconDataBuilder - at the small roundabout on the ground"))}constructor(e,t,o){this._overpassAPIDataLoader=e,this._computeData=t,this._mapIconData=o}findData(){this._findNodes(),this._moveIconToRcnRef(),this._findMiniRoundabout(),this._addRcnRefNumber(),this._findStreets(),this._addStreetInfo(),this._addRoundaboutInfo()}}class et{_computeData=null;_mapIconData=null;constructor(e,t){this._computeData=e,this._mapIconData=t}findData(){null!==this._computeData.direction&&(this._computeData.direction<e.note.svgIcon.angleDirection.right?(this._mapIconData.tooltip=M.getText("MapIconDataBuilder - Turn right"),this._computeData.directionArrow="ðŸ¢‚"):this._computeData.direction<e.note.svgIcon.angleDirection.slightRight?(this._mapIconData.tooltip=M.getText("MapIconDataBuilder - Turn slight right"),this._computeData.directionArrow="ðŸ¢…"):this._computeData.direction<e.note.svgIcon.angleDirection.continue?(this._mapIconData.tooltip=M.getText("MapIconDataBuilder - Continue"),this._computeData.directionArrow="ðŸ¢"):this._computeData.direction<e.note.svgIcon.angleDirection.slightLeft?(this._mapIconData.tooltip=M.getText("MapIconDataBuilder - Turn slight left"),this._computeData.directionArrow="ðŸ¢„"):this._computeData.direction<e.note.svgIcon.angleDirection.left?(this._mapIconData.tooltip=M.getText("MapIconDataBuilder - Turn left"),this._computeData.directionArrow="ðŸ¢€"):this._computeData.direction<e.note.svgIcon.angleDirection.sharpLeft?(this._mapIconData.tooltip=M.getText("MapIconDataBuilder - Turn sharp left"),this._computeData.directionArrow="ðŸ¢‡"):this._computeData.direction<e.note.svgIcon.angleDirection.sharpRight?(this._mapIconData.tooltip=M.getText("MapIconDataBuilder - Turn sharp right"),this._computeData.directionArrow="ðŸ¢†"):(this._mapIconData.tooltip=M.getText("MapIconDataBuilder - Turn right"),this._computeData.directionArrow="ðŸ¢‚")),u.atStart===this._computeData.positionOnRoute?this._mapIconData.tooltip=M.getText("MapIconDataBuilder - Start"):u.atEnd===this._computeData.positionOnRoute&&(this._mapIconData.tooltip=M.getText("MapIconDataBuilder - Stop"))}}class tt{_computeData=null;_mapIconData=null;_rotationItineraryPoint=null;_directionItineraryPoint=null;_iconPoint=null;_computeTranslation(){this._mapIconData.translation=G.subtrackPoints([h.svgViewboxDim/2,h.svgViewboxDim/2],G.project(this._computeData.mapIconPosition.latLng,e.note.svgIcon.zoom))}_searchPoints(){this._rotationItineraryPoint=this._computeData.route.itinerary.itineraryPoints.first,this._directionItineraryPoint=this._computeData.route.itinerary.itineraryPoints.last;let t=n.defaultValue,o=!1;this._computeData.route.itinerary.itineraryPoints.forEach((n=>{this._computeData.mapIconPosition.distance-t>e.note.svgIcon.angleDistance&&(this._rotationItineraryPoint=n),t-this._computeData.mapIconPosition.distance>e.note.svgIcon.angleDistance&&!o&&(this._directionItineraryPoint=n,o=!0),t+=n.distance})),this._iconPoint=G.addPoints(G.project(this._computeData.mapIconPosition.latLng,e.note.svgIcon.zoom),this._mapIconData.translation)}_findRotation(){if(this._computeData.mapIconPosition.nearestItineraryPointObjId!==this._computeData.route.itinerary.itineraryPoints.first.objId){let t=G.addPoints(G.project(this._rotationItineraryPoint.latLng,e.note.svgIcon.zoom),this._mapIconData.translation);this._mapIconData.rotation=Math.atan((this._iconPoint[1]-t[1])/(t[0]-this._iconPoint[0]))*c.d180/Math.PI,0>this._mapIconData.rotation&&(this._mapIconData.rotation+=c.d360),this._mapIconData.rotation-=c.d270,0>t[0]-this._iconPoint[0]&&(this._mapIconData.rotation+=c.d180)}}_findDirection(){if(this._computeData.mapIconPosition.nearestItineraryPointObjId!==this._computeData.route.itinerary.itineraryPoints.last.objId){let t=G.addPoints(G.project(this._directionItineraryPoint.latLng,e.note.svgIcon.zoom),this._mapIconData.translation);for(this._computeData.direction=Math.atan((this._iconPoint[1]-t[1])/(t[0]-this._iconPoint[0]))*c.d180/Math.PI,0>t[0]-this._iconPoint[0]&&(this._computeData.direction+=c.d180),this._computeData.direction-=this._mapIconData.rotation;c.d0>this._computeData.direction;)this._computeData.direction+=c.d360;for(;c.d360<this._computeData.direction;)this._computeData.direction-=c.d360}}_findPositionOnRoute(){this._computeData.mapIconPosition.nearestItineraryPointObjId===this._computeData.route.itinerary.itineraryPoints.first.objId&&(this._mapIconData.rotation=-this._computeData.direction-c.d90,this._computeData.direction=null,this._computeData.positionOnRoute=u.atStart),this._computeData.mapIconPosition.latLng[0]===this._computeData.route.itinerary.itineraryPoints.last.lat&&this._computeData.mapIconPosition.latLng[1]===this._computeData.route.itinerary.itineraryPoints.last.lng&&(this._computeData.direction=null,this._computeData.positionOnRoute=u.atEnd)}constructor(e,t){this._computeData=e,this._mapIconData=t}findData(){this._computeTranslation(),this._searchPoints(),this._findRotation(),this._findDirection(),this._findPositionOnRoute()}}class ot{_overpassAPIDataLoader=null;_mapIconData=Object.seal({translation:[0,0],rotation:0,rcnRef:"",tooltip:"",streets:""});_computeData={mapIconPosition:null,route:null,positionOnRoute:u.onRoute,direction:null,directionArrow:" "};constructor(){}buildData(e,t,o){return this._computeData.mapIconPosition=o,this._computeData.route=e,this._computeData.positionOnRoute=u.onRoute,this._computeData.direction=null,this._computeData.directionArrow=" ",this._overpassAPIDataLoader=t,this._mapIconData.translation=[0,0],this._mapIconData.rotation=0,this._mapIconData.rcnRef="",this._mapIconData.tooltip="",this._mapIconData.streets="",new tt(this._computeData,this._mapIconData).findData(),new et(this._computeData,this._mapIconData).findData(),new $e(this._overpassAPIDataLoader,this._computeData,this._mapIconData).findData(),this._mapIconData}}class nt{_route=null;_overpassAPIDataLoader=new Qe({searchRelations:!1,setGeometry:!1});_mapIconPosition=Object.seal({latLng:[r.defaultValue,r.defaultValue],distance:n.defaultValue,nearestItineraryPointObjId:_});_queryDistance=Math.max(e.geoCoder.distances.hamlet,e.geoCoder.distances.village,e.geoCoder.distances.city,e.geoCoder.distances.town);_requestStarted=!1;_searchNearestItineraryPoint(){let e=null,t=Number.MAX_VALUE,o=n.defaultValue;this._route.itinerary.itineraryPoints.forEach((n=>{let a=X.pointsDistance(this._mapIconPosition.latLng,n.latLng);t>a&&(t=a,e=n,this._mapIconPosition.distance=o),o+=n.distance})),this._mapIconPosition.latLng=e.latLng,this._mapIconPosition.nearestItineraryPointObjId=e.objId}_buildIconAndAdress(){let e=(new ot).buildData(this._route,this._overpassAPIDataLoader,this._mapIconPosition),t=(new qe).buildSvg(this._route,this._overpassAPIDataLoader,e);this._requestStarted=!1;let o=e.streets;return""!==this._overpassAPIDataLoader.city&&(o+=' <span class="TravelNotes-NoteHtml-Address-City">'+this._overpassAPIDataLoader.city+"</span>"),this._overpassAPIDataLoader.place&&this._overpassAPIDataLoader.place!==this._overpassAPIDataLoader.city&&(o+=" ("+this._overpassAPIDataLoader.place+")"),Object.freeze({statusOk:!0,noteData:{iconContent:t.outerHTML,tooltipContent:e.tooltip,address:o,iconWidth:h.width,iconHeight:h.height,latLng:this._mapIconPosition.latLng}})}async _exeGetIconAndAdress(){if(this._requestStarted)return Object.freeze({statusOk:!1,noteData:null});this._requestStarted=!0,this._searchNearestItineraryPoint();let e=this._mapIconPosition.latLng[0].toFixed(r.fixed)+","+this._mapIconPosition.latLng[1].toFixed(r.fixed),t=["way[highway](around:"+(1.5*h.svgViewboxDim).toFixed(0)+","+e+")->.a;(.a >;.a;)->.a;.a out;is_in("+e+')->.e;area.e[admin_level][boundary="administrative"];out;node(around:'+this._queryDistance+","+e+")[place];out;"];return await this._overpassAPIDataLoader.loadData(t,this._mapIconPosition.latLng),this._overpassAPIDataLoader.statusOk?this._buildIconAndAdress():Object.freeze({statusOk:!1})}async _exeGetIconAndAdressWithPromise(e,t){let o=await this._exeGetIconAndAdress();o.statusOk?e(o):t("An error occurs...")}constructor(){}async getIconAndAdressAsync(e,t){return this._mapIconPosition.latLng=e,this._route=Z.getRoute(t),this._exeGetIconAndAdress()}getIconAndAdressWithPromise(e,t){return this._mapIconPosition.latLng=e,this._route=Z.getRoute(t),new Promise(((e,t)=>this._exeGetIconAndAdressWithPromise(e,t)))}}class at{_noteDialog=null;constructor(e){this._noteDialog=e}destructor(){this._noteDialog=null}handleEvent(e){if(!this._noteDialog.focusControl)return;let t=e.currentTarget,o=this._noteDialog.focusControl.selectionStart,n=this._noteDialog.focusControl.selectionEnd;this._noteDialog.focusControl.value=this._noteDialog.focusControl.value.slice(0,o)+t.dataset.tanHtmlBefore+(0===t.dataset.tanHtmlAfter.length?"":this._noteDialog.focusControl.value.slice(o,n))+t.dataset.tanHtmlAfter+this._noteDialog.focusControl.value.slice(n),o===n||0===t.dataset.tanHtmlAfter.length?(o+=t.dataset.tanHtmlBefore.length,n=o):n+=t.dataset.tanHtmlBefore.length+t.dataset.tanHtmlAfter.length,this._noteDialog.focusControl.setSelectionRange(o,n),this._noteDialog.focusControl.focus();let a={};a[this._noteDialog.focusControl.dataset.tanName]=this._noteDialog.focusControl.value,this._noteDialog.updatePreview(a)}}class st{_noteDialog=null;_updatePreviewAndControls(e){this._noteDialog.setControlsValues(e),this._noteDialog.updatePreview(e)}_onMapIcon(){_!==this._noteDialog.mapIconData.routeObjId?(this._noteDialog.showWait(),(new nt).getIconAndAdressWithPromise(this._noteDialog.mapIconData.latLng,this._noteDialog.mapIconData.routeObjId).then((e=>{this._noteDialog.hideWait(),this._updatePreviewAndControls(e.noteData)})).catch((()=>{this._noteDialog.hideWait(),this._noteDialog.showError(M.getText("Notedialog - an error occurs when creating the SVG icon"))}))):this._noteDialog.showError(M.getText("Notedialog - not possible to create a SVG icon for a travel note"))}constructor(e){this._noteDialog=e}destructor(){this._noteDialog=null}handleEvent(e){e.stopPropagation();let t=Je.getIconData(e.target.selectedIndex);"SvgIcon"!==t.icon?this._updatePreviewAndControls({iconContent:t.icon,iconHeight:t.height,iconWidth:t.width,tooltipContent:t.tooltip}):this._onMapIcon()}}class it{_noteDialog=null;constructor(e){this._noteDialog=e}destructor(){this._noteDialog=null}handleEvent(e){e.target.textContent="â–¼"===e.target.textContent?"â–¶":"â–¼",this._noteDialog.toogleContents()}}class rt{_noteDialogToolbar=null;constructor(e){this._noteDialogToolbar=e}handleEvent(e){e.stopPropagation();let t=new FileReader;t.onload=()=>{let e={};try{e=JSON.parse(t.result),Je.loadJson(e),this._noteDialogToolbar.update()}catch(e){e instanceof Error&&console.error(e)}},t.readAsText(e.target.files[0])}}class lt{_noteDialogToolbar=null;constructor(e){this._noteDialogToolbar=e}destructor(){this._noteDialogToolbar=null}handleEvent(e){e.stopPropagation(),P.openFile(new rt(this._noteDialogToolbar),".json")}}class dt{_noteDialog=null;_rootHTMLElement=null;_iconSelect=null;_toogleContentsButton=null;_openFileButton=null;_editionButtons=[];_eventListeners={onEditionButtonClick:null,onIconSelectChange:null,onToogleContentsButtonClick:null,onOpenFileButtonClick:null};_addIconsSelector(){this._iconSelect=Y.create("select",{className:"TravelNotes-NoteDialog-Select",id:"TravelNotes-NoteDialog-IconSelect"},this._rootHTMLElement),this._iconSelect.addEventListener("change",this._eventListeners.onIconSelectChange,!1),Je.icons.forEach((e=>{this._iconSelect.add(Y.create("option",{text:e[0]}))})),this._iconSelect.selectedIndex=p}_addToolbarButtons(){this._toogleContentsButton=Y.create("div",{className:"TravelNotes-BaseDialog-Button",title:M.getText("NoteDialog - show hidden contents"),textContent:"â–¼"},this._rootHTMLElement),this._toogleContentsButton.addEventListener("click",this._eventListeners.onToogleContentsButtonClick,!1),this._openFileButton=Y.create("div",{className:"TravelNotes-BaseDialog-Button",title:M.getText("NoteDialog - Open a configuration file"),textContent:"ðŸ“‚"},this._rootHTMLElement),this._openFileButton.addEventListener("click",this._eventListeners.onOpenFileButtonClick,!1)}_addEditionButtons(){Je.buttons.forEach((e=>{let t=Y.create("div",{dataset:{HtmlBefore:e.htmlBefore||"",HtmlAfter:e.htmlAfter||""},className:"TravelNotes-NoteDialog-EditorButton"},this._rootHTMLElement);x.sanitizeToHtmlElement(e.title||"?",t),t.addEventListener("click",this._eventListeners.onEditionButtonClick,!1),this._editionButtons.push(t)}))}_addToolbarElements(){this._addIconsSelector(),this._addToolbarButtons(),this._addEditionButtons()}_removeEventListeners(){this._iconSelect.removeEventListener("change",this._eventListeners.onIconSelectChange,!1),this._toogleContentsButton.removeEventListener("click",this._eventListeners.onToogleContentsButtonClick,!1),this._openFileButton.removeEventListener("click",this._eventListeners.onOpenFileButtonClick,!1),this._editionButtons.forEach((e=>{e.removeEventListener("click",this._eventListeners.onEditionButtonClick,!1)}))}constructor(e){this._noteDialog=e,this._rootHTMLElement=Y.create("div",{id:"TravelNotes-NoteDialog-ToolbarDiv"}),this._eventListeners.onIconSelectChange=new st(this._noteDialog),this._eventListeners.onToogleContentsButtonClick=new it(this._noteDialog),this._eventListeners.onOpenFileButtonClick=new lt(this),this._eventListeners.onEditionButtonClick=new at(this._noteDialog),this._addToolbarElements()}destructor(){this._removeEventListeners(),this._eventListeners.onEditionButtonClick.destructor(),this._eventListeners.onIconSelectChange.destructor(),this._eventListeners.onToogleContentsButtonClick.destructor(),this._eventListeners.onOpenFileButtonClick.destructor(),this._noteDialog=null}update(){this._removeEventListeners(),this._rootHTMLElement.textContent="",this._editionButtons=[],this._addToolbarElements()}get rootHTMLElement(){return this._rootHTMLElement}}class ht{_nominatimStatusOk=!0;_queryDistance=Math.max(e.geoCoder.distances.hamlet,e.geoCoder.distances.village,e.geoCoder.distances.city,e.geoCoder.distances.town);_latLng=null;_overpassAPIDataLoader=null;_nominatimData=null;_mergeData(){let e=null;this._overpassAPIDataLoader.city&&(e=this._overpassAPIDataLoader.city,this._overpassAPIDataLoader.place&&(e+=" ("+this._overpassAPIDataLoader.place+")"),e||(e=this._overpassAPIDataLoader.country));let t=null,o=null;return this._nominatimData&&(t=this._nominatimData.street,o=this._nominatimData.nameDetails||"",e||(e=this._nominatimData.country)),e=e||"",t=t||"",o=o||"",(t.includes(o)||e.includes(o))&&(o=""),Object.freeze({name:x.sanitizeToJsString(o),street:x.sanitizeToJsString(t),city:x.sanitizeToJsString(e),statusOk:this._nominatimStatusOk})}_parseNominatimData(e){let t="";e.error?this._nominatimStatusOk=!1:(e.address.house_number&&(t+=e.address.house_number+" "),e.address.road?t+=e.address.road+" ":e.address.pedestrian&&(t+=e.address.pedestrian+" "),this._nominatimData={street:t,nameDetails:e.namedetails.name,country:e.address.country})}async _loadNominatimData(){let t=e.nominatim.url+"reverse?format=json&lat="+this._latLng[0]+"&lon="+this._latLng[1]+"&zoom=18&addressdetails=1&namedetails=1",o=e.nominatim.language;o&&"*"!==o&&(t+="&accept-language="+o);let n=new Headers;o&&"*"===o&&n.append("accept-language","");let a=await fetch(t,{headers:n});if(g===a.status&&a.ok){this._nominatimStatusOk=this._nominatimStatusOk&&!0;let e=await a.json();this._parseNominatimData(e)}else this._nominatimStatusOk=!1}_getOverpassQueries(){return["is_in("+this._latLng[0]+","+this._latLng[1]+')->.e;area.e[admin_level][boundary="administrative"];out;node(around:'+this._queryDistance+","+this._latLng[0]+","+this._latLng[1]+")[place];out;"]}async _execGetAddress(){return this._nominatimStatusOk=!0,this._nominatimData=null,this._overpassAPIDataLoader=new Qe({searchWays:!1,searchRelations:!1,setGeometry:!0}),await this._overpassAPIDataLoader.loadData(this._getOverpassQueries(),this._latLng),await this._loadNominatimData(),this._mergeData()}async _exeGetAdressWithPromise(e,t){let o=await this._execGetAddress();o.statusOk?e(o):t("An error occurs...")}constructor(){}async getAddressAsync(e){return this._latLng=e,this._execGetAddress()}getAddressWithPromise(e){return this._latLng=e,new Promise(((e,t)=>this._exeGetAdressWithPromise(e,t)))}}class ct{_noteDialog=null;_onAddressUpdatedByGeoCoder(e){this._noteDialog.hideWait();let t=e.street;""!==e.city&&(t+=' <span class="TravelNotes-NoteHtml-Address-City">'+e.city+"</span>"),this._noteDialog.setControlsValues({address:t}),this._noteDialog.updatePreview({address:t})}constructor(e){this._noteDialog=e}destructor(){this._noteDialog=null}setAddressWithGeoCoder(e){this._noteDialog.showWait(),this._noteDialog.hideError(),(new ht).getAddressWithPromise(e).then((e=>{this._onAddressUpdatedByGeoCoder(e)})).catch((e=>{e&&console.error(e),this._noteDialog.hideWait(),this._noteDialog.showError(M.getText("Notedialog - an error occurs when searching the adress"))}))}}class ut{_noteDialog=null;_latLng=null;_geoCoderHelper=null;constructor(e,t){this._noteDialog=e,this._latLng=t,this._geoCoderHelper=new ct(this._noteDialog)}destructor(){this._noteDialog=null,this._geoCoderHelper.destructor()}handleEvent(e){e.stopPropagation(),this._geoCoderHelper.setAddressWithGeoCoder(this._latLng)}}class vt{_noteDialog=null;_disableFocusControl=!1;constructor(e,t){this._noteDialog=e,this._disableFocusControl=t}destructor(){this._noteDialog=null}handleEvent(e){e.stopPropagation(),this._disableFocusControl?this._noteDialog.focusControl=null:this._noteDialog.focusControl=e.target}}class _t{_noteDialog=null;constructor(e){this._noteDialog=e}destructor(){this._noteDialog=null}handleEvent(e){if(e.stopPropagation(),""===e.target.value)return void this._noteDialog.hideError();""===x.sanitizeToUrl(e.target.value).errorsString?this._noteDialog.hideError():this._noteDialog.showError(M.getText("NoteDialog - invalidUrl"))}}class pt{_noteDialog=null;constructor(e){this._noteDialog=e}destructor(){this._noteDialog=null}handleEvent(e){e.stopPropagation();let t={};t[e.target.dataset.tanName]=e.target.value,this._noteDialog.updatePreview(t)}}class mt{_noteDialog=null;_iconDimsDiv=null;_iconWidthInput=null;_iconHeightInput=null;_eventListeners={onInputUpdated:null};constructor(e){this._noteDialog=e,this._iconDimsDiv=Y.create("div",{className:"TravelNotes-NoteDialog-DataDiv"}),Y.create("text",{value:M.getText("NoteDialog - Icon width")},this._iconDimsDiv),this._iconWidthInput=Y.create("input",{type:"number",className:"TravelNotes-NoteDialog-NumberInput",value:h.width,dataset:{Name:"iconWidth"}},this._iconDimsDiv),Y.create("text",{value:M.getText("NoteDialog - Icon height")},this._iconDimsDiv),this._iconHeightInput=Y.create("input",{type:"number",className:"TravelNotes-NoteDialog-NumberInput",value:h.height,dataset:{Name:"iconHeight"}},this._iconDimsDiv),this._eventListeners.onInputUpdated=new pt(this._noteDialog),this._iconWidthInput.addEventListener("input",this._eventListeners.onInputUpdated),this._iconHeightInput.addEventListener("input",this._eventListeners.onInputUpdated)}destructor(){this._iconWidthInput.removeEventListener("input",this._eventListeners.onInputUpdated),this._iconHeightInput.removeEventListener("input",this._eventListeners.onInputUpdated),this._eventListeners.onInputUpdated.destructor(),this._noteDialog=null}get HTMLElements(){return[this._iconDimsDiv]}get iconWidth(){return Number.parseInt(this._iconWidthInput.value)}set iconWidth(e){this._iconWidthInput.value=e}get iconHeight(){return Number.parseInt(this._iconHeightInput.value)}set iconHeight(e){this._iconHeightInput.value=e}}class gt{_noteDialog=null;_iconDiv=null;_iconTextArea=null;_eventListeners={onFocusControl:null,onInputUpdated:null};constructor(t){this._noteDialog=t,this._iconDiv=Y.create("div",{className:"TravelNotes-NoteDialog-DataDiv",textContent:M.getText("NoteDialog - Icon content")}),this._iconTextArea=Y.create("textarea",{className:"TravelNotes-NoteDialog-TextArea",placeholder:"?????",rows:e.noteDialog.areaHeight.icon,dataset:{Name:"iconContent"}},this._iconDiv),this._eventListeners.onFocusControl=new vt(this._noteDialog,!1),this._eventListeners.onInputUpdated=new pt(this._noteDialog),this._iconTextArea.addEventListener("focus",this._eventListeners.onFocusControl),this._iconTextArea.addEventListener("input",this._eventListeners.onInputUpdated)}destructor(){this._iconTextArea.removeEventListener("focus",this._eventListeners.onFocusControl),this._iconTextArea.removeEventListener("input",this._eventListeners.onInputUpdated),this._eventListeners.onFocusControl.destructor(),this._eventListeners.onInputUpdated.destructor(),this._noteDialog=null}get HTMLElements(){return[this._iconDiv]}get iconContent(){return this._iconTextArea.value}set iconContent(e){this._iconTextArea.value=e}}class yt{_noteDialog=null;_tooltipDiv=null;_tooltipInput=null;_eventListeners={onFocusControl:null,onInputUpdated:null};constructor(e){this._noteDialog=e,this._tooltipDiv=Y.create("div",{className:"TravelNotes-NoteDialog-DataDiv",textContent:M.getText("NoteDialog - Tooltip content")}),this._tooltipInput=Y.create("input",{type:"text",className:"TravelNotes-NoteDialog-InputText",dataset:{Name:"tooltipContent"}},this._tooltipDiv),this._eventListeners.onFocusControl=new vt(this._noteDialog,!1),this._eventListeners.onInputUpdated=new pt(this._noteDialog),this._tooltipInput.addEventListener("focus",this._eventListeners.onFocusControl),this._tooltipInput.addEventListener("input",this._eventListeners.onInputUpdated)}destructor(){this._tooltipInput.removeEventListener("focus",this._eventListeners.onFocusControl),this._tooltipInput.removeEventListener("input",this._eventListeners.onInputUpdated),this._eventListeners.onFocusControl.destructor(),this._eventListeners.onInputUpdated.destructor(),this._noteDialog=null}get HTMLElements(){return[this._tooltipDiv]}get tooltipContent(){return this._tooltipInput.value}set tooltipContent(e){this._tooltipInput.value=e}}class bt{_noteDialog=null;_popupDiv=null;_popupTextArea=null;_eventListeners={onFocusControl:null,onInputUpdated:null};constructor(t){this._noteDialog=t,this._popupDiv=Y.create("div",{className:"TravelNotes-NoteDialog-DataDiv",textContent:M.getText("NoteDialog - Text")}),this._popupTextArea=Y.create("textarea",{className:"TravelNotes-NoteDialog-TextArea",rows:e.noteDialog.areaHeight.popupContent,dataset:{Name:"popupContent"}},this._popupDiv),this._eventListeners.onFocusControl=new vt(this._noteDialog,!1),this._eventListeners.onInputUpdated=new pt(this._noteDialog),this._popupTextArea.addEventListener("focus",this._eventListeners.onFocusControl),this._popupTextArea.addEventListener("input",this._eventListeners.onInputUpdated)}destructor(){this._popupTextArea.removeEventListener("focus",this._eventListeners.onFocusControl),this._popupTextArea.removeEventListener("input",this._eventListeners.onInputUpdated),this._eventListeners.onFocusControl.destructor(),this._eventListeners.onInputUpdated.destructor(),this._noteDialog=null}get HTMLElements(){return[this._popupDiv]}get popupContent(){return this._popupTextArea.value}set popupContent(e){this._popupTextArea.value=e}}class It{_noteDialog=null;_addressHeaderDiv=null;_addressInputDiv=null;_addressInput=null;_addressButton=null;_latLng=null;_eventListeners={onFocusControl:null,onInputUpdated:null,onAddressButtonClick:null};constructor(e,t){this._noteDialog=e,this._latLng=t,this._addressHeaderDiv=Y.create("div",{className:"TravelNotes-NoteDialog-DataDiv"}),this._addressButton=Y.create("div",{className:"TravelNotes-BaseDialog-Button",title:M.getText("NoteDialog - Reset address"),textContent:"ðŸ”„"},this._addressHeaderDiv),Y.create("text",{value:M.getText("NoteDialog - Address")},this._addressHeaderDiv),this._addressInputDiv=Y.create("div",{className:"TravelNotes-NoteDialog-DataDiv"}),this._addressInput=Y.create("input",{type:"text",className:"TravelNotes-NoteDialog-InputText",dataset:{Name:"address"}},this._addressInputDiv),this._eventListeners.onFocusControl=new vt(this._noteDialog,!1),this._eventListeners.onInputUpdated=new pt(this._noteDialog),this._eventListeners.onAddressButtonClick=new ut(this._noteDialog,this._latLng),this._addressInput.addEventListener("focus",this._eventListeners.onFocusControl),this._addressInput.addEventListener("input",this._eventListeners.onInputUpdated),this._addressButton.addEventListener("click",this._eventListeners.onAddressButtonClick)}destructor(){this._addressInput.removeEventListener("focus",this._eventListeners.onFocusControl),this._addressInput.removeEventListener("input",this._eventListeners.onInputUpdated),this._addressButton.removeEventListener("click",this._eventListeners.onAddressButtonClick),this._eventListeners.onFocusControl.destructor(),this._eventListeners.onInputUpdated.destructor(),this._eventListeners.onAddressButtonClick.destructor()}get HTMLElements(){return[this._addressHeaderDiv,this._addressInputDiv]}get address(){return this._addressInput.value}set address(e){this._addressInput.value=e}}class wt{_noteDialog=null;_linkHeaderDiv=null;_linkInputDiv=null;_linkInput=null;_eventListeners={onFocusControl:null,onInputUpdated:null,onBlurUrlInput:null};_createTheDevilButton(t){e.noteDialog.theDevil.addButton&&Y.create("text",{value:"ðŸ‘¿"},Y.create("a",{href:"https://www.google.com/maps/@"+t[0].toFixed(r.fixed)+","+t[1].toFixed(r.fixed)+","+e.noteDialog.theDevil.zoomFactor+"z",target:"_blank",title:"Reminder! The devil will know everything about you"},Y.create("div",{className:"TravelNotes-BaseDialog-Button",title:"Reminder! The devil will know everything about you"},this._linkHeaderDiv)))}constructor(e,t){this._noteDialog=e,this._linkHeaderDiv=Y.create("div",{className:"TravelNotes-NoteDialog-DataDiv"}),this._createTheDevilButton(t),Y.create("text",{value:M.getText("NoteDialog - Link")},this._linkHeaderDiv),this._linkInputDiv=Y.create("div",{className:"TravelNotes-NoteDialog-DataDiv"}),this._linkInput=Y.create("input",{type:"text",className:"TravelNotes-NoteDialog-InputText",dataset:{Name:"url"}},this._linkInputDiv),this._eventListeners.onFocusControl=new vt(this._noteDialog,!0),this._eventListeners.onInputUpdated=new pt(this._noteDialog),this._eventListeners.onBlurUrlInput=new _t(this._noteDialog),this._linkInput.addEventListener("focus",this._eventListeners.onFocusControl),this._linkInput.addEventListener("input",this._eventListeners.onInputUpdated),this._linkInput.addEventListener("blur",this._eventListeners.onBlurUrlInput)}destructor(){this._linkInput.removeEventListener("focus",this._eventListeners.onFocusControl),this._linkInput.removeEventListener("input",this._eventListeners.onInputUpdated),this._linkInput.removeEventListener("blur",this._eventListeners.onBlurUrlInput),this._eventListeners.onFocusControl.destructor(),this._eventListeners.onInputUpdated.destructor(),this._eventListeners.onBlurUrlInput.destructor(),this._noteDialog=null}get HTMLElements(){return[this._linkHeaderDiv,this._linkInputDiv]}get url(){return this._linkInput.value}set url(e){this._linkInput.value=e}}class Lt{_noteDialog=null;_phoneHeaderDiv=null;_phoneInputDiv=null;_phoneInput=null;_eventListeners={onFocusControl:null,onInputUpdated:null};constructor(e){this._noteDialog=e,this._phoneHeaderDiv=Y.create("div",{className:"TravelNotes-NoteDialog-DataDiv"}),Y.create("text",{value:"Â "+M.getText("NoteDialog - Phone")},this._phoneHeaderDiv),this._phoneInputDiv=Y.create("div",{className:"TravelNotes-NoteDialog-DataDiv"}),this._phoneInput=Y.create("input",{type:"text",className:"TravelNotes-NoteDialog-InputText",dataset:{Name:"phone"}},this._phoneInputDiv),this._eventListeners.onFocusControl=new vt(this._noteDialog,!1),this._eventListeners.onInputUpdated=new pt(this._noteDialog),this._phoneInput.addEventListener("focus",this._eventListeners.onFocusControl),this._phoneInput.addEventListener("input",this._eventListeners.onInputUpdated)}destructor(){this._phoneInput.removeEventListener("focus",this._eventListeners.onFocusControl),this._phoneInput.removeEventListener("input",this._eventListeners.onInputUpdated),this._eventListeners.onFocusControl.destructor(),this._eventListeners.onInputUpdated.destructor(),this._noteDialog=null}get HTMLElements(){return[this._phoneHeaderDiv,this._phoneInputDiv]}get phone(){return this._phoneInput.value}set phone(e){this._phoneInput.value=e}}class Tt{_previewNote=null;_previewDiv=null;constructor(e){this._previewNote=e,this._previewDiv=Y.create("div",{className:"TravelNotes-NoteDialog-PreviewDiv"}),this._previewDiv.appendChild(Be.getNoteTextAndIconHTML("TravelNotes-NoteDialog-",{note:this._previewNote,route:null}))}update(){this._previewDiv.textContent="",this._previewDiv.appendChild(Be.getNoteTextAndIconHTML("TravelNotes-NoteDialog-",{note:this._previewNote,route:null}))}get HTMLElements(){return[this._previewDiv]}}class Dt extends le{_note=null;_startGeoCoder=!1;_routeObjId=null;_previewNote=null;_iconDimsControl=null;_iconControl=null;_tooltipControl=null;_popupControl=null;_addressControl=null;_linkControl=null;_phoneControl=null;_previewControl=null;_toolbar=null;_focusControl=null;constructor(e,t,o){super(),this._note=e,this._startGeoCoder=o,this._routeObjId=t,this._previewNote=new U,this._previewNote.jsonObject=e.jsonObject,this._toolbar=new dt(this),this._iconDimsControl=new mt(this),this._iconControl=new gt(this),this._tooltipControl=new yt(this),this._popupControl=new bt(this),this._addressControl=new It(this,e.latLng,o),this._linkControl=new wt(this,e.latLng),this._phoneControl=new Lt(this),this._previewControl=new Tt(this._previewNote),this.setControlsValues(e)}_destructor(){this._toolbar.destructor(),this._iconDimsControl.destructor(),this._iconControl.destructor(),this._tooltipControl.destructor(),this._popupControl.destructor(),this._addressControl.destructor(),this._linkControl.destructor(),this._phoneControl.destructor()}set focusControl(e){this._focusControl=e}get focusControl(){return this._focusControl}get mapIconData(){return Object.freeze({latLng:this._previewNote.latLng,routeObjId:this._routeObjId})}updatePreview(e){for(const t in e)this._previewNote[t]=e[t];this._previewControl.update()}onShow(){this._startGeoCoder&&new ct(this).setAddressWithGeoCoder(this._previewNote.latLng),this.toogleContents()}canClose(){return""===this._iconControl.iconContent?(this.showError(M.getText("Notedialog - The icon content cannot be empty")),!1):""===this._linkControl.url||""!==x.sanitizeToUrl(this._linkControl.url).url||(this.showError(M.getText("NoteDialog - invalidUrl")),!1)}onCancel(){this._destructor(),super.onCancel()}onOk(){super.onOk()&&(this.getControlsValues(this._note),this._note.latLng=this._previewNote.latLng,this._note.validateData(),this._destructor())}get title(){return M.getText("NoteDialog - Note")}get contentHTMLElements(){return[].concat(this._toolbar.rootHTMLElement,this._iconDimsControl.HTMLElements,this._iconControl.HTMLElements,this._tooltipControl.HTMLElements,this._popupControl.HTMLElements,this._addressControl.HTMLElements,this._linkControl.HTMLElements,this._phoneControl.HTMLElements)}get footerHTMLElements(){return this._previewControl.HTMLElements}setControlsValues(e){this._iconDimsControl.iconHeight=e.iconHeight||this._iconDimsControl.iconHeight,this._iconDimsControl.iconWidth=e.iconWidth||this._iconDimsControl.iconWidth,this._iconControl.iconContent=e.iconContent||this._iconControl.iconContent,this._tooltipControl.tooltipContent=e.tooltipContent||this._tooltipControl.tooltipContent,this._popupControl.popupContent=e.popupContent||this._popupControl.popupContent,this._addressControl.address=e.address||this._addressControl.address,this._linkControl.url=e.url||this._linkControl.url,this._phoneControl.phone=e.phone||this._phoneControl.phone}getControlsValues(e){e.iconWidth=this._iconDimsControl.iconHeight,e.iconHeight=this._iconDimsControl.iconWidth,e.iconContent=this._iconControl.iconContent,e.tooltipContent=this._tooltipControl.tooltipContent,e.popupContent=this._popupControl.popupContent,e.address=this._addressControl.address,e.url=this._linkControl.url,e.phone=this._phoneControl.phone}toogleContents(){e.noteDialog.mask.iconsDimension&&this._iconDimsControl.HTMLElements[0].classList.toggle("TravelNotes-Hidden"),e.noteDialog.mask.iconTextArea&&this._iconControl.HTMLElements[0].classList.toggle("TravelNotes-Hidden"),e.noteDialog.mask.popupContent&&this._popupControl.HTMLElements[0].classList.toggle("TravelNotes-Hidden"),e.noteDialog.mask.tooltip&&this._tooltipControl.HTMLElements[0].classList.toggle("TravelNotes-Hidden"),e.noteDialog.mask.address&&(this._addressControl.HTMLElements[0].classList.toggle("TravelNotes-Hidden"),this._addressControl.HTMLElements[1].classList.toggle("TravelNotes-Hidden")),e.noteDialog.mask.link&&(this._linkControl.HTMLElements[0].classList.toggle("TravelNotes-Hidden"),this._linkControl.HTMLElements[1].classList.toggle("TravelNotes-Hidden")),e.noteDialog.mask.phone&&(this._phoneControl.HTMLElements[0].classList.toggle("TravelNotes-Hidden"),this._phoneControl.HTMLElements[1].classList.toggle("TravelNotes-Hidden"))}}class Et{_backgroundDiv=null;_messageDiv=null;constructor(){}createUI(){if(document.getElementById("TravelNotes-WaitUI"))return;this._backgroundDiv=Y.create("div",{className:"TravelNotes-Background"},document.body);let e=Y.create("div",{id:"TravelNotes-WaitUI"},this._backgroundDiv);this._messageDiv=Y.create("div",{id:"TravelNotes-WaitUI-MessageDiv"},e),Y.create("div",{className:"TravelNotes-WaitAnimationBullet"},Y.create("div",{className:"TravelNotes-WaitAnimation"},e))}showInfo(e){this._messageDiv.textContent=e}close(){document.body.removeChild(this._backgroundDiv),this._backgroundDiv=null}}const ft=new class{_waitUI=null;_showSearchNoteDialog=null;_maneuverCounter=0;_addNote(e,t,o){if(o)if(_===t)z.travel.notes.add(e),xe.dispatch("showtravelnotes");else{let o=Z.getRoute(t);o.notes.add(e),e.chainedDistance=o.chainedDistance,o.notes.sort(((e,t)=>e.distance-t.distance)),xe.dispatch("showitinerary")}else _===t?xe.dispatch("updatetravelnotes"):xe.dispatch("updateitinerary");xe.dispatch("noteupdated",{removedNoteObjId:e.objId,addedNoteObjId:e.objId}),xe.dispatch("roadbookupdate")}_noteDialog(e,t,o){new Dt(e,t,o).show().then((()=>this._addNote(e,t,o))).catch((e=>{console.error(e)}))}_newNote(e){let t=new U;return t.latLng=e,t.iconLatLng=e,t}constructor(){}get osmSearchNoteDialog(){return null===this._showSearchNoteDialog&&(this._showSearchNoteDialog=e.osmSearch.showSearchNoteDialog),this._showSearchNoteDialog}changeOsmSearchNoteDialog(){this._showSearchNoteDialog=!this.osmSearchNoteDialog}newRouteNote(e){let t=Z.getRoute(e.routeObjId),o=G.getClosestLatLngDistance(t,[e.lat,e.lng]),n=this._newNote(o.latLng);n.distance=o.distance,this._noteDialog(n,t.objId,!0)}async newSearchNote(e){let t=_,o=new U;if(e.isTravelNote)o.latLng=[e.osmElement.lat,e.osmElement.lon];else{let n=Z.getNearestRouteData([e.osmElement.lat,e.osmElement.lon]);if(!n.route)return void Me.showError(M.getText("NoteEditor - No route was found"));o.latLng=n.latLngOnRoute,o.distance=n.distanceOnRoute,t=n.route.objId}if(o.iconLatLng=[e.osmElement.lat,e.osmElement.lon],o.iconHeight=h.height,o.iconWidth=h.width,e.osmElement.tags.rcn_ref?o.iconContent="<div class='TravelNotes-MapNote TravelNotes-MapNoteCategory-0073'><svg viewBox='0 0 20 20'><text x='10' y='14'>"+e.osmElement.tags.rcn_ref+"</text></svg></div>":o.iconContent=Je.getIconContentFromName(e.osmElement.description),o.url=e.osmElement.tags.website||"",o.phone=e.osmElement.tags.phone||"",o.tooltipContent=e.osmElement.description||"",o.popupContent=e.osmElement.tags.name||"",e.osmElement.tags["addr:street"]&&e.osmElement.tags["addr:city"])o.address=(e.osmElement.tags["addr:housenumber"]?e.osmElement.tags["addr:housenumber"]+" ":"")+e.osmElement.tags["addr:street"]+' <span class="TravelNotes-NoteHtml-Address-City">'+e.osmElement.tags["addr:city"]+"</span>";else{this._waitUI=new Et,this._waitUI.createUI(),this._waitUI.showInfo("Creating address");let t=null;try{t=await(new ht).getAddressAsync([e.osmElement.lat,e.osmElement.lon])}catch(e){console.error(e)}this._waitUI.close(),t.statusOk&&(o.address=t.street,""!==t.city&&(o.address+=' <span class="TravelNotes-NoteHtml-Address-City">'+t.city+"</span>"))}this.osmSearchNoteDialog||""===o.iconContent?this._noteDialog(o,t,!0):this._addNote(o,t,!0)}newTravelNote(e){let t=this._newNote(e);this._noteDialog(t,_,!0)}editNote(e){let t=Z.getNoteAndRoute(e),o=null===t.route?_:t.route.objId;this._noteDialog(t.note,o,!1)}removeNote(e){let t=Z.getNoteAndRoute(e);t.route?(t.route.notes.remove(e),xe.dispatch("updateitinerary")):(z.travel.notes.remove(e),xe.dispatch("updatetravelnotes")),xe.dispatch("noteupdated",{removedNoteObjId:e,addedNoteObjId:_}),xe.dispatch("roadbookupdate")}hideNotes(){let e=z.travel.notes.iterator;for(;!e.done;)xe.dispatch("removeobject",{objId:e.value.objId});let t=z.travel.routes.iterator;for(;!t.done;)for(e=t.value.notes.iterator;!e.done;)xe.dispatch("removeobject",{objId:e.value.objId});if(_!==z.editedRouteObjId)for(e=z.travel.editedRoute.notes.iterator;!e.done;)xe.dispatch("removeobject",{objId:e.value.objId})}showNotes(){this.hideNotes();let e=z.travel.notes.iterator;for(;!e.done;)xe.dispatch("noteupdated",{removedNoteObjId:_,addedNoteObjId:e.value.objId});let t=z.travel.routes.iterator;for(;!t.done;)t.value.hidden||xe.dispatch("routeupdated",{removedRouteObjId:t.value.objId,addedRouteObjId:t.value.objId})}attachNoteToRoute(e){let t=Z.getNoteAndRoute(e).note,o=Z.getNearestRouteData(t.latLng);o.route&&(z.travel.notes.remove(e),t.distance=o.distance,t.latLng=o.latLngOnRoute,t.chainedDistance=o.route.chainedDistance,o.route.notes.add(t),o.route.notes.sort(((e,t)=>e.distance-t.distance)),xe.dispatch("noteupdated",{removedNoteObjId:e,addedNoteObjId:e}),xe.dispatch("updateitinerary"),xe.dispatch("updatetravelnotes"),xe.dispatch("roadbookupdate"))}detachNoteFromRoute(e){let t=Z.getNoteAndRoute(e);t.route.notes.remove(e),t.note.distance=n.invalid,t.note.chainedDistance=n.defaultValue,z.travel.notes.add(t.note),xe.dispatch("updateitinerary"),xe.dispatch("updatetravelnotes"),xe.dispatch("roadbookupdate")}travelNoteDropped(e,t,o){z.travel.notes.moveTo(e,t,o),xe.dispatch("updatetravelnotes"),xe.dispatch("roadbookupdate")}};class Nt{_myGpxString="";_timeStamp="";_route=null;_addHeader(){this._myGpxString='<?xml version="1.0"?>\n',this._myGpxString+='<gpx xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd" version="1.1" creator="leaflet.TravelNotes">'}_addWayPoints(){let e=this._route.wayPoints.iterator;for(;!e.done;)this._myGpxString+='\n\t<wpt lat="'+e.value.lat+'" lon="'+e.value.lng+'" '+this._timeStamp+"/>"}_addRoute(){this._myGpxString+="\n\t<rte>";let e=this._route.itinerary.maneuvers.iterator;for(;!e.done;){let t=this._route.itinerary.itineraryPoints.getAt(e.value.itineraryPointObjId),o=e.value.instruction.replaceAll(/\u0027/g,"&apos;").replaceAll(/"/g,"&quot;").replaceAll(/</g,"&lt;").replaceAll(/>/g,"&gt;");this._myGpxString+='\n\t\t<rtept lat="'+t.lat+'" lon="'+t.lng+'" '+this._timeStamp+'desc="'+o+'" />'}this._myGpxString+="\n\t</rte>"}_addTrack(){this._myGpxString+="\n\t<trk>",this._myGpxString+="\n\t\t<trkseg>";let e=this._route.itinerary.itineraryPoints.iterator;for(;!e.done;)this._myGpxString+='\n\t\t\t<trkpt lat="'+e.value.lat+'" lon="'+e.value.lng+'" '+this._timeStamp+" />";this._myGpxString+="\n\t\t</trkseg>",this._myGpxString+="\n\t</trk>"}_addFooter(){this._myGpxString+="\n</gpx>"}_saveGpxToFile(){let e=(""===z.travel.name?"":z.travel.name+" - ")+this._route.computedName;""===e&&(e="TravelNote"),e+=".gpx",P.saveFile(e,this._myGpxString,"application/xml")}constructor(){}routeToGpx(e){this._route=Z.getRoute(e),this._route&&(this._timeStamp='time="'+(new Date).toISOString()+'" ',this._addHeader(),this._addWayPoints(),this._addRoute(),this._addTrack(),this._addFooter(),this._saveGpxToFile())}}class xt{_red=t.maxColorValue;_green=t.maxColorValue;_blue=t.maxColorValue;constructor(e,o,n){this._red="number"==typeof e&&t.maxColorValue>=e&&t.minColorValue<=e?e:t.maxColorValue,this._green="number"==typeof o&&t.maxColorValue>=o&&t.minColorValue<=o?o:t.maxColorValue,this._blue="number"==typeof n&&t.maxColorValue>=n&&t.minColorValue<=n?n:t.maxColorValue}get red(){return this._red}set red(e){"number"==typeof e&&t.maxColorValue>=e&&t.minColorValue<=e&&(this._red=e)}get green(){return this._green}set green(e){"number"==typeof e&&t.maxColorValue>=e&&t.minColorValue<=e&&(this._green=e)}get blue(){return this._blue}set blue(e){"number"==typeof e&&t.maxColorValue>=e&&t.minColorValue<=e&&(this._blue=e)}get cssColor(){return"#"+this._red.toString(m).padStart(2,"0")+this._green.toString(m).padStart(2,"0")+this._blue.toString(m).padStart(2,"0")}set cssColor(e){"#"===e[0]?(this._red=Number.parseInt(e.substr(1,2),m),this._green=Number.parseInt(e.substr(3,2),m),this._blue=Number.parseInt(e.substr(5,2),m)):"rgb"===e.substr(0,3)&&([this._red,this._green,this._blue]=Array.from(e.match(/[0-9]{1,3}/g),(e=>Number.parseInt(e))))}clone(){return new xt(this._red,this._green,this._blue)}copyTo(e){e.red=this._red,e.green=this._green,e.blue=this._blue}}class Mt{_redSlider=null;_colorButtons=null;constructor(e,t){this._redSlider=e,this._colorButtons=t}destructor(){this._redSlider=null,this._colorButtons=null}handleEvent(e){e.stopPropagation();let o=new xt;o.red=Math.ceil(e.target.valueAsNumber*(t.maxColorValue/t.sliderMaxValue));for(let e=0;e<t.rowsNumber;++e){o.blue=e*t.deltaColor;for(let n=0;n<t.rowsNumber;++n)o.green=n*t.deltaColor,this._colorButtons[t.rowsNumber*e+n].style["background-color"]=o.cssColor}}}class Pt{_colorControl=null;_inputs=null;constructor(e,t){this._colorControl=e,this._inputs=t}destructor(){this._colorControl=null,this._inputs=null}handleEvent(e){e.stopPropagation();let t=new xt(Number.parseInt(this._inputs.red.value),Number.parseInt(this._inputs.green.value),Number.parseInt(this._inputs.blue.value));this._colorControl.color=t}}class Ct{_colorControl=null;constructor(e){this._colorControl=e}destructor(){this._colorControl=null}handleEvent(e){e.stopPropagation();let t=new xt;t.cssColor=e.target.style["background-color"],this._colorControl.color=t}}class jt{_colorDiv=null;_colorButtons=[];_inputs={red:null,green:null,blue:null};_redSliderInput=null;_rgbDiv=null;_colorSampleDiv=null;_newColor=new xt;_eventListeners={onColorButtonClick:null,onColorInput:null,onRedSliderInput:null};_createColorButtonsDiv(){let e=Y.create("div",null,this._colorDiv),o=new xt(t.initialRed,t.minColorValue,t.minColorValue);this._eventListeners.onColorButtonClick=new Ct(this);for(let n=0;n<t.rowsNumber;++n){let n=Y.create("div",null,e);o.green=t.minColorValue;for(let e=0;e<t.cellsNumber;++e){let e=Y.create("div",{className:"TravelNotes-ColorControl-CellColorDiv"},n);e.style["background-color"]=o.cssColor,e.addEventListener("click",this._eventListeners.onColorButtonClick,!1),o.green+=t.deltaColor,this._colorButtons.push(e)}o.blue+=t.deltaColor}}_createRedSliderDiv(){let e=Y.create("div",null,this._colorDiv);this._redSliderInput=Y.create("input",{type:"range",value:Math.ceil(t.initialRed*(t.sliderMaxValue/t.maxColorValue)),min:0,max:t.sliderMaxValue,step:t.sliderStep},e),this._eventListeners.onRedSliderInput=new Mt(this._redSliderInput,this._colorButtons),this._redSliderInput.addEventListener("input",this._eventListeners.onRedSliderInput,!1),this._redSliderInput.focus()}_createColorInput(e,o){Y.create("text",{value:e},this._rgbDiv);let n=Y.create("input",{type:"number",className:"TravelNotes-ColorControl-NumberInput",value:o,min:t.minColorValue,max:t.maxColorValue},this._rgbDiv);return n.addEventListener("input",this._eventListeners.onColorInput,!1),n}_createColorInputsDiv(){this._rgbDiv=Y.create("div",null,this._colorDiv),this._eventListeners.onColorInput=new Pt(this,this._inputs),this._inputs.red=this._createColorInput(M.getText("ColorControl - Red"),this._newColor.red),this._inputs.green=this._createColorInput(M.getText("ColorControl - Green"),this._newColor.green),this._inputs.blue=this._createColorInput(M.getText("ColorControl - Blue"),this._newColor.blue)}_createColorSampleDiv(){this._colorSampleDiv=Y.create("div",{id:"TravelNotes-ColorControl-ColorSampleDiv"},this._colorDiv),this._colorSampleDiv.style["background-color"]=this._newColor.cssColor}constructor(e){this._newColor.cssColor=e,this._colorDiv=Y.create("div",{id:"TravelNotes-ColorControl-ColorDiv"}),this._createColorButtonsDiv(),this._createRedSliderDiv(),this._createColorInputsDiv(),this._createColorSampleDiv()}destructor(){this._colorButtons.forEach((e=>{e.removeEventListener("click",this._eventListeners.onColorButtonClick,!1)})),this._eventListeners.onColorButtonClick.destructor();for(const e in this._inputs)this._inputs[e].removeEventListener("input",this._eventListeners.onColorInput,!1);this._eventListeners.onColorInput.destructor(),this._redSliderInput.removeEventListener("input",this._eventListeners.onRedSliderInput,!1),this._eventListeners.onRedSliderInput.destructor()}get HTMLElements(){return[this._colorDiv]}get cssColor(){return this._newColor.cssColor}set color(e){this._inputs.red.value=e.red,this._inputs.green.value=e.green,this._inputs.blue.value=e.blue,this._colorSampleDiv.style["background-color"]=e.cssColor,e.copyTo(this._newColor)}}class At extends le{_route=null;_colorControl=null;_nameInput=null;_widthInput=null;_dashSelect=null;_chainInput=null;_createNameDiv(){let e=Y.create("div",{textContent:M.getText("RoutePropertiesDialog - Name")}),t=Y.create("div",{className:"TravelNotes-RoutePropertiesDialog-DataDiv",id:"TravelNotes-RoutePropertiesDialog-NameInputDiv"});return this._nameInput=Y.create("input",{type:"text",id:"TravelNotes-RoutePropertiesDialog-NameInput",value:this._route.computedName},t),[e,t]}_createWidthDiv(){let e=Y.create("div",{className:"TravelNotes-RoutePropertiesDialog-DataDiv"});return Y.create("text",{value:M.getText("RoutePropertiesDialog - Width")},Y.create("span",null,e)),this._widthInput=Y.create("input",{type:"number",id:"TravelNotes-RoutePropertiesDialog-WidthInput",value:this._route.width,min:1,max:40},e),e}_createDashDiv(){let t=Y.create("div",{className:"TravelNotes-RoutePropertiesDialog-DataDiv"});Y.create("text",{value:M.getText("RoutePropertiesDialog - Linetype")},Y.create("span",null,t)),this._dashSelect=Y.create("select",null,t);let o=e.route.dashChoices;for(let e=0;e<o.length;e++)this._dashSelect.add(Y.create("option",{text:o[e].text}));return this._dashSelect.selectedIndex=this._route.dashArray<o.length?this._route.dashArray:0,t}_createChainDiv(){let e=Y.create("div",{className:"TravelNotes-RoutePropertiesDialog-DataDiv",id:"TravelNotes-RoutePropertiesDialog-ChainDiv"});return Y.create("text",{value:M.getText("RoutePropertiesDialog - Chained route")},Y.create("span",null,e)),this._chainInput=Y.create("input",{type:"checkbox",checked:this._route.chain},e),e}_createColorHeaderDiv(){return Y.create("div",{textContent:M.getText("RoutePropertiesDialog - Color"),id:"TravelNotes-RoutePropertiesDialog-ColorHeaderDiv"})}constructor(e){super(),this._route=e,this._colorControl=new jt(e.color)}onCancel(){this._colorControl.destructor(),super.onCancel()}onOk(){this._route.color=this._colorControl.cssColor,this._route.computedName!==this._nameInput.value&&(this._route.name=this._nameInput.value),this._route.width=parseInt(this._widthInput.value),this._route.chain=this._chainInput.checked,this._route.dashArray=this._dashSelect.selectedIndex,this._route.validateData(),this._colorControl.destructor(),super.onOk()}get title(){return M.getText("RoutePropertiesDialog - Route properties")}get contentHTMLElements(){return[].concat(this._createNameDiv(),this._createWidthDiv(),this._createDashDiv(),this._createChainDiv(),this._createColorHeaderDiv(),this._colorControl.HTMLElements)}}class St extends le{_paperWidthInput=null;_paperHeightInput=null;_borderWidthInput=null;_pageBreakInput=null;_printNotesInput=null;_zoomFactorInput=null;_createPaperWidthDiv(){let t=Y.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv"});return Y.create("text",{value:M.getText("PrintRouteMapDialog - Paper width")},t),this._paperWidthInput=Y.create("input",{type:"number",className:"TravelNotes-PrintRouteMapDialog-NumberInput"},t),this._paperWidthInput.value=e.printRouteMap.paperWidth,Y.create("text",{value:M.getText("PrintRouteMapDialog - Paper width units")},t),t}_createPaperHeightDiv(){let t=Y.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv"});return Y.create("text",{value:M.getText("PrintRouteMapDialog - Paper height")},t),this._paperHeightInput=Y.create("input",{type:"number",className:"TravelNotes-PrintRouteMapDialog-NumberInput",value:e.printRouteMap.paperHeight},t),Y.create("text",{value:M.getText("PrintRouteMapDialog - Paper height units")},t),t}_createBorderWidthDiv(){let t=Y.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv"});return Y.create("text",{value:M.getText("PrintRouteMapDialog - Border width")},t),this._borderWidthInput=Y.create("input",{type:"number",className:"TravelNotes-PrintRouteMapDialog-NumberInput",value:e.printRouteMap.borderWidth},t),Y.create("text",{value:M.getText("PrintRouteMapDialog - Border width units")},t),t}_createZoomFactorDiv(){let t=Y.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv"});return Y.create("text",{value:M.getText("PrintRouteMapDialog - Zoom factor")},t),this._zoomFactorInput=Y.create("input",{type:"number",className:"TravelNotes-PrintRouteMapDialog-NumberInput",value:Math.min(e.printRouteMap.zoomFactor,15),min:z.map.getMinZoom(),max:Math.min(z.map.getMaxZoom(),15)},t),t}_createPageBreakDiv(){let t=Y.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv"});return this._pageBreakInput=Y.create("input",{type:"checkbox",checked:e.printRouteMap.pageBreak},t),Y.create("text",{value:M.getText("PrintRouteMapDialog - Page break")},t),t}_createPrintNotesDiv(){let t=Y.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv"});return this._printNotesInput=Y.create("input",{type:"checkbox",checked:e.printRouteMap.printNotes},t),Y.create("text",{value:M.getText("PrintRouteMapDialog - Print notes")},t),t}constructor(e={}){super(e)}onOk(){super.onOk(Object.freeze({paperWidth:parseInt(this._paperWidthInput.value),paperHeight:parseInt(this._paperHeightInput.value),borderWidth:parseInt(this._borderWidthInput.value),zoomFactor:parseInt(this._zoomFactorInput.value),pageBreak:this._pageBreakInput.checked,printNotes:this._printNotesInput.checked}))}get contentHTMLElements(){return[this._createPaperWidthDiv(),this._createPaperHeightDiv(),this._createBorderWidthDiv(),this._createZoomFactorDiv(),this._createPageBreakDiv(),this._createPrintNotesDiv()]}get title(){return M.getText("PrintRouteMapDialog - Print")}}
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file FloatWindow.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/
class Ot{_dragData=null;constructor(e){this._dragData=e}handleEvent(e){this._dragData.dragStartX=e.screenX,this._dragData.dragStartY=e.screenY,e.dataTransfer.dropEffect="move",e.dataTransfer.effectAllowed="move"}}class kt{_dragData=null;_containerDiv=null;constructor(e){this._dragData=e}handleEvent(e){let t=e.target.parentNode;this._dragData.windowX+=e.screenX-this._dragData.dragStartX,this._dragData.windowY+=e.screenY-this._dragData.dragStartY,this._dragData.windowX=Math.min(Math.max(this._dragData.windowX,20),z.map.getContainer().clientWidth-t.clientWidth-20),this._dragData.windowY=Math.max(this._dragData.windowY,20);let o=z.map.getContainer().clientHeight-Math.max(this._dragData.windowY,0)-20;t.style.top=String(this._dragData.windowY)+"px",t.style.left=String(this._dragData.windowX)+"px",t.style["max-height"]=String(o)+"px"}}class Rt{_geometry=[];_pushNoteGeometry(e){this._geometry.push(e.latLng),this._geometry.push(e.iconLatLng)}_pushRouteGeometry(e){e.itinerary.itineraryPoints.forEach((e=>this._geometry.push(e.latLng))),e.notes.forEach((e=>this._pushNoteGeometry(e)))}constructor(){}zoomToLatLng(e){xe.dispatch("zoomto",{latLng:e})}zoomToManeuver(e){let t=z.travel.editedRoute.itinerary.maneuvers.getAt(e).itineraryPointObjId,o=z.travel.editedRoute.itinerary.itineraryPoints.getAt(t).latLng;xe.dispatch("zoomto",{latLng:o})}zoomToNote(e){this._geometry=[],this._pushNoteGeometry(Z.getNoteAndRoute(e).note),xe.dispatch("zoomto",{geometry:[this._geometry]})}zoomToRoute(e){this._geometry=[],this._pushRouteGeometry(Z.getRoute(e)),xe.dispatch("zoomto",{geometry:[this._geometry]})}zoomToTravel(){this._geometry=[],z.travel.routes.forEach((e=>this._pushRouteGeometry(e))),_!==z.travel.editedRouteObjId&&this._pushRouteGeometry(z.travel.editedRoute),z.travel.notes.forEach((e=>this._pushNoteGeometry(e))),xe.dispatch("zoomto",{geometry:[this._geometry]})}zoomToPoi(e){xe.dispatch("zoomto",e)}}class Ht extends Ye{constructor(e,t=null){super(e,t)}doAction(e){switch(e){case 0:ft.newRouteNote({routeObjId:this.eventData.targetObjId,lat:this.eventData.lat,lng:this.eventData.lng});break;case 1:(new Rt).zoomToLatLng([this.eventData.lat,this.eventData.lng])}}get menuItems(){return[{itemText:M.getText("ProfileContextMenu - Add a note to the route at this point"),isActive:!0},{itemText:M.getText("ProfileContextMenu - Zoom to this point"),isActive:!0}]}}
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file ProfileWindow.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/class Bt{constructor(){}getlatLngElevOnRouteAtMousePosition(e){let t=Z.getRoute(Number.parseInt(e.currentTarget.dataset.tanObjId)),o=e.currentTarget.getBoundingClientRect(),n=(e.clientX-o.x-d.margin/(2*d.margin+d.width)*o.width)/(d.width/(2*d.margin+d.width)*o.width)*t.distance;return 0<n&&n<t.distance?G.getLatLngElevAtDist(t,n):null}}class Ut extends Bt{constructor(){super()}handleEvent(e){e.preventDefault(),e.stopPropagation();let t=this.getlatLngElevOnRouteAtMousePosition(e);t&&(e.latlng={lat:t.latLng[0],lng:t.latLng[1]},new Ht(e).show())}}class Kt{constructor(){}handleEvent(e){e.preventDefault(),e.stopPropagation(),xe.dispatch("removeobject",{objId:Number.parseInt(e.currentTarget.dataset.tanMarkerObjId)})}}class Ft extends Bt{constructor(){super()}_marker=null;_distanceText=null;_elevText=null;_ascentText=null;_textAnchor=null;_markerX=null;_profileSvg=null;_createSvgText(e,t){let o=document.createElementNS(y,"text");return o.appendChild(document.createTextNode(e)),o.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-elevText"),o.setAttributeNS(null,"x",this._markerX),o.setAttributeNS(null,"y",t),o.setAttributeNS(null,"text-anchor",this._textAnchor),this._profileSvg.appendChild(o),o}handleEvent(e){e.preventDefault(),e.stopPropagation(),this._profileSvg=e.currentTarget;let t=this.getlatLngElevOnRouteAtMousePosition(e);if(t){let o=Number.parseInt(this._profileSvg.dataset.tanMarkerObjId);xe.dispatch("removeobject",{objId:o}),xe.dispatch("additinerarypointmarker",{objId:o,latLng:t.latLng}),this._marker&&(this._profileSvg.removeChild(this._marker),this._profileSvg.removeChild(this._distanceText),this._profileSvg.removeChild(this._elevText),this._profileSvg.removeChild(this._ascentText));let n=this._profileSvg.getBoundingClientRect();this._markerX=(2*d.margin+d.width)*(e.clientX-n.x)/n.width;let a=d.margin+d.height;this._marker=document.createElementNS(y,"polyline"),this._marker.setAttributeNS(null,"points",String(this._markerX)+","+d.margin+" "+this._markerX+","+a),this._marker.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-markerPolyline"),this._profileSvg.appendChild(this._marker);let s=Z.getRoute(Number.parseInt(this._profileSvg.dataset.tanObjId));this._textAnchor=t.routeDistance>s.distance/2?"end":"start",this._markerX+=t.routeDistance>s.distance/2?-d.xDeltaText:d.xDeltaText,this._distanceText=this._createSvgText(P.formatDistance(t.routeDistance),d.margin+d.yDeltaText),this._elevText=this._createSvgText("Alt. "+t.elev.toFixed(0)+" m.",d.margin+2*d.yDeltaText),this._ascentText=this._createSvgText("Pente "+t.ascent.toFixed(0)+" % ",d.margin+3*d.yDeltaText)}}}class Vt extends class{_dragData=Object.seal({dragStartX:0,dragStartY:0,windowX:0,windowY:0});_containerDiv=null;_topBar=null;_headerDiv=null;_contentDiv=null;_eventListeners={onTopBarDragStart:null,onTopBarDragEnd:null};_createContainerDiv(){this._containerDiv=Y.create("div",{className:"TravelNotes-FloatWindow-Container"},document.body)}_createTopBar(){this._topBar=Y.create("div",{className:"TravelNotes-FloatWindow-TopBar",draggable:!0},this._containerDiv),this._topBar.addEventListener("dragstart",this._eventListeners.onTopBarDragStart,!1),this._topBar.addEventListener("dragend",this._eventListeners.onTopBarDragEnd,!1),Y.create("div",{textContent:"âŒ",className:"TravelNotes-FloatWindow-CancelButton",title:M.getText("FloatWindow - Close")},this._topBar).addEventListener("click",(()=>this.close()),!1)}_createHeaderDiv(){this._headerDiv=Y.create("div",{className:"TravelNotes-FloatWindow-HeaderDiv"},this._containerDiv)}_createContentDiv(){this._contentDiv=Y.create("div",{className:"TravelNotes-FloatWindow-ContentDiv"},this._containerDiv)}constructor(){this._eventListeners.onTopBarDragStart=new Ot(this._dragData),this._eventListeners.onTopBarDragEnd=new kt(this._dragData),this._createContainerDiv(),this._createTopBar(),this._createHeaderDiv(),this._createContentDiv()}close(){this._topBar.removeEventListener("dragstart",this._eventListeners.onTopBarDragStart,!1),this._topBar.removeEventListener("dragend",this._eventListeners.onTopBarDragEnd,!1),this._eventListeners.onTopBarDragStart=null,this._eventListeners.onTopBarDragEnd=null,document.body.removeChild(this._containerDiv)}update(){}get header(){return this._headerDiv}get content(){return this._contentDiv}}{_svg=null;_ascentDiv=null;_route=null;_eventListeners={onSvgContextMenu:null,onSvgMouseMove:null,onSvgMouseLeave:null};_markerObjId=L.nextObjId;_clean(){this._svg&&(this._svg.removeEventListener("contextmenu",this._eventListeners.onSvgContextMenu,!1),this._svg.removeEventListener("mousemove",this._eventListeners.onSvgMouseMove,!1),this._svg.removeEventListener("mouseleave",this._eventListeners.onSvgMouseLeave,!1),xe.dispatch("removeobject",{objId:this._markerObjId}),this.content.removeChild(this._ascentDiv),this.content.removeChild(this._svg)),this._svg=null,this._ascentDiv=null}constructor(){super(),this._eventListeners.onSvgContextMenu=new Ut,this._eventListeners.onSvgMouseMove=new Ft,this._eventListeners.onSvgMouseLeave=new Kt}close(){this._clean(),xe.dispatch("profileclosed",{objId:this._route.objId}),super.close()}update(e){this._clean(),this._route=e,this._svg=(new He).createSvg(this._route),this._svg.dataset.tanObjId=e.objId,this._svg.dataset.tanMarkerObjId=this._markerObjId,this.header.textContent=M.getText("ProfileWindow - Profile {name}",{name:this._route.computedName}),this.content.appendChild(this._svg),this._svg.addEventListener("contextmenu",this._eventListeners.onSvgContextMenu,!1),this._svg.addEventListener("mousemove",this._eventListeners.onSvgMouseMove,!1),this._svg.addEventListener("mouseleave",this._eventListeners.onSvgMouseLeave,!1),this._ascentDiv=Y.create("div",{className:"TravelNotes-ProfileWindow-Ascent",textContent:M.getText("ProfileWindow - Ascent: {ascent} m. - Descent: {descent} m. - Distance: {distance}",{ascent:this._route.itinerary.ascent.toFixed(0),descent:this._route.itinerary.descent.toFixed(0),distance:P.formatDistance(this._route.distance)})}),this.content.appendChild(this._ascentDiv)}}const Wt=new class{_profileWindows=new Map;constructor(){}createProfile(t){let o=this._profileWindows.get(t.objId);if(t.itinerary.hasProfile){e.route.elev.smooth&&(new He).smooth(t),t.itinerary.ascent=0,t.itinerary.descent=0;let n=t.itinerary.itineraryPoints.first.elev;t.itinerary.itineraryPoints.forEach((e=>{let o=e.elev-n;0>o?t.itinerary.descent-=o:t.itinerary.ascent+=o,n=e.elev})),o&&o.update(t)}else o&&o.close()}updateProfile(e,t){let o=this._profileWindows.get(e);o&&(this._profileWindows.delete(e),t&&t.itinerary.hasProfile?(o.update(t),this._profileWindows.set(t.objId,o)):o.close())}deleteProfile(e){let t=this._profileWindows.get(e);t&&t.close()}deleteAllProfiles(){this._profileWindows.forEach((e=>e.close()))}showProfile(e){let t=this._profileWindows.get(e);t||(t=new Vt);let o=Z.getRoute(e);t.update(o),this._profileWindows.set(e,t)}onProfileClosed(e){this._profileWindows.delete(e)}},zt=1e-6;class Gt{_views=[];_route=null;_printSize=null;_isItineraryHorOrVer(e,t,o){return t.lng===o.lng?{lat:t.lat>o.lat?e.bottomLeft.lat:e.upperRight.lat,lng:t.lng}:t.lat===o.lat?{lat:t.lat,lng:t.lng<o.lng?e.upperRight.lng:e.bottomLeft.lng}:null}_isFirstPointOnView(e,t){return t.lat-e.bottomLeft.lat<zt||e.upperRight.lat-t.lat<zt||t.lng-e.bottomLeft.lng<zt||e.upperRight.lng-t.lng<zt?{lat:t.lat,lng:t.lng}:null}_haveViewOnlyOnePoint(e,t,o){if(e.bottomLeft.lat===e.upperRight.lat&&e.bottomLeft.lng===e.upperRight.lng){let e=Math.min(Math.abs(this._printSize[0]/(o.lat-t.lat)),Math.abs(this._printSize[1]/(o.lng-t.lng)));return{lat:t.lat+e*(o.lat-t.lat),lng:t.lng+e*(o.lng-t.lng)}}return null}_computeIntermediatePoint(e,t,o){let n=this._haveViewOnlyOnePoint(e,t,o);if(n)return n;if(n=this._isFirstPointOnView(e,t),n)return n;if(n=this._isItineraryHorOrVer(e,t,o),n)return n;let a=(t.lat-o.lat)/(t.lng-o.lng),s=t.lat-a*t.lng;if(n={lat:a*e.upperRight.lng+s,lng:e.upperRight.lng},n.lat<=e.upperRight.lat&&n.lat>=e.bottomLeft.lat&&n.lng<o.lng)return n;if(n={lat:e.upperRight.lat,lng:(e.upperRight.lat-s)/a},n.lng>=e.bottomLeft.lng&&n.lng<=e.upperRight.lng&&n.lat<o.lat)return n;if(n={lat:a*e.bottomLeft.lng+s,lng:e.bottomLeft.lng},n.lat<=e.upperRight.lat&&n.lat>=e.bottomLeft.lat&&n.lng>o.lng)return n;if(n={lat:e.bottomLeft.lat,lng:(e.bottomLeft.lat-s)/a},n.lng>=e.bottomLeft.lng&&n.lng<=e.upperRight.lng&&n.lat>o.lat)return n;throw new Error("intermediate point not found")}_computeViews(){this._views=[];let e=this._route.itinerary.itineraryPoints.iterator,t=e.done,o={bottomLeft:{lat:e.value.lat,lng:e.value.lng},upperRight:{lat:e.value.lat,lng:e.value.lng}},n={lat:e.value.lat,lng:e.value.lng},a=e.value;t=e.done;let s=e.value;for(;!t;){let i={bottomLeft:{lat:Math.min(o.bottomLeft.lat,s.lat),lng:Math.min(o.bottomLeft.lng,s.lng)},upperRight:{lat:Math.max(o.upperRight.lat,s.lat),lng:Math.max(o.upperRight.lng,s.lng)}},r=[i.upperRight.lat-i.bottomLeft.lat,i.upperRight.lng-i.bottomLeft.lng];this._printSize[0]>r[0]&&this._printSize[1]>r[1]?(o=i,a=e.value,t=e.done,s=e.value,t&&(o.entryPoint=n,o.exitPoint=a,this._views.push(o))):(a=this._computeIntermediatePoint(o,a,s),o.bottomLeft={lat:Math.min(o.bottomLeft.lat,a.lat),lng:Math.min(o.bottomLeft.lng,a.lng)},o.upperRight={lat:Math.max(o.upperRight.lat,a.lat),lng:Math.max(o.upperRight.lng,a.lng)},o.entryPoint=n,o.exitPoint=a,this._views.push(o),o={bottomLeft:{lat:a.lat,lng:a.lng},upperRight:{lat:a.lat,lng:a.lng}},n={lat:a.lat,lng:a.lng})}}constructor(e,t){this._route=e,this._printSize=t,this._computeViews()}get views(){return this._views}}class Xt{_name=null;_service=null;_url=null;_wmsOptions=null;_bounds=null;_minZoom=null;_maxZoom=null;_toolbar=null;_providerName=null;_providerKeyNeeded=!1;_attribution=null;_getCapabilitiesUrl=null;constructor(e){if(!e.name||"string"!=typeof e.name)throw new Error("invalid name for layer");if(this._name=x.sanitizeToJsString(e.name),!e.service||"wms"!==e.service&&"wmts"!==e.service)throw new Error("invalid service for layer "+this._name);if(this._service=e.service,!e.url||"string"!=typeof e.url)throw new Error("invalid url for layer "+this._name);if(this._url=e.url,"wms"===this._service){if(!(e.wmsOptions&&e.wmsOptions.layers&&"string"==typeof e.wmsOptions.layers&&e.wmsOptions.format&&"string"==typeof e.wmsOptions.format&&e.wmsOptions.transparent&&"boolean"==typeof e.wmsOptions.transparent))throw new Error("invalid wmsOptions for layer "+this._name);this._wmsOptions=e.wmsOptions,this._wmsOptions.layers=x.sanitizeToJsString(this._wmsOptions.layers),this._wmsOptions.format=x.sanitizeToJsString(this._wmsOptions.format)}try{e.bounds&&"number"==typeof e.bounds[0][0]&&"number"==typeof e.bounds[0][1]&&"number"==typeof e.bounds[1][0]&&"number"==typeof e.bounds[1][1]&&(this._bounds=e.bounds)}catch(e){throw new Error("invalid bounds for layer "+this._name)}if(e.minZoom&&"number"==typeof e.minZoom&&(this._minZoom=e.minZoom),e.maxZoom&&"number"==typeof e.maxZoom&&(this._maxZoom=e.maxZoom),!(e.toolbar&&e.toolbar.text&&"string"==typeof e.toolbar.text&&e.toolbar.color&&"string"==typeof e.toolbar.color&&e.toolbar.backgroundColor&&"string"==typeof e.toolbar.backgroundColor))throw new Error("invalid toolbar for layer "+this._name);if(this._toolbar=e.toolbar,this._toolbar.text=x.sanitizeToJsString(this._toolbar.text),this._toolbar.color=x.sanitizeToColor(this._toolbar.color)||"#000000",this._toolbar.backgroundColor=x.sanitizeToColor(this._toolbar.backgroundColor)||"#ffffff",!e.providerName||"string"!=typeof e.providerName)throw new Error("invalid providerName for layer "+this._name);if(this._providerName=x.sanitizeToJsString(e.providerName),"boolean"!=typeof e.providerKeyNeeded)throw new Error("invalid providerKeyNeeded for layer "+this._name);if(this._providerKeyNeeded=e.providerKeyNeeded,""===e.attribution)this._attribution="";else{if(!e.attribution||"string"!=typeof e.attribution)throw new Error("invalid attribution for map layer "+this._name);this._attribution=x.sanitizeToHtmlString(e.attribution).htmlString}if(e.getCapabilitiesUrl&&"string"==typeof e.getCapabilitiesUrl&&(this._getCapabilitiesUrl=x.sanitizeToUrl(e.getCapabilitiesUrl).url,""===this._getCapabilitiesUrl))throw new Error("invalid getCapabilitiesUrl for map layer "+this._name)}get name(){return this._name}get service(){return this._service}get url(){return this._url}get wmsOptions(){return this._wmsOptions}get bounds(){return this._bounds}get minZoom(){return this._minZoom}get maxZoom(){return this._maxZoom}get toolbar(){return this._toolbar}get providerName(){return this._providerName}get providerKeyNeeded(){return this._providerKeyNeeded}get attribution(){return this._attribution}get getCapabilitiesUrl(){return this._getCapabilitiesUrl}}const Zt=new class{_mapLayers=new Map;_defaultMapLayer=null;_mapLayersAdded=!1;constructor(){this._defaultMapLayer=new Xt({service:"wmts",url:"https://{s}.tile.osm.org/{z}/{x}/{y}.png",name:"OSM - Color",toolbar:{text:"OSM",color:"#ff0000",backgroundColor:"#ffffff"},providerName:"OSM",providerKeyNeeded:!1,attribution:""}),this._mapLayers.set(this._defaultMapLayer.name,this._defaultMapLayer)}getMapLayer(e){let t=this._mapLayers.get(e)||this._defaultMapLayer;return t.providerKeyNeeded&&(Pe.hasKey(t.providerName.toLowerCase())||(t=this._defaultMapLayer)),t}forEach(e){this._mapLayers.forEach(e)}addMapLayers(e){this._mapLayersAdded||(e.forEach((e=>{let t=new Xt(e);this._mapLayers.get(t.name)||this._mapLayers.set(t.name,t)})),this._mapLayersAdded=!0)}get defaultMapLayer(){return this._defaultMapLayer}};class Yt{handleEvent(){window.print()}}class Jt{_printPageBuilder=null;constructor(e){this._printPageBuilder=e}handleEvent(){this._printPageBuilder.onAfterPrint(),this._printPageBuilder=null}}class qt{_printData=null;_route=null;_views=[];_printToolbar=null;_printButton=null;_cancelButton=null;_viewsCounter=0;_viewsDiv=[];_routePolyline=null;_eventsListeners={onPrint:null,onAfterPrint:null};onAfterPrint(){this._viewsDiv.forEach((e=>document.body.removeChild(e))),this._viewsDiv.length=0,this._printButton.removeEventListener("click",this._eventsListeners.onPrint,!1),this._cancelButton.removeEventListener("click",this._eventsListeners.onAfterPrint,!1),document.body.removeChild(this._printToolbar);let e=document.body.children;for(let t=0;t<e.length;t++)e.item(t).classList.remove("TravelNotes-Hidden");z.map.invalidateSize(!1),document.title="Travel & Notes"+(""===z.travel.name?"":" - "+z.travel.name),window.removeEventListener("afterprint",this._eventsListeners.onAfterPrint,!0),this._eventsListeners.onAfterPrint=null,this._eventsListeners.onPrint=null}_getMapLayer(){let e=Zt.getMapLayer(z.travel.layerName),t=Pe.getUrl(e),o=null;return o="wmts"===e.service.toLowerCase()?window.L.tileLayer(t):window.L.tileLayer.wms(t,e.wmsOptions),o.options.attribution=x.sanitizeToHtmlString(' Â© <a href="https://www.openstreetmap.org/copyright" target="_blank" title="OpenStreetMap contributors">OpenStreetMap contributors</a> '+e.attribution+'| Â© <a href="https://github.com/wwwouaiebe" target="_blank" title="https://github.com/wwwouaiebe">Travel & Notes</a> ').htmlString,o}_getNotesMarkers(){let e=[];return this._route.notes.forEach((t=>{let o=window.L.divIcon({iconSize:[t.iconWidth,t.iconHeight],iconAnchor:[t.iconWidth/2,t.iconHeight/2],popupAnchor:[0,-t.iconHeight/2],html:t.iconContent,className:"TravelNotes-Map-AllNotes "}),n=window.L.marker(t.iconLatLng,{zIndexOffset:100,icon:o,draggable:!0});e.push(n)})),e}_createViewOnPage(t){this._viewsCounter++;let o="TravelNotes-RouteViewDiv"+this._viewsCounter,n=document.createElement("div");n.className="TravelNotes-routeViewDiv",n.id=o,document.body.appendChild(n),this._viewsDiv.push(n),this._printData.pageBreak&&n.classList.add("TravelNotes-PrintPageBreak"),n.style.width=String(this._printData.paperWidth)+"mm",n.style.height=String(this._printData.paperHeight)+"mm";let a=this._printData.printNotes?this._getNotesMarkers():[];a.push(this._getMapLayer()),a.push(window.L.circleMarker([t.entryPoint.lat,t.entryPoint.lng],e.printRouteMap.entryPointMarker)),a.push(window.L.circleMarker([t.exitPoint.lat,t.exitPoint.lng],e.printRouteMap.exitPointMarker)),a.push(this._routePolyline),window.L.map(o,{attributionControl:!0,zoomControl:!1,center:[(t.bottomLeft.lat+t.upperRight.lat)/2,(t.bottomLeft.lng+t.upperRight.lng)/2],zoom:this._printData.zoomFactor,minZoom:this._printData.zoomFactor,maxZoom:this._printData.zoomFactor,layers:a})}_createToolbar(){this._printToolbar=Y.create("div",{id:"TravelNotes-PrintToolbar"},document.body),this._printButton=Y.create("div",{className:"TravelNotes-UI-Button",title:M.getText("PrintPageBuilder - Print"),textContent:"ðŸ–¨ï¸"},this._printToolbar),this._printButton.addEventListener("click",this._eventsListeners.onPrint,!1),this._cancelButton=Y.create("div",{className:"TravelNotes-UI-Button",title:M.getText("PrintPageBuilder - Cancel print"),textContent:"âŒ"},this._printToolbar),this._cancelButton.addEventListener("click",this._eventsListeners.onAfterPrint,!1)}constructor(e,t,o){this._route=e,this._views=t,this._printData=o,this._eventsListeners.onPrint=new Yt,this._eventsListeners.onAfterPrint=new Jt(this)}preparePage(){let e=document.body.children;for(let t=0;t<e.length;t++)e.item(t).classList.add("TravelNotes-Hidden");document.title=""===z.travel.name?"maps":z.travel.name+" - "+this._route.computedName+" - maps",this._createToolbar(),window.addEventListener("afterprint",this._eventsListeners.onAfterPrint,!0);let t=[],o=this._route.itinerary.itineraryPoints.iterator;for(;!o.done;)t.push(o.value.latLng);this._routePolyline=window.L.polyline(t,{color:this._route.color,weight:this._route.width}),this._viewsCounter=0,this._views.forEach((e=>this._createViewOnPage(e)))}}class Qt{_tilesPerPage=0;_computeViewSize(e){let t=Y.create("div",{},document.body);t.style.position="absolute",t.style.top="0",t.style.left="0",t.style.width=String(e.paperWidth-2*e.borderWidth)+"mm",t.style.height=String(e.paperHeight-2*e.borderWidth)+"mm",this._tilesPerPage=Math.ceil(t.clientWidth/256)*Math.ceil(t.clientHeight/256);let o=G.screenCoordToLatLng(0,0),n=G.screenCoordToLatLng(t.clientWidth,t.clientHeight);document.body.removeChild(t);let a=z.map.getZoomScale(z.map.getZoom(),e.zoomFactor);return[Math.abs(o[0]-n[0])*a,Math.abs(o[1]-n[1])*a]}constructor(){}print(t,o){let n=Z.getRoute(o);if(!n)return;let a=new Gt(n,this._computeViewSize(t));e.printRouteMap.maxTiles<a.views.length*this._tilesPerPage?Me.showError(M.getText("RoutePrinter - The maximum of allowed pages is reached.")):new qt(n,a.views,t).preparePage()}}const $t=new class{constructor(){}addRoute(){let e=new F;z.travel.routes.add(e),l.editedChanged===z.travel.editedRoute.editionStatus?(this.chainRoutes(),xe.dispatch("setrouteslist"),xe.dispatch("roadbookupdate")):this.editRoute(e.objId)}editRoute(e){let t=Z.getRoute(e),o=t.itinerary.provider,n=z.providers.get(o.toLowerCase());if(o&&""!==o&&(!n||n.providerKeyNeeded&&!Pe.hasKey(o)))return void Me.showError(M.getText("RouteEditor - Not possible to edit a route created with this provider",{provider:o}));_!==z.editedRouteObjId&&this.cancelEdition(),o&&""!==o&&xe.dispatch("setprovider",{provider:o});let a=t.itinerary.transitMode;a&&""!==a&&xe.dispatch("settransitmode",{transitMode:a}),z.travel.editedRoute=new F,t.editionStatus=l.editedNoChange,z.travel.editedRoute.jsonObject=t.jsonObject,z.editedRouteObjId=t.objId,z.travel.editedRoute.hidden=!1,t.hidden=!1,Wt.updateProfile(z.editedRouteObjId,z.travel.editedRoute),this.chainRoutes(),xe.dispatch("routeupdated",{removedRouteObjId:t.objId,addedRouteObjId:z.travel.editedRoute.objId}),xe.dispatch("roadbookupdate"),xe.dispatch("showitinerary"),xe.dispatch("setrouteslist")}removeRoute(e){let t=e;t!==z.editedRouteObjId&&t!==z.travel.editedRoute.objId||(t=z.editedRouteObjId,this.cancelEdition()),xe.dispatch("routeupdated",{removedRouteObjId:t,addedRouteObjId:_}),z.travel.routes.remove(t),Wt.deleteProfile(t),this.chainRoutes(),xe.dispatch("roadbookupdate"),xe.dispatch("setrouteslist")}saveGpx(e){(new Nt).routeToGpx(e)}chainRoutes(){let e=z.travel.routes.iterator,t=n.defaultValue;for(;!e.done;){e.value.chain?(e.value.chainedDistance=t,t+=e.value.distance):e.value.chainedDistance=n.defaultValue;let o=e.value.notes.iterator;for(;!o.done;)o.value.chainedDistance=e.value.chainedDistance}}saveEdition(){let e=new F;e.jsonObject=z.travel.editedRoute.jsonObject,z.travel.routes.replace(z.editedRouteObjId,e),z.editedRouteObjId=e.objId,this.cancelEdition()}cancelEdition(){let e=Z.getRoute(z.editedRouteObjId);e.editionStatus=l.notEdited,Wt.updateProfile(z.travel.editedRoute.objId,e),xe.dispatch("routeupdated",{removedRouteObjId:z.travel.editedRoute.objId,addedRouteObjId:z.editedRouteObjId}),z.editedRouteObjId=_,z.travel.editedRoute=new F,this.chainRoutes(),xe.dispatch("roadbookupdate"),xe.dispatch("setrouteslist"),xe.dispatch("showitinerary")}routeProperties(e){let t=Z.getRoute(e);new At(t).show().then((()=>{this.chainRoutes(),t.haveValidWayPoints()&&xe.dispatch("routepropertiesupdated",{routeObjId:t.objId}),xe.dispatch("roadbookupdate"),xe.dispatch("setrouteslist"),xe.dispatch("updateitinerary")})).catch((e=>{e instanceof Error&&console.error(e)}))}printRouteMap(e){(new St).show().then((t=>(new Qt).print(t,e))).catch((e=>{e instanceof Error&&console.error(e)}))}showRoute(e){Z.getRoute(e).hidden=!1,xe.dispatch("routeupdated",{removedRouteObjId:_,addedRouteObjId:e}),xe.dispatch("setrouteslist")}hideRoute(e){Z.getRoute(e).hidden=!0,xe.dispatch("routeupdated",{removedRouteObjId:e,addedRouteObjId:_}),xe.dispatch("setrouteslist")}showRoutes(){let e=z.travel.routes.iterator;for(;!e.done;)e.value.hidden&&(e.value.hidden=!1,xe.dispatch("routeupdated",{removedRouteObjId:_,addedRouteObjId:e.value.objId}));xe.dispatch("setrouteslist")}hideRoutes(){let e=z.travel.routes.iterator;for(;!e.done;)e.value.hidden||e.value.objId===z.editedRouteObjId||(e.value.hidden=!0,xe.dispatch("routeupdated",{removedRouteObjId:e.value.objId,addedRouteObjId:_}));xe.dispatch("setrouteslist")}};class eo extends le{_wayPoint=null;_addressInput=null;_resetAddressButton=null;_nameInput=null;async handleEvent(t){if(t.stopPropagation(),!e.wayPoint.reverseGeocoding)return;this.showWait();let o=new ht,n=await o.getAddressAsync(this._wayPoint.latLng);if(this.hideWait(),n.statusOk){e.wayPoint.geocodingIncludeName&&(this._nameInput.value=n.name);let t=n.street;""!==n.city&&(t+=" "+n.city),this._addressInput.value=t}}_createAddressControl(){let e=Y.create("div");this._resetAddressButton=Y.create("div",{className:"TravelNotes-BaseDialog-Button",title:M.getText("WayPointPropertiesDialog - Reset address"),textContent:"ðŸ”„"},e),this._resetAddressButton.addEventListener("click",this,!1),Y.create("text",{value:M.getText("WayPointPropertiesDialog - Address")},e);let t=Y.create("div");return this._addressInput=Y.create("input",{type:"text",value:this._wayPoint.address,className:"TravelNotes-WayPointPropertiesDialog-Input"},t),[e,t]}_createNameControl(){let e=Y.create("div",{textContent:M.getText("WayPointPropertiesDialog - Name")}),t=Y.create("div");return this._nameInput=Y.create("input",{type:"text",value:this._wayPoint.name,className:"TravelNotes-WayPointPropertiesDialog-Input"},t),[e,t]}constructor(e){super(),this._wayPoint=e}onCancel(){this._resetAddressButton.removeEventListener("click",this,!1),super.onCancel()}onOk(){this._wayPoint.address=this._addressInput.value,this._wayPoint.name=this._nameInput.value,this._resetAddressButton.removeEventListener("click",this,!1),super.onOk()}get contentHTMLElements(){return[].concat(this._createNameControl(),this._createAddressControl())}get title(){return M.getText("WayPointPropertiesDialog - Waypoint properties")}}const to=new class{_routingRequestStarted=!1;_zoomToRouteAfterRouting=!1;_computeRouteDistances(e){let t=e.itinerary.itineraryPoints.iterator,o=e.itinerary.maneuvers.iterator;for(t.done,o.done,o.value.distance=n.defaultValue,o.done,e.distance=n.defaultValue,e.duration=n.defaultValue;!t.done;)t.previous.distance=X.pointsDistance(t.previous.latLng,t.value.latLng),e.distance+=t.previous.distance,o.previous.distance+=t.previous.distance,o.value.itineraryPointObjId===t.value.objId&&(e.duration+=o.previous.duration,o.value.distance=n.defaultValue,o.next&&o.value.itineraryPointObjId===o.next.itineraryPointObjId&&(o.done,o.value.distance=n.defaultValue),o.done)}_onRoutingError(e){this._routingRequestStarted=!1,Me.showError(e),e instanceof Error&&console.error(e)}_onRoutingOk(){this._routingRequestStarted=!1,z.travel.editedRoute.itinerary.validateData();let e=z.travel.editedRoute.itinerary.maneuvers.iterator;for(;!e.done;)e.value.validateData();let t=z.travel.editedRoute.itinerary.itineraryPoints.iterator;for(;!t.done;)t.value.validateData();if(this._computeRouteDistances(z.travel.editedRoute),"circle"!==z.travel.editedRoute.itinerary.transitMode){let e=z.travel.editedRoute.wayPoints.iterator;for(;!e.done;)e.first?e.value.latLng=z.travel.editedRoute.itinerary.itineraryPoints.first.latLng:e.last?e.value.latLng=z.travel.editedRoute.itinerary.itineraryPoints.last.latLng:e.value.latLng=G.getClosestLatLngDistance(z.travel.editedRoute,e.value.latLng).latLng}let o=z.travel.editedRoute.notes.iterator;for(;!o.done;){let e=G.getClosestLatLngDistance(z.travel.editedRoute,o.value.latLng);o.value.latLng=e.latLng,o.value.distance=e.distance}$t.chainRoutes(),z.travel.editedRoute.notes.sort(((e,t)=>e.distance-t.distance)),this._zoomToRouteAfterRouting&&(new Rt).zoomToRoute(z.travel.editedRoute.objId),Wt.createProfile(z.travel.editedRoute),xe.dispatch("routeupdated",{removedRouteObjId:z.travel.editedRoute.objId,addedRouteObjId:z.travel.editedRoute.objId}),xe.dispatch("roadbookupdate"),xe.dispatch("showitinerary"),xe.dispatch("setrouteslist")}constructor(){}startRouting(){if(!this._routingRequestStarted&&z.travel.editedRoute.haveValidWayPoints()){this._zoomToRouteAfterRouting=0===z.travel.editedRoute.itinerary.itineraryPoints.length,this._routingRequestStarted=!0;let e=z.providers.get(z.routing.provider.toLowerCase());z.travel.editedRoute.itinerary.provider=e.name,z.travel.editedRoute.itinerary.transitMode=z.routing.transitMode,e.getPromiseRoute(z.travel.editedRoute).then((()=>this._onRoutingOk())).catch((()=>this._onRoutingError()))}}};const oo=new class{_renameWayPoint(e,t){let o=z.travel.editedRoute.wayPoints.getAt(t);o?(z.travel.editedRoute.editionStatus=l.editedChanged,o.name=e.name,o.address=e.address,xe.dispatch("setrouteslist"),xe.dispatch("showitinerary"),xe.dispatch("roadbookupdate")):console.error("waypoint not found")}async _renameWayPointWithGeocoder(t,o){if(!e.wayPoint.reverseGeocoding)return xe.dispatch("setrouteslist"),xe.dispatch("showitinerary"),void xe.dispatch("roadbookupdate");let n=await(new ht).getAddressAsync(t);if(n.statusOk){let t=n.street;""!==n.city&&(t+=" "+n.city);let a="";e.wayPoint.geocodingIncludeName&&(a=n.name),this._renameWayPoint(Object.seal({name:a,address:t}),o)}}constructor(){}addWayPoint(e){z.travel.editedRoute.editionStatus=l.editedChanged;let t=new j;t.latLng=e,z.travel.editedRoute.wayPoints.add(t),this._renameWayPointWithGeocoder(e,t.objId),xe.dispatch("addwaypoint",{wayPoint:z.travel.editedRoute.wayPoints.last,letter:z.travel.editedRoute.wayPoints.length-2}),z.travel.editedRoute.wayPoints.swap(t.objId,!0),to.startRouting()}addWayPointOnRoute(e,t){let o=G.getClosestLatLngDistance(z.travel.editedRoute,e).distance;z.travel.editedRoute.editionStatus=l.editedChanged;let n=new j;n.latLng=t;let a="",s=z.travel.editedRoute.wayPoints.iterator;for(;!s.done;){if(o<G.getClosestLatLngDistance(z.travel.editedRoute,s.value.latLng).distance){a=String(s.index),z.travel.editedRoute.wayPoints.add(n),z.travel.editedRoute.wayPoints.moveTo(n.objId,s.value.objId,!0),this._renameWayPointWithGeocoder(t,n.objId),xe.dispatch("addwaypoint",{wayPoint:n,letter:a}),to.startRouting();break}}}reverseWayPoints(){z.travel.editedRoute.editionStatus=l.editedChanged;let e=z.travel.editedRoute.wayPoints.iterator;for(;!e.done;)xe.dispatch("removeobject",{objId:e.value.objId});for(z.travel.editedRoute.wayPoints.reverse(),e=z.travel.editedRoute.wayPoints.iterator;!e.done;)xe.dispatch("addwaypoint",{wayPoint:e.value,letter:e.first?"A":e.last?"B":e.index});xe.dispatch("setrouteslist"),xe.dispatch("showitinerary"),xe.dispatch("roadbookupdate"),to.startRouting()}removeWayPoint(e){z.travel.editedRoute.editionStatus=l.editedChanged,xe.dispatch("removeobject",{objId:e}),z.travel.editedRoute.wayPoints.remove(e),to.startRouting()}setStartPoint(e){z.travel.editedRoute.editionStatus=l.editedChanged,r.defaultValue!==z.travel.editedRoute.wayPoints.first.lat&&xe.dispatch("removeobject",{objId:z.travel.editedRoute.wayPoints.first.objId}),z.travel.editedRoute.wayPoints.first.latLng=e,this._renameWayPointWithGeocoder(e,z.travel.editedRoute.wayPoints.first.objId),xe.dispatch("addwaypoint",{wayPoint:z.travel.editedRoute.wayPoints.first,letter:"A"}),to.startRouting()}setEndPoint(e){z.travel.editedRoute.editionStatus=l.editedChanged,r.defaultValue!==z.travel.editedRoute.wayPoints.last.lat&&xe.dispatch("removeobject",{objId:z.travel.editedRoute.wayPoints.last.objId}),z.travel.editedRoute.wayPoints.last.latLng=e,this._renameWayPointWithGeocoder(e,z.travel.editedRoute.wayPoints.last.objId),xe.dispatch("addwaypoint",{wayPoint:z.travel.editedRoute.wayPoints.last,letter:"B"}),to.startRouting()}wayPointDragEnd(e){z.travel.editedRoute.editionStatus=l.editedChanged,this._renameWayPointWithGeocoder(z.travel.editedRoute.wayPoints.getAt(e).latLng,e),to.startRouting()}wayPointProperties(e){let t=z.travel.editedRoute.wayPoints.getAt(e);new eo(t).show().then((()=>{xe.dispatch("setrouteslist"),xe.dispatch("showitinerary"),xe.dispatch("roadbookupdate")})).catch((e=>{e instanceof Error&&console.error(e)}))}};class no extends le{_options=null;constructor(e={}){super(e),this._options=e}get contentHTMLElements(){return[Y.create("div",{textContent:this._options.text||""})]}get title(){return this._options.title||""}}class ao{_waitUI=null;_newNoteFromOsmData(e,t){let o=new U;for(const t in e)o[t]=e[t];o.iconLatLng=o.latLng,o.distance=G.getClosestLatLngDistance(t,o.latLng).distance,o.chainedDistance=t.chainedDistance,t.notes.add(o),xe.dispatch("noteupdated",{removedNoteObjId:_,addedNoteObjId:o.objId}),xe.dispatch("roadbookupdate")}async _addAllManeuverNotes(e,t){this._waitUI=new Et,this._waitUI.createUI();let o=e.itinerary.maneuvers.iterator;for(;!o.done;){this._waitUI.showInfo(M.getText("NoteEditor - Creating note",{noteNumber:o.index+1,notesLength:t}));let n=e.itinerary.itineraryPoints.getAt(o.value.itineraryPointObjId).latLng,a=await(new nt).getIconAndAdressAsync(n,e.objId);a.statusOk?this._newNoteFromOsmData(a.noteData,e):console.error("An error occurs when creating the svg icon "+o.index)}e.notes.sort(((e,t)=>e.distance-t.distance)),xe.dispatch("updateitinerary"),xe.dispatch("roadbookupdate"),this._waitUI.close(),this._waitUI=null}constructor(){}addAllManeuverNotes(t){let o=Z.getRoute(t),n=o.itinerary.maneuvers.iterator,a=0;for(;!n.done;)"kDepartDefault"===n.value.iconName&&!n.first||"kArriveDefault"===n.value.iconName&&!n.last||a++;e.note.maxManeuversNotes<a?Me.showError(M.getText("NoteEditor - max maneuvers notes reached {maneuversLength}{maxManeuversNotes}",{maneuversLength:a,maxManeuversNotes:e.note.maxManeuversNotes})):new no({title:M.getText("NoteEditor - Add a note for each maneuver"),text:M.getText("NoteEditor - Add a note for each maneuver. Are you sure?",{noteLength:a}),secondButtonText:"âŒ"}).show().then((()=>this._addAllManeuverNotes(o,a))).catch((e=>{e instanceof Error&&console.error(e)}))}}class so extends Ye{_routeObjId=_;_route=null;constructor(e,t=null){super(e,t),this._routeObjId=this.eventData.targetObjId,this._route=Z.getRoute(this._routeObjId)}doAction(e){switch(e){case 0:$t.editRoute(this._routeObjId);break;case 1:$t.removeRoute(this._routeObjId);break;case 2:this._route.hidden?$t.showRoute(this._routeObjId):$t.hideRoute(this._routeObjId);break;case 3:$t.routeProperties(this._routeObjId);break;case 4:(new Rt).zoomToRoute(this._routeObjId);break;case 5:Wt.showProfile(this._routeObjId);break;case 6:$t.printRouteMap(this._routeObjId);break;case 7:$t.saveGpx(this._routeObjId);break;case 8:oo.reverseWayPoints();break;case 9:ft.newRouteNote({routeObjId:this._routeObjId,lat:this.eventData.lat,lng:this.eventData.lng});break;case 10:(new ao).addAllManeuverNotes(this._routeObjId);break;case 11:$t.saveEdition();break;case 12:$t.cancelEdition()}}get menuItems(){return[{itemText:M.getText("RouteContextMenu - Edit this route"),isActive:this._routeObjId!==z.travel.editedRoute.objId&&l.editedChanged!==z.travel.editedRoute.editionStatus},{itemText:M.getText("RouteContextMenu - Delete this route"),isActive:this._routeObjId!==z.travel.editedRoute.objId||l.editedChanged!==z.travel.editedRoute.editionStatus},{itemText:M.getText(this._route.hidden?"RouteContextMenu - Show this route":"RouteContextMenu - Hide this route"),isActive:this._route.hidden||z.travel.editedRoute.objId!==this._routeObjId},{itemText:M.getText("RouteContextMenu - Properties"),isActive:!this._route.hidden},{itemText:M.getText("RouteContextMenu - Zoom to route"),isActive:!this._route.hidden},{itemText:M.getText("RouteContextMenu - View the elevation"),isActive:this._route.itinerary.hasProfile},{itemText:M.getText("RouteContextMenu - Print route map"),isActive:e.printRouteMap.isEnabled},{itemText:M.getText("RouteContextMenu - Save this route in a GPX file"),isActive:0<this._route.itinerary.itineraryPoints.length},{itemText:M.getText("RouteContextMenu - Invert waypoints"),isActive:z.travel.editedRoute.objId===this._routeObjId},{itemText:M.getText("RouteContextMenu - Add a note on the route"),isActive:!this.eventData.haveParentNode},{itemText:M.getText("RouteContextMenu - Create a note for each route maneuver"),isActive:!this._route.hidden},{itemText:M.getText("RouteContextMenu - Save modifications on this route"),isActive:z.travel.editedRoute.objId===this._routeObjId},{itemText:M.getText("RouteContextMenu - Cancel modifications on this route"),isActive:z.travel.editedRoute.objId===this._routeObjId}]}}class io{static handleEvent(e){let t=Z.getRoute(e.target.objId),o=G.getClosestLatLngDistance(t,[e.latlng.lat,e.latlng.lng]).distance;o+=t.chainedDistance,o=P.formatDistance(o);let n=z.mapObjects.get(e.target.objId);n.closeTooltip();let a=t.computedName;z.travel.readOnly||(a+=0===a.length?"":" - ",a+=o),n.setTooltipContent(a),n.openTooltip(e.latlng)}}class ro{static handleEvent(e){window.L.DomEvent.stopPropagation(e),new so(e).show()}}class lo{static marker=null;static initialLatLng=null}class ho{static handleEvent(){lo.marker&&(window.L.DomEvent.off(lo.marker),z.map.removeLayer(lo.marker),lo.marker=null)}}class co{static handleEvent(){window.L.DomEvent.off(lo.marker,"mouseout",ho.handleEvent)}}class uo{static handleEvent(e){e.latlng.lat=lo.initialLatLng[0],e.latlng.lng=lo.initialLatLng[1],e.target.objId=z.travel.editedRoute.objId,new so(e).show()}}class vo{static handleEvent(e){oo.addWayPointOnRoute(lo.initialLatLng,[e.target.getLatLng().lat,e.target.getLatLng().lng]),lo.marker&&(window.L.DomEvent.off(lo.marker,"dragstart",co.handleEvent),window.L.DomEvent.off(lo.marker,"dragend",vo.handleEvent),window.L.DomEvent.off(lo.marker,"contextmenu",uo.handleEvent),z.map.removeLayer(lo.marker),lo.marker=null)}}class _o{static _showDragTooltip=1;static handleEvent(t){let o=Z.getRoute(t.target.objId);if(l.notEdited!==o.editionStatus)if(lo.initialLatLng=[t.latlng.lat,t.latlng.lng],lo.marker)lo.marker.setLatLng(t.latlng);else{let o='<div class="TravelNotes-Map-WayPoint TravelNotes-Map-WayPointTmp"></div><div class="TravelNotes-Map-WayPointText">?</div>';lo.marker=window.L.marker(t.latlng,{icon:window.L.divIcon({iconSize:[I,I],iconAnchor:[10,I],html:o,className:"TravelNotes-Map-WayPointStyle"}),draggable:!0}),(p===e.route.showDragTooltip||_o._showDragTooltip<=e.route.showDragTooltip)&&(_o._showDragTooltip++,lo.marker.bindTooltip(M.getText("MapEditor - Drag and drop to add a waypoint")),lo.marker.getTooltip().options.offset=[0,0]),lo.marker.addTo(z.map),window.L.DomEvent.on(lo.marker,"mouseout",ho.handleEvent),window.L.DomEvent.on(lo.marker,"dragstart",co.handleEvent),window.L.DomEvent.on(lo.marker,"dragend",vo.handleEvent),window.L.DomEvent.on(lo.marker,"contextmenu",uo.handleEvent)}}}class po{static handleEvent(e){let t=Z.getNoteAndRoute(e.target.objId),o=t.note,n=t.route,a=z.mapObjects.get(e.target.objId);if(null===n)o.latLng=[e.target.getLatLng().lat,e.target.getLatLng().lng],xe.dispatch("updatetravelnotes");else{let t=G.getClosestLatLngDistance(n,[e.target.getLatLng().lat,e.target.getLatLng().lng]);o.latLng=t.latLng,o.distance=t.distance,n.notes.sort(((e,t)=>e.distance-t.distance)),a.getLayer(a.bulletId).setLatLng(t.latLng),xe.dispatch("updateitinerary")}a.getLayer(a.polylineId).setLatLngs([o.latLng,o.iconLatLng]),xe.dispatch("roadbookupdate")}}class mo{static handleEvent(e){let t=Z.getNoteAndRoute(e.target.objId).note,o=z.mapObjects.get(e.target.objId);o.getLayer(o.polylineId).setLatLngs([[e.latlng.lat,e.latlng.lng],t.iconLatLng])}}class go{static handleEvent(t){t.originalEvent.target.style.opacity=e.note.grip.moveOpacity}}class yo{static handleEvent(t){t.originalEvent.target.style.opacity=e.note.grip.opacity}}class bo extends Ye{_noteObjId=_;_route=null;constructor(e,t=null){super(e,t),this._noteObjId=this.eventData.targetObjId,this._route=Z.getNoteAndRoute(this._noteObjId).route}doAction(e){switch(e){case 0:ft.editNote(this._noteObjId);break;case 1:ft.removeNote(this._noteObjId);break;case 2:(new Rt).zoomToNote(this._noteObjId);break;case 3:this._route?ft.detachNoteFromRoute(this._noteObjId):ft.attachNoteToRoute(this._noteObjId)}}get menuItems(){return[{itemText:M.getText("NoteContextMenu - Edit this note"),isActive:!0},{itemText:M.getText("NoteContextMenu - Delete this note"),isActive:!0},{itemText:M.getText("NoteContextMenu - Zoom to note"),isActive:!0},{itemText:M.getText(this._route?"NoteContextMenu - Detach note from route":"NoteContextMenu - Attach note to route"),isActive:_===z.editedRouteObjId}]}}class Io{static handleEvent(e){new bo(e).show()}}class wo{static handleEvent(e){let t=Z.getNoteAndRoute(e.target.objId).note;t.iconLatLng=[e.target.getLatLng().lat,e.target.getLatLng().lng];let o=z.mapObjects.get(e.target.objId);o.getLayer(o.polylineId).setLatLngs([t.latLng,t.iconLatLng])}}class Lo{static handleEvent(e){let t=Z.getNoteAndRoute(e.target.objId).note,o=z.mapObjects.get(e.target.objId);o.getLayer(o.polylineId).setLatLngs([t.latLng,[e.latlng.lat,e.latlng.lng]])}}class To extends Ye{_wayPointObjId=_;constructor(e,t=null){super(e,t),this._wayPointObjId=this.eventData.targetObjId}doAction(e){switch(e){case 0:oo.removeWayPoint(this._wayPointObjId);break;case 1:oo.wayPointProperties(this._wayPointObjId)}}get menuItems(){return[{itemText:M.getText("WayPointContextMenu - Delete this waypoint"),isActive:z.travel.editedRoute.wayPoints.first.objId!==this._wayPointObjId&&z.travel.editedRoute.wayPoints.last.objId!==this._wayPointObjId},{itemText:M.getText("WayPointContextMenu - Modify properties"),isActive:!0}]}}class Do{static handleEvent(e){new To(e).show()}}class Eo{static handleEvent(e){z.travel.editedRoute.wayPoints.getAt(e.target.objId).latLng=[e.target.getLatLng().lat,e.target.getLatLng().lng],oo.wayPointDragEnd(e.target.objId)}}const fo=new class extends class{_currentLayer=null;_geolocationCircle=null;_getDashArray(t){t.dashArray>=e.route.dashChoices.length&&(t.dashArray=0);let o=e.route.dashChoices[t.dashArray].iDashArray;if(o){let e="",n=0;for(n=0;n<o.length-1;n++)e+=o[n]*t.width+",";return e+=o[n]*t.width,e}return null}_addNote(t){let o=Z.getNoteAndRoute(t).note,n=window.L.marker(o.latLng,{icon:window.L.divIcon({iconSize:[e.note.grip.size,e.note.grip.size],iconAnchor:[e.note.grip.size/2,e.note.grip.size/2],html:"<div></div>",className:"TravelNotes-Map-Note-Bullet"}),opacity:e.note.grip.opacity,draggable:!z.travel.readOnly});n.objId=o.objId;let a=window.L.divIcon({iconSize:[o.iconWidth,o.iconHeight],iconAnchor:[o.iconWidth/2,o.iconHeight/2],popupAnchor:[0,-o.iconHeight/2],html:o.iconContent,className:"TravelNotes-Map-AllNotes "}),s=window.L.marker(o.iconLatLng,{zIndexOffset:100,icon:a,draggable:!z.travel.readOnly});s.objId=o.objId,s.bindPopup((e=>x.clone(Be.getNoteTextHTML("TravelNotes-Map-",Z.getNoteAndRoute(e.objId))))),0!==o.tooltipContent.length&&(s.bindTooltip((e=>Z.getNoteAndRoute(e.objId).note.tooltipContent)),s.getTooltip().options.offset[0]=o.iconWidth/2);let i=window.L.polyline([o.latLng,o.iconLatLng],e.note.polyline);i.objId=o.objId;let r=window.L.layerGroup([s,i,n]);return r.markerId=window.L.Util.stamp(s),r.polylineId=window.L.Util.stamp(i),r.bulletId=window.L.Util.stamp(n),this.addToMap(o.objId,r),e.note.haveBackground&&document.querySelectorAll(".TravelNotes-MapNote,.TravelNotes-SvgIcon").forEach((e=>e.classList.add("TravelNotes-Map-Note-Background"))),Object.freeze({marker:s,polyline:i,bullet:n})}constructor(){}addToMap(e,t){t.objId=e,t.addTo(z.map),z.mapObjects.set(e,t)}addRoute(e){let t=Z.getRoute(e),o=[],n=t.itinerary.itineraryPoints.iterator;for(;!n.done;)o.push(n.value.latLng);let a=window.L.polyline(o,{color:t.color,weight:t.width,dashArray:this._getDashArray(t)});this.addToMap(t.objId,a),l.notEdited===t.editionStatus&&(a.bindTooltip(t.computedName,{sticky:!0,direction:"right"}),window.L.DomEvent.on(a,"mouseover",io.handleEvent),window.L.DomEvent.on(a,"mousemove",io.handleEvent)),a.bindPopup((e=>x.clone(Ue.getRouteHeaderHTML("TravelNotes-Map-",Z.getRoute(e.objId))))),window.L.DomEvent.on(a,"click",(e=>e.target.openPopup(e.latlng)));let s=t.notes.iterator;for(;!s.done;)this._addNote(s.value.objId);return t}addNote(e){return this._addNote(e)}getDashArray(e){return this._getDashArray(e)}zoomTo(t,o){if(o){let e=[];o.forEach((t=>e=e.concat(t))),z.map.fitBounds(G.getLatLngBounds(e))}else z.map.setView(t,e.itineraryPoint.zoomFactor)}setLayer(e,t){let o=null;o="wmts"===e.service.toLowerCase()?window.L.tileLayer(t):window.L.tileLayer.wms(t,e.wmsOptions),this._currentLayer&&z.map.removeLayer(this._currentLayer),z.map.addLayer(o),this._currentLayer=o,z.travel.readOnly||(z.map.getZoom()<(e.minZoom||0)&&z.map.setZoom(e.minZoom||0),z.map.setMinZoom(e.minZoom||0),z.map.getZoom()>(e.maxZoom||18)&&z.map.setZoom(e.maxZoom||18),z.map.setMaxZoom(e.maxZoom||18),e.bounds?(z.map.getBounds().intersects(e.bounds)&&!z.map.getBounds().contains(e.bounds)||(z.map.setMaxBounds(null),z.map.fitBounds(e.bounds),z.map.setZoom(e.minZoom||0)),z.map.setMaxBounds(e.bounds)):z.map.setMaxBounds(null)),z.map.fire("baselayerchange",o)}onGeolocationStatusChanged(e){a.active!==e&&this._geolocationCircle&&(z.map.removeLayer(this._geolocationCircle),this._geolocationCircle=null)}onGeolocationPositionChanged(t){let o=e.geoLocation.zoomToPosition;this._geolocationCircle&&(z.map.removeLayer(this._geolocationCircle),o=!1),this._geolocationCircle=window.L.circleMarker(window.L.latLng(t.coords.latitude,t.coords.longitude),e.geoLocation.marker).bindTooltip(P.formatLatLng([t.coords.latitude,t.coords.longitude])).addTo(z.map),o&&z.map.setView(window.L.latLng(t.coords.latitude,t.coords.longitude),e.geoLocation.zoomFactor)}}{_RemoveFromMap(e){let t=z.mapObjects.get(e);t&&(window.L.DomEvent.off(t),z.map.removeLayer(t),z.mapObjects.delete(e))}constructor(){super()}updateRoute(e,t){if(_!==e){let t=Z.getRoute(e);this._RemoveFromMap(t.objId);let o=t.notes.iterator;for(;!o.done;)this._RemoveFromMap(o.value.objId);let n=t.wayPoints.iterator;for(;!n.done;)this._RemoveFromMap(n.value.objId)}if(_!==t){let e=this.addRoute(t),o=z.mapObjects.get(t);if(!z.travel.readOnly){window.L.DomEvent.on(o,"contextmenu",ro.handleEvent),window.L.DomEvent.on(o,"mouseover",_o.handleEvent);let t=e.notes.iterator;for(;!t.done;){let e=z.mapObjects.get(t.value.objId),o=e.getLayer(e.markerId),n=e.getLayer(e.bulletId);window.L.DomEvent.on(n,"dragend",po.handleEvent),window.L.DomEvent.on(n,"drag",mo.handleEvent),window.L.DomEvent.on(n,"mouseenter",go.handleEvent),window.L.DomEvent.on(n,"mouseleave",yo.handleEvent),window.L.DomEvent.on(o,"contextmenu",Io.handleEvent),window.L.DomEvent.on(o,"dragend",wo.handleEvent),window.L.DomEvent.on(o,"drag",Lo.handleEvent)}}if(!z.travel.readOnly&&l.notEdited!==e.editionStatus){let e=z.travel.editedRoute.wayPoints.iterator;for(;!e.done;)this.addWayPoint(e.value,e.first?"A":e.last?"B":e.index)}}}updateRouteProperties(e){let t=z.mapObjects.get(e),o=Z.getRoute(e);t.setStyle({color:o.color,weight:o.width,dashArray:this.getDashArray(o)})}updateNote(e,t){let o=!1;if(_!==e){let t=z.mapObjects.get(e);t&&(o=t.getLayer(t.markerId).isPopupOpen()),this._RemoveFromMap(e)}if(_!==t){let e=this.addNote(t);o&&e.marker.openPopup(),z.travel.readOnly||(window.L.DomEvent.on(e.bullet,"dragend",po.handleEvent),window.L.DomEvent.on(e.bullet,"drag",mo.handleEvent),window.L.DomEvent.on(e.bullet,"mouseenter",go.handleEvent),window.L.DomEvent.on(e.bullet,"mouseleave",yo.handleEvent),window.L.DomEvent.on(e.marker,"contextmenu",Io.handleEvent),window.L.DomEvent.on(e.marker,"dragend",wo.handleEvent),window.L.DomEvent.on(e.marker,"drag",Lo.handleEvent))}}removeObject(e){this._RemoveFromMap(e)}removeAllObjects(){z.mapObjects.forEach((e=>{window.L.DomEvent.off(e),z.map.removeLayer(e)})),z.mapObjects.clear()}addWayPoint(e,t){if(r.defaultValue===e.lat&&r.defaultValue===e.lng)return;let o='<div class="TravelNotes-Map-WayPoint TravelNotes-Map-WayPoint'+("A"===t?"Start":"B"===t?"End":"Via")+'"></div><div class="TravelNotes-Map-WayPointText">'+t+"</div>",n=window.L.marker(e.latLng,{icon:window.L.divIcon({iconSize:[I,I],iconAnchor:[10,I],html:o,className:"TravelNotes-Map-WayPointStyle"}),draggable:!0});n.bindTooltip((e=>Z.getWayPoint(e.objId).fullName)),n.getTooltip().options.offset=[10,-10],window.L.DomEvent.on(n,"contextmenu",Do.handleEvent),n.objId=e.objId,this.addToMap(e.objId,n),window.L.DomEvent.on(n,"dragend",Eo.handleEvent)}addItineraryPointMarker(t,o){this.addToMap(t,window.L.circleMarker(o,e.itineraryPoint.marker))}addSearchPointMarker(t,o,n){let a=!1;if(n){let e=[];n.forEach((t=>{e=e.concat(t)}));let t=G.getLatLngBounds(e),o=z.map.getBounds();a=(t.getEast()-t.getWest())/(o.getEast()-o.getWest())>.01&&(t.getNorth()-t.getSouth())/(o.getNorth()-o.getSouth())>.01}a?this.addToMap(t,window.L.polyline(n,e.osmSearch.searchPointPolyline)):this.addToMap(t,window.L.circleMarker(o,e.osmSearch.searchPointMarker))}addRectangle(e,t,o){this.addToMap(e,window.L.rectangle(t,o))}setLayer(e){let t=Pe.getUrl(e);t&&super.setLayer(e,t)}};
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file IndexedDb.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/const No=new class{_indexedDb=null;_UUID=null;_data=null;_open(e,t){if(this._indexedDb)return void e();let o=window.indexedDB.open("TravelNotesDb",1);o.onerror=()=>{this._indexedDb=null,t(new Error("Not possible to open the db"))},o.onsuccess=t=>{this._indexedDb=t.target.result,e()},o.onupgradeneeded=e=>{this._indexedDb=e.target.result,this._indexedDb.createObjectStore("Travels",{keyPath:"UUID"})}}_read(e,t){if(!this._indexedDb)return void t(new Error("Database not opened"));let o=this._indexedDb.transaction(["Travels"],"readonly");o.onerror=()=>t(new Error("Transaction error")),o.objectStore("Travels").get(this._UUID).onsuccess=t=>e(t.target.result?t.target.result.data:null)}_write(e,t){if(!this._indexedDb)return void t(new Error("Database not opened"));let o=null;try{o=this._indexedDb.transaction(["Travels"],"readwrite")}catch(e){return void t(e)}o.onerror=()=>t(new Error("Transaction error")),o.objectStore("Travels").put({UUID:this._UUID,data:this._data}).onsuccess=()=>e()}_close(){this._indexedDb.close(),this._indexedDb=null}constructor(){}getOpenPromise(){return new Promise(((e,t)=>this._open(e,t)))}getReadPromise(e){return this._UUID=e,new Promise(((e,t)=>this._read(e,t)))}getWritePromise(e,t){return this._UUID=e,this._data=t,new Promise(((e,t)=>this._write(e,t)))}closeDb(e){if(!this._indexedDb)return;if(!e)return void this._close();let t=this._indexedDb.transaction(["Travels"],"readwrite");t.onerror=()=>{};let o=t.objectStore("Travels").delete(e);o.onerror=()=>this._close(),o.onsuccess=()=>this._close()}};const xo=new class{_getTravelHeaderHTML(t){let o=Y.create("div",{className:t+"Travel-Header"});x.sanitizeToHtmlElement(z.travel.name,Y.create("div",{className:t+"Travel-Header-Name"},o));let a=n.defaultValue,s=0,i=0,r=z.travel.routes.iterator;for(;!r.done;){let n=r.value.objId===z.editedRouteObjId&&e.routeEditor.showEditedRouteInRoadbook?z.travel.editedRoute:r.value;x.sanitizeToHtmlElement('<a href="#route'+n.objId+'" >'+n.computedName+"</a>Â :Â "+P.formatDistance(n.distance)+".",Y.create("div",{className:t+"Travel-Header-RouteName"},o)),n.chain&&(a+=n.distance,s+=n.itinerary.ascent,i+=n.itinerary.descent)}return x.sanitizeToHtmlElement("<span>"+M.getText("TravelHTMLViewsFactory - Travel distance")+"</span>Â :Â "+P.formatDistance(a),Y.create("div",{className:t+"Travel-Header-TravelDistance"},o)),0!==s&&x.sanitizeToHtmlElement("<span>"+M.getText("travelHTMLViewsFactory - Travel ascent")+"</span>Â :Â "+String(s.toFixed(0))+" m.",Y.create("div",{className:t+"Travel-Header-TravelAscent"},o)),0!==i&&x.sanitizeToHtmlElement("<span>"+M.getText("TravelHTMLViewsFactory - Travel descent")+"</span>Â :Â "+String(i.toFixed(0))+" m.",Y.create("div",{className:t+"Travel-Header-TravelDescent"},o)),o}_getTravelFooterHTML(e){let t=M.getText("TravelHTMLViewsFactory - Travel footer")+'<a href="https://github.com/wwwouaiebe/leaflet.TravelNotes" target="_blank" title="https://github.com/wwwouaiebe/leaflet.TravelNotes" >Travel & Notes</a>, Â© <a href="https://www.ouaie.be/" target="_blank" title="https://www.ouaie.be/" >wwwouaiebe 2017 2021</a> Â© <a href="https://www.openstreetmap.org/copyright" target="_blank" title="https://www.openstreetmap.org/copyright">'+M.getText("TravelHTMLViewsFactory - OpenStreetMap contributors")+"</a>",o=Y.create("div",{className:e+"TravelFooter"});return x.sanitizeToHtmlElement(t,o),o}constructor(){}getTravelHTML(t){let o=Y.create("div",{className:t+"Travel"});o.appendChild(this._getTravelHeaderHTML(t)),o.appendChild(Be.getTravelNotesHTML(t));let n=z.travel.routes.iterator;for(;!n.done;){let a=e.routeEditor.showEditedRouteInRoadbook&&n.value.objId===z.editedRouteObjId?z.travel.editedRoute:n.value;o.appendChild(Ue.getRouteHeaderHTML(t,a)),a.itinerary.hasProfile&&o.appendChild(Ue.getRouteProfileHTML(t,a)),o.appendChild(Ue.getRouteManeuversAndNotesHTML(t,a,!1)),o.appendChild(Ue.getRouteFooterHTML(t,a))}return o.appendChild(this._getTravelFooterHTML(t)),o}};const Mo=new class{_mouseUISpan=null;_saveStatus=o.saved;_mousePosition="";_zoom="";_saveTimer=null;_updateUI(){this._mouseUISpan&&(this._mouseUISpan.textContent=this._saveStatus+"Â "+this._mousePosition+"Â -Â ZoomÂ :Â "+this._zoom)}constructor(){}set saveStatus(e){o.modified===e&&o.notSaved===this._saveStatus||(this._saveStatus=e,o.modified!==e||this._saveTimer||(this._saveTimer=setTimeout((()=>this._saveStatus=o.notSaved),3e5)),o.saved===e&&this._saveTimer&&(clearTimeout(this._saveTimer),this._saveTimer=null),this._updateUI())}createUI(){this._mouseUISpan=Y.create("span",null,Y.create("div",{id:"TravelNotes-MouseUI"},document.body)),this._zoom=z.map.getZoom(),this._mousePosition=P.formatLat(e.map.center.lat)+"Â -Â "+P.formatLng(e.map.center.lng),z.map.on("mousemove",(e=>{this._mousePosition=P.formatLatLng([e.latlng.lat,e.latlng.lng]),this._updateUI()})),z.map.on("zoomend",(()=>{this._zoom=String(z.map.getZoom()),this._updateUI()}))}};const Po=new class{_python2Round(e){return Math.floor(Math.abs(e)+.5)*(0<=e?1:-1)}_encodeDelta(e,t,o){let n=this._python2Round(e*o),a=this._python2Round(t*o),s=n-a;s<<=1,0>n-a&&(s=~s);let i="";for(;32<=s;)i+=String.fromCharCode(63+(32|31&s)),s>>=5;return i+=String.fromCharCode(s+63),i}_index=0;_decodeDelta(e){let t=null,o=0,n=0;do{t=e.charCodeAt(this._index++)-63,n|=(31&t)<<o,o+=5}while(32<=t);return 1&n?~(n>>1):n>>1}constructor(){}encode(e,t){if(!e.length)return"";let o=t.length,n=Array.from(t,(e=>Math.pow(10,e))),a="";for(let t=0;t<o;t++)a+=this._encodeDelta(e[0][t],0,n[t]);for(let t=1;t<e.length;t++){let s=e[t],i=e[t-1];for(let e=0;e<o;e++)a+=this._encodeDelta(s[e],i[e],n[e])}return a}decode(e,t){let o=t.length;if(!e||0===e.length)return[];this._index=0;let n=[],a=Array.from(t,(e=>Math.pow(10,e))),s=new Array(o).fill(0);for(;this._index<e.length;){let t=new Array(o).fill(0);for(let n=0;n<o;n++)s[n]+=this._decodeDelta(e),t[n]=s[n]/a[n];n.push(t)}return n}};class Co{_compressRoute(e){let t={};0!==e.itinerary.itineraryPoints.length&&(t=e.itinerary.itineraryPoints[0].objType);let o={values:"",objType:t},n=[];e.itinerary.itineraryPoints.forEach((e=>{n.push([e.lat,e.lng,e.distance,e.elev,e.objId])})),o.values=Po.encode(n,[r.fixed,r.fixed,2,2,0]),e.itinerary.itineraryPoints=o}_decompressRoute(e){let t=[];if(e.itinerary.itineraryPoints.values)Po.decode(e.itinerary.itineraryPoints.values,[r.fixed,r.fixed,2,2,0]).forEach((o=>{let a={lat:r.defaultValue,lng:r.defaultValue,distance:n.defaultValue,elev:i.defaultValue,objId:_};[a.lat,a.lng,a.distance,a.elev,a.objId]=o,a.objType=e.itinerary.itineraryPoints.objType,t.push(a)}));else{e.itinerary.itineraryPoints.latLngs=Po.decode(e.itinerary.itineraryPoints.latLngs,[r.fixed,r.fixed]);let o=0;e.itinerary.itineraryPoints.latLngs.forEach((n=>{let a={};a.lat=n[0],a.lng=n[1],a.distance=e.itinerary.itineraryPoints.distances[o],e.itinerary.itineraryPoints.elevs?a.elev=e.itinerary.itineraryPoints.elevs[o]:a.elev=i.defaultValue,a.objId=e.itinerary.itineraryPoints.objIds[o],a.objType=e.itinerary.itineraryPoints.objType,t.push(a),o++}))}e.itinerary.itineraryPoints=t}_decompressTravel(e){e.routes.forEach(this._decompressRoute),e.editedRoute&&this._decompressRoute(e.editedRoute)}constructor(){}decompress(e){this._decompressTravel(e),z.travel.jsonObject=e,z.editedRouteObjId=_,z.travel.routes.forEach((e=>{l.notEdited!==e.editionStatus&&(z.editedRouteObjId=e.objId)}))}decompressMerge(e){this._decompressTravel(e);let t=new W;t.jsonObject=e;let o=t.routes.iterator;for(;!o.done;)z.travel.routes.add(o.value);let n=t.notes.iterator;for(;!n.done;)z.travel.notes.add(n.value)}compress(e){let t=e.jsonObject;return t.routes.forEach(this._compressRoute),this._compressRoute(t.editedRoute),t}}class jo extends le{_removeTravelNotesInput=null;_removeRoutesNotesInput=null;_removeManeuversInput=null;_removeTravelNotesDiv=null;_removeRoutesNotesDiv=null;_removeManeuversDiv=null;_createInputDiv(e){let t=Y.create("div",null),o=Y.create("input",{type:"checkbox",checked:!1},t);return Y.create("text",{value:e},t),[t,o]}constructor(e={}){super(e),[this._removeTravelNotesDiv,this._removeTravelNotesInput]=this._createInputDiv(M.getText("SaveAsDialog - Remove Travel Notes")),[this._removeRoutesNotesDiv,this._removeRoutesNotesInput]=this._createInputDiv(M.getText("SaveAsDialog - Remove Routes Notes")),[this._removeManeuversDiv,this._removeManeuversInput]=this._createInputDiv(M.getText("SaveAsDialog - Remove Maneuvers"))}onOk(){super.onOk(Object.freeze({removeTravelNotes:this._removeTravelNotesInput.checked,removeRoutesNotes:this._removeRoutesNotesInput.checked,removeManeuvers:this._removeManeuversInput.checked}))}get contentHTMLElements(){return[this._removeTravelNotesDiv,this._removeRoutesNotesDiv,this._removeManeuversDiv]}get title(){return M.getText("SaveAsDialog - SaveAs")}}const Ao=new class{_saveAsTravel(e){let t=new W;t.jsonObject=z.travel.jsonObject,t.name+="-partial";let o=t.routes.iterator;for(;!o.done;)o.value.hidden=!1;if(e.removeTravelNotes&&t.notes.removeAll(),e.removeRoutesNotes)for(o=t.routes.iterator;!o.done;)o.value.notes.removeAll();if(e.removeManeuvers)for(o=t.routes.iterator;!o.done;)o.value.itinerary.maneuvers.removeAll();let n=(new Co).compress(t);P.saveFile(n.name+".trv",JSON.stringify(n),"application/json")}constructor(){}routeDropped(e,t,o){let n=e===z.travel.editedRoute.objId?z.editedRouteObjId:e,a=t===z.travel.editedRoute.objId?z.editedRouteObjId:t;z.travel.routes.moveTo(n,a,o),$t.chainRoutes(),xe.dispatch("setrouteslist"),xe.dispatch("roadbookupdate")}saveAsTravel(){""!==z.travel.name?_===z.editedRouteObjId?(new jo).show().then((e=>{this._saveAsTravel(e)})).catch((e=>{e instanceof Error&&console.error(e)})):Me.showError(M.getText("TravelEditor - Not possible to partial save when a route is edited.")):Me.showError(M.getText("TravelEditor - Gives a name to the travel"))}saveTravel(){if(""===z.travel.name)return void Me.showError(M.getText("TravelEditor - Gives a name to the travel"));let e=z.travel.routes.iterator;for(;!e.done;)e.value.hidden=!1;let t=(new Co).compress(z.travel);P.saveFile(t.name+".trv",JSON.stringify(t),"application/json"),Mo.saveStatus=o.saved}newTravel(){e.travelNotes.haveBeforeUnloadWarning&&!window.confirm(M.getText("TravelEditor - This page ask to close; data are perhaps not saved."))||(Wt.deleteAllProfiles(),xe.dispatch("removeallobjects"),z.travel.editedRoute=new F,z.editedRouteObjId=_,z.travel=new W,z.travel.routes.add(new F),xe.dispatch("setrouteslist"),xe.dispatch("showitinerary"),xe.dispatch("roadbookupdate"),xe.dispatch("travelnameupdated"),e.travelEditor.startupRouteEdition&&$t.editRoute(z.travel.routes.first.objId),Mo.saveStatus=o.saved)}};const So=new class{_attributionsDiv=null;constructor(){}createUI(){this._attributionsDiv=Y.create("div",{id:"TravelNotes-AttributionsUI"},document.body)}set attributions(e){let t='Â© <a href="https://leafletjs.com/" target="_blank" title="Leaflet">Leaflet</a> | Â© <a href="https://www.openstreetmap.org/copyright" target="_blank" title="OpenStreetMap contributors">OpenStreetMap contributors</a> '+e+'| Â© <a href="https://github.com/wwwouaiebe" target="_blank" title="https://github.com/wwwouaiebe">Travel & Notes</a>';for(;this._attributionsDiv.firstChild;)this._attributionsDiv.removeChild(this._attributionsDiv.firstChild);x.sanitizeToHtmlElement(t,this._attributionsDiv)}};class Oo{_mapLayer=null;constructor(e){this._mapLayer=e}handleEvent(e){e.stopPropagation(),e.target.style.color=this._mapLayer.toolbar.backgroundColor,e.target.style["background-color"]=this._mapLayer.toolbar.color}}class ko{_mapLayer=null;constructor(e){this._mapLayer=e}handleEvent(e){e.stopPropagation(),e.target.style.color=this._mapLayer.toolbar.color,e.target.style["background-color"]=this._mapLayer.toolbar.backgroundColor}}class Ro{_mapLayer=null;constructor(e){this._mapLayer=e}handleEvent(e){e.stopPropagation(),xe.dispatch("layerchange",{layer:this._mapLayer}),So.attributions=this._mapLayer.attribution,z.travel.layerName=this._mapLayer.name}}class Ho{_buttonHTMLElement=null;_eventListeners={mouseEnter:null,mouseLeave:null,click:null};_parentNode=null;constructor(e,t){this._parentNode=t,this._buttonHTMLElement=Y.create("div",{className:"TravelNotes-MapLayersToolbarUI-Button",title:e.name,dataset:{MapLayerName:e.name},textContent:e.toolbar.text,style:"color:"+e.toolbar.color+";background-color:"+e.toolbar.backgroundColor},t),this._eventListeners.mouseEnter=new Oo(e),this._eventListeners.mouseLeave=new ko(e),this._eventListeners.click=new Ro(e),this._buttonHTMLElement.addEventListener("mouseenter",this._eventListeners.mouseEnter,!1),this._buttonHTMLElement.addEventListener("mouseleave",this._eventListeners.mouseLeave,!1),this._buttonHTMLElement.addEventListener("click",this._eventListeners.click,!1)}destructor(){this._buttonHTMLElement.removeEventListener("mouseenter",this._eventListeners.mouseEnter,!1),this._buttonHTMLElement.removeEventListener("mouseleave",this._eventListeners.mouseLeave,!1),this._buttonHTMLElement.removeEventListener("click",this._eventListeners.click,!1),this._parentNode.removeChild(this._buttonHTMLElement),this._parentNode=null}get height(){return this._buttonHTMLElement.clientHeight}}class Bo{constructor(){}handleEvent(e){e.stopPropagation(),e.target.classList.add("TravelNotes-MapLayersToolbarUI-LinkButton-Enter"),e.target.classList.remove("TravelNotes-MapLayersToolbarUI-LinkButton-Leave")}}class Uo{constructor(){}handleEvent(e){e.stopPropagation(),e.target.classList.add("TravelNotes-MapLayersToolbarUI-LinkButton-Leave"),e.target.classList.remove("TravelNotes-MapLayersToolbarUI-LinkButton-Enter")}}class Ko{_eventListeners={mouseEnter:null,mouseLeave:null};_linkButton=null;_parentNode=null;constructor(e,t){this._parentNode=t,this._linkButton=Y.create("div",{className:"TravelNotes-MapLayersToolbarUI-Button TravelNotes-MapLayersToolbarUI-LinkButton-Leave"},t),Y.create("a",e,this._linkButton),this._eventListeners.mouseEnter=new Bo,this._eventListeners.mouseLeave=new Uo,this._linkButton.addEventListener("mouseenter",this._eventListeners.mouseEnter,!1),this._linkButton.addEventListener("mouseleave",this._eventListeners.mouseLeave,!1)}destructor(){this._linkButton.removeEventListener("mouseenter",this._eventListeners.mouseEnter,!1),this._linkButton.removeEventListener("mouseleave",this._eventListeners.mouseLeave,!1),this._parentNode.removeChild(this._linkButton),this._parentNode=null}get height(){return this._linkButton.clientHeight}}class Fo{_mapLayersToolbarUI=null;_wheelEventData=null;constructor(e,t){this._mapLayersToolbarUI=e,this._wheelEventData=t}handleEvent(e){e.stopPropagation(),e.deltaY&&(this._wheelEventData.marginTop-=e.deltaY*v[e.deltaMode],this._wheelEventData.marginTop=this._wheelEventData.marginTop>this._wheelEventData.buttonTop?this._wheelEventData.buttonTop:this._wheelEventData.marginTop,this._wheelEventData.marginTop=this._wheelEventData.marginTop<this._wheelEventData.buttonTop-this._wheelEventData.buttonsHeight+3*this._wheelEventData.buttonHeight?this._wheelEventData.buttonTop-this._wheelEventData.buttonsHeight+3*this._wheelEventData.buttonHeight:this._wheelEventData.marginTop,this._mapLayersToolbarUI.buttonsHTMLElement.style.marginTop=String(this._wheelEventData.marginTop)+"px")}}const Vo=new class{_mainHTMLElement=null;_buttonsHTMLElement=null;_buttonsAndLinks=[];_wheelEventData={marginTop:0,buttonHeight:0,buttonsHeight:0,buttonTop:0};_timerId=null;_onWheelButtonsEventListener=null;_show(){if(this._timerId)return clearTimeout(this._timerId),void(this._timerId=null);if(this._buttonsHTMLElement=Y.create("div",{id:"TravelNotes-MapLayersToolbarUI-Buttons"},this._mainHTMLElement),this._wheelEventData.buttonTop=this._mainHTMLElement.clientHeight,this._wheelEventData.buttonsHeight=0,Zt.forEach((e=>{if(e.providerKeyNeeded&&Pe.hasKey(e.providerName.toLowerCase())||!e.providerKeyNeeded){let t=new Ho(e,this._buttonsHTMLElement);this._wheelEventData.buttonHeight=t.height,this._wheelEventData.buttonsHeight+=t.height,this._buttonsAndLinks.push(t)}})),e.layersToolbarUI.theDevil&&e.layersToolbarUI.theDevil.addButton){let e=new Ko({href:"https://www.google.com/maps/@"+z.map.getCenter().lat+","+z.map.getCenter().lng+","+z.map.getZoom()+"z",title:"Reminder! The devil will know everything about you",textContent:"ðŸ‘¿",target:"_blank"},this._buttonsHTMLElement);this._wheelEventData.buttonsHeight+=e.height,this._buttonsAndLinks.push(e)}this._wheelEventData.buttonTop+=this._wheelEventData.buttonHeight,this._wheelEventData.marginTop=this._wheelEventData.buttonTop,this._buttonsHTMLElement.style.marginTop=String(this._wheelEventData.marginTop)+"px",this._buttonsHTMLElement.addEventListener("wheel",this._onWheelButtonsEventListener,!1)}_hide(){this._buttonsAndLinks.forEach((e=>e.destructor())),this._buttonsAndLinks.length=0,this._buttonsHTMLElement.removeEventListener("wheel",this._onWheelButtonsEventListener,!1),this._mainHTMLElement.removeChild(this._buttonsHTMLElement),this._timerId=null}_onMouseLeave(){this._timerId=setTimeout((()=>this._hide()),e.layersToolbarUI.toolbarTimeOut)}constructor(){this._onWheelButtonsEventListener=new Fo(this,this._wheelEventData)}createUI(){this._mainHTMLElement=Y.create("div",{id:"TravelNotes-MapLayersToolbarUI"},document.body),Y.create("div",{id:"TravelNotes-MapLayersToolbarUI-Header",textContent:M.getText("MapLayersToolbarUI - Layers")},this._mainHTMLElement),this._mainHTMLElement.addEventListener("mouseenter",(()=>this._show()),!1),this._mainHTMLElement.addEventListener("mouseleave",(()=>this._onMouseLeave()),!1),xe.dispatch("layerchange",{layer:Zt.defaultMapLayer}),So.attributions=Zt.defaultMapLayer.attribution}setMapLayer(e){let t=Zt.getMapLayer(e);xe.dispatch("layerchange",{layer:t}),So.attributions=t.attribution,z.travel.layerName=t.name}get buttonsHTMLElement(){return this._buttonsHTMLElement}};class Wo{_display(){xe.dispatch("removeallobjects"),document.title="Travel & Notes"+(""===z.travel.name?"":" - "+z.travel.name);let e=z.travel.routes.iterator;for(;!e.done;)l.notEdited===e.value.editionStatus&&xe.dispatch("routeupdated",{removedRouteObjId:_,addedRouteObjId:e.value.objId});_!==z.editedRouteObjId&&xe.dispatch("routeupdated",{removedRouteObjId:_,addedRouteObjId:z.travel.editedRoute.objId});let t=z.travel.notes.iterator;for(;!t.done;)xe.dispatch("noteupdated",{removedNoteObjId:_,addedNoteObjId:t.value.objId});if((new Rt).zoomToTravel(),Vo.setMapLayer(z.travel.layerName),xe.dispatch("setrouteslist"),_!==z.editedRouteObjId){let e=z.travel.editedRoute.itinerary.provider;if(e&&""!==e&&!z.providers.get(e.toLowerCase()))Me.showError(M.getText("FileLoader - Not possible to select as provider",{provider:e}));else{let t=z.travel.editedRoute.itinerary.transitMode;xe.dispatch("setprovider",{provider:e}),t&&""!==t&&xe.dispatch("settransitmode",{transitMode:t})}}$t.chainRoutes(),xe.dispatch("travelnameupdated"),xe.dispatch("showitinerary"),xe.dispatch("roadbookupdate")}_openFile(e,t){try{t?(new Co).decompressMerge(e):(Wt.deleteAllProfiles(),(new Co).decompress(e)),this._display(),t||(Mo.saveStatus=o.saved)}catch(e){Me.showError("An error occurs when reading the file : "+e.message)}}constructor(){}openLocalFile(e){this._openFile(e,!1)}mergeLocalFile(e){this._openFile(e,!0)}}class zo{handleEvent(e){e.stopPropagation(),Ao.saveAsTravel()}}class Go{handleEvent(e){e.stopPropagation(),Ao.newTravel(),document.title="Travel & Notes"+(""===z.travel.name?"":" - "+z.travel.name)}}class Xo{handleEvent(e){e.stopPropagation(),Ao.saveTravel()}}class Zo{handleEvent(e){e.stopPropagation();let t=new FileReader;t.onload=()=>{let e={};try{e=JSON.parse(t.result),(new Wo).openLocalFile(e)}catch(e){e instanceof Error&&console.error(e)}},t.readAsText(e.target.files[0])}}class Yo{handleEvent(t){t.stopPropagation(),e.travelNotes.haveBeforeUnloadWarning&&!window.confirm(M.getText("TravelEditor - This page ask to close; data are perhaps not saved."))||P.openFile(new Zo,".trv")}}class Jo{handleEvent(e){e.stopPropagation();let t=new FileReader;t.onload=()=>{let e={};try{e=JSON.parse(t.result),(new Wo).mergeLocalFile(e)}catch(e){e instanceof Error&&console.error(e)}},t.readAsText(e.target.files[0])}}class qo{handleEvent(e){e.stopPropagation(),_===z.editedRouteObjId?P.openFile(new Jo,".trv"):Me.showError(M.getText("TravelUI - Not possible to merge a travel when a route is edited"))}}class Qo{_buttonsDiv=null;_createSaveAsTravelButton(){Y.create("div",{className:"TravelNotes-UI-Button TravelNotes-TravelUI-SaveAsButton",title:M.getText("TravelUI - Save as travel"),textContent:"ðŸ’¾"},this._buttonsDiv).addEventListener("click",new zo,!1)}_createCancelTravelButton(){Y.create("div",{className:"TravelNotes-UI-Button",title:M.getText("TravelUI - Cancel travel"),textContent:"âŒ"},this._buttonsDiv).addEventListener("click",new Go,!1)}_createSaveTravelButton(){Y.create("div",{className:"TravelNotes-UI-Button",title:M.getText("TravelUI - Save travel"),textContent:"ðŸ’¾"},this._buttonsDiv).addEventListener("click",new Xo,!1)}_createOpenTravelButton(){Y.create("div",{className:"TravelNotes-UI-Button",title:M.getText("TravelUI - Open travel"),textContent:"ðŸ“‚"},this._buttonsDiv).addEventListener("click",new Yo,!1)}_createImportTravelButton(){Y.create("div",{className:"TravelNotes-UI-Button",title:M.getText("TravelUI - Import travel"),textContent:"ðŸŒ"},this._buttonsDiv).addEventListener("click",new qo,!1)}_createRoadbookButton(){Y.create("text",{value:"ðŸ“‹"},Y.create("a",{className:"TravelNotes-UI-LinkButton",href:"TravelNotesRoadbook.html?lng="+e.travelNotes.language+"&page="+z.UUID,target:"_blank"},Y.create("div",{className:"TravelNotes-UI-Button",title:M.getText("TravelUI - Open travel roadbook")},this._buttonsDiv)))}constructor(e){this._buttonsDiv=Y.create("div",{className:"TravelNotes-UI-FlexRowDiv"},e),this._createSaveAsTravelButton(),this._createCancelTravelButton(),this._createSaveTravelButton(),this._createOpenTravelButton(),this._createImportTravelButton(),this._createRoadbookButton()}}class $o{constructor(){}handleEvent(e){e.preventDefault()}}class en{constructor(){}handleEvent(e){e.stopPropagation();try{e.dataTransfer.setData("ObjId",e.target.dataset.tanObjId),e.dataTransfer.dropEffect="move"}catch(e){e instanceof Error&&console.error(e)}}}class tn{constructor(){}handleEvent(e){e.preventDefault();let t=e.target,o=t.getBoundingClientRect();Ao.routeDropped(Number.parseInt(e.dataTransfer.getData("ObjId")),Number.parseInt(t.dataset.tanObjId),e.clientY-o.top<o.bottom-e.clientY)}}class on{constructor(){}handleEvent(e){e.stopPropagation(),e.deltaY&&(e.target.scrollTop+=e.deltaY*v[e.deltaMode]),e.stopPropagation()}}class nn{constructor(){}handleEvent(e){e.stopPropagation(),e.preventDefault(),new so(e,e.target.parentNode).show()}}class an{_routesListHTMLElement=null;_routeContextMenuEventListener=new nn;_routeDropEventListener=new tn;_routeDragStartEventListener=new en;constructor(e){this._routesListHTMLElement=Y.create("div",{className:"TravelNotes-TravelUI-RoutesListDiv"},e),this._routesListHTMLElement.addEventListener("dragover",new $o),this._routesListHTMLElement.addEventListener("wheel",new on)}toogleExpand(){return this._routesListHTMLElement.classList.toggle("TravelNotes-Hidden"),this._routesListHTMLElement.classList.contains("TravelNotes-Hidden")}setRoutesList(){for(;this._routesListHTMLElement.firstChild;)this._routesListHTMLElement.firstChild.removeEventListener("dragstart",this._routeDragStartEventListener),this._routesListHTMLElement.firstChild.removeEventListener("drop",this._routeDropEventListener),this._routesListHTMLElement.firstChild.removeEventListener("contextmenu",this._routeContextMenuEventListener),this._routesListHTMLElement.removeChild(this._routesListHTMLElement.firstChild);let e=z.travel.routes.iterator;for(;!e.done;){let t=e.value.objId===z.editedRouteObjId?z.travel.editedRoute:e.value,o=(e.value.objId===z.editedRouteObjId?"ðŸ”´Â ":"")+(t.chain?"â›“Â ":"")+(e.value.objId===z.editedRouteObjId?z.travel.editedRoute.computedName:t.computedName),n=Y.create("div",{draggable:!0,className:"TravelNotes-TravelUI-RoutesList-Item TravelNotes-UI-MoveCursor"+(e.value.hidden?" TravelNotes-TravelUI-RoutesList-HiddenItem":""),dataset:{ObjId:t.objId},textContent:o},this._routesListHTMLElement);n.addEventListener("dragstart",this._routeDragStartEventListener),n.addEventListener("drop",this._routeDropEventListener),n.addEventListener("contextmenu",this._routeContextMenuEventListener)}}}class sn{handleEvent(e){e.stopPropagation(),z.travel.name=x.sanitizeToJsString(e.target.value),document.title="Travel & Notes"+(""===z.travel.name?"":" - "+z.travel.name),xe.dispatch("roadbookupdate")}}class rn{_routesListUI=null;constructor(e){this._routesListUI=e}handleEvent(e){e.stopPropagation();let t=this._routesListUI.toogleExpand();e.target.textContent=t?"â–¶":"â–¼",e.target.title=t?M.getText("TravelUI - Show"):M.getText("TravelUI - Hide")}}class ln{handleEvent(e){e.stopPropagation(),$t.addRoute()}}class dn{_routesHeaderDiv=null;_travelNameInput=null;_routesListUI=null;_expandRoutesButton=null;_createTravelNameDiv(e){let t=Y.create("div",{className:"TravelNotes-UI-FlexRowDiv"},e);Y.create("span",{textContent:M.getText("TravelUI - Travel")},t),this._travelNameInput=Y.create("input",{id:"TravelNotes-TravelUI-InputTravelName",type:"text",value:z.travel.name},t),this._travelNameInput.addEventListener("change",new sn,!1)}_createAddRouteButton(){Y.create("div",{className:"TravelNotes-UI-Button TravelNotes-UI-FlexRow-RightButton",title:M.getText("TravelUI - Add a route"),textContent:"+"},this._routesHeaderDiv).addEventListener("click",new ln,!1)}_createRoutesListHeaderDiv(e){this._routesHeaderDiv=Y.create("div",{className:"TravelNotes-UI-FlexRowDiv"},e),this._expandRoutesButton=Y.create("div",{textContent:"â–¼",className:"TravelNotes-TravelUI-RouteList-ExpandButton"},this._routesHeaderDiv),Y.create("span",{textContent:M.getText("TravelUI - Travel routes")},this._routesHeaderDiv),this._createAddRouteButton(this._routesHeaderDiv)}constructor(e){this._createTravelNameDiv(e),new Qo(e),this._createRoutesListHeaderDiv(e),this._routesListUI=new an(e),this._expandRoutesButton.addEventListener("click",new rn(this._routesListUI),!1)}setTravelName(){this._travelNameInput.value=z.travel.name}get routesListUI(){return this._routesListUI}}class hn{_paneManagerUI=null;constructor(e){this._paneManagerUI=e}handleEvent(e){this._paneManagerUI.showPane(e.target.dataset.tanPaneId)}}class cn{constructor(){}handleEvent(e){e.deltaY&&(e.target.scrollTop+=e.deltaY*v[e.deltaMode]),e.stopPropagation()}}class un{_activePaneId=s.invalidPane;_panes=new Map;_paneData=null;_paneControl=null;_headerDiv=null;_removeActivePane(){s.invalidPane!==this._activePaneId&&(this._panes.get(this._activePaneId).remove(),this._paneData.textContent="")}constructor(e){this._headerDiv=Y.create("div",{className:"TravelNotes-UI-FlexRowDiv"},e),this._paneControl=Y.create("div",{id:"TravelNotes-PanesManagerUI-PaneControlsDiv"},e),this._paneData=Y.create("div",{id:"TravelNotes-PanesManagerUI-PaneDataDiv"},e),this._paneData.addEventListener("wheel",new cn)}addPane(e){let t=new e(this._paneData,this._paneControl);this._panes.set(t.getPaneId(),t),Y.create("div",{textContent:t.getButtonText(),className:"TravelNotes-PanesManagerUI-PaneButton",dataset:{PaneId:t.getPaneId()}},this._headerDiv).addEventListener("click",new hn(this))}showPane(e){this._removeActivePane(),this._activePaneId=e,this._panes.get(this._activePaneId).add(),document.querySelectorAll(".TravelNotes-PanesManagerUI-PaneButton").forEach((e=>{e.dataset.tanPaneId===this._activePaneId?e.classList.add("TravelNotes-PanesManagerUI-ActivePaneButton"):e.classList.remove("TravelNotes-PanesManagerUI-ActivePaneButton")}))}updatePane(e){e===this._activePaneId&&this.showPane(e)}}const vn={bike:'data:image/svg+xml;utf8,<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" > <path fill="rgb(0,0,191)" d="m 11.25,3.125 v 1.09375 l 1.5625,0.9765625 V 6.5625H 7.4999999 V 5.625 h 0.625 c 1.25,0 1.25,-1.25 0,-1.25 h -2.5 c -1.25,0 -1.25,1.25 0,1.25 h 0.625 V 6.5625 L 5.0781249,8.75 c -0.026125,-5.821e-4 -0.0519,0 -0.078125,0 -2.0153538,0 -3.75,1.734646 -3.75,3.75 0,2.015354 1.7346462,3.75 3.75,3.75 2.0153537,0 3.75,-1.734646 3.75,-3.75 0,-0.432461 -0.089462,-0.858226 -0.234375,-1.25 h 0.546875 c 0.9375,0 1.1534331,-0.567495 1.4843751,-0.898437 L 12.773438,7.8125 13.4375,9.1015625 C 12.159328,9.7073948 11.25,11.031094 11.25,12.5 c 0,2.015354 1.734646,3.75 3.75,3.75 2.015354,0 3.75,-1.734646 3.75,-3.75 0,-2.015354 -1.734646,-3.75 -3.75,-3.75 -0.03934,0 -0.07808,-0.00131 -0.117187,0 L 13.75,6.5625 V 4.5703125 Z M 7.2265624,7.8125 H 11.132813 L 9.1796874,10 h -1.40625 c -0.0231,0 -0.054487,0.0026 -0.078125,0 C 7.3660586,9.6463159 6.9994024,9.3504739 6.5624999,9.140625 6.5471874,9.1173375 6.5373874,9.0856825 6.5234374,9.0625 Z M 4.9999999,10 c 1.2571387,0 2.5,1.242862 2.5,2.5 0,1.257139 -1.2428613,2.5 -2.5,2.5 -1.2571388,0 -2.5,-1.242861 -2.5,-2.5 0,-1.257138 1.2428612,-2.5 2.5,-2.5 z M 15,10 c 1.257137,0 2.5,1.242862 2.5,2.5 0,1.257139 -1.242863,2.5 -2.5,2.5 -1.257139,0 -2.5,-1.242861 -2.5,-2.5 0,-1.257138 1.242861,-2.5 2.5,-2.5 z" /></svg>',pedestrian:'data:image/svg+xml;utf8,<svg viewBox="0 0 20 20"  xmlns="http://www.w3.org/2000/svg"> <g fill="rgb(0,0,191)" transform="matrix(0.15866777,0,0,0.12627988,148.47251,-116.69398)"> <path d="m -875.5,962.4 c 2,-1.5 4.6,-2.3 7.4,-2.2 3.6,0.3 6.7,2.5 8.4,5.2 l 10.7,21.2 14.5,10.1 c 1.2,1 2,2.5 1.9,4.2 -0.1,2.6 -2.5,4.6 -5.2,4.3 -0.7,0 -1.5,-0.3 -2.2,-0.7 l -15.6,-10.7 c -0.4,-0.4 -0.9,-0.9 -1.2,-1.5 l -4.1,-7.9 -4.8,21.1 18.9,22.3 c 0.4,0.7 0.7,1.5 0.9,2.2 l 5.1,26.9 c 0,0.6 0,1 0,1.5 -0.3,4.1 -3.8,6.8 -7.7,6.7 -3.2,-0.3 -5.7,-2.6 -6.5,-5.7 l -4.8,-25.1 -15.3,-17 -3.6,16.3 c -0.1,0.7 -1.2,2.3 -1.5,2.9 l -14.6,24.9 c -1.5,2.2 -3.9,3.8 -6.7,3.4 -4.1,-0.3 -7,-3.8 -6.7,-7.7 0.1,-1.2 0.6,-2.2 1,-3.1 l 13.7,-22.8 11.4,-50.4 -7.4,6 -4.1,18 c -0.4,2.2 -2.6,4.2 -5.1,4.1 -2.6,-0.1 -4.6,-2.5 -4.5,-5.2 0,-0.1 0,-0.4 0.1,-0.6 l 4.6,-20.9 c 0.3,-0.9 0.7,-1.6 1.5,-2.2 z" /> <path d="m -884.5,943.5 c 1.3,8.6 8.7,15.3 17.8,15.3 5.7,0 10.2,-4.6 10.2,-10.2 0,-5.6 -4.6,-10.2 -10.2,-10.2 -3.9,0 -7.2,2 -8.9,5.2 -0.2,0.4 -0.5,0.7 -0.8,1 -2,2 -5.3,2 -7.3,0 -0.4,-0.4 -0.6,-0.7 -0.8,-1.1 z" /></g></svg>',car:'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" > <g fill="rgb(0,0,191)"><path d="m 2,13 a 1.7142857,1.7142857 0 0 0 1.7142857,1.714286 H 16.285714 A 1.7142857,1.7142857 0 0 0 18,13 V 9.5714286 A 1.7142857,1.7142857 0 0 0 16.285714,7.8571429 H 3.7142857 A 1.7142857,1.7142857 0 0 0 2,9.5714286 Z m 1.8285714,-2.285714 a 1.0285714,1.0285714 0 1 1 0,0.01143 z m 10.2857146,0 a 1.0285714,1.0285714 0 1 1 0,0.01143 z" /> <path d="M 4.2857143,7.8571429 V 5 A 1.7142857,1.7142857 0 0 1 6,3.2857143 h 8 A 1.7142857,1.7142857 0 0 1 15.714286,5 V 7.8571429 H 14 V 6.1428571 A 1.1428571,1.1428571 0 0 0 12.857143,5 H 7.1428571 A 1.1428571,1.1428571 0 0 0 6,6.1428571 v 1.7142858 z" /> <g transform="matrix(1.1428571,0,0,1.1428571,2,2.1428571)"><rect x="1" y="10" width="2" height="3" /><rect x="11" y="10" width="2" height="3" /></g></g></svg>',train:'data:image/svg+xml;utf8,<svg viewBox="-3 -3 20 20" xmlns="http://www.w3.org/2000/svg"> <g fill="rgb(0,0,191)"><path d="M 5,0 C 3.025911,-0.0084 1,3 1,7 l 0,2 c 0,1 1,2 2,2 l 8,0 c 1,0 2,-1 2,-2 L 13,7 C 13,3 11,0 9,0 z m -1,3 6,0 c 0,0 1,1 1,3 L 3.03125,6 C 2.994661,3.9916 4,3 4,3 z M 3,8 6,8 6,9 3,9 z m 5,0 3,0 0,1 -3,0 z m -6,4 -1,2 3,0 1,-2 z m 7,0 1,2 3,0 -1,-2 z"/></g></svg>',line:'data:image/svg+xml;utf8,<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" > <line x1="5" y1="17" x2="11" y2="2" stroke="rgb(0,0,0)" /> <line x1="3" y1="6" x2="17" y2="9" stroke="rgb(191,0,0)" /> <line x1="3" y1="16" x2="17" y2="5" stroke="rgb(255,204,0)" /> </svg>',circle:'data:image/svg+xml;utf8,<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" > <g fill="transparent"> <circle cx="8" cy="6" r="5" stroke="rgb(0,0,0)" /> <circle cx="12" cy="12" r="4" stroke="rgb(255,204,0)" /> <circle cx="14" cy="8" r="3" stroke="rgb(191,0,0)" /> </g> </svg>'};class _n{_providerToolbarUI=null;_transitMode=null;_buttonHTMLElement=null;constructor(e,t){this._providerToolbarUI=e,this._transitMode=t,this._buttonHTMLElement=Y.create("img",{src:vn[t],id:"TravelNotes-ProvidersToolbarUI-"+t+"ImgButton",className:"TravelNotes-ProvidersToolbarUI-ImgButton",title:M.getText("ProvidersToolbarUI - "+t)}),this._buttonHTMLElement.addEventListener("click",this),this.visible=!1}handleEvent(e){e.stopPropagation(),this._providerToolbarUI.transitMode=this._transitMode,to.startRouting()}get buttonHTMLElement(){return this._buttonHTMLElement}get transitMode(){return this._transitMode}set active(e){e?this._buttonHTMLElement.classList.add("TravelNotes-ProvidersToolbarUI-ActiveTransitModeImgButton"):this._buttonHTMLElement.classList.remove("TravelNotes-ProvidersToolbarUI-ActiveTransitModeImgButton")}set visible(e){e?this._buttonHTMLElement.classList.remove("TravelNotes-Hidden"):this._buttonHTMLElement.classList.add("TravelNotes-Hidden")}}class pn{_providerToolbarUI=null;_provider=null;_buttonHTMLElement=null;constructor(e,t){this._providerToolbarUI=e,this._provider=t,this._buttonHTMLElement=Y.create("img",{src:t.icon,id:"TravelNotes-ProvidersToolbarUI-"+t.name+"ImgButton",className:"TravelNotes-ProvidersToolbarUI-ImgButton",title:t.title||t.name}),this._buttonHTMLElement.addEventListener("click",this)}handleEvent(e){e.stopPropagation(),this._providerToolbarUI.provider=this._provider.name,to.startRouting()}get buttonHTMLElement(){return this._buttonHTMLElement}get provider(){return this._provider}set active(e){e?this._buttonHTMLElement.classList.add("TravelNotes-ProvidersToolbarUI-ActiveProviderImgButton"):this._buttonHTMLElement.classList.remove("TravelNotes-ProvidersToolbarUI-ActiveProviderImgButton")}}class mn{_toolbarHTMLElement=null;_transitModeButtons=new Map;_providerButtons=new Map;_activeTransitModeButton=null;_activeProviderButton=null;_createTransitModesButtons(){["bike","pedestrian","car","train","line","circle"].forEach((e=>{let t=new _n(this,e);this._transitModeButtons.set(e,t),this._toolbarHTMLElement.appendChild(t.buttonHTMLElement)}))}_createProvidersButtons(){z.providers.forEach((e=>{if(0!==e.providerKey){let t=new pn(this,e);this._providerButtons.set(e.name,t),this._toolbarHTMLElement.appendChild(t.buttonHTMLElement)}}))}constructor(e){this._toolbarHTMLElement=Y.create("div",{className:"TravelNotes-UI-FlexRowDiv TravelNotes-ProvidersToolbarUI-ImgButtonsDiv"},e),this._createTransitModesButtons(),this._createProvidersButtons(),this.provider=this._providerButtons.keys().next().value}set provider(e){z.routing.provider=e,this._activeProviderButton&&(this._activeProviderButton.active=!1),this._activeProviderButton=this._providerButtons.get(e),this._activeProviderButton.active=!0;let t=z.providers.get(e.toLowerCase());this._transitModeButtons.forEach((e=>{e.visible=p!==t.transitModes.indexOf(e.transitMode)})),this._activeTransitModeButton&&p!==t.transitModes.indexOf(this._activeTransitModeButton.transitMode)||(this._activeTransitModeButton=null,this._transitModeButtons.forEach((e=>{this._activeTransitModeButton||p===t.transitModes.indexOf(e.transitMode)?e.active=!1:(this._activeTransitModeButton=e,e.active=!0,z.routing.transitMode=e.transitMode)})))}set transitMode(e){z.routing.transitMode=e,this._activeTransitModeButton&&(this._activeTransitModeButton.active=!1),this._activeTransitModeButton=this._transitModeButtons.get(e),this._activeTransitModeButton.active=!0}providersAdded(){for(;this._toolbarHTMLElement.firstChild;)this._toolbarHTMLElement.removeChild(this._toolbarHTMLElement.firstChild);this._transitModeButtons.clear(),this._providerButtons.clear(),this._createTransitModesButtons(),this._createProvidersButtons(),this.provider=this._providerButtons.keys().next().value;let e=this._providerButtons.keys().next().value;this.provider=e,this.transitMode=z.providers.get(e.toLowerCase()).transitModes[0]}}const gn=new class{_status="geolocation"in navigator?a.inactive:a.disabled;_watchId=null;_showPosition(e){xe.dispatch("geolocationpositionchanged",{position:e})}_stop(){a.active===this._status&&(this._status=a.inactive),xe.dispatch("geolocationstatuschanged",{status:this._status}),navigator.geolocation.clearWatch(this._watchId),this._watchId=null}_error(e){1===e.code&&(this._status=a.refusedByUser),this._stop()}_start(){this._status=a.active,xe.dispatch("geolocationstatuschanged",{status:this._status}),navigator.geolocation.getCurrentPosition((e=>this._showPosition(e)),(e=>this._error(e)),e.geoLocation.options),this._watchId=navigator.geolocation.watchPosition(this._showPosition,this._error,e.geoLocation.options)}constructor(){}get status(){return this._status}switch(){switch(this._status){case a.inactive:this._start();break;case a.active:this._stop()}return this._status}};class yn{constructor(){}handleEvent(e){e.stopPropagation(),Pe.setKeysFromDialog()}}class bn{constructor(){}handleEvent(e){e.stopPropagation(),gn.switch()}}class In{constructor(){}handleEvent(e){e.target.textContent="ðŸ“Œ"===e.target.textContent?"âŒ":"ðŸ“Œ",xe.dispatch("uipinned")}}class wn{_geoLocationButton=null;_buttonsDiv=null;_createHomeButton(){Y.create("text",{value:"ðŸ "},Y.create("a",{className:"TravelNotes-UI-LinkButton",href:window.location.origin,target:"_blank"},Y.create("div",{className:"TravelNotes-UI-Button",title:"Home"},this._buttonsDiv)))}_createHelpButton(){Y.create("text",{value:"?"},Y.create("a",{className:"TravelNotes-UI-LinkButton",href:"https://github.com/wwwouaiebe/leaflet.TravelNotes/tree/gh-pages/TravelNotesGuides",target:"_blank"},Y.create("div",{className:"TravelNotes-UI-Button",title:"Help"},this._buttonsDiv)))}_createContactButton(){Y.create("text",{value:"@"},Y.create("a",{className:"TravelNotes-UI-LinkButton",href:e.travelNotesToolbarUI.contactMail.url||window.location.origin,target:"_blank"},Y.create("div",{className:"TravelNotes-UI-Button",title:"Contact"},this._buttonsDiv)))}_createApiKeysButton(){e.APIKeysDialog.showButton&&Y.create("div",{className:"TravelNotes-UI-Button",title:M.getText("TravelNotesToolbarUI - API keys"),textContent:"ðŸ”‘"},this._buttonsDiv).addEventListener("click",new yn,!1)}_createGeoLocationButton(){a.disabled<gn.status&&(this._geoLocationButton=Y.create("div",{className:"TravelNotes-UI-Button",title:M.getText("TravelNotesToolbarUI - Geo location"),textContent:"ðŸŒ"},this._buttonsDiv),this._geoLocationButton.addEventListener("click",new bn,!1))}_createPinButton(){Y.create("div",{textContent:e.travelEditor.startMinimized?"ðŸ“Œ":"âŒ",className:"TravelNotes-UI-Button TravelNotes-UI-FlexRow-RightButton"},this._buttonsDiv).addEventListener("click",new In,!1)}constructor(e){this._buttonsDiv=Y.create("div",{className:"TravelNotes-UI-FlexRowDiv"},e),this._createHomeButton(),this._createHelpButton(),this._createContactButton(),this._createApiKeysButton(),this._createGeoLocationButton(),this._createPinButton()}geoLocationStatusChanged(e){switch(e){case a.inactive:this._geoLocationButton.classList.remove("TravelNotes-TravelNotesToolbarUI-GeoLocationButton-Striked");break;case a.active:this._geoLocationButton.classList.add("TravelNotes-TravelNotesToolbarUI-GeoLocationButton-Striked");break;default:this._geoLocationButton&&(this._geoLocationButton.parentNode.removeChild(this._geoLocationButton),this._geoLocationButton=null)}}}class Ln{constructor(e,t){this.paneData=e,this.paneControl=t}remove(){}add(){}getPaneId(){return s.invalidPane}getButtonText(){return""}}class Tn{_itineraryDataUI=null;constructor(e){this._itineraryDataUI=e}handleEvent(e){e.stopPropagation(),this._itineraryDataUI.toggleNotes()}}class Dn{_itineraryDataUI=null;constructor(e){this._itineraryDataUI=e}handleEvent(e){e.stopPropagation(),this._itineraryDataUI.toggleManeuvers()}}class En{_routeHeaderHTMLElement=null;_checkBoxesHTMLElement=null;_showNotesCheckBoxHTMLElement=null;_showManeuversCheckBoxHTMLElement=null;_showNotes=e.itineraryPaneUI.showNotes;_showManeuvers=e.itineraryPaneUI.showManeuvers;_eventListeners={onInputNotesCheckbox:null,onInputManeuverCheckbox:null};_paneControl=null;_itineraryDataUI=null;constructor(e,t){this._paneControl=e,this._eventListeners.onInputNotesCheckbox=new Tn(t),this._eventListeners.onInputManeuverCheckbox=new Dn(t),this._itineraryDataUI=t}addControl(){this._checkBoxesHTMLElement=Y.create("div",null,this._paneControl),Y.create("text",{value:M.getText("ItineraryPaneUI - Show notes")},this._checkBoxesHTMLElement),this._showNotesCheckBoxHTMLElement=Y.create("input",{type:"checkbox",id:"TravelNotes-ItineraryPane-ShowNotesInput",checked:this._showNotes},this._checkBoxesHTMLElement),this._showNotesCheckBoxHTMLElement.addEventListener("click",this._eventListeners.onInputNotesCheckbox),Y.create("text",{value:M.getText("ItineraryPaneUI - Show maneuvers")},this._checkBoxesHTMLElement),this._showManeuversCheckBoxHTMLElement=Y.create("input",{type:"checkbox",id:"TravelNotes-ItineraryPane-ShowManeuversInput",checked:this._showManeuvers},this._checkBoxesHTMLElement),this._showManeuversCheckBoxHTMLElement.addEventListener("click",this._eventListeners.onInputManeuverCheckbox),this._routeHeaderHTMLElement=Ue.getRouteHeaderHTML("TravelNotes-ItineraryPaneUI-",z.travel.editedRoute),this._paneControl.appendChild(this._routeHeaderHTMLElement),this._showManeuvers||this._itineraryDataUI.toggleManeuvers(),this._showNotes||this._itineraryDataUI.toggleNotes()}clearControl(){this._checkBoxesHTMLElement&&(this._showManeuversCheckBoxHTMLElement&&(this._showManeuvers=this._showManeuversCheckBoxHTMLElement.checked,this._showManeuversCheckBoxHTMLElement.removeEventListener("click",this._eventListeners.onInputManeuverCheckbox),this._checkBoxesHTMLElement.removeChild(this._showManeuversCheckBoxHTMLElement),this._showManeuversCheckBoxHTMLElement=null),this._showNotesCheckBoxHTMLElement&&(this._showNotes=this._showNotesCheckBoxHTMLElement.checked,this._showNotesCheckBoxHTMLElement.addEventListener("click",this._eventListeners.onInputNotesCheckbox),this._checkBoxesHTMLElement.removeChild(this._showNotesCheckBoxHTMLElement),this._showNotesCheckBoxHTMLElement=null),this._paneControl.removeChild(this._checkBoxesHTMLElement),this._checkBoxesHTMLElement=null),this._routeHeaderHTMLElement&&(this._paneControl.removeChild(this._routeHeaderHTMLElement),this._routeHeaderHTMLElement=null)}}class fn extends Ye{constructor(e,t=null){super(e,t)}doAction(e){switch(e){case 0:(new Rt).zoomToManeuver(this.eventData.targetObjId)}}get menuItems(){return[{itemText:M.getText("ManeuverContextMenu - Zoom to this maneuver"),isActive:!0}]}}class Nn{_paneData=null;constructor(e){this._paneData=e}handleEvent(e){e.stopPropagation(),e.preventDefault(),new fn(e,this._paneData).show()}}class xn{_paneData=null;constructor(e){this._paneData=e}handleEvent(e){e.stopPropagation(),e.preventDefault(),new bo(e,this._paneData).show()}}class Mn{constructor(){}handleEvent(e){e.stopPropagation(),xe.dispatch("additinerarypointmarker",{objId:Number.parseInt(e.target.dataset.tanMarkerObjId),latLng:z.travel.editedRoute.itinerary.itineraryPoints.getAt(z.travel.editedRoute.itinerary.maneuvers.getAt(Number.parseInt(e.target.dataset.tanObjId)).itineraryPointObjId).latLng})}}class Pn{constructor(){}handleEvent(e){e.stopPropagation(),xe.dispatch("additinerarypointmarker",{objId:Number.parseInt(e.target.dataset.tanMarkerObjId),latLng:z.travel.editedRoute.notes.getAt(Number.parseInt(e.target.dataset.tanObjId)).latLng})}}class Cn{constructor(){}handleEvent(e){e.stopPropagation(),xe.dispatch("removeobject",{objId:Number.parseInt(e.target.dataset.tanMarkerObjId)})}}class jn{_paneData=null;_notesHTML=[];_maneuversHTML=[];_routeManeuversAndNotesHTML=null;_eventListeners={onContextMenu:null,onMouseEnter:null,onMouseLeave:null};constructor(e){this._paneData=e,this._eventListeners.onContextMenuManeuver=new Nn(this._paneData),this._eventListeners.onContextMenuNote=new xn(this._paneData),this._eventListeners.onMouseEnterManeuver=new Mn,this._eventListeners.onMouseEnterNote=new Pn,this._eventListeners.onMouseLeave=new Cn}toggleNotes(){this._notesHTML.forEach((e=>e.classList.toggle("TravelNotes-Hidden")))}toggleManeuvers(){this._maneuversHTML.forEach((e=>e.classList.toggle("TravelNotes-Hidden")))}addData(){this._routeManeuversAndNotesHTML=Ue.getRouteManeuversAndNotesHTML("TravelNotes-ItineraryPaneUI-",z.travel.editedRoute,!0),this._routeManeuversAndNotesHTML.childNodes.forEach((e=>{"Maneuver"===e.dataset.tanObjType?(e.addEventListener("contextmenu",this._eventListeners.onContextMenuManeuver),e.addEventListener("mouseenter",this._eventListeners.onMouseEnterManeuver),e.addEventListener("mouseleave",this._eventListeners.onMouseLeave),this._maneuversHTML.push(e)):"Note"===e.dataset.tanObjType&&(e.addEventListener("contextmenu",this._eventListeners.onContextMenuNote),e.addEventListener("mouseenter",this._eventListeners.onMouseEnterNote),e.addEventListener("mouseleave",this._eventListeners.onMouseLeave),this._notesHTML.push(e))})),this._paneData.appendChild(this._routeManeuversAndNotesHTML)}clearData(){this._maneuversHTML.forEach((e=>{e.removeEventListener("contextmenu",this._eventListeners.onContextMenuManeuver),e.removeEventListener("mouseenter",this._eventListeners.onMouseEnterManeuver),e.removeEventListener("mouseleave",this._eventListeners.onMouseLeave)})),this._maneuversHTML.length=0,this._notesHTML.forEach((e=>{e.removeEventListener("contextmenu",this._eventListeners.onContextMenuNote),e.removeEventListener("mouseenter",this._eventListeners.onMouseEnterNote),e.removeEventListener("mouseleave",this._eventListeners.onMouseLeave)})),this._notesHTML.length=0,this._routeManeuversAndNotesHTML&&this._paneData.removeChild(this._routeManeuversAndNotesHTML),this._routeManeuversAndNotesHTML=null}}class An extends Ln{_itineraryDataUI=null;_itineraryControlUI=null;constructor(e,t){super(e,t),this._itineraryDataUI=new jn(this.paneData),this._itineraryControlUI=new En(this.paneControl,this._itineraryDataUI)}remove(){this._itineraryDataUI.clearData(),this._itineraryControlUI.clearControl()}add(){_!==z.editedRouteObjId&&(this._itineraryDataUI.addData(),this._itineraryControlUI.addControl())}getPaneId(){return s.itineraryPane}getButtonText(){return M.getText("PanesManagerUI - Itinerary")}}class Sn{constructor(){}handleEvent(e){e.stopPropagation();try{e.dataTransfer.setData("ObjId",e.target.dataset.tanObjId),e.dataTransfer.dropEffect="move"}catch(e){e instanceof Error&&console.error(e)}}}class On{constructor(){}handleEvent(e){e.preventDefault()}}class kn{constructor(){}handleEvent(e){e.preventDefault();let t=e.currentTarget,o=t.getBoundingClientRect();ft.travelNoteDropped(Number.parseInt(e.dataTransfer.getData("ObjId")),Number.parseInt(t.dataset.tanObjId),e.clientY-o.top<o.bottom-e.clientY)}}class Rn{_paneData=null;constructor(e){this._paneData=e}handleEvent(e){e.stopPropagation(),e.preventDefault(),new bo(e,this._paneData).show()}}class Hn extends Ln{_travelNotesDiv=null;_eventListeners={onDragStart:null,onDragOver:null,onDrop:null,onContextMenu:null};constructor(e,t){super(e,t),this._eventListeners.onDragStart=new Sn,this._eventListeners.onDragOver=new On,this._eventListeners.onDrop=new kn,this._eventListeners.onContextMenu=new Rn(e)}remove(){this._travelNotesDiv&&(this._travelNotesDiv.childNodes.forEach((e=>{e.removeEventListener("contextmenu",this._eventListeners.onContextMenu,!1),e.removeEventListener("dragstart",this._eventListeners.onDragStart,!1),e.removeEventListener("drop",this._eventListeners.onDrop,!1)})),this.paneData.removeChild(this._travelNotesDiv)),this._travelNotesDiv=null}add(){this._travelNotesDiv=Be.getTravelNotesHTML("TravelNotes-TravelNotesPaneUI-"),this._travelNotesDiv.addEventListener("dragover",this._eventListeners.onDragOver,!1),this.paneData.appendChild(this._travelNotesDiv),this._travelNotesDiv.childNodes.forEach((e=>{e.draggable=!0,e.addEventListener("contextmenu",this._eventListeners.onContextMenu,!1),e.addEventListener("dragstart",this._eventListeners.onDragStart,!1),e.addEventListener("drop",this._eventListeners.onDrop,!1),e.classList.add("TravelNotes-UI-MoveCursor")}))}getPaneId(){return s.travelNotesPane}getButtonText(){return M.getText("PanesManagerUI - Travel notes")}}class Bn{_objId=_;constructor(e,t){this.name=x.sanitizeToJsString(e),this.items=[],this.filterTagsArray=[],this.elementTypes=["node","way","relation"],this.isSelected=!1,this.isExpanded=!1,this.isRoot=!1,t&&(this.isExpanded=!0,this.isRoot=!0),this._objId=L.nextObjId}get objId(){return this._objId}}const Un=new class{_dictionary=null;_itemsMap=null;_itemsArray=[];_filterTagsArray=null;_currentItem=null;_parseLine(e){let t=e.split(";");for(;""===t[t.length-1];)t.pop();let o=0,n=null;t.forEach((e=>{if(""!==e)if(p===e.indexOf("="))this._currentItem=new Bn(e),this._itemsMap.set(this._currentItem.objId,this._currentItem),this._itemsArray[o].push(this._currentItem),this._itemsArray[o+1]=this._currentItem.items,this._filterTagsArray=this._currentItem.filterTagsArray;else{let t=e.split("=");if("element"===t[0])this._currentItem.elementTypes=[t[1]];else{let e={};e[t[0]]="*"===t[1]?null:t[1],n=n||[],n.push(e)}}o++})),n&&this._filterTagsArray.push(n)}constructor(){this._itemsMap=new Map,this._dictionary=new Bn("All",!0),this._itemsMap.set(this._dictionary.objId,this._dictionary),this._itemsArray=[this._dictionary.items]}parseDictionary(e){e.split(/\r\n|\r|\n/).forEach((e=>{""!==e&&this._parseLine(e)}))}_selectItem(e,t){e.isSelected=t,e.items.forEach((e=>{this._selectItem(e,t)}))}selectItemObjId(e,t){let o=this._itemsMap.get(e);this._selectItem(o,t)}changeExpanded(e){let t=this._itemsMap.get(e);t.isExpanded=!t.isExpanded}expandBranch(e){e.items.forEach((e=>{this.expandBranch(e)})),e.isExpanded=!0}collapseBranch(e){e.items.forEach((e=>{this.collapseBranch(e)})),e.isRoot||(e.isExpanded=!1)}clearBranch(e){e.items.forEach((e=>{this.clearBranch(e)})),e.isSelected=!1}get dictionary(){return this._dictionary}};const Kn=new class{_searchStarted=!1;_filterItems=[];_previousSearchBounds=null;_filterOsmElement(e,t){let o=!0;return t.forEach((t=>{let[n,a]=Object.entries(t)[0];o=o&&e.tags[n]&&(!a||e.tags[n]===a)})),o}_addPointOfInterest(e,t){this._filterItems.forEach((o=>{o.filterTagsArray.forEach((n=>{this._filterOsmElement(e,n)&&(e.description=o.name,t.set(e.id,e))}))}))}_getSearchQueries(){let t=[],o=new Map;this._filterItems.forEach((e=>{e.filterTagsArray.forEach((t=>{let[n,a]=Object.entries(t[0])[0],s=o.get(n);s||(s={values:new Map,elements:new Map},o.set(n,s)),s.values.set(a,a),e.elementTypes.forEach((e=>{s.elements.set(e,e)}))}))}));let n=this._computeSearchBounds();this._previousSearchBounds=n;let a="("+n.getSouthWest().lat.toFixed(r.fixed)+","+n.getSouthWest().lng.toFixed(r.fixed)+","+n.getNorthEast().lat.toFixed(r.fixed)+","+n.getNorthEast().lng.toFixed(r.fixed)+")";return o.forEach(((o,n)=>{let s='"'+n+'"';if(1===o.values.size){let e=o.values.values().next().value;e&&(s+='="'+e+'"')}else 1<o.values.size&&(s+='~"',o.values.forEach((e=>{s+=e+"|"})),s=s.substr(0,s.length-1)+'"');if(e.overpassApi.useNwr){let e=1===o.elements.size?o.elements.values().next().value:"nwr";t.push(e+"["+s+"]"+a+";"+("node"===e?"":"(._;>;);")+"out;")}else{let e=[];1===o.elements.size?e.push(o.elements.values().next().value):e=["node","way","rel"],e.forEach((e=>{t.push(e+"["+s+"]"+a+";"+("node"===e?"":"(._;>;);")+"out;")}))}})),t}_searchFilters(e){e.isSelected&&0<e.filterTagsArray.length&&(this._filterItems=this._filterItems.concat(e)),e.items.forEach((e=>this._searchFilters(e)))}_computeSearchBounds(){let e=z.map.getCenter(),t=z.map.getBounds(),o=G.getSquareBoundingBox([e.lat,e.lng],5e3);return t.getSouthWest().lat=Math.max(t.getSouthWest().lat,o.getSouthWest().lat),t.getSouthWest().lng=Math.max(t.getSouthWest().lng,o.getSouthWest().lng),t.getNorthEast().lat=Math.min(t.getNorthEast().lat,o.getNorthEast().lat),t.getNorthEast().lng=Math.min(t.getNorthEast().lng,o.getNorthEast().lng),t}constructor(){}async search(){if(this._searchStarted)return;this._searchStarted=!0,this._filterItems=[],this._searchFilters(Un.dictionary);let e=new Qe({searchPlaces:!1});await e.loadData(this._getSearchQueries());let t=new Map;[e.nodes,e.ways,e.relations].forEach((e=>{e.forEach((e=>{e.tags&&this._addPointOfInterest(e,t)}))})),z.searchData=Array.from(t.values()).sort(((e,t)=>e.description>t.description)),this._searchStarted=!1,xe.dispatch("showsearch")}get searchBounds(){return this._computeSearchBounds()}get previousSearchBounds(){return this._previousSearchBounds}};class Fn{_previousSearchLimitObjId=_;_searchLimitObjId=_;_drawSearchLimit(){_===this._searchLimitObjId?this._searchLimitObjId=L.nextObjId:xe.dispatch("removeobject",{objId:this._searchLimitObjId}),xe.dispatch("addrectangle",{objId:this._searchLimitObjId,bounds:Kn.searchBounds,properties:e.osmSearch.nextSearchLimit})}_drawPreviousSearchlimit(){let t=Kn.previousSearchBounds;t&&(_===this._previousSearchLimitObjId?this._previousSearchLimitObjId=L.nextObjId:xe.dispatch("removeobject",{objId:this._previousSearchLimitObjId}),xe.dispatch("addrectangle",{objId:this._previousSearchLimitObjId,bounds:[[t.getSouthWest().lat,t.getSouthWest().lng],[t.getNorthEast().lat,t.getNorthEast().lng]],properties:e.osmSearch.previousSearchLimit}))}constructor(){}show(){z.map.on("zoom",this._drawSearchLimit,this),z.map.on("move",this._drawSearchLimit,this),this._drawSearchLimit(),this._drawPreviousSearchlimit()}hide(){z.map.off("zoom",this._drawSearchLimit,this),z.map.off("move",this._drawSearchLimit,this),_!==this._searchLimitObjId&&(xe.dispatch("removeobject",{objId:this._searchLimitObjId}),this._searchLimitObjId=_),_!==this._previousSearchLimitObjId&&(xe.dispatch("removeobject",{objId:this._previousSearchLimitObjId}),this._previousSearchLimitObjId=_)}}class Vn extends Ye{_osmElement=null;_latLng=r.defaultValue;constructor(e,t=null){super(e,t),this._osmElement=z.searchData[Number.parseInt(e.currentTarget.dataset.tanElementIndex)],this._latLng=[this._osmElement.lat,this._osmElement.lon]}doAction(e){switch(e){case 0:oo.setStartPoint(this._latLng);break;case 1:oo.addWayPoint(this._latLng);break;case 2:oo.setEndPoint(this._latLng);break;case 3:ft.newSearchNote({osmElement:this._osmElement,isTravelNote:!1});break;case 4:ft.newSearchNote({osmElement:this._osmElement,isTravelNote:!0});break;case 5:ft.changeOsmSearchNoteDialog();break;case 6:(new Rt).zoomToPoi({latLng:this._latLng,geometry:this._osmElement.geometry})}}get menuItems(){return[{itemText:M.getText("MapContextMenu - Select this point as start point"),isActive:_!==z.editedRouteObjId&&r.defaultValue===z.travel.editedRoute.wayPoints.first.lat},{itemText:M.getText("MapContextMenu - Select this point as way point"),isActive:_!==z.editedRouteObjId},{itemText:M.getText("MapContextMenu - Select this point as end point"),isActive:_!==z.editedRouteObjId&&r.defaultValue===z.travel.editedRoute.wayPoints.last.lat},{itemText:M.getText("OsmSearchContextMenu - Create a route note with this result"),isActive:!0},{itemText:M.getText("OsmSearchContextMenu - Create a travel note with this result"),isActive:!0},{itemText:M.getText(ft.osmSearchNoteDialog?"OsmSearchContextMenu - Hide note dialog":"OsmSearchContextMenu - Show note dialog"),isActive:!0},{itemText:M.getText("OsmSearchContextMenu - Zoom to this result"),isActive:!0}]}}class Wn{constructor(){}handleEvent(e){e.stopPropagation(),e.preventDefault(),new Vn(e,this.paneDataDiv).show()}}class zn{constructor(){}handleEvent(e){e.stopPropagation();let t=z.searchData[Number.parseInt(e.target.dataset.tanElementIndex)];xe.dispatch("addsearchpointmarker",{objId:Number.parseInt(e.target.dataset.tanObjId),latLng:[t.lat,t.lon],geometry:t.geometry})}}class Gn{constructor(){}handleEvent(e){e.stopPropagation(),xe.dispatch("removeobject",{objId:Number.parseInt(e.target.dataset.tanObjId)})}}class Xn{_paneData=null;_currentOsmElement=null;_currentHtmlElement=null;_elementIndex=0;_eventListeners={onContextMenu:null,onMouseEnter:null,onMouseLeave:null};_buildIcon(){let e="";e=this._currentOsmElement.tags.rcn_ref?"<div class='TravelNotes-MapNote TravelNotes-MapNoteCategory-0073'><svg viewBox='0 0 20 20'><text class='' x=10 y=14>"+this._currentOsmElement.tags.rcn_ref+"</text></svg></div>":Je.getIconContentFromName(this._currentOsmElement.description)||"";let t=Y.create("div",{className:"TravelNotes-OsmSearchPaneUI-SearchResult-IconCell"},this._currentHtmlElement);x.sanitizeToHtmlElement(e,t)}_addOsmTag(e,t){e&&Y.create("div",{textContent:e},t)}_addAddress(e){let t=(this._currentOsmElement.tags["addr:street"]?(this._currentOsmElement.tags["addr:housenumber"]?this._currentOsmElement.tags["addr:housenumber"]+" ":"")+this._currentOsmElement.tags["addr:street"]+" ":"")+(this._currentOsmElement.tags["addr:city"]?(this._currentOsmElement.tags["addr:postcode"]?this._currentOsmElement.tags["addr:postcode"]+" ":"")+this._currentOsmElement.tags["addr:city"]:"");""!==t&&this._addOsmTag(t,e)}_addPhone(e){this._currentOsmElement.tags.phone&&this._addOsmTag("â˜Žï¸ : "+this._currentOsmElement.tags.phone,e)}_addMail(e){this._currentOsmElement.tags.email&&Y.create("a",{href:"mailto:"+this._currentOsmElement.tags.email,textContent:this._currentOsmElement.tags.email},Y.create("div",{textContent:"ðŸ“§ : "},e))}_addWebSite(e){this._currentOsmElement.tags.website&&Y.create("a",{href:this._currentOsmElement.tags.website,target:"_blank",textContent:this._currentOsmElement.tags.website},Y.create("div",null,e))}_addOsmData(){let e=Y.create("div",{className:"TravelNotes-OsmSearchPaneUI-SearchResult-Cell"},this._currentHtmlElement);this._addOsmTag(this._currentOsmElement.description,e),this._addOsmTag(this._currentOsmElement.tags.name,e),this._addOsmTag(this._currentOsmElement.tags.rcn_ref,e),this._addAddress(e),this._addPhone(e),this._addMail(e),this._addWebSite(e)}_addTitle(){for(const[e,t]of Object.entries(this._currentOsmElement.tags))this._currentHtmlElement.title+=e+"="+t+"\n"}_addEventListeners(){this._currentHtmlElement.addEventListener("contextmenu",this._eventListeners.onContextMenu,!1),this._currentHtmlElement.addEventListener("mouseenter",this._eventListeners.onMouseEnter,!1),this._currentHtmlElement.addEventListener("mouseleave",this._eventListeners.onMouseLeave,!1)}_buildHtmlElement(e){this._currentHtmlElement=Y.create("div",{className:"TravelNotes-OsmSearchPaneUI-SearchResult-Row",dataset:{ObjId:L.nextObjId,ElementIndex:this._elementIndex++}},e),this._buildIcon(),this._addOsmData(),this._addTitle(),this._addEventListeners()}constructor(e){this._paneData=e,this._eventListeners.onContextMenu=new Wn,this._eventListeners.onMouseEnter=new zn,this._eventListeners.onMouseLeave=new Gn}addData(){this._currentOsmElement=null,this._currentHtmlElement=null,this._elementIndex=0,z.searchData.forEach((e=>{this._currentOsmElement=e,this._buildHtmlElement(this._paneData)}))}clearData(){for(;this._paneData.firstChild;)this._paneData.firstChild.removeEventListener("contextmenu",this._eventListeners.onContextMenu,!1),this._paneData.firstChild.removeEventListener("mouseenter",this._eventListeners.onMouseEnter,!1),this._paneData.firstChild.removeEventListener("mouseleave",this._eventListeners.onMouseLeave,!1),xe.dispatch("removeobject",{objId:Number.parseInt(this._paneData.firstChild.dataset.tanObjId)}),this._paneData.removeChild(this._paneData.firstChild)}}class Zn{_osmSearchTreeUI=null;_osmSearchWaitUI=null;constructor(e,t){this._osmSearchTreeUI=e,this._osmSearchWaitUI=t}handleEvent(e){e.stopPropagation(),Un.dictionary.isExpanded=!1,this._osmSearchTreeUI.redraw(),z.searchData.length=0,xe.dispatch("showsearch"),this._osmSearchWaitUI.showWait(),Kn.search()}}class Yn{_osmSearchTreeUI=null;constructor(e){this._osmSearchTreeUI=e}handleEvent(e){e.stopPropagation(),Un.expandBranch(Un.dictionary),this._osmSearchTreeUI.redraw()}}class Jn{_osmSearchTreeUI=null;constructor(e){this._osmSearchTreeUI=e}handleEvent(e){e.stopPropagation(),Un.collapseBranch(Un.dictionary),this._osmSearchTreeUI.redraw()}}class qn{_osmSearchTreeUI=null;constructor(e){this._osmSearchTreeUI=e}handleEvent(e){e.stopPropagation(),Un.clearBranch(Un.dictionary),this._osmSearchTreeUI.redraw()}}class Qn{_toolbarHTMLElement=null;constructor(e,t){this._toolbarHTMLElement=Y.create("div"),Y.create("div",{className:"TravelNotes-UI-Button",title:M.getText("OsmSearchPaneUI - Search OpenStreetMap"),textContent:"ðŸ”Ž"},this._toolbarHTMLElement).addEventListener("click",new Zn(e,t),!1),Y.create("div",{className:"TravelNotes-UI-Button",title:M.getText("OsmSearchPaneUI - Expand tree"),textContent:"â–¼"},this._toolbarHTMLElement).addEventListener("click",new Yn(e),!1),Y.create("div",{className:"TravelNotes-UI-Button",title:M.getText("OsmSearchPaneUI - Collapse tree"),textContent:"â–¶"},this._toolbarHTMLElement).addEventListener("click",new Jn(e),!1),Y.create("div",{id:"TravelNotes-OsmSearchPaneUI-ClearAllButton",className:"TravelNotes-UI-Button",title:M.getText("OsmSearchPaneUI - Clear tree"),textContent:"âŒ"},this._toolbarHTMLElement).addEventListener("click",new qn(e),!1)}get toolbarHTMLElement(){return this._toolbarHTMLElement}}class $n{_osmSearchTreeUI=null;constructor(e){this._osmSearchTreeUI=e}handleEvent(e){e.stopPropagation(),Un.selectItemObjId(Number.parseInt(e.target.parentNode.dataset.tanObjId),e.target.checked),this._osmSearchTreeUI.redraw()}}class ea{constructor(){}handleEvent(e){e.stopPropagation(),e.deltaY&&(e.target.scrollTop+=e.deltaY*v[e.deltaMode]),e.stopPropagation()}}class ta{_osmSearchTreeUI=null;constructor(e){this._osmSearchTreeUI=e}handleEvent(e){e.stopPropagation(),Un.changeExpanded(Number.parseInt(e.target.parentNode.dataset.tanObjId)),this._osmSearchTreeUI.redraw()}}class oa{_treeHTMLElement=null;_eventListeners={onClickArrow:null,onChangeCheckbox:null};_deepTree=0;_addItem(e){this._deepTree++;let t=Y.create("div",{className:"TravelNotes-OsmSearchPaneUI-SearchItem TravelNotes-OsmSearchPaneUI-SearchItemMargin"+this._deepTree,dataset:{ObjId:e.objId}},this._treeHTMLElement);if(!e.isRoot){Y.create("input",{type:"checkbox",checked:e.isSelected},t).addEventListener("change",this._eventListeners.onChangeCheckbox,!1)}if(0===e.filterTagsArray.length){Y.create("div",{className:"TravelNotes-UI-Button TravelNotes-OsmSearchPaneUI-TreeArrow",textContent:e.isExpanded?"â–¼":"â–¶"},t).addEventListener("click",this._eventListeners.onClickArrow,!1)}Y.create("text",{value:e.name},t),e.isExpanded&&e.items.forEach((e=>this._addItem(e))),this._deepTree--}constructor(){this._eventListeners.onChangeCheckbox=new $n(this),this._eventListeners.onClickArrow=new ta(this),this._treeHTMLElement=Y.create("div",{id:"TravelNotes-OsmSearchPaneUI-SearchTree"}),this._treeHTMLElement.addEventListener("wheel",new ea,!1),Un.dictionary.name="",this._addItem(Un.dictionary)}redraw(){this._treeHTMLElement.textContent="",this._addItem(Un.dictionary)}get treeHTMLElement(){return this._treeHTMLElement}}class na{_waitDiv=null;_waitBullet=null;constructor(){this._waitDiv=Y.create("div",{className:"TravelNotes-WaitAnimation"}),this._waitDiv.classList.add("TravelNotes-Hidden")}showWait(){this._waitBullet=Y.create("div",{className:"TravelNotes-WaitAnimationBullet"},this._waitDiv),this._waitDiv.classList.remove("TravelNotes-Hidden")}hideWait(){this._waitBullet&&(this._waitDiv.removeChild(this._waitBullet),this._waitBullet=null),this._waitDiv.classList.add("TravelNotes-Hidden")}get waitHTMLElement(){return this._waitDiv}}class aa{_osmSearchTreeUI=null;_osmSearchToolbar=null;_osmSearchWaitUI=null;_paneControl=null;constructor(e){this._paneControl=e,this._osmSearchTreeUI=new oa,this._osmSearchWaitUI=new na,this._osmSearchToolbar=new Qn(this._osmSearchTreeUI,this._osmSearchWaitUI)}addControl(){this._paneControl.appendChild(this._osmSearchToolbar.toolbarHTMLElement),this._paneControl.appendChild(this._osmSearchTreeUI.treeHTMLElement),this._paneControl.appendChild(this._osmSearchWaitUI.waitHTMLElement)}clearControl(){this._paneControl.removeChild(this._osmSearchTreeUI.treeHTMLElement),this._paneControl.removeChild(this._osmSearchToolbar.toolbarHTMLElement),this._osmSearchWaitUI.hideWait(),this._paneControl.removeChild(this._osmSearchWaitUI.waitHTMLElement)}}class sa extends Ln{_osmSearchDataUI=new Xn(this.paneData);_osmSearchControlUI=new aa(this.paneControl);_osmSearchLimitsUI=new Fn;_addControls(){this._osmSearchControlUI.addControl(this.paneControlDiv)}_addData(){this._osmSearchDataUI.addData(this.paneDataDiv)}_clearPaneControlDiv(){this._osmSearchControlUI.clearControl(this.paneControlDiv)}_clearPaneDataDiv(){this._osmSearchDataUI.clearData(this.paneDataDiv)}constructor(e,t){super(e,t)}remove(){this._osmSearchLimitsUI.hide(),this._clearPaneDataDiv(),this._clearPaneControlDiv()}add(){this._osmSearchLimitsUI.show(),this._addControls(),this._addData()}getPaneId(){return s.searchPane}getButtonText(){return M.getText("PanesManagerUI - Search")}}const ia=new class{_mainHTMLElement=null;_travelNotesToolbarUI=null;_travelUI=null;_panesManagerUI=null;_providersToolbarUI=null;_timerId=null;_titleHTMLElement=null;_isPinned=!1;_addMouseEventListeners(){this._mainHTMLElement.addEventListener("click",(e=>{e.target.id&&"TravelNotes-UI-MainDiv"===e.target.id&&(e.stopPropagation(),e.preventDefault())}),!1),this._mainHTMLElement.addEventListener("dblclick",(e=>{e.stopPropagation(),e.preventDefault()}),!1),this._mainHTMLElement.addEventListener("contextmenu",(e=>{e.stopPropagation(),e.preventDefault()}),!1),this._mainHTMLElement.addEventListener("wheel",(e=>{e.stopPropagation(),e.preventDefault()}),!1)}_onMouseLeave(){this._isPinned||(this._timerId=setTimeout((()=>this._hide()),e.travelEditor.timeout))}_show(){if(this._isPinned)return;this._timerId&&(clearTimeout(this._timerId),this._timerId=null),this._mainHTMLElement.classList.remove("TravelNotes-UI-Minimized"),this._titleHTMLElement.classList.add("TravelNotes-Hidden");let e=this._mainHTMLElement.childNodes;for(let t=1;t<e.length;t++)e[t].classList.remove("TravelNotes-Hidden")}_hide(){if(this._isPinned)return;this._mainHTMLElement.classList.add("TravelNotes-UI-Minimized"),this._titleHTMLElement.classList.remove("TravelNotes-Hidden");let e=this._mainHTMLElement.childNodes;for(let t=1;t<e.length;t++)e[t].classList.add("TravelNotes-Hidden")}constructor(){}pin(){this._isPinned=!this._isPinned}createUI(t){this._mainHTMLElement||(this._mainHTMLElement=Y.create("div",{id:"TravelNotes-UI-MainDiv"},t),this._titleHTMLElement=Y.create("div",{id:"TravelNotes-UI-MainDiv-Title",textContent:"TravelÂ &Â Notes"},this._mainHTMLElement),this._travelNotesToolbarUI=new wn(this._mainHTMLElement),this._travelUI=new dn(this._mainHTMLElement),this._panesManagerUI=new un(this._mainHTMLElement),this._panesManagerUI.addPane(An),this._panesManagerUI.addPane(Hn),this._panesManagerUI.addPane(sa),this._providersToolbarUI=new mn(this._mainHTMLElement),this._mainHTMLElement.addEventListener("mouseenter",(()=>this._show()),!1),this._mainHTMLElement.addEventListener("mouseleave",(()=>this._onMouseLeave()),!1),this._addMouseEventListeners(),e.travelEditor.startMinimized?(this._hide(),this._isPinned=!1):(this._show(),this._isPinned=!0))}get travelNotesToolbarUI(){return this._travelNotesToolbarUI}get travelUI(){return this._travelUI}get panesManagerUI(){return this._panesManagerUI}get providersToolbarUI(){return this._providersToolbarUI}};class ra{constructor(){}openDistantFile(e){(new Co).decompress(e),z.travel.readOnly=!0,document.title="Travel & Notes"+(""===z.travel.name?"":" - "+z.travel.name);let t=z.travel.routes.iterator;for(;!t.done;)l.notEdited===t.value.editionStatus&&xe.dispatch("routeupdated",{removedRouteObjId:_,addedRouteObjId:t.value.objId});_!==z.editedRouteObjId&&xe.dispatch("routeupdated",{removedRouteObjId:_,addedRouteObjId:z.travel.editedRoute.objId});let o=z.travel.notes.iterator;for(;!o.done;)xe.dispatch("noteupdated",{removedNoteObjId:_,addedNoteObjId:o.value.objId});(new Rt).zoomToTravel()}}class la extends le{_aboutDiv=null;constructor(e={}){super(e),this._aboutDiv=Y.create("div",{id:"TravelNotes-AboutDialog-AboutDiv"}),x.sanitizeToHtmlElement('<p>This  program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 3 of the License, or any later version.</p><p>Copyright - 2017 2021 - wwwouaiebe</p><p>Contact : <a href="https://www.ouaie.be/pages/Contact" target="_blank">https://www.ouaie.be/</a></p><p>GitHub : <a href="https://github.com/wwwouaiebe/leaflet.TravelNotes" target="_blank">https://github.com/wwwouaiebe/leaflet.TravelNotes</a></p><p>Version : v3.0.0.<p>This program uses: <a href="https://leafletjs.com/" target="_blank">leaflet</a>, <a href="https://github.com/Project-OSRM/osrm-text-instructions" target="_blank">Project-OSRM/osrm-text-instructions</a> and  <a href="https://github.com/drolbr/Overpass-API" target="_blank">the Overpass API</a></p>',this._aboutDiv)}get contentHTMLElements(){return[this._aboutDiv]}get title(){return M.getText("AboutDialog - About Travel & Notes")}}class da extends Ye{_latLng=r.defaultValue;constructor(e,t=null){super(e,t),this._latLng=[this.eventData.lat,this.eventData.lng]}doAction(e){switch(e){case 0:oo.setStartPoint(this._latLng);break;case 1:oo.addWayPoint(this._latLng);break;case 2:oo.setEndPoint(this._latLng);break;case 3:$t.addRoute();break;case 4:$t.hideRoutes();break;case 5:$t.showRoutes();break;case 6:ft.newTravelNote(this._latLng);break;case 7:ft.hideNotes();break;case 8:ft.showNotes();break;case 9:(new Rt).zoomToTravel();break;case 10:(new la).show().catch((()=>{}))}}get menuItems(){return[{itemText:M.getText("MapContextMenu - Select this point as start point"),isActive:_!==z.editedRouteObjId&&r.defaultValue===z.travel.editedRoute.wayPoints.first.lat},{itemText:M.getText("MapContextMenu - Select this point as way point"),isActive:_!==z.editedRouteObjId},{itemText:M.getText("MapContextMenu - Select this point as end point"),isActive:_!==z.editedRouteObjId&&r.defaultValue===z.travel.editedRoute.wayPoints.last.lat},{itemText:M.getText("MapContextMenu - Add a route"),isActive:!0},{itemText:M.getText("MapContextMenu - Hide all routes"),isActive:!0},{itemText:M.getText("MapContextMenu - Show all routes"),isActive:!0},{itemText:M.getText("MapContextMenu - New travel note"),isActive:!0},{itemText:M.getText("MapContextMenu - Hide all notes"),isActive:!0},{itemText:M.getText("MapContextMenu - Show all notes"),isActive:!0},{itemText:M.getText("MapContextMenu - Zoom to travel"),isActive:!0},{itemText:M.getText("MapContextMenu - About Travel & Notes"),isActive:!0}]}}const ha=new class{_travelNotesLoaded=!1;async _loadDistantTravel(e){let t=await fetch(e);if(g===t.status&&t.ok){let e=await t.json();(new ra).openDistantFile(e)}else z.map.setView([r.defaultValue,r.defaultValue],2),document.title="Travel & Notes"}constructor(){}addReadOnlyMap(e,t){this._travelNotesLoaded||(this._travelNotesLoaded=!0,e&&(z.map=e),So.createUI(),Vo.setMapLayer("OSM - Color"),this._loadDistantTravel(t))}addControl(t,n){this._travelNotesLoaded||(this._travelNotesLoaded=!0,t&&(z.map=t,z.map.on("contextmenu",(e=>new da(e).show()))),z.travel=new W,z.travel.routes.add(new F),ia.createUI(document.getElementById(n)),So.createUI(),Pe.setKeysFromServerFile(),e.layersToolbarUI.haveLayersToolbarUI?Vo.createUI():Vo.setMapLayer("OSM - Color"),e.mouseUI.haveMouseUI&&Mo.createUI(),e.travelEditor.startupRouteEdition&&$t.editRoute(z.travel.routes.first.objId),xe.dispatch("setrouteslist"),xe.dispatch("roadbookupdate"),z.map.setView([e.map.center.lat,e.map.center.lng],e.map.zoom),Me.showHelp("<p>"+M.getText("Help - Continue with interface1")+"</p><p>"+M.getText("Help - Continue with interface2")+"</p>"),document.title="Travel & Notes",Mo.saveStatus=o.saved)}addProvider(e){Pe.addProvider(e)}showInfo(e){Me.showInfo(e)}get overpassApiUrl(){return e.overpassApi.url}get map(){return z.map}get version(){return D}};class ca{_copyObjectTo(e,t){if("object"==typeof e&&"object"==typeof t){for(let o in t)"object"==typeof t[o]?this._copyObjectTo(e[o],t[o]):typeof e[o]==typeof t[o]&&("string"==typeof t[o]?t[o]="color"===o?x.sanitizeToColor(e[o])||t[o]:"url"===o?x.sanitizeToUrl(e[o]).url:x.sanitizeToJsString(e[o]):t[o]=e[o]||t[o]);for(let o in e)"object"==typeof e[o]?("[object Array]"===Object.prototype.toString.call(e[o])?t[o]=t[o]||[]:t[o]=t[o]||{},this._copyObjectTo(e[o],t[o])):"string"==typeof t.property?t[o]=x.sanitizeToHtmlString(e[o],[]).htmlString:t[o]=e[o]}}_freeze(e){for(let t in e)"object"==typeof e[t]&&this._freeze(e[t]);Object.freeze(e)}constructor(){}overload(t){this._copyObjectTo(t,e),this._freeze(e)}}class ua{constructor(){}handleEvent(){Mo.saveStatus=o.modified,P.storageAvailable("localStorage")&&No.getOpenPromise().then((()=>{No.getWritePromise(z.UUID,xo.getTravelHTML("TravelNotes-Roadbook-").outerHTML)})).then((()=>localStorage.setItem(z.UUID,Date.now()))).catch((e=>{e instanceof Error&&console.error(e)}))}}(new class{_travelUrl=null;_language=null;_originAndPath=window.location.href.substr(0,window.location.href.lastIndexOf("/")+1)+"TravelNotes";_errorMessage="";_addEventsListeners(){document.addEventListener("routeupdated",(e=>{e.data&&fo.updateRoute(e.data.removedRouteObjId,e.data.addedRouteObjId)}),!1),document.addEventListener("routepropertiesupdated",(e=>{e.data&&fo.updateRouteProperties(e.data.routeObjId)}),!1),document.addEventListener("noteupdated",(e=>{e.data&&fo.updateNote(e.data.removedNoteObjId,e.data.addedNoteObjId)}),!1),document.addEventListener("removeobject",(e=>{e.data&&fo.removeObject(e.data.objId)}),!1),document.addEventListener("removeallobjects",(()=>fo.removeAllObjects()),!1),document.addEventListener("zoomto",(e=>{e.data&&fo.zoomTo(e.data.latLng,e.data.geometry)}),!1),document.addEventListener("additinerarypointmarker",(e=>{e.data&&fo.addItineraryPointMarker(e.data.objId,e.data.latLng)}),!1),document.addEventListener("addsearchpointmarker",(e=>{e.data&&fo.addSearchPointMarker(e.data.objId,e.data.latLng,e.data.geometry)}),!1),document.addEventListener("addrectangle",(e=>{e.data&&fo.addRectangle(e.data.objId,e.data.bounds,e.data.properties)}),!1),document.addEventListener("addwaypoint",(e=>{e.data&&fo.addWayPoint(e.data.wayPoint,e.data.letter)}),!1),document.addEventListener("layerchange",(e=>{e.data&&fo.setLayer(e.data.layer)})),document.addEventListener("geolocationpositionchanged",(e=>{e.data&&fo.onGeolocationPositionChanged(e.data.position)}),!1),document.addEventListener("geolocationstatuschanged",(e=>{e.data&&fo.onGeolocationStatusChanged(e.data.status)}),!1),document.addEventListener("roadbookupdate",new ua,!1),document.addEventListener("profileclosed",(e=>{e.data&&Wt.onProfileClosed(e.data.objId)}),!1),document.addEventListener("uipinned",(()=>ia.pin()),!1),document.addEventListener("geolocationstatuschanged",(e=>{ia.travelNotesToolbarUI.geoLocationStatusChanged(e.data.status)}),!1),document.addEventListener("travelnameupdated",(()=>ia.travelUI.setTravelName()),!1),document.addEventListener("setrouteslist",(()=>ia.travelUI.routesListUI.setRoutesList()),!1),document.addEventListener("showitinerary",(()=>ia.panesManagerUI.showPane(s.itineraryPane)),!1),document.addEventListener("updateitinerary",(()=>ia.panesManagerUI.updatePane(s.itineraryPane)),!1),document.addEventListener("showtravelnotes",(()=>ia.panesManagerUI.showPane(s.travelNotesPane)),!1),document.addEventListener("updatetravelnotes",(()=>ia.panesManagerUI.updatePane(s.travelNotesPane)),!1),document.addEventListener("showsearch",(()=>ia.panesManagerUI.showPane(s.searchPane)),!1),document.addEventListener("updatesearch",(()=>ia.panesManagerUI.updatePane(s.searchPane)),!1),document.addEventListener("providersadded",(()=>ia.providersToolbarUI.providersAdded()),!1),document.addEventListener("setprovider",(e=>{e.data&&e.data.provider&&(ia.providersToolbarUI.provider=e.data.provider)}),!1),document.addEventListener("settransitmode",(e=>{e.data&&e.data.transitMode&&(ia.providersToolbarUI.transitMode=e.data.transitMode)}),!1)}_addUnloadEventsListeners(){window.addEventListener("unload",(()=>localStorage.removeItem(z.UUID))),window.addEventListener("beforeunload",(t=>{if(No.closeDb(z.UUID),e.travelNotes.haveBeforeUnloadWarning)return t.returnValue="x","x"}))}_readURL(){let e=new URL(window.location),t=e.searchParams.get("fil");if(t&&0!==t.length)try{if(t=atob(t),t.match(/[^\w-%:./]/))throw new Error("invalid char in the url encoded in the fil parameter");let o=new URL(t);if(!(e.protocol&&o.protocol&&e.protocol===o.protocol&&e.hostname&&o.hostname&&e.hostname===o.hostname))throw new Error("The distant file is not on the same site than the app");this._travelUrl=encodeURI(o.href)}catch(e){e instanceof Error&&console.error(e)}let o=e.searchParams.get("lng");o&&o.match(/^[A-Z,a-z]{2}$/)&&(this._language=o.toLowerCase())}async _loadConfig(){let t=await fetch(this._originAndPath+"Config.json");if(g===t.status&&t.ok){let o=await t.json();return o.travelNotes.language=this._language||o.travelNotes.language,"wwwouaiebe.github.io"===window.location.hostname&&(o.APIKeysDialog.haveUnsecureButtons=!0,o.errorsUI.showHelp=!0,o.layersToolbarUI.theDevil.addButton=!1,o.note.maxManeuversNotes=10,o.note.haveBackground=!0,o.noteDialog.theDevil.addButton=!1,o.printRouteMap.maxTiles=120,o.route.showDragTooltip=p),(new ca).overload(o),z.providers.forEach((t=>{t.userLanguage=e.travelNotes.language})),!0}return!1}async _loadTranslations(e,t){return"fulfilled"===e.status&&g===e.value.status&&e.value.ok?(M.setTranslations(await e.value.json()),!0):"fulfilled"===t.status&&g===t.value.status&&t.value.ok?(M.setTranslations(await t.value.json()),this._errorMessage+="Not possible to load the TravelNotes"+this._language.toUpperCase()+".json file. English will be used. ",!0):(this._errorMessage+="Not possible to load the translations. ",!1)}async _loadNoteDialogConfig(e,t){if("fulfilled"===e.status&&g===e.value.status&&e.value.ok){let t=await e.value.json();return Je.loadJson(t),!0}if("fulfilled"===t.status&&g===t.value.status&&t.value.ok){let e=await t.value.json();return Je.loadJson(e),this._errorMessage+="Not possible to load the TravelNotesNoteDialog"+this._language.toUpperCase()+".json file. English will be used. ",!0}return this._errorMessage+="Not possible to load the translations for the note dialog. ",!1}async _loadOsmSearchDictionary(e,t){return"fulfilled"===e.status&&g===e.value.status&&e.value.ok?(Un.parseDictionary(await e.value.text()),!0):"fulfilled"===t.status&&g===t.value.status&&t.value.ok?(Un.parseDictionary(await t.value.text()),this._errorMessage+="Not possible to load the TravelNotesSearchDictionary"+this._language.toUpperCase()+".csv file. English will be used. ",!0):(this._errorMessage+="Not possible to load the search dictionary. OSM search will not be available.",!0)}async _loadMapLayers(e){return"fulfilled"===e.status&&g===e.value.status&&e.value.ok?(Zt.addMapLayers(await e.value.json()),!0):(this._errorMessage+="Not possible to load the TravelNotesLayers.json file. Only the OpenStreetMap background will be available. ",!0)}async _loadJsonFiles(){let e=await Promise.allSettled([fetch(this._originAndPath+this._language.toUpperCase()+".json"),fetch(this._originAndPath+"EN.json"),fetch(this._originAndPath+"NoteDialog"+this._language.toUpperCase()+".json"),fetch(this._originAndPath+"NoteDialogEN.json"),fetch(this._originAndPath+"SearchDictionary"+this._language.toUpperCase()+".csv"),fetch(this._originAndPath+"SearchDictionaryEN.csv"),fetch(this._originAndPath+"Layers.json")]),t=await this._loadTranslations(e[0],e[1])&&await this._loadNoteDialogConfig(e[2],e[3])&&await this._loadOsmSearchDictionary(e[4],e[5])&&await this._loadMapLayers(e[6]);return""!==this._errorMessage&&t?Me.showError(this._errorMessage):""!==this._errorMessage&&(document.body.textContent=this._errorMessage),t}_loadTravelNotes(){if(e.travelNotes.autoLoad){let e=document.createElement("div");e.id="TravelNotes-Map",document.body.appendChild(e),Y.create("div",{id:"TravelNotes-UI"},document.body);let t=window.L.map("TravelNotes-Map",{attributionControl:!1,zoomControl:!1}).setView([r.defaultValue,r.defaultValue],0);this._travelUrl?ha.addReadOnlyMap(t,this._travelUrl):(this._addUnloadEventsListeners(),ha.addControl(t,"TravelNotes-UI")),e.focus()}}constructor(){}async loadApp(){this._addEventsListeners(),this._originAndPath=window.location.href.substr(0,window.location.href.lastIndexOf("/")+1)+"TravelNotes",window.TaN=ha,this._readURL(),await this._loadConfig()?(this._language=this._language||e.travelNotes.language||"fr",Me.createUI(),await this._loadJsonFiles()&&this._loadTravelNotes()):document.body.textContent="Not possible to load the TravelNotesConfig.json file. "}}).loadApp()}();