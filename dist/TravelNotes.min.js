/**
 * 
 * @source: https://github.com/wwwouaiebe/leaflet.TravelNotes
 * 
 * @licstart  The following is the entire license notice for the
 * JavaScript code in this page.
 * 
 * leaflet.travelnotes - version 2.3.0
 * Build 02577 - 2021-09-01T12:31:37+0200 
 * Copyright 2017 2021 wwwouaiebe 
 * Contact: https://www.ouaie.be/
 * License: GPL-3.0
 * 
 * The JavaScript code in this page is free software: you can
 * redistribute it and/or modify it under the terms of the GNU
 * General Public License (GNU GPL) as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option)
 * any later version.  The code is distributed WITHOUT ANY WARRANTY;
 * without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.
 * 
 * As additional permission under GNU GPL version 3 section 7, you
 * may distribute non-source (e.g., minimized or compacted) forms of
 * that code without the copy of the GNU GPL normally required by
 * section 4, provided you include this license notice and a URL
 * through which recipients can access the Corresponding Source.
 * 
 * @licend  The above is the entire license notice
 * for the JavaScript code in this page.
 * 
 */


!function(){"use strict";
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file Config.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/let e={APIKeys:{saveToSessionStorage:!0},APIKeysDialog:{haveUnsecureButtons:!0,showAPIKeys:!0,showButton:!0},contextMenu:{timeout:1500},errorsUI:{helpTimeOut:3e4,showError:!0,showHelp:!0,showInfo:!0,showWarning:!0,timeOut:1e4},geoCoder:{distances:{city:1200,hamlet:200,town:1500,village:400},osmCityAdminLevel:{DEFAULT:"8",GB:"10"}},geoLocation:{marker:{color:"#ff0000",radius:11},options:{enableHighAccuracy:!1,maximumAge:0,timeout:1/0},zoomFactor:17,zoomToPosition:!0},itineraryPaneUI:{showManeuvers:!1,showNotes:!0},itineraryPoint:{marker:{color:"#ff0000",fill:!1,radius:7,weight:2},zoomFactor:17},layersToolbarUI:{haveLayersToolbarUI:!0,toolbarTimeOut:1500,theDevil:{addButton:!1}},map:{center:{lat:50.50923,lng:5.49542},zoom:12},mouseUI:{haveMouseUI:!0},nominatim:{url:"https://nominatim.openstreetmap.org/",language:"*"},note:{grip:{size:10,opacity:0,moveOpacity:1},haveBackground:!1,maxManeuversNotes:100,polyline:{color:"#808080",weight:1},reverseGeocoding:!1,svgIcon:{angleDistance:10,angleDirection:{right:35,slightRight:80,continue:100,slightLeft:145,left:200,sharpLeft:270,sharpRight:340},rcnRefDistance:20,roadbookFactor:1,zoom:17}},noteDialog:{areaHeight:{icon:2,popupContent:8},mask:{iconsDimension:!0,iconTextArea:!1,tooltip:!1,popupContent:!1,address:!1,link:!1,phone:!0},theDevil:{addButton:!1,zoomFactor:17}},osmSearch:{nextSearchLimit:{color:"#ff0000",fill:!1,weight:1},previousSearchLimit:{color:"#006400",fill:!1,weight:1},searchPointMarker:{color:"#006400",fill:!1,radius:20,weight:4},searchPointPolyline:{color:"#006400",fill:!1,weight:4},showSearchNoteDialog:!1},overpassApi:{timeOut:40,url:"https://lz4.overpass-api.de/api/interpreter"},printRouteMap:{isEnabled:!0,maxTiles:240,paperWidth:287,paperHeight:200,pageBreak:!1,printNotes:!0,borderWidth:30,zoomFactor:15,entryPointMarker:{color:"#00ff00",weight:4,radius:10,fill:!0,fillOpacity:1},exitPointMarker:{color:"#ff0000",weight:4,radius:10,fill:!0,fillOpacity:1}},route:{color:"#ff0000",dashArray:0,dashChoices:[{text:"——————",iDashArray:[0]},{text:"— — — — —",iDashArray:[4,2]},{text:"—‧—‧—‧—‧—",iDashArray:[4,2,0,2]},{text:"················",iDashArray:[0,2]}],elev:{smooth:!0,smoothCoefficient:.25,smoothPoints:3},showDragTooltip:3,width:3},routeEditor:{showEditedRouteInRoadbook:!0},travelEditor:{startMinimized:!0,startupRouteEdition:!0,timeout:1e3},travelNotes:{autoLoad:!0,haveBeforeUnloadWarning:!0,language:"fr"},travelNotesToolbarUI:{contactMail:{url:"https://github.com/wwwouaiebe/leaflet.TravelNotes/issues"}},wayPoint:{reverseGeocoding:!1,geocodingIncludeName:!1}};
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file Constants.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/const t=Object.freeze({minColorValue:0,maxColorValue:255,rowsNumber:6,cellsNumber:6,deltaColor:51,sliderMaxValue:100,sliderStep:20,initialRed:0}),o=Object.freeze({notSaved:"🔴",modified:"🟡",saved:"🟢"}),a=Object.freeze({fixed:2,invalid:-1,defaultValue:0,metersInKm:1e3}),n=Object.freeze({refusedByUser:-1,disabled:0,inactive:1,active:2}),s=Object.freeze({invalidPane:"43a6a53e-008a-4910-80a6-7a87d301ea15",itineraryPane:"8fbf0da7-4e6f-4bc7-8e20-1388461ccde7",travelNotesPane:"dffe782b-07df-4b81-a318-f287c0cf5ec6",searchPane:"228f00d7-43a8-4c13-897d-70400cb6dd58"}),i=Object.freeze({fixed:2,defaultValue:0}),r=Object.freeze({defaultValue:0,fixed:6,maxLat:90,minLat:-90,maxLng:180,minLng:-180}),l=Object.freeze({notEdited:0,editedNoChange:1,editedChanged:2}),d=Object.freeze({margin:100,height:500,width:1e3,yDeltaText:30,xDeltaText:10,vScales:[1,2,5,10,20,50,100,200,500,1e3,2e3,5e3],hScales:[1,2,5,10,20,50,100,200,500,1e3,2e3,5e3,1e4,2e4,5e4,1e5]}),h=Object.freeze({width:40,height:40,svgViewboxDim:200}),c=Object.freeze({d0:0,d90:90,d180:180,d270:270,d360:360,d540:540,toRadians:Math.PI/180,fromRadians:180/Math.PI}),u=Object.freeze({atStart:-1,onRoute:0,atEnd:1}),v=[.3,10,1],p=-1,m=-1,g=16,b=200,y="http://www.w3.org/2000/svg",I=6371e3,w=20,L=20;class T{static#objId=0;static get nextObjId(){return++T.#objId}}
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file Version.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/const D="2.3.0";class f{#objTypeName="";#validObjTypeNames=["Itinerary","ItineraryPoint","Maneuver","Note","Route","Travel","WayPoint"];constructor(e){if(m===this.#validObjTypeNames.indexOf(e))throw new Error("Invalid ObjType name : "+e);this.#objTypeName=e,Object.freeze(this)}get name(){return this.#objTypeName}get version(){return D}get jsonObject(){return{name:this.#objTypeName,version:D}}validate(e){if(!Object.getOwnPropertyNames(e).includes("name"))throw new Error("No name for "+this.#objTypeName);if(this.#objTypeName!==e.name)throw new Error("Invalid name for "+this.#objTypeName);if(!Object.getOwnPropertyNames(e).includes("version"))throw new Error("No version for "+this.#objTypeName)}}class E{#collection=null;#index=m;constructor(e){this.#collection=e,Object.freeze(this)}get value(){return this.#index<this.#collection.length?this.#collection.at(this.#index):null}get previous(){return 0>=this.#index?null:this.#collection.at(this.#index-1)}get next(){return this.#index<this.#collection.length-1?this.#collection.at(this.#index+1):null}get done(){return++this.#index>=this.#collection.length}get first(){return 0===this.#index}get last(){return this.#index>=this.#collection.length-1}get index(){return this.#index}}class N{#array=[];#objName="";#classCollection=null;#indexOfObjId(e){return this.#array.findIndex((t=>t.objId===e))}#nextOrPrevious(e,t,o){let a=this.#indexOfObjId(e);if(m===a)throw new Error("invalid objId for next or previous function");if(1!==o&&-1!==o)throw new Error("invalid direction");let n=t;for(n||(n=()=>!0),a+=o;m<a&&a<this.#array.length&&!n(this.#array[a]);)a+=o;return m===a||this.#array.length===a?null:this.#array[a]}constructor(e){this.#classCollection=e;let t=new e;if(!t.objType||!t.objType.name)throw new Error("invalid object name for collection");this.#objName=t.objType.name,Object.freeze(this)}add(e){if(!e.objType||!e.objType.name||e.objType.name!==this.#objName)throw new Error("invalid object name for add function");this.#array.push(e)}at(e){return e<this.#array.length&&e>m?this.#array[e]:null}forEach(e){let t=null,o=this.iterator;for(;!o.done;)t=e(o.value,t);return t}getAt(e){let t=this.#indexOfObjId(e);return m===t?null:this.#array[t]}moveTo(e,t,o){let a=this.#indexOfObjId(e),n=this.#indexOfObjId(t);if(m===a||m===n)throw new Error("invalid objId for function  myMoveTo");o||n++,this.#array.splice(n,0,this.#array[a]),n<a&&a++,this.#array.splice(a,1)}next(e,t){return this.#nextOrPrevious(e,t,1)}previous(e,t){return this.#nextOrPrevious(e,t,-1)}remove(e){let t=this.#indexOfObjId(e);if(m===t)throw new Error("invalid objId for remove function");this.#array.splice(this.#indexOfObjId(e),1)}removeAll(e){e?this.#array.splice(1,this.#array.length-2):this.#array.length=0}replace(e,t){let o=this.#indexOfObjId(e);if(m===o)throw new Error("invalid objId for replace function");if(!t.objType||!t.objType.name||t.objType.name!==this.#objName)throw new Error("invalid object name for replace function");this.#array[o]=t}reverse(){this.#array.reverse()}sort(e){this.#array.sort(e)}swap(e,t){let o=this.#indexOfObjId(e);if(m===o||0===o&&t||this.#array.length-1===o&&!t)throw new Error("invalid objId for swap function");let a=this.#array[o];this.#array[o]=this.#array[o+(t?-1:1)],this.#array[o+(t?-1:1)]=a}get first(){return this.#array[0]}get iterator(){return new E(this)}get last(){return this.#array[this.#array.length-1]}get length(){return this.#array.length}get jsonObject(){let e=[],t=this.iterator;for(;!t.done;)e.push(t.value.jsonObject);return e}set jsonObject(e){this.#array.length=0;let t=null;e.forEach((e=>{t=new this.#classCollection,t.jsonObject=e,this.add(t)}))}}const x=Object.freeze(new class{#validityMap=new Map;#parser=new DOMParser;#addHtmlEntities(e){return e.replaceAll(/</g,"&lt;").replaceAll(/>/g,"&gt;").replaceAll(/"/g,"&quot;").replaceAll(/\u0027/g,"&apos;").replaceAll(/\u0a00/g,"&nbsp;")}#stringify(e){let t="",o="",a=e.childNodes;for(let n=0;n<a.length;n++){let a=e.childNodes[n],s=a.nodeName.toLowerCase(),i=this.#validityMap.get(s);if(i){i=i.concat(["id","class","dir","title","tanwidth","tanheight"]);let e="svg"===s||"text"===s||"polyline"===s;t+="<"+s,a.hasAttribute("target")&&(t+=' rel="noopener noreferrer"'),i.forEach((n=>{if(e)a.hasAttributeNS(null,n)&&(t+=" "+n+'="'+this.#addHtmlEntities(a.getAttribute(n))+'"',a.removeAttribute(n));else if(a.hasAttribute(n))if("href"===n||"src"===n){let e=this.sanitizeToUrl(a.getAttribute(n),n).url;""===e?o+="\nAn invalid url ("+a.getAttribute(n)+") was removed from a "+n+" attribute":t+=" "+n+'="'+e+'"',a.removeAttribute(n)}else t+=" "+n+'="'+this.#addHtmlEntities(a.getAttribute(n))+'"',a.removeAttribute(n)})),t+=">";let n="",r="";[n,r]=this.#stringify(a),t+=n,o+=r,t+="</"+s+">"}else"#text"===s?t+=this.#addHtmlEntities(a.nodeValue):o+="\nAn invalid tag "+s+" was removed";if(a.hasAttributes)for(let e=0;e<a.attributes.length;e++)"rel"!==a.attributes[e].name&&(o+="\nAn unsecure attribute "+a.attributes[e].name+'="'+a.attributes[e].value+'" was removed.')}return[t,o]}#cloneNode(e,t){let o=e.childNodes;for(let a=0;a<o.length;a++){let o=e.childNodes[a],n=o.nodeName.toLowerCase(),s=this.#validityMap.get(n);if(s){s=s.concat(["id","class","dir","title","tanwidth","tanheight"]);let e="svg"===n||"text"===n||"polyline"===n,a=e?document.createElementNS(y,n):document.createElement(n);if(s.forEach((t=>{if(e)o.hasAttributeNS(null,t)&&(a.setAttributeNS(null,t,o.getAttribute(t)),o.removeAttributeNS(null,t));else if(o.hasAttribute(t))if("href"===t||"src"===t){let e=this.sanitizeToUrl(o.getAttribute(t),t).url;""!==e&&a.setAttribute(t,e)}else a.setAttribute(t,o.getAttribute(t))})),o.hasAttribute("style")){o.getAttribute("style").split(";").forEach((e=>{let t=e.split(":");2!==t.length||"width"!==t[0].trim()&&"height"!==t[0].trim()||(a.style[t[0].trim()]=t[1].trim())}))}o.hasAttribute("target")&&a.setAttribute("rel","noopener noreferrer"),t.appendChild(a),this.#cloneNode(o,a)}else"#text"===n&&t.appendChild(document.createTextNode(o.nodeValue))}}constructor(){this.#validityMap.set("a",["href","target"]),this.#validityMap.set("div",[]),this.#validityMap.set("del",[]),this.#validityMap.set("em",[]),this.#validityMap.set("figcaption",[]),this.#validityMap.set("figure",[]),this.#validityMap.set("h1",[]),this.#validityMap.set("h2",[]),this.#validityMap.set("h3",[]),this.#validityMap.set("h4",[]),this.#validityMap.set("h5",[]),this.#validityMap.set("h6",[]),this.#validityMap.set("hr",[]),this.#validityMap.set("img",["src","alt","width","height"]),this.#validityMap.set("ins",[]),this.#validityMap.set("li",[]),this.#validityMap.set("mark",[]),this.#validityMap.set("ol",[]),this.#validityMap.set("p",[]),this.#validityMap.set("s",[]),this.#validityMap.set("small",[]),this.#validityMap.set("strong",[]),this.#validityMap.set("span",[]),this.#validityMap.set("sub",[]),this.#validityMap.set("sup",[]),this.#validityMap.set("ul",[]),this.#validityMap.set("svg",["xmlns","viewBox","class"]),this.#validityMap.set("text",["x","y","text-anchor"]),this.#validityMap.set("polyline",["points","class","transform"])}sanitizeToColor(e){let t=e.match(/^\u0023[0-9,A-F,a-f]{6}$/);return t?t[0]:null}sanitizeToUrl(e,t="href"){let o=this.#parser.parseFromString("<div>"+e+"</div>","text/html");if(!o||"#document"!==o.nodeName)return{url:"",errorsString:"Parsing error"};let a=o.body.firstChild,n="";for(let e=0;e<a.childNodes.length;e++){if("#text"!==a.childNodes[e].nodeName)return{url:"",errorsString:"Invalid characters found in the url"};n+=a.childNodes[e].nodeValue}if(n=n.replaceAll(/</g,"").replaceAll(/>/g,"").replaceAll(/"/g,"").replaceAll(/\u0027/g,"").replaceAll(/&lt;/g,"").replaceAll(/&gt;/g,"").replaceAll(/&quot;/g,"").replaceAll(/&apos;/g,"").replaceAll(/%3C/g,"").replaceAll(/%3c/g,"").replaceAll(/%3E/g,"").replaceAll(/%3e/g,"").replaceAll(/%22/g,"").replaceAll(/%27/g,""),n!==e)return{url:"",errorsString:"Invalid characters found in the url"};let s=["https:"];if("http:"!==window.location.protocol&&"href"!==t||s.push("http:"),"href"===t){s.push("mailto:"),s.push("sms:"),s.push("tel:");let e=n.match(/^\u0023\w*/);if(e&&n===e[0])return{url:n,errorsString:""}}"src"===t&&s.push("data:");let i=null;try{i=new URL(n)}catch(e){return{url:"",errorsString:"Invalid url string"}}if(m===s.indexOf(i.protocol))return{url:"",errorsString:"Invalid protocol "+i.protocol};if(m!==["sms:","tel:"].indexOf(i.protocol)&&i.pathname.match(/^\+[0-9,*,\u0023]*$/))return{url:n,errorsString:""};try{encodeURIComponent(i.href)}catch(e){return{url:"",errorsString:"Invalid character in url"}}return{url:n,errorsString:""}}sanitizeToJsString(e){let t=this.#parser.parseFromString("<div>"+e+"</div>","text/html");if(!t||"#document"!==t.nodeName)return"";let o=t.body.firstChild,a="";for(let e=0;e<o.childNodes.length;e++){if("#text"!==o.childNodes[e].nodeName)return"";a+=o.childNodes[e].nodeValue}return a=a.replaceAll(/</g,"≺").replaceAll(/>/g,"≻").replaceAll(/"/g,"″").replaceAll(/\u0027/g,"′"),a}sanitizeToHtmlElement(e,t){let o=this.#parser.parseFromString("<div>"+e+"</div>","text/html");o&&"#document"===o.nodeName?this.#cloneNode(o.body.firstChild,t):t.textContent=""}sanitizeToHtmlString(e){let t="",o="",a=this.#parser.parseFromString("<div>"+e.replace("&nbsp;","਀")+"</div>","text/html");return a&&"#document"===a.nodeName?([t,o]=this.#stringify(a.body.firstChild,o),{htmlString:t,errorsString:o}):{htmlString:"",errorsString:"Parsing error"}}});const M=new class{#translations=new Map;constructor(){Object.freeze(this)}setTranslations(e){e.forEach((e=>this.#translations.set(e.msgid,x.sanitizeToJsString(e.msgstr))))}getText(e,t){let o=this.#translations.get(e);return t&&o&&Object.getOwnPropertyNames(t).forEach((e=>o=o.replace("{"+e+"}",t[e]))),o||e}};const P=new class{constructor(){Object.freeze(this)}get UUID(){let e=new Uint8Array(16);const t=["","","","-","","-","","-","","-","","","","","",""];window.crypto.getRandomValues(e),e[6]=15&e[6]|64,e[8]=63&e[8]|128;let o="";for(let a=0;a<16;a++)o+=e[a].toString(g).padStart(2,"0")+t[a];return o}storageAvailable(e){try{let t=window[e],o="__storage_test__";return t.setItem(o,o),t.removeItem(o),!0}catch(e){return!1}}openFile(e,t){let o=document.createElement("input");o.type="file",t&&(o.accept=t),o.addEventListener("change",e,!1),o.click()}saveFile(e,t,o){try{let a=null;a=o?window.URL.createObjectURL(new File([t],e,{type:o})):URL.createObjectURL(t);let n=document.createElement("a");n.setAttribute("href",a),n.setAttribute("download",e),n.click(),window.URL.revokeObjectURL(a)}catch(e){e instanceof Error&&console.error(e)}}formatTime(e){let t=Math.floor(e);if(0===t)return"";let o=Math.floor(t/86400),a=Math.floor(t%86400/3600),n=Math.floor(t%3600/60),s=Math.floor(t%60);return 0<o?o+" "+M.getText("Utilities - Day")+" "+a+" "+M.getText("Utilities - Hour"):0<a?a+" "+M.getText("Utilities - Hour")+" "+n+" "+M.getText("Utilities - Minute"):0<n?n+" "+M.getText("Utilities - Minute"):s+" "+M.getText("Utilities - Second")}formatDistance(e){let t=Math.floor(e);return 0>=t?"0 km":Math.floor(t/a.metersInKm)+","+Math.floor(t%a.metersInKm/10).toFixed(0).padStart(2,"0").padEnd(3,"0")+" km"}formatLat(e){return e>0?e.toFixed(r.fixed)+" N":(-e).toFixed(r.fixed)+" S"}formatLng(e){return e>0?e.toFixed(r.fixed)+" E":(-e).toFixed(r.fixed)+" W"}formatLatLng(e){return 0===e[0]&&0===e[1]?"":this.formatLat(e[0])+" - "+this.formatLng(e[1])}},C=new f("WayPoint");class j{#objId=p;#upgradeObject(e){switch(e.objType.version){case"1.0.0":case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":case"1.5.0":case"1.6.0":case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":e.address=e.name,e.name="";case"1.12.0":case"1.13.0":case"2.0.0":case"2.1.0":case"2.2.0":e.objType.version="2.3.0";break;default:throw new Error("invalid version for "+C.name)}}#validateObject(e){if(!Object.getOwnPropertyNames(e).includes("objType"))throw new Error("No objType for "+C.name);C.validate(e.objType),C.version!==e.objType.version&&this.#upgradeObject(e);let t=Object.getOwnPropertyNames(e);return["address","name","lat","lng","objId"].forEach((e=>{if(!t.includes(e))throw new Error("No "+e+" for "+C.name)})),e}constructor(){this.name="",this.address="",this.lat=r.defaultValue,this.lng=r.defaultValue,this.#objId=T.nextObjId,Object.seal(this)}get fullName(){let e=""===this.name?this.address:this.name+", "+this.address;return""===e&&(e=P.formatLatLng([this.lat,this.lng])),e}get latLng(){return[this.lat,this.lng]}set latLng(e){this.lat=e[0],this.lng=e[1]}get objId(){return this.#objId}get objType(){return C}get jsonObject(){return{name:this.name,address:this.address,lat:parseFloat(this.lat.toFixed(r.fixed)),lng:parseFloat(this.lng.toFixed(r.fixed)),objId:this.#objId,objType:C.jsonObject}}set jsonObject(e){let t=this.#validateObject(e);this.address=t.address||"",this.name=t.name||"",this.lat=t.lat||r.defaultValue,this.lng=t.lng||r.defaultValue,this.#objId=T.nextObjId,this.validateData()}validateData(){"string"==typeof this.address?this.address=x.sanitizeToJsString(this.address):this.address="","string"==typeof this.name?this.name=x.sanitizeToJsString(this.name):this.name="","number"!=typeof this.lat&&(this.lat=r.defaultValue),"number"!=typeof this.lng&&(this.lng=r.defaultValue)}}const A=new f("ItineraryPoint");class O{#objId=p;#upgradeObject(e){switch(e.objType.version){case"1.0.0":case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":case"1.5.0":case"1.6.0":e.elev=i.defaultValue;case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":case"1.12.0":case"1.13.0":case"2.0.0":case"2.1.0":case"2.2.0":e.objType.version="2.3.0";break;default:throw new Error("invalid version for "+A.name)}}#validateObject(e){if(!Object.getOwnPropertyNames(e).includes("objType"))throw new Error("No objType for "+A.name);A.validate(e.objType),A.version!==e.objType.version&&this.#upgradeObject(e);let t=Object.getOwnPropertyNames(e);return["lat","lng","distance","elev","objId"].forEach((e=>{if(!t.includes(e))throw new Error("No "+e+" for "+A.name)})),e}constructor(){this.lat=r.defaultValue,this.lng=r.defaultValue,this.distance=a.defaultValue,this.elev=i.defaultValue,this.#objId=T.nextObjId,Object.seal(this)}get latLng(){return[this.lat,this.lng]}set latLng(e){this.lat=e[0],this.lng=e[1]}get objType(){return A}get objId(){return this.#objId}get jsonObject(){return{lat:parseFloat(this.lat.toFixed(r.fixed)),lng:parseFloat(this.lng.toFixed(r.fixed)),distance:parseFloat(this.distance.toFixed(a.fixed)),elev:parseFloat(this.elev.toFixed(i.fixed)),objId:this.#objId,objType:A.jsonObject}}set jsonObject(e){let t=this.#validateObject(e);this.lat=t.lat||r.defaultValue,this.lng=t.lng||r.defaultValue,this.distance=t.distance||a.defaultValue,this.elev=t.elev||i.defaultValue,this.#objId=T.nextObjId,this.validateData()}validateData(){"number"!=typeof this.lat&&(this.lat=r.defaultValue),"number"!=typeof this.lng&&(this.lng=r.defaultValue),"number"!=typeof this.distance&&(this.distance=a.defaultValue),"number"!=typeof this.elev&&(this.elev=i.defaultValue)}}const S=new f("Maneuver");class k{#objId=p;#upgradeObject(e){switch(e.objType.version){case"1.0.0":case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":case"1.5.0":case"1.6.0":case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":"kArriveDefault"===e.iconName&&(e.distance=a.defaultValue);case"1.12.0":case"1.13.0":case"2.0.0":case"2.1.0":case"2.2.0":e.objType.version="2.3.0";break;default:throw new Error("invalid version for "+S.name)}}#validateObject(e){if(!Object.getOwnPropertyNames(e).includes("objType"))throw new Error("No objType for "+S.name);S.validate(e.objType),S.version!==e.objType.version&&this.#upgradeObject(e);let t=Object.getOwnPropertyNames(e);return["iconName","instruction","distance","duration","itineraryPointObjId","objId"].forEach((e=>{if(!t.includes(e))throw new Error("No "+e+" for "+S.name)})),e}constructor(){this.iconName="",this.instruction="",this.itineraryPointObjId=p,this.distance=a.defaultValue,this.duration=a.defaultValue,this.#objId=T.nextObjId,Object.seal(this)}get objType(){return S}get objId(){return this.#objId}get jsonObject(){return{iconName:this.iconName,instruction:this.instruction,distance:parseFloat(this.distance.toFixed(a.fixed)),duration:this.duration,itineraryPointObjId:this.itineraryPointObjId,objId:this.#objId,objType:S.jsonObject}}set jsonObject(e){let t=this.#validateObject(e);this.iconName=t.iconName||"",this.instruction=t.instruction||"",this.distance=t.distance||a.defaultValue,this.duration=t.duration||a.defaultValue,this.itineraryPointObjId=t.itineraryPointObjId||p,this.#objId=T.nextObjId,this.validateData()}validateData(){"string"==typeof this.iconName?this.iconName=x.sanitizeToJsString(this.iconName):this.iconName="","string"==typeof this.instruction?this.instruction=x.sanitizeToJsString(this.instruction):this.instruction="","number"!=typeof this.distance&&(this.distance=a.defaultValue),"number"!=typeof this.duration&&(this.duration=a.defaultValue),"number"!=typeof this.itineraryPointObjId&&(this.itineraryPointObjId=p)}}const R=new f("Itinerary");class H{#objId=p;#upgradeObject(e){switch(e.objType.version){case"1.0.0":case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":case"1.5.0":case"1.6.0":e.hasProfile=!1,e.ascent=0,e.descent=0;case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":case"1.12.0":case"1.13.0":case"2.0.0":case"2.1.0":case"2.2.0":e.objType.version="2.3.0";break;default:throw new Error("invalid version for "+R.name)}}#validateObject(e){if(!Object.getOwnPropertyNames(e).includes("objType"))throw new Error("No objType for "+R.name);R.validate(e.objType),R.version!==e.objType.version&&this.#upgradeObject(e);let t=Object.getOwnPropertyNames(e);return["hasProfile","ascent","descent","itineraryPoints","maneuvers","provider","transitMode","objId"].forEach((e=>{if(!t.includes(e))throw new Error("No "+e+" for "+R.name)})),e}constructor(){this.hasProfile=!1,this.ascent=0,this.descent=0,this.provider="",this.transitMode="",this.itineraryPoints=new N(O),this.maneuvers=new N(k),this.#objId=T.nextObjId,Object.seal(this)}get objType(){return R}get objId(){return this.#objId}get jsonObject(){return{hasProfile:this.hasProfile,ascent:this.ascent,descent:this.descent,itineraryPoints:this.itineraryPoints.jsonObject,maneuvers:this.maneuvers.jsonObject,provider:this.provider,transitMode:this.transitMode,objId:this.#objId,objType:R.jsonObject}}set jsonObject(e){let t=this.#validateObject(e);this.hasProfile=t.hasProfile||!1,this.ascent=t.ascent||0,this.descent=t.descent||0,this.itineraryPoints.jsonObject=t.itineraryPoints||[],this.maneuvers.jsonObject=t.maneuvers||[],this.provider=t.provider||"",this.transitMode=t.transitMode||"",this.#objId=T.nextObjId;let o=new Map,a=0,n=this.itineraryPoints.iterator;for(;!n.done;)o.set(t.itineraryPoints[a].objId,n.value.objId),a++;let s=this.maneuvers.iterator;for(;!s.done;)s.value.itineraryPointObjId=o.get(s.value.itineraryPointObjId);this.validateData()}validateData(){"boolean"!=typeof this.hasProfile&&(this.hasProfile=!1),"number"!=typeof this.ascent&&(this.ascent=0),"number"!=typeof this.descent&&(this.descent=0),"string"==typeof this.provider?this.provider=x.sanitizeToJsString(this.provider):this.provider="","string"==typeof this.transitMode?this.transitMode=x.sanitizeToJsString(this.transitMode):this.transitMode=""}}const B=new f("Note");class U{#objId=p;#UpdateStyles(e){return e.replaceAll(/style='color:white;background-color:red'/g,"class='TravelNotes-Note-WhiteRed'").replaceAll(/style='color:white;background-color:green'/g,"class='TravelNotes-Note-WhiteGreen'").replaceAll(/style='color:white;background-color:blue'/g,"class='TravelNotes-Note-WhiteBlue'").replaceAll(/style='color:white;background-color:brown'/g,"class='TravelNotes-Note-WhiteBrown'").replaceAll(/style='color:white;background-color:black'/g,"class='TravelNotes-Note-WhiteBlack'").replaceAll(/style='border:solid 0.1em'/g,"class='TravelNotes-Note-BlackWhite'").replaceAll(/style='background-color:white;'/g,"class='TravelNotes-Note-Knooppunt'").replaceAll(/style='fill:green;font:bold 120px sans-serif;'/g,"").replaceAll(/style='fill:none;stroke:green;stroke-width:10;'/g,"")}#upgradeObject(e){switch(e.objType.version){case"1.0.0":case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":case"1.5.0":case"1.6.0":case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":case"1.12.0":case"1.13.0":"string"==typeof e.iconHeight&&(e.iconHeight=Number.parseInt(e.iconHeight)),"string"==typeof e.iconWidth&&(e.iconWidth=Number.parseInt(e.iconWidth)),e.iconContent=this.#UpdateStyles(e.iconContent),e.popupContent=this.#UpdateStyles(e.popupContent),e.tooltipContent=this.#UpdateStyles(e.tooltipContent),e.phone=this.#UpdateStyles(e.phone),e.address=this.#UpdateStyles(e.address);case"2.0.0":case"2.1.0":case"2.2.0":e.objType.version="2.3.0";break;default:throw new Error("invalid version for "+B.name)}}#validateObject(e){if(!Object.getOwnPropertyNames(e).includes("objType"))throw new Error("No objType for "+B.name);B.validate(e.objType),B.version!==e.objType.version&&this.#upgradeObject(e);let t=Object.getOwnPropertyNames(e);return["iconHeight","iconWidth","iconContent","popupContent","tooltipContent","phone","url","address","iconLat","iconLng","lat","lng","distance","chainedDistance","objId"].forEach((e=>{if(!t.includes(e))throw new Error("No "+e+" for "+B.name)})),e}constructor(){this.iconHeight=h.height,this.iconWidth=h.width,this.iconContent="",this.popupContent="",this.tooltipContent="",this.phone="",this.url="",this.address="",this.iconLat=r.defaultValue,this.iconLng=r.defaultValue,this.lat=r.defaultValue,this.lng=r.defaultValue,this.distance=a.invalid,this.chainedDistance=a.defaultValue,this.#objId=T.nextObjId,Object.seal(this)}get isRouteNote(){return this.distance!==a.invalid}get iconLatLng(){return[this.iconLat,this.iconLng]}set iconLatLng(e){this.iconLat=e[0],this.iconLng=e[1]}get latLng(){return[this.lat,this.lng]}set latLng(e){this.lat=e[0],this.lng=e[1]}get objType(){return B}get objId(){return this.#objId}get jsonObject(){return{iconHeight:this.iconHeight,iconWidth:this.iconWidth,iconContent:this.iconContent,popupContent:this.popupContent,tooltipContent:this.tooltipContent,phone:this.phone,url:this.url,address:this.address,iconLat:parseFloat(this.iconLat.toFixed(r.fixed)),iconLng:parseFloat(this.iconLng.toFixed(r.fixed)),lat:parseFloat(this.lat.toFixed(r.fixed)),lng:parseFloat(this.lng.toFixed(r.fixed)),distance:parseFloat(this.distance.toFixed(a.fixed)),chainedDistance:parseFloat(this.chainedDistance.toFixed(a.fixed)),objId:this.#objId,objType:B.jsonObject}}set jsonObject(e){let t=this.#validateObject(e);this.iconHeight=t.iconHeight||h.height,this.iconWidth=t.iconWidth||h.width,this.iconContent=t.iconContent||"",this.popupContent=t.popupContent||"",this.tooltipContent=t.tooltipContent||"",this.phone=t.phone||"",this.url=t.url||"",this.address=t.address||"",this.iconLat=t.iconLat||r.defaultValue,this.iconLng=t.iconLng||r.defaultValue,this.lat=t.lat||r.defaultValue,this.lng=t.lng||r.defaultValue,this.distance=t.distance||a.invalid,this.chainedDistance=t.chainedDistance||a.defaultValue,this.#objId=T.nextObjId,this.validateData(!0)}validateData(e){if("number"!=typeof this.iconHeight&&(this.iconHeight=h.height),"number"!=typeof this.iconWidth&&(this.iconWidth=h.width),"string"==typeof this.iconContent){let t=x.sanitizeToHtmlString(this.iconContent);e&&""!==t.errorsString&&console.log(t.errorsString+" ("+this.iconContent+")"),this.iconContent=t.htmlString}else this.iconContent="";if("string"==typeof this.popupContent){let t=x.sanitizeToHtmlString(this.popupContent);e&&""!==t.errorsString&&console.log(t.errorsString+" ("+this.popupContent+")"),this.popupContent=t.htmlString}else this.popupContent="";if("string"==typeof this.tooltipContent){let t=x.sanitizeToHtmlString(this.tooltipContent);e&&""!==t.errorsString&&console.log(t.errorsString+" ("+this.tooltipContent+")"),this.tooltipContent=t.htmlString}else this.tooltipContent="";if("string"==typeof this.phone){let t=x.sanitizeToHtmlString(this.phone);e&&""!==t.errorsString&&console.log(t.errorsString+" ("+this.phone+")"),this.phone=t.htmlString}else this.phone="";if("string"==typeof this.url&&""!==this.url){let t=x.sanitizeToUrl(this.url);e&&""!==t.errorsString&&console.log(t.errorsString+" ("+this.url+")"),this.url=encodeURI(t.url)}else this.url="";"string"==typeof this.address?this.address=x.sanitizeToHtmlString(this.address).htmlString:this.address="","number"!=typeof this.iconLat&&(this.iconLat=r.defaultValue),"number"!=typeof this.iconLng&&(this.iconLng=r.defaultValue),"number"!=typeof this.lat&&(this.lat=r.defaultValue),"number"!=typeof this.lng&&(this.lng=r.defaultValue),"number"!=typeof this.distance&&(this.distance=a.invalid),"number"!=typeof this.chainedDistance&&(this.chainedDistance=a.defaultValue)}}const K=new f("Route");class F{#objId=p;#upgradeObject(e){switch(e.objType.version){case"1.0.0":e.dashArray=0,e.hidden=!1;case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":e.edited=l.notEdited;case"1.5.0":case"1.6.0":case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":e.editionStatus=e.edited;case"1.12.0":case"1.13.0":case"2.0.0":case"2.1.0":case"2.2.0":e.objType.version="2.3.0";break;default:throw new Error("invalid version for "+K.name)}}#validateObject(e){if(!Object.getOwnPropertyNames(e).includes("objType"))throw new Error("No objType for "+K.name);K.validate(e.objType),K.version!==e.objType.version&&this.#upgradeObject(e);let t=Object.getOwnPropertyNames(e);return["name","wayPoints","notes","itinerary","width","color","dashArray","chain","distance","duration","editionStatus","hidden","chainedDistance","objId"].forEach((e=>{if(!t.includes(e))throw new Error("No "+e+" for "+K.name)})),e}constructor(){this.name="",this.wayPoints=new N(j),this.wayPoints.add(new j),this.wayPoints.add(new j),this.notes=new N(U),this.itinerary=new H,this.width=e.route.width,this.color=e.route.color,this.dashArray=e.route.dashArray,this.chain=!0,this.chainedDistance=a.defaultValue,this.distance=a.defaultValue,this.duration=a.defaultValue,this.editionStatus=l.notEdited,this.hidden=!1,this.#objId=T.nextObjId,Object.seal(this)}get computedName(){let e=this.name;return""===e&&(e=(""===this.wayPoints.first.fullName?"???":this.wayPoints.first.fullName)+" ⮞ "+(""===this.wayPoints.last.fullName?"???":this.wayPoints.last.fullName)),e}get objId(){return this.#objId}get objType(){return K}haveValidWayPoints(){let e=!0;return this.wayPoints.forEach((t=>{e=e&&r.defaultValue!==t.lat&&r.defaultValue!==t.lng})),e}get jsonObject(){return{name:this.name,wayPoints:this.wayPoints.jsonObject,notes:this.notes.jsonObject,itinerary:this.itinerary.jsonObject,width:this.width,color:this.color,dashArray:this.dashArray,chain:this.chain,distance:parseFloat(this.distance.toFixed(a.fixed)),duration:this.duration,editionStatus:this.editionStatus,hidden:this.hidden,chainedDistance:parseFloat(this.chainedDistance.toFixed(a.fixed)),objId:this.#objId,objType:K.jsonObject}}set jsonObject(t){let o=this.#validateObject(t);this.name=o.name||"",this.wayPoints.jsonObject=o.wayPoints||[],this.notes.jsonObject=o.notes||[],this.itinerary.jsonObject=o.itinerary||(new H).jsonObject,this.width=o.width||e.route.width,this.color=o.color||"#000000",this.dashArray=o.dashArray||0,this.chain=o.chain||!1,this.distance=o.distance,this.duration=o.duration,this.editionStatus=o.editionStatus||l.notEdited,this.hidden=o.hidden||!1,this.chainedDistance=o.chainedDistance,this.#objId=T.nextObjId,this.validateData()}validateData(){"string"==typeof this.name?this.name=x.sanitizeToJsString(this.name):this.name="","number"!=typeof this.width&&(this.width=e.route.width),"string"==typeof this.color?this.color=x.sanitizeToColor(this.color)||e.route.color:this.color=e.route.color,"number"!=typeof this.dashArray&&(this.dashArray=0),this.dashArray>=e.route.dashChoices.length&&(this.dashArray=0),"boolean"!=typeof this.chain&&(this.chain=!1),"number"!=typeof this.distance&&(this.distance=a.defaultValue),"number"!=typeof this.duration&&(this.duration=a.defaultValue),"number"!=typeof this.editionStatus&&(this.editionStatus=l.notEdited),"boolean"!=typeof this.hidden&&(this.hidden=!1),"number"!=typeof this.chainedDistance&&(this.chainedDistance=a.defaultValue)}}const z=new f("Travel");class V{#objId=p;#upgradeObject(e){switch(e.objType.version){case"1.0.0":case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":e.editedRoute=new F;case"1.5.0":if(e.userData.layerId){let t=[{layerId:"0",layerName:"OSM - Color"},{layerId:"1",layerName:"OSM - Black and White"},{layerId:"2",layerName:"Thunderforest - Transport"},{layerId:"3",layerName:"Thunderforest - OpenCycleMap"},{layerId:"4",layerName:"Thunderforest - Outdoors"},{layerId:"5",layerName:"Esri - Aerial view"},{layerId:"6",layerName:"Kartverket - Norway"},{layerId:"7",layerName:"IGN-NGI - Belgium now"},{layerId:"12",layerName:"Thunderforest - Landscape"},{layerId:"24",layerName:"Lantmäteriet - Sweden"},{layerId:"25",layerName:"Maanmittauslaitos - Finland"}].find((t=>t.layerId===e.userData.layerId));e.layerName=t?t.layerName:"OSM - Color"}else e.layerName="OSM - Color";case"1.6.0":case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":case"1.12.0":case"1.13.0":case"2.0.0":case"2.1.0":case"2.2.0":e.objType.version="2.3.0";break;default:throw new Error("invalid version for "+z.name)}}#validateObject(e){if(!Object.getOwnPropertyNames(e).includes("objType"))throw new Error("No objType for "+z.name);z.validate(e.objType),z.version!==e.objType.version&&this.#upgradeObject(e);let t=Object.getOwnPropertyNames(e);return["name","editedRoute","routes","objId"].forEach((e=>{if(!t.includes(e))throw new Error("No "+e+" for "+z.name)})),e}constructor(){this.editedRoute=new F,this.routes=new N(F),this.notes=new N(U),this.layerName="OSM - Color",this.name="",this.readOnly=!1,this.#objId=T.nextObjId,Object.seal(this)}get objId(){return this.#objId}get objType(){return z}get jsonObject(){return{editedRoute:this.editedRoute.jsonObject,layerName:this.layerName,name:this.name,routes:this.routes.jsonObject,notes:this.notes.jsonObject,readOnly:this.readOnly,objId:this.#objId,objType:z.jsonObject}}set jsonObject(e){let t=this.#validateObject(e);this.editedRoute.jsonObject=t.editedRoute,this.layerName=e.layerName||"OSM - Color",this.name=t.name||"",this.readOnly=t.readOnly||!1,this.routes.jsonObject=t.routes||[],this.notes.jsonObject=t.notes||[],this.#objId=T.nextObjId,this.validateData()}validateData(){"string"==typeof this.layerName?this.layerName=x.sanitizeToJsString(this.layerName):this.layerName="OSM - Color","string"==typeof this.name?this.name=x.sanitizeToJsString(this.name):this.name="TravelNotes","boolean"!=typeof this.readOnly&&(this.readOnly=!0)}}const W=new class{#providers=new Map;#mapObjects=new Map;#routing=Object.seal({provider:"",transitMode:""});#UUID=P.UUID;constructor(){this.map=null,this.travel=new V,this.editedRouteObjId=p,this.searchData=[],Object.seal(this)}get providers(){return this.#providers}get mapObjects(){return this.#mapObjects}get routing(){return this.#routing}get UUID(){return this.#UUID}};const G=new class{constructor(){Object.freeze(this)}getLatLngElevAtDist(e,t){if(e.distance<=t||0>=t)return null;let o=0,a=e.itinerary.itineraryPoints.iterator;for(;o<t&&!a.done;)o+=a.value.distance;let n=a.value;a.done;let s=(n.distance-o+t)/n.distance;return Object.freeze({latLng:[n.lat+(a.value.lat-n.lat)*s,n.lng+(a.value.lng-n.lng)*s],elev:n.elev+(a.value.elev-n.elev)*s,ascent:100*(a.value.elev-n.elev)/n.distance,routeDistance:t})}getClosestLatLngDistance(e,t){if(0===e.itinerary.itineraryPoints.length)return null;let o=e.itinerary.itineraryPoints.iterator;o.done;let n=Number.MAX_VALUE,s=window.L.Projection.SphericalMercator.project(window.L.latLng(t[0],t[1])),i=window.L.Projection.SphericalMercator.project(window.L.latLng(o.value.lat,o.value.lng)),r=null,l=a.defaultValue,d=o.value.distance;for(;!o.done;){let e=window.L.Projection.SphericalMercator.project(window.L.latLng(o.value.lat,o.value.lng)),t=window.L.LineUtil.pointToSegmentDistance(s,i,e);t<n&&(n=t,r=window.L.Projection.SphericalMercator.unproject(window.L.LineUtil.closestPointOnSegment(s,i,e)),l=d-r.distanceTo(window.L.latLng(o.value.lat,o.value.lng))),d+=o.value.distance,i=e}return Object.freeze({latLng:[r.lat,r.lng],distance:l})}getLatLngBounds(e){let t=window.L.latLng([r.maxLat,r.maxLng]),o=window.L.latLng([r.minLat,r.minLng]);return e.forEach((e=>{t.lat=Math.min(t.lat,e[0]),t.lng=Math.min(t.lng,e[1]),o.lat=Math.max(o.lat,e[0]),o.lng=Math.max(o.lng,e[1])})),window.L.latLngBounds(t,o)}getSquareBoundingBox(e,t){let o=t/I*c.fromRadians,a=e[0]*c.toRadians,n=Math.acos((Math.cos(t/I)-Math.sin(a)**2)/Math.cos(a)**2)*c.fromRadians;return window.L.latLngBounds(window.L.latLng([e[0]-o,e[1]-n]),window.L.latLng([e[0]+o,e[1]+n]))}project(e,t){let o=W.map.project(window.L.latLng(e),t);return[o.x,o.y]}screenCoordToLatLng(e,t){let o=W.map.containerPointToLatLng(window.L.point(e,t));return[o.lat,o.lng]}addPoints(e,t){return[e[0]+t[0],e[1]+t[1]]}subtrackPoints(e,t){return[e[0]-t[0],e[1]-t[1]]}};const X=new class{#normalizeLng(e){return(e+c.d540)%c.d360-c.d180}constructor(){Object.freeze(this)}arcFromSummitArcArc(e,t,o){return Math.acos(Math.cos(t)*Math.cos(o)+Math.sin(t)*Math.sin(o)*Math.cos(e))}summitFromArcArcArc(e,t,o){return Math.acos((Math.cos(o)-Math.cos(e)*Math.cos(t))/(Math.sin(e)*Math.sin(t)))}pointsDistance(e,t){if(e[0]===t[0]&&e[1]===t[1])return 0;let o=e[0]*c.toRadians,a=t[0]*c.toRadians,n=(this.#normalizeLng(t[1])-this.#normalizeLng(e[1]))*c.toRadians;return Math.acos(Math.sin(o)*Math.sin(a)+Math.cos(o)*Math.cos(a)*Math.cos(n))*I}};const _=new class{#setNearestRouteData(e,t,o){if(e.objId!==W.editedRouteObjId){let a=G.getClosestLatLngDistance(e,t);if(a){let n=X.pointsDistance(t,a.latLng);n<o.distance&&(o.route=e,o.distance=n,o.latLngOnRoute=a.latLng,o.distanceOnRoute=a.distance)}}}constructor(){Object.freeze(this)}getNearestRouteData(e){let t={distance:Number.MAX_VALUE,route:null,distanceOnRoute:0,latLngOnRoute:[r.defaultValue,r.defaultValue]};return W.travel.routes.forEach((o=>this.#setNearestRouteData(o,e,t))),p!==W.editedRouteObjId&&this.#setNearestRouteData(W.travel.editedRoute,e,t),Object.freeze(t)}getRoute(e){let t=null;return t=W.travel.routes.getAt(e),t||e===W.travel.editedRoute.objId&&(t=W.travel.editedRoute),t}getNoteAndRoute(e){let t=null,o=null;if(t=W.travel.notes.getAt(e),!t){let a=W.travel.routes.iterator;for(;!a.done&&!t;)t=a.value.notes.getAt(e),t&&(o=a.value);t||(t=W.travel.editedRoute.notes.getAt(e),t&&(o=W.travel.editedRoute))}return Object.freeze({note:t,route:o})}getWayPoint(e){let t=W.travel.editedRoute.wayPoints.getAt(e);if(!t){let o=W.travel.routes.iterator;for(;!o.done&&!t;)t=o.value.wayPoints.getAt(e)}return t}};
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file HTMLElementsFactory.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/const Z=new class{#addProperties(e,t){for(let o in t)try{if("dataset"===o){let o=t.dataset;for(let t in o)e.dataset["tan"+t]=o[t]}else e[o]=t[o]}catch(e){e instanceof Error&&console.error(e)}e.target&&(e.rel="noopener noreferrer")}constructor(){Object.freeze(this)}create(e,t,o){let a=null;return"text"===e.toLowerCase()?a=document.createTextNode(t.value||""):(a="select"===e.toLowerCase()?document.createElement(e):Object.seal(document.createElement(e)),t&&this.#addProperties(a,t)),o&&o.appendChild(a),a}};class Y{#baseDialog=null;constructor(e){Object.seal(this),this.#baseDialog=e}destructor(){this.#baseDialog=null}handleEvent(){this.#baseDialog.onOk()}}class J{#baseDialog=null;constructor(e){Object.seal(this),this.#baseDialog=e}destructor(){this.#baseDialog=null}handleEvent(){this.#baseDialog.onCancel()}}class q{#dragData=null;constructor(e){Object.seal(this),this.#dragData=e}destructor(){this.#dragData=null}handleEvent(e){this.#dragData.dragStartX=e.screenX,this.#dragData.dragStartY=e.screenY,e.dataTransfer.dropEffect="move",e.dataTransfer.effectAllowed="move"}}class Q{#dragData=null;#containerDiv=null;#backgroundDiv=null;constructor(e,t,o){Object.seal(this),this.#dragData=e,this.#containerDiv=t,this.#backgroundDiv=o}destructor(){this.#dragData=null,this.#containerDiv=null,this.#backgroundDiv=null}handleEvent(e){this.#dragData.dialogX+=e.screenX-this.#dragData.dragStartX,this.#dragData.dialogX=Math.min(Math.max(this.#dragData.dialogX,L),this.#backgroundDiv.clientWidth-this.#containerDiv.clientWidth-L),this.#dragData.dialogY+=e.screenY-this.#dragData.dragStartY,this.#dragData.dialogY=Math.max(this.#dragData.dialogY,L);let t=this.#backgroundDiv.clientHeight-Math.max(this.#dragData.dialogY,0)-L;this.#containerDiv.style.left=String(this.#dragData.dialogX)+"px",this.#containerDiv.style.top=String(this.#dragData.dialogY)+"px",this.#containerDiv.style["max-height"]=String(t)+"px"}}class ${#baseDialog=null;constructor(e){Object.seal(this),this.#baseDialog=e}destructor(){this.#baseDialog=null}handleEvent(e){this.#baseDialog.keyboardEventListenerEnabled&&("Escape"===e.key||"Esc"===e.key?this.#baseDialog.onCancel():"Enter"===e.key&&this.#baseDialog.onOk())}}class ee{#mapCenter=[r.defaultValue,r.defaultValue];handleEvent(e){if("start"===e.action)return void(this.#mapCenter=W.map.getCenter());let t=G.screenCoordToLatLng(e.startX,e.startY),o=G.screenCoordToLatLng(e.endX,e.endY);W.map.panTo([this.#mapCenter.lat+t[0]-o[0],this.#mapCenter.lng+t[1]-o[1]])}}class te{#initialZoom=0;#startPoint=null;handleEvent(e){if("start"===e.action)return this.#initialZoom=W.map.getZoom(),void(this.#startPoint=window.L.point(e.clientX,e.clientY));let t=Math.floor(this.#initialZoom+(e.startY-e.endY)/50);t=Math.min(W.map.getMaxZoom(),t),t=Math.max(W.map.getMinZoom(),t),W.map.setZoomAround(this.#startPoint,t)}}class oe{handleEvent(e){if("TravelNotes-Background"!==e.target.id)return;let t=W.map.getZoom()+(0>e.deltaY?1:-1);t=Math.min(W.map.getMaxZoom(),t),t=Math.max(W.map.getMinZoom(),t),W.map.setZoomAround(window.L.point(e.clientX,e.clientY),t)}}class ae{handleEvent(e){e.preventDefault()}}class ne{handleEvent(e){e.preventDefault()}}class se{#panOngoing=!1;#startPanX=0;#startPanY=0;#target=null;#button=0;#eventType="";#dispatchEvent(e,t){let o=new Event(this.#eventType);o.startX=this.#startPanX,o.startY=this.#startPanY,o.endX=e.screenX,o.endY=e.screenY,o.clientX=e.clientX,o.clientY=e.clientY,o.action=t,this.#target.dispatchEvent(o)}constructor(e,t){switch(this.#target=e,this.#button=t,t){case 0:this.#eventType="leftpan";break;case 1:this.#eventType="middlepan";break;case 2:this.#eventType="rightpan";break;default:this.#button=m}}handleEvent(e){switch(e.type){case"mousedown":e.button===this.#button&&(this.#startPanX=e.screenX,this.#startPanY=e.screenY,this.#panOngoing=!0,this.#dispatchEvent(e,"start"));break;case"mouseup":e.button!==this.#button||!this.#panOngoing||this.#startPanX===e.screenX&&this.#startPanY===e.screenY||this.#dispatchEvent(e,"end"),this.#panOngoing=!1;break;case"mousemove":this.#panOngoing&&(document.selection?document.selection.empty():window.getSelection().removeAllRanges(),this.#dispatchEvent(e,"move"))}}}class ie{static get LEFT_BUTTON(){return 0}static get MIDDLE_BUTTON(){return 1}static get RIGHT_BUTTON(){return 2}#target=null;#eventListener=null;constructor(e,t=0){this.#target=e,this.#eventListener=new se(e,t),this.#target.addEventListener("mousedown",this.#eventListener),this.#target.addEventListener("mouseup",this.#eventListener),this.#target.addEventListener("mousemove",this.#eventListener)}detach(){this.#target.removeEventListener("mousedown",this.#eventListener),this.#target.removeEventListener("mouseup",this.#eventListener),this.#target.removeEventListener("mousemove",this.#eventListener),this.#eventListener=null,this.#target=null}}class re{#backgroundDiv={};#containerDiv={};#errorDiv={};#waitDiv={};#okButton={};#cancelButton={};#topBar={};#secondButton=null;#leftPanEventDispatcher=null;#rightPanEventDispatcher=null;keyboardEventListenerEnabled=!0;#dragData=Object.seal({dragStartX:0,dragStartY:0,dialogX:0,dialogY:0});#eventListeners={onKeydown:null,onTopBarDragStart:null,onTopBarDragEnd:null,onCancelButtonClick:null,onOkButtonClick:null,onLeftPan:null,onRightPan:null,onWheel:null,onContextMenu:null,onDragOver:null};#options=null;#onPromiseOkFct=null;#onPromiseErrorFct=null;#createBackgroundDiv(){this.#backgroundDiv=Z.create("div",{id:"TravelNotes-Background",className:"TravelNotes-Background"}),this.#leftPanEventDispatcher=new ie(this.#backgroundDiv,ie.LEFT_BUTTON),this.#rightPanEventDispatcher=new ie(this.#backgroundDiv,ie.RIGHT_BUTTON),this.#eventListeners.onLeftPan=new ee,this.#backgroundDiv.addEventListener("leftpan",this.#eventListeners.onLeftPan,!1),this.#eventListeners.onRightPan=new te,this.#backgroundDiv.addEventListener("rightpan",this.#eventListeners.onRightPan,!1),this.#eventListeners.onDragOver=new ne,this.#backgroundDiv.addEventListener("dragover",this.#eventListeners.onDragOver,!1),this.#eventListeners.onWheel=new oe,this.#backgroundDiv.addEventListener("wheel",this.#eventListeners.onWheel,!1),this.#eventListeners.onContextMenu=new ae,this.#backgroundDiv.addEventListener("contextmenu",this.#eventListeners.onContextMenu,!1)}#createContainerDiv(){this.#containerDiv=Z.create("div",{className:"TravelNotes-BaseDialog-Container"},this.#backgroundDiv)}#createTopBar(){this.#topBar=Z.create("div",{className:"TravelNotes-BaseDialog-TopBar",draggable:!0},this.#containerDiv),this.#eventListeners.onTopBarDragStart=new q(this.#dragData),this.#eventListeners.onTopBarDragEnd=new Q(this.#dragData,this.#containerDiv,this.#backgroundDiv),this.#topBar.addEventListener("dragstart",this.#eventListeners.onTopBarDragStart,!1),this.#topBar.addEventListener("dragend",this.#eventListeners.onTopBarDragEnd,!1),this.#eventListeners.onCancelButtonClick=new J(this),this.#cancelButton=Z.create("div",{textContent:"❌",className:"TravelNotes-BaseDialog-CancelButton",title:M.getText("BaseDialog - Cancel")},this.#topBar),this.#cancelButton.addEventListener("click",this.#eventListeners.onCancelButtonClick,!1)}#createHeaderDiv(){Z.create("text",{value:this.title},Z.create("div",{className:"TravelNotes-BaseDialog-HeaderDiv"},this.#containerDiv))}#createContentDiv(){let e=Z.create("div",{className:"TravelNotes-BaseDialog-ContentDiv"},this.#containerDiv);this.contentHTMLElements.forEach((t=>e.appendChild(t)))}#createErrorDiv(){this.#errorDiv=Z.create("div",{className:"TravelNotes-BaseDialog-ErrorDiv TravelNotes-Hidden"},this.#containerDiv)}#createWaitDiv(){Z.create("div",{className:"TravelNotes-WaitAnimationBullet"},Z.create("div",{className:"TravelNotes-WaitAnimation"},this.#waitDiv=Z.create("div",{className:"TravelNotes-BaseDialog-WaitDiv  TravelNotes-Hidden"},this.#containerDiv)))}#createFooterDiv(){let e=Z.create("div",{className:"TravelNotes-BaseDialog-FooterDiv"},this.#containerDiv);this.#okButton=Z.create("div",{textContent:this.#options.firstButtonText||"🆗",className:"TravelNotes-BaseDialog-Button"},e),this.#eventListeners.onOkButtonClick=new Y(this),this.#okButton.addEventListener("click",this.#eventListeners.onOkButtonClick,!1),this.#options.secondButtonText&&(this.#secondButton=Z.create("div",{textContent:this.#options.secondButtonText,className:"TravelNotes-BaseDialog-Button"},e),this.#secondButton.addEventListener("click",this.#eventListeners.onCancelButtonClick,!1)),this.footerHTMLElements.forEach((t=>e.appendChild(t)))}#createHTML(){this.#createBackgroundDiv(),this.#createContainerDiv(),this.#createTopBar(),this.#createHeaderDiv(),this.#createContentDiv(),this.#createErrorDiv(),this.#createWaitDiv(),this.#createFooterDiv()}#centerDialog(){this.#dragData.dialogX=(this.#backgroundDiv.clientWidth-this.#containerDiv.clientWidth)/2,this.#dragData.dialogY=(this.#backgroundDiv.clientHeight-this.#containerDiv.clientHeight)/2,this.#dragData.dialogX=Math.min(Math.max(this.#dragData.dialogX,L),this.#backgroundDiv.clientWidth-this.#containerDiv.clientWidth-L),this.#dragData.dialogY=Math.max(this.#dragData.dialogY,L);let e=this.#backgroundDiv.clientHeight-Math.max(this.#dragData.dialogY,0)-L;this.#containerDiv.style.left=String(this.#dragData.dialogX)+"px",this.#containerDiv.style.top=String(this.#dragData.dialogY)+"px",this.#containerDiv.style["max-height"]=String(e)+"px"}#show(e,t){this.#onPromiseOkFct=e,this.#onPromiseErrorFct=t,this.#createHTML(),document.body.appendChild(this.#backgroundDiv),this.#centerDialog(),document.addEventListener("keydown",this.#eventListeners.onKeydown,{capture:!0}),this.onShow()}constructor(e={}){Object.seal(this),this.#options=e,this.#eventListeners.onKeydown=new $(this)}#destructor(){this.#backgroundDiv.removeEventListener("dragover",this.#eventListeners.onDragOver,!1),this.#backgroundDiv.removeEventListener("leftpan",this.#eventListeners.onLeftPan,!1),this.#backgroundDiv.removeEventListener("rightpan",this.#eventListeners.onRightPan,!1),this.#backgroundDiv.removeEventListener("wheel",this.#eventListeners.onWheel,!1),this.#backgroundDiv.removeEventListener("contextmenu",this.#eventListeners.onContextMenu,!1),document.removeEventListener("keydown",this.#eventListeners.onKeydown,{capture:!0}),this.#topBar.removeEventListener("dragstart",this.#eventListeners.onTopBarDragStart,!1),this.#topBar.removeEventListener("dragend",this.#eventListeners.onTopBarDragEnd,!1),this.#cancelButton.removeEventListener("click",this.#eventListeners.onCancelButtonClick,!1),this.#okButton.removeEventListener("click",this.#eventListeners.onOkButtonClick,!1),this.#options.secondButtonText&&this.#secondButton.removeEventListener("click",this.#eventListeners.onCancelButtonClick,!1),document.removeEventListener("keydown",this.#eventListeners.onKeydown,{capture:!0}),this.#eventListeners.onKeydown.destructor(),this.#eventListeners.onTopBarDragStart.destructor(),this.#eventListeners.onTopBarDragEnd.destructor(),this.#eventListeners.onCancelButtonClick.destructor(),this.#eventListeners.onOkButtonClick.destructor(),this.#leftPanEventDispatcher.detach(),this.#rightPanEventDispatcher.detach(),document.body.removeChild(this.#backgroundDiv)}onCancel(){this.#destructor(),this.#onPromiseErrorFct("Canceled by user")}canClose(){return!0}onOk(e){this.canClose()&&(this.#destructor(),this.#onPromiseOkFct(e))}onShow(){}get title(){return""}get contentHTMLElements(){return[]}get footerHTMLElements(){return[]}show(){return new Promise(((e,t)=>this.#show(e,t)))}showWait(){this.#waitDiv.classList.remove("TravelNotes-Hidden"),this.#okButton.classList.add("TravelNotes-Hidden")}hideWait(){this.#waitDiv.classList.add("TravelNotes-Hidden"),this.#okButton.classList.remove("TravelNotes-Hidden")}showError(e){x.sanitizeToHtmlElement(e,this.#errorDiv),this.#errorDiv.classList.remove("TravelNotes-Hidden")}hideError(){this.#errorDiv.textContent="",this.#errorDiv.classList.add("TravelNotes-Hidden")}}
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file PasswordDialogEventListeners.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/class le{#passwordInput=null;constructor(e){this.#passwordInput=e}destructor(){this.#passwordInput=null}handleEvent(e){e.stopPropagation,this.#passwordInput.type="text"}}class de{#passwordInput=null;constructor(e){this.#passwordInput=e}destructor(){this.#passwordInput=null}handleEvent(e){e.stopPropagation,this.#passwordInput.type="password",this.#passwordInput.focus()}}class he extends re{#passwordDiv=null;#passwordInput=null;#eyeSpan=null;#verifyPassword=!1;#onMouseDownEyeEventListener=null;#onMouseUpEyeEventListener=null;constructor(e){super(),this.#verifyPassword=e,this.#passwordDiv=Z.create("div",{id:"TravelNotes-PasswordDialog-PasswordDiv"}),this.#passwordInput=Z.create("input",{type:"password"},this.#passwordDiv),this.#onMouseDownEyeEventListener=new le(this.#passwordInput),this.#onMouseUpEyeEventListener=new de(this.#passwordInput),this.#eyeSpan=Z.create("span",{id:"TravelNotes-PasswordDialog-EyeSpan",textContent:"👁️"},this.#passwordDiv),this.#eyeSpan.addEventListener("mousedown",this.#onMouseDownEyeEventListener,!1),this.#eyeSpan.addEventListener("mouseup",this.#onMouseUpEyeEventListener,!1)}#destructor(){this.#eyeSpan.removeEventListener("mousedown",this.#onMouseDownEyeEventListener,!1),this.#eyeSpan.removeEventListener("mouseup",this.#onMouseUpEyeEventListener,!1),this.#onMouseDownEyeEventListener.destructor(),this.#onMouseUpEyeEventListener.destructor()}canClose(){return this.hideError(),!(this.#verifyPassword&&(this.#passwordInput.value.length<12||!this.#passwordInput.value.match(/[0-9]+/)||!this.#passwordInput.value.match(/[a-z]+/)||!this.#passwordInput.value.match(/[A-Z]+/)||!this.#passwordInput.value.match(/[^0-9a-zA-Z]/)))||(this.showError("<p>"+M.getText("PasswordDialog - Password rules1")+"</p><ul><li>"+M.getText("PasswordDialog - Password rules2")+"</li><li>"+M.getText("PasswordDialog - Password rules3")+"</li><li>"+M.getText("PasswordDialog - Password rules4")+"</li><li>"+M.getText("PasswordDialog - Password rules5")+"</li><li>"+M.getText("PasswordDialog - Password rules6")+"</li></ul>"),this.#passwordInput.focus(),!1)}onCancel(){this.#destructor(),super.onCancel()}onOk(){this.#destructor(),super.onOk((new window.TextEncoder).encode(this.#passwordInput.value))}onShow(){this.#passwordInput.focus()}get contentHTMLElements(){return[this.#passwordDiv]}get title(){return M.getText("PasswordDialog - password")}}
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file DataEncryptor.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/class ce{#salt=null;#importKey(e){return window.crypto.subtle.importKey("raw",e,{name:"PBKDF2"},!1,["deriveKey"])}#deriveKey(e,t){return window.crypto.subtle.deriveKey({name:"PBKDF2",salt:(new window.TextEncoder).encode(t),iterations:1e6,hash:"SHA-256"},e,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}#decrypt(e,t){return window.crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(t.slice(0,16))},e,new Uint8Array(t.slice(16)))}#encrypt(e,t,o){return window.crypto.subtle.encrypt({name:"AES-GCM",iv:t},e,o)}constructor(e){this.#salt=e||"Tire la chevillette la bobinette cherra. Le Petit Chaperon rouge tira la chevillette.",Object.freeze(this)}encryptData(e,t,o,a){let n=window.crypto.getRandomValues(new Uint8Array(16));a.then(this.#importKey).then((e=>this.#deriveKey(e,this.#salt))).then((t=>this.#encrypt(t,n,e))).then((e=>{t(new Blob([n,new Uint8Array(e)],{type:"application/octet-stream"}))})).catch(o)}decryptData(e,t,o,a){a.then(this.#importKey).then((e=>this.#deriveKey(e,this.#salt))).then((t=>this.#decrypt(t,e))).then(t).catch(o)}}class ue{handleEvent(e){e.stopPropagation();let t=new Event("apikeydeleted");t.data={objId:Number.parseInt(e.target.dataset.tanObjId)},e.target.parentNode.parentNode.dispatchEvent(t)}}class ve{#rootHTMLElement=null;#providerNameInput=null;#providerKeyInput=null;#objId=p;constructor(t){this.#objId=T.nextObjId,this.#rootHTMLElement=Z.create("div",{className:"TravelNotes-APIKeysDialog-ApiKeyRow"}),this.#providerNameInput=Z.create("input",{className:"TravelNotes-APIKeysDialog-ApiKeyName TravelNotes-APIKeysDialog-Input",value:t.providerName,placeholder:M.getText("APIKeysDialog - provider name")},this.#rootHTMLElement),this.#providerKeyInput=Z.create("input",{className:"TravelNotes-APIKeysDialog-ApiKeyValue TravelNotes-APIKeysDialog-Input",value:t.providerKey,placeholder:M.getText("APIKeysDialog - API key"),type:e.APIKeysDialog.showAPIKeys?"text":"password"},this.#rootHTMLElement),Z.create("div",{className:"TravelNotes-BaseDialog-Button TravelNotes-APIKeysDialog-AtRightButton TravelNotes-APIKeysDialog-DeleteRowButton",title:M.getText("APIKeysDialog - delete API key"),textContent:"❌",dataset:{ObjId:this.#objId}},this.#rootHTMLElement).addEventListener("click",new ue,!1)}get objId(){return this.#objId}get HTMLElements(){return[this.#rootHTMLElement]}get providerName(){return this.#providerNameInput.value}get providerKey(){return this.#providerKeyInput.value}get APIKey(){return Object.seal({providerName:this.#providerNameInput.value,providerKey:this.#providerKeyInput.value})}}class pe{#APIKeysDialog=null;constructor(e){this.#APIKeysDialog=e}destructor(){this.#APIKeysDialog=null}onErrorDecrypt(e){this.#APIKeysDialog.hideWait(),this.#APIKeysDialog.keyboardEventListenerEnabled=!0,e&&"Canceled by user"!==e&&this.#APIKeysDialog.showError(M.getText("APIKeysDialog - An error occurs when reading the file"))}onOkDecrypt(e){try{this.#APIKeysDialog.addAPIKeys(JSON.parse((new TextDecoder).decode(e)))}catch(e){return void this.onErrorDecrypt(e)}this.#APIKeysDialog.hideWait(),this.#APIKeysDialog.hideError(),this.#APIKeysDialog.keyboardEventListenerEnabled=!0}onOkEncrypt(e){this.#APIKeysDialog.hideError(),this.#APIKeysDialog.hideWait(),P.saveFile("APIKeys",e),this.#APIKeysDialog.keyboardEventListenerEnabled=!0}onErrorEncrypt(){this.#APIKeysDialog.showError(M.getText("APIKeysDialog - An error occurs when saving the keys")),this.#APIKeysDialog.hideWait(),this.#APIKeysDialog.keyboardEventListenerEnabled=!0}}class me{#APIKeysControls=null;constructor(e){this.#APIKeysControls=e}destructor(){this.#APIKeysControls=null}getAPIKeysJsonString(){let e=[];return this.#APIKeysControls.forEach((t=>{e.push(t.APIKey)})),JSON.stringify(e)}}class ge{#APIKeysDialog=null;#APIKeysControls=null;constructor(e,t){this.#APIKeysDialog=e,this.#APIKeysControls=t}destructor(){this.#APIKeysDialog=null,this.#APIKeysControls=null}handleEvent(e){e.stopPropagation(),this.#APIKeysControls.delete(e.data.objId),this.#APIKeysDialog.refreshAPIKeys()}}class be{#APIKeysDialog=null;constructor(e){this.#APIKeysDialog=e}destructor(){this.#APIKeysDialog=null}handleEvent(e){e.stopPropagation();let t=new FileReader;t.onload=()=>{try{this.#APIKeysDialog.addAPIKeys(JSON.parse(t.result))}catch(e){this.#APIKeysDialog.showError(e.message),e instanceof Error&&console.error(e)}},t.readAsText(e.target.files[0])}}class ye{#APIKeysDialog=null;#openUnsecureFileInputEventListener=null;constructor(e){this.#APIKeysDialog=e,this.#openUnsecureFileInputEventListener=new be(this.#APIKeysDialog)}destructor(){this.#APIKeysDialog=null,this.#openUnsecureFileInputEventListener.destructor()}handleEvent(e){e.stopPropagation(),this.#APIKeysDialog.hideError(),P.openFile(this.#openUnsecureFileInputEventListener,".json")}}class Ie{#APIKeysDialog=null;#dataEncryptorHandlers=null;constructor(e){this.#APIKeysDialog=e,this.#dataEncryptorHandlers=new pe(this.#APIKeysDialog)}destructor(){this.#APIKeysDialog=null,this.#dataEncryptorHandlers.destructor()}handleEvent(e){e.stopPropagation(),this.#APIKeysDialog.hideError(),this.#APIKeysDialog.showWait(),this.#APIKeysDialog.keyboardEventListenerEnabled=!1,fetch(window.location.href.substr(0,window.location.href.lastIndexOf("/")+1)+"APIKeys").then((e=>{b===e.status&&e.ok?e.arrayBuffer().then((e=>{(new ce).decryptData(e,(e=>{this.#dataEncryptorHandlers.onOkDecrypt(e)}),(e=>{this.#dataEncryptorHandlers.onErrorDecrypt(e)}),new he(!1).show())})):this.#dataEncryptorHandlers.onErrorDecrypt(new Error("Invalid http status"))})).catch((e=>{this.#dataEncryptorHandlers.onErrorDecrypt(e),e instanceof Error&&console.error(e)}))}}class we{#APIKeysDialog=null;#dataEncryptorHandlers=null;constructor(e){this.#APIKeysDialog=e,this.#dataEncryptorHandlers=new pe(this.#APIKeysDialog)}destructor(){this.#APIKeysDialog=null,this.#dataEncryptorHandlers.destructor()}handleEvent(e){e.stopPropagation(),this.#APIKeysDialog.showWait(),this.#APIKeysDialog.keyboardEventListenerEnabled=!1;let t=new FileReader;t.onload=()=>{(new ce).decryptData(t.result,(e=>{this.#dataEncryptorHandlers.onOkDecrypt(e)}),(e=>{this.#dataEncryptorHandlers.onErrorDecrypt(e)}),new he(!1).show())},t.readAsArrayBuffer(e.target.files[0])}}class Le{#APIKeysDialog=null;#openSecureFileInputEventListener=null;constructor(e){this.#APIKeysDialog=e,this.#openSecureFileInputEventListener=new we(this.#APIKeysDialog)}destructor(){this.#APIKeysDialog=null,this.#openSecureFileInputEventListener.destructor()}handleEvent(e){e.stopPropagation(),this.#APIKeysDialog.hideError(),P.openFile(this.#openSecureFileInputEventListener)}}class Te{#APIKeysDialog=null;#APIKeysControls=null;#saveAPIKeysHelper=null;#dataEncryptorHandlers=null;constructor(e,t){this.#APIKeysDialog=e,this.#APIKeysControls=t,this.#saveAPIKeysHelper=new me(this.#APIKeysControls),this.#dataEncryptorHandlers=new pe(this.#APIKeysDialog)}destructor(){this.#APIKeysDialog=null,this.#APIKeysControls=null,this.#saveAPIKeysHelper.destructor(),this.#dataEncryptorHandlers.destructor()}handleEvent(e){e.stopPropagation(),this.#APIKeysDialog.validateAPIKeys()&&(this.#APIKeysDialog.showWait(),this.#APIKeysDialog.keyboardEventListenerEnabled=!1,(new ce).encryptData((new window.TextEncoder).encode(this.#saveAPIKeysHelper.getAPIKeysJsonString()),(e=>this.#dataEncryptorHandlers.onOkEncrypt(e)),(()=>this.#dataEncryptorHandlers.onErrorEncrypt()),new he(!0).show()))}}class De{#APIKeysDialog=null;#APIKeysControls=null;#saveAPIKeysHelper=null;constructor(e,t){this.#APIKeysDialog=e,this.#APIKeysControls=t,this.#saveAPIKeysHelper=new me(this.#APIKeysControls)}destructor(){this.#APIKeysDialog=null,this.#APIKeysControls=null,this.#saveAPIKeysHelper.destructor()}handleEvent(e){e.stopPropagation(),this.#APIKeysDialog.validateAPIKeys()&&P.saveFile("APIKeys.json",this.#saveAPIKeysHelper.getAPIKeysJsonString(),"application/json")}}class fe{#APIKeysDialog=null;#APIKeysControls=null;constructor(e,t){this.#APIKeysDialog=e,this.#APIKeysControls=t}destructor(){this.#APIKeysDialog=null,this.#APIKeysControls=null}handleEvent(e){e.stopPropagation();let t=Object.seal({providerName:"",providerKey:""}),o=new ve(t);this.#APIKeysControls.set(o.objId,o),this.#APIKeysDialog.refreshAPIKeys()}}class Ee{#APIKeysDialog=null;#APIKeysControls=null;#haveAPIKeysFile=!1;#rootHTMLElement=null;#reloadKeysFromServerButton=null;#saveKeysToSecureFileButton=null;#restoreKeysFromSecureFileButton=null;#newAPIKeyButton=null;#saveKeysToUnsecureFileButton=null;#restoreKeysFromUnsecureFileButton=null;#reloadKeysFromServerButtonEventListener=null;#saveKeysToSecureFileButtonEventListener=null;#restoreKeysFromSecureFileButtonEventListener=null;#newAPIKeyButtonEventListener=null;#saveKeysToUnsecureFileButtonEventListener=null;#restoreKeysFromUnsecureFileButtonEventListener=null;#createReloadKeysFromServerButton(){this.#reloadKeysFromServerButton=Z.create("div",{className:"TravelNotes-BaseDialog-Button",title:M.getText("APIKeysDialog - Reload from server"),textContent:"🔄"},this.#rootHTMLElement),this.#reloadKeysFromServerButtonEventListener=new Ie(this.#APIKeysDialog),this.#reloadKeysFromServerButton.addEventListener("click",this.#reloadKeysFromServerButtonEventListener,!1)}#createSaveKeysToSecureFileButton(){this.#saveKeysToSecureFileButton=Z.create("div",{className:"TravelNotes-BaseDialog-Button",title:M.getText("APIKeysDialog - Save to file"),textContent:"💾"},this.#rootHTMLElement),this.#saveKeysToSecureFileButtonEventListener=new Te(this.#APIKeysDialog,this.#APIKeysControls),this.#saveKeysToSecureFileButton.addEventListener("click",this.#saveKeysToSecureFileButtonEventListener,!1)}#createRestoreKeysFromSecureFileButton(){this.#restoreKeysFromSecureFileButton=Z.create("div",{className:"TravelNotes-BaseDialog-Button",title:M.getText("APIKeysDialog - Open file"),textContent:"📂"},this.#rootHTMLElement),this.#restoreKeysFromSecureFileButtonEventListener=new Le(this.#APIKeysDialog),this.#restoreKeysFromSecureFileButton.addEventListener("click",this.#restoreKeysFromSecureFileButtonEventListener,!1)}#createNewAPIKeyButton(){this.#newAPIKeyButton=Z.create("div",{className:"TravelNotes-BaseDialog-Button",title:M.getText("APIKeysDialog - new API key"),textContent:"+"},this.#rootHTMLElement),this.#newAPIKeyButtonEventListener=new fe(this.#APIKeysDialog,this.#APIKeysControls),this.#newAPIKeyButton.addEventListener("click",this.#newAPIKeyButtonEventListener,!1)}#createSaveKeysToUnsecureFileButton(){this.#saveKeysToUnsecureFileButton=Z.create("div",{className:"TravelNotes-BaseDialog-Button TravelNotes-APIKeysDialog-AtRightButton",title:M.getText("APIKeysDialog - Save to json file"),textContent:"💾"},this.#rootHTMLElement),this.#saveKeysToUnsecureFileButtonEventListener=new De(this.#APIKeysDialog,this.#APIKeysControls),this.#saveKeysToUnsecureFileButton.addEventListener("click",this.#saveKeysToUnsecureFileButtonEventListener,!1)}#createRestoreKeysFromUnsecureFileButton(){this.#restoreKeysFromUnsecureFileButton=Z.create("div",{className:"TravelNotes-BaseDialog-Button",title:M.getText("APIKeysDialog - Open json file"),textContent:"📂"},this.#rootHTMLElement),this.#restoreKeysFromUnsecureFileButtonEventListener=new ye(this.#APIKeysDialog),this.#restoreKeysFromUnsecureFileButton.addEventListener("click",this.#restoreKeysFromUnsecureFileButtonEventListener,!1)}#addToolbarButtons(){window.crypto&&window.crypto.subtle&&window.crypto.subtle.importKey&&window.isSecureContext&&(this.#haveAPIKeysFile&&this.#createReloadKeysFromServerButton(),this.#createSaveKeysToSecureFileButton(),this.#createRestoreKeysFromSecureFileButton()),this.#createNewAPIKeyButton(),e.APIKeysDialog.haveUnsecureButtons&&(this.#createSaveKeysToUnsecureFileButton(),this.#createRestoreKeysFromUnsecureFileButton())}constructor(e,t,o){this.#APIKeysDialog=e,this.#APIKeysControls=t,this.#haveAPIKeysFile=o,this.#rootHTMLElement=Z.create("div",{id:"TravelNotes-APIKeysDialog-ToolbarDiv"}),this.#addToolbarButtons()}destructor(){this.#reloadKeysFromServerButton&&(this.#reloadKeysFromServerButton.removeEventListener("click",this.#reloadKeysFromServerButtonEventListener,!1),this.#reloadKeysFromServerButtonEventListener.destructor()),this.#saveKeysToSecureFileButton&&(this.#saveKeysToSecureFileButton.removeEventListener("click",this.#saveKeysToSecureFileButtonEventListener,!1),this.#saveKeysToSecureFileButtonEventListener.destructor()),this.#restoreKeysFromSecureFileButton&&(this.#restoreKeysFromSecureFileButton.removeEventListener("click",this.#restoreKeysFromSecureFileButtonEventListener,!1),this.#restoreKeysFromSecureFileButtonEventListener.destructor()),this.#newAPIKeyButton&&(this.#newAPIKeyButton.removeEventListener("click",this.#newAPIKeyButtonEventListener,!1),this.#newAPIKeyButtonEventListener.destructor()),this.#saveKeysToUnsecureFileButton&&(this.#saveKeysToUnsecureFileButton.removeEventListener("click",this.#saveKeysToUnsecureFileButtonEventListener,!1),this.#saveKeysToUnsecureFileButtonEventListener.destructor()),this.#restoreKeysFromUnsecureFileButton&&(this.#restoreKeysFromUnsecureFileButton.removeEventListener("click",this.#restoreKeysFromUnsecureFileButtonEventListener,!1),this.#restoreKeysFromUnsecureFileButtonEventListener.destructor())}get rootHTMLElement(){return this.#rootHTMLElement}}class Ne extends re{#APIKeysControls=new Map;#toolbar=null;#APIKeysControlsContainer=null;#onAPIKeyDeletedEventListener=null;#createAPIKeysControlsContainer(){this.#APIKeysControlsContainer=Z.create("div"),this.#onAPIKeyDeletedEventListener=new ge(this,this.#APIKeysControls),this.#APIKeysControlsContainer.addEventListener("apikeydeleted",this.#onAPIKeyDeletedEventListener,!1)}constructor(e,t){super(),this.#toolbar=new Ee(this,this.#APIKeysControls,t),this.#createAPIKeysControlsContainer(),this.addAPIKeys(e)}#destructor(){this.#toolbar.destructor(),this.#APIKeysControlsContainer.removeEventListener("apikeydeleted",this.#onAPIKeyDeletedEventListener,!1),this.#onAPIKeyDeletedEventListener.destructor()}validateAPIKeys(){this.hideError();let e=!1,t=[];this.#APIKeysControls.forEach((o=>{e=e||""===o.providerName||""===o.providerKey,t.push(o.providerName)}));let o=!1;return t.forEach((e=>{o=o||t.indexOf(e)!==t.lastIndexOf(e)})),e?(this.showError(M.getText("APIKeysDialog - empty API key name or value")),!1):!o||(this.showError(M.getText("APIKeysDialog - duplicate API key name found")),!1)}addAPIKeys(e){this.#APIKeysControls.clear(),e.forEach((e=>{let t=new ve(e);this.#APIKeysControls.set(t.objId,t)})),this.refreshAPIKeys()}refreshAPIKeys(){for(;this.#APIKeysControlsContainer.firstChild;)this.#APIKeysControlsContainer.removeChild(this.#APIKeysControlsContainer.firstChild);this.#APIKeysControls.forEach((e=>{this.#APIKeysControlsContainer.appendChild(e.HTMLElements[0])}))}canClose(){return this.validateAPIKeys()}onCancel(){this.#destructor(),super.onCancel()}onOk(){let e=[];this.#APIKeysControls.forEach((t=>e.push(t.APIKey))),this.#destructor(),super.onOk(e)}get title(){return M.getText("APIKeysDialog - API keys")}get contentHTMLElements(){return[this.#toolbar.rootHTMLElement,this.#APIKeysControlsContainer]}}
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file EventDispatcher.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/const xe=new class{constructor(){Object.freeze(this)}dispatch(e,t){let o=new Event(e);t&&(o.data=t),document.dispatchEvent(o)}};const Me=new class{#mainHTMLElement=null;#messageHTMLElement=null;#timerId=null;#showHelpInput=null;#showHelpHTMLElement=null;#showHelp=e.errorsUI.showHelp;#onHelpInputChange(){this.#showHelp=!this.#showHelpInput.checked}#hide(){this.#timerId&&(clearTimeout(this.#timerId),this.#timerId=null),this.#mainHTMLElement.classList.remove("TravelNotes-ErrorsUI-Error"),this.#mainHTMLElement.classList.remove("TravelNotes-ErrorsUI-Warning"),this.#mainHTMLElement.classList.remove("TravelNotes-ErrorsUI-Info"),this.#mainHTMLElement.classList.remove("TravelNotes-ErrorsUI-Help"),this.#mainHTMLElement.classList.add("TravelNotes-Hidden"),this.#showHelpHTMLElement.classList.add("TravelNotes-Hidden"),this.#messageHTMLElement.textContent=""}#show(t,o){if("Error"===o&&!e.errorsUI.showError||"Warning"===o&&!e.errorsUI.showWarning||"Info"===o&&!e.errorsUI.showInfo||"Help"===o&&!e.errorsUI.showHelp||"Help"===o&&!this.#showHelp)return;this.#timerId&&(clearTimeout(this.#timerId),this.#timerId=null),x.sanitizeToHtmlElement(t,this.#messageHTMLElement),this.#mainHTMLElement.classList.add("TravelNotes-ErrorsUI-"+o),this.#mainHTMLElement.classList.remove("TravelNotes-Hidden");let a=e.errorsUI.timeOut;"Help"===o&&(this.#showHelpHTMLElement.classList.remove("TravelNotes-Hidden"),a=e.errorsUI.helpTimeOut),this.#timerId=setTimeout((()=>this.#hide()),a)}constructor(){Object.freeze(this)}createUI(){if(this.#mainHTMLElement)return;this.#mainHTMLElement=Z.create("div",{id:"TravelNotes-ErrorsUI",className:"TravelNotes-Hidden"},document.body);let e=Z.create("div",null,this.#mainHTMLElement);Z.create("span",{id:"TravelNotes-ErrorsUI-CancelButton",textContent:"❌"},e).addEventListener("click",(()=>this.#hide()),!1),this.#messageHTMLElement=Z.create("div",{id:"TravelNotes-ErrorsUI-Message"},this.#mainHTMLElement),this.#showHelpHTMLElement=Z.create("div",{id:"TravelNotes-ErrorsUI-HelpInputDiv",className:"TravelNotes-Hidden"},this.#mainHTMLElement),this.#showHelpInput=Z.create("input",{id:"TravelNotes-ErrorsUI-HelpInput",type:"checkbox"},this.#showHelpHTMLElement),this.#showHelpInput.addEventListener("change",(()=>this.#onHelpInputChange()),!1),Z.create("label",{id:"TravelNotes-ErrorsUI-HelpInputLabel",htmlFor:"TravelNotes-ErrorsUI-HelpInput",textContent:M.getText("ErrorUI - Dont show again")},this.#showHelpHTMLElement)}showError(e){this.#show(e,"Error")}showWarning(e){this.#show(e,"Warning")}showInfo(e){this.#show(e,"Info")}showHelp(e){this.#show(e,"Help")}};
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file BaseRouteProvider.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/class Pe{#userLanguage="fr";#providerKey="";#route=null;#getRoute(e,t){}constructor(){Object.seal(this)}get icon(){return"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAIAAAC0Ujn1AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAArSURBVEhL7cyxDQAgAAQh91/67ektTI4BOHumGtWoRjWqUY1qVKMaP9bbBZKXggu6NeCUAAAAAElFTkSuQmCC"}getPromiseRoute(e){return this.#route=e,new Promise(((e,t)=>this.#getRoute(e,t)))}get name(){return""}get title(){return""}get transitModes(){return[]}get providerKeyNeeded(){return!0}get providerKey(){return this.#providerKey.length}set providerKey(e){this.#providerKey=e}get userLanguage(){return this.#userLanguage}set userLanguage(e){this.#userLanguage=e}}const Ce=new class{#haveAPIKeysFile=!1;#APIKeysMap=new Map;#onOkDecryptServerFile(e){let t=JSON.parse((new TextDecoder).decode(e));this.#resetAPIKeys(t)}#onErrorDecryptServerFile(e){e instanceof Error&&console.error(e),e&&"Canceled by user"!==e&&Me.showError(M.getText("APIKeysManager - An error occurs when reading the APIKeys file"))}#onServerFileFound(e){window.isSecureContext&&window.crypto&&window.crypto.subtle&&window.crypto.subtle.importKey&&(new ce).decryptData(e,(e=>this.#onOkDecryptServerFile(e)),(e=>this.#onErrorDecryptServerFile(e)),new he(!1).show())}#getAPIKey(e){return this.#APIKeysMap.get(e.toLowerCase())}#setAPIKey(e,t){this.#APIKeysMap.set(e.toLowerCase(),t)}#setAPIKeysFromSessionStorage(){let e=0;for(let t=0;t<sessionStorage.length;t++){let o=sessionStorage.key(t);"ProviderKey"===o.substr(o.length-"ProviderKey".length)&&(this.#setAPIKey(o.substr(0,o.length-"ProviderKey".length),atob(sessionStorage.getItem(o))),e++)}return W.providers.forEach((e=>{e.providerKey=this.#getAPIKey(e.name)||""})),e}#resetAPIKeys(t){sessionStorage.clear(),this.#APIKeysMap.clear();let o=P.storageAvailable("sessionStorage")&&e.APIKeys.saveToSessionStorage;t.forEach((e=>{o&&sessionStorage.setItem(e.providerName.toLowerCase()+"ProviderKey",btoa(e.providerKey)),this.#setAPIKey(e.providerName,e.providerKey)})),W.providers.forEach((e=>{e.providerKey=this.#getAPIKey(e.name)||""})),xe.dispatch("providersadded")}constructor(){Object.freeze(this)}hasKey(e){return this.#APIKeysMap.has(e.toLowerCase())}getUrl(e){if(e.providerKeyNeeded){let t=this.#APIKeysMap.get(e.providerName.toLowerCase());return t?e.url.replace("{providerKey}",t):null}return e.url}setKeysFromServerFile(){let e=!1;0!==this.#setAPIKeysFromSessionStorage()&&(xe.dispatch("providersadded"),e=!0),fetch(window.location.href.substr(0,window.location.href.lastIndexOf("/")+1)+"APIKeys").then((t=>{b===t.status&&t.ok&&(this.#haveAPIKeysFile=!0,e||t.arrayBuffer().then((e=>this.#onServerFileFound(e))))})).catch((e=>{e instanceof Error&&console.error(e)}))}setKeysFromDialog(){let e=[];this.#APIKeysMap.forEach(((t,o)=>{e.push(Object.seal({providerName:o,providerKey:t}))})),e.sort(((e,t)=>e.providerName.localeCompare(t.providerName))),new Ne(e,this.#haveAPIKeysFile).show().then((e=>this.#resetAPIKeys(e))).catch((e=>{e instanceof Error&&console.error(e)}))}addProvider(e){if(!Object.prototype.isPrototypeOf.call(Pe,e))return void console.error("Invalid provider class given : "+e.name);let t=new e,o=t.name.toLowerCase(),a=this.#getAPIKey(o);t.providerKeyNeeded&&!a&&P.storageAvailable("sessionStorage")&&(a=sessionStorage.getItem(o),a&&(a=atob(a))),t.providerKeyNeeded&&a&&(t.providerKey=a),W.providers.set(t.name.toLowerCase(),t)}},je=d.margin.toFixed(0),Ae=(d.margin+d.height).toFixed(0),Oe=(d.margin+d.width).toFixed(0),Se=d.margin.toFixed(0),ke=(d.margin+d.width+d.xDeltaText).toFixed(0),Re=(d.margin-d.xDeltaText).toFixed(0),He=d.margin+d.height+d.margin/2;class Be{#route=null;#smoothDistance=0;#smoothPoints=e.route.elev.smoothPoints;#svg=null;#VScale=1;#HScale=1;#minElev=Number.MAX_VALUE;#maxElev=0;#deltaElev=0;#createTmpPoints(){let e=0,t=0,o=[],a=this.#route.itinerary.itineraryPoints.iterator,n=0,s=a.done;for(o.push({distance:e,elev:a.value.elev}),n+=a.value.distance,s=a.done;!s;){for(e+=this.#smoothDistance;e>=n&&!s;)n+=a.value.distance,s=a.done;if(!s){let s=(a.value.elev-a.previous.elev)/a.previous.distance;t=a.value.elev-(n-e)*s,o.push({distance:e,elev:t})}}return o.push({distance:n,elev:this.#route.itinerary.itineraryPoints.last.elev}),o}#createSmoothPoints(){let e=this.#createTmpPoints(),t=new Map,o=(e[this.#smoothPoints].elev-e[0].elev)/this.#smoothPoints,a=0;for(a=0;a<this.#smoothPoints;a++)t.set(a*this.#smoothDistance,{distance:a*this.#smoothDistance,elev:e[0].elev+o*a});for(a=this.#smoothPoints;a<e.length-this.#smoothPoints;a++){let o=0;for(let t=a-this.#smoothPoints;a+this.#smoothPoints>=t;t++)o+=e[t].elev;t.set(e[a].distance,{distance:e[a].distance,elev:o/(2*this.#smoothPoints+1)})}return a--,o=this.#smoothDistance*(e[e.length-1].elev-e[e.length-1-this.#smoothPoints].elev)/(e[e.length-1].distance-e[e.length-1-this.#smoothPoints].distance),t.set(e[a].distance+this.#smoothDistance,{distance:e[a].distance+this.#smoothDistance,elev:e[a].elev+o}),t.set(e[a].distance+2*this.#smoothDistance,{distance:e[a].distance+2*this.#smoothDistance,elev:e[a].elev+2*o}),t}#createProfilePolyline(){let e="",t=0,o=0,a=0;this.#route.itinerary.itineraryPoints.forEach((n=>{o=(d.margin+this.#HScale*t).toFixed(0),a=(d.margin+this.#VScale*(this.#maxElev-n.elev)).toFixed(0),e+=o+","+a+" ",t+=n.distance}));let n=document.createElementNS(y,"polyline");n.setAttributeNS(null,"points",e),n.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-profilePolyline"),this.#svg.appendChild(n)}#createFramePolyline(){let e=je+","+Se+" "+je+","+Ae+" "+Oe+","+Ae+" "+Oe+","+Se,t=document.createElementNS(y,"polyline");t.setAttributeNS(null,"points",e),t.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-framePolyline"),this.#svg.appendChild(t)}#createDistanceTexts(){let e=Number.MAX_VALUE,t=0;d.hScales.forEach((o=>{let a=Math.abs(this.#route.distance/8-o);a<e&&(e=a,t=o)}));let o=Math.ceil(this.#route.chainedDistance/t)*t;for(;o<this.#route.distance+this.#route.chainedDistance;){let e=document.createElementNS(y,"text");e.appendChild(document.createTextNode(a.metersInKm<t||0<this.#route.chainedDistance?o/a.metersInKm+" km":o+" m ")),e.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-distLegend"),e.setAttributeNS(null,"x",d.margin+(o-this.#route.chainedDistance)*this.#HScale),e.setAttributeNS(null,"y",He),e.setAttributeNS(null,"text-anchor","start"),this.#svg.appendChild(e),o+=t}}#createElevTexts(){let e=Number.MAX_VALUE,t=0;d.vScales.forEach((o=>{let a=Math.abs(this.#deltaElev/4-o);a<e&&(e=a,t=o)}));let o=Math.ceil(this.#minElev/t)*t;for(;o<this.#maxElev;){let e=d.margin+(this.#maxElev-o)*this.#VScale,a=document.createElementNS(y,"text");a.appendChild(document.createTextNode(o.toFixed(0))),a.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-elevLegend"),a.setAttributeNS(null,"x",ke),a.setAttributeNS(null,"y",e),a.setAttributeNS(null,"text-anchor","start"),this.#svg.appendChild(a);let n=document.createElementNS(y,"text");n.appendChild(document.createTextNode(o.toFixed(0))),n.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-elevLegend"),n.setAttributeNS(null,"x",Re),n.setAttributeNS(null,"y",e),n.setAttributeNS(null,"text-anchor","end"),this.#svg.appendChild(n),o+=t}}#createSvgElement(){this.#svg=document.createElementNS(y,"svg"),this.#svg.setAttributeNS(null,"viewBox","0 0 "+(d.width+2*d.margin)+" "+(d.height+2*d.margin)),this.#svg.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile")}constructor(){Object.freeze(this)}smooth(t){this.#route=t;let o=this.#route.itinerary.itineraryPoints.iterator,a=0,n=0;for(;!o.done;)a+=o.value.distance,n+=o.next?Math.abs(o.value.elev-o.next.elev):0;if(this.#smoothDistance=10*Math.floor(e.route.elev.smoothCoefficient/(n/a)),a<=2*this.#smoothPoints*this.#smoothDistance)return;let s=this.#createSmoothPoints();o=this.#route.itinerary.itineraryPoints.iterator,o.done;let i=o.value.distance;for(;!o.done;){let e=s.get(Math.floor(i/this.#smoothDistance)*this.#smoothDistance),t=s.get(Math.ceil(i/this.#smoothDistance)*this.#smoothDistance);if(e&&t){let a=i-e.distance,n=(t.elev-e.elev)/(t.distance-e.distance);o.value.elev=e.elev+a*n}i+=o.value.distance}}createSvg(e){return this.#route=e,this.#minElev=Number.MAX_VALUE,this.#maxElev=0,this.#route.itinerary.itineraryPoints.forEach((e=>{this.#maxElev=Math.max(this.#maxElev,e.elev),this.#minElev=Math.min(this.#minElev,e.elev)})),this.#deltaElev=this.#maxElev-this.#minElev,this.#VScale=d.height/this.#deltaElev,this.#HScale=d.width/this.#route.distance,this.#createSvgElement(),this.#createProfilePolyline(),this.#createFramePolyline(),this.#createElevTexts(),this.#createDistanceTexts(),this.#svg}}const Ue=new class{constructor(){Object.freeze(this)}getNoteTextAndIconHTML(t,o){let a=Z.create("div",{dataset:{ObjId:o.note.objId}}),n=Z.create("div",{className:t+(o.route?"Route-ManeuversAndNotes-IconCell":"Travel-Notes-IconCell")},a),s=1;x.sanitizeToHtmlElement(o.note.iconContent,n),"TravelNotes-Roadbook-"===t&&n.firstChild?("svg"===n.firstChild.tagName?(n.firstChild.setAttributeNS(null,"viewBox","0 0 "+h.svgViewboxDim+" "+h.svgViewboxDim),s=e.note.svgIcon.roadbookFactor):n.firstChild.classList.contains("TravelNotes-MapNoteCategory-0073")&&(s=e.note.svgIcon.roadbookFactor),n.setAttribute("tanwidth",String(o.note.iconWidth*s)+"px"),n.setAttribute("tanheight",String(o.note.iconWidth*s)+"px")):(n.style.width=String(o.note.iconWidth)+"px",n.style.height=String(o.note.iconHeight)+"px");let i=this.getNoteTextHTML(t,o);return i.className=t+(o.route?"Route-ManeuversAndNotes-Cell":"Travel-Notes-Cell"),a.appendChild(i),a}getNoteTextHTML(e,t){let o=t.note,a=Z.create("div");if(0!==o.tooltipContent.length&&x.sanitizeToHtmlElement(o.tooltipContent,Z.create("div",{className:e+"NoteHtml-TooltipContent"},a)),0!==o.popupContent.length&&x.sanitizeToHtmlElement(o.popupContent,Z.create("div",{className:e+"NoteHtml-PopupContent"},a)),0!==o.address.length&&x.sanitizeToHtmlElement("<span>"+M.getText("NoteHTMLViewsFactory - Address")+"</span> : "+o.address,Z.create("div",{className:e+"NoteHtml-Address"},a)),0!==o.url.length&&x.sanitizeToHtmlElement("<span>"+M.getText("NoteHTMLViewsFactory - Link")+"</span><a href="+o.url+' target="_blank" >'+o.url.substr(0,40)+"...</a>",Z.create("div",{className:e+"NoteHtml-Url"},a)),0!==o.phone.length){let t=o.phone;if(o.phone.match(/^\+[0-9, ,*,\u0023]*$/)){let e=o.phone.replaceAll(/\u0020/g,""),a=o.phone.replaceAll(/\u0020/g," ");t=M.getText("NoteHTMLViewsFactory - Phone")+" : "+M.getText("NoteHTMLViewsFactory - call")+'<a target="_blank" href="tel:'+e+'" >'+a+"</a>"+M.getText("NoteHTMLViewsFactory - Send a sms to")+'<a target="_blank" href="sms:'+e+'" >'+a+"</a>"}else t=M.getText("NoteHTMLViewsFactory - Phone")+" : "+o.phone;x.sanitizeToHtmlElement(t,Z.create("div",{className:e+"NoteHtml-Phone"},a))}if(x.sanitizeToHtmlElement(P.formatLatLng(o.latLng),Z.create("div",{className:e+"NoteHtml-LatLng"},a)),t.route){t.route.chain&&x.sanitizeToHtmlElement("<span>"+M.getText("NoteHTMLViewsFactory - Distance from start of travel")+"</span> : "+P.formatDistance(o.chainedDistance+o.distance),Z.create("div",{className:e+"NoteHtml-Distance"},a)),x.sanitizeToHtmlElement("<span>"+M.getText("NoteHTMLViewsFactory - Distance from start of route")+"</span> : "+P.formatDistance(o.distance),Z.create("div",{className:e+"NoteHtml-Distance"},a));let n=t.route.notes.next(o.objId);if(n){let t=n.distance-o.distance;9<t&&x.sanitizeToHtmlElement("<span>"+M.getText("NoteHTMLViewsFactory - Next note after")+"</span> : "+P.formatDistance(t),Z.create("div",{className:e+"NoteHtml-NextDistance"},a))}}return a}getTravelNotesHTML(e){let t=Z.create("div",{className:e+"Travel-Notes"}),o=W.travel.notes.iterator;for(;!o.done;){let a=this.getNoteTextAndIconHTML(e,{note:o.value,route:null});a.className=e+"Travel-Notes-Row",t.appendChild(a)}return t}};const Ke=new class{#getManeuverHTML(e,t){let o=Z.create("div");Z.create("div",{className:e+"Route-ManeuversAndNotes-IconCell TravelNotes-ManeuverNote-"+t.maneuver.iconName},o);let n=Z.create("div",{className:e+"Route-ManeuversAndNotes-Cell"},o);return x.sanitizeToHtmlElement(t.maneuver.instruction,Z.create("div",null,n)),t.route.chain&&x.sanitizeToHtmlElement("<span>"+M.getText("RouteHTMLViewsFactory - Distance from start of travel")+"</span> : "+P.formatDistance(t.route.chainedDistance+t.maneuverDistance),Z.create("div",{className:e+"Route-Maneuver-Distance"},n)),x.sanitizeToHtmlElement("<span>"+M.getText("RouteHTMLViewsFactory - Distance from start of route")+"</span> : "+P.formatDistance(t.maneuverDistance),Z.create("div",{className:e+"Route-Maneuver-Distance"},n)),a.defaultValue<t.maneuver.distance&&x.sanitizeToHtmlElement("<span>"+M.getText("RouteHTMLViewsFactory - Next maneuver after")+"</span> : "+P.formatDistance(t.maneuver.distance),Z.create("div",{className:e+"Route-Maneuver-Distance"},n)),o}constructor(){Object.freeze(this)}getRouteProfileHTML(e,t){let o=Z.create("div",{className:e+"RouteProfile"});return x.sanitizeToHtmlElement(M.getText("RouteHTMLViewsFactory - Profile"),o),o.appendChild((new Be).createSvg(t)),o}getRouteManeuversAndNotesHTML(e,t,o){let a=[],n=t.notes.iterator;for(;!n.done;)a.push({data:n.value,distance:n.value.distance});let s=t.itinerary.maneuvers.iterator,i=0;for(;!s.done;)a.push({data:s.value,distance:i}),i+=s.value.distance;a.sort(((e,t)=>e.distance-t.distance));let r=Z.create("div",{className:e+"Route-ManeuversAndNotes"});return a.forEach((a=>{let n=null;"Note"===a.data.objType.name?(n=Ue.getNoteTextAndIconHTML(e,{note:a.data,route:t}),n.className=e+"Route-Notes-Row"):(n=this.#getManeuverHTML(e,{route:t,maneuver:a.data,maneuverDistance:a.distance}),n.className=e+"Route-Maneuvers-Row"),o&&(n.dataset.tanObjId=a.data.objId,n.dataset.tanMarkerObjId=T.nextObjId,n.dataset.tanObjType=a.data.objType.name),r.appendChild(n)})),r}getRouteHeaderHTML(e,t){let o=Z.create("div",{className:e+"Route-Header",id:"route"+t.objId});return x.sanitizeToHtmlElement(t.computedName,Z.create("div",{className:e+"Route-Header-Name"},o)),0!==t.distance&&x.sanitizeToHtmlElement("<span>"+M.getText("RouteHTMLViewsFactory - Route distance")+"</span> : "+P.formatDistance(t.distance),Z.create("div",{className:e+"Route-Header-Distance"},o)),W.travel.readOnly||"bike"===t.itinerary.transitMode||x.sanitizeToHtmlElement("<span>"+M.getText("RouteHTMLViewsFactory - Duration")+"</span> : "+P.formatTime(t.duration),Z.create("div",{className:e+"Route-Header-Duration"},o)),t.itinerary.hasProfile&&(x.sanitizeToHtmlElement("<span>"+M.getText("RouteHTMLViewsFactory - Ascent")+"</span> : "+String(t.itinerary.ascent.toFixed(0))+" m.",Z.create("div",{className:e+"Route-Header-Ascent"},o)),x.sanitizeToHtmlElement("<span>"+M.getText("RouteHTMLViewsFactory - Descent")+"</span> : "+String(t.itinerary.descent.toFixed(0))+" m.",Z.create("div",{className:e+"Route-Header-Descent"},o))),o}getRouteFooterHTML(e,t){let o="";""!==t.itinerary.provider&&""!==t.itinerary.transitMode&&(o=M.getText("RouteHTMLViewsFactory - Itinerary computed by {provider} and optimized for {transitMode}",{provider:t.itinerary.provider,transitMode:M.getText("RouteHTMLViewsFactory - TransitMode "+t.itinerary.transitMode)}));let a=Z.create("div",{className:e+"RouteFooter"});return x.sanitizeToHtmlElement(o,a),a}};
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file BaseContextMenuEventListeners.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/class Fe{#menuOperator=null;constructor(e){this.#menuOperator=e}destructor(){this.#menuOperator=null}handleEvent(e){e.stopPropagation(),this.#menuOperator.onKeydownKeyboard(e.key)}}class ze{#menuOperator=null;constructor(e){this.#menuOperator=e}destructor(){this.#menuOperator=null}handleEvent(e){e.stopPropagation(),this.#menuOperator.onCancelMenu()}}class Ve{#menuOperator=null;constructor(e){this.#menuOperator=e}destructor(){this.#menuOperator=null}handleEvent(e){e.stopPropagation(),this.#menuOperator.onMouseLeaveMenuItem(e.target)}}class We{#menuOperator=null;constructor(e){this.#menuOperator=e}destructor(){this.#menuOperator=null}handleEvent(e){e.stopPropagation(),this.#menuOperator.onMouseEnterMenuItem(e.target)}}class Ge{#menuOperator=null;constructor(e){this.#menuOperator=e}destructor(){this.#menuOperator=null}handleEvent(e){e.stopPropagation(),this.#menuOperator.selectItem(Number.parseInt(e.target.dataset.tanObjId))}}class Xe{#menuOperator=null;constructor(e){this.#menuOperator=e}destructor(){this.#menuOperator=null}handleEvent(e){e.stopPropagation(),this.#menuOperator.onMouseLeaveContainer()}}class _e{#menuOperator=null;constructor(e){this.#menuOperator=e}destructor(){this.#menuOperator=null}handleEvent(e){e.stopPropagation(),this.#menuOperator.onMouseEnterContainer()}}class Ze{#contextMenu=null;#eventListeners={onKeydownKeyboard:null,onMouseLeaveContainer:null,onMouseEnterContainer:null,onMouseClickCancelButton:null,onClickMenuItem:null,onMouseLeaveMenuItem:null,onMouseEnterMenuItem:null};#keyboardSelectedItem=m;#timerId=null;#unselectItems(){this.#contextMenu.htmlElements.menuItemHTMLElements.forEach((e=>{e.classList.remove("TravelNotes-ContextMenu-ItemSelected")}))}#changeKeyboardSelectedItem(e){switch(this.#unselectItems(),e){case m:case 1:this.#keyboardSelectedItem+=e,m===this.#keyboardSelectedItem&&(this.#keyboardSelectedItem=this.#contextMenu.htmlElements.menuItemHTMLElements.length-1),this.#contextMenu.htmlElements.menuItemHTMLElements.length===this.#keyboardSelectedItem&&(this.#keyboardSelectedItem=0);break;case 0:this.#keyboardSelectedItem=0;break;default:this.#keyboardSelectedItem=this.#contextMenu.htmlElements.menuItemHTMLElements.length-1}this.#contextMenu.htmlElements.menuItemHTMLElements[this.#keyboardSelectedItem].classList.add("TravelNotes-ContextMenu-ItemSelected")}constructor(e){this.#contextMenu=e,this.#eventListeners.onKeydownKeyboard=new Fe(this),this.#eventListeners.onMouseLeaveContainer=new Xe(this),this.#eventListeners.onMouseEnterContainer=new _e(this),this.#eventListeners.onMouseClickCancelButton=new ze(this),this.#eventListeners.onClickMenuItem=new Ge(this),this.#eventListeners.onMouseLeaveMenuItem=new Ve(this),this.#eventListeners.onMouseEnterMenuItem=new We(this),document.addEventListener("keydown",this.#eventListeners.onKeydownKeyboard,!0),this.#contextMenu.htmlElements.container.addEventListener("mouseleave",this.#eventListeners.onMouseLeaveContainer),this.#contextMenu.htmlElements.container.addEventListener("mouseenter",this.#eventListeners.onMouseEnterContainer),this.#contextMenu.htmlElements.cancelButton.addEventListener("click",this.#eventListeners.onMouseClickCancelButton),this.#contextMenu.htmlElements.menuItemHTMLElements.forEach((e=>{e.addEventListener("click",this.#eventListeners.onClickMenuItem),e.addEventListener("mouseleave",this.#eventListeners.onMouseLeaveMenuItem),e.addEventListener("mouseenter",this.#eventListeners.onMouseEnterMenuItem)}))}destructor(){this.#timerId&&(clearTimeout(this.#timerId),this.#timerId=null),document.removeEventListener("keydown",this.#eventListeners.onKeydownKeyboard,!0),this.#contextMenu.htmlElements.container.removeEventListener("mouseleave",this.#eventListeners.onMouseLeaveContainer),this.#contextMenu.htmlElements.container.removeEventListener("mouseenter",this.#eventListeners.onMouseEnterContainer),this.#contextMenu.htmlElements.cancelButton.removeEventListener("click",this.#eventListeners.onMouseClickCancelButton),this.#contextMenu.htmlElements.menuItemHTMLElements.forEach((e=>{e.removeEventListener("click",this.#eventListeners.onClickMenuItem),e.removeEventListener("mouseleave",this.#eventListeners.onMouseLeaveMenuItem),e.removeEventListener("mouseenter",this.#eventListeners.onMouseEnterMenuItem)}));for(const e in this.#eventListeners)this.#eventListeners[e].destructor();this.#contextMenu.htmlElements.parentNode.removeChild(this.#contextMenu.htmlElements.container),this.#contextMenu=null}onMouseLeaveContainer(){this.#timerId=setTimeout((()=>this.onCancelMenu()),e.contextMenu.timeout)}onMouseEnterContainer(){this.#timerId&&(clearTimeout(this.#timerId),this.#timerId=null)}onKeydownKeyboard(e){switch(e){case"Escape":case"Esc":this.onCancelMenu();break;case"ArrowDown":case"ArrowRight":case"Tab":this.#changeKeyboardSelectedItem(1);break;case"ArrowUp":case"ArrowLeft":this.#changeKeyboardSelectedItem(m);break;case"Home":this.#changeKeyboardSelectedItem(0);break;case"End":this.#changeKeyboardSelectedItem(2);break;case"Enter":if(m===this.#keyboardSelectedItem||this.#contextMenu.htmlElements.menuItemHTMLElements[this.#keyboardSelectedItem].classList.contains("TravelNotes-ContextMenu-ItemDisabled"))return;this.#contextMenu.onOk(this.#keyboardSelectedItem)}}onCancelMenu(){this.#contextMenu.onCancel("Canceled by user")}selectItem(e){this.#contextMenu.htmlElements.menuItemHTMLElements[e].classList.contains("TravelNotes-ContextMenu-ItemDisabled")||this.#contextMenu.onOk(e)}onMouseLeaveMenuItem(e){e.classList.remove("TravelNotes-ContextMenu-ItemSelected")}onMouseEnterMenuItem(e){this.#unselectItems(),this.#keyboardSelectedItem=Number.parseInt(e.dataset.tanObjId),e.classList.add("TravelNotes-ContextMenu-ItemSelected")}}class Ye{static#currentMenu=null;#onPromiseOk=null;#onPromiseError=null;#htmlElements={parentNode:null,container:null,cancelButton:null,menuItemHTMLElements:[]};#eventData={clientX:0,clientY:0,lat:r.defaultValue,lng:r.defaultValue,targetObjId:p,haveParentNode:!1};#menuOperator=null;#createContainer(){this.#htmlElements.container=Z.create("div",{className:"TravelNotes-ContextMenu-Container"},this.#htmlElements.parentNode)}#createCancelButton(){this.#htmlElements.cancelButton=Z.create("div",{textContent:"❌",className:"TravelNotes-ContextMenu-CloseButton",title:M.getText("ContextMenu - Close")},this.#htmlElements.container)}#createMenuItemsHTMLElements(){let e=0;this.menuItems.forEach((t=>{let o=Z.create("div",{textContent:t.itemText,className:"TravelNotes-ContextMenu-Item",dataset:{ObjId:String(e++)}},this.#htmlElements.container);t.isActive||o.classList.add("TravelNotes-ContextMenu-ItemDisabled"),this.#htmlElements.menuItemHTMLElements.push(o)}))}#moveContainer(){let e=W.map.getContainer().clientWidth,t=W.map.getContainer().clientHeight,o=Math.min(this.#eventData.clientY,t-this.#htmlElements.container.clientHeight-20),a=Math.min(this.#eventData.clientX,e-this.#htmlElements.container.clientWidth-20);this.#htmlElements.container.style.top=String(o)+"px",this.#eventData.haveParentNode?this.#htmlElements.container.style.right=String(20)+"px":this.#htmlElements.container.style.left=String(a)+"px"}#createMenu(e,t){this.#onPromiseOk=e,this.#onPromiseError=t,this.#createContainer(),this.#createCancelButton(),this.#createMenuItemsHTMLElements(),this.#moveContainer(),this.#menuOperator=new Ze(this)}onOk(e){this.#menuOperator.destructor(),Ye.#currentMenu=null,this.#onPromiseOk(e)}onCancel(){this.#menuOperator.destructor(),Ye.#currentMenu=null,this.#onPromiseError()}show(){Ye.#currentMenu&&new Promise(((e,t)=>{this.#createMenu(e,t)})).then((e=>this.doAction(e))).catch((e=>{e&&console.error(e)}))}constructor(e,t){Ye.#currentMenu?Ye.#currentMenu.onCancel():(this.#eventData.clientX=e.clientX||e.originalEvent.clientX||0,this.#eventData.clientY=e.clientY||e.originalEvent.clientY||0,this.#eventData.lat=e.latlng?e.latlng.lat:r.defaultValue,this.#eventData.lng=e.latlng?e.latlng.lng:r.defaultValue,e.target.objId?this.#eventData.targetObjId=e.target.objId:e.target.dataset&&e.target.dataset.tanObjId&&(this.#eventData.targetObjId=Number.parseInt(e.target.dataset.tanObjId)),this.#eventData.haveParentNode=null!==t,Object.freeze(this.#eventData),this.#htmlElements.parentNode=t||document.body,Ye.#currentMenu=this,Object.seal(this))}get menuItems(){return[]}get htmlElements(){return this.#htmlElements}get eventData(){return this.#eventData}}const Je=new class{#editionButtons=[];#preDefinedIconsMap=new Map;#preDefinedIcons=[];constructor(){}get buttons(){return this.#editionButtons}get icons(){return this.#preDefinedIcons}getIconData(e){return this.#preDefinedIcons[e][1]}getIconContentFromName(e){let t=this.#preDefinedIconsMap.get(e);return t?t.icon:""}loadJson(e){e.editionButtons&&(this.#editionButtons=this.#editionButtons.concat(e.editionButtons)),e.preDefinedIconsList.forEach((e=>{e.name=x.sanitizeToJsString(e.name)||"?",e.icon=x.sanitizeToHtmlString(e.icon).htmlString||"?",e.tooltip=x.sanitizeToJsString(e.tooltip)||"?",e.width=e.width||h.width,e.height=e.height||h.height,this.#preDefinedIconsMap.set(e.name,e)})),this.#preDefinedIcons=Array.from(this.#preDefinedIconsMap).sort(((e,t)=>e[0].localeCompare(t[0])))}};class qe{#route=null;#overpassAPIDataLoader=null;#MapIconData=null;#svgElement=null;#createSvg(){this.#svgElement=document.createElementNS(y,"svg"),this.#svgElement.setAttributeNS(null,"viewBox",String(h.svgViewboxDim/4)+" "+h.svgViewboxDim/4+" "+h.svgViewboxDim/2+" "+h.svgViewboxDim/2),this.#svgElement.setAttributeNS(null,"class","TravelNotes-SvgIcon")}#createRoute(){let t=-1,o=m,a=m,n=[];if(this.#route.itinerary.itineraryPoints.forEach((s=>{t++;let i=G.addPoints(G.project(s.latLng,e.note.svgIcon.zoom),this.#MapIconData.translation);n.push(i),i[0]>=0&&i[1]>=0&&i[0]<=h.svgViewboxDim&&i[1]<=h.svgViewboxDim&&(m===o&&(o=t),a=t)})),m!==o&&m!==a){0<o&&o--,this.#route.itinerary.itineraryPoints.length-1>a&&a++;let e="";for(t=o;t<=a;t++)e+=n[t][0].toFixed(0)+","+n[t][1].toFixed(0)+" ";let s=document.createElementNS(y,"polyline");s.setAttributeNS(null,"points",e),s.setAttributeNS(null,"class","TravelNotes-OSM-Itinerary"),s.setAttributeNS(null,"transform","rotate("+this.#MapIconData.rotation+","+h.svgViewboxDim/2+","+h.svgViewboxDim/2+")"),this.#svgElement.appendChild(s)}}#createWays(){this.#overpassAPIDataLoader.ways.forEach((t=>{let o=m,a=m,n=-1,s=[];if(t.nodes.forEach((t=>{n++;let i=this.#overpassAPIDataLoader.nodes.get(t),r=G.addPoints(G.project([i.lat,i.lon],e.note.svgIcon.zoom),this.#MapIconData.translation);s.push(r),r[0]>=0&&r[1]>=0&&r[0]<=h.svgViewboxDim&&r[1]<=h.svgViewboxDim&&(m===o&&(o=n),a=n)})),m!==o&&m!==a){0<o&&o--,t.nodes.length-1>a&&a++;let e="";for(n=o;n<=a;n++)e+=s[n][0].toFixed(0)+","+s[n][1].toFixed(0)+" ";let i=document.createElementNS(y,"polyline");i.setAttributeNS(null,"points",e),i.setAttributeNS(null,"class","TravelNotes-OSM-Highway TravelNotes-OSM-Highway-"+t.tags.highway),i.setAttributeNS(null,"transform","rotate("+this.#MapIconData.rotation+","+h.svgViewboxDim/2+","+h.svgViewboxDim/2+")"),this.#svgElement.appendChild(i)}}))}#createRcnRef(){if(""===this.#MapIconData.rcnRef)return;let e=document.createElementNS(y,"text");e.textContent=this.#MapIconData.rcnRef,e.setAttributeNS(null,"x",String(h.svgViewboxDim/2)),e.setAttributeNS(null,"y",String(.6*h.svgViewboxDim)),e.setAttributeNS(null,"class","TravelNotes-OSM-RcnRef"),this.#svgElement.appendChild(e)}constructor(){Object.freeze(this)}buildSvg(e,t,o){return this.#route=e,this.#overpassAPIDataLoader=t,this.#MapIconData=o,this.#createSvg(),this.#createRoute(),this.#createWays(),this.#createRcnRef(),this.#svgElement}}class Qe{#options={searchPlaces:!0,searchWays:!0,searchRelations:!0,setGeometry:!0};#nodes=new Map;#ways=new Map;#relations=new Map;#adminNames=null;#osmCityAdminLevel=null;#place=null;#places=null;#latLngDistance=Object.seal({latLng:[r.defaultValue,r.defaultValue],distance:a.defaultValue});#city=null;#statusOk=!0;#setGeometry(){this.#ways.forEach((e=>{e.geometry=[[]],e.lat=r.defaultValue,e.lon=r.defaultValue;let t=0;e.nodes.forEach((o=>{let a=this.#nodes.get(o);e.geometry[0].push([a.lat,a.lon]),e.lat+=a.lat,e.lon+=a.lon,t++})),0!==t&&(e.lat/=t,e.lon/=t)})),this.#relations.forEach((e=>{e.geometry=[[]],e.lat=r.defaultValue,e.lon=r.defaultValue;let t=0;e.members.forEach((o=>{if("way"===o.type){let a=this.#ways.get(o.ref);e.geometry.push(a.geometry[0]),e.lat+=a.lat,e.lon+=a.lon,t++}})),0!==t&&(e.lat/=t,e.lon/=t)}))}#parseData(t){t.forEach((t=>{switch(t.type){case"node":if(this.#nodes.set(t.id,t),t.tags&&this.#options.searchPlaces&&t.tags.place&&this.#places[t.tags.place]&&t.tags.name){let e=X.pointsDistance(this.#latLngDistance.latLng,[t.lat,t.lon]),o=this.#places[t.tags.place];o.maxDistance>e&&o.distance>e&&(o.distance=e,o.name=t.tags.name)}break;case"way":this.#options.searchWays&&this.#ways.set(t.id,t);break;case"relation":this.#options.searchRelations&&this.#relations.set(t.id,t);break;case"area":if(this.#options.searchPlaces){let o=t.tags.name;e.nominatim.language&&"*"!==e.nominatim.language&&t.tags["name:"+e.nominatim.language]&&(o=t.tags["name:"+e.nominatim.language]),this.#adminNames[Number.parseInt(t.tags.admin_level)]=o,"2"===t.tags.admin_level&&(this.#osmCityAdminLevel=e.geoCoder.osmCityAdminLevel[t.tags["ISO3166-1"]]||this.#osmCityAdminLevel)}}})),this.#options.setGeometry&&this.#setGeometry(),this.#options.searchPlaces&&this.#setPlaceAndCity()}#setPlaceAndCity(){let e=null;for(let t=2;t<this.#adminNames.length;t++)void 0!==this.#adminNames[t]&&(this.#osmCityAdminLevel>=t?this.#city=this.#adminNames[t]:e=this.#adminNames[t]);let t=Number.MAX_VALUE;Object.values(this.#places).forEach((e=>{e.distance<t&&(t=e.distance,this.#place=e.name)})),this.#place=e||this.#place,this.#place===this.#city&&(this.#place=null)}async#parseSearchResults(e){for(let t=0;t<e.length;t++)if("fulfilled"===e[t].status&&b===e[t].value.status&&e[t].value.ok){let o=await e[t].value.json();this.#parseData(o.elements),this.#statusOk=this.#statusOk&&!0}else this.#statusOk=!1,console.error("An error occurs when calling theOverpassAPI: "),console.error(e[t])}constructor(e){if(e)for(const[t,o]of Object.entries(e))this.#options[t]=o}async loadData(t,o){this.#statusOk=!0,this.#adminNames=[],this.#osmCityAdminLevel=e.geoCoder.osmCityAdminLevel.DEFAULT,this.#place=null,this.#places={hamlet:{name:null,distance:Number.MAX_VALUE,maxDistance:e.geoCoder.distances.hamlet},village:{name:null,distance:Number.MAX_VALUE,maxDistance:e.geoCoder.distances.village},city:{name:null,distance:Number.MAX_VALUE,maxDistance:e.geoCoder.distances.city},town:{name:null,distance:Number.MAX_VALUE,maxDistance:e.geoCoder.distances.town}},this.#latLngDistance.latLng=o,this.#latLngDistance.distance=a.defaultValue,this.#city=null,this.#nodes.clear(),this.#ways.clear(),this.#relations.clear();let n=[];t.forEach((t=>{n.push(fetch(e.overpassApi.url+"?data=[out:json][timeout:"+e.overpassApi.timeOut+"];"+t))})),await Promise.allSettled(n).then((e=>this.#parseSearchResults(e)))}get nodes(){return this.#nodes}get ways(){return this.#ways}get relations(){return this.#relations}get place(){return this.#place}get city(){return this.#city}get country(){return this.#adminNames[2]}get statusOk(){return this.#statusOk}}class $e{#overpassAPIDataLoader=null;#computeData=null;#mapIconData=null;#rcnRefNode=null;#svgPointId=m;#incomingNodeId=m;#outgoingNodeId=m;#iconNode=null;#incomingStreet="";#outgoingStreet="";#roundabout={isMini:!1,isEntry:!1,isExit:!1};#getWayName(e){return(e.tags.name?e.tags.name:"")+(e.tags.name&&e.tags.ref?" ":"")+(e.tags.ref?"["+e.tags.ref+"]":"")}#latLngCompare(e){const t=5e-6;let o=!1;return this.#computeData.route.wayPoints.forEach((a=>{Math.abs(e.lat-a.lat)<t&&Math.abs(e.lng-a.lng)<t&&(o=!0)})),!o&&(this.#computeData.mapIconPosition.latLng[0]!==e.lat||this.#computeData.mapIconPosition.latLng[1]!==e.lng)}#findNodes(){let e=this.#computeData.route.itinerary.itineraryPoints.previous(this.#computeData.mapIconPosition.nearestItineraryPointObjId,(e=>this.#latLngCompare(e))),t=this.#computeData.route.itinerary.itineraryPoints.next(this.#computeData.mapIconPosition.nearestItineraryPointObjId,(e=>this.#latLngCompare(e))),o=Number.MAX_VALUE,n=Number.MAX_VALUE,s=Number.MAX_VALUE,i=a.defaultValue;this.#overpassAPIDataLoader.nodes.forEach((a=>{"bike"===this.#computeData.route.itinerary.transitMode&&a.tags&&a.tags.rcn_ref&&(this.#rcnRefNode=a),p!==this.#computeData.mapIconPosition.nearestItineraryPointObjId&&(i=X.pointsDistance([a.lat,a.lon],this.#computeData.mapIconPosition.latLng),i<o&&(this.#svgPointId=a.id,o=i)),e&&(i=X.pointsDistance([a.lat,a.lon],e.latLng),i<n&&(this.#incomingNodeId=a.id,n=i)),t&&(i=X.pointsDistance([a.lat,a.lon],t.latLng),i<s&&(this.#outgoingNodeId=a.id,s=i))})),this.#iconNode=this.#overpassAPIDataLoader.nodes.get(this.#svgPointId)}#moveIconToRcnRef(){if(this.#rcnRefNode){let t=X.pointsDistance([this.#rcnRefNode.lat,this.#rcnRefNode.lon],[this.#iconNode.lat,this.#iconNode.lon]);e.note.svgIcon.rcnRefDistance>t&&(this.#iconNode=this.#rcnRefNode)}}#findMiniRoundabout(){this.#roundabout.isMini=this.#iconNode&&this.#iconNode.tags&&this.#iconNode.tags.highway&&"mini_roundabout"===this.#iconNode.tags.highway}#addRcnRefNumber(){"bike"===this.#computeData.route.itinerary.transitMode&&this.#iconNode&&this.#iconNode.tags&&this.#iconNode.tags.rcn_ref&&this.#iconNode.tags["network:type"]&&"node_network"===this.#iconNode.tags["network:type"]&&(this.#mapIconData.rcnRef=this.#iconNode.tags.rcn_ref,this.#mapIconData.tooltip+=M.getText("MapIconDataBuilder - rcnRef",{rcnRef:this.#mapIconData.rcnRef}))}#findStreets(){this.#overpassAPIDataLoader.ways.forEach((e=>{if(!e.nodes.includes(this.#svgPointId))return;let t=this.#getWayName(e),o=""!==t,a=e.nodes.includes(this.#incomingNodeId),n=e.nodes.includes(this.#outgoingNodeId),s=2*e.nodes.filter((e=>e===this.#svgPointId)).length;if(e.nodes[0]===this.#svgPointId&&s--,e.nodes[e.nodes.length-1]===this.#svgPointId&&s--,a&&(this.#incomingStreet=o?t:"???",s--,e.tags.junction&&"roundabout"===e.tags.junction&&(this.#roundabout.isExit=!0)),0!==s&&(n&&(this.#outgoingStreet=o?t:"???",s--,e.tags.junction&&"roundabout"===e.tags.junction&&(this.#roundabout.isEntry=!0)),0!==s&&o))for(;0!==s;)this.#mapIconData.streets=""===this.#mapIconData.streets?t:this.#mapIconData.streets+" ⪥  "+t,s--}))}#addStreetInfo(){u.atStart===this.#computeData.positionOnRoute?this.#mapIconData.streets="🟢 "+this.#outgoingStreet:u.atEnd===this.#computeData.positionOnRoute?this.#mapIconData.streets=this.#incomingStreet+" 🔴 ":this.#mapIconData.streets=this.#incomingStreet+(""===this.#mapIconData.streets?"":" ⪥  "+this.#mapIconData.streets)+" "+this.#computeData.directionArrow+" "+this.#outgoingStreet}#addRoundaboutInfo(){this.#roundabout.isEntry&&!this.#roundabout.isExit?this.#mapIconData.tooltip+=M.getText("MapIconDataBuilder - entry roundabout"):!this.#roundabout.isEntry&&this.#roundabout.isExit?this.#mapIconData.tooltip+=M.getText("MapIconDataBuilder - exit roundabout"):this.#roundabout.isEntry&&this.#roundabout.isExit&&(this.#mapIconData.tooltip+=M.getText("MapIconDataBuilder - continue roundabout")),this.#roundabout.isMini&&(this.#mapIconData.tooltip+=M.getText("MapIconDataBuilder - at the small roundabout on the ground"))}constructor(e,t,o){this.#overpassAPIDataLoader=e,this.#computeData=t,this.#mapIconData=o}findData(){this.#findNodes(),this.#moveIconToRcnRef(),this.#findMiniRoundabout(),this.#addRcnRefNumber(),this.#findStreets(),this.#addStreetInfo(),this.#addRoundaboutInfo()}}class et{#computeData=null;#mapIconData=null;constructor(e,t){this.#computeData=e,this.#mapIconData=t}findData(){null!==this.#computeData.direction&&(this.#computeData.direction<e.note.svgIcon.angleDirection.right?(this.#mapIconData.tooltip=M.getText("MapIconDataBuilder - Turn right"),this.#computeData.directionArrow="🢂"):this.#computeData.direction<e.note.svgIcon.angleDirection.slightRight?(this.#mapIconData.tooltip=M.getText("MapIconDataBuilder - Turn slight right"),this.#computeData.directionArrow="🢅"):this.#computeData.direction<e.note.svgIcon.angleDirection.continue?(this.#mapIconData.tooltip=M.getText("MapIconDataBuilder - Continue"),this.#computeData.directionArrow="🢁"):this.#computeData.direction<e.note.svgIcon.angleDirection.slightLeft?(this.#mapIconData.tooltip=M.getText("MapIconDataBuilder - Turn slight left"),this.#computeData.directionArrow="🢄"):this.#computeData.direction<e.note.svgIcon.angleDirection.left?(this.#mapIconData.tooltip=M.getText("MapIconDataBuilder - Turn left"),this.#computeData.directionArrow="🢀"):this.#computeData.direction<e.note.svgIcon.angleDirection.sharpLeft?(this.#mapIconData.tooltip=M.getText("MapIconDataBuilder - Turn sharp left"),this.#computeData.directionArrow="🢇"):this.#computeData.direction<e.note.svgIcon.angleDirection.sharpRight?(this.#mapIconData.tooltip=M.getText("MapIconDataBuilder - Turn sharp right"),this.#computeData.directionArrow="🢆"):(this.#mapIconData.tooltip=M.getText("MapIconDataBuilder - Turn right"),this.#computeData.directionArrow="🢂")),u.atStart===this.#computeData.positionOnRoute?this.#mapIconData.tooltip=M.getText("MapIconDataBuilder - Start"):u.atEnd===this.#computeData.positionOnRoute&&(this.#mapIconData.tooltip=M.getText("MapIconDataBuilder - Stop"))}}class tt{#computeData=null;#mapIconData=null;#rotationItineraryPoint=null;#directionItineraryPoint=null;#iconPoint=null;#computeTranslation(){this.#mapIconData.translation=G.subtrackPoints([h.svgViewboxDim/2,h.svgViewboxDim/2],G.project(this.#computeData.mapIconPosition.latLng,e.note.svgIcon.zoom))}#searchPoints(){this.#rotationItineraryPoint=this.#computeData.route.itinerary.itineraryPoints.first,this.#directionItineraryPoint=this.#computeData.route.itinerary.itineraryPoints.last;let t=a.defaultValue,o=!1;this.#computeData.route.itinerary.itineraryPoints.forEach((a=>{this.#computeData.mapIconPosition.distance-t>e.note.svgIcon.angleDistance&&(this.#rotationItineraryPoint=a),t-this.#computeData.mapIconPosition.distance>e.note.svgIcon.angleDistance&&!o&&(this.#directionItineraryPoint=a,o=!0),t+=a.distance})),this.#iconPoint=G.addPoints(G.project(this.#computeData.mapIconPosition.latLng,e.note.svgIcon.zoom),this.#mapIconData.translation)}#findRotation(){if(this.#computeData.mapIconPosition.nearestItineraryPointObjId!==this.#computeData.route.itinerary.itineraryPoints.first.objId){let t=G.addPoints(G.project(this.#rotationItineraryPoint.latLng,e.note.svgIcon.zoom),this.#mapIconData.translation);this.#mapIconData.rotation=Math.atan((this.#iconPoint[1]-t[1])/(t[0]-this.#iconPoint[0]))*c.d180/Math.PI,0>this.#mapIconData.rotation&&(this.#mapIconData.rotation+=c.d360),this.#mapIconData.rotation-=c.d270,0>t[0]-this.#iconPoint[0]&&(this.#mapIconData.rotation+=c.d180)}}#findDirection(){if(this.#computeData.mapIconPosition.nearestItineraryPointObjId!==this.#computeData.route.itinerary.itineraryPoints.last.objId){let t=G.addPoints(G.project(this.#directionItineraryPoint.latLng,e.note.svgIcon.zoom),this.#mapIconData.translation);for(this.#computeData.direction=Math.atan((this.#iconPoint[1]-t[1])/(t[0]-this.#iconPoint[0]))*c.d180/Math.PI,0>t[0]-this.#iconPoint[0]&&(this.#computeData.direction+=c.d180),this.#computeData.direction-=this.#mapIconData.rotation;c.d0>this.#computeData.direction;)this.#computeData.direction+=c.d360;for(;c.d360<this.#computeData.direction;)this.#computeData.direction-=c.d360}}#findPositionOnRoute(){this.#computeData.mapIconPosition.nearestItineraryPointObjId===this.#computeData.route.itinerary.itineraryPoints.first.objId&&(this.#mapIconData.rotation=-this.#computeData.direction-c.d90,this.#computeData.direction=null,this.#computeData.positionOnRoute=u.atStart),this.#computeData.mapIconPosition.latLng[0]===this.#computeData.route.itinerary.itineraryPoints.last.lat&&this.#computeData.mapIconPosition.latLng[1]===this.#computeData.route.itinerary.itineraryPoints.last.lng&&(this.#computeData.direction=null,this.#computeData.positionOnRoute=u.atEnd)}findData(){this.#computeTranslation(),this.#searchPoints(),this.#findRotation(),this.#findDirection(),this.#findPositionOnRoute()}constructor(e,t){this.#computeData=e,this.#mapIconData=t}}class ot{#overpassAPIDataLoader=null;#mapIconData=Object.seal({translation:[0,0],rotation:0,rcnRef:"",tooltip:"",streets:""});#computeData={mapIconPosition:null,route:null,positionOnRoute:u.onRoute,direction:null,directionArrow:" "};constructor(){Object.freeze(this)}buildData(e,t,o){return this.#computeData.mapIconPosition=o,this.#computeData.route=e,this.#computeData.positionOnRoute=u.onRoute,this.#computeData.direction=null,this.#computeData.directionArrow=" ",this.#overpassAPIDataLoader=t,this.#mapIconData.translation=[0,0],this.#mapIconData.rotation=0,this.#mapIconData.rcnRef="",this.#mapIconData.tooltip="",this.#mapIconData.streets="",new tt(this.#computeData,this.#mapIconData).findData(),new et(this.#computeData,this.#mapIconData).findData(),new $e(this.#overpassAPIDataLoader,this.#computeData,this.#mapIconData).findData(),this.#mapIconData}}class at{#route=null;#overpassAPIDataLoader=new Qe({searchRelations:!1,setGeometry:!1});#mapIconPosition=Object.seal({latLng:[r.defaultValue,r.defaultValue],distance:a.defaultValue,nearestItineraryPointObjId:p});#queryDistance=Math.max(e.geoCoder.distances.hamlet,e.geoCoder.distances.village,e.geoCoder.distances.city,e.geoCoder.distances.town);#requestStarted=!1;#searchNearestItineraryPoint(){let e=null,t=Number.MAX_VALUE,o=a.defaultValue;this.#route.itinerary.itineraryPoints.forEach((a=>{let n=X.pointsDistance(this.#mapIconPosition.latLng,a.latLng);t>n&&(t=n,e=a,this.#mapIconPosition.distance=o),o+=a.distance})),this.#mapIconPosition.latLng=e.latLng,this.#mapIconPosition.nearestItineraryPointObjId=e.objId}#buildIconAndAdress(){let e=(new ot).buildData(this.#route,this.#overpassAPIDataLoader,this.#mapIconPosition),t=(new qe).buildSvg(this.#route,this.#overpassAPIDataLoader,e);this.#requestStarted=!1;let o=e.streets;return""!==this.#overpassAPIDataLoader.city&&(o+=' <span class="TravelNotes-NoteHtml-Address-City">'+this.#overpassAPIDataLoader.city+"</span>"),this.#overpassAPIDataLoader.place&&this.#overpassAPIDataLoader.place!==this.#overpassAPIDataLoader.city&&(o+=" ("+this.#overpassAPIDataLoader.place+")"),Object.freeze({statusOk:!0,noteData:{iconContent:t.outerHTML,tooltipContent:e.tooltip,address:o,iconWidth:h.width,iconHeight:h.height,latLng:this.#mapIconPosition.latLng}})}async#exeGetIconAndAdress(){if(this.#requestStarted)return Object.freeze({statusOk:!1,noteData:null});this.#requestStarted=!0,this.#searchNearestItineraryPoint();let e=this.#mapIconPosition.latLng[0].toFixed(r.fixed)+","+this.#mapIconPosition.latLng[1].toFixed(r.fixed),t=["way[highway](around:"+(1.5*h.svgViewboxDim).toFixed(0)+","+e+")->.a;(.a >;.a;)->.a;.a out;is_in("+e+')->.e;area.e[admin_level][boundary="administrative"];out;node(around:'+this.#queryDistance+","+e+")[place];out;"];return await this.#overpassAPIDataLoader.loadData(t,this.#mapIconPosition.latLng),this.#overpassAPIDataLoader.statusOk?this.#buildIconAndAdress():Object.freeze({statusOk:!1})}async#exeGetIconAndAdressWithPromise(e,t){let o=await this.#exeGetIconAndAdress();o.statusOk?e(o):t("An error occurs...")}constructor(){Object.freeze(this)}async getIconAndAdressAsync(e,t){return this.#mapIconPosition.latLng=e,this.#route=_.getRoute(t),this.#exeGetIconAndAdress()}getIconAndAdressWithPromise(e,t){return this.#mapIconPosition.latLng=e,this.#route=_.getRoute(t),new Promise(((e,t)=>this.#exeGetIconAndAdressWithPromise(e,t)))}}class nt{#noteDialog=null;constructor(e){this.#noteDialog=e}destructor(){this.#noteDialog=null}handleEvent(e){if(!this.#noteDialog.focusControl)return;let t=e.target;for(;!t.dataset.tanHtmlBefore;)t=t.parentNode;let o=this.#noteDialog.focusControl.selectionStart,a=this.#noteDialog.focusControl.selectionEnd;this.#noteDialog.focusControl.value=this.#noteDialog.focusControl.value.slice(0,o)+t.dataset.tanHtmlBefore+(0===t.dataset.tanHtmlAfter.length?"":this.#noteDialog.focusControl.value.slice(o,a))+t.dataset.tanHtmlAfter+this.#noteDialog.focusControl.value.slice(a),o===a||0===t.dataset.tanHtmlAfter.length?(o+=t.dataset.tanHtmlBefore.length,a=o):a+=t.dataset.tanHtmlBefore.length+t.dataset.tanHtmlAfter.length,this.#noteDialog.focusControl.setSelectionRange(o,a),this.#noteDialog.focusControl.focus();let n={};n[this.#noteDialog.focusControl.dataset.tanName]=this.#noteDialog.focusControl.value,this.#noteDialog.updatePreview(n)}}class st{#noteDialog=null;#updatePreviewAndControls(e){this.#noteDialog.setControlsValues(e),this.#noteDialog.updatePreview(e)}#onMapIcon(){p!==this.#noteDialog.mapIconData.routeObjId?(this.#noteDialog.showWait(),(new at).getIconAndAdressWithPromise(this.#noteDialog.mapIconData.latLng,this.#noteDialog.mapIconData.routeObjId).then((e=>{this.#noteDialog.hideWait(),this.#updatePreviewAndControls(e.noteData)})).catch((()=>{this.#noteDialog.hideWait(),this.#noteDialog.showError(M.getText("Notedialog - an error occurs when creating the SVG icon"))}))):this.#noteDialog.showError(M.getText("Notedialog - not possible to create a SVG icon for a travel note"))}constructor(e){this.#noteDialog=e}destructor(){this.#noteDialog=null}handleEvent(e){e.stopPropagation();let t=Je.getIconData(e.target.selectedIndex);"SvgIcon"!==t.icon?this.#updatePreviewAndControls({iconContent:t.icon,iconHeight:t.height,iconWidth:t.width,tooltipContent:t.tooltip}):this.#onMapIcon()}}class it{#noteDialog=null;constructor(e){this.#noteDialog=e}destructor(){this.#noteDialog=null}handleEvent(e){e.target.textContent="▼"===e.target.textContent?"▶":"▼",this.#noteDialog.toogleContents()}}class rt{#noteDialogToolbar=null;constructor(e){this.#noteDialogToolbar=e}handleEvent(e){e.stopPropagation();let t=new FileReader;t.onload=()=>{let e={};try{e=JSON.parse(t.result),Je.loadJson(e),this.#noteDialogToolbar.update()}catch(e){e instanceof Error&&console.error(e)}},t.readAsText(e.target.files[0])}}class lt{#noteDialogToolbar=null;constructor(e){this.#noteDialogToolbar=e}destructor(){this.#noteDialogToolbar=null}handleEvent(e){e.stopPropagation(),P.openFile(new rt(this.#noteDialogToolbar),".json")}}class dt{#noteDialog=null;#rootHTMLElement=null;#iconSelect=null;#toogleContentsButton=null;#openFileButton=null;#editionButtons=[];#eventListeners={onEditionButtonClick:null,onIconSelectChange:null,onToogleContentsButtonClick:null,onOpenFileButtonClick:null};#addIconsSelector(){this.#iconSelect=Z.create("select",{className:"TravelNotes-NoteDialog-Select",id:"TravelNotes-NoteDialog-IconSelect"},this.#rootHTMLElement),this.#iconSelect.addEventListener("change",this.#eventListeners.onIconSelectChange,!1),Je.icons.forEach((e=>{this.#iconSelect.add(Z.create("option",{text:e[0]}))})),this.#iconSelect.selectedIndex=m}#addToolbarButtons(){this.#toogleContentsButton=Z.create("div",{className:"TravelNotes-BaseDialog-Button",title:M.getText("NoteDialog - show hidden contents"),textContent:"▼"},this.#rootHTMLElement),this.#toogleContentsButton.addEventListener("click",this.#eventListeners.onToogleContentsButtonClick,!1),this.#openFileButton=Z.create("div",{className:"TravelNotes-BaseDialog-Button",title:M.getText("NoteDialog - Open a configuration file"),textContent:"📂"},this.#rootHTMLElement),this.#openFileButton.addEventListener("click",this.#eventListeners.onOpenFileButtonClick,!1)}#addEditionButtons(){Je.buttons.forEach((e=>{let t=Z.create("div",{dataset:{HtmlBefore:e.htmlBefore||"",HtmlAfter:e.htmlAfter||""},className:"TravelNotes-NoteDialog-EditorButton"},this.#rootHTMLElement);x.sanitizeToHtmlElement(e.title||"?",t),t.addEventListener("click",this.#eventListeners.onEditionButtonClick,!1),this.#editionButtons.push(t)}))}#addToolbarElements(){this.#addIconsSelector(),this.#addToolbarButtons(),this.#addEditionButtons()}#removeEventListeners(){this.#iconSelect.removeEventListener("change",this.#eventListeners.onIconSelectChange,!1),this.#toogleContentsButton.removeEventListener("click",this.#eventListeners.onToogleContentsButtonClick,!1),this.#openFileButton.removeEventListener("click",this.#eventListeners.onOpenFileButtonClick,!1),this.#editionButtons.forEach((e=>{e.removeEventListener("click",this.#eventListeners.onEditionButtonClick,!1)}))}constructor(e){this.#noteDialog=e,this.#rootHTMLElement=Z.create("div",{id:"TravelNotes-NoteDialog-ToolbarDiv"}),this.#eventListeners.onIconSelectChange=new st(this.#noteDialog),this.#eventListeners.onToogleContentsButtonClick=new it(this.#noteDialog),this.#eventListeners.onOpenFileButtonClick=new lt(this),this.#eventListeners.onEditionButtonClick=new nt(this.#noteDialog),this.#addToolbarElements()}destructor(){this.#removeEventListeners(),this.#eventListeners.onEditionButtonClick.destructor(),this.#eventListeners.onIconSelectChange.destructor(),this.#eventListeners.onToogleContentsButtonClick.destructor(),this.#eventListeners.onOpenFileButtonClick.destructor(),this.#noteDialog=null}update(){this.#removeEventListeners(),this.#rootHTMLElement.textContent="",this.#editionButtons=[],this.#addToolbarElements()}get rootHTMLElement(){return this.#rootHTMLElement}}class ht{#nominatimStatusOk=!0;#queryDistance=Math.max(e.geoCoder.distances.hamlet,e.geoCoder.distances.village,e.geoCoder.distances.city,e.geoCoder.distances.town);#latLng=null;#overpassAPIDataLoader=null;#nominatimData=null;#mergeData(){let e=null;this.#overpassAPIDataLoader.city&&(e=this.#overpassAPIDataLoader.city,this.#overpassAPIDataLoader.place&&(e+=" ("+this.#overpassAPIDataLoader.place+")"),e||(e=this.#overpassAPIDataLoader.country));let t=null,o=null;return this.#nominatimData&&(t=this.#nominatimData.street,o=this.#nominatimData.nameDetails||"",e||(e=this.#nominatimData.country)),e=e||"",t=t||"",o=o||"",(t.includes(o)||e.includes(o))&&(o=""),Object.freeze({name:x.sanitizeToJsString(o),street:x.sanitizeToJsString(t),city:x.sanitizeToJsString(e),statusOk:this.#nominatimStatusOk})}#parseNominatimData(e){let t="";e.error?this.#nominatimStatusOk=!1:(e.address.house_number&&(t+=e.address.house_number+" "),e.address.road?t+=e.address.road+" ":e.address.pedestrian&&(t+=e.address.pedestrian+" "),this.#nominatimData={street:t,nameDetails:e.namedetails.name,country:e.address.country})}async#loadNominatimData(){let t=e.nominatim.url+"reverse?format=json&lat="+this.#latLng[0]+"&lon="+this.#latLng[1]+"&zoom=18&addressdetails=1&namedetails=1",o=e.nominatim.language;o&&"*"!==o&&(t+="&accept-language="+o);let a=new Headers;o&&"*"===o&&a.append("accept-language","");let n=await fetch(t,{headers:a});if(b===n.status&&n.ok){this.#nominatimStatusOk=this.#nominatimStatusOk&&!0;let e=await n.json();this.#parseNominatimData(e)}else this.#nominatimStatusOk=!1}#getOverpassQueries(){return["is_in("+this.#latLng[0]+","+this.#latLng[1]+')->.e;area.e[admin_level][boundary="administrative"];out;node(around:'+this.#queryDistance+","+this.#latLng[0]+","+this.#latLng[1]+")[place];out;"]}async#execGetAddress(){return this.#nominatimStatusOk=!0,this.#nominatimData=null,this.#overpassAPIDataLoader=new Qe({searchWays:!1,searchRelations:!1,setGeometry:!0}),await this.#overpassAPIDataLoader.loadData(this.#getOverpassQueries(),this.#latLng),await this.#loadNominatimData(),this.#mergeData()}async#exeGetAdressWithPromise(e,t){let o=await this.#execGetAddress();o.statusOk?e(o):t("An error occurs...")}constructor(){Object.freeze(this)}async getAddressAsync(e){return this.#latLng=e,this.#execGetAddress()}getAddressWithPromise(e){return this.#latLng=e,new Promise(((e,t)=>this.#exeGetAdressWithPromise(e,t)))}}class ct{#noteDialog=null;#onAddressUpdatedByGeoCoder(e){this.#noteDialog.hideWait();let t=e.street;""!==e.city&&(t+=' <span class="TravelNotes-NoteHtml-Address-City">'+e.city+"</span>"),this.#noteDialog.setControlsValues({address:t}),this.#noteDialog.updatePreview({address:t})}constructor(e){this.#noteDialog=e}destructor(){this.#noteDialog=null}setAddressWithGeoCoder(e){this.#noteDialog.showWait(),this.#noteDialog.hideError(),(new ht).getAddressWithPromise(e).then((e=>{this.#onAddressUpdatedByGeoCoder(e)})).catch((e=>{e&&console.error(e),this.#noteDialog.hideWait(),this.#noteDialog.showError(M.getText("Notedialog - an error occurs when searching the adress"))}))}}class ut{#noteDialog=null;#latLng=null;#geoCoderHelper=null;constructor(e,t){this.#noteDialog=e,this.#latLng=t,this.#geoCoderHelper=new ct(this.#noteDialog)}destructor(){this.#noteDialog=null,this.#geoCoderHelper.destructor()}handleEvent(e){e.stopPropagation(),this.#geoCoderHelper.setAddressWithGeoCoder(this.#latLng)}}class vt{#noteDialog=null;#disableFocusControl=!1;constructor(e,t){this.#noteDialog=e,this.#disableFocusControl=t}destructor(){this.#noteDialog=null}handleEvent(e){e.stopPropagation(),this.#disableFocusControl?this.#noteDialog.focusControl=null:this.#noteDialog.focusControl=e.target}}class pt{#noteDialog=null;constructor(e){this.#noteDialog=e}destructor(){this.#noteDialog=null}handleEvent(e){if(e.stopPropagation(),""===e.target.value)return;""===x.sanitizeToUrl(e.target.value).errorsString?this.#noteDialog.hideError():this.#noteDialog.showError(M.getText("NoteDialog - invalidUrl"))}}class mt{#noteDialog=null;constructor(e){this.#noteDialog=e}destructor(){this.#noteDialog=null}handleEvent(e){e.stopPropagation();let t={};t[e.target.dataset.tanName]=e.target.value,this.#noteDialog.updatePreview(t)}}class gt{#noteDialog=null;#iconDimsDiv=null;#iconWidthInput=null;#iconHeightInput=null;#eventListeners={onInputUpdated:null};constructor(e){this.#noteDialog=e,this.#iconDimsDiv=Z.create("div",{className:"TravelNotes-NoteDialog-DataDiv"}),Z.create("text",{value:M.getText("NoteDialog - Icon width")},this.#iconDimsDiv),this.#iconWidthInput=Z.create("input",{type:"number",className:"TravelNotes-NoteDialog-NumberInput",value:h.width,dataset:{Name:"iconWidth"}},this.#iconDimsDiv),Z.create("text",{value:M.getText("NoteDialog - Icon height")},this.#iconDimsDiv),this.#iconHeightInput=Z.create("input",{type:"number",className:"TravelNotes-NoteDialog-NumberInput",value:h.height,dataset:{Name:"iconHeight"}},this.#iconDimsDiv),this.#eventListeners.onInputUpdated=new mt(this.#noteDialog),this.#iconWidthInput.addEventListener("input",this.#eventListeners.onInputUpdated),this.#iconHeightInput.addEventListener("input",this.#eventListeners.onInputUpdated)}destructor(){this.#iconWidthInput.removeEventListener("input",this.#eventListeners.onInputUpdated),this.#iconHeightInput.removeEventListener("input",this.#eventListeners.onInputUpdated),this.#eventListeners.onInputUpdated.destructor(),this.#noteDialog=null}get HTMLElements(){return[this.#iconDimsDiv]}get iconWidth(){return Number.parseInt(this.#iconWidthInput.value)}set iconWidth(e){this.#iconWidthInput.value=e}get iconHeight(){return Number.parseInt(this.#iconHeightInput.value)}set iconHeight(e){this.#iconHeightInput.value=e}}class bt{#noteDialog=null;#iconDiv=null;#iconTextArea=null;#eventListeners={onFocusControl:null,onInputUpdated:null};constructor(t){this.#noteDialog=t,this.#iconDiv=Z.create("div",{className:"TravelNotes-NoteDialog-DataDiv",textContent:M.getText("NoteDialog - Icon content")}),this.#iconTextArea=Z.create("textarea",{className:"TravelNotes-NoteDialog-TextArea",placeholder:"?????",rows:e.noteDialog.areaHeight.icon,dataset:{Name:"iconContent"}},this.#iconDiv),this.#eventListeners.onFocusControl=new vt(this.#noteDialog,!1),this.#eventListeners.onInputUpdated=new mt(this.#noteDialog),this.#iconTextArea.addEventListener("focus",this.#eventListeners.onFocusControl),this.#iconTextArea.addEventListener("input",this.#eventListeners.onInputUpdated)}destructor(){this.#iconTextArea.removeEventListener("focus",this.#eventListeners.onFocusControl),this.#iconTextArea.removeEventListener("input",this.#eventListeners.onInputUpdated),this.#eventListeners.onFocusControl.destructor(),this.#eventListeners.onInputUpdated.destructor(),this.#noteDialog=null}get HTMLElements(){return[this.#iconDiv]}get iconContent(){return this.#iconTextArea.value}set iconContent(e){this.#iconTextArea.value=e}}class yt{#noteDialog=null;#tooltipDiv=null;#tooltipInput=null;#eventListeners={onFocusControl:null,onInputUpdated:null};constructor(e){this.#noteDialog=e,this.#tooltipDiv=Z.create("div",{className:"TravelNotes-NoteDialog-DataDiv",textContent:M.getText("NoteDialog - Tooltip content")}),this.#tooltipInput=Z.create("input",{type:"text",className:"TravelNotes-NoteDialog-InputText",dataset:{Name:"tooltipContent"}},this.#tooltipDiv),this.#eventListeners.onFocusControl=new vt(this.#noteDialog,!1),this.#eventListeners.onInputUpdated=new mt(this.#noteDialog),this.#tooltipInput.addEventListener("focus",this.#eventListeners.onFocusControl),this.#tooltipInput.addEventListener("input",this.#eventListeners.onInputUpdated)}destructor(){this.#tooltipInput.removeEventListener("focus",this.#eventListeners.onFocusControl),this.#tooltipInput.removeEventListener("input",this.#eventListeners.onInputUpdated),this.#eventListeners.onFocusControl.destructor(),this.#eventListeners.onInputUpdated.destructor(),this.#noteDialog=null}get HTMLElements(){return[this.#tooltipDiv]}get tooltipContent(){return this.#tooltipInput.value}set tooltipContent(e){this.#tooltipInput.value=e}}class It{#noteDialog=null;#popupDiv=null;#popupTextArea=null;#eventListeners={onFocusControl:null,onInputUpdated:null};constructor(t){this.#noteDialog=t,this.#popupDiv=Z.create("div",{className:"TravelNotes-NoteDialog-DataDiv",textContent:M.getText("NoteDialog - Text")}),this.#popupTextArea=Z.create("textarea",{className:"TravelNotes-NoteDialog-TextArea",rows:e.noteDialog.areaHeight.popupContent,dataset:{Name:"popupContent"}},this.#popupDiv),this.#eventListeners.onFocusControl=new vt(this.#noteDialog,!1),this.#eventListeners.onInputUpdated=new mt(this.#noteDialog),this.#popupTextArea.addEventListener("focus",this.#eventListeners.onFocusControl),this.#popupTextArea.addEventListener("input",this.#eventListeners.onInputUpdated)}destructor(){this.#popupTextArea.removeEventListener("focus",this.#eventListeners.onFocusControl),this.#popupTextArea.removeEventListener("input",this.#eventListeners.onInputUpdated),this.#eventListeners.onFocusControl.destructor(),this.#eventListeners.onInputUpdated.destructor(),this.#noteDialog=null}get HTMLElements(){return[this.#popupDiv]}get popupContent(){return this.#popupTextArea.value}set popupContent(e){this.#popupTextArea.value=e}}class wt{#noteDialog=null;#addressHeaderDiv=null;#addressInputDiv=null;#addressInput=null;#addressButton=null;#latLng=null;#eventListeners={onFocusControl:null,onInputUpdated:null,onAddressButtonClick:null};constructor(e,t){this.#noteDialog=e,this.#latLng=t,this.#addressHeaderDiv=Z.create("div",{className:"TravelNotes-NoteDialog-DataDiv"}),this.#addressButton=Z.create("div",{className:"TravelNotes-BaseDialog-Button",title:M.getText("NoteDialog - Reset address"),textContent:"🔄"},this.#addressHeaderDiv),Z.create("text",{value:M.getText("NoteDialog - Address")},this.#addressHeaderDiv),this.#addressInputDiv=Z.create("div",{className:"TravelNotes-NoteDialog-DataDiv"}),this.#addressInput=Z.create("input",{type:"text",className:"TravelNotes-NoteDialog-InputText",dataset:{Name:"address"}},this.#addressInputDiv),this.#eventListeners.onFocusControl=new vt(this.#noteDialog,!1),this.#eventListeners.onInputUpdated=new mt(this.#noteDialog),this.#eventListeners.onAddressButtonClick=new ut(this.#noteDialog,this.#latLng),this.#addressInput.addEventListener("focus",this.#eventListeners.onFocusControl),this.#addressInput.addEventListener("input",this.#eventListeners.onInputUpdated),this.#addressButton.addEventListener("click",this.#eventListeners.onAddressButtonClick)}destructor(){this.#addressInput.removeEventListener("focus",this.#eventListeners.onFocusControl),this.#addressInput.removeEventListener("input",this.#eventListeners.onInputUpdated),this.#addressButton.removeEventListener("click",this.#eventListeners.onAddressButtonClick),this.#eventListeners.onFocusControl.destructor(),this.#eventListeners.onInputUpdated.destructor(),this.#eventListeners.onAddressButtonClick.destructor()}get HTMLElements(){return[this.#addressHeaderDiv,this.#addressInputDiv]}get address(){return this.#addressInput.value}set address(e){this.#addressInput.value=e}}class Lt{#noteDialog=null;#linkHeaderDiv=null;#linkInputDiv=null;#linkInput=null;#eventListeners={onFocusControl:null,onInputUpdated:null,onBlurUrlInput:null};#createTheDevilButton(t){e.noteDialog.theDevil.addButton&&Z.create("text",{value:"👿"},Z.create("a",{href:"https://www.google.com/maps/@"+t[0].toFixed(r.fixed)+","+t[1].toFixed(r.fixed)+","+e.noteDialog.theDevil.zoomFactor+"z",target:"_blank",title:"Reminder! The devil will know everything about you"},Z.create("div",{className:"TravelNotes-BaseDialog-Button",title:"Reminder! The devil will know everything about you"},this.#linkHeaderDiv)))}constructor(e,t){this.#noteDialog=e,this.#linkHeaderDiv=Z.create("div",{className:"TravelNotes-NoteDialog-DataDiv"}),this.#createTheDevilButton(t),Z.create("text",{value:M.getText("NoteDialog - Link")},this.#linkHeaderDiv),this.#linkInputDiv=Z.create("div",{className:"TravelNotes-NoteDialog-DataDiv"}),this.#linkInput=Z.create("input",{type:"text",className:"TravelNotes-NoteDialog-InputText",dataset:{Name:"url"}},this.#linkInputDiv),this.#eventListeners.onFocusControl=new vt(this.#noteDialog,!0),this.#eventListeners.onInputUpdated=new mt(this.#noteDialog),this.#eventListeners.onBlurUrlInput=new pt(this.#noteDialog),this.#linkInput.addEventListener("focus",this.#eventListeners.onFocusControl),this.#linkInput.addEventListener("input",this.#eventListeners.onInputUpdated),this.#linkInput.addEventListener("blur",this.#eventListeners.onBlurUrlInput)}destructor(){this.#linkInput.removeEventListener("focus",this.#eventListeners.onFocusControl),this.#linkInput.removeEventListener("input",this.#eventListeners.onInputUpdated),this.#linkInput.removeEventListener("blur",this.#eventListeners.onBlurUrlInput),this.#eventListeners.onFocusControl.destructor(),this.#eventListeners.onInputUpdated.destructor(),this.#eventListeners.onBlurUrlInput.destructor(),this.#noteDialog=null}get HTMLElements(){return[this.#linkHeaderDiv,this.#linkInputDiv]}get url(){return this.#linkInput.value}set url(e){this.#linkInput.value=e}}class Tt{#noteDialog=null;#phoneHeaderDiv=null;#phoneInputDiv=null;#phoneInput=null;#eventListeners={onFocusControl:null,onInputUpdated:null};constructor(e){this.#noteDialog=e,this.#phoneHeaderDiv=Z.create("div",{className:"TravelNotes-NoteDialog-DataDiv"}),Z.create("text",{value:" "+M.getText("NoteDialog - Phone")},this.#phoneHeaderDiv),this.#phoneInputDiv=Z.create("div",{className:"TravelNotes-NoteDialog-DataDiv"}),this.#phoneInput=Z.create("input",{type:"text",className:"TravelNotes-NoteDialog-InputText",dataset:{Name:"phone"}},this.#phoneInputDiv),this.#eventListeners.onFocusControl=new vt(this.#noteDialog,!1),this.#eventListeners.onInputUpdated=new mt(this.#noteDialog),this.#phoneInput.addEventListener("focus",this.#eventListeners.onFocusControl),this.#phoneInput.addEventListener("input",this.#eventListeners.onInputUpdated)}destructor(){this.#phoneInput.removeEventListener("focus",this.#eventListeners.onFocusControl),this.#phoneInput.removeEventListener("input",this.#eventListeners.onInputUpdated),this.#eventListeners.onFocusControl.destructor(),this.#eventListeners.onInputUpdated.destructor(),this.#noteDialog=null}get HTMLElements(){return[this.#phoneHeaderDiv,this.#phoneInputDiv]}get phone(){return this.#phoneInput.value}set phone(e){this.#phoneInput.value=e}}class Dt{#previewNote=null;#previewDiv=null;constructor(e){this.#previewNote=e,this.#previewDiv=Z.create("div",{className:"TravelNotes-NoteDialog-PreviewDiv"}),this.#previewDiv.appendChild(Ue.getNoteTextAndIconHTML("TravelNotes-NoteDialog-",{note:this.#previewNote,route:null}))}update(){this.#previewDiv.textContent="",this.#previewDiv.appendChild(Ue.getNoteTextAndIconHTML("TravelNotes-NoteDialog-",{note:this.#previewNote,route:null}))}get HTMLElements(){return[this.#previewDiv]}}class ft extends re{#note=null;#startGeoCoder=!1;#routeObjId=null;#previewNote=null;#iconDimsControl=null;#iconControl=null;#tooltipControl=null;#popupControl=null;#addressControl=null;#linkControl=null;#phoneControl=null;#previewControl=null;#toolbar=null;#focusControl=null;constructor(e,t,o){super(),this.#note=e,this.#startGeoCoder=o,this.#routeObjId=t,this.#previewNote=new U,this.#previewNote.jsonObject=e.jsonObject,this.#toolbar=new dt(this),this.#iconDimsControl=new gt(this),this.#iconControl=new bt(this),this.#tooltipControl=new yt(this),this.#popupControl=new It(this),this.#addressControl=new wt(this,e.latLng,o),this.#linkControl=new Lt(this,e.latLng),this.#phoneControl=new Tt(this),this.#previewControl=new Dt(this.#previewNote),this.setControlsValues(e)}#destructor(){this.#toolbar.destructor(),this.#iconDimsControl.destructor(),this.#iconControl.destructor(),this.#tooltipControl.destructor(),this.#popupControl.destructor(),this.#addressControl.destructor(),this.#linkControl.destructor(),this.#phoneControl.destructor()}set focusControl(e){this.#focusControl=e}get focusControl(){return this.#focusControl}get mapIconData(){return Object.freeze({latLng:this.#previewNote.latLng,routeObjId:this.#routeObjId})}updatePreview(e){for(const t in e)this.#previewNote[t]=e[t];this.#previewControl.update()}onShow(){this.#startGeoCoder&&new ct(this).setAddressWithGeoCoder(this.#previewNote.latLng),this.toogleContents()}canClose(){return""===this.#iconControl.iconContent?(this.showError(M.getText("Notedialog - The icon content cannot be empty")),!1):""!==this.#linkControl.url&&""===x.sanitizeToUrl(this.#linkControl.url).url?(this.showError(M.getText("NoteDialog - invalidUrl")),!1):(this.getControlsValues(this.#note),this.#note.latLng=this.#previewNote.latLng,this.#note.validateData(),!0)}onCancel(){this.#destructor(),super.onCancel()}onOk(){this.#destructor(),super.onOk()}get title(){return M.getText("NoteDialog - Note")}get contentHTMLElements(){return[].concat(this.#toolbar.rootHTMLElement,this.#iconDimsControl.HTMLElements,this.#iconControl.HTMLElements,this.#tooltipControl.HTMLElements,this.#popupControl.HTMLElements,this.#addressControl.HTMLElements,this.#linkControl.HTMLElements,this.#phoneControl.HTMLElements)}get footerHTMLElements(){return this.#previewControl.HTMLElements}setControlsValues(e){this.#iconDimsControl.iconHeight=e.iconHeight||this.#iconDimsControl.iconHeight,this.#iconDimsControl.iconWidth=e.iconWidth||this.#iconDimsControl.iconWidth,this.#iconControl.iconContent=e.iconContent||this.#iconControl.iconContent,this.#tooltipControl.tooltipContent=e.tooltipContent||this.#tooltipControl.tooltipContent,this.#popupControl.popupContent=e.popupContent||this.#popupControl.popupContent,this.#addressControl.address=e.address||this.#addressControl.address,this.#linkControl.url=e.url||this.#linkControl.url,this.#phoneControl.phone=e.phone||this.#phoneControl.phone}getControlsValues(e){e.iconWidth=this.#iconDimsControl.iconHeight,e.iconHeight=this.#iconDimsControl.iconWidth,e.iconContent=this.#iconControl.iconContent,e.tooltipContent=this.#tooltipControl.tooltipContent,e.popupContent=this.#popupControl.popupContent,e.address=this.#addressControl.address,e.url=this.#linkControl.url,e.phone=this.#phoneControl.phone}toogleContents(){e.noteDialog.mask.iconsDimension&&this.#iconDimsControl.HTMLElements[0].classList.toggle("TravelNotes-Hidden"),e.noteDialog.mask.iconTextArea&&this.#iconControl.HTMLElements[0].classList.toggle("TravelNotes-Hidden"),e.noteDialog.mask.popupContent&&this.#popupControl.HTMLElements[0].classList.toggle("TravelNotes-Hidden"),e.noteDialog.mask.tooltip&&this.#tooltipControl.HTMLElements[0].classList.toggle("TravelNotes-Hidden"),e.noteDialog.mask.address&&(this.#addressControl.HTMLElements[0].classList.toggle("TravelNotes-Hidden"),this.#addressControl.HTMLElements[1].classList.toggle("TravelNotes-Hidden")),e.noteDialog.mask.link&&(this.#linkControl.HTMLElements[0].classList.toggle("TravelNotes-Hidden"),this.#linkControl.HTMLElements[1].classList.toggle("TravelNotes-Hidden")),e.noteDialog.mask.phone&&(this.#phoneControl.HTMLElements[0].classList.toggle("TravelNotes-Hidden"),this.#phoneControl.HTMLElements[1].classList.toggle("TravelNotes-Hidden"))}}class Et{#backgroundDiv=null;#messageDiv=null;constructor(){Object.freeze(this)}createUI(){if(document.getElementById("TravelNotes-WaitUI"))return;this.#backgroundDiv=Z.create("div",{className:"TravelNotes-Background"},document.body);let e=Z.create("div",{id:"TravelNotes-WaitUI"},this.#backgroundDiv);this.#messageDiv=Z.create("div",{id:"TravelNotes-WaitUI-MessageDiv"},e),Z.create("div",{className:"TravelNotes-WaitAnimationBullet"},Z.create("div",{className:"TravelNotes-WaitAnimation"},e))}showInfo(e){this.#messageDiv.textContent=e}close(){document.body.removeChild(this.#backgroundDiv),this.#backgroundDiv=null}}const Nt=new class{#waitUI=null;#showSearchNoteDialog=null;#maneuverCounter=0;#addNote(e,t,o){if(o)if(p===t)W.travel.notes.add(e),xe.dispatch("showtravelnotes");else{let o=_.getRoute(t);o.notes.add(e),e.chainedDistance=o.chainedDistance,o.notes.sort(((e,t)=>e.distance-t.distance)),xe.dispatch("showitinerary")}else p===t?xe.dispatch("updatetravelnotes"):xe.dispatch("updateitinerary");xe.dispatch("noteupdated",{removedNoteObjId:e.objId,addedNoteObjId:e.objId}),xe.dispatch("roadbookupdate")}#noteDialog(e,t,o){new ft(e,t,o).show().then((()=>this.#addNote(e,t,o))).catch((e=>{console.error(e)}))}#newNote(e){let t=new U;return t.latLng=e,t.iconLatLng=e,t}constructor(){Object.freeze(this)}get osmSearchNoteDialog(){return null===this.#showSearchNoteDialog&&(this.#showSearchNoteDialog=e.osmSearch.showSearchNoteDialog),this.#showSearchNoteDialog}changeOsmSearchNoteDialog(){this.#showSearchNoteDialog=!this.osmSearchNoteDialog}newRouteNote(e){let t=_.getRoute(e.routeObjId),o=G.getClosestLatLngDistance(t,[e.lat,e.lng]),a=this.#newNote(o.latLng);a.distance=o.distance,this.#noteDialog(a,t.objId,!0)}async newSearchNote(e){let t=p,o=new U;if(e.isTravelNote)o.latLng=[e.osmElement.lat,e.osmElement.lon];else{let a=_.getNearestRouteData([e.osmElement.lat,e.osmElement.lon]);if(!a.route)return void Me.showError(M.getText("NoteEditor - No route was found"));o.latLng=a.latLngOnRoute,o.distance=a.distanceOnRoute,t=a.route.objId}if(o.iconLatLng=[e.osmElement.lat,e.osmElement.lon],o.iconHeight=h.height,o.iconWidth=h.width,e.osmElement.tags.rcn_ref?o.iconContent="<div class='TravelNotes-MapNote TravelNotes-MapNoteCategory-0073'><svg viewBox='0 0 20 20'><text x='10' y='14'>"+e.osmElement.tags.rcn_ref+"</text></svg></div>":o.iconContent=Je.getIconContentFromName(e.osmElement.description),o.url=e.osmElement.tags.website||"",o.phone=e.osmElement.tags.phone||"",o.tooltipContent=e.osmElement.description||"",o.popupContent=e.osmElement.tags.name||"",e.osmElement.tags["addr:street"]&&e.osmElement.tags["addr:city"])o.address=(e.osmElement.tags["addr:housenumber"]?e.osmElement.tags["addr:housenumber"]+" ":"")+e.osmElement.tags["addr:street"]+' <span class="TravelNotes-NoteHtml-Address-City">'+e.osmElement.tags["addr:city"]+"</span>";else{this.#waitUI=new Et,this.#waitUI.createUI(),this.#waitUI.showInfo("Creating address");let t=null;try{t=await(new ht).getAddressAsync([e.osmElement.lat,e.osmElement.lon])}catch(e){console.error(e)}this.#waitUI.close(),t.statusOk&&(o.address=t.street,""!==t.city&&(o.address+=' <span class="TravelNotes-NoteHtml-Address-City">'+t.city+"</span>"))}this.osmSearchNoteDialog||""===o.iconContent?this.#noteDialog(o,t,!0):this.#addNote(o,t,!0)}newTravelNote(e){let t=this.#newNote(e);this.#noteDialog(t,p,!0)}editNote(e){let t=_.getNoteAndRoute(e),o=null===t.route?p:t.route.objId;this.#noteDialog(t.note,o,!1)}removeNote(e){let t=_.getNoteAndRoute(e);t.route?(t.route.notes.remove(e),xe.dispatch("updateitinerary")):(W.travel.notes.remove(e),xe.dispatch("updatetravelnotes")),xe.dispatch("noteupdated",{removedNoteObjId:e,addedNoteObjId:p}),xe.dispatch("roadbookupdate")}hideNotes(){let e=W.travel.notes.iterator;for(;!e.done;)xe.dispatch("removeobject",{objId:e.value.objId});let t=W.travel.routes.iterator;for(;!t.done;)for(e=t.value.notes.iterator;!e.done;)xe.dispatch("removeobject",{objId:e.value.objId});if(p!==W.editedRouteObjId)for(e=W.travel.editedRoute.notes.iterator;!e.done;)xe.dispatch("removeobject",{objId:e.value.objId})}showNotes(){this.hideNotes();let e=W.travel.notes.iterator;for(;!e.done;)xe.dispatch("noteupdated",{removedNoteObjId:p,addedNoteObjId:e.value.objId});let t=W.travel.routes.iterator;for(;!t.done;)t.value.hidden||xe.dispatch("routeupdated",{removedRouteObjId:t.value.objId,addedRouteObjId:t.value.objId})}attachNoteToRoute(e){let t=_.getNoteAndRoute(e).note,o=_.getNearestRouteData(t.latLng);o.route&&(W.travel.notes.remove(e),t.distance=o.distance,t.latLng=o.latLngOnRoute,t.chainedDistance=o.route.chainedDistance,o.route.notes.add(t),o.route.notes.sort(((e,t)=>e.distance-t.distance)),xe.dispatch("noteupdated",{removedNoteObjId:e,addedNoteObjId:e}),xe.dispatch("updateitinerary"),xe.dispatch("updatetravelnotes"),xe.dispatch("roadbookupdate"))}detachNoteFromRoute(e){let t=_.getNoteAndRoute(e);t.route.notes.remove(e),t.note.distance=a.invalid,t.note.chainedDistance=a.defaultValue,W.travel.notes.add(t.note),xe.dispatch("updateitinerary"),xe.dispatch("updatetravelnotes"),xe.dispatch("roadbookupdate")}travelNoteDropped(e,t,o){W.travel.notes.moveTo(e,t,o),xe.dispatch("updatetravelnotes"),xe.dispatch("roadbookupdate")}};class xt{#myGpxString="";#timeStamp="";#route=null;#addHeader(){this.#myGpxString='<?xml version="1.0"?>\n',this.#myGpxString+='<gpx xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd" version="1.1" creator="leaflet.TravelNotes">'}#addWayPoints(){let e=this.#route.wayPoints.iterator;for(;!e.done;)this.#myGpxString+='\n\t<wpt lat="'+e.value.lat+'" lon="'+e.value.lng+'" '+this.#timeStamp+"/>"}#addRoute(){this.#myGpxString+="\n\t<rte>";let e=this.#route.itinerary.maneuvers.iterator;for(;!e.done;){let t=this.#route.itinerary.itineraryPoints.getAt(e.value.itineraryPointObjId),o=e.value.instruction.replaceAll(/\u0027/g,"&apos;").replaceAll(/"/g,"&quot;").replaceAll(/</g,"&lt;").replaceAll(/>/g,"&gt;");this.#myGpxString+='\n\t\t<rtept lat="'+t.lat+'" lon="'+t.lng+'" '+this.#timeStamp+'desc="'+o+'" />'}this.#myGpxString+="\n\t</rte>"}#addTrack(){this.#myGpxString+="\n\t<trk>",this.#myGpxString+="\n\t\t<trkseg>";let e=this.#route.itinerary.itineraryPoints.iterator;for(;!e.done;)this.#myGpxString+='\n\t\t\t<trkpt lat="'+e.value.lat+'" lon="'+e.value.lng+'" '+this.#timeStamp+" />";this.#myGpxString+="\n\t\t</trkseg>",this.#myGpxString+="\n\t</trk>"}#addFooter(){this.#myGpxString+="\n</gpx>"}#saveGpxToFile(){let e=(""===W.travel.name?"":W.travel.name+" - ")+this.#route.computedName;""===e&&(e="TravelNote"),e+=".gpx",P.saveFile(e,this.#myGpxString)}constructor(){Object.freeze(this)}routeToGpx(e){this.#route=_.getRoute(e),this.#route&&(this.#timeStamp='time="'+(new Date).toISOString()+'" ',this.#addHeader(),this.#addWayPoints(),this.#addRoute(),this.#addTrack(),this.#addFooter(),this.#saveGpxToFile())}}class Mt{#red=t.maxColorValue;#green=t.maxColorValue;#blue=t.maxColorValue;constructor(e,o,a){this.#red="number"==typeof e&&t.maxColorValue>=e&&t.minColorValue<=e?e:t.maxColorValue,this.#green="number"==typeof o&&t.maxColorValue>=o&&t.minColorValue<=o?o:t.maxColorValue,this.#blue="number"==typeof a&&t.maxColorValue>=a&&t.minColorValue<=a?a:t.maxColorValue,Object.seal(this)}get red(){return this.#red}set red(e){"number"==typeof e&&t.maxColorValue>=e&&t.minColorValue<=e&&(this.#red=e)}get green(){return this.#green}set green(e){"number"==typeof e&&t.maxColorValue>=e&&t.minColorValue<=e&&(this.#green=e)}get blue(){return this.#blue}set blue(e){"number"==typeof e&&t.maxColorValue>=e&&t.minColorValue<=e&&(this.#blue=e)}get cssColor(){return"#"+this.#red.toString(g).padStart(2,"0")+this.#green.toString(g).padStart(2,"0")+this.#blue.toString(g).padStart(2,"0")}set cssColor(e){"#"===e[0]?(this.#red=Number.parseInt(e.substr(1,2),g),this.#green=Number.parseInt(e.substr(3,2),g),this.#blue=Number.parseInt(e.substr(5,2),g)):"rgb"===e.substr(0,3)&&([this.#red,this.#green,this.#blue]=Array.from(e.match(/[0-9]{1,3}/g),(e=>Number.parseInt(e))))}clone(){return new Mt(this.#red,this.#green,this.#blue)}copyTo(e){e.red=this.#red,e.green=this.#green,e.blue=this.#blue}}class Pt{#redSlider=null;#colorButtons=null;constructor(e,t){this.#redSlider=e,this.#colorButtons=t}destructor(){this.#redSlider=null,this.#colorButtons=null}handleEvent(e){e.stopPropagation();let o=new Mt;o.red=Math.ceil(e.target.valueAsNumber*(t.maxColorValue/t.sliderMaxValue));for(let e=0;e<t.rowsNumber;++e){o.blue=e*t.deltaColor;for(let a=0;a<t.rowsNumber;++a)o.green=a*t.deltaColor,this.#colorButtons[t.rowsNumber*e+a].style["background-color"]=o.cssColor}}}class Ct{#colorControl=null;#inputs=null;constructor(e,t){this.#colorControl=e,this.#inputs=t}destructor(){this.#colorControl=null,this.#inputs=null}handleEvent(e){e.stopPropagation();let t=new Mt(Number.parseInt(this.#inputs.red.value),Number.parseInt(this.#inputs.green.value),Number.parseInt(this.#inputs.blue.value));this.#colorControl.color=t}}class jt{#colorControl=null;constructor(e){this.#colorControl=e}destructor(){this.#colorControl=null}handleEvent(e){e.stopPropagation();let t=new Mt;t.cssColor=e.target.style["background-color"],this.#colorControl.color=t}}class At{#colorDiv=null;#colorButtons=[];#inputs={red:null,green:null,blue:null};#redSliderInput=null;#rgbDiv=null;#colorSampleDiv=null;#newColor=new Mt;#eventListeners={onColorButtonClick:null,onColorInput:null,onRedSliderInput:null};#createColorButtonsDiv(){let e=Z.create("div",null,this.#colorDiv),o=new Mt(t.initialRed,t.minColorValue,t.minColorValue);this.#eventListeners.onColorButtonClick=new jt(this);for(let a=0;a<t.rowsNumber;++a){let a=Z.create("div",null,e);o.green=t.minColorValue;for(let e=0;e<t.cellsNumber;++e){let e=Z.create("div",{className:"TravelNotes-ColorControl-CellColorDiv"},a);e.style["background-color"]=o.cssColor,e.addEventListener("click",this.#eventListeners.onColorButtonClick,!1),o.green+=t.deltaColor,this.#colorButtons.push(e)}o.blue+=t.deltaColor}}#createRedSliderDiv(){let e=Z.create("div",null,this.#colorDiv);this.#redSliderInput=Z.create("input",{type:"range",value:Math.ceil(t.initialRed*(t.sliderMaxValue/t.maxColorValue)),min:0,max:t.sliderMaxValue,step:t.sliderStep},e),this.#eventListeners.onRedSliderInput=new Pt(this.#redSliderInput,this.#colorButtons),this.#redSliderInput.addEventListener("input",this.#eventListeners.onRedSliderInput,!1),this.#redSliderInput.focus()}#createColorInput(e,o){Z.create("text",{value:e},this.#rgbDiv);let a=Z.create("input",{type:"number",className:"TravelNotes-ColorControl-NumberInput",value:o,min:t.minColorValue,max:t.maxColorValue},this.#rgbDiv);return a.addEventListener("input",this.#eventListeners.onColorInput,!1),a}#createColorInputsDiv(){this.#rgbDiv=Z.create("div",null,this.#colorDiv),this.#eventListeners.onColorInput=new Ct(this,this.#inputs),this.#inputs.red=this.#createColorInput(M.getText("ColorControl - Red"),this.#newColor.red),this.#inputs.green=this.#createColorInput(M.getText("ColorControl - Green"),this.#newColor.green),this.#inputs.blue=this.#createColorInput(M.getText("ColorControl - Blue"),this.#newColor.blue)}#createColorSampleDiv(){this.#colorSampleDiv=Z.create("div",{id:"TravelNotes-ColorControl-ColorSampleDiv"},this.#colorDiv),this.#colorSampleDiv.style["background-color"]=this.#newColor.cssColor}constructor(e){this.#newColor.cssColor=e,this.#colorDiv=Z.create("div",{id:"TravelNotes-ColorControl-ColorDiv"}),this.#createColorButtonsDiv(),this.#createRedSliderDiv(),this.#createColorInputsDiv(),this.#createColorSampleDiv()}destructor(){this.#colorButtons.forEach((e=>{e.removeEventListener("click",this.#eventListeners.onColorButtonClick,!1)})),this.#eventListeners.onColorButtonClick.destructor();for(const e in this.#inputs)this.#inputs[e].removeEventListener("input",this.#eventListeners.onColorInput,!1);this.#eventListeners.onColorInput.destructor(),this.#redSliderInput.removeEventListener("input",this.#eventListeners.onRedSliderInput,!1),this.#eventListeners.onRedSliderInput.destructor()}get HTMLElements(){return[this.#colorDiv]}get cssColor(){return this.#newColor.cssColor}set color(e){this.#inputs.red.value=e.red,this.#inputs.green.value=e.green,this.#inputs.blue.value=e.blue,this.#colorSampleDiv.style["background-color"]=e.cssColor,e.copyTo(this.#newColor)}}class Ot extends re{#route=null;#colorControl=null;#nameInput=null;#widthInput=null;#dashSelect=null;#chainInput=null;#createNameDiv(){let e=Z.create("div",{textContent:M.getText("RoutePropertiesDialog - Name")}),t=Z.create("div",{className:"TravelNotes-RoutePropertiesDialog-DataDiv",id:"TravelNotes-RoutePropertiesDialog-NameInputDiv"});return this.#nameInput=Z.create("input",{type:"text",id:"TravelNotes-RoutePropertiesDialog-NameInput",value:this.#route.computedName},t),[e,t]}#createWidthDiv(){let e=Z.create("div",{className:"TravelNotes-RoutePropertiesDialog-DataDiv"});return Z.create("text",{value:M.getText("RoutePropertiesDialog - Width")},Z.create("span",null,e)),this.#widthInput=Z.create("input",{type:"number",id:"TravelNotes-RoutePropertiesDialog-WidthInput",value:this.#route.width,min:1,max:40},e),e}#createDashDiv(){let t=Z.create("div",{className:"TravelNotes-RoutePropertiesDialog-DataDiv"});Z.create("text",{value:M.getText("RoutePropertiesDialog - Linetype")},Z.create("span",null,t)),this.#dashSelect=Z.create("select",null,t);let o=e.route.dashChoices;for(let e=0;e<o.length;e++)this.#dashSelect.add(Z.create("option",{text:o[e].text}));return this.#dashSelect.selectedIndex=this.#route.dashArray<o.length?this.#route.dashArray:0,t}#createChainDiv(){let e=Z.create("div",{className:"TravelNotes-RoutePropertiesDialog-DataDiv",id:"TravelNotes-RoutePropertiesDialog-ChainDiv"});return Z.create("text",{value:M.getText("RoutePropertiesDialog - Chained route")},Z.create("span",null,e)),this.#chainInput=Z.create("input",{type:"checkbox",checked:this.#route.chain},e),e}#createColorHeaderDiv(){return Z.create("div",{textContent:M.getText("RoutePropertiesDialog - Color"),id:"TravelNotes-RoutePropertiesDialog-ColorHeaderDiv"})}constructor(e){super(),this.#route=e,this.#colorControl=new At(e.color)}onCancel(){this.#colorControl.destructor(),super.onCancel()}onOk(){this.#route.color=this.#colorControl.cssColor,this.#route.computedName!==this.#nameInput.value&&(this.#route.name=this.#nameInput.value),this.#route.width=parseInt(this.#widthInput.value),this.#route.chain=this.#chainInput.checked,this.#route.dashArray=this.#dashSelect.selectedIndex,this.#route.validateData(),this.#colorControl.destructor(),super.onOk()}get title(){return M.getText("RoutePropertiesDialog - Route properties")}get contentHTMLElements(){return[].concat(this.#createNameDiv(),this.#createWidthDiv(),this.#createDashDiv(),this.#createChainDiv(),this.#createColorHeaderDiv(),this.#colorControl.HTMLElements)}}class St extends re{#paperWidthInput=null;#paperHeightInput=null;#borderWidthInput=null;#pageBreakInput=null;#printNotesInput=null;#zoomFactorInput=null;#createPaperWidthDiv(){let t=Z.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv"});return Z.create("text",{value:M.getText("PrintRouteMapDialog - Paper width")},t),this.#paperWidthInput=Z.create("input",{type:"number",className:"TravelNotes-PrintRouteMapDialog-NumberInput"},t),this.#paperWidthInput.value=e.printRouteMap.paperWidth,Z.create("text",{value:M.getText("PrintRouteMapDialog - Paper width units")},t),t}#createPaperHeightDiv(){let t=Z.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv"});return Z.create("text",{value:M.getText("PrintRouteMapDialog - Paper height")},t),this.#paperHeightInput=Z.create("input",{type:"number",className:"TravelNotes-PrintRouteMapDialog-NumberInput",value:e.printRouteMap.paperHeight},t),Z.create("text",{value:M.getText("PrintRouteMapDialog - Paper height units")},t),t}#createBorderWidthDiv(){let t=Z.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv"});return Z.create("text",{value:M.getText("PrintRouteMapDialog - Border width")},t),this.#borderWidthInput=Z.create("input",{type:"number",className:"TravelNotes-PrintRouteMapDialog-NumberInput",value:e.printRouteMap.borderWidth},t),Z.create("text",{value:M.getText("PrintRouteMapDialog - Border width units")},t),t}#createZoomFactorDiv(){let t=Z.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv"});return Z.create("text",{value:M.getText("PrintRouteMapDialog - Zoom factor")},t),this.#zoomFactorInput=Z.create("input",{type:"number",className:"TravelNotes-PrintRouteMapDialog-NumberInput",value:Math.min(e.printRouteMap.zoomFactor,15),min:W.map.getMinZoom(),max:Math.min(W.map.getMaxZoom(),15)},t),t}#createPageBreakDiv(){let t=Z.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv"});return this.#pageBreakInput=Z.create("input",{type:"checkbox",checked:e.printRouteMap.pageBreak},t),Z.create("text",{value:M.getText("PrintRouteMapDialog - Page break")},t),t}#createPrintNotesDiv(){let t=Z.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv"});return this.#printNotesInput=Z.create("input",{type:"checkbox",checked:e.printRouteMap.printNotes},t),Z.create("text",{value:M.getText("PrintRouteMapDialog - Print notes")},t),t}constructor(){super()}onOk(){super.onOk(Object.freeze({paperWidth:parseInt(this.#paperWidthInput.value),paperHeight:parseInt(this.#paperHeightInput.value),borderWidth:parseInt(this.#borderWidthInput.value),zoomFactor:parseInt(this.#zoomFactorInput.value),pageBreak:this.#pageBreakInput.checked,printNotes:this.#printNotesInput.checked}))}get contentHTMLElements(){return[this.#createPaperWidthDiv(),this.#createPaperHeightDiv(),this.#createBorderWidthDiv(),this.#createZoomFactorDiv(),this.#createPageBreakDiv(),this.#createPrintNotesDiv()]}get title(){return M.getText("PrintRouteMapDialog - Print")}}
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file FloatWindow.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/
class kt{#dragData=null;constructor(e){Object.seal(this),this.#dragData=e}handleEvent(e){this.#dragData.dragStartX=e.screenX,this.#dragData.dragStartY=e.screenY,e.dataTransfer.dropEffect="move",e.dataTransfer.effectAllowed="move"}}class Rt{#dragData=null;#containerDiv=null;constructor(e){Object.seal(this),this.#dragData=e}handleEvent(e){let t=e.target.parentNode;this.#dragData.windowX+=e.screenX-this.#dragData.dragStartX,this.#dragData.windowY+=e.screenY-this.#dragData.dragStartY,this.#dragData.windowX=Math.min(Math.max(this.#dragData.windowX,20),W.map.getContainer().clientWidth-t.clientWidth-20),this.#dragData.windowY=Math.max(this.#dragData.windowY,20);let o=W.map.getContainer().clientHeight-Math.max(this.#dragData.windowY,0)-20;t.style.top=String(this.#dragData.windowY)+"px",t.style.left=String(this.#dragData.windowX)+"px",t.style["max-height"]=String(o)+"px"}}class Ht{#geometry=[];#pushNoteGeometry(e){this.#geometry.push(e.latLng),this.#geometry.push(e.iconLatLng)}#pushRouteGeometry(e){e.itinerary.itineraryPoints.forEach((e=>this.#geometry.push(e.latLng))),e.notes.forEach((e=>this.#pushNoteGeometry(e)))}constructor(){Object.freeze(this)}zoomToLatLng(e){xe.dispatch("zoomto",{latLng:e})}zoomToManeuver(e){let t=W.travel.editedRoute.itinerary.maneuvers.getAt(e).itineraryPointObjId,o=W.travel.editedRoute.itinerary.itineraryPoints.getAt(t).latLng;xe.dispatch("zoomto",{latLng:o})}zoomToNote(e){this.#geometry=[],this.#pushNoteGeometry(_.getNoteAndRoute(e).note),xe.dispatch("zoomto",{geometry:[this.#geometry]})}zoomToRoute(e){this.#geometry=[],this.#pushRouteGeometry(_.getRoute(e)),xe.dispatch("zoomto",{geometry:[this.#geometry]})}zoomToTravel(){this.#geometry=[],W.travel.routes.forEach((e=>this.#pushRouteGeometry(e))),p!==W.travel.editedRouteObjId&&this.#pushRouteGeometry(W.travel.editedRoute),W.travel.notes.forEach((e=>this.#pushNoteGeometry(e))),xe.dispatch("zoomto",{geometry:[this.#geometry]})}zoomToPoi(e){xe.dispatch("zoomto",e)}}class Bt extends Ye{constructor(e,t=null){super(e,t)}doAction(e){switch(e){case 0:Nt.newRouteNote({routeObjId:this.eventData.targetObjId,lat:this.eventData.lat,lng:this.eventData.lng});break;case 1:(new Ht).zoomToLatLng([this.eventData.lat,this.eventData.lng])}}get menuItems(){return[{itemText:M.getText("ProfileContextMenu - Add a note to the route at this point"),isActive:!0},{itemText:M.getText("ProfileContextMenu - Zoom to this point"),isActive:!0}]}}
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file ProfileWindow.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/class Ut{getlatLngElevOnRouteAtMousePosition(e,t){let o=_.getRoute(Number.parseInt(t.dataset.tanObjId)),a=t.getBoundingClientRect(),n=(e.clientX-a.x-d.margin/(2*d.margin+d.width)*a.width)/(d.width/(2*d.margin+d.width)*a.width)*o.distance;return 0<n&&n<o.distance?G.getLatLngElevAtDist(o,n):null}}class Kt extends Ut{constructor(){super()}handleEvent(e){e.preventDefault(),e.stopPropagation();let t=e.target;for(;!t.dataset.tanObjId;)t=t.parentNode;let o=this.getlatLngElevOnRouteAtMousePosition(e,t);o&&(e.latlng={lat:o.latLng[0],lng:o.latLng[1]},new Bt(e).show())}}class Ft{handleEvent(e){e.preventDefault(),e.stopPropagation();let t=e.target;for(;!t.dataset.tanObjId;)t=t.parentNode;xe.dispatch("removeobject",{objId:Number.parseInt(t.dataset.tanMarkerObjId)})}}class zt extends Ut{constructor(){super()}#marker=null;#distanceText=null;#elevText=null;#ascentText=null;#textAnchor=null;#markerX=null;#profileSvg=null;#createSvgText(e,t){let o=document.createElementNS(y,"text");return o.appendChild(document.createTextNode(e)),o.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-elevText"),o.setAttributeNS(null,"x",this.#markerX),o.setAttributeNS(null,"y",t),o.setAttributeNS(null,"text-anchor",this.#textAnchor),this.#profileSvg.appendChild(o),o}handleEvent(e){for(e.preventDefault(),e.stopPropagation(),this.#profileSvg=e.target;!this.#profileSvg.dataset.tanObjId;)this.#profileSvg=this.#profileSvg.parentNode;let t=this.getlatLngElevOnRouteAtMousePosition(e,this.#profileSvg);if(t){let o=Number.parseInt(this.#profileSvg.dataset.tanMarkerObjId);xe.dispatch("removeobject",{objId:o}),xe.dispatch("additinerarypointmarker",{objId:o,latLng:t.latLng}),this.#marker&&(this.#profileSvg.removeChild(this.#marker),this.#profileSvg.removeChild(this.#distanceText),this.#profileSvg.removeChild(this.#elevText),this.#profileSvg.removeChild(this.#ascentText));let a=this.#profileSvg.getBoundingClientRect();this.#markerX=(2*d.margin+d.width)*(e.clientX-a.x)/a.width;let n=d.margin+d.height;this.#marker=document.createElementNS(y,"polyline"),this.#marker.setAttributeNS(null,"points",String(this.#markerX)+","+d.margin+" "+this.#markerX+","+n),this.#marker.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-markerPolyline"),this.#profileSvg.appendChild(this.#marker);let s=_.getRoute(Number.parseInt(this.#profileSvg.dataset.tanObjId));this.#textAnchor=t.routeDistance>s.distance/2?"end":"start",this.#markerX+=t.routeDistance>s.distance/2?-d.xDeltaText:d.xDeltaText,this.#distanceText=this.#createSvgText(P.formatDistance(t.routeDistance),d.margin+d.yDeltaText),this.#elevText=this.#createSvgText("Alt. "+t.elev.toFixed(0)+" m.",d.margin+2*d.yDeltaText),this.#ascentText=this.#createSvgText("Pente "+t.ascent.toFixed(0)+" % ",d.margin+3*d.yDeltaText)}}}class Vt extends class{#dragData=Object.seal({dragStartX:0,dragStartY:0,windowX:0,windowY:0});#containerDiv=null;#topBar=null;#headerDiv=null;#contentDiv=null;#eventListeners={onTopBarDragStart:null,onTopBarDragEnd:null};#createContainerDiv(){this.#containerDiv=Z.create("div",{className:"TravelNotes-FloatWindow-Container"},document.body)}#createTopBar(){this.#topBar=Z.create("div",{className:"TravelNotes-FloatWindow-TopBar",draggable:!0},this.#containerDiv),this.#topBar.addEventListener("dragstart",this.#eventListeners.onTopBarDragStart,!1),this.#topBar.addEventListener("dragend",this.#eventListeners.onTopBarDragEnd,!1),Z.create("div",{textContent:"❌",className:"TravelNotes-FloatWindow-CancelButton",title:M.getText("FloatWindow - Close")},this.#topBar).addEventListener("click",(()=>this.close()),!1)}#createHeaderDiv(){this.#headerDiv=Z.create("div",{className:"TravelNotes-FloatWindow-HeaderDiv"},this.#containerDiv)}#createContentDiv(){this.#contentDiv=Z.create("div",{className:"TravelNotes-FloatWindow-ContentDiv"},this.#containerDiv)}constructor(){this.#eventListeners.onTopBarDragStart=new kt(this.#dragData),this.#eventListeners.onTopBarDragEnd=new Rt(this.#dragData),this.#createContainerDiv(),this.#createTopBar(),this.#createHeaderDiv(),this.#createContentDiv(),Object.seal(this)}close(){this.#topBar.removeEventListener("dragstart",this.#eventListeners.onTopBarDragStart,!1),this.#topBar.removeEventListener("dragend",this.#eventListeners.onTopBarDragEnd,!1),this.#eventListeners.onTopBarDragStart=null,this.#eventListeners.onTopBarDragEnd=null,document.body.removeChild(this.#containerDiv)}update(){}get header(){return this.#headerDiv}get content(){return this.#contentDiv}}{#svg=null;#ascentDiv=null;#route=null;#eventListeners={onSvgContextMenu:null,onSvgMouseMove:null,onSvgMouseLeave:null};#markerObjId=T.nextObjId;#clean(){this.#svg&&(this.#svg.removeEventListener("contextmenu",this.#eventListeners.onSvgContextMenu,!1),this.#svg.removeEventListener("mousemove",this.#eventListeners.onSvgMouseMove,!1),this.#svg.removeEventListener("mouseleave",this.#eventListeners.onSvgMouseLeave,!1),xe.dispatch("removeobject",{objId:this.#markerObjId}),this.content.removeChild(this.#ascentDiv),this.content.removeChild(this.#svg)),this.#svg=null,this.#ascentDiv=null}constructor(){super(),this.#eventListeners.onSvgContextMenu=new Kt,this.#eventListeners.onSvgMouseMove=new zt,this.#eventListeners.onSvgMouseLeave=new Ft}close(){this.#clean(),xe.dispatch("profileclosed",{objId:this.#route.objId}),super.close()}update(e){this.#clean(),this.#route=e,this.#svg=(new Be).createSvg(this.#route),this.#svg.dataset.tanObjId=e.objId,this.#svg.dataset.tanMarkerObjId=this.#markerObjId,this.header.textContent=M.getText("ProfileWindow - Profile {name}",{name:this.#route.computedName}),this.content.appendChild(this.#svg),this.#svg.addEventListener("contextmenu",this.#eventListeners.onSvgContextMenu,!1),this.#svg.addEventListener("mousemove",this.#eventListeners.onSvgMouseMove,!1),this.#svg.addEventListener("mouseleave",this.#eventListeners.onSvgMouseLeave,!1),this.#ascentDiv=Z.create("div",{className:"TravelNotes-ProfileWindow-Ascent",textContent:M.getText("ProfileWindow - Ascent: {ascent} m. - Descent: {descent} m. - Distance: {distance}",{ascent:this.#route.itinerary.ascent.toFixed(0),descent:this.#route.itinerary.descent.toFixed(0),distance:P.formatDistance(this.#route.distance)})}),this.content.appendChild(this.#ascentDiv)}}const Wt=new class{#profileWindows=new Map;constructor(){Object.freeze(this)}createProfile(t){let o=this.#profileWindows.get(t.objId);if(t.itinerary.hasProfile){e.route.elev.smooth&&(new Be).smooth(t),t.itinerary.ascent=0,t.itinerary.descent=0;let a=t.itinerary.itineraryPoints.first.elev;t.itinerary.itineraryPoints.forEach((e=>{let o=e.elev-a;0>o?t.itinerary.descent-=o:t.itinerary.ascent+=o,a=e.elev})),o&&o.update(t)}else o&&o.close()}updateProfile(e,t){let o=this.#profileWindows.get(e);o&&(this.#profileWindows.delete(e),t&&t.itinerary.hasProfile?(o.update(t),this.#profileWindows.set(t.objId,o)):o.close())}deleteProfile(e){let t=this.#profileWindows.get(e);t&&t.close()}deleteAllProfiles(){this.#profileWindows.forEach((e=>e.close()))}showProfile(e){let t=this.#profileWindows.get(e);t||(t=new Vt);let o=_.getRoute(e);t.update(o),this.#profileWindows.set(e,t)}onProfileClosed(e){this.#profileWindows.delete(e)}},Gt=1e-6;class Xt{#views=[];#route=null;#printSize=null;#isItineraryHorOrVer(e,t,o){return t.lng===o.lng?{lat:t.lat>o.lat?e.bottomLeft.lat:e.upperRight.lat,lng:t.lng}:t.lat===o.lat?{lat:t.lat,lng:t.lng<o.lng?e.upperRight.lng:e.bottomLeft.lng}:null}#isFirstPointOnView(e,t){return t.lat-e.bottomLeft.lat<Gt||e.upperRight.lat-t.lat<Gt||t.lng-e.bottomLeft.lng<Gt||e.upperRight.lng-t.lng<Gt?{lat:t.lat,lng:t.lng}:null}#haveViewOnlyOnePoint(e,t,o){if(e.bottomLeft.lat===e.upperRight.lat&&e.bottomLeft.lng===e.upperRight.lng){let e=Math.min(Math.abs(this.#printSize[0]/(o.lat-t.lat)),Math.abs(this.#printSize[1]/(o.lng-t.lng)));return{lat:t.lat+e*(o.lat-t.lat),lng:t.lng+e*(o.lng-t.lng)}}return null}#computeIntermediatePoint(e,t,o){let a=this.#haveViewOnlyOnePoint(e,t,o);if(a)return a;if(a=this.#isFirstPointOnView(e,t),a)return a;if(a=this.#isItineraryHorOrVer(e,t,o),a)return a;let n=(t.lat-o.lat)/(t.lng-o.lng),s=t.lat-n*t.lng;if(a={lat:n*e.upperRight.lng+s,lng:e.upperRight.lng},a.lat<=e.upperRight.lat&&a.lat>=e.bottomLeft.lat&&a.lng<o.lng)return a;if(a={lat:e.upperRight.lat,lng:(e.upperRight.lat-s)/n},a.lng>=e.bottomLeft.lng&&a.lng<=e.upperRight.lng&&a.lat<o.lat)return a;if(a={lat:n*e.bottomLeft.lng+s,lng:e.bottomLeft.lng},a.lat<=e.upperRight.lat&&a.lat>=e.bottomLeft.lat&&a.lng>o.lng)return a;if(a={lat:e.bottomLeft.lat,lng:(e.bottomLeft.lat-s)/n},a.lng>=e.bottomLeft.lng&&a.lng<=e.upperRight.lng&&a.lat>o.lat)return a;throw new Error("intermediate point not found")}#computeViews(){this.#views=[];let e=this.#route.itinerary.itineraryPoints.iterator,t=e.done,o={bottomLeft:{lat:e.value.lat,lng:e.value.lng},upperRight:{lat:e.value.lat,lng:e.value.lng}},a={lat:e.value.lat,lng:e.value.lng},n=e.value;t=e.done;let s=e.value;for(;!t;){let i={bottomLeft:{lat:Math.min(o.bottomLeft.lat,s.lat),lng:Math.min(o.bottomLeft.lng,s.lng)},upperRight:{lat:Math.max(o.upperRight.lat,s.lat),lng:Math.max(o.upperRight.lng,s.lng)}},r=[i.upperRight.lat-i.bottomLeft.lat,i.upperRight.lng-i.bottomLeft.lng];this.#printSize[0]>r[0]&&this.#printSize[1]>r[1]?(o=i,n=e.value,t=e.done,s=e.value,t&&(o.entryPoint=a,o.exitPoint=n,this.#views.push(o))):(n=this.#computeIntermediatePoint(o,n,s),o.bottomLeft={lat:Math.min(o.bottomLeft.lat,n.lat),lng:Math.min(o.bottomLeft.lng,n.lng)},o.upperRight={lat:Math.max(o.upperRight.lat,n.lat),lng:Math.max(o.upperRight.lng,n.lng)},o.entryPoint=a,o.exitPoint=n,this.#views.push(o),o={bottomLeft:{lat:n.lat,lng:n.lng},upperRight:{lat:n.lat,lng:n.lng}},a={lat:n.lat,lng:n.lng})}}constructor(e,t){this.#route=e,this.#printSize=t,this.#computeViews()}get views(){return this.#views}}class _t{#name=null;#service=null;#url=null;#wmsOptions=null;#bounds=null;#minZoom=null;#maxZoom=null;#toolbar=null;#providerName=null;#providerKeyNeeded=!1;#attribution=null;#getCapabilitiesUrl=null;constructor(e){if(!e.name||"string"!=typeof e.name)throw new Error("invalid name for layer");if(this.#name=x.sanitizeToJsString(e.name),!e.service||"wms"!==e.service&&"wmts"!==e.service)throw new Error("invalid service for layer "+this.#name);if(this.#service=e.service,!e.url||"string"!=typeof e.url)throw new Error("invalid url for layer "+this.#name);if(this.#url=e.url,"wms"===this.#service){if(!(e.wmsOptions&&e.wmsOptions.layers&&"string"==typeof e.wmsOptions.layers&&e.wmsOptions.format&&"string"==typeof e.wmsOptions.format&&e.wmsOptions.transparent&&"boolean"==typeof e.wmsOptions.transparent))throw new Error("invalid wmsOptions for layer "+this.#name);this.#wmsOptions=e.wmsOptions,this.#wmsOptions.layers=x.sanitizeToJsString(this.#wmsOptions.layers),this.#wmsOptions.format=x.sanitizeToJsString(this.#wmsOptions.format)}try{e.bounds&&"number"==typeof e.bounds[0][0]&&"number"==typeof e.bounds[0][1]&&"number"==typeof e.bounds[1][0]&&"number"==typeof e.bounds[1][1]&&(this.#bounds=e.bounds)}catch(e){throw new Error("invalid bounds for layer "+this.#name)}if(e.minZoom&&"number"==typeof e.minZoom&&(this.#minZoom=e.minZoom),e.maxZoom&&"number"==typeof e.maxZoom&&(this.#maxZoom=e.maxZoom),!(e.toolbar&&e.toolbar.text&&"string"==typeof e.toolbar.text&&e.toolbar.color&&"string"==typeof e.toolbar.color&&e.toolbar.backgroundColor&&"string"==typeof e.toolbar.backgroundColor))throw new Error("invalid toolbar for layer "+this.#name);if(this.#toolbar=e.toolbar,this.#toolbar.text=x.sanitizeToJsString(this.#toolbar.text),this.#toolbar.color=x.sanitizeToColor(this.#toolbar.color)||"#000000",this.#toolbar.backgroundColor=x.sanitizeToColor(this.#toolbar.backgroundColor)||"#ffffff",!e.providerName||"string"!=typeof e.providerName)throw new Error("invalid providerName for layer "+this.#name);if(this.#providerName=x.sanitizeToJsString(e.providerName),"boolean"!=typeof e.providerKeyNeeded)throw new Error("invalid providerKeyNeeded for layer "+this.#name);if(this.#providerKeyNeeded=e.providerKeyNeeded,""===e.attribution)this.#attribution="";else{if(!e.attribution||"string"!=typeof e.attribution)throw new Error("invalid attribution for map layer "+this.#name);this.#attribution=x.sanitizeToHtmlString(e.attribution).htmlString}if(e.getCapabilitiesUrl&&"string"==typeof e.getCapabilitiesUrl&&(this.#getCapabilitiesUrl=x.sanitizeToUrl(e.getCapabilitiesUrl).url,""===this.#getCapabilitiesUrl))throw new Error("invalid getCapabilitiesUrl for map layer "+this.#name);Object.freeze(this)}get name(){return this.#name}get service(){return this.#service}get url(){return this.#url}get wmsOptions(){return this.#wmsOptions}get bounds(){return this.#bounds}get minZoom(){return this.#minZoom}get maxZoom(){return this.#maxZoom}get toolbar(){return this.#toolbar}get providerName(){return this.#providerName}get providerKeyNeeded(){return this.#providerKeyNeeded}get attribution(){return this.#attribution}get getCapabilitiesUrl(){return this.#getCapabilitiesUrl}}const Zt=new class{#mapLayers=new Map;#defaultMapLayer=null;#mapLayersAdded=!1;constructor(){this.#defaultMapLayer=new _t({service:"wmts",url:"https://{s}.tile.osm.org/{z}/{x}/{y}.png",name:"OSM - Color",toolbar:{text:"OSM",color:"#ff0000",backgroundColor:"#ffffff"},providerName:"OSM",providerKeyNeeded:!1,attribution:""}),this.#mapLayers.set(this.#defaultMapLayer.name,this.#defaultMapLayer),Object.freeze(this)}getMapLayer(e){let t=this.#mapLayers.get(e)||this.#defaultMapLayer;return t.providerKeyNeeded&&(Ce.hasKey(t.providerName.toLowerCase())||(t=this.#defaultMapLayer)),t}forEach(e){this.#mapLayers.forEach(e)}addMapLayers(e){this.#mapLayersAdded||(e.forEach((e=>{let t=new _t(e);this.#mapLayers.get(t.name)||this.#mapLayers.set(t.name,t)})),this.#mapLayersAdded=!0)}get defaultMapLayer(){return this.#defaultMapLayer}};class Yt{handleEvent(){window.print()}}class Jt{#printPageBuilder=null;constructor(e){this.#printPageBuilder=e}handleEvent(){this.#printPageBuilder.onAfterPrint(),this.#printPageBuilder=null}}class qt{#printData=null;#route=null;#views=[];#printToolbar=null;#printButton=null;#cancelButton=null;#viewsCounter=0;#viewsDiv=[];#routePolyline=null;#eventsListeners={onPrint:null,onAfterPrint:null};onAfterPrint(){this.#viewsDiv.forEach((e=>document.body.removeChild(e))),this.#viewsDiv.length=0,this.#printButton.removeEventListener("click",this.#eventsListeners.onPrint,!1),this.#cancelButton.removeEventListener("click",this.#eventsListeners.onAfterPrint,!1),document.body.removeChild(this.#printToolbar);let e=document.body.children;for(let t=0;t<e.length;t++)e.item(t).classList.remove("TravelNotes-Hidden");W.map.invalidateSize(!1),document.title="Travel & Notes"+(""===W.travel.name?"":" - "+W.travel.name),window.removeEventListener("afterprint",this.#eventsListeners.onAfterPrint,!0),this.#eventsListeners.onAfterPrint=null,this.#eventsListeners.onPrint=null}#getMapLayer(){let e=Zt.getMapLayer(W.travel.layerName),t=Ce.getUrl(e),o=null;return o="wmts"===e.service.toLowerCase()?window.L.tileLayer(t):window.L.tileLayer.wms(t,e.wmsOptions),o.options.attribution=x.sanitizeToHtmlString(' © <a href="https://www.openstreetmap.org/copyright" target="_blank" title="OpenStreetMap contributors">OpenStreetMap contributors</a> '+e.attribution+'| © <a href="https://github.com/wwwouaiebe" target="_blank" title="https://github.com/wwwouaiebe">Travel & Notes</a> ').htmlString,o}#getNotesMarkers(){let e=[];return this.#route.notes.forEach((t=>{let o=window.L.divIcon({iconSize:[t.iconWidth,t.iconHeight],iconAnchor:[t.iconWidth/2,t.iconHeight/2],popupAnchor:[0,-t.iconHeight/2],html:t.iconContent,className:"TravelNotes-Map-AllNotes "}),a=window.L.marker(t.iconLatLng,{zIndexOffset:100,icon:o,draggable:!0});e.push(a)})),e}#createViewOnPage(t){this.#viewsCounter++;let o="TravelNotes-RouteViewDiv"+this.#viewsCounter,a=document.createElement("div");a.className="TravelNotes-routeViewDiv",a.id=o,document.body.appendChild(a),this.#viewsDiv.push(a),this.#printData.pageBreak&&a.classList.add("TravelNotes-PrintPageBreak"),a.style.width=String(this.#printData.paperWidth)+"mm",a.style.height=String(this.#printData.paperHeight)+"mm";let n=this.#printData.printNotes?this.#getNotesMarkers():[];n.push(this.#getMapLayer()),n.push(window.L.circleMarker([t.entryPoint.lat,t.entryPoint.lng],e.printRouteMap.entryPointMarker)),n.push(window.L.circleMarker([t.exitPoint.lat,t.exitPoint.lng],e.printRouteMap.exitPointMarker)),n.push(this.#routePolyline),window.L.map(o,{attributionControl:!0,zoomControl:!1,center:[(t.bottomLeft.lat+t.upperRight.lat)/2,(t.bottomLeft.lng+t.upperRight.lng)/2],zoom:this.#printData.zoomFactor,minZoom:this.#printData.zoomFactor,maxZoom:this.#printData.zoomFactor,layers:n})}#createToolbar(){this.#printToolbar=Z.create("div",{id:"TravelNotes-PrintToolbar"},document.body),this.#printButton=Z.create("div",{className:"TravelNotes-UI-Button",title:M.getText("PrintPageBuilder - Print"),textContent:"🖨️"},this.#printToolbar),this.#printButton.addEventListener("click",this.#eventsListeners.onPrint,!1),this.#cancelButton=Z.create("div",{className:"TravelNotes-UI-Button",title:M.getText("PrintPageBuilder - Cancel print"),textContent:"❌"},this.#printToolbar),this.#cancelButton.addEventListener("click",this.#eventsListeners.onAfterPrint,!1)}preparePage(){let e=document.body.children;for(let t=0;t<e.length;t++)e.item(t).classList.add("TravelNotes-Hidden");document.title=""===W.travel.name?"maps":W.travel.name+" - "+this.#route.computedName+" - maps",this.#createToolbar(),window.addEventListener("afterprint",this.#eventsListeners.onAfterPrint,!0);let t=[],o=this.#route.itinerary.itineraryPoints.iterator;for(;!o.done;)t.push(o.value.latLng);this.#routePolyline=window.L.polyline(t,{color:this.#route.color,weight:this.#route.width}),this.#viewsCounter=0,this.#views.forEach((e=>this.#createViewOnPage(e)))}constructor(e,t,o){this.#route=e,this.#views=t,this.#printData=o,this.#eventsListeners.onPrint=new Yt,this.#eventsListeners.onAfterPrint=new Jt(this),Object.seal(this)}}class Qt{#tilesPerPage=0;#computeViewSize(e){let t=Z.create("div",{},document.body);t.style.position="absolute",t.style.top="0",t.style.left="0",t.style.width=String(e.paperWidth-2*e.borderWidth)+"mm",t.style.height=String(e.paperHeight-2*e.borderWidth)+"mm",this.#tilesPerPage=Math.ceil(t.clientWidth/256)*Math.ceil(t.clientHeight/256);let o=G.screenCoordToLatLng(0,0),a=G.screenCoordToLatLng(t.clientWidth,t.clientHeight);document.body.removeChild(t);let n=W.map.getZoomScale(W.map.getZoom(),e.zoomFactor);return[Math.abs(o[0]-a[0])*n,Math.abs(o[1]-a[1])*n]}constructor(){Object.freeze(this)}print(t,o){let a=_.getRoute(o);if(!a)return;let n=new Xt(a,this.#computeViewSize(t));e.printRouteMap.maxTiles<n.views.length*this.#tilesPerPage?Me.showError(M.getText("RoutePrinter - The maximum of allowed pages is reached.")):new qt(a,n.views,t).preparePage()}}const $t=new class{constructor(){Object.freeze(this)}addRoute(){let e=new F;W.travel.routes.add(e),l.editedChanged===W.travel.editedRoute.editionStatus?(this.chainRoutes(),xe.dispatch("setrouteslist"),xe.dispatch("roadbookupdate")):this.editRoute(e.objId)}editRoute(e){if(l.editedChanged===W.travel.editedRoute.editionStatus)return void Me.showError(M.getText("RouteEditor - Not possible to edit a route without a save or cancel"));let t=_.getRoute(e),o=t.itinerary.provider,a=W.providers.get(o.toLowerCase());if(o&&""!==o&&(!a||a.providerKeyNeeded&&!Ce.hasKey(o)))return void Me.showError(M.getText("RouteEditor - Not possible to edit a route created with this provider",{provider:o}));p!==W.editedRouteObjId&&this.cancelEdition(),o&&""!==o&&xe.dispatch("setprovider",{provider:o});let n=t.itinerary.transitMode;n&&""!==n&&xe.dispatch("settransitmode",{transitMode:n}),W.travel.editedRoute=new F,t.editionStatus=l.editedNoChange,W.travel.editedRoute.jsonObject=t.jsonObject,W.editedRouteObjId=t.objId,W.travel.editedRoute.hidden=!1,t.hidden=!1,Wt.updateProfile(W.editedRouteObjId,W.travel.editedRoute),this.chainRoutes(),xe.dispatch("routeupdated",{removedRouteObjId:t.objId,addedRouteObjId:W.travel.editedRoute.objId}),xe.dispatch("roadbookupdate"),xe.dispatch("showitinerary"),xe.dispatch("setrouteslist")}removeRoute(e){let t=e;if(t===W.editedRouteObjId||t===W.travel.editedRoute.objId){if(l.editedChanged===W.travel.editedRoute.editionStatus)return void Me.showError(M.getText("TravelEditor - Cannot remove an edited route"));t=W.editedRouteObjId,this.cancelEdition()}xe.dispatch("routeupdated",{removedRouteObjId:t,addedRouteObjId:p}),W.travel.routes.remove(t),Wt.deleteProfile(t),this.chainRoutes(),xe.dispatch("roadbookupdate"),xe.dispatch("setrouteslist")}saveGpx(e){(new xt).routeToGpx(e)}chainRoutes(){let e=W.travel.routes.iterator,t=a.defaultValue;for(;!e.done;){e.value.chain?(e.value.chainedDistance=t,t+=e.value.distance):e.value.chainedDistance=a.defaultValue;let o=e.value.notes.iterator;for(;!o.done;)o.value.chainedDistance=e.value.chainedDistance}}saveEdition(){let e=new F;e.jsonObject=W.travel.editedRoute.jsonObject,W.travel.routes.replace(W.editedRouteObjId,e),W.editedRouteObjId=e.objId,this.cancelEdition()}cancelEdition(){let e=_.getRoute(W.editedRouteObjId);e.editionStatus=l.notEdited,Wt.updateProfile(W.travel.editedRoute.objId,e),xe.dispatch("routeupdated",{removedRouteObjId:W.travel.editedRoute.objId,addedRouteObjId:W.editedRouteObjId}),W.editedRouteObjId=p,W.travel.editedRoute=new F,this.chainRoutes(),xe.dispatch("roadbookupdate"),xe.dispatch("setrouteslist"),xe.dispatch("showitinerary")}routeProperties(e){let t=_.getRoute(e);new Ot(t).show().then((()=>{this.chainRoutes(),t.haveValidWayPoints()&&xe.dispatch("routepropertiesupdated",{routeObjId:t.objId}),xe.dispatch("roadbookupdate"),xe.dispatch("setrouteslist"),xe.dispatch("updateitinerary")})).catch((e=>{e instanceof Error&&console.error(e)}))}printRouteMap(e){(new St).show().then((t=>(new Qt).print(t,e))).catch((e=>{e instanceof Error&&console.error(e)}))}showRoute(e){_.getRoute(e).hidden=!1,xe.dispatch("routeupdated",{removedRouteObjId:p,addedRouteObjId:e}),xe.dispatch("setrouteslist")}hideRoute(e){_.getRoute(e).hidden=!0,xe.dispatch("routeupdated",{removedRouteObjId:e,addedRouteObjId:p}),xe.dispatch("setrouteslist")}showRoutes(){let e=W.travel.routes.iterator;for(;!e.done;)e.value.hidden&&(e.value.hidden=!1,xe.dispatch("routeupdated",{removedRouteObjId:p,addedRouteObjId:e.value.objId}));xe.dispatch("setrouteslist")}hideRoutes(){let e=W.travel.routes.iterator;for(;!e.done;)e.value.hidden||e.value.objId===W.editedRouteObjId||(e.value.hidden=!0,xe.dispatch("routeupdated",{removedRouteObjId:e.value.objId,addedRouteObjId:p}));xe.dispatch("setrouteslist")}};class eo extends re{#wayPoint=null;#addressInput=null;#resetAddressButton=null;#nameInput=null;async handleEvent(t){if(t.stopPropagation(),!e.wayPoint.reverseGeocoding)return;this.showWait();let o=new ht,a=await o.getAddressAsync(this.#wayPoint.latLng);if(this.hideWait(),a.statusOk){e.wayPoint.geocodingIncludeName&&(this.#nameInput.value=a.name);let t=a.street;""!==a.city&&(t+=" "+a.city),this.#addressInput.value=t}}#createAddressControl(){let e=Z.create("div");this.#resetAddressButton=Z.create("div",{className:"TravelNotes-BaseDialog-Button",title:M.getText("WayPointPropertiesDialog - Reset address"),textContent:"🔄"},e),this.#resetAddressButton.addEventListener("click",this,!1),Z.create("text",{value:M.getText("WayPointPropertiesDialog - Address")},e);let t=Z.create("div");return this.#addressInput=Z.create("input",{type:"text",value:this.#wayPoint.address,className:"TravelNotes-WayPointPropertiesDialog-Input"},t),[e,t]}#createNameControl(){let e=Z.create("div",{textContent:M.getText("WayPointPropertiesDialog - Name")}),t=Z.create("div");return this.#nameInput=Z.create("input",{type:"text",value:this.#wayPoint.name,className:"TravelNotes-WayPointPropertiesDialog-Input"},t),[e,t]}constructor(e){super(),this.#wayPoint=e}onCancel(){this.#resetAddressButton.removeEventListener("click",this,!1),super.onCancel()}onOk(){this.#wayPoint.address=this.#addressInput.value,this.#wayPoint.name=this.#nameInput.value,this.#resetAddressButton.removeEventListener("click",this,!1),super.onOk()}get contentHTMLElements(){return[].concat(this.#createNameControl(),this.#createAddressControl())}get title(){return M.getText("WayPointPropertiesDialog - Waypoint properties")}}const to=new class{#routingRequestStarted=!1;#zoomToRouteAfterRouting=!1;#computeRouteDistances(e){let t=e.itinerary.itineraryPoints.iterator,o=e.itinerary.maneuvers.iterator;for(t.done,o.done,o.value.distance=a.defaultValue,o.done,e.distance=a.defaultValue,e.duration=a.defaultValue;!t.done;)t.previous.distance=X.pointsDistance(t.previous.latLng,t.value.latLng),e.distance+=t.previous.distance,o.previous.distance+=t.previous.distance,o.value.itineraryPointObjId===t.value.objId&&(e.duration+=o.previous.duration,o.value.distance=a.defaultValue,o.next&&o.value.itineraryPointObjId===o.next.itineraryPointObjId&&(o.done,o.value.distance=a.defaultValue),o.done)}#onRoutingError(e){this.#routingRequestStarted=!1,Me.showError(e),e instanceof Error&&console.error(e)}#onRoutingOk(){this.#routingRequestStarted=!1,W.travel.editedRoute.itinerary.validateData();let e=W.travel.editedRoute.itinerary.maneuvers.iterator;for(;!e.done;)e.value.validateData();let t=W.travel.editedRoute.itinerary.itineraryPoints.iterator;for(;!t.done;)t.value.validateData();if(this.#computeRouteDistances(W.travel.editedRoute),"circle"!==W.travel.editedRoute.itinerary.transitMode){let e=W.travel.editedRoute.wayPoints.iterator;for(;!e.done;)e.first?e.value.latLng=W.travel.editedRoute.itinerary.itineraryPoints.first.latLng:e.last?e.value.latLng=W.travel.editedRoute.itinerary.itineraryPoints.last.latLng:e.value.latLng=G.getClosestLatLngDistance(W.travel.editedRoute,e.value.latLng).latLng}let o=W.travel.editedRoute.notes.iterator;for(;!o.done;){let e=G.getClosestLatLngDistance(W.travel.editedRoute,o.value.latLng);o.value.latLng=e.latLng,o.value.distance=e.distance}$t.chainRoutes(),W.travel.editedRoute.notes.sort(((e,t)=>e.distance-t.distance)),this.#zoomToRouteAfterRouting&&(new Ht).zoomToRoute(W.travel.editedRoute.objId),Wt.createProfile(W.travel.editedRoute),xe.dispatch("routeupdated",{removedRouteObjId:W.travel.editedRoute.objId,addedRouteObjId:W.travel.editedRoute.objId}),xe.dispatch("roadbookupdate"),xe.dispatch("showitinerary"),xe.dispatch("setrouteslist")}startRouting(){if(!this.#routingRequestStarted&&W.travel.editedRoute.haveValidWayPoints()){this.#zoomToRouteAfterRouting=0===W.travel.editedRoute.itinerary.itineraryPoints.length,this.#routingRequestStarted=!0;let e=W.providers.get(W.routing.provider.toLowerCase());W.travel.editedRoute.itinerary.provider=e.name,W.travel.editedRoute.itinerary.transitMode=W.routing.transitMode,e.getPromiseRoute(W.travel.editedRoute,null).then((()=>this.#onRoutingOk())).catch((()=>this.#onRoutingError()))}}};const oo=new class{#renameWayPoint(e,t){let o=W.travel.editedRoute.wayPoints.getAt(t);o?(W.travel.editedRoute.editionStatus=l.editedChanged,o.name=e.name,o.address=e.address,xe.dispatch("setrouteslist"),xe.dispatch("showitinerary"),xe.dispatch("roadbookupdate")):console.error("waypoint not found")}async#renameWayPointWithGeocoder(t,o){if(!e.wayPoint.reverseGeocoding)return xe.dispatch("setrouteslist"),xe.dispatch("showitinerary"),void xe.dispatch("roadbookupdate");let a=await(new ht).getAddressAsync(t);if(a.statusOk){let t=a.street;""!==a.city&&(t+=" "+a.city);let n="";e.wayPoint.geocodingIncludeName&&(n=a.name),this.#renameWayPoint(Object.seal({name:n,address:t}),o)}}constructor(){Object.freeze(this)}addWayPoint(e){W.travel.editedRoute.editionStatus=l.editedChanged;let t=new j;t.latLng=e,W.travel.editedRoute.wayPoints.add(t),this.#renameWayPointWithGeocoder(e,t.objId),xe.dispatch("addwaypoint",{wayPoint:W.travel.editedRoute.wayPoints.last,letter:W.travel.editedRoute.wayPoints.length-2}),W.travel.editedRoute.wayPoints.swap(t.objId,!0),to.startRouting()}addWayPointOnRoute(e,t){let o=G.getClosestLatLngDistance(W.travel.editedRoute,e).distance;W.travel.editedRoute.editionStatus=l.editedChanged;let a=new j;a.latLng=t;let n="",s=W.travel.editedRoute.wayPoints.iterator;for(;!s.done;){if(o<G.getClosestLatLngDistance(W.travel.editedRoute,s.value.latLng).distance){n=String(s.index),W.travel.editedRoute.wayPoints.add(a),W.travel.editedRoute.wayPoints.moveTo(a.objId,s.value.objId,!0),this.#renameWayPointWithGeocoder(t,a.objId),xe.dispatch("addwaypoint",{wayPoint:a,letter:n}),to.startRouting();break}}}reverseWayPoints(){W.travel.editedRoute.editionStatus=l.editedChanged;let e=W.travel.editedRoute.wayPoints.iterator;for(;!e.done;)xe.dispatch("removeobject",{objId:e.value.objId});for(W.travel.editedRoute.wayPoints.reverse(),e=W.travel.editedRoute.wayPoints.iterator;!e.done;)xe.dispatch("addwaypoint",{wayPoint:e.value,letter:e.first?"A":e.last?"B":e.index});xe.dispatch("setrouteslist"),xe.dispatch("showitinerary"),xe.dispatch("roadbookupdate"),to.startRouting()}removeWayPoint(e){W.travel.editedRoute.editionStatus=l.editedChanged,xe.dispatch("removeobject",{objId:e}),W.travel.editedRoute.wayPoints.remove(e),to.startRouting()}setStartPoint(e){W.travel.editedRoute.editionStatus=l.editedChanged,r.defaultValue!==W.travel.editedRoute.wayPoints.first.lat&&xe.dispatch("removeobject",{objId:W.travel.editedRoute.wayPoints.first.objId}),W.travel.editedRoute.wayPoints.first.latLng=e,this.#renameWayPointWithGeocoder(e,W.travel.editedRoute.wayPoints.first.objId),xe.dispatch("addwaypoint",{wayPoint:W.travel.editedRoute.wayPoints.first,letter:"A"}),to.startRouting()}setEndPoint(e){W.travel.editedRoute.editionStatus=l.editedChanged,r.defaultValue!==W.travel.editedRoute.wayPoints.last.lat&&xe.dispatch("removeobject",{objId:W.travel.editedRoute.wayPoints.last.objId}),W.travel.editedRoute.wayPoints.last.latLng=e,this.#renameWayPointWithGeocoder(e,W.travel.editedRoute.wayPoints.last.objId),xe.dispatch("addwaypoint",{wayPoint:W.travel.editedRoute.wayPoints.last,letter:"B"}),to.startRouting()}wayPointDragEnd(e){W.travel.editedRoute.editionStatus=l.editedChanged,this.#renameWayPointWithGeocoder(W.travel.editedRoute.wayPoints.getAt(e).latLng,e),to.startRouting()}wayPointProperties(e){let t=W.travel.editedRoute.wayPoints.getAt(e);new eo(t).show().then((()=>{xe.dispatch("setrouteslist"),xe.dispatch("showitinerary"),xe.dispatch("roadbookupdate")})).catch((e=>{e instanceof Error&&console.error(e)}))}};class ao extends re{#options=null;constructor(e={}){super(e),this.#options=e}get contentHTMLElements(){return[Z.create("div",{textContent:this.#options.text||""})]}get title(){return this.#options.title||""}}class no{#waitUI=null;#newNoteFromOsmData(e,t){let o=new U;for(const t in e)o[t]=e[t];o.iconLatLng=o.latLng,o.distance=G.getClosestLatLngDistance(t,o.latLng).distance,o.chainedDistance=t.chainedDistance,t.notes.add(o),xe.dispatch("noteupdated",{removedNoteObjId:p,addedNoteObjId:o.objId}),xe.dispatch("roadbookupdate")}async#addAllManeuverNotes(e,t){this.#waitUI=new Et,this.#waitUI.createUI();let o=e.itinerary.maneuvers.iterator;for(;!o.done;){this.#waitUI.showInfo(M.getText("NoteEditor - Creating note",{noteNumber:o.index+1,notesLength:t}));let a=e.itinerary.itineraryPoints.getAt(o.value.itineraryPointObjId).latLng,n=await(new at).getIconAndAdressAsync(a,e.objId);n.statusOk?this.#newNoteFromOsmData(n.noteData,e):console.error("An error occurs when creating the svg icon "+o.index)}e.notes.sort(((e,t)=>e.distance-t.distance)),xe.dispatch("updateitinerary"),xe.dispatch("roadbookupdate"),this.#waitUI.close(),this.#waitUI=null}addAllManeuverNotes(t){let o=_.getRoute(t),a=o.itinerary.maneuvers.iterator,n=0;for(;!a.done;)"kDepartDefault"===a.value.iconName&&!a.first||"kArriveDefault"===a.value.iconName&&!a.last||n++;e.note.maxManeuversNotes<n?Me.showError(M.getText("NoteEditor - max maneuvers notes reached {maneuversLength}{maxManeuversNotes}",{maneuversLength:n,maxManeuversNotes:e.note.maxManeuversNotes})):new ao({title:M.getText("NoteEditor - Add a note for each maneuver"),text:M.getText("NoteEditor - Add a note for each maneuver. Are you sure?",{noteLength:n}),secondButtonText:"❌"}).show().then((()=>this.#addAllManeuverNotes(o,n))).catch((e=>{e instanceof Error&&console.error(e)}))}}class so extends Ye{#routeObjId=p;#route=null;constructor(e,t=null){super(e,t),this.#routeObjId=this.eventData.targetObjId,this.#route=_.getRoute(this.#routeObjId)}doAction(e){switch(e){case 0:$t.editRoute(this.#routeObjId);break;case 1:$t.removeRoute(this.#routeObjId);break;case 2:this.#route.hidden?$t.showRoute(this.#routeObjId):$t.hideRoute(this.#routeObjId);break;case 3:$t.routeProperties(this.#routeObjId);break;case 4:(new Ht).zoomToRoute(this.#routeObjId);break;case 5:Wt.showProfile(this.#routeObjId);break;case 6:$t.printRouteMap(this.#routeObjId);break;case 7:$t.saveGpx(this.#routeObjId);break;case 8:oo.reverseWayPoints();break;case 9:Nt.newRouteNote({routeObjId:this.#routeObjId,lat:this.eventData.lat,lng:this.eventData.lng});break;case 10:(new no).addAllManeuverNotes(this.#routeObjId);break;case 11:$t.saveEdition();break;case 12:$t.cancelEdition()}}get menuItems(){return[{itemText:M.getText("RouteContextMenu - Edit this route"),isActive:this.#routeObjId!==W.travel.editedRoute.objId&&l.editedChanged!==W.travel.editedRoute.editionStatus},{itemText:M.getText("RouteContextMenu - Delete this route"),isActive:this.#routeObjId!==W.travel.editedRoute.objId||l.editedChanged!==W.travel.editedRoute.editionStatus},{itemText:M.getText(this.#route.hidden?"RouteContextMenu - Show this route":"RouteContextMenu - Hide this route"),isActive:this.#route.hidden||W.travel.editedRoute.objId!==this.#routeObjId},{itemText:M.getText("RouteContextMenu - Properties"),isActive:!this.#route.hidden},{itemText:M.getText("RouteContextMenu - Zoom to route"),isActive:!this.#route.hidden},{itemText:M.getText("RouteContextMenu - View the elevation"),isActive:this.#route.itinerary.hasProfile},{itemText:M.getText("RouteContextMenu - Print route map"),isActive:e.printRouteMap.isEnabled},{itemText:M.getText("RouteContextMenu - Save this route in a GPX file"),isActive:0<this.#route.itinerary.itineraryPoints.length},{itemText:M.getText("RouteContextMenu - Invert waypoints"),isActive:W.travel.editedRoute.objId===this.#routeObjId},{itemText:M.getText("RouteContextMenu - Add a note on the route"),isActive:!this.eventData.haveParentNode},{itemText:M.getText("RouteContextMenu - Create a note for each route maneuver"),isActive:!this.#route.hidden},{itemText:M.getText("RouteContextMenu - Save modifications on this route"),isActive:W.travel.editedRoute.objId===this.#routeObjId},{itemText:M.getText("RouteContextMenu - Cancel modifications on this route"),isActive:W.travel.editedRoute.objId===this.#routeObjId}]}}class io{static handleEvent(e){let t=_.getRoute(e.target.objId),o=G.getClosestLatLngDistance(t,[e.latlng.lat,e.latlng.lng]).distance;o+=t.chainedDistance,o=P.formatDistance(o);let a=W.mapObjects.get(e.target.objId);a.closeTooltip();let n=t.computedName;W.travel.readOnly||(n+=0===n.length?"":" - ",n+=o),a.setTooltipContent(n),a.openTooltip(e.latlng)}}class ro{static handleEvent(e){window.L.DomEvent.stopPropagation(e),new so(e).show()}}class lo{static marker=null;static initialLatLng=null}class ho{static handleEvent(){lo.marker&&(window.L.DomEvent.off(lo.marker),W.map.removeLayer(lo.marker),lo.marker=null)}}class co{static handleEvent(){window.L.DomEvent.off(lo.marker,"mouseout",ho.handleEvent)}}class uo{static handleEvent(e){e.latlng.lat=lo.initialLatLng[0],e.latlng.lng=lo.initialLatLng[1],e.target.objId=W.travel.editedRoute.objId,new so(e).show()}}class vo{static handleEvent(e){oo.addWayPointOnRoute(lo.initialLatLng,[e.target.getLatLng().lat,e.target.getLatLng().lng]),lo.marker&&(window.L.DomEvent.off(lo.marker,"dragstart",co.handleEvent),window.L.DomEvent.off(lo.marker,"dragend",vo.handleEvent),window.L.DomEvent.off(lo.marker,"contextmenu",uo.handleEvent),W.map.removeLayer(lo.marker),lo.marker=null)}}class po{static#showDragTooltip=1;static handleEvent(t){let o=_.getRoute(t.target.objId);if(l.notEdited!==o.editionStatus)if(lo.initialLatLng=[t.latlng.lat,t.latlng.lng],lo.marker)lo.marker.setLatLng(t.latlng);else{let o='<div class="TravelNotes-Map-WayPoint TravelNotes-Map-WayPointTmp"></div><div class="TravelNotes-Map-WayPointText">?</div>';lo.marker=window.L.marker(t.latlng,{icon:window.L.divIcon({iconSize:[w,w],iconAnchor:[10,w],html:o,className:"TravelNotes-Map-WayPointStyle"}),draggable:!0}),(m===e.route.showDragTooltip||po.#showDragTooltip<=e.route.showDragTooltip)&&(po.#showDragTooltip++,lo.marker.bindTooltip(M.getText("MapEditor - Drag and drop to add a waypoint")),lo.marker.getTooltip().options.offset=[0,0]),lo.marker.addTo(W.map),window.L.DomEvent.on(lo.marker,"mouseout",ho.handleEvent),window.L.DomEvent.on(lo.marker,"dragstart",co.handleEvent),window.L.DomEvent.on(lo.marker,"dragend",vo.handleEvent),window.L.DomEvent.on(lo.marker,"contextmenu",uo.handleEvent)}}}class mo{static handleEvent(e){let t=_.getNoteAndRoute(e.target.objId),o=t.note,a=t.route,n=W.mapObjects.get(e.target.objId);if(null===a)o.latLng=[e.target.getLatLng().lat,e.target.getLatLng().lng],xe.dispatch("updatetravelnotes");else{let t=G.getClosestLatLngDistance(a,[e.target.getLatLng().lat,e.target.getLatLng().lng]);o.latLng=t.latLng,o.distance=t.distance,a.notes.sort(((e,t)=>e.distance-t.distance)),n.getLayer(n.bulletId).setLatLng(t.latLng),xe.dispatch("updateitinerary")}n.getLayer(n.polylineId).setLatLngs([o.latLng,o.iconLatLng]),xe.dispatch("roadbookupdate")}}class go{static handleEvent(e){let t=_.getNoteAndRoute(e.target.objId).note,o=W.mapObjects.get(e.target.objId);o.getLayer(o.polylineId).setLatLngs([[e.latlng.lat,e.latlng.lng],t.iconLatLng])}}class bo{static handleEvent(t){t.originalEvent.target.style.opacity=e.note.grip.moveOpacity}}class yo{static handleEvent(t){t.originalEvent.target.style.opacity=e.note.grip.opacity}}class Io extends Ye{#noteObjId=p;#route=null;constructor(e,t=null){super(e,t),this.#noteObjId=this.eventData.targetObjId,this.#route=_.getNoteAndRoute(this.#noteObjId).route}doAction(e){switch(e){case 0:Nt.editNote(this.#noteObjId);break;case 1:Nt.removeNote(this.#noteObjId);break;case 2:(new Ht).zoomToNote(this.#noteObjId);break;case 3:this.#route?Nt.detachNoteFromRoute(this.#noteObjId):Nt.attachNoteToRoute(this.#noteObjId)}}get menuItems(){return[{itemText:M.getText("NoteContextMenu - Edit this note"),isActive:!0},{itemText:M.getText("NoteContextMenu - Delete this note"),isActive:!0},{itemText:M.getText("NoteContextMenu - Zoom to note"),isActive:!0},{itemText:M.getText(this.#route?"NoteContextMenu - Detach note from route":"NoteContextMenu - Attach note to route"),isActive:p===W.editedRouteObjId}]}}class wo{static handleEvent(e){new Io(e).show()}}class Lo{static handleEvent(e){let t=_.getNoteAndRoute(e.target.objId).note;t.iconLatLng=[e.target.getLatLng().lat,e.target.getLatLng().lng];let o=W.mapObjects.get(e.target.objId);o.getLayer(o.polylineId).setLatLngs([t.latLng,t.iconLatLng])}}class To{static handleEvent(e){let t=_.getNoteAndRoute(e.target.objId).note,o=W.mapObjects.get(e.target.objId);o.getLayer(o.polylineId).setLatLngs([t.latLng,[e.latlng.lat,e.latlng.lng]])}}class Do extends Ye{#wayPointObjId=p;constructor(e,t=null){super(e,t),this.#wayPointObjId=this.eventData.targrtObjId}doAction(e){switch(e){case 0:oo.removeWayPoint(this.#wayPointObjId);break;case 1:oo.wayPointProperties(this.#wayPointObjId)}}get menuItems(){return[{itemText:M.getText("WayPointContextMenu - Delete this waypoint"),isActive:W.travel.editedRoute.wayPoints.first.objId!==this.#wayPointObjId&&W.travel.editedRoute.wayPoints.last.objId!==this.#wayPointObjId},{itemText:M.getText("WayPointContextMenu - Modify properties"),isActive:!0}]}}class fo{static handleEvent(e){new Do(e).show()}}class Eo{static handleEvent(e){W.travel.editedRoute.wayPoints.getAt(e.target.objId).latLng=[e.target.getLatLng().lat,e.target.getLatLng().lng],oo.wayPointDragEnd(e.target.objId)}}const No=new class extends class{#currentLayer=null;#geolocationCircle=null;#getDashArray(t){t.dashArray>=e.route.dashChoices.length&&(t.dashArray=0);let o=e.route.dashChoices[t.dashArray].iDashArray;if(o){let e="",a=0;for(a=0;a<o.length-1;a++)e+=o[a]*t.width+",";return e+=o[a]*t.width,e}return null}#addNote(t){let o=_.getNoteAndRoute(t).note,a=window.L.marker(o.latLng,{icon:window.L.divIcon({iconSize:[e.note.grip.size,e.note.grip.size],iconAnchor:[e.note.grip.size/2,e.note.grip.size/2],html:"<div></div>",className:"TravelNotes-Map-Note-Bullet"}),opacity:e.note.grip.opacity,draggable:!W.travel.readOnly});a.objId=o.objId;let n=window.L.divIcon({iconSize:[o.iconWidth,o.iconHeight],iconAnchor:[o.iconWidth/2,o.iconHeight/2],popupAnchor:[0,-o.iconHeight/2],html:o.iconContent,className:"TravelNotes-Map-AllNotes "}),s=window.L.marker(o.iconLatLng,{zIndexOffset:100,icon:n,draggable:!W.travel.readOnly});s.objId=o.objId,s.bindPopup((e=>Ue.getNoteTextHTML("TravelNotes-Map-",_.getNoteAndRoute(e.objId)))),0!==o.tooltipContent.length&&(s.bindTooltip((e=>_.getNoteAndRoute(e.objId).note.tooltipContent)),s.getTooltip().options.offset[0]=o.iconWidth/2);let i=window.L.polyline([o.latLng,o.iconLatLng],e.note.polyline);i.objId=o.objId;let r=window.L.layerGroup([s,i,a]);return r.markerId=window.L.Util.stamp(s),r.polylineId=window.L.Util.stamp(i),r.bulletId=window.L.Util.stamp(a),this.addToMap(o.objId,r),e.note.haveBackground&&document.querySelectorAll(".TravelNotes-MapNote,.TravelNotes-SvgIcon").forEach((e=>e.classList.add("TravelNotes-Map-Note-Background"))),Object.freeze({marker:s,polyline:i,bullet:a})}constructor(){Object.freeze(this)}addToMap(e,t){t.objId=e,t.addTo(W.map),W.mapObjects.set(e,t)}addRoute(e){let t=_.getRoute(e),o=[],a=t.itinerary.itineraryPoints.iterator;for(;!a.done;)o.push(a.value.latLng);let n=window.L.polyline(o,{color:t.color,weight:t.width,dashArray:this.#getDashArray(t)});this.addToMap(t.objId,n),l.notEdited===t.editionStatus&&(n.bindTooltip(t.computedName,{sticky:!0,direction:"right"}),window.L.DomEvent.on(n,"mouseover",io.handleEvent),window.L.DomEvent.on(n,"mousemove",io.handleEvent)),n.bindPopup((e=>{let t=_.getRoute(e.objId);return Ke.getRouteHeaderHTML("TravelNotes-Map-",t)})),window.L.DomEvent.on(n,"click",(e=>e.target.openPopup(e.latlng)));let s=t.notes.iterator;for(;!s.done;)this.#addNote(s.value.objId);return t}addNote(e){return this.#addNote(e)}getDashArray(e){return this.#getDashArray(e)}zoomTo(t,o){if(o){let e=[];o.forEach((t=>e=e.concat(t))),W.map.fitBounds(G.getLatLngBounds(e))}else W.map.setView(t,e.itineraryPoint.zoomFactor)}setLayer(e,t){let o=null;o="wmts"===e.service.toLowerCase()?window.L.tileLayer(t):window.L.tileLayer.wms(t,e.wmsOptions),this.#currentLayer&&W.map.removeLayer(this.#currentLayer),W.map.addLayer(o),this.#currentLayer=o,W.travel.readOnly||(W.map.getZoom()<(e.minZoom||0)&&W.map.setZoom(e.minZoom||0),W.map.setMinZoom(e.minZoom||0),W.map.getZoom()>(e.maxZoom||18)&&W.map.setZoom(e.maxZoom||18),W.map.setMaxZoom(e.maxZoom||18),e.bounds?(W.map.getBounds().intersects(e.bounds)&&!W.map.getBounds().contains(e.bounds)||(W.map.setMaxBounds(null),W.map.fitBounds(e.bounds),W.map.setZoom(e.minZoom||0)),W.map.setMaxBounds(e.bounds)):W.map.setMaxBounds(null)),W.map.fire("baselayerchange",o)}onGeolocationStatusChanged(e){n.active!==e&&this.#geolocationCircle&&(W.map.removeLayer(this.#geolocationCircle),this.#geolocationCircle=null)}onGeolocationPositionChanged(t){let o=e.geoLocation.zoomToPosition;this.#geolocationCircle&&(W.map.removeLayer(this.#geolocationCircle),o=!1),this.#geolocationCircle=window.L.circleMarker(window.L.latLng(t.coords.latitude,t.coords.longitude),e.geoLocation.marker).bindTooltip(P.formatLatLng([t.coords.latitude,t.coords.longitude])).addTo(W.map),o&&W.map.setView(window.L.latLng(t.coords.latitude,t.coords.longitude),e.geoLocation.zoomFactor)}}{#RemoveFromMap(e){let t=W.mapObjects.get(e);t&&(window.L.DomEvent.off(t),W.map.removeLayer(t),W.mapObjects.delete(e))}constructor(){super(),Object.freeze(this)}updateRoute(e,t){if(p!==e){let t=_.getRoute(e);this.#RemoveFromMap(t.objId);let o=t.notes.iterator;for(;!o.done;)this.#RemoveFromMap(o.value.objId);let a=t.wayPoints.iterator;for(;!a.done;)this.#RemoveFromMap(a.value.objId)}if(p!==t){let e=this.addRoute(t),o=W.mapObjects.get(t);if(!W.travel.readOnly){window.L.DomEvent.on(o,"contextmenu",ro.handleEvent),window.L.DomEvent.on(o,"mouseover",po.handleEvent);let t=e.notes.iterator;for(;!t.done;){let e=W.mapObjects.get(t.value.objId),o=e.getLayer(e.markerId),a=e.getLayer(e.bulletId);window.L.DomEvent.on(a,"dragend",mo.handleEvent),window.L.DomEvent.on(a,"drag",go.handleEvent),window.L.DomEvent.on(a,"mouseenter",bo.handleEvent),window.L.DomEvent.on(a,"mouseleave",yo.handleEvent),window.L.DomEvent.on(o,"contextmenu",wo.handleEvent),window.L.DomEvent.on(o,"dragend",Lo.handleEvent),window.L.DomEvent.on(o,"drag",To.handleEvent)}}if(!W.travel.readOnly&&l.notEdited!==e.editionStatus){let e=W.travel.editedRoute.wayPoints.iterator;for(;!e.done;)this.addWayPoint(e.value,e.first?"A":e.last?"B":e.index)}}}updateRouteProperties(e){let t=W.mapObjects.get(e),o=_.getRoute(e);t.setStyle({color:o.color,weight:o.width,dashArray:this.getDashArray(o)})}updateNote(e,t){let o=!1;if(p!==e){let t=W.mapObjects.get(e);t&&(o=t.getLayer(t.markerId).isPopupOpen()),this.#RemoveFromMap(e)}if(p!==t){let e=this.addNote(t);o&&e.marker.openPopup(),W.travel.readOnly||(window.L.DomEvent.on(e.bullet,"dragend",mo.handleEvent),window.L.DomEvent.on(e.bullet,"drag",go.handleEvent),window.L.DomEvent.on(e.bullet,"mouseenter",bo.handleEvent),window.L.DomEvent.on(e.bullet,"mouseleave",yo.handleEvent),window.L.DomEvent.on(e.marker,"contextmenu",wo.handleEvent),window.L.DomEvent.on(e.marker,"dragend",Lo.handleEvent),window.L.DomEvent.on(e.marker,"drag",To.handleEvent))}}removeObject(e){this.#RemoveFromMap(e)}removeAllObjects(){W.mapObjects.forEach((e=>{window.L.DomEvent.off(e),W.map.removeLayer(e)})),W.mapObjects.clear()}addWayPoint(e,t){if(r.defaultValue===e.lat&&r.defaultValue===e.lng)return;let o='<div class="TravelNotes-Map-WayPoint TravelNotes-Map-WayPoint'+("A"===t?"Start":"B"===t?"End":"Via")+'"></div><div class="TravelNotes-Map-WayPointText">'+t+"</div>",a=window.L.marker(e.latLng,{icon:window.L.divIcon({iconSize:[w,w],iconAnchor:[10,w],html:o,className:"TravelNotes-Map-WayPointStyle"}),draggable:!0});a.bindTooltip((e=>_.getWayPoint(e.objId).fullName)),a.getTooltip().options.offset=[10,-10],window.L.DomEvent.on(a,"contextmenu",fo.handleEvent),a.objId=e.objId,this.addToMap(e.objId,a),window.L.DomEvent.on(a,"dragend",Eo.handleEvent)}addItineraryPointMarker(t,o){this.addToMap(t,window.L.circleMarker(o,e.itineraryPoint.marker))}addSearchPointMarker(t,o,a){let n=!1;if(a){let e=[];a.forEach((t=>{e=e.concat(t)}));let t=G.getLatLngBounds(e),o=W.map.getBounds();n=(t.getEast()-t.getWest())/(o.getEast()-o.getWest())>.01&&(t.getNorth()-t.getSouth())/(o.getNorth()-o.getSouth())>.01}n?this.addToMap(t,window.L.polyline(a,e.osmSearch.searchPointPolyline)):this.addToMap(t,window.L.circleMarker(o,e.osmSearch.searchPointMarker))}addRectangle(e,t,o){this.addToMap(e,window.L.rectangle(t,o))}setLayer(e){let t=Ce.getUrl(e);t&&super.setLayer(e,t)}};
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file IndexedDb.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/const xo=new class{#indexedDb=null;#UUID=null;#data=null;#open(e,t){if(this.#indexedDb)return void e();let o=window.indexedDB.open("TravelNotesDb",1);o.onerror=()=>{this.#indexedDb=null,t(new Error("Not possible to open the db"))},o.onsuccess=t=>{this.#indexedDb=t.target.result,e()},o.onupgradeneeded=e=>{this.#indexedDb=e.target.result,this.#indexedDb.createObjectStore("Travels",{keyPath:"UUID"})}}#read(e,t){if(!this.#indexedDb)return void t(new Error("Database not opened"));let o=this.#indexedDb.transaction(["Travels"],"readonly");o.onerror=()=>t(new Error("Transaction error")),o.objectStore("Travels").get(this.#UUID).onsuccess=t=>e(t.target.result?t.target.result.data:null)}#write(e,t){if(!this.#indexedDb)return void t(new Error("Database not opened"));let o=null;try{o=this.#indexedDb.transaction(["Travels"],"readwrite")}catch(e){return void t(e)}o.onerror=()=>t(new Error("Transaction error")),o.objectStore("Travels").put({UUID:this.#UUID,data:this.#data}).onsuccess=()=>e()}#close(){this.#indexedDb.close(),this.#indexedDb=null}constructor(){Object.freeze(this)}getOpenPromise(){return new Promise(((e,t)=>this.#open(e,t)))}getReadPromise(e){return this.#UUID=e,new Promise(((e,t)=>this.#read(e,t)))}getWritePromise(e,t){return this.#UUID=e,this.#data=t,new Promise(((e,t)=>this.#write(e,t)))}closeDb(e){if(!this.#indexedDb)return;if(!e)return void this.#close();let t=this.#indexedDb.transaction(["Travels"],"readwrite");t.onerror=()=>{};let o=t.objectStore("Travels").delete(e);o.onerror=()=>this.#close(),o.onsuccess=()=>this.#close()}};const Mo=new class{#getTravelHeaderHTML(t){let o=Z.create("div",{className:t+"Travel-Header"});x.sanitizeToHtmlElement(W.travel.name,Z.create("div",{className:t+"Travel-Header-Name"},o));let n=a.defaultValue,s=0,i=0,r=W.travel.routes.iterator;for(;!r.done;){let a=r.value.objId===W.editedRouteObjId&&e.routeEditor.showEditedRouteInRoadbook?W.travel.editedRoute:r.value;x.sanitizeToHtmlElement('<a href="#route'+a.objId+'" >'+a.computedName+"</a> : "+P.formatDistance(a.distance)+".",Z.create("div",{className:t+"Travel-Header-RouteName"},o)),a.chain&&(n+=a.distance,s+=a.itinerary.ascent,i+=a.itinerary.descent)}return x.sanitizeToHtmlElement("<span>"+M.getText("TravelHTMLViewsFactory - Travel distance")+"</span> : "+P.formatDistance(n),Z.create("div",{className:t+"Travel-Header-TravelDistance"},o)),0!==s&&x.sanitizeToHtmlElement("<span>"+M.getText("travelHTMLViewsFactory - Travel ascent")+"</span> : "+String(s.toFixed(0))+" m.",Z.create("div",{className:t+"Travel-Header-TravelAscent"},o)),0!==i&&x.sanitizeToHtmlElement("<span>"+M.getText("TravelHTMLViewsFactory - Travel descent")+"</span> : "+String(i.toFixed(0))+" m.",Z.create("div",{className:t+"Travel-Header-TravelDescent"},o)),o}#getTravelFooterHTML(e){let t=M.getText("TravelHTMLViewsFactory - Travel footer")+'<a href="https://github.com/wwwouaiebe/leaflet.TravelNotes" target="_blank" title="https://github.com/wwwouaiebe/leaflet.TravelNotes" >Travel & Notes</a>, © <a href="https://www.ouaie.be/" target="_blank" title="https://www.ouaie.be/" >wwwouaiebe 2017 2021</a> © <a href="https://www.openstreetmap.org/copyright" target="_blank" title="https://www.openstreetmap.org/copyright">'+M.getText("TravelHTMLViewsFactory - OpenStreetMap contributors")+"</a>",o=Z.create("div",{className:e+"TravelFooter"});return x.sanitizeToHtmlElement(t,o),o}constructor(){Object.freeze(this)}getTravelHTML(t){let o=Z.create("div",{className:t+"Travel"});o.appendChild(this.#getTravelHeaderHTML(t)),o.appendChild(Ue.getTravelNotesHTML(t));let a=W.travel.routes.iterator;for(;!a.done;){let n=e.routeEditor.showEditedRouteInRoadbook&&a.value.objId===W.editedRouteObjId?W.travel.editedRoute:a.value;o.appendChild(Ke.getRouteHeaderHTML(t,n)),n.itinerary.hasProfile&&o.appendChild(Ke.getRouteProfileHTML(t,n)),o.appendChild(Ke.getRouteManeuversAndNotesHTML(t,n,!1)),o.appendChild(Ke.getRouteFooterHTML(t,n))}return o.appendChild(this.#getTravelFooterHTML(t)),o}};const Po=new class{#mouseUISpan=null;#saveStatus=o.saved;#mousePosition="";#zoom="";#saveTimer=null;#updateUI(){this.#mouseUISpan&&(this.#mouseUISpan.textContent=this.#saveStatus+" "+this.#mousePosition+" - Zoom : "+this.#zoom)}constructor(){Object.freeze(this)}set saveStatus(e){o.modified===e&&o.notSaved===this.#saveStatus||(this.#saveStatus=e,o.modified!==e||this.#saveTimer||(this.#saveTimer=setTimeout((()=>this.#saveStatus=o.notSaved),3e5)),o.saved===e&&this.#saveTimer&&(clearTimeout(this.#saveTimer),this.#saveTimer=null),this.#updateUI())}createUI(){this.#mouseUISpan=Z.create("span",null,Z.create("div",{id:"TravelNotes-MouseUI"},document.body)),this.#zoom=W.map.getZoom(),this.#mousePosition=P.formatLat(e.map.center.lat)+" - "+P.formatLng(e.map.center.lng),W.map.on("mousemove",(e=>{this.#mousePosition=P.formatLatLng([e.latlng.lat,e.latlng.lng]),this.#updateUI()})),W.map.on("zoomend",(()=>{this.#zoom=String(W.map.getZoom()),this.#updateUI()}))}};const Co=new class{#python2Round(e){return Math.floor(Math.abs(e)+.5)*(0<=e?1:-1)}#encodeDelta(e,t,o){let a=this.#python2Round(e*o),n=this.#python2Round(t*o),s=a-n;s<<=1,0>a-n&&(s=~s);let i="";for(;32<=s;)i+=String.fromCharCode(63+(32|31&s)),s>>=5;return i+=String.fromCharCode(s+63),i}#index=0;#decodeDelta(e){let t=null,o=0,a=0;do{t=e.charCodeAt(this.#index++)-63,a|=(31&t)<<o,o+=5}while(32<=t);return 1&a?~(a>>1):a>>1}constructor(){Object.freeze(this)}encode(e,t){if(!e.length)return"";let o=t.length,a=Array.from(t,(e=>Math.pow(10,e))),n="";for(let t=0;t<o;t++)n+=this.#encodeDelta(e[0][t],0,a[t]);for(let t=1;t<e.length;t++){let s=e[t],i=e[t-1];for(let e=0;e<o;e++)n+=this.#encodeDelta(s[e],i[e],a[e])}return n}decode(e,t){let o=t.length;if(!e||0===e.length)return[];this.#index=0;let a=[],n=Array.from(t,(e=>Math.pow(10,e))),s=new Array(o).fill(0);for(;this.#index<e.length;){let t=new Array(o).fill(0);for(let a=0;a<o;a++)s[a]+=this.#decodeDelta(e),t[a]=s[a]/n[a];a.push(t)}return a}};class jo{#compressRoute(e){let t={};0!==e.itinerary.itineraryPoints.length&&(t=e.itinerary.itineraryPoints[0].objType);let o={values:"",objType:t},a=[];e.itinerary.itineraryPoints.forEach((e=>{a.push([e.lat,e.lng,e.distance,e.elev,e.objId])})),o.values=Co.encode(a,[r.fixed,r.fixed,2,2,0]),e.itinerary.itineraryPoints=o}#decompressRoute(e){let t=[];if(e.itinerary.itineraryPoints.values)Co.decode(e.itinerary.itineraryPoints.values,[r.fixed,r.fixed,2,2,0]).forEach((o=>{let n={lat:r.defaultValue,lng:r.defaultValue,distance:a.defaultValue,elev:i.defaultValue,objId:p};[n.lat,n.lng,n.distance,n.elev,n.objId]=o,n.objType=e.itinerary.itineraryPoints.objType,t.push(n)}));else{e.itinerary.itineraryPoints.latLngs=Co.decode(e.itinerary.itineraryPoints.latLngs,[r.fixed,r.fixed]);let o=0;e.itinerary.itineraryPoints.latLngs.forEach((a=>{let n={};n.lat=a[0],n.lng=a[1],n.distance=e.itinerary.itineraryPoints.distances[o],e.itinerary.itineraryPoints.elevs?n.elev=e.itinerary.itineraryPoints.elevs[o]:n.elev=i.defaultValue,n.objId=e.itinerary.itineraryPoints.objIds[o],n.objType=e.itinerary.itineraryPoints.objType,t.push(n),o++}))}e.itinerary.itineraryPoints=t}#decompressTravel(e){e.routes.forEach(this.#decompressRoute),e.editedRoute&&this.#decompressRoute(e.editedRoute)}constructor(){Object.freeze(this)}decompress(e){this.#decompressTravel(e),W.travel.jsonObject=e,W.editedRouteObjId=p,W.travel.routes.forEach((e=>{l.notEdited!==e.editionStatus&&(W.editedRouteObjId=e.objId)}))}decompressMerge(e){this.#decompressTravel(e);let t=new V;t.jsonObject=e;let o=t.routes.iterator;for(;!o.done;)W.travel.routes.add(o.value);let a=t.notes.iterator;for(;!a.done;)W.travel.notes.add(a.value)}compress(e){let t=e.jsonObject;return t.routes.forEach(this.#compressRoute),this.#compressRoute(t.editedRoute),t}}class Ao extends re{#removeTravelNotesInput=null;#removeRoutesNotesInput=null;#removeManeuversInput=null;#removeTravelNotesDiv=null;#removeRoutesNotesDiv=null;#removeManeuversDiv=null;#createInputDiv(e){let t=Z.create("div",null),o=Z.create("input",{type:"checkbox",checked:!1},t);return Z.create("text",{value:e},t),[t,o]}constructor(){super(),[this.#removeTravelNotesDiv,this.#removeTravelNotesInput]=this.#createInputDiv(M.getText("SaveAsDialog - Remove Travel Notes")),[this.#removeRoutesNotesDiv,this.#removeRoutesNotesInput]=this.#createInputDiv(M.getText("SaveAsDialog - Remove Routes Notes")),[this.#removeManeuversDiv,this.#removeManeuversInput]=this.#createInputDiv(M.getText("SaveAsDialog - Remove Travel Notes"))}onOk(){super.onOk(Object.freeze({removeTravelNotes:this.#removeTravelNotesInput.checked,removeRoutesNotes:this.#removeRoutesNotesInput.checked,removeManeuvers:this.#removeManeuversInput.checked}))}get contentHTMLElements(){return[this.#removeTravelNotesDiv,this.#removeRoutesNotesDiv,this.#removeManeuversDiv]}get title(){return M.getText("SaveAsDialog - SaveAs")}}const Oo=new class{#saveAsTravel(e){let t=new V;t.jsonObject=W.travel.jsonObject,t.name+="-partial";let o=t.routes.iterator;for(;!o.done;)o.value.hidden=!1;if(e.removeTravelNotes&&t.notes.removeAll(),e.removeRoutesNotes)for(o=t.routes.iterator;!o.done;)o.value.notes.removeAll();if(e.removeManeuvers)for(o=t.routes.iterator;!o.done;)o.value.itinerary.maneuvers.removeAll();let a=(new jo).compress(t);P.saveFile(a.name+".trv",JSON.stringify(a),"application/json")}constructor(){Object.freeze(this)}routeDropped(e,t,o){W.travel.routes.moveTo(e,t,o),$t.chainRoutes(),xe.dispatch("setrouteslist"),xe.dispatch("roadbookupdate")}saveAsTravel(){""!==W.travel.name?p===W.editedRouteObjId?(new Ao).show().then((e=>{this.#saveAsTravel(e)})).catch((e=>{e instanceof Error&&console.error(e)})):Me.showError(M.getText("TravelEditor - Not possible to partial save when a route is edited.")):Me.showError(M.getText("TravelEditor - Gives a name to the travel"))}saveTravel(){if(""===W.travel.name)return void Me.showError(M.getText("TravelEditor - Gives a name to the travel"));let e=W.travel.routes.iterator;for(;!e.done;)e.value.hidden=!1;let t=(new jo).compress(W.travel);P.saveFile(t.name+".trv",JSON.stringify(t),"application/json"),Po.saveStatus=o.saved}clear(){e.travelNotes.haveBeforeUnloadWarning&&!window.confirm(M.getText("TravelEditor - This page ask to close; data are perhaps not saved."))||(Wt.deleteAllProfiles(),xe.dispatch("removeallobjects"),W.travel.editedRoute=new F,W.editedRouteObjId=p,W.travel=new V,W.travel.routes.add(new F),xe.dispatch("setrouteslist"),xe.dispatch("showitinerary"),xe.dispatch("roadbookupdate"),xe.dispatch("travelnameupdated"),e.travelEditor.startupRouteEdition&&$t.editRoute(W.travel.routes.first.objId),Po.saveStatus=o.saved)}};const So=new class{#attributionsDiv=null;constructor(){Object.freeze(this)}createUI(){this.#attributionsDiv=Z.create("div",{id:"TravelNotes-AttributionsUI"},document.body)}set attributions(e){let t='© <a href="https://leafletjs.com/" target="_blank" title="Leaflet">Leaflet</a> | © <a href="https://www.openstreetmap.org/copyright" target="_blank" title="OpenStreetMap contributors">OpenStreetMap contributors</a> '+e+'| © <a href="https://github.com/wwwouaiebe" target="_blank" title="https://github.com/wwwouaiebe">Travel & Notes</a>';for(;this.#attributionsDiv.firstChild;)this.#attributionsDiv.removeChild(this.#attributionsDiv.firstChild);x.sanitizeToHtmlElement(t,this.#attributionsDiv)}};class ko{#mapLayer=null;constructor(e){this.#mapLayer=e}handleEvent(e){e.stopPropagation(),e.target.style.color=this.#mapLayer.toolbar.backgroundColor,e.target.style["background-color"]=this.#mapLayer.toolbar.color}}class Ro{#mapLayer=null;constructor(e){this.#mapLayer=e}handleEvent(e){e.stopPropagation(),e.target.style.color=this.#mapLayer.toolbar.color,e.target.style["background-color"]=this.#mapLayer.toolbar.backgroundColor}}class Ho{#mapLayer=null;constructor(e){this.#mapLayer=e}handleEvent(e){e.stopPropagation(),xe.dispatch("layerchange",{layer:this.#mapLayer}),So.attributions=this.#mapLayer.attribution,W.travel.layerName=this.#mapLayer.name}}class Bo{#buttonHTMLElement=null;#eventListeners={mouseEnter:null,mouseLeave:null,click:null};#parentNode=null;constructor(e,t){this.#parentNode=t,this.#buttonHTMLElement=Z.create("div",{className:"TravelNotes-MapLayersToolbarUI-Button",title:e.name,dataset:{MapLayerName:e.name},textContent:e.toolbar.text,style:"color:"+e.toolbar.color+";background-color:"+e.toolbar.backgroundColor},t),this.#eventListeners.mouseEnter=new ko(e),this.#eventListeners.mouseLeave=new Ro(e),this.#eventListeners.click=new Ho(e),this.#buttonHTMLElement.addEventListener("mouseenter",this.#eventListeners.mouseEnter,!1),this.#buttonHTMLElement.addEventListener("mouseleave",this.#eventListeners.mouseLeave,!1),this.#buttonHTMLElement.addEventListener("click",this.#eventListeners.click,!1)}destructor(){this.#buttonHTMLElement.removeEventListener("mouseenter",this.#eventListeners.mouseEnter,!1),this.#buttonHTMLElement.removeEventListener("mouseleave",this.#eventListeners.mouseLeave,!1),this.#buttonHTMLElement.removeEventListener("click",this.#eventListeners.click,!1),this.#parentNode.removeChild(this.#buttonHTMLElement),this.#parentNode=null}get height(){return this.#buttonHTMLElement.clientHeight}}class Uo{handleEvent(e){e.stopPropagation(),e.target.classList.add("TravelNotes-MapLayersToolbarUI-LinkButton-Enter"),e.target.classList.remove("TravelNotes-MapLayersToolbarUI-LinkButton-Leave")}}class Ko{handleEvent(e){e.stopPropagation(),e.target.classList.add("TravelNotes-MapLayersToolbarUI-LinkButton-Leave"),e.target.classList.remove("TravelNotes-MapLayersToolbarUI-LinkButton-Enter")}}class Fo{#eventListeners={mouseEnter:null,mouseLeave:null};#linkButton=null;#parentNode=null;constructor(e,t){this.#parentNode=t,this.#linkButton=Z.create("div",{className:"TravelNotes-MapLayersToolbarUI-Button TravelNotes-MapLayersToolbarUI-LinkButton-Leave"},t),Z.create("a",e,this.#linkButton),this.#eventListeners.mouseEnter=new Uo,this.#eventListeners.mouseLeave=new Ko,this.#linkButton.addEventListener("mouseenter",this.#eventListeners.mouseEnter,!1),this.#linkButton.addEventListener("mouseleave",this.#eventListeners.mouseLeave,!1)}destructor(){this.#linkButton.removeEventListener("mouseenter",this.#eventListeners.mouseEnter,!1),this.#linkButton.removeEventListener("mouseleave",this.#eventListeners.mouseLeave,!1),this.#parentNode.removeChild(this.#linkButton),this.#parentNode=null}get height(){return this.#linkButton.clientHeight}}class zo{#mapLayersToolbarUI=null;#wheelEventData=null;constructor(e,t){this.#mapLayersToolbarUI=e,this.#wheelEventData=t}handleEvent(e){e.stopPropagation(),e.deltaY&&(this.#wheelEventData.marginTop-=e.deltaY*v[e.deltaMode],this.#wheelEventData.marginTop=this.#wheelEventData.marginTop>this.#wheelEventData.buttonTop?this.#wheelEventData.buttonTop:this.#wheelEventData.marginTop,this.#wheelEventData.marginTop=this.#wheelEventData.marginTop<this.#wheelEventData.buttonTop-this.#wheelEventData.buttonsHeight+3*this.#wheelEventData.buttonHeight?this.#wheelEventData.buttonTop-this.#wheelEventData.buttonsHeight+3*this.#wheelEventData.buttonHeight:this.#wheelEventData.marginTop,this.#mapLayersToolbarUI.buttonsHTMLElement.style.marginTop=String(this.#wheelEventData.marginTop)+"px")}}const Vo=new class{#mainHTMLElement=null;#buttonsHTMLElement=null;#buttonsAndLinks=[];#wheelEventData={marginTop:0,buttonHeight:0,buttonsHeight:0,buttonTop:0};#timerId=null;#onWheelButtonsEventListener=null;#show(){if(this.#timerId)return clearTimeout(this.#timerId),void(this.#timerId=null);if(this.#buttonsHTMLElement=Z.create("div",{id:"TravelNotes-MapLayersToolbarUI-Buttons"},this.#mainHTMLElement),this.#wheelEventData.buttonTop=this.#mainHTMLElement.clientHeight,this.#wheelEventData.buttonsHeight=0,Zt.forEach((e=>{if(e.providerKeyNeeded&&Ce.hasKey(e.providerName.toLowerCase())||!e.providerKeyNeeded){let t=new Bo(e,this.#buttonsHTMLElement);this.#wheelEventData.buttonHeight=t.height,this.#wheelEventData.buttonsHeight+=t.height,this.#buttonsAndLinks.push(t)}})),e.layersToolbarUI.theDevil&&e.layersToolbarUI.theDevil.addButton){let e=new Fo({href:"https://www.google.com/maps/@"+W.map.getCenter().lat+","+W.map.getCenter().lng+","+W.map.getZoom()+"z",title:"Reminder! The devil will know everything about you",textContent:"👿",target:"_blank"},this.#buttonsHTMLElement);this.#wheelEventData.buttonsHeight+=e.height,this.#buttonsAndLinks.push(e)}this.#wheelEventData.buttonTop+=this.#wheelEventData.buttonHeight,this.#wheelEventData.marginTop=this.#wheelEventData.buttonTop,this.#buttonsHTMLElement.style.marginTop=String(this.#wheelEventData.marginTop)+"px",this.#buttonsHTMLElement.addEventListener("wheel",this.#onWheelButtonsEventListener,!1)}#hide(){this.#buttonsAndLinks.forEach((e=>e.destructor())),this.#buttonsAndLinks.length=0,this.#buttonsHTMLElement.removeEventListener("wheel",this.#onWheelButtonsEventListener,!1),this.#mainHTMLElement.removeChild(this.#buttonsHTMLElement),this.#timerId=null}#onMouseLeave(){this.#timerId=setTimeout((()=>this.#hide()),e.layersToolbarUI.toolbarTimeOut)}constructor(){this.#onWheelButtonsEventListener=new zo(this,this.#wheelEventData),Object.freeze(this)}createUI(){this.#mainHTMLElement=Z.create("div",{id:"TravelNotes-MapLayersToolbarUI"},document.body),Z.create("div",{id:"TravelNotes-MapLayersToolbarUI-Header",textContent:M.getText("MapLayersToolbarUI - Layers")},this.#mainHTMLElement),this.#mainHTMLElement.addEventListener("mouseenter",(()=>this.#show()),!1),this.#mainHTMLElement.addEventListener("mouseleave",(()=>this.#onMouseLeave()),!1),xe.dispatch("layerchange",{layer:Zt.defaultMapLayer}),So.attributions=Zt.defaultMapLayer.attribution}setMapLayer(e){let t=Zt.getMapLayer(e);xe.dispatch("layerchange",{layer:t}),So.attributions=t.attribution,W.travel.layerName=t.name}get buttonsHTMLElement(){return this.#buttonsHTMLElement}};class Wo{#display(){xe.dispatch("removeallobjects"),document.title="Travel & Notes"+(""===W.travel.name?"":" - "+W.travel.name);let e=W.travel.routes.iterator;for(;!e.done;)l.notEdited===e.value.editionStatus&&xe.dispatch("routeupdated",{removedRouteObjId:p,addedRouteObjId:e.value.objId});p!==W.editedRouteObjId&&xe.dispatch("routeupdated",{removedRouteObjId:p,addedRouteObjId:W.travel.editedRoute.objId});let t=W.travel.notes.iterator;for(;!t.done;)xe.dispatch("noteupdated",{removedNoteObjId:p,addedNoteObjId:t.value.objId});if((new Ht).zoomToTravel(),Vo.setMapLayer(W.travel.layerName),xe.dispatch("setrouteslist"),p!==W.editedRouteObjId){let e=W.travel.editedRoute.itinerary.provider;if(e&&""!==e&&!W.providers.get(e.toLowerCase()))Me.showError(M.getText("FileLoader - Not possible to select as provider",{provider:e}));else{let t=W.travel.editedRoute.itinerary.transitMode;xe.dispatch("setprovider",{provider:e}),t&&""!==t&&xe.dispatch("settransitmode",{transitMode:t})}}$t.chainRoutes(),xe.dispatch("travelnameupdated"),xe.dispatch("showitinerary"),xe.dispatch("roadbookupdate")}#openFile(e,t){try{t?(new jo).decompressMerge(e):(Wt.deleteAllProfiles(),(new jo).decompress(e)),this.#display(),t||(Po.saveStatus=o.saved)}catch(e){Me.showError("An error occurs when reading the file : "+e.message)}}constructor(){Object.freeze(this)}openLocalFile(e){this.#openFile(e,!1)}mergeLocalFile(e){this.#openFile(e,!0)}}class Go{handleEvent(e){e.stopPropagation(),Oo.saveAsTravel()}}class Xo{handleEvent(e){e.stopPropagation(),Oo.clear(),document.title="Travel & Notes"+(""===W.travel.name?"":" - "+W.travel.name)}}class _o{handleEvent(e){e.stopPropagation(),Oo.saveTravel()}}class Zo{handleEvent(e){e.stopPropagation();let t=new FileReader;t.onload=()=>{let e={};try{e=JSON.parse(t.result),(new Wo).openLocalFile(e)}catch(e){e instanceof Error&&console.error(e)}},t.readAsText(e.target.files[0])}}class Yo{handleEvent(t){t.stopPropagation(),e.travelNotes.haveBeforeUnloadWarning&&!window.confirm(M.getText("TravelEditor - This page ask to close; data are perhaps not saved."))||P.openFile(new Zo,".trv")}}class Jo{handleEvent(e){e.stopPropagation();let t=new FileReader;t.onload=()=>{let e={};try{e=JSON.parse(t.result),(new Wo).mergeLocalFile(e)}catch(e){e instanceof Error&&console.error(e)}},t.readAsText(e.target.files[0])}}class qo{handleEvent(e){e.stopPropagation(),p===W.editedRouteObjId?P.openFile(new Jo,".trv"):Me.showError(M.getText("TravelUI - Not possible to merge a travel when a route is edited"))}}class Qo{#buttonsDiv=null;#createSaveAsTravelButton(){Z.create("div",{className:"TravelNotes-UI-Button TravelNotes-TravelUI-SaveAsButton",title:M.getText("TravelUI - Save as travel"),textContent:"💾"},this.#buttonsDiv).addEventListener("click",new Go,!1)}#createCancelTravelButton(){Z.create("div",{className:"TravelNotes-UI-Button",title:M.getText("TravelUI - Cancel travel"),textContent:"❌"},this.#buttonsDiv).addEventListener("click",new Xo,!1)}#createSaveTravelButton(){Z.create("div",{className:"TravelNotes-UI-Button",title:M.getText("TravelUI - Save travel"),textContent:"💾"},this.#buttonsDiv).addEventListener("click",new _o,!1)}#createOpenTravelButton(){Z.create("div",{className:"TravelNotes-UI-Button",title:M.getText("TravelUI - Open travel"),textContent:"📂"},this.#buttonsDiv).addEventListener("click",new Yo,!1)}#createImportTravelButton(){Z.create("div",{className:"TravelNotes-UI-Button",title:M.getText("TravelUI - Import travel"),textContent:"🌏"},this.#buttonsDiv).addEventListener("click",new qo,!1)}#createRoadbookButton(){Z.create("text",{value:"📋"},Z.create("a",{className:"TravelNotes-UI-LinkButton",href:"TravelNotesRoadbook.html?lng="+e.travelNotes.language+"&page="+W.UUID,target:"_blank"},Z.create("div",{className:"TravelNotes-UI-Button",title:M.getText("TravelUI - Open travel roadbook")},this.#buttonsDiv)))}constructor(e){Object.seal(this),this.#buttonsDiv=Z.create("div",{className:"TravelNotes-UI-FlexRowDiv"},e),this.#createSaveAsTravelButton(),this.#createCancelTravelButton(),this.#createSaveTravelButton(),this.#createOpenTravelButton(),this.#createImportTravelButton(),this.#createRoadbookButton()}}class $o{constructor(){}handleEvent(e){e.preventDefault()}}class ea{constructor(){}handleEvent(e){e.stopPropagation();try{e.dataTransfer.setData("ObjId",e.target.dataset.tanObjId),e.dataTransfer.dropEffect="move"}catch(e){e instanceof Error&&console.error(e)}}}class ta{constructor(){}handleEvent(e){e.preventDefault();let t=e.target,o=t.getBoundingClientRect();Oo.routeDropped(Number.parseInt(e.dataTransfer.getData("ObjId")),Number.parseInt(t.dataset.tanObjId),e.clientY-o.top<o.bottom-e.clientY)}}class oa{constructor(){}handleEvent(e){e.stopPropagation(),e.deltaY&&(e.target.scrollTop+=e.deltaY*v[e.deltaMode]),e.stopPropagation()}}class aa{constructor(){}handleEvent(e){e.stopPropagation(),e.preventDefault(),new so(e,e.target.parentNode).show()}}class na{#routesListHTMLElement=null;#routeContextMenuEventListener=new aa;#routeDropEventListener=new ta;#routeDragStartEventListener=new ea;constructor(e){Object.seal(this),this.#routesListHTMLElement=Z.create("div",null,e),this.#routesListHTMLElement.addEventListener("dragover",new $o),this.#routesListHTMLElement.addEventListener("wheel",new oa)}toogleExpand(){return this.#routesListHTMLElement.classList.toggle("TravelNotes-Hidden"),this.#routesListHTMLElement.classList.contains("TravelNotes-Hidden")}setRoutesList(){for(;this.#routesListHTMLElement.firstChild;)this.#routesListHTMLElement.firstChild.removeEventListener("dragstart",this.#routeDragStartEventListener),this.#routesListHTMLElement.firstChild.removeEventListener("drop",this.#routeDropEventListener),this.#routesListHTMLElement.firstChild.removeEventListener("contextmenu",this.#routeContextMenuEventListener),this.#routesListHTMLElement.removeChild(this.#routesListHTMLElement.firstChild);let e=W.travel.routes.iterator;for(;!e.done;){let t=e.value.objId===W.editedRouteObjId?W.travel.editedRoute:e.value,o=(e.value.objId===W.editedRouteObjId?"🔴 ":"")+(t.chain?"⛓ ":"")+(e.value.objId===W.editedRouteObjId?W.travel.editedRoute.computedName:t.computedName),a=Z.create("div",{draggable:!0,className:"TravelNotes-TravelUI-routesListHTMLElement-Item TravelNotes-UI-MoveCursor"+(e.value.hidden?" TravelNotes-TravelUI-routesListHTMLElement-HiddenItem":""),dataset:{ObjId:t.objId},textContent:o},this.#routesListHTMLElement);a.addEventListener("dragstart",this.#routeDragStartEventListener),a.addEventListener("drop",this.#routeDropEventListener),a.addEventListener("contextmenu",this.#routeContextMenuEventListener)}}}class sa{handleEvent(e){e.stopPropagation(),W.travel.name=x.sanitizeToJsString(e.target.value),document.title="Travel & Notes"+(""===W.travel.name?"":" - "+W.travel.name),xe.dispatch("roadbookupdate")}}class ia{#routesListUI=null;constructor(e){this.#routesListUI=e}handleEvent(e){e.stopPropagation();let t=this.#routesListUI.toogleExpand();e.target.textContent=t?"▶":"▼",e.target.title=t?M.getText("TravelUI - Show"):M.getText("TravelUI - Hide")}}class ra{handleEvent(e){e.stopPropagation(),$t.addRoute()}}class la{#routesHeaderDiv=null;#travelNameInput=null;#routesListUI=null;#expandRoutesButton=null;#createTravelNameDiv(e){let t=Z.create("div",{className:"TravelNotes-UI-FlexRowDiv"},e);Z.create("span",{textContent:M.getText("TravelUI - Travel")},t),this.#travelNameInput=Z.create("input",{id:"TravelNotes-TravelUI-InputTravelName",type:"text",value:W.travel.name},t),this.#travelNameInput.addEventListener("change",new sa,!1)}#createAddRouteButton(){Z.create("div",{className:"TravelNotes-UI-Button TravelNotes-UI-FlexRow-RightButton",title:M.getText("TravelUI - Add a route"),textContent:"+"},this.#routesHeaderDiv).addEventListener("click",new ra,!1)}#createRoutesListHeaderDiv(e){this.#routesHeaderDiv=Z.create("div",{className:"TravelNotes-UI-FlexRowDiv"},e),this.#expandRoutesButton=Z.create("div",{textContent:"▼",className:"TravelNotes-TravelUI-RouteList-ExpandButton"},this.#routesHeaderDiv),Z.create("span",{textContent:M.getText("TravelUI - Travel routes")},this.#routesHeaderDiv),this.#createAddRouteButton(this.#routesHeaderDiv)}constructor(e){Object.seal(this),this.#createTravelNameDiv(e),new Qo(e),this.#createRoutesListHeaderDiv(e),this.#routesListUI=new na(e),this.#expandRoutesButton.addEventListener("click",new ia(this.#routesListUI),!1)}setTravelName(){this.#travelNameInput.value=W.travel.name}get routesListUI(){return this.#routesListUI}}class da{#paneManagerUI=null;constructor(e){this.#paneManagerUI=e}handleEvent(e){this.#paneManagerUI.showPane(e.target.dataset.tanPaneId)}}class ha{constructor(){}handleEvent(e){e.deltaY&&(e.target.scrollTop+=e.deltaY*v[e.deltaMode]),e.stopPropagation()}}class ca{#activePaneId=s.invalidPane;#panes=new Map;#paneData=null;#paneControl=null;#headerDiv=null;#removeActivePane(){s.invalidPane!==this.#activePaneId&&(this.#panes.get(this.#activePaneId).remove(),this.#paneData.textContent="")}constructor(e){Object.seal(this),this.#headerDiv=Z.create("div",{className:"TravelNotes-UI-FlexRowDiv"},e),this.#paneControl=Z.create("div",{id:"TravelNotes-PanesManagerUI-PaneControlsDiv"},e),this.#paneData=Z.create("div",{id:"TravelNotes-PanesManagerUI-PaneDataDiv"},e),this.#paneData.addEventListener("wheel",new ha)}addPane(e){let t=new e(this.#paneData,this.#paneControl);this.#panes.set(t.getPaneId(),t),Z.create("div",{textContent:t.getButtonText(),className:"TravelNotes-PanesManagerUI-PaneButton",dataset:{PaneId:t.getPaneId()}},this.#headerDiv).addEventListener("click",new da(this))}showPane(e){this.#removeActivePane(),this.#activePaneId=e,this.#panes.get(this.#activePaneId).add(),document.querySelectorAll(".TravelNotes-PanesManagerUI-PaneButton").forEach((e=>{e.dataset.tanPaneId===this.#activePaneId?e.classList.add("TravelNotes-PanesManagerUI-ActivePaneButton"):e.classList.remove("TravelNotes-PanesManagerUI-ActivePaneButton")}))}updatePane(e){e===this.#activePaneId&&this.showPane(e)}}const ua={bike:'data:image/svg+xml;utf8,<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" > <path fill="rgb(0,0,191)" d="m 11.25,3.125 v 1.09375 l 1.5625,0.9765625 V 6.5625H 7.4999999 V 5.625 h 0.625 c 1.25,0 1.25,-1.25 0,-1.25 h -2.5 c -1.25,0 -1.25,1.25 0,1.25 h 0.625 V 6.5625 L 5.0781249,8.75 c -0.026125,-5.821e-4 -0.0519,0 -0.078125,0 -2.0153538,0 -3.75,1.734646 -3.75,3.75 0,2.015354 1.7346462,3.75 3.75,3.75 2.0153537,0 3.75,-1.734646 3.75,-3.75 0,-0.432461 -0.089462,-0.858226 -0.234375,-1.25 h 0.546875 c 0.9375,0 1.1534331,-0.567495 1.4843751,-0.898437 L 12.773438,7.8125 13.4375,9.1015625 C 12.159328,9.7073948 11.25,11.031094 11.25,12.5 c 0,2.015354 1.734646,3.75 3.75,3.75 2.015354,0 3.75,-1.734646 3.75,-3.75 0,-2.015354 -1.734646,-3.75 -3.75,-3.75 -0.03934,0 -0.07808,-0.00131 -0.117187,0 L 13.75,6.5625 V 4.5703125 Z M 7.2265624,7.8125 H 11.132813 L 9.1796874,10 h -1.40625 c -0.0231,0 -0.054487,0.0026 -0.078125,0 C 7.3660586,9.6463159 6.9994024,9.3504739 6.5624999,9.140625 6.5471874,9.1173375 6.5373874,9.0856825 6.5234374,9.0625 Z M 4.9999999,10 c 1.2571387,0 2.5,1.242862 2.5,2.5 0,1.257139 -1.2428613,2.5 -2.5,2.5 -1.2571388,0 -2.5,-1.242861 -2.5,-2.5 0,-1.257138 1.2428612,-2.5 2.5,-2.5 z M 15,10 c 1.257137,0 2.5,1.242862 2.5,2.5 0,1.257139 -1.242863,2.5 -2.5,2.5 -1.257139,0 -2.5,-1.242861 -2.5,-2.5 0,-1.257138 1.242861,-2.5 2.5,-2.5 z" /></svg>',pedestrian:'data:image/svg+xml;utf8,<svg viewBox="0 0 20 20"  xmlns="http://www.w3.org/2000/svg"> <g fill="rgb(0,0,191)" transform="matrix(0.15866777,0,0,0.12627988,148.47251,-116.69398)"> <path d="m -875.5,962.4 c 2,-1.5 4.6,-2.3 7.4,-2.2 3.6,0.3 6.7,2.5 8.4,5.2 l 10.7,21.2 14.5,10.1 c 1.2,1 2,2.5 1.9,4.2 -0.1,2.6 -2.5,4.6 -5.2,4.3 -0.7,0 -1.5,-0.3 -2.2,-0.7 l -15.6,-10.7 c -0.4,-0.4 -0.9,-0.9 -1.2,-1.5 l -4.1,-7.9 -4.8,21.1 18.9,22.3 c 0.4,0.7 0.7,1.5 0.9,2.2 l 5.1,26.9 c 0,0.6 0,1 0,1.5 -0.3,4.1 -3.8,6.8 -7.7,6.7 -3.2,-0.3 -5.7,-2.6 -6.5,-5.7 l -4.8,-25.1 -15.3,-17 -3.6,16.3 c -0.1,0.7 -1.2,2.3 -1.5,2.9 l -14.6,24.9 c -1.5,2.2 -3.9,3.8 -6.7,3.4 -4.1,-0.3 -7,-3.8 -6.7,-7.7 0.1,-1.2 0.6,-2.2 1,-3.1 l 13.7,-22.8 11.4,-50.4 -7.4,6 -4.1,18 c -0.4,2.2 -2.6,4.2 -5.1,4.1 -2.6,-0.1 -4.6,-2.5 -4.5,-5.2 0,-0.1 0,-0.4 0.1,-0.6 l 4.6,-20.9 c 0.3,-0.9 0.7,-1.6 1.5,-2.2 z" /> <path d="m -884.5,943.5 c 1.3,8.6 8.7,15.3 17.8,15.3 5.7,0 10.2,-4.6 10.2,-10.2 0,-5.6 -4.6,-10.2 -10.2,-10.2 -3.9,0 -7.2,2 -8.9,5.2 -0.2,0.4 -0.5,0.7 -0.8,1 -2,2 -5.3,2 -7.3,0 -0.4,-0.4 -0.6,-0.7 -0.8,-1.1 z" /></g></svg>',car:'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" > <g fill="rgb(0,0,191)"><path d="m 2,13 a 1.7142857,1.7142857 0 0 0 1.7142857,1.714286 H 16.285714 A 1.7142857,1.7142857 0 0 0 18,13 V 9.5714286 A 1.7142857,1.7142857 0 0 0 16.285714,7.8571429 H 3.7142857 A 1.7142857,1.7142857 0 0 0 2,9.5714286 Z m 1.8285714,-2.285714 a 1.0285714,1.0285714 0 1 1 0,0.01143 z m 10.2857146,0 a 1.0285714,1.0285714 0 1 1 0,0.01143 z" /> <path d="M 4.2857143,7.8571429 V 5 A 1.7142857,1.7142857 0 0 1 6,3.2857143 h 8 A 1.7142857,1.7142857 0 0 1 15.714286,5 V 7.8571429 H 14 V 6.1428571 A 1.1428571,1.1428571 0 0 0 12.857143,5 H 7.1428571 A 1.1428571,1.1428571 0 0 0 6,6.1428571 v 1.7142858 z" /> <g transform="matrix(1.1428571,0,0,1.1428571,2,2.1428571)"><rect x="1" y="10" width="2" height="3" /><rect x="11" y="10" width="2" height="3" /></g></g></svg>',train:'data:image/svg+xml;utf8,<svg viewBox="-3 -3 20 20" xmlns="http://www.w3.org/2000/svg"> <g fill="rgb(0,0,191)"><path d="M 5,0 C 3.025911,-0.0084 1,3 1,7 l 0,2 c 0,1 1,2 2,2 l 8,0 c 1,0 2,-1 2,-2 L 13,7 C 13,3 11,0 9,0 z m -1,3 6,0 c 0,0 1,1 1,3 L 3.03125,6 C 2.994661,3.9916 4,3 4,3 z M 3,8 6,8 6,9 3,9 z m 5,0 3,0 0,1 -3,0 z m -6,4 -1,2 3,0 1,-2 z m 7,0 1,2 3,0 -1,-2 z"/></g></svg>',line:'data:image/svg+xml;utf8,<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" > <line x1="5" y1="17" x2="11" y2="2" stroke="rgb(0,0,0)" /> <line x1="3" y1="6" x2="17" y2="9" stroke="rgb(191,0,0)" /> <line x1="3" y1="16" x2="17" y2="5" stroke="rgb(255,204,0)" /> </svg>',circle:'data:image/svg+xml;utf8,<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" > <g fill="transparent"> <circle cx="8" cy="6" r="5" stroke="rgb(0,0,0)" /> <circle cx="12" cy="12" r="4" stroke="rgb(255,204,0)" /> <circle cx="14" cy="8" r="3" stroke="rgb(191,0,0)" /> </g> </svg>'};class va{#providerToolbarUI=null;#transitMode=null;#buttonHTMLElement=null;constructor(e,t){this.#providerToolbarUI=e,this.#transitMode=t,this.#buttonHTMLElement=Z.create("img",{src:ua[t],id:"TravelNotes-ProvidersToolbarUI-"+t+"ImgButton",className:"TravelNotes-ProvidersToolbarUI-ImgButton",title:M.getText("ProvidersToolbarUI - "+t)}),this.#buttonHTMLElement.addEventListener("click",this),this.visible=!1}handleEvent(e){e.stopPropagation(),this.#providerToolbarUI.transitMode=this.#transitMode,to.startRouting()}get buttonHTMLElement(){return this.#buttonHTMLElement}get transitMode(){return this.#transitMode}set active(e){e?this.#buttonHTMLElement.classList.add("TravelNotes-ProvidersToolbarUI-ActiveTransitModeImgButton"):this.#buttonHTMLElement.classList.remove("TravelNotes-ProvidersToolbarUI-ActiveTransitModeImgButton")}set visible(e){e?this.#buttonHTMLElement.classList.remove("TravelNotes-Hidden"):this.#buttonHTMLElement.classList.add("TravelNotes-Hidden")}}class pa{#providerToolbarUI=null;#provider=null;#buttonHTMLElement=null;constructor(e,t){this.#providerToolbarUI=e,this.#provider=t,this.#buttonHTMLElement=Z.create("img",{src:t.icon,id:"TravelNotes-ProvidersToolbarUI-"+t.name+"ImgButton",className:"TravelNotes-ProvidersToolbarUI-ImgButton",title:t.title||t.name}),this.#buttonHTMLElement.addEventListener("click",this)}handleEvent(e){e.stopPropagation(),this.#providerToolbarUI.provider=this.#provider.name,to.startRouting()}get buttonHTMLElement(){return this.#buttonHTMLElement}get provider(){return this.#provider}set active(e){e?this.#buttonHTMLElement.classList.add("TravelNotes-ProvidersToolbarUI-ActiveProviderImgButton"):this.#buttonHTMLElement.classList.remove("TravelNotes-ProvidersToolbarUI-ActiveProviderImgButton")}}class ma{#toolbarHTMLElement=null;#transitModeButtons=new Map;#providerButtons=new Map;#activeTransitModeButton=null;#activeProviderButton=null;#createTransitModesButtons(){["bike","pedestrian","car","train","line","circle"].forEach((e=>{let t=new va(this,e);this.#transitModeButtons.set(e,t),this.#toolbarHTMLElement.appendChild(t.buttonHTMLElement)}))}#createProvidersButtons(){W.providers.forEach((e=>{if(0!==e.providerKey){let t=new pa(this,e);this.#providerButtons.set(e.name,t),this.#toolbarHTMLElement.appendChild(t.buttonHTMLElement)}}))}constructor(e){Object.seal(this),this.#toolbarHTMLElement=Z.create("div",{className:"TravelNotes-UI-FlexRowDiv TravelNotes-ProvidersToolbarUI-ImgButtonsDiv"},e),this.#createTransitModesButtons(),this.#createProvidersButtons(),this.provider=this.#providerButtons.keys().next().value}set provider(e){W.routing.provider=e,this.#activeProviderButton&&(this.#activeProviderButton.active=!1),this.#activeProviderButton=this.#providerButtons.get(e),this.#activeProviderButton.active=!0;let t=W.providers.get(e.toLowerCase());this.#transitModeButtons.forEach((e=>{e.visible=m!==t.transitModes.indexOf(e.transitMode)})),this.#activeTransitModeButton&&m!==t.transitModes.indexOf(this.#activeTransitModeButton.transitMode)||(this.#activeTransitModeButton=null,this.#transitModeButtons.forEach((e=>{this.#activeTransitModeButton||m===t.transitModes.indexOf(e.transitMode)?e.active=!1:(this.#activeTransitModeButton=e,e.active=!0,W.routing.transitMode=e.transitMode)})))}set transitMode(e){W.routing.transitMode=e,this.#activeTransitModeButton&&(this.#activeTransitModeButton.active=!1),this.#activeTransitModeButton=this.#transitModeButtons.get(e),this.#activeTransitModeButton.active=!0}providersAdded(){for(;this.#toolbarHTMLElement.firstChild;)this.#toolbarHTMLElement.removeChild(this.#toolbarHTMLElement.firstChild);this.#transitModeButtons.clear(),this.#providerButtons.clear(),this.#createTransitModesButtons(),this.#createProvidersButtons(),this.provider=this.#providerButtons.keys().next().value}}const ga=new class{#status="geolocation"in navigator?n.inactive:n.disabled;#watchId=null;#showPosition(e){xe.dispatch("geolocationpositionchanged",{position:e})}#stop(){n.active===this.#status&&(this.#status=n.inactive),xe.dispatch("geolocationstatuschanged",{status:this.#status}),navigator.geolocation.clearWatch(this.#watchId),this.#watchId=null}#error(e){1===e.code&&(this.#status=n.refusedByUser),this.#stop()}#start(){this.#status=n.active,xe.dispatch("geolocationstatuschanged",{status:this.#status}),navigator.geolocation.getCurrentPosition(this.#showPosition,this.#error,e.geoLocation.options),this.#watchId=navigator.geolocation.watchPosition(this.#showPosition,this.#error,e.geoLocation.options)}constructor(){Object.freeze(this)}get status(){return this.#status}switch(){switch(this.#status){case n.inactive:this.#start();break;case n.active:this.#stop()}return this.#status}};class ba{handleEvent(e){e.stopPropagation(),Ce.setKeysFromDialog()}}class ya{handleEvent(e){e.stopPropagation(),ga.switch()}}class Ia{handleEvent(e){e.target.textContent="📌"===e.target.textContent?"❌":"📌",xe.dispatch("uipinned")}}class wa{#geoLocationButton=null;#buttonsDiv=null;#createHomeButton(){Z.create("text",{value:"🏠"},Z.create("a",{className:"TravelNotes-UI-LinkButton",href:window.location.origin,target:"_blank"},Z.create("div",{className:"TravelNotes-UI-Button",title:"Home"},this.#buttonsDiv)))}#createHelpButton(){Z.create("text",{value:"?"},Z.create("a",{className:"TravelNotes-UI-LinkButton",href:"https://github.com/wwwouaiebe/leaflet.TravelNotes/tree/gh-pages/TravelNotesGuides",target:"_blank"},Z.create("div",{className:"TravelNotes-UI-Button",title:"Help"},this.#buttonsDiv)))}#createContactButton(){Z.create("text",{value:"@"},Z.create("a",{className:"TravelNotes-UI-LinkButton",href:e.travelNotesToolbarUI.contactMail.url||window.location.origin,target:"_blank"},Z.create("div",{className:"TravelNotes-UI-Button",title:"Contact"},this.#buttonsDiv)))}#createApiKeysButton(){e.APIKeysDialog.showButton&&Z.create("div",{className:"TravelNotes-UI-Button",title:M.getText("TravelNotesToolbarUI - API keys"),textContent:"🔑"},this.#buttonsDiv).addEventListener("click",new ba,!1)}#createGeoLocationButton(){n.disabled<ga.status&&(this.#geoLocationButton=Z.create("div",{className:"TravelNotes-UI-Button",title:M.getText("TravelNotesToolbarUI - Geo location"),textContent:"🌐"},this.#buttonsDiv),this.#geoLocationButton.addEventListener("click",new ya,!1))}#createPinButton(){Z.create("div",{textContent:e.travelEditor.startMinimized?"📌":"❌",className:"TravelNotes-UI-Button TravelNotes-UI-FlexRow-RightButton"},this.#buttonsDiv).addEventListener("click",new Ia,!1)}constructor(e){Object.seal(this),this.#buttonsDiv=Z.create("div",{className:"TravelNotes-UI-FlexRowDiv"},e),this.#createHomeButton(),this.#createHelpButton(),this.#createContactButton(),this.#createApiKeysButton(),this.#createGeoLocationButton(),this.#createPinButton()}geoLocationStatusChanged(e){switch(e){case n.inactive:this.#geoLocationButton.classList.remove("TravelNotes-TravelNotesToolbarUI-GeoLocationButton-Striked");break;case n.active:this.#geoLocationButton.classList.add("TravelNotes-TravelNotesToolbarUI-GeoLocationButton-Striked");break;default:this.#geoLocationButton&&(this.#geoLocationButton.parentNode.removeChild(this.#geoLocationButton),this.#geoLocationButton=null)}}}class La{constructor(e,t){this.paneData=e,this.paneControl=t,Object.seal(this)}remove(){}add(){}getPaneId(){return s.invalidPane}getButtonText(){return""}}class Ta{#itineraryDataUI=null;constructor(e){this.#itineraryDataUI=e}handleEvent(e){e.stopPropagation(),this.#itineraryDataUI.toggleNotes()}}class Da{#itineraryDataUI=null;constructor(e){this.#itineraryDataUI=e}handleEvent(e){e.stopPropagation(),this.#itineraryDataUI.toggleManeuvers()}}class fa{#routeHeaderHTMLElement=null;#checkBoxesHTMLElement=null;#showNotesCheckBoxHTMLElement=null;#showManeuversCheckBoxHTMLElement=null;#showNotes=e.itineraryPaneUI.showNotes;#showManeuvers=e.itineraryPaneUI.showManeuvers;#eventListeners={onInputNotesCheckbox:null,onInputManeuverCheckbox:null};#paneControl=null;#itineraryDataUI=null;constructor(e,t){this.#paneControl=e,this.#eventListeners.onInputNotesCheckbox=new Ta(t),this.#eventListeners.onInputManeuverCheckbox=new Da(t),this.#itineraryDataUI=t}addControl(){this.#checkBoxesHTMLElement=Z.create("div",null,this.#paneControl),Z.create("text",{value:M.getText("ItineraryPaneUI - Show notes")},this.#checkBoxesHTMLElement),this.#showNotesCheckBoxHTMLElement=Z.create("input",{type:"checkbox",id:"TravelNotes-ItineraryPane-ShowNotesInput",checked:this.#showNotes},this.#checkBoxesHTMLElement),this.#showNotesCheckBoxHTMLElement.addEventListener("click",this.#eventListeners.onInputNotesCheckbox),Z.create("text",{value:M.getText("ItineraryPaneUI - Show maneuvers")},this.#checkBoxesHTMLElement),this.#showManeuversCheckBoxHTMLElement=Z.create("input",{type:"checkbox",id:"TravelNotes-ItineraryPane-ShowManeuversInput",checked:this.#showManeuvers},this.#checkBoxesHTMLElement),this.#showManeuversCheckBoxHTMLElement.addEventListener("click",this.#eventListeners.onInputManeuverCheckbox),this.#routeHeaderHTMLElement=Ke.getRouteHeaderHTML("TravelNotes-ItineraryPaneUI-",W.travel.editedRoute),this.#paneControl.appendChild(this.#routeHeaderHTMLElement),this.#showManeuvers||this.#itineraryDataUI.toggleManeuvers(),this.#showNotes||this.#itineraryDataUI.toggleNotes()}clearControl(){this.#checkBoxesHTMLElement&&(this.#showManeuversCheckBoxHTMLElement&&(this.#showManeuvers=this.#showManeuversCheckBoxHTMLElement.checked,this.#showManeuversCheckBoxHTMLElement.removeEventListener("click",this.#eventListeners.onInputManeuverCheckbox),this.#checkBoxesHTMLElement.removeChild(this.#showManeuversCheckBoxHTMLElement),this.#showManeuversCheckBoxHTMLElement=null),this.#showNotesCheckBoxHTMLElement&&(this.#showNotes=this.#showNotesCheckBoxHTMLElement.checked,this.#showNotesCheckBoxHTMLElement.addEventListener("click",this.#eventListeners.onInputNotesCheckbox),this.#checkBoxesHTMLElement.removeChild(this.#showNotesCheckBoxHTMLElement),this.#showNotesCheckBoxHTMLElement=null),this.#paneControl.removeChild(this.#checkBoxesHTMLElement),this.#checkBoxesHTMLElement=null),this.#routeHeaderHTMLElement&&(this.#paneControl.removeChild(this.#routeHeaderHTMLElement),this.#routeHeaderHTMLElement=null)}}class Ea extends Ye{constructor(e,t=null){super(e,t)}doAction(e){switch(e){case 0:(new Ht).zoomToManeuver(this.eventData.targetObjId)}}get menuItems(){return[{itemText:M.getText("ManeuverContextMenu - Zoom to this maneuver"),isActive:!0}]}}class Na{#paneData=null;constructor(e){this.#paneData=e}handleEvent(e){e.stopPropagation(),e.preventDefault();let t=e.target;for(;!t.dataset.tanObjId;)t=t.parentNode;e.target.dataset.tanObjId=t.dataset.tanObjId,new Ea(e,this.#paneData).show()}}class xa{#paneData=null;constructor(e){this.#paneData=e}handleEvent(e){e.stopPropagation(),e.preventDefault();let t=e.target;for(;!t.dataset.tanObjId;)t=t.parentNode;e.target.dataset.tanObjId=t.dataset.tanObjId,new Io(e,this.#paneData).show()}}class Ma{handleEvent(e){e.stopPropagation(),xe.dispatch("additinerarypointmarker",{objId:Number.parseInt(e.target.dataset.tanMarkerObjId),latLng:W.travel.editedRoute.itinerary.itineraryPoints.getAt(W.travel.editedRoute.itinerary.maneuvers.getAt(Number.parseInt(e.target.dataset.tanObjId)).itineraryPointObjId).latLng})}}class Pa{handleEvent(e){e.stopPropagation(),xe.dispatch("additinerarypointmarker",{objId:Number.parseInt(e.target.dataset.tanMarkerObjId),latLng:W.travel.editedRoute.notes.getAt(Number.parseInt(e.target.dataset.tanObjId)).latLng})}}class Ca{handleEvent(e){e.stopPropagation(),xe.dispatch("removeobject",{objId:Number.parseInt(e.target.dataset.tanMarkerObjId)})}}class ja{#paneData=null;#notesHTML=[];#maneuversHTML=[];#routeManeuversAndNotesHTML=null;#eventListeners={onContextMenu:null,onMouseEnter:null,onMouseLeave:null};constructor(e){this.#paneData=e,this.#eventListeners.onContextMenuManeuver=new Na(this.#paneData),this.#eventListeners.onContextMenuNote=new xa(this.#paneData),this.#eventListeners.onMouseEnterManeuver=new Ma,this.#eventListeners.onMouseEnterNote=new Pa,this.#eventListeners.onMouseLeave=new Ca}toggleNotes(){this.#notesHTML.forEach((e=>e.classList.toggle("TravelNotes-Hidden")))}toggleManeuvers(){this.#maneuversHTML.forEach((e=>e.classList.toggle("TravelNotes-Hidden")))}addData(){this.#routeManeuversAndNotesHTML=Ke.getRouteManeuversAndNotesHTML("TravelNotes-ItineraryPaneUI-",W.travel.editedRoute,!0),this.#routeManeuversAndNotesHTML.childNodes.forEach((e=>{"Maneuver"===e.dataset.tanObjType?(e.addEventListener("contextmenu",this.#eventListeners.onContextMenuManeuver),e.addEventListener("mouseenter",this.#eventListeners.onMouseEnterManeuver),e.addEventListener("mouseleave",this.#eventListeners.onMouseLeave),this.#maneuversHTML.push(e)):"Note"===e.dataset.tanObjType&&(e.addEventListener("contextmenu",this.#eventListeners.onContextMenuNote),e.addEventListener("mouseenter",this.#eventListeners.onMouseEnterNote),e.addEventListener("mouseleave",this.#eventListeners.onMouseLeave),this.#notesHTML.push(e))})),this.#paneData.appendChild(this.#routeManeuversAndNotesHTML)}clearData(){this.#maneuversHTML.forEach((e=>{e.removeEventListener("contextmenu",this.#eventListeners.onContextMenuManeuver),e.removeEventListener("mouseenter",this.#eventListeners.onMouseEnterManeuver),e.removeEventListener("mouseleave",this.#eventListeners.onMouseLeave)})),this.#maneuversHTML.length=0,this.#notesHTML.forEach((e=>{e.removeEventListener("contextmenu",this.#eventListeners.onContextMenuNote),e.removeEventListener("mouseenter",this.#eventListeners.onMouseEnterNote),e.removeEventListener("mouseleave",this.#eventListeners.onMouseLeave)})),this.#notesHTML.length=0,this.#routeManeuversAndNotesHTML&&this.#paneData.removeChild(this.#routeManeuversAndNotesHTML),this.#routeManeuversAndNotesHTML=null}}class Aa extends La{#itineraryDataUI=null;#itineraryControlUI=null;constructor(e,t){super(e,t),this.#itineraryDataUI=new ja(this.paneData),this.#itineraryControlUI=new fa(this.paneControl,this.#itineraryDataUI)}remove(){this.#itineraryDataUI.clearData(),this.#itineraryControlUI.clearControl()}add(){p!==W.editedRouteObjId&&(this.#itineraryDataUI.addData(),this.#itineraryControlUI.addControl())}getPaneId(){return s.itineraryPane}getButtonText(){return M.getText("PanesManagerUI - Itinerary")}}class Oa{constructor(){}handleEvent(e){e.stopPropagation();try{e.dataTransfer.setData("ObjId",e.target.dataset.tanObjId),e.dataTransfer.dropEffect="move"}catch(e){e instanceof Error&&console.error(e)}}}class Sa{constructor(){}handleEvent(e){e.preventDefault()}}class ka{constructor(){}handleEvent(e){e.preventDefault();let t=e.target;for(;!t.dataset.tanObjId;)t=t.parentElement;let o=t.getBoundingClientRect();Nt.travelNoteDropped(Number.parseInt(e.dataTransfer.getData("ObjId")),Number.parseInt(t.dataset.tanObjId),e.clientY-o.top<o.bottom-e.clientY)}}class Ra{#paneData=null;constructor(e){this.#paneData=e}handleEvent(e){e.stopPropagation(),e.preventDefault();let t=e.target;for(;!t.dataset.tanObjId;)t=t.parentNode;e.target.dataset.tanObjId=t.dataset.tanObjId,new Io(e,this.#paneData).show()}}class Ha extends La{#travelNotesDiv=null;#eventListeners={onDragStart:null,onDragOver:null,onDrop:null,onContextMenu:null};constructor(e,t){super(e,t),this.#eventListeners.onDragStart=new Oa,this.#eventListeners.onDragOver=new Sa,this.#eventListeners.onDrop=new ka,this.#eventListeners.onContextMenu=new Ra(e)}remove(){this.#travelNotesDiv&&(this.#travelNotesDiv.childNodes.forEach((e=>{e.removeEventListener("contextmenu",this.#eventListeners.onContextMenu,!1),e.removeEventListener("dragstart",this.#eventListeners.onDragStart,!1)})),this.paneData.removeChild(this.#travelNotesDiv)),this.#travelNotesDiv=null}add(){this.#travelNotesDiv=Ue.getTravelNotesHTML("TravelNotes-TravelNotesPaneUI-"),this.#travelNotesDiv.addEventListener("drop",this.#eventListeners.onDrop,!1),this.#travelNotesDiv.addEventListener("dragover",this.#eventListeners.onDragOver,!1),this.paneData.appendChild(this.#travelNotesDiv),this.#travelNotesDiv.childNodes.forEach((e=>{e.draggable=!0,e.addEventListener("contextmenu",this.#eventListeners.onContextMenu,!1),e.addEventListener("dragstart",this.#eventListeners.onDragStart,!1),e.classList.add("TravelNotes-UI-MoveCursor")}))}getPaneId(){return s.travelNotesPane}getButtonText(){return M.getText("PanesManagerUI - Travel notes")}}class Ba{#objId=p;constructor(e,t){this.name=x.sanitizeToJsString(e),this.items=[],this.filterTagsArray=[],this.elementTypes=["node","way","relation"],this.isSelected=!1,this.isExpanded=!1,this.isRoot=!1,t&&(this.isExpanded=!0,this.isRoot=!0),this.#objId=T.nextObjId}get objId(){return this.#objId}}const Ua=new class{#dictionary=null;#itemsMap=null;#itemsArray=[];#filterTagsArray=null;#currentItem=null;constructor(){this.#itemsMap=new Map,this.#dictionary=new Ba("All",!0),this.#itemsMap.set(this.#dictionary.objId,this.#dictionary),this.#itemsArray=[this.#dictionary.items]}#parseLine(e){let t=e.split(";");for(;""===t[t.length-1];)t.pop();let o=0,a=null;t.forEach((e=>{if(""!==e)if(m===e.indexOf("="))this.#currentItem=new Ba(e),this.#itemsMap.set(this.#currentItem.objId,this.#currentItem),this.#itemsArray[o].push(this.#currentItem),this.#itemsArray[o+1]=this.#currentItem.items,this.#filterTagsArray=this.#currentItem.filterTagsArray;else{let t=e.split("=");if("element"===t[0])this.#currentItem.elementTypes=[t[1]];else{let e={};e[t[0]]="*"===t[1]?null:t[1],a=a||[],a.push(e)}}o++})),a&&this.#filterTagsArray.push(a)}parseDictionary(e){e.split(/\r\n|\r|\n/).forEach((e=>{""!==e&&this.#parseLine(e)}))}#selectItem(e,t){e.isSelected=t,e.items.forEach((e=>{this.#selectItem(e,t)}))}selectItemObjId(e,t){let o=this.#itemsMap.get(e);this.#selectItem(o,t)}changeExpanded(e){let t=this.#itemsMap.get(e);t.isExpanded=!t.isExpanded}expandBranch(e){e.items.forEach((e=>{this.expandBranch(e)})),e.isExpanded=!0}collapseBranch(e){e.items.forEach((e=>{this.collapseBranch(e)})),e.isRoot||(e.isExpanded=!1)}clearBranch(e){e.items.forEach((e=>{this.clearBranch(e)})),e.isSelected=!1}get dictionary(){return this.#dictionary}};const Ka=new class{#searchStarted=!1;#filterItems=[];#previousSearchBounds=null;#filterOsmElement(e,t){let o=!0;return t.forEach((t=>{let[a,n]=Object.entries(t)[0];o=o&&e.tags[a]&&(!n||e.tags[a]===n)})),o}#addPointOfInterest(e,t){this.#filterItems.forEach((o=>{o.filterTagsArray.forEach((a=>{this.#filterOsmElement(e,a)&&(e.description=o.name,t.set(e.id,e))}))}))}#getSearchQueries(){let e=[],t=new Map;this.#filterItems.forEach((e=>{e.filterTagsArray.forEach((o=>{let[a,n]=Object.entries(o[0])[0],s=t.get(a);s||(s={values:new Map,elements:new Map},t.set(a,s)),s.values.set(n,n),e.elementTypes.forEach((e=>{s.elements.set(e,e)}))}))}));let o=this.#computeSearchBounds();this.#previousSearchBounds=o;let a="("+o.getSouthWest().lat.toFixed(r.fixed)+","+o.getSouthWest().lng.toFixed(r.fixed)+","+o.getNorthEast().lat.toFixed(r.fixed)+","+o.getNorthEast().lng.toFixed(r.fixed)+")";return t.forEach(((t,o)=>{let n='"'+o+'"';if(1===t.values.size){let e=t.values.values().next().value;e&&(n+='="'+e+'"')}else 1<t.values.size&&(n+='~"',t.values.forEach((e=>{n+=e+"|"})),n=n.substr(0,n.length-1)+'"');let s=1===t.elements.size?t.elements.values().next().value:"nwr";e.push(s+"["+n+"]"+a+";"+("node"===s?"":"(._;>;);")+"out;")})),e}#searchFilters(e){e.isSelected&&0<e.filterTagsArray.length&&(this.#filterItems=this.#filterItems.concat(e)),e.items.forEach((e=>this.#searchFilters(e)))}#computeSearchBounds(){let e=W.map.getCenter(),t=W.map.getBounds(),o=G.getSquareBoundingBox([e.lat,e.lng],5e3);return t.getSouthWest().lat=Math.max(t.getSouthWest().lat,o.getSouthWest().lat),t.getSouthWest().lng=Math.max(t.getSouthWest().lng,o.getSouthWest().lng),t.getNorthEast().lat=Math.min(t.getNorthEast().lat,o.getNorthEast().lat),t.getNorthEast().lng=Math.min(t.getNorthEast().lng,o.getNorthEast().lng),t}constructor(){Object.freeze(this)}async search(){if(this.#searchStarted)return;this.#searchStarted=!0,this.#filterItems=[],this.#searchFilters(Ua.dictionary);let e=new Qe({searchPlaces:!1});await e.loadData(this.#getSearchQueries());let t=new Map;[e.nodes,e.ways,e.relations].forEach((e=>{e.forEach((e=>{e.tags&&this.#addPointOfInterest(e,t)}))})),W.searchData=Array.from(t.values()).sort(((e,t)=>e.description>t.description)),this.#searchStarted=!1,xe.dispatch("showsearch")}get searchBounds(){return this.#computeSearchBounds()}get previousSearchBounds(){return this.#previousSearchBounds}};class Fa{#previousSearchLimitObjId=p;#searchLimitObjId=p;#drawSearchLimit(){p===this.#searchLimitObjId?this.#searchLimitObjId=T.nextObjId:xe.dispatch("removeobject",{objId:this.#searchLimitObjId}),xe.dispatch("addrectangle",{objId:this.#searchLimitObjId,bounds:Ka.searchBounds,properties:e.osmSearch.nextSearchLimit})}#drawPreviousSearchlimit(){let t=Ka.previousSearchBounds;t&&(p===this.#previousSearchLimitObjId?this.#previousSearchLimitObjId=T.nextObjId:xe.dispatch("removeobject",{objId:this.#previousSearchLimitObjId}),xe.dispatch("addrectangle",{objId:this.#previousSearchLimitObjId,bounds:[[t.getSouthWest().lat,t.getSouthWest().lng],[t.getNorthEast().lat,t.getNorthEast().lng]],properties:e.osmSearch.previousSearchLimit}))}show(){W.map.on("zoom",this.#drawSearchLimit,this),W.map.on("move",this.#drawSearchLimit,this),this.#drawSearchLimit(),this.#drawPreviousSearchlimit()}hide(){W.map.off("zoom",this.#drawSearchLimit,this),W.map.off("move",this.#drawSearchLimit,this),p!==this.#searchLimitObjId&&(xe.dispatch("removeobject",{objId:this.#searchLimitObjId}),this.#searchLimitObjId=p),p!==this.#previousSearchLimitObjId&&(xe.dispatch("removeobject",{objId:this.#previousSearchLimitObjId}),this.#previousSearchLimitObjId=p)}}class za extends Ye{#osmElement=null;#latLng=r.defaultValue;constructor(e,t=null){super(e,t),this.#osmElement=W.searchData[Number.parseInt(e.target.dataset.tanElementIndex)],this.#latLng=[this.#osmElement.lat,this.#osmElement.lon]}doAction(e){switch(e){case 0:oo.setStartPoint(this.#latLng);break;case 1:oo.addWayPoint(this.#latLng);break;case 2:oo.setEndPoint(this.#latLng);break;case 3:Nt.newSearchNote({osmElement:this.#osmElement,isTravelNote:!1});break;case 4:Nt.newSearchNote({osmElement:this.#osmElement,isTravelNote:!0});break;case 5:Nt.changeOsmSearchNoteDialog();break;case 6:(new Ht).zoomToPoi({latLng:this.#latLng,geometry:this.#osmElement.geometry})}}get menuItems(){return[{itemText:M.getText("MapContextMenu - Select this point as start point"),isActive:p!==W.editedRouteObjId&&r.defaultValue===W.travel.editedRoute.wayPoints.first.lat},{itemText:M.getText("MapContextMenu - Select this point as way point"),isActive:p!==W.editedRouteObjId},{itemText:M.getText("MapContextMenu - Select this point as end point"),isActive:p!==W.editedRouteObjId&&r.defaultValue===W.travel.editedRoute.wayPoints.last.lat},{itemText:M.getText("OsmSearchContextMenu - Create a route note with this result"),isActive:!0},{itemText:M.getText("OsmSearchContextMenu - Create a travel note with this result"),isActive:!0},{itemText:M.getText(Nt.osmSearchNoteDialog?"OsmSearchContextMenu - Hide note dialog":"OsmSearchContextMenu - Show note dialog"),isActive:!0},{itemText:M.getText("OsmSearchContextMenu - Zoom to this result"),isActive:!0}]}}class Va{handleEvent(e){e.stopPropagation(),e.preventDefault();let t=e.target;for(;!t.dataset.tanObjId;)t=t.parentNode;e.target.dataset.tanObjId=t.dataset.tanObjId,e.target.dataset.tanElementIndex=t.dataset.tanElementIndex,new za(e,this.paneDataDiv).show()}}class Wa{handleEvent(e){e.stopPropagation();let t=W.searchData[Number.parseInt(e.target.dataset.tanElementIndex)];xe.dispatch("addsearchpointmarker",{objId:Number.parseInt(e.target.dataset.tanObjId),latLng:[t.lat,t.lon],geometry:t.geometry})}}class Ga{handleEvent(e){e.stopPropagation(),xe.dispatch("removeobject",{objId:Number.parseInt(e.target.dataset.tanObjId)})}}class Xa{#paneData=null;#currentOsmElement=null;#currentHtmlElement=null;#elementIndex=0;#eventListeners={onContextMenu:null,onMouseEnter:null,onMouseLeave:null};#buildIcon(){let e="";e=this.#currentOsmElement.tags.rcn_ref?"<div class='TravelNotes-MapNote TravelNotes-MapNoteCategory-0073'><svg viewBox='0 0 20 20'><text class='' x=10 y=14>"+this.#currentOsmElement.tags.rcn_ref+"</text></svg></div>":Je.getIconContentFromName(this.#currentOsmElement.description)||"";let t=Z.create("div",{className:"TravelNotes-OsmSearchPaneUI-SearchResult-IconCell"},this.#currentHtmlElement);x.sanitizeToHtmlElement(e,t)}#addOsmTag(e,t){e&&Z.create("div",{textContent:e},t)}#addAddress(e){let t=(this.#currentOsmElement.tags["addr:street"]?(this.#currentOsmElement.tags["addr:housenumber"]?this.#currentOsmElement.tags["addr:housenumber"]+" ":"")+this.#currentOsmElement.tags["addr:street"]+" ":"")+(this.#currentOsmElement.tags["addr:city"]?(this.#currentOsmElement.tags["addr:postcode"]?this.#currentOsmElement.tags["addr:postcode"]+" ":"")+this.#currentOsmElement.tags["addr:city"]:"");""!==t&&this.#addOsmTag(t,e)}#addPhone(e){this.#currentOsmElement.tags.phone&&this.#addOsmTag("☎️ : "+this.#currentOsmElement.tags.phone,e)}#addMail(e){this.#currentOsmElement.tags.email&&Z.create("a",{href:"mailto:"+this.#currentOsmElement.tags.email,textContent:this.#currentOsmElement.tags.email},Z.create("div",{textContent:"📧 : "},e))}#addWebSite(e){this.#currentOsmElement.tags.website&&Z.create("a",{href:this.#currentOsmElement.tags.website,target:"_blank",textContent:this.#currentOsmElement.tags.website},Z.create("div",null,e))}#addOsmData(){let e=Z.create("div",{className:"TravelNotes-OsmSearchPaneUI-SearchResult-Cell"},this.#currentHtmlElement);this.#addOsmTag(this.#currentOsmElement.description,e),this.#addOsmTag(this.#currentOsmElement.tags.name,e),this.#addOsmTag(this.#currentOsmElement.tags.rcn_ref,e),this.#addAddress(e),this.#addPhone(e),this.#addMail(e),this.#addWebSite(e)}#addTitle(){for(const[e,t]of Object.entries(this.#currentOsmElement.tags))this.#currentHtmlElement.title+=e+"="+t+"\n"}#addEventListeners(){this.#currentHtmlElement.addEventListener("contextmenu",this.#eventListeners.onContextMenu,!1),this.#currentHtmlElement.addEventListener("mouseenter",this.#eventListeners.onMouseEnter,!1),this.#currentHtmlElement.addEventListener("mouseleave",this.#eventListeners.onMouseLeave,!1)}#buildHtmlElement(e){this.#currentHtmlElement=Z.create("div",{className:"TravelNotes-OsmSearchPaneUI-SearchResult-Row",dataset:{ObjId:T.nextObjId,ElementIndex:this.#elementIndex++}},e),this.#buildIcon(),this.#addOsmData(),this.#addTitle(),this.#addEventListeners()}constructor(e){this.#paneData=e,this.#eventListeners.onContextMenu=new Va,this.#eventListeners.onMouseEnter=new Wa,this.#eventListeners.onMouseLeave=new Ga}addData(){this.#currentOsmElement=null,this.#currentHtmlElement=null,this.#elementIndex=0,W.searchData.forEach((e=>{this.#currentOsmElement=e,this.#buildHtmlElement(this.#paneData)}))}clearData(){for(;this.#paneData.firstChild;)this.#paneData.firstChild.removeEventListener("contextmenu",this.#eventListeners.onContextMenu,!1),this.#paneData.firstChild.removeEventListener("mouseenter",this.#eventListeners.onMouseEnter,!1),this.#paneData.firstChild.removeEventListener("mouseleave",this.#eventListeners.onMouseLeave,!1),this.#paneData.removeChild(this.#paneData.firstChild)}}class _a{#osmSearchTreeUI=null;#osmSearchWaitUI=null;constructor(e,t){this.#osmSearchTreeUI=e,this.#osmSearchWaitUI=t}handleEvent(e){e.stopPropagation(),Ua.dictionary.isExpanded=!1,this.#osmSearchTreeUI.redraw(),W.searchData.length=0,xe.dispatch("showsearch"),this.#osmSearchWaitUI.showWait(),Ka.search()}}class Za{#osmSearchTreeUI=null;constructor(e){this.#osmSearchTreeUI=e}handleEvent(e){e.stopPropagation(),Ua.expandBranch(Ua.dictionary),this.#osmSearchTreeUI.redraw()}}class Ya{#osmSearchTreeUI=null;constructor(e){this.#osmSearchTreeUI=e}handleEvent(e){e.stopPropagation(),Ua.collapseBranch(Ua.dictionary),this.#osmSearchTreeUI.redraw()}}class Ja{#osmSearchTreeUI=null;constructor(e){this.#osmSearchTreeUI=e}handleEvent(e){e.stopPropagation(),Ua.clearBranch(Ua.dictionary),this.#osmSearchTreeUI.redraw()}}class qa{#toolbarHTMLElement=null;constructor(e,t){this.#toolbarHTMLElement=Z.create("div"),Z.create("div",{className:"TravelNotes-UI-Button",title:M.getText("OsmSearchPaneUI - Search OpenStreetMap"),textContent:"🔎"},this.#toolbarHTMLElement).addEventListener("click",new _a(e,t),!1),Z.create("div",{className:"TravelNotes-UI-Button",title:M.getText("OsmSearchPaneUI - Expand tree"),textContent:"▼"},this.#toolbarHTMLElement).addEventListener("click",new Za(e),!1),Z.create("div",{className:"TravelNotes-UI-Button",title:M.getText("OsmSearchPaneUI - Collapse tree"),textContent:"▶"},this.#toolbarHTMLElement).addEventListener("click",new Ya(e),!1),Z.create("div",{id:"TravelNotes-OsmSearchPaneUI-ClearAllButton",className:"TravelNotes-UI-Button",title:M.getText("OsmSearchPaneUI - Clear tree"),textContent:"❌"},this.#toolbarHTMLElement).addEventListener("click",new Ja(e),!1)}get toolbarHTMLElement(){return this.#toolbarHTMLElement}}class Qa{#osmSearchTreeUI=null;constructor(e){this.#osmSearchTreeUI=e}handleEvent(e){e.stopPropagation(),Ua.selectItemObjId(Number.parseInt(e.target.parentNode.dataset.tanObjId),e.target.checked),this.#osmSearchTreeUI.redraw()}}class $a{handleEvent(e){e.stopPropagation(),e.deltaY&&(e.target.scrollTop+=e.deltaY*v[e.deltaMode]),e.stopPropagation()}}class en{#osmSearchTreeUI=null;constructor(e){this.#osmSearchTreeUI=e}handleEvent(e){e.stopPropagation(),Ua.changeExpanded(Number.parseInt(e.target.parentNode.dataset.tanObjId)),this.#osmSearchTreeUI.redraw()}}class tn{#treeHTMLElement=null;#eventListeners={onClickArrow:null,onChangeCheckbox:null};#deepTree=0;#addItem(e){this.#deepTree++;let t=Z.create("div",{className:"TravelNotes-OsmSearchPaneUI-SearchItem TravelNotes-OsmSearchPaneUI-SearchItemMargin"+this.#deepTree,dataset:{ObjId:e.objId}},this.#treeHTMLElement);if(!e.isRoot){Z.create("input",{type:"checkbox",checked:e.isSelected},t).addEventListener("change",this.#eventListeners.onChangeCheckbox,!1)}if(0===e.filterTagsArray.length){Z.create("div",{className:"TravelNotes-UI-Button TravelNotes-OsmSearchPaneUI-TreeArrow",textContent:e.isExpanded?"▼":"▶"},t).addEventListener("click",this.#eventListeners.onClickArrow,!1)}Z.create("text",{value:e.name},t),e.isExpanded&&e.items.forEach((e=>this.#addItem(e))),this.#deepTree--}constructor(){this.#eventListeners.onChangeCheckbox=new Qa(this),this.#eventListeners.onClickArrow=new en(this),this.#treeHTMLElement=Z.create("div",{id:"TravelNotes-OsmSearchPaneUI-SearchTree"}),this.#treeHTMLElement.addEventListener("wheel",new $a,!1),Ua.dictionary.name="",this.#addItem(Ua.dictionary)}redraw(){this.#treeHTMLElement.textContent="",this.#addItem(Ua.dictionary)}get treeHTMLElement(){return this.#treeHTMLElement}}class on{#waitDiv=null;#waitBullet=null;constructor(){this.#waitDiv=Z.create("div",{className:"TravelNotes-WaitAnimation"}),this.#waitDiv.classList.add("TravelNotes-Hidden")}showWait(){this.#waitBullet=Z.create("div",{className:"TravelNotes-WaitAnimationBullet"},this.#waitDiv),this.#waitDiv.classList.remove("TravelNotes-Hidden")}hideWait(){this.#waitBullet&&(this.#waitDiv.removeChild(this.#waitBullet),this.#waitBullet=null),this.#waitDiv.classList.add("TravelNotes-Hidden")}get waitHTMLElement(){return this.#waitDiv}}class an{#osmSearchTreeUI=null;#osmSearchToolbar=null;#osmSearchWaitUI=null;#paneControl=null;constructor(e){this.#paneControl=e,this.#osmSearchTreeUI=new tn,this.#osmSearchWaitUI=new on,this.#osmSearchToolbar=new qa(this.#osmSearchTreeUI,this.#osmSearchWaitUI)}addControl(){this.#paneControl.appendChild(this.#osmSearchToolbar.toolbarHTMLElement),this.#paneControl.appendChild(this.#osmSearchTreeUI.treeHTMLElement),this.#paneControl.appendChild(this.#osmSearchWaitUI.waitHTMLElement)}clearControl(){this.#paneControl.removeChild(this.#osmSearchTreeUI.treeHTMLElement),this.#paneControl.removeChild(this.#osmSearchToolbar.toolbarHTMLElement),this.#osmSearchWaitUI.hideWait(),this.#paneControl.removeChild(this.#osmSearchWaitUI.waitHTMLElement)}}class nn extends La{#osmSearchDataUI=new Xa(this.paneData);#osmSearchControlUI=new an(this.paneControl);#osmSearchLimitsUI=new Fa;#addControls(){this.#osmSearchControlUI.addControl(this.paneControlDiv)}#addData(){this.#osmSearchDataUI.addData(this.paneDataDiv)}#clearPaneControlDiv(){this.#osmSearchControlUI.clearControl(this.paneControlDiv)}#clearPaneDataDiv(){this.#osmSearchDataUI.clearData(this.paneDataDiv)}constructor(e,t){super(e,t)}remove(){this.#osmSearchLimitsUI.hide(),this.#clearPaneDataDiv(),this.#clearPaneControlDiv()}add(){this.#osmSearchLimitsUI.show(),this.#addControls(),this.#addData()}getPaneId(){return s.searchPane}getButtonText(){return M.getText("PanesManagerUI - Search")}}const sn=new class{#mainHTMLElement=null;#travelNotesToolbarUI=null;#travelUI=null;#panesManagerUI=null;#providersToolbarUI=null;#timerId=null;#titleHTMLElement=null;#isPinned=!1;#addMouseEventListeners(){this.#mainHTMLElement.addEventListener("click",(e=>{e.target.id&&"TravelNotes-UI-MainDiv"===e.target.id&&(e.stopPropagation(),e.preventDefault())}),!1),this.#mainHTMLElement.addEventListener("dblclick",(e=>{e.stopPropagation(),e.preventDefault()}),!1),this.#mainHTMLElement.addEventListener("contextmenu",(e=>{e.stopPropagation(),e.preventDefault()}),!1),this.#mainHTMLElement.addEventListener("wheel",(e=>{e.stopPropagation(),e.preventDefault()}),!1)}#onMouseLeave(){this.#isPinned||(this.#timerId=setTimeout((()=>this.#hide()),e.travelEditor.timeout))}#show(){if(this.#isPinned)return;this.#timerId&&(clearTimeout(this.#timerId),this.#timerId=null),this.#mainHTMLElement.classList.remove("TravelNotes-UI-Minimized"),this.#titleHTMLElement.classList.add("TravelNotes-Hidden");let e=this.#mainHTMLElement.childNodes;for(let t=1;t<e.length;t++)e[t].classList.remove("TravelNotes-Hidden")}#hide(){if(this.#isPinned)return;this.#mainHTMLElement.classList.add("TravelNotes-UI-Minimized"),this.#titleHTMLElement.classList.remove("TravelNotes-Hidden");let e=this.#mainHTMLElement.childNodes;for(let t=1;t<e.length;t++)e[t].classList.add("TravelNotes-Hidden")}constructor(){Object.freeze(this)}pin(){this.#isPinned=!this.#isPinned}createUI(t){this.#mainHTMLElement||(this.#mainHTMLElement=Z.create("div",{id:"TravelNotes-UI-MainDiv"},t),this.#titleHTMLElement=Z.create("div",{id:"TravelNotes-UI-MainDiv-Title",textContent:"Travel & Notes"},this.#mainHTMLElement),this.#travelNotesToolbarUI=new wa(this.#mainHTMLElement),this.#travelUI=new la(this.#mainHTMLElement),this.#panesManagerUI=new ca(this.#mainHTMLElement),this.#panesManagerUI.addPane(Aa),this.#panesManagerUI.addPane(Ha),this.#panesManagerUI.addPane(nn),this.#providersToolbarUI=new ma(this.#mainHTMLElement),this.#mainHTMLElement.addEventListener("mouseenter",(()=>this.#show()),!1),this.#mainHTMLElement.addEventListener("mouseleave",(()=>this.#onMouseLeave()),!1),this.#addMouseEventListeners(),e.travelEditor.startMinimized?(this.#hide(),this.#isPinned=!1):(this.#show(),this.#isPinned=!0))}get travelNotesToolbarUI(){return this.#travelNotesToolbarUI}get travelUI(){return this.#travelUI}get panesManagerUI(){return this.#panesManagerUI}get providersToolbarUI(){return this.#providersToolbarUI}};class rn{constructor(){Object.freeze(this)}openDistantFile(e){(new jo).decompress(e),W.travel.readOnly=!0,document.title="Travel & Notes"+(""===W.travel.name?"":" - "+W.travel.name);let t=W.travel.routes.iterator;for(;!t.done;)l.notEdited===t.value.editionStatus&&xe.dispatch("routeupdated",{removedRouteObjId:p,addedRouteObjId:t.value.objId});p!==W.editedRouteObjId&&xe.dispatch("routeupdated",{removedRouteObjId:p,addedRouteObjId:W.travel.editedRoute.objId});let o=W.travel.notes.iterator;for(;!o.done;)xe.dispatch("noteupdated",{removedNoteObjId:p,addedNoteObjId:o.value.objId});(new Ht).zoomToTravel()}}class ln extends re{#aboutDiv=null;constructor(){super(),this.#aboutDiv=Z.create("div",{id:"TravelNotes-AboutDialog-AboutDiv"}),x.sanitizeToHtmlElement('<p>This  program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 3 of the License, or any later version.</p><p>Copyright - 2017 2021 - wwwouaiebe</p><p>Contact : <a href="https://www.ouaie.be/pages/Contact" target="_blank">https://www.ouaie.be/</a></p><p>GitHub : <a href="https://github.com/wwwouaiebe/leaflet.TravelNotes" target="_blank">https://github.com/wwwouaiebe/leaflet.TravelNotes</a></p><p>Version : 2.3.0.<p>This program uses: <a href="https://leafletjs.com/" target="_blank">leaflet</a>, <a href="https://github.com/Project-OSRM/osrm-text-instructions" target="_blank">Project-OSRM/osrm-text-instructions</a> and  <a href="https://github.com/drolbr/Overpass-API" target="_blank">the Overpass API</a></p>',this.#aboutDiv)}get contentHTMLElements(){return[this.#aboutDiv]}get title(){return M.getText("AboutDialog - About Travel & Notes")}}class dn extends Ye{#latLng=r.defaultValue;constructor(e,t=null){super(e,t),this.#latLng=[this.eventData.lat,this.eventData.lng]}doAction(e){switch(e){case 0:oo.setStartPoint(this.#latLng);break;case 1:oo.addWayPoint(this.#latLng);break;case 2:oo.setEndPoint(this.#latLng);break;case 3:$t.addRoute();break;case 4:$t.hideRoutes();break;case 5:$t.showRoutes();break;case 6:Nt.newTravelNote(this.#latLng);break;case 7:Nt.hideNotes();break;case 8:Nt.showNotes();break;case 9:(new Ht).zoomToTravel();break;case 10:(new ln).show().catch((()=>{}))}}get menuItems(){return[{itemText:M.getText("MapContextMenu - Select this point as start point"),isActive:p!==W.editedRouteObjId&&r.defaultValue===W.travel.editedRoute.wayPoints.first.lat},{itemText:M.getText("MapContextMenu - Select this point as way point"),isActive:p!==W.editedRouteObjId},{itemText:M.getText("MapContextMenu - Select this point as end point"),isActive:p!==W.editedRouteObjId&&r.defaultValue===W.travel.editedRoute.wayPoints.last.lat},{itemText:M.getText("MapContextMenu - Add a route"),isActive:!0},{itemText:M.getText("MapContextMenu - Hide all routes"),isActive:!0},{itemText:M.getText("MapContextMenu - Show all routes"),isActive:!0},{itemText:M.getText("MapContextMenu - New travel note"),isActive:!0},{itemText:M.getText("MapContextMenu - Hide all notes"),isActive:!0},{itemText:M.getText("MapContextMenu - Show all notes"),isActive:!0},{itemText:M.getText("MapContextMenu - Zoom to travel"),isActive:!0},{itemText:M.getText("MapContextMenu - About Travel & Notes"),isActive:!0}]}}const hn=new class{#travelNotesLoaded=!1;async#loadDistantTravel(e){let t=fetch(e);if(b===t.status&&t.ok){let e=await t.json();(new rn).openDistantFile(e)}else W.map.setView([r.defaultValue,r.defaultValue],2),document.title="Travel & Notes"}constructor(){Object.freeze(this)}addReadOnlyMap(e,t){this.#travelNotesLoaded||(this.#travelNotesLoaded=!0,e&&(W.map=e),So.createUI(),Vo.setMapLayer("OSM - Color"),this.#loadDistantTravel(t))}addControl(t,a){this.#travelNotesLoaded||(this.#travelNotesLoaded=!0,t&&(W.map=t,W.map.on("contextmenu",(e=>new dn(e).show()))),W.travel=new V,W.travel.routes.add(new F),sn.createUI(document.getElementById(a)),So.createUI(),Ce.setKeysFromServerFile(),e.layersToolbarUI.haveLayersToolbarUI?Vo.createUI():Vo.setMapLayer("OSM - Color"),e.mouseUI.haveMouseUI&&Po.createUI(),e.travelEditor.startupRouteEdition&&$t.editRoute(W.travel.routes.first.objId),xe.dispatch("setrouteslist"),xe.dispatch("roadbookupdate"),W.map.setView([e.map.center.lat,e.map.center.lng],e.map.zoom),Me.showHelp("<p>"+M.getText("Help - Continue with interface1")+"</p><p>"+M.getText("Help - Continue with interface2")+"</p>"),document.title="Travel & Notes",Po.saveStatus=o.saved)}addProvider(e){Ce.addProvider(e)}showInfo(e){Me.showInfo(e)}get overpassApiUrl(){return e.overpassApi.url}get map(){return W.map}get version(){return D}};class cn{#copyObjectTo(e,t){if("object"==typeof e&&"object"==typeof t){for(let o in t)"object"==typeof t[o]?this.#copyObjectTo(e[o],t[o]):typeof e[o]==typeof t[o]&&("string"==typeof t[o]?t[o]="color"===o?x.sanitizeToColor(e[o])||t[o]:"url"===o?x.sanitizeToUrl(e[o]).url:x.sanitizeToJsString(e[o]):t[o]=e[o]||t[o]);for(let o in e)"object"==typeof e[o]?("[object Array]"===Object.prototype.toString.call(e[o])?t[o]=t[o]||[]:t[o]=t[o]||{},this.#copyObjectTo(e[o],t[o])):"string"==typeof t.property?t[o]=x.sanitizeToHtmlString(e[o],[]).htmlString:t[o]=e[o]}}#freeze(e){for(let t in e)"object"==typeof e[t]&&this.#freeze(e[t]);Object.freeze(e)}overload(t){this.#copyObjectTo(t,e),this.#freeze(e)}}class un{handleEvent(){Po.saveStatus=o.modified,P.storageAvailable("localStorage")&&xo.getOpenPromise().then((()=>{xo.getWritePromise(W.UUID,Mo.getTravelHTML("TravelNotes-Roadbook-").outerHTML)})).then((()=>localStorage.setItem(W.UUID,Date.now()))).catch((e=>{e instanceof Error&&console.error(e)}))}}(new class{#travelUrl=null;#language=null;#originAndPath=window.location.href.substr(0,window.location.href.lastIndexOf("/")+1)+"TravelNotes";#errorMessage="";#addEventsListeners(){document.addEventListener("routeupdated",(e=>{e.data&&No.updateRoute(e.data.removedRouteObjId,e.data.addedRouteObjId)}),!1),document.addEventListener("routepropertiesupdated",(e=>{e.data&&No.updateRouteProperties(e.data.routeObjId)}),!1),document.addEventListener("noteupdated",(e=>{e.data&&No.updateNote(e.data.removedNoteObjId,e.data.addedNoteObjId)}),!1),document.addEventListener("removeobject",(e=>{e.data&&No.removeObject(e.data.objId)}),!1),document.addEventListener("removeallobjects",(()=>No.removeAllObjects()),!1),document.addEventListener("zoomto",(e=>{e.data&&No.zoomTo(e.data.latLng,e.data.geometry)}),!1),document.addEventListener("additinerarypointmarker",(e=>{e.data&&No.addItineraryPointMarker(e.data.objId,e.data.latLng)}),!1),document.addEventListener("addsearchpointmarker",(e=>{e.data&&No.addSearchPointMarker(e.data.objId,e.data.latLng,e.data.geometry)}),!1),document.addEventListener("addrectangle",(e=>{e.data&&No.addRectangle(e.data.objId,e.data.bounds,e.data.properties)}),!1),document.addEventListener("addwaypoint",(e=>{e.data&&No.addWayPoint(e.data.wayPoint,e.data.letter)}),!1),document.addEventListener("layerchange",(e=>{e.data&&No.setLayer(e.data.layer)})),document.addEventListener("geolocationpositionchanged",(e=>{e.data&&No.onGeolocationPositionChanged(e.data.position)}),!1),document.addEventListener("geolocationstatuschanged",(e=>{e.data&&No.onGeolocationStatusChanged(e.data.status)}),!1),document.addEventListener("roadbookupdate",new un,!1),document.addEventListener("profileclosed",(e=>{e.data&&Wt.onProfileClosed(e.data.objId)}),!1),document.addEventListener("uipinned",(()=>sn.pin()),!1),document.addEventListener("geolocationstatuschanged",(e=>{sn.travelNotesToolbarUI.geoLocationStatusChanged(e.data.status)}),!1),document.addEventListener("travelnameupdated",(()=>sn.travelUI.setTravelName()),!1),document.addEventListener("setrouteslist",(()=>sn.travelUI.routesListUI.setRoutesList()),!1),document.addEventListener("showitinerary",(()=>sn.panesManagerUI.showPane(s.itineraryPane)),!1),document.addEventListener("updateitinerary",(()=>sn.panesManagerUI.updatePane(s.itineraryPane)),!1),document.addEventListener("showtravelnotes",(()=>sn.panesManagerUI.showPane(s.travelNotesPane)),!1),document.addEventListener("updatetravelnotes",(()=>sn.panesManagerUI.updatePane(s.travelNotesPane)),!1),document.addEventListener("showsearch",(()=>sn.panesManagerUI.showPane(s.searchPane)),!1),document.addEventListener("updatesearch",(()=>sn.panesManagerUI.updatePane(s.searchPane)),!1),document.addEventListener("providersadded",(()=>sn.providersToolbarUI.providersAdded()),!1),document.addEventListener("setprovider",(e=>{e.data&&e.data.provider&&(sn.providersToolbarUI.provider=e.data.provider)}),!1),document.addEventListener("settransitmode",(e=>{e.data&&e.data.provider&&(sn.providersToolbarUI.transitMode=e.data.transitMode)}),!1)}#addUnloadEventsListeners(){window.addEventListener("unload",(()=>localStorage.removeItem(W.UUID))),window.addEventListener("beforeunload",(t=>{if(xo.closeDb(W.UUID),e.travelNotes.haveBeforeUnloadWarning)return t.returnValue="x","x"}))}#readURL(){let e=new URL(window.location),t=e.searchParams.get("fil");if(t&&0!==t.length)try{if(t=atob(t),t.match(/[^\w-%:./]/))throw new Error("invalid char in the url encoded in the fil parameter");let o=new URL(t);if(!(e.protocol&&o.protocol&&e.protocol===o.protocol&&e.hostname&&o.hostname&&e.hostname===o.hostname))throw new Error("The distant file is not on the same site than the app");this.#travelUrl=encodeURI(o.href)}catch(e){e instanceof Error&&console.error(e)}let o=e.searchParams.get("lng");o&&o.match(/^[A-Z,a-z]{2}$/)&&(this.#language=o.toLowerCase())}async#loadConfig(){let t=await fetch(this.#originAndPath+"Config.json");if(b===t.status&&t.ok){let o=await t.json();return o.travelNotes.language=this.#language||o.travelNotes.language,"wwwouaiebe.github.io"===window.location.hostname&&(o.APIKeysDialog.haveUnsecureButtons=!0,o.errorsUI.showHelp=!0,o.layersToolbarUI.theDevil.addButton=!1,o.note.maxManeuversNotes=10,o.note.haveBackground=!0,o.noteDialog.theDevil.addButton=!1,o.printRouteMap.maxTiles=120,o.route.showDragTooltip=m),(new cn).overload(o),W.providers.forEach((t=>{t.userLanguage=e.travelNotes.language})),!0}return!1}async#loadTranslations(e,t){return"fulfilled"===e.status&&b===e.value.status&&e.value.ok?(M.setTranslations(await e.value.json()),!0):"fulfilled"===t.status&&b===t.value.status&&t.value.ok?(M.setTranslations(await t.value.json()),this.#errorMessage+="Not possible to load the TravelNotes"+this.#language.toUpperCase()+".json file. English will be used. ",!0):(this.#errorMessage+="Not possible to load the translations. ",!1)}async#loadNoteDialogConfig(e,t){if("fulfilled"===e.status&&b===e.value.status&&e.value.ok){let t=await e.value.json();return Je.loadJson(t),!0}if("fulfilled"===t.status&&b===t.value.status&&t.value.ok){let e=await t.value.json();return Je.loadJson(e),this.#errorMessage+="Not possible to load the TravelNotesNoteDialog"+this.#language.toUpperCase()+".json file. English will be used. ",!0}return this.#errorMessage+="Not possible to load the translations for the note dialog. ",!1}async#loadOsmSearchDictionary(e,t){return"fulfilled"===e.status&&b===e.value.status&&e.value.ok?(Ua.parseDictionary(await e.value.text()),!0):"fulfilled"===t.status&&b===t.value.status&&t.value.ok?(Ua.parseDictionary(await t.value.text()),this.#errorMessage+="Not possible to load the TravelNotesSearchDictionary"+this.#language.toUpperCase()+".csv file. English will be used. ",!0):(this.#errorMessage+="Not possible to load the search dictionary. OSM search will not be available.",!0)}async#loadMapLayers(e){return"fulfilled"===e.status&&b===e.value.status&&e.value.ok?(Zt.addMapLayers(await e.value.json()),!0):(this.#errorMessage+="Not possible to load the TravelNotesLayers.json file. Only the OpenStreetMap background will be available. ",!0)}async#loadJsonFiles(){let e=await Promise.allSettled([fetch(this.#originAndPath+this.#language.toUpperCase()+".json"),fetch(this.#originAndPath+"EN.json"),fetch(this.#originAndPath+"NoteDialog"+this.#language.toUpperCase()+".json"),fetch(this.#originAndPath+"NoteDialogEN.json"),fetch(this.#originAndPath+"SearchDictionary"+this.#language.toUpperCase()+".csv"),fetch(this.#originAndPath+"SearchDictionaryEN.csv"),fetch(this.#originAndPath+"Layers.json")]),t=await this.#loadTranslations(e[0],e[1])&&await this.#loadNoteDialogConfig(e[2],e[3])&&await this.#loadOsmSearchDictionary(e[4],e[5])&&await this.#loadMapLayers(e[6]);return""!==this.#errorMessage&&t?Me.showError(this.#errorMessage):""!==this.#errorMessage&&(document.body.textContent=this.#errorMessage),t}#loadTravelNotes(){if(e.travelNotes.autoLoad){let e=document.createElement("div");e.id="TravelNotes-Map",document.body.appendChild(e),Z.create("div",{id:"TravelNotes-UI"},document.body);let t=window.L.map("TravelNotes-Map",{attributionControl:!1,zoomControl:!1}).setView([r.defaultValue,r.defaultValue],0);this.travelUrl?hn.addReadOnlyMap(t,this.travelUrl):(this.#addUnloadEventsListeners(),hn.addControl(t,"TravelNotes-UI")),e.focus()}}constructor(){Object.seal(this)}async loadApp(){this.#addEventsListeners(),this.#originAndPath=window.location.href.substr(0,window.location.href.lastIndexOf("/")+1)+"TravelNotes",window.TaN=hn,this.#readURL(),await this.#loadConfig()?(this.#language=this.#language||e.travelNotes.language||"fr",Me.createUI(),await this.#loadJsonFiles()&&this.#loadTravelNotes()):document.body.textContent="Not possible to load the TravelNotesConfig.json file. "}}).loadApp()}();