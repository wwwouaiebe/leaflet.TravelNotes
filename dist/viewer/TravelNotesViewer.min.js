/**
 * 
 * @source: https://github.com/wwwouaiebe/leaflet.TravelNotes
 * 
 * @licstart  The following is the entire license notice for the
 * JavaScript code in this page.
 * 
 * leaflet.travelnotes - version 3.0.0
 * Build 02783 - 2021-09-09T15:35:02+0200 
 * Copyright 2017 2021 wwwouaiebe 
 * Contact: https://www.ouaie.be/
 * License: GPL-3.0
 * 
 * The JavaScript code in this page is free software: you can
 * redistribute it and/or modify it under the terms of the GNU
 * General Public License (GNU GPL) as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option)
 * any later version.  The code is distributed WITHOUT ANY WARRANTY;
 * without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.
 * 
 * As additional permission under GNU GPL version 3 section 7, you
 * may distribute non-source (e.g., minimized or compacted) forms of
 * that code without the copy of the GNU GPL normally required by
 * section 4, provided you include this license notice and a URL
 * through which recipients can access the Corresponding Source.
 * 
 * @licend  The above is the entire license notice
 * for the JavaScript code in this page.
 * 
 */


!function(){"use strict";
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file Config.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/let e={APIKeys:{saveToSessionStorage:!0},APIKeysDialog:{haveUnsecureButtons:!0,showAPIKeys:!0,showButton:!0},contextMenu:{timeout:1500},errorsUI:{helpTimeOut:3e4,showError:!0,showHelp:!0,showInfo:!0,showWarning:!0,timeOut:1e4},geoCoder:{distances:{city:1200,hamlet:200,town:1500,village:400},osmCityAdminLevel:{DEFAULT:"8",GB:"10"}},geoLocation:{marker:{color:"#ff0000",radius:11},options:{enableHighAccuracy:!1,maximumAge:0,timeout:1/0},zoomFactor:17,zoomToPosition:!0},itineraryPaneUI:{showManeuvers:!1,showNotes:!0},itineraryPoint:{marker:{color:"#ff0000",fill:!1,radius:7,weight:2},zoomFactor:17},layersToolbarUI:{haveLayersToolbarUI:!0,toolbarTimeOut:1500,theDevil:{addButton:!1}},map:{center:{lat:50.50923,lng:5.49542},zoom:12},mouseUI:{haveMouseUI:!0},nominatim:{url:"https://nominatim.openstreetmap.org/",language:"*"},note:{grip:{size:10,opacity:0,moveOpacity:1},haveBackground:!1,maxManeuversNotes:100,polyline:{color:"#808080",weight:1},reverseGeocoding:!1,svgIcon:{angleDistance:10,angleDirection:{right:35,slightRight:80,continue:100,slightLeft:145,left:200,sharpLeft:270,sharpRight:340},rcnRefDistance:20,roadbookFactor:1,zoom:17}},noteDialog:{areaHeight:{icon:2,popupContent:8},mask:{iconsDimension:!0,iconTextArea:!1,tooltip:!1,popupContent:!1,address:!1,link:!1,phone:!0},theDevil:{addButton:!1,zoomFactor:17}},osmSearch:{nextSearchLimit:{color:"#ff0000",fill:!1,weight:1},previousSearchLimit:{color:"#006400",fill:!1,weight:1},searchPointMarker:{color:"#006400",fill:!1,radius:20,weight:4},searchPointPolyline:{color:"#006400",fill:!1,weight:4},showSearchNoteDialog:!1},overpassApi:{useNwr:!0,timeOut:40,url:"https://lz4.overpass-api.de/api/interpreter"},printRouteMap:{isEnabled:!0,maxTiles:240,paperWidth:287,paperHeight:200,pageBreak:!1,printNotes:!0,borderWidth:30,zoomFactor:15,entryPointMarker:{color:"#00ff00",weight:4,radius:10,fill:!0,fillOpacity:1},exitPointMarker:{color:"#ff0000",weight:4,radius:10,fill:!0,fillOpacity:1}},route:{color:"#ff0000",dashArray:0,dashChoices:[{text:"——————",iDashArray:[0]},{text:"— — — — —",iDashArray:[4,2]},{text:"—‧—‧—‧—‧—",iDashArray:[4,2,0,2]},{text:"················",iDashArray:[0,2]}],elev:{smooth:!0,smoothCoefficient:.25,smoothPoints:3},showDragTooltip:3,width:3},routeEditor:{showEditedRouteInRoadbook:!0},travelEditor:{startMinimized:!0,startupRouteEdition:!0,timeout:1e3},travelNotes:{autoLoad:!0,haveBeforeUnloadWarning:!0,language:"fr"},travelNotesToolbarUI:{contactMail:{url:"https://github.com/wwwouaiebe/leaflet.TravelNotes/issues"}},wayPoint:{reverseGeocoding:!1,geocodingIncludeName:!1}};
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file Constants.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/Object.freeze({minColorValue:0,maxColorValue:255,rowsNumber:6,cellsNumber:6,deltaColor:51,sliderMaxValue:100,sliderStep:20,initialRed:0}),Object.freeze({notSaved:"🔴",modified:"🟡",saved:"🟢"});const t=Object.freeze({fixed:2,invalid:-1,defaultValue:0,metersInKm:1e3}),s=Object.freeze({refusedByUser:-1,disabled:0,inactive:1,active:2});Object.freeze({invalidPane:"43a6a53e-008a-4910-80a6-7a87d301ea15",itineraryPane:"8fbf0da7-4e6f-4bc7-8e20-1388461ccde7",travelNotesPane:"dffe782b-07df-4b81-a318-f287c0cf5ec6",searchPane:"228f00d7-43a8-4c13-897d-70400cb6dd58"});const o=Object.freeze({fixed:2,defaultValue:0}),i=Object.freeze({defaultValue:0,fixed:6,maxLat:90,minLat:-90,maxLng:180,minLng:-180}),r=Object.freeze({notEdited:0,editedNoChange:1,editedChanged:2}),a=Object.freeze({margin:100,height:500,width:1e3,yDeltaText:30,xDeltaText:10,vScales:[1,2,5,10,20,50,100,200,500,1e3,2e3,5e3],hScales:[1,2,5,10,20,50,100,200,500,1e3,2e3,5e3,1e4,2e4,5e4,1e5]}),n=Object.freeze({width:40,height:40,svgViewboxDim:200}),l=Object.freeze({d0:0,d90:90,d180:180,d270:270,d360:360,d540:540,toRadians:Math.PI/180,fromRadians:180/Math.PI});Object.freeze({atStart:-1,onRoute:0,atEnd:1});const d=-1,h=-1,c=200,u="http://www.w3.org/2000/svg",p=6371e3,g=20;const _=Object.freeze(new class{_validityMap=new Map;_parser=new DOMParser;_addHtmlEntities(e){return e.replaceAll(/</g,"&lt;").replaceAll(/>/g,"&gt;").replaceAll(/"/g,"&quot;").replaceAll(/\u0027/g,"&apos;").replaceAll(/\u0a00/g,"&nbsp;")}_stringify(e){let t="",s="",o=e.childNodes;for(let i=0;i<o.length;i++){let o=e.childNodes[i],r=o.nodeName.toLowerCase(),a=this._validityMap.get(r);if(a){a=a.concat(["id","class","dir","title","tanwidth","tanheight"]);let e="svg"===r||"text"===r||"polyline"===r;t+="<"+r,o.hasAttribute("target")&&(t+=' rel="noopener noreferrer"'),a.forEach((i=>{if(e)o.hasAttributeNS(null,i)&&(t+=" "+i+'="'+this._addHtmlEntities(o.getAttribute(i))+'"',o.removeAttribute(i));else if(o.hasAttribute(i))if("href"===i||"src"===i){let e=this.sanitizeToUrl(o.getAttribute(i),i).url;""===e?s+="\nAn invalid url ("+o.getAttribute(i)+") was removed from a "+i+" attribute":t+=" "+i+'="'+e+'"',o.removeAttribute(i)}else t+=" "+i+'="'+this._addHtmlEntities(o.getAttribute(i))+'"',o.removeAttribute(i)})),t+=">";let i="",n="";[i,n]=this._stringify(o),t+=i,s+=n,t+="</"+r+">"}else"#text"===r?t+=this._addHtmlEntities(o.nodeValue):s+="\nAn invalid tag "+r+" was removed";if(o.hasAttributes)for(let e=0;e<o.attributes.length;e++)"rel"!==o.attributes[e].name&&(s+="\nAn unsecure attribute "+o.attributes[e].name+'="'+o.attributes[e].value+'" was removed.')}return[t,s]}_cloneNode(e,t){let s=e.childNodes;for(let o=0;o<s.length;o++){let s=e.childNodes[o],i=s.nodeName.toLowerCase(),r=this._validityMap.get(i);if(r){r=r.concat(["id","class","dir","title","tanwidth","tanheight"]);let e="svg"===i||"text"===i||"polyline"===i,o=e?document.createElementNS(u,i):document.createElement(i);if(r.forEach((t=>{if(e)s.hasAttributeNS(null,t)&&(o.setAttributeNS(null,t,s.getAttribute(t)),s.removeAttributeNS(null,t));else if(s.hasAttribute(t))if("href"===t||"src"===t){let e=this.sanitizeToUrl(s.getAttribute(t),t).url;""!==e&&o.setAttribute(t,e)}else o.setAttribute(t,s.getAttribute(t))})),s.hasAttribute("style")){s.getAttribute("style").split(";").forEach((e=>{let t=e.split(":");2!==t.length||"width"!==t[0].trim()&&"height"!==t[0].trim()||(o.style[t[0].trim()]=t[1].trim())}))}s.hasAttribute("target")&&o.setAttribute("rel","noopener noreferrer"),t.appendChild(o),this._cloneNode(s,o)}else"#text"===i&&t.appendChild(document.createTextNode(s.nodeValue))}}constructor(){this._validityMap.set("a",["href","target"]),this._validityMap.set("div",[]),this._validityMap.set("del",[]),this._validityMap.set("em",[]),this._validityMap.set("figcaption",[]),this._validityMap.set("figure",[]),this._validityMap.set("h1",[]),this._validityMap.set("h2",[]),this._validityMap.set("h3",[]),this._validityMap.set("h4",[]),this._validityMap.set("h5",[]),this._validityMap.set("h6",[]),this._validityMap.set("hr",[]),this._validityMap.set("img",["src","alt","width","height"]),this._validityMap.set("ins",[]),this._validityMap.set("li",[]),this._validityMap.set("mark",[]),this._validityMap.set("ol",[]),this._validityMap.set("p",[]),this._validityMap.set("s",[]),this._validityMap.set("small",[]),this._validityMap.set("strong",[]),this._validityMap.set("span",[]),this._validityMap.set("sub",[]),this._validityMap.set("sup",[]),this._validityMap.set("ul",[]),this._validityMap.set("svg",["xmlns","viewBox","class"]),this._validityMap.set("text",["x","y","text-anchor"]),this._validityMap.set("polyline",["points","class","transform"])}sanitizeToColor(e){let t=e.match(/^\u0023[0-9,A-F,a-f]{6}$/);return t?t[0]:null}sanitizeToUrl(e,t="href"){let s=this._parser.parseFromString("<div>"+e+"</div>","text/html");if(!s||"#document"!==s.nodeName)return{url:"",errorsString:"Parsing error"};let o=s.body.firstChild,i="";for(let e=0;e<o.childNodes.length;e++){if("#text"!==o.childNodes[e].nodeName)return{url:"",errorsString:"Invalid characters found in the url"};i+=o.childNodes[e].nodeValue}if(i=i.replaceAll(/</g,"").replaceAll(/>/g,"").replaceAll(/"/g,"").replaceAll(/\u0027/g,"").replaceAll(/&lt;/g,"").replaceAll(/&gt;/g,"").replaceAll(/&quot;/g,"").replaceAll(/&apos;/g,"").replaceAll(/%3C/g,"").replaceAll(/%3c/g,"").replaceAll(/%3E/g,"").replaceAll(/%3e/g,"").replaceAll(/%22/g,"").replaceAll(/%27/g,""),i!==e)return{url:"",errorsString:"Invalid characters found in the url"};let r=["https:"];if("http:"!==window.location.protocol&&"href"!==t||r.push("http:"),"href"===t){r.push("mailto:"),r.push("sms:"),r.push("tel:");let e=i.match(/^\u0023\w*/);if(e&&i===e[0])return{url:i,errorsString:""}}"src"===t&&r.push("data:");let a=null;try{a=new URL(i)}catch(e){return{url:"",errorsString:"Invalid url string"}}if(h===r.indexOf(a.protocol))return{url:"",errorsString:"Invalid protocol "+a.protocol};if(h!==["sms:","tel:"].indexOf(a.protocol)&&a.pathname.match(/^\+[0-9,*,\u0023]*$/))return{url:i,errorsString:""};try{encodeURIComponent(a.href)}catch(e){return{url:"",errorsString:"Invalid character in url"}}return{url:i,errorsString:""}}sanitizeToJsString(e){let t=this._parser.parseFromString("<div>"+e+"</div>","text/html");if(!t||"#document"!==t.nodeName)return"";let s=t.body.firstChild,o="";for(let e=0;e<s.childNodes.length;e++){if("#text"!==s.childNodes[e].nodeName)return"";o+=s.childNodes[e].nodeValue}return o=o.replaceAll(/</g,"≺").replaceAll(/>/g,"≻").replaceAll(/"/g,"″").replaceAll(/\u0027/g,"′"),o}sanitizeToHtmlElement(e,t){let s=this._parser.parseFromString("<div>"+e+"</div>","text/html");s&&"#document"===s.nodeName?this._cloneNode(s.body.firstChild,t):t.textContent=""}clone(e){let t=document.createElement(e.tagName);return this._cloneNode(e,t),t}sanitizeToHtmlString(e){let t="",s="",o=this._parser.parseFromString("<div>"+e.replace("&nbsp;","਀")+"</div>","text/html");return o&&"#document"===o.nodeName?([t,s]=this._stringify(o.body.firstChild,s),{htmlString:t,errorsString:s}):{htmlString:"",errorsString:"Parsing error"}}});class m{_copyObjectTo(e,t){if("object"==typeof e&&"object"==typeof t){for(let s in t)"object"==typeof t[s]?this._copyObjectTo(e[s],t[s]):typeof e[s]==typeof t[s]&&("string"==typeof t[s]?t[s]="color"===s?_.sanitizeToColor(e[s])||t[s]:"url"===s?_.sanitizeToUrl(e[s]).url:_.sanitizeToJsString(e[s]):t[s]=e[s]||t[s]);for(let s in e)"object"==typeof e[s]?("[object Array]"===Object.prototype.toString.call(e[s])?t[s]=t[s]||[]:t[s]=t[s]||{},this._copyObjectTo(e[s],t[s])):"string"==typeof t.property?t[s]=_.sanitizeToHtmlString(e[s],[]).htmlString:t[s]=e[s]}}_freeze(e){for(let t in e)"object"==typeof e[t]&&this._freeze(e[t]);Object.freeze(e)}constructor(){}overload(t){this._copyObjectTo(t,e),this._freeze(e)}}class v{static _objId=0;static get nextObjId(){return++v._objId}}
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file Version.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/const y="2.3.0";class b{_objTypeName="";_validObjTypeNames=["Itinerary","ItineraryPoint","Maneuver","Note","Route","Travel","WayPoint"];constructor(e){if(h===this._validObjTypeNames.indexOf(e))throw new Error("Invalid ObjType name : "+e);this._objTypeName=e}get name(){return this._objTypeName}get version(){return y}get jsonObject(){return{name:this._objTypeName,version:y}}validate(e){if(!Object.getOwnPropertyNames(e).includes("name"))throw new Error("No name for "+this._objTypeName);if(this._objTypeName!==e.name)throw new Error("Invalid name for "+this._objTypeName);if(!Object.getOwnPropertyNames(e).includes("version"))throw new Error("No version for "+this._objTypeName)}}class f{_collection=null;_index=h;constructor(e){this._collection=e}get value(){return this._index<this._collection.length?this._collection.at(this._index):null}get previous(){return 0>=this._index?null:this._collection.at(this._index-1)}get next(){return this._index<this._collection.length-1?this._collection.at(this._index+1):null}get done(){return++this._index>=this._collection.length}get first(){return 0===this._index}get last(){return this._index>=this._collection.length-1}get index(){return this._index}}class w{_array=[];_objName="";_classCollection=null;_indexOfObjId(e){return this._array.findIndex((t=>t.objId===e))}_nextOrPrevious(e,t,s){let o=this._indexOfObjId(e);if(h===o)throw new Error("invalid objId for next or previous function");if(1!==s&&-1!==s)throw new Error("invalid direction");let i=t;for(i||(i=()=>!0),o+=s;h<o&&o<this._array.length&&!i(this._array[o]);)o+=s;return h===o||this._array.length===o?null:this._array[o]}constructor(e){this._classCollection=e;let t=new e;if(!t.objType||!t.objType.name)throw new Error("invalid object name for collection");this._objName=t.objType.name}add(e){if(!e.objType||!e.objType.name||e.objType.name!==this._objName)throw new Error("invalid object name for add function");this._array.push(e)}at(e){return e<this._array.length&&e>h?this._array[e]:null}forEach(e){let t=null,s=this.iterator;for(;!s.done;)t=e(s.value,t);return t}getAt(e){let t=this._indexOfObjId(e);return h===t?null:this._array[t]}moveTo(e,t,s){let o=this._indexOfObjId(e),i=this._indexOfObjId(t);if(h===o||h===i)throw new Error("invalid objId for function  myMoveTo");s||i++,this._array.splice(i,0,this._array[o]),i<o&&o++,this._array.splice(o,1)}next(e,t){return this._nextOrPrevious(e,t,1)}previous(e,t){return this._nextOrPrevious(e,t,-1)}remove(e){let t=this._indexOfObjId(e);if(h===t)throw new Error("invalid objId for remove function");this._array.splice(this._indexOfObjId(e),1)}removeAll(e){e?this._array.splice(1,this._array.length-2):this._array.length=0}replace(e,t){let s=this._indexOfObjId(e);if(h===s)throw new Error("invalid objId for replace function");if(!t.objType||!t.objType.name||t.objType.name!==this._objName)throw new Error("invalid object name for replace function");this._array[s]=t}reverse(){this._array.reverse()}sort(e){this._array.sort(e)}swap(e,t){let s=this._indexOfObjId(e);if(h===s||0===s&&t||this._array.length-1===s&&!t)throw new Error("invalid objId for swap function");let o=this._array[s];this._array[s]=this._array[s+(t?-1:1)],this._array[s+(t?-1:1)]=o}get first(){return this._array[0]}get iterator(){return new f(this)}get last(){return this._array[this._array.length-1]}get length(){return this._array.length}get jsonObject(){let e=[],t=this.iterator;for(;!t.done;)e.push(t.value.jsonObject);return e}set jsonObject(e){this._array.length=0;let t=null;e.forEach((e=>{t=new this._classCollection,t.jsonObject=e,this.add(t)}))}}const I=new class{_translations=new Map;constructor(){}setTranslations(e){e.forEach((e=>this._translations.set(e.msgid,_.sanitizeToJsString(e.msgstr))))}getText(e,t){let s=this._translations.get(e);return t&&s&&Object.getOwnPropertyNames(t).forEach((e=>s=s.replace("{"+e+"}",t[e]))),s||e}};const T=new class{constructor(){}get UUID(){let e=new Uint8Array(16);const t=["","","","-","","-","","-","","-","","","","","",""];window.crypto.getRandomValues(e),e[6]=15&e[6]|64,e[8]=63&e[8]|128;let s="";for(let o=0;o<16;o++)s+=e[o].toString(16).padStart(2,"0")+t[o];return s}storageAvailable(e){try{let t=window[e],s="__storage_test__";return t.setItem(s,s),t.removeItem(s),!0}catch(e){return!1}}openFile(e,t){let s=document.createElement("input");s.type="file",t&&(s.accept=t),s.addEventListener("change",e,!1),s.click()}saveFile(e,t,s){try{let o=null;o=s?window.URL.createObjectURL(new File([t],e,{type:s})):URL.createObjectURL(t);let i=document.createElement("a");i.setAttribute("href",o),i.setAttribute("download",e),i.click(),window.URL.revokeObjectURL(o)}catch(e){e instanceof Error&&console.error(e)}}formatTime(e){let t=Math.floor(e);if(0===t)return"";let s=Math.floor(t/86400),o=Math.floor(t%86400/3600),i=Math.floor(t%3600/60),r=Math.floor(t%60);return 0<s?s+" "+I.getText("Utilities - Day")+" "+o+" "+I.getText("Utilities - Hour"):0<o?o+" "+I.getText("Utilities - Hour")+" "+i+" "+I.getText("Utilities - Minute"):0<i?i+" "+I.getText("Utilities - Minute"):r+" "+I.getText("Utilities - Second")}formatDistance(e){let s=Math.floor(e);return 0>=s?"0 km":Math.floor(s/t.metersInKm)+","+Math.floor(s%t.metersInKm/10).toFixed(0).padStart(2,"0").padEnd(3,"0")+" km"}formatLat(e){return e>0?e.toFixed(i.fixed)+" N":(-e).toFixed(i.fixed)+" S"}formatLng(e){return e>0?e.toFixed(i.fixed)+" E":(-e).toFixed(i.fixed)+" W"}formatLatLng(e){return 0===e[0]&&0===e[1]?"":this.formatLat(e[0])+" - "+this.formatLng(e[1])}},L=new b("WayPoint");class E{_objId=d;_upgradeObject(e){switch(e.objType.version){case"1.0.0":case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":case"1.5.0":case"1.6.0":case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":e.address=e.name,e.name="";case"1.12.0":case"1.13.0":case"2.0.0":case"2.1.0":case"2.2.0":e.objType.version="2.3.0";break;default:throw new Error("invalid version for "+L.name)}}_validateObject(e){if(!Object.getOwnPropertyNames(e).includes("objType"))throw new Error("No objType for "+L.name);L.validate(e.objType),L.version!==e.objType.version&&this._upgradeObject(e);let t=Object.getOwnPropertyNames(e);return["address","name","lat","lng","objId"].forEach((e=>{if(!t.includes(e))throw new Error("No "+e+" for "+L.name)})),e}constructor(){this.name="",this.address="",this.lat=i.defaultValue,this.lng=i.defaultValue,this._objId=v.nextObjId}get fullName(){let e=""===this.name?this.address:this.name+", "+this.address;return""===e&&(e=T.formatLatLng([this.lat,this.lng])),e}get latLng(){return[this.lat,this.lng]}set latLng(e){this.lat=e[0],this.lng=e[1]}get objId(){return this._objId}get objType(){return L}get jsonObject(){return{name:this.name,address:this.address,lat:parseFloat(this.lat.toFixed(i.fixed)),lng:parseFloat(this.lng.toFixed(i.fixed)),objId:this._objId,objType:L.jsonObject}}set jsonObject(e){let t=this._validateObject(e);this.address=t.address||"",this.name=t.name||"",this.lat=t.lat||i.defaultValue,this.lng=t.lng||i.defaultValue,this._objId=v.nextObjId,this.validateData()}validateData(){"string"==typeof this.address?this.address=_.sanitizeToJsString(this.address):this.address="","string"==typeof this.name?this.name=_.sanitizeToJsString(this.name):this.name="","number"!=typeof this.lat&&(this.lat=i.defaultValue),"number"!=typeof this.lng&&(this.lng=i.defaultValue)}}const P=new b("ItineraryPoint");class N{_objId=d;_upgradeObject(e){switch(e.objType.version){case"1.0.0":case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":case"1.5.0":case"1.6.0":e.elev=o.defaultValue;case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":case"1.12.0":case"1.13.0":case"2.0.0":case"2.1.0":case"2.2.0":e.objType.version="2.3.0";break;default:throw new Error("invalid version for "+P.name)}}_validateObject(e){if(!Object.getOwnPropertyNames(e).includes("objType"))throw new Error("No objType for "+P.name);P.validate(e.objType),P.version!==e.objType.version&&this._upgradeObject(e);let t=Object.getOwnPropertyNames(e);return["lat","lng","distance","elev","objId"].forEach((e=>{if(!t.includes(e))throw new Error("No "+e+" for "+P.name)})),e}constructor(){this.lat=i.defaultValue,this.lng=i.defaultValue,this.distance=t.defaultValue,this.elev=o.defaultValue,this._objId=v.nextObjId}get latLng(){return[this.lat,this.lng]}set latLng(e){this.lat=e[0],this.lng=e[1]}get objType(){return P}get objId(){return this._objId}get jsonObject(){return{lat:parseFloat(this.lat.toFixed(i.fixed)),lng:parseFloat(this.lng.toFixed(i.fixed)),distance:parseFloat(this.distance.toFixed(t.fixed)),elev:parseFloat(this.elev.toFixed(o.fixed)),objId:this._objId,objType:P.jsonObject}}set jsonObject(e){let s=this._validateObject(e);this.lat=s.lat||i.defaultValue,this.lng=s.lng||i.defaultValue,this.distance=s.distance||t.defaultValue,this.elev=s.elev||o.defaultValue,this._objId=v.nextObjId,this.validateData()}validateData(){"number"!=typeof this.lat&&(this.lat=i.defaultValue),"number"!=typeof this.lng&&(this.lng=i.defaultValue),"number"!=typeof this.distance&&(this.distance=t.defaultValue),"number"!=typeof this.elev&&(this.elev=o.defaultValue)}}const D=new b("Maneuver");class j{_objId=d;_upgradeObject(e){switch(e.objType.version){case"1.0.0":case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":case"1.5.0":case"1.6.0":case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":"kArriveDefault"===e.iconName&&(e.distance=t.defaultValue);case"1.12.0":case"1.13.0":case"2.0.0":case"2.1.0":case"2.2.0":e.objType.version="2.3.0";break;default:throw new Error("invalid version for "+D.name)}}_validateObject(e){if(!Object.getOwnPropertyNames(e).includes("objType"))throw new Error("No objType for "+D.name);D.validate(e.objType),D.version!==e.objType.version&&this._upgradeObject(e);let t=Object.getOwnPropertyNames(e);return["iconName","instruction","distance","duration","itineraryPointObjId","objId"].forEach((e=>{if(!t.includes(e))throw new Error("No "+e+" for "+D.name)})),e}constructor(){this.iconName="",this.instruction="",this.itineraryPointObjId=d,this.distance=t.defaultValue,this.duration=t.defaultValue,this._objId=v.nextObjId}get objType(){return D}get objId(){return this._objId}get jsonObject(){return{iconName:this.iconName,instruction:this.instruction,distance:parseFloat(this.distance.toFixed(t.fixed)),duration:this.duration,itineraryPointObjId:this.itineraryPointObjId,objId:this._objId,objType:D.jsonObject}}set jsonObject(e){let s=this._validateObject(e);this.iconName=s.iconName||"",this.instruction=s.instruction||"",this.distance=s.distance||t.defaultValue,this.duration=s.duration||t.defaultValue,this.itineraryPointObjId=s.itineraryPointObjId||d,this._objId=v.nextObjId,this.validateData()}validateData(){"string"==typeof this.iconName?this.iconName=_.sanitizeToJsString(this.iconName):this.iconName="","string"==typeof this.instruction?this.instruction=_.sanitizeToJsString(this.instruction):this.instruction="","number"!=typeof this.distance&&(this.distance=t.defaultValue),"number"!=typeof this.duration&&(this.duration=t.defaultValue),"number"!=typeof this.itineraryPointObjId&&(this.itineraryPointObjId=d)}}const A=new b("Itinerary");class x{_objId=d;_upgradeObject(e){switch(e.objType.version){case"1.0.0":case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":case"1.5.0":case"1.6.0":e.hasProfile=!1,e.ascent=0,e.descent=0;case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":case"1.12.0":case"1.13.0":case"2.0.0":case"2.1.0":case"2.2.0":e.objType.version="2.3.0";break;default:throw new Error("invalid version for "+A.name)}}_validateObject(e){if(!Object.getOwnPropertyNames(e).includes("objType"))throw new Error("No objType for "+A.name);A.validate(e.objType),A.version!==e.objType.version&&this._upgradeObject(e);let t=Object.getOwnPropertyNames(e);return["hasProfile","ascent","descent","itineraryPoints","maneuvers","provider","transitMode","objId"].forEach((e=>{if(!t.includes(e))throw new Error("No "+e+" for "+A.name)})),e}constructor(){this.hasProfile=!1,this.ascent=0,this.descent=0,this.provider="",this.transitMode="",this.itineraryPoints=new w(N),this.maneuvers=new w(j),this._objId=v.nextObjId}get objType(){return A}get objId(){return this._objId}get jsonObject(){return{hasProfile:this.hasProfile,ascent:this.ascent,descent:this.descent,itineraryPoints:this.itineraryPoints.jsonObject,maneuvers:this.maneuvers.jsonObject,provider:this.provider,transitMode:this.transitMode,objId:this._objId,objType:A.jsonObject}}set jsonObject(e){let t=this._validateObject(e);this.hasProfile=t.hasProfile||!1,this.ascent=t.ascent||0,this.descent=t.descent||0,this.itineraryPoints.jsonObject=t.itineraryPoints||[],this.maneuvers.jsonObject=t.maneuvers||[],this.provider=t.provider||"",this.transitMode=t.transitMode||"",this._objId=v.nextObjId;let s=new Map,o=0,i=this.itineraryPoints.iterator;for(;!i.done;)s.set(t.itineraryPoints[o].objId,i.value.objId),o++;let r=this.maneuvers.iterator;for(;!r.done;)r.value.itineraryPointObjId=s.get(r.value.itineraryPointObjId);this.validateData()}validateData(){"boolean"!=typeof this.hasProfile&&(this.hasProfile=!1),"number"!=typeof this.ascent&&(this.ascent=0),"number"!=typeof this.descent&&(this.descent=0),"string"==typeof this.provider?this.provider=_.sanitizeToJsString(this.provider):this.provider="","string"==typeof this.transitMode?this.transitMode=_.sanitizeToJsString(this.transitMode):this.transitMode=""}}const K=new b("Note");class M{_objId=d;_UpdateStyles(e){return e.replaceAll(/style='color:white;background-color:red'/g,"class='TravelNotes-Note-WhiteRed'").replaceAll(/style='color:white;background-color:green'/g,"class='TravelNotes-Note-WhiteGreen'").replaceAll(/style='color:white;background-color:blue'/g,"class='TravelNotes-Note-WhiteBlue'").replaceAll(/style='color:white;background-color:brown'/g,"class='TravelNotes-Note-WhiteBrown'").replaceAll(/style='color:white;background-color:black'/g,"class='TravelNotes-Note-WhiteBlack'").replaceAll(/style='border:solid 0.1em'/g,"class='TravelNotes-Note-BlackWhite'").replaceAll(/style='background-color:white;'/g,"class='TravelNotes-Note-Knooppunt'").replaceAll(/style='fill:green;font:bold 120px sans-serif;'/g,"").replaceAll(/style='fill:none;stroke:green;stroke-width:10;'/g,"")}_upgradeObject(e){switch(e.objType.version){case"1.0.0":case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":case"1.5.0":case"1.6.0":case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":case"1.12.0":case"1.13.0":"string"==typeof e.iconHeight&&(e.iconHeight=Number.parseInt(e.iconHeight)),"string"==typeof e.iconWidth&&(e.iconWidth=Number.parseInt(e.iconWidth)),e.iconContent=this._UpdateStyles(e.iconContent),e.popupContent=this._UpdateStyles(e.popupContent),e.tooltipContent=this._UpdateStyles(e.tooltipContent),e.phone=this._UpdateStyles(e.phone),e.address=this._UpdateStyles(e.address);case"2.0.0":case"2.1.0":case"2.2.0":e.objType.version="2.3.0";break;default:throw new Error("invalid version for "+K.name)}}_validateObject(e){if(!Object.getOwnPropertyNames(e).includes("objType"))throw new Error("No objType for "+K.name);K.validate(e.objType),K.version!==e.objType.version&&this._upgradeObject(e);let t=Object.getOwnPropertyNames(e);return["iconHeight","iconWidth","iconContent","popupContent","tooltipContent","phone","url","address","iconLat","iconLng","lat","lng","distance","chainedDistance","objId"].forEach((e=>{if(!t.includes(e))throw new Error("No "+e+" for "+K.name)})),e}constructor(){this.iconHeight=n.height,this.iconWidth=n.width,this.iconContent="",this.popupContent="",this.tooltipContent="",this.phone="",this.url="",this.address="",this.iconLat=i.defaultValue,this.iconLng=i.defaultValue,this.lat=i.defaultValue,this.lng=i.defaultValue,this.distance=t.invalid,this.chainedDistance=t.defaultValue,this._objId=v.nextObjId}get isRouteNote(){return this.distance!==t.invalid}get iconLatLng(){return[this.iconLat,this.iconLng]}set iconLatLng(e){this.iconLat=e[0],this.iconLng=e[1]}get latLng(){return[this.lat,this.lng]}set latLng(e){this.lat=e[0],this.lng=e[1]}get objType(){return K}get objId(){return this._objId}get jsonObject(){return{iconHeight:this.iconHeight,iconWidth:this.iconWidth,iconContent:this.iconContent,popupContent:this.popupContent,tooltipContent:this.tooltipContent,phone:this.phone,url:this.url,address:this.address,iconLat:parseFloat(this.iconLat.toFixed(i.fixed)),iconLng:parseFloat(this.iconLng.toFixed(i.fixed)),lat:parseFloat(this.lat.toFixed(i.fixed)),lng:parseFloat(this.lng.toFixed(i.fixed)),distance:parseFloat(this.distance.toFixed(t.fixed)),chainedDistance:parseFloat(this.chainedDistance.toFixed(t.fixed)),objId:this._objId,objType:K.jsonObject}}set jsonObject(e){let s=this._validateObject(e);this.iconHeight=s.iconHeight||n.height,this.iconWidth=s.iconWidth||n.width,this.iconContent=s.iconContent||"",this.popupContent=s.popupContent||"",this.tooltipContent=s.tooltipContent||"",this.phone=s.phone||"",this.url=s.url||"",this.address=s.address||"",this.iconLat=s.iconLat||i.defaultValue,this.iconLng=s.iconLng||i.defaultValue,this.lat=s.lat||i.defaultValue,this.lng=s.lng||i.defaultValue,this.distance=s.distance||t.invalid,this.chainedDistance=s.chainedDistance||t.defaultValue,this._objId=v.nextObjId,this.validateData(!0)}validateData(e){if("number"!=typeof this.iconHeight&&(this.iconHeight=n.height),"number"!=typeof this.iconWidth&&(this.iconWidth=n.width),"string"==typeof this.iconContent){let t=_.sanitizeToHtmlString(this.iconContent);e&&""!==t.errorsString&&console.log(t.errorsString+" ("+this.iconContent+")"),this.iconContent=t.htmlString}else this.iconContent="";if("string"==typeof this.popupContent){let t=_.sanitizeToHtmlString(this.popupContent);e&&""!==t.errorsString&&console.log(t.errorsString+" ("+this.popupContent+")"),this.popupContent=t.htmlString}else this.popupContent="";if("string"==typeof this.tooltipContent){let t=_.sanitizeToHtmlString(this.tooltipContent);e&&""!==t.errorsString&&console.log(t.errorsString+" ("+this.tooltipContent+")"),this.tooltipContent=t.htmlString}else this.tooltipContent="";if("string"==typeof this.phone){let t=_.sanitizeToHtmlString(this.phone);e&&""!==t.errorsString&&console.log(t.errorsString+" ("+this.phone+")"),this.phone=t.htmlString}else this.phone="";if("string"==typeof this.url&&""!==this.url){let t=_.sanitizeToUrl(this.url);e&&""!==t.errorsString&&console.log(t.errorsString+" ("+this.url+")"),this.url=encodeURI(t.url)}else this.url="";"string"==typeof this.address?this.address=_.sanitizeToHtmlString(this.address).htmlString:this.address="","number"!=typeof this.iconLat&&(this.iconLat=i.defaultValue),"number"!=typeof this.iconLng&&(this.iconLng=i.defaultValue),"number"!=typeof this.lat&&(this.lat=i.defaultValue),"number"!=typeof this.lng&&(this.lng=i.defaultValue),"number"!=typeof this.distance&&(this.distance=t.invalid),"number"!=typeof this.chainedDistance&&(this.chainedDistance=t.defaultValue)}}const O=new b("Route");class C{_objId=d;_upgradeObject(e){switch(e.objType.version){case"1.0.0":e.dashArray=0,e.hidden=!1;case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":e.edited=r.notEdited;case"1.5.0":case"1.6.0":case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":e.editionStatus=e.edited;case"1.12.0":case"1.13.0":case"2.0.0":case"2.1.0":case"2.2.0":e.objType.version="2.3.0";break;default:throw new Error("invalid version for "+O.name)}}_validateObject(e){if(!Object.getOwnPropertyNames(e).includes("objType"))throw new Error("No objType for "+O.name);O.validate(e.objType),O.version!==e.objType.version&&this._upgradeObject(e);let t=Object.getOwnPropertyNames(e);return["name","wayPoints","notes","itinerary","width","color","dashArray","chain","distance","duration","editionStatus","hidden","chainedDistance","objId"].forEach((e=>{if(!t.includes(e))throw new Error("No "+e+" for "+O.name)})),e}constructor(){this.name="",this.wayPoints=new w(E),this.wayPoints.add(new E),this.wayPoints.add(new E),this.notes=new w(M),this.itinerary=new x,this.width=e.route.width,this.color=e.route.color,this.dashArray=e.route.dashArray,this.chain=!0,this.chainedDistance=t.defaultValue,this.distance=t.defaultValue,this.duration=t.defaultValue,this.editionStatus=r.notEdited,this.hidden=!1,this._objId=v.nextObjId}get computedName(){let e=this.name;return""===e&&(e=(""===this.wayPoints.first.fullName?"???":this.wayPoints.first.fullName)+" ⮞ "+(""===this.wayPoints.last.fullName?"???":this.wayPoints.last.fullName)),e}get objId(){return this._objId}get objType(){return O}haveValidWayPoints(){let e=!0;return this.wayPoints.forEach((t=>{e=e&&i.defaultValue!==t.lat&&i.defaultValue!==t.lng})),e}get jsonObject(){return{name:this.name,wayPoints:this.wayPoints.jsonObject,notes:this.notes.jsonObject,itinerary:this.itinerary.jsonObject,width:this.width,color:this.color,dashArray:this.dashArray,chain:this.chain,distance:parseFloat(this.distance.toFixed(t.fixed)),duration:this.duration,editionStatus:this.editionStatus,hidden:this.hidden,chainedDistance:parseFloat(this.chainedDistance.toFixed(t.fixed)),objId:this._objId,objType:O.jsonObject}}set jsonObject(t){let s=this._validateObject(t);this.name=s.name||"",this.wayPoints.jsonObject=s.wayPoints||[],this.notes.jsonObject=s.notes||[],this.itinerary.jsonObject=s.itinerary||(new x).jsonObject,this.width=s.width||e.route.width,this.color=s.color||"#000000",this.dashArray=s.dashArray||0,this.chain=s.chain||!1,this.distance=s.distance,this.duration=s.duration,this.editionStatus=s.editionStatus||r.notEdited,this.hidden=s.hidden||!1,this.chainedDistance=s.chainedDistance,this._objId=v.nextObjId,this.validateData()}validateData(){"string"==typeof this.name?this.name=_.sanitizeToJsString(this.name):this.name="","number"!=typeof this.width&&(this.width=e.route.width),"string"==typeof this.color?this.color=_.sanitizeToColor(this.color)||e.route.color:this.color=e.route.color,"number"!=typeof this.dashArray&&(this.dashArray=0),this.dashArray>=e.route.dashChoices.length&&(this.dashArray=0),"boolean"!=typeof this.chain&&(this.chain=!1),"number"!=typeof this.distance&&(this.distance=t.defaultValue),"number"!=typeof this.duration&&(this.duration=t.defaultValue),"number"!=typeof this.editionStatus&&(this.editionStatus=r.notEdited),"boolean"!=typeof this.hidden&&(this.hidden=!1),"number"!=typeof this.chainedDistance&&(this.chainedDistance=t.defaultValue)}}const S=new b("Travel");class H{_objId=d;_upgradeObject(e){switch(e.objType.version){case"1.0.0":case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":e.editedRoute=new C;case"1.5.0":if(e.userData.layerId){let t=[{layerId:"0",layerName:"OSM - Color"},{layerId:"1",layerName:"OSM - Black and White"},{layerId:"2",layerName:"Thunderforest - Transport"},{layerId:"3",layerName:"Thunderforest - OpenCycleMap"},{layerId:"4",layerName:"Thunderforest - Outdoors"},{layerId:"5",layerName:"Esri - Aerial view"},{layerId:"6",layerName:"Kartverket - Norway"},{layerId:"7",layerName:"IGN-NGI - Belgium now"},{layerId:"12",layerName:"Thunderforest - Landscape"},{layerId:"24",layerName:"Lantmäteriet - Sweden"},{layerId:"25",layerName:"Maanmittauslaitos - Finland"}].find((t=>t.layerId===e.userData.layerId));e.layerName=t?t.layerName:"OSM - Color"}else e.layerName="OSM - Color";case"1.6.0":case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":case"1.12.0":case"1.13.0":case"2.0.0":case"2.1.0":case"2.2.0":e.objType.version="2.3.0";break;default:throw new Error("invalid version for "+S.name)}}_validateObject(e){if(!Object.getOwnPropertyNames(e).includes("objType"))throw new Error("No objType for "+S.name);S.validate(e.objType),S.version!==e.objType.version&&this._upgradeObject(e);let t=Object.getOwnPropertyNames(e);return["name","editedRoute","routes","objId"].forEach((e=>{if(!t.includes(e))throw new Error("No "+e+" for "+S.name)})),e}constructor(){this.editedRoute=new C,this.routes=new w(C),this.notes=new w(M),this.layerName="OSM - Color",this.name="",this.readOnly=!1,this._objId=v.nextObjId}get objId(){return this._objId}get objType(){return S}get jsonObject(){return{editedRoute:this.editedRoute.jsonObject,layerName:this.layerName,name:this.name,routes:this.routes.jsonObject,notes:this.notes.jsonObject,readOnly:this.readOnly,objId:this._objId,objType:S.jsonObject}}set jsonObject(e){let t=this._validateObject(e);this.editedRoute.jsonObject=t.editedRoute,this.layerName=e.layerName||"OSM - Color",this.name=t.name||"",this.readOnly=t.readOnly||!1,this.routes.jsonObject=t.routes||[],this.notes.jsonObject=t.notes||[],this._objId=v.nextObjId,this.validateData()}validateData(){"string"==typeof this.layerName?this.layerName=_.sanitizeToJsString(this.layerName):this.layerName="OSM - Color","string"==typeof this.name?this.name=_.sanitizeToJsString(this.name):this.name="TravelNotes","boolean"!=typeof this.readOnly&&(this.readOnly=!0)}}const F=new class{_providers=new Map;_mapObjects=new Map;_routing=Object.seal({provider:"",transitMode:""});_UUID=T.UUID;constructor(){this.map=null,this.travel=new H,this.editedRouteObjId=d,this.searchData=[]}get providers(){return this._providers}get mapObjects(){return this._mapObjects}get routing(){return this._routing}get UUID(){return this._UUID}};
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file EventDispatcher.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/const k=new class{constructor(){}dispatch(e,t){let s=new Event(e);t&&(s.data=t),document.dispatchEvent(s)}};const B=new class{_python2Round(e){return Math.floor(Math.abs(e)+.5)*(0<=e?1:-1)}_encodeDelta(e,t,s){let o=this._python2Round(e*s),i=this._python2Round(t*s),r=o-i;r<<=1,0>o-i&&(r=~r);let a="";for(;32<=r;)a+=String.fromCharCode(63+(32|31&r)),r>>=5;return a+=String.fromCharCode(r+63),a}_index=0;_decodeDelta(e){let t=null,s=0,o=0;do{t=e.charCodeAt(this._index++)-63,o|=(31&t)<<s,s+=5}while(32<=t);return 1&o?~(o>>1):o>>1}constructor(){}encode(e,t){if(!e.length)return"";let s=t.length,o=Array.from(t,(e=>Math.pow(10,e))),i="";for(let t=0;t<s;t++)i+=this._encodeDelta(e[0][t],0,o[t]);for(let t=1;t<e.length;t++){let r=e[t],a=e[t-1];for(let e=0;e<s;e++)i+=this._encodeDelta(r[e],a[e],o[e])}return i}decode(e,t){let s=t.length;if(!e||0===e.length)return[];this._index=0;let o=[],i=Array.from(t,(e=>Math.pow(10,e))),r=new Array(s).fill(0);for(;this._index<e.length;){let t=new Array(s).fill(0);for(let o=0;o<s;o++)r[o]+=this._decodeDelta(e),t[o]=r[o]/i[o];o.push(t)}return o}};class R{_compressRoute(e){let t={};0!==e.itinerary.itineraryPoints.length&&(t=e.itinerary.itineraryPoints[0].objType);let s={values:"",objType:t},o=[];e.itinerary.itineraryPoints.forEach((e=>{o.push([e.lat,e.lng,e.distance,e.elev,e.objId])})),s.values=B.encode(o,[i.fixed,i.fixed,2,2,0]),e.itinerary.itineraryPoints=s}_decompressRoute(e){let s=[];if(e.itinerary.itineraryPoints.values)B.decode(e.itinerary.itineraryPoints.values,[i.fixed,i.fixed,2,2,0]).forEach((r=>{let a={lat:i.defaultValue,lng:i.defaultValue,distance:t.defaultValue,elev:o.defaultValue,objId:d};[a.lat,a.lng,a.distance,a.elev,a.objId]=r,a.objType=e.itinerary.itineraryPoints.objType,s.push(a)}));else{e.itinerary.itineraryPoints.latLngs=B.decode(e.itinerary.itineraryPoints.latLngs,[i.fixed,i.fixed]);let t=0;e.itinerary.itineraryPoints.latLngs.forEach((i=>{let r={};r.lat=i[0],r.lng=i[1],r.distance=e.itinerary.itineraryPoints.distances[t],e.itinerary.itineraryPoints.elevs?r.elev=e.itinerary.itineraryPoints.elevs[t]:r.elev=o.defaultValue,r.objId=e.itinerary.itineraryPoints.objIds[t],r.objType=e.itinerary.itineraryPoints.objType,s.push(r),t++}))}e.itinerary.itineraryPoints=s}_decompressTravel(e){e.routes.forEach(this._decompressRoute),e.editedRoute&&this._decompressRoute(e.editedRoute)}constructor(){}decompress(e){this._decompressTravel(e),F.travel.jsonObject=e,F.editedRouteObjId=d,F.travel.routes.forEach((e=>{r.notEdited!==e.editionStatus&&(F.editedRouteObjId=e.objId)}))}decompressMerge(e){this._decompressTravel(e);let t=new H;t.jsonObject=e;let s=t.routes.iterator;for(;!s.done;)F.travel.routes.add(s.value);let o=t.notes.iterator;for(;!o.done;)F.travel.notes.add(o.value)}compress(e){let t=e.jsonObject;return t.routes.forEach(this._compressRoute),this._compressRoute(t.editedRoute),t}}const U=new class{constructor(){}getLatLngElevAtDist(e,t){if(e.distance<=t||0>=t)return null;let s=0,o=e.itinerary.itineraryPoints.iterator;for(;s<t&&!o.done;)s+=o.value.distance;let i=o.value;o.done;let r=(i.distance-s+t)/i.distance;return Object.freeze({latLng:[i.lat+(o.value.lat-i.lat)*r,i.lng+(o.value.lng-i.lng)*r],elev:i.elev+(o.value.elev-i.elev)*r,ascent:100*(o.value.elev-i.elev)/i.distance,routeDistance:t})}getClosestLatLngDistance(e,s){if(0===e.itinerary.itineraryPoints.length)return null;let o=e.itinerary.itineraryPoints.iterator;o.done;let i=Number.MAX_VALUE,r=window.L.Projection.SphericalMercator.project(window.L.latLng(s[0],s[1])),a=window.L.Projection.SphericalMercator.project(window.L.latLng(o.value.lat,o.value.lng)),n=null,l=t.defaultValue,d=o.value.distance;for(;!o.done;){let e=window.L.Projection.SphericalMercator.project(window.L.latLng(o.value.lat,o.value.lng)),t=window.L.LineUtil.pointToSegmentDistance(r,a,e);t<i&&(i=t,n=window.L.Projection.SphericalMercator.unproject(window.L.LineUtil.closestPointOnSegment(r,a,e)),l=d-n.distanceTo(window.L.latLng(o.value.lat,o.value.lng))),d+=o.value.distance,a=e}return Object.freeze({latLng:[n.lat,n.lng],distance:l})}getLatLngBounds(e){let t=window.L.latLng([i.maxLat,i.maxLng]),s=window.L.latLng([i.minLat,i.minLng]);return e.forEach((e=>{t.lat=Math.min(t.lat,e[0]),t.lng=Math.min(t.lng,e[1]),s.lat=Math.max(s.lat,e[0]),s.lng=Math.max(s.lng,e[1])})),window.L.latLngBounds(t,s)}getSquareBoundingBox(e,t){let s=t/p*l.fromRadians,o=e[0]*l.toRadians,i=Math.acos((Math.cos(t/p)-Math.sin(o)**2)/Math.cos(o)**2)*l.fromRadians;return window.L.latLngBounds(window.L.latLng([e[0]-s,e[1]-i]),window.L.latLng([e[0]+s,e[1]+i]))}project(e,t){let s=F.map.project(window.L.latLng(e),t);return[s.x,s.y]}screenCoordToLatLng(e,t){let s=F.map.containerPointToLatLng(window.L.point(e,t));return[s.lat,s.lng]}addPoints(e,t){return[e[0]+t[0],e[1]+t[1]]}subtrackPoints(e,t){return[e[0]-t[0],e[1]-t[1]]}};const z=new class{_normalizeLng(e){return(e+l.d540)%l.d360-l.d180}constructor(){}arcFromSummitArcArc(e,t,s){return Math.acos(Math.cos(t)*Math.cos(s)+Math.sin(t)*Math.sin(s)*Math.cos(e))}summitFromArcArcArc(e,t,s){return Math.acos((Math.cos(s)-Math.cos(e)*Math.cos(t))/(Math.sin(e)*Math.sin(t)))}pointsDistance(e,t){if(e[0]===t[0]&&e[1]===t[1])return 0;let s=e[0]*l.toRadians,o=t[0]*l.toRadians,i=(this._normalizeLng(t[1])-this._normalizeLng(e[1]))*l.toRadians;return Math.acos(Math.sin(s)*Math.sin(o)+Math.cos(s)*Math.cos(o)*Math.cos(i))*p}};const V=new class{_setNearestRouteData(e,t,s){if(e.objId!==F.editedRouteObjId){let o=U.getClosestLatLngDistance(e,t);if(o){let i=z.pointsDistance(t,o.latLng);i<s.distance&&(s.route=e,s.distance=i,s.latLngOnRoute=o.latLng,s.distanceOnRoute=o.distance)}}}constructor(){}getNearestRouteData(e){let t={distance:Number.MAX_VALUE,route:null,distanceOnRoute:0,latLngOnRoute:[i.defaultValue,i.defaultValue]};return F.travel.routes.forEach((s=>this._setNearestRouteData(s,e,t))),d!==F.editedRouteObjId&&this._setNearestRouteData(F.travel.editedRoute,e,t),Object.freeze(t)}getRoute(e){let t=null;return t=F.travel.routes.getAt(e),t||e===F.travel.editedRoute.objId&&(t=F.travel.editedRoute),t}getNoteAndRoute(e){let t=null,s=null;if(t=F.travel.notes.getAt(e),!t){let o=F.travel.routes.iterator;for(;!o.done&&!t;)t=o.value.notes.getAt(e),t&&(s=o.value);t||(t=F.travel.editedRoute.notes.getAt(e),t&&(s=F.travel.editedRoute))}return Object.freeze({note:t,route:s})}getWayPoint(e){let t=F.travel.editedRoute.wayPoints.getAt(e);if(!t){let s=F.travel.routes.iterator;for(;!s.done&&!t;)t=s.value.wayPoints.getAt(e)}return t}};class W{_geometry=[];_pushNoteGeometry(e){this._geometry.push(e.latLng),this._geometry.push(e.iconLatLng)}_pushRouteGeometry(e){e.itinerary.itineraryPoints.forEach((e=>this._geometry.push(e.latLng))),e.notes.forEach((e=>this._pushNoteGeometry(e)))}constructor(){}zoomToLatLng(e){k.dispatch("zoomto",{latLng:e})}zoomToManeuver(e){let t=F.travel.editedRoute.itinerary.maneuvers.getAt(e).itineraryPointObjId,s=F.travel.editedRoute.itinerary.itineraryPoints.getAt(t).latLng;k.dispatch("zoomto",{latLng:s})}zoomToNote(e){this._geometry=[],this._pushNoteGeometry(V.getNoteAndRoute(e).note),k.dispatch("zoomto",{geometry:[this._geometry]})}zoomToRoute(e){this._geometry=[],this._pushRouteGeometry(V.getRoute(e)),k.dispatch("zoomto",{geometry:[this._geometry]})}zoomToTravel(){this._geometry=[],F.travel.routes.forEach((e=>this._pushRouteGeometry(e))),d!==F.travel.editedRouteObjId&&this._pushRouteGeometry(F.travel.editedRoute),F.travel.notes.forEach((e=>this._pushNoteGeometry(e))),k.dispatch("zoomto",{geometry:[this._geometry]})}zoomToPoi(e){k.dispatch("zoomto",e)}}class Z{constructor(){}openDistantFile(e){(new R).decompress(e),F.travel.readOnly=!0,document.title="Travel & Notes"+(""===F.travel.name?"":" - "+F.travel.name);let t=F.travel.routes.iterator;for(;!t.done;)r.notEdited===t.value.editionStatus&&k.dispatch("routeupdated",{removedRouteObjId:d,addedRouteObjId:t.value.objId});d!==F.editedRouteObjId&&k.dispatch("routeupdated",{removedRouteObjId:d,addedRouteObjId:F.travel.editedRoute.objId});let s=F.travel.notes.iterator;for(;!s.done;)k.dispatch("noteupdated",{removedNoteObjId:d,addedNoteObjId:s.value.objId});(new W).zoomToTravel()}}
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file HTMLElementsFactory.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/const X=new class{_addProperties(e,t){for(let s in t)try{if("dataset"===s){let s=t.dataset;for(let t in s)e.dataset["tan"+t]=s[t]}else e[s]=t[s]}catch(e){e instanceof Error&&console.error(e)}e.target&&(e.rel="noopener noreferrer")}constructor(){}create(e,t,s){let o=null;return"text"===e.toLowerCase()?o=document.createTextNode(t.value||""):(o="select"===e.toLowerCase()?document.createElement(e):Object.seal(document.createElement(e)),t&&this._addProperties(o,t)),s&&s.appendChild(o),o}};const Y=new class{_attributionsDiv=null;constructor(){}createUI(){this._attributionsDiv=X.create("div",{id:"TravelNotes-AttributionsUI"},document.body)}set attributions(e){let t='© <a href="https://leafletjs.com/" target="_blank" title="Leaflet">Leaflet</a> | © <a href="https://www.openstreetmap.org/copyright" target="_blank" title="OpenStreetMap contributors">OpenStreetMap contributors</a> '+e+'| © <a href="https://github.com/wwwouaiebe" target="_blank" title="https://github.com/wwwouaiebe">Travel & Notes</a>';for(;this._attributionsDiv.firstChild;)this._attributionsDiv.removeChild(this._attributionsDiv.firstChild);_.sanitizeToHtmlElement(t,this._attributionsDiv)}};const G=new class{_status="geolocation"in navigator?s.inactive:s.disabled;_watchId=null;_showPosition(e){k.dispatch("geolocationpositionchanged",{position:e})}_stop(){s.active===this._status&&(this._status=s.inactive),k.dispatch("geolocationstatuschanged",{status:this._status}),navigator.geolocation.clearWatch(this._watchId),this._watchId=null}_error(e){1===e.code&&(this._status=s.refusedByUser),this._stop()}_start(){this._status=s.active,k.dispatch("geolocationstatuschanged",{status:this._status}),navigator.geolocation.getCurrentPosition((e=>this._showPosition(e)),(e=>this._error(e)),e.geoLocation.options),this._watchId=navigator.geolocation.watchPosition(this._showPosition,this._error,e.geoLocation.options)}constructor(){}get status(){return this._status}switch(){switch(this._status){case s.inactive:this._start();break;case s.active:this._stop()}return this._status}};class J{_mapLayers=null;constructor(e){this._mapLayers=e}handleEvent(e){e.stopPropagation();let t=this._mapLayers[Number.parseInt(e.target.dataset.tanMapLayerId)];k.dispatch("layerchange",{layer:t}),Y.attributions=t.attribution}}class ${constructor(){}handleEvent(e){e.stopPropagation(),G.switch()}}class q{constructor(){}handleEvent(e){e.stopPropagation(),(new W).zoomToTravel()}}const Q=new class{_mapLayersToolbar=null;_mapLayers=[{service:"wmts",url:"https://{s}.tile.osm.org/{z}/{x}/{y}.png",name:"OSM - Color",toolbar:{text:"OSM",color:"red",backgroundColor:"white"},providerName:"OSM",providerKeyNeeded:!1,attribution:""}];constructor(){}createUI(){this._mapLayersToolbar=X.create("div",{id:"TravelNotes-ViewerLayersToolbarUI"},document.body),X.create("div",{className:"TravelNotes-ViewerLayersToolbarUI-Button",title:"My position",textContent:"🌐",style:"color:black;background-color:white"},this._mapLayersToolbar).addEventListener("click",new $,!1),X.create("div",{className:"TravelNotes-ViewerLayersToolbarUI-Button",title:"Zoom on the travel",textContent:"🔍",style:"color:black;background-color:white"},this._mapLayersToolbar).addEventListener("click",new q,!1);let e=new J(this._mapLayers);for(let t=0;t<this._mapLayers.length;t++){let s=this._mapLayers[t];X.create("div",{className:"TravelNotes-ViewerLayersToolbarUI-Button",title:s.name,dataset:{MapLayerId:t},textContent:s.toolbar.text,style:"color:"+s.toolbar.color+";background-color:"+s.toolbar.backgroundColor},this._mapLayersToolbar).addEventListener("click",e,!1)}}setMapLayer(e){let t=e.match(/^[0-9]$/)?this._mapLayers[Number.parseInt(e)]||this._mapLayers[0]:this._mapLayers.find((t=>t.name===e))||this._mapLayers[0];k.dispatch("layerchange",{layer:t}),Y.attributions=t.attribution}addMapLayers(e){e.forEach((e=>{e.providerKeyNeeded||this._mapLayers.push(e)}))}};const ee=new class{_travelNotesLoaded=!1;async _loadDistantTravel(e){let t=await fetch(e);if(c===t.status&&t.ok){let e=await t.json();(new Z).openDistantFile(e)}else F.map.setView([i.defaultValue,i.defaultValue],2),document.title="Travel & Notes"}constructor(){}addReadOnlyMap(e,t){this._travelNotesLoaded||(this._travelNotesLoaded=!0,Y.createUI(),t&&Q.createUI(),Q.setMapLayer("OSM - Color"),e&&this._loadDistantTravel(e))}},te=a.margin.toFixed(0),se=(a.margin+a.height).toFixed(0),oe=(a.margin+a.width).toFixed(0),ie=a.margin.toFixed(0),re=(a.margin+a.width+a.xDeltaText).toFixed(0),ae=(a.margin-a.xDeltaText).toFixed(0),ne=a.margin+a.height+a.margin/2;class le{_route=null;_smoothDistance=0;_smoothPoints=e.route.elev.smoothPoints;_svg=null;_VScale=1;_HScale=1;_minElev=Number.MAX_VALUE;_maxElev=0;_deltaElev=0;_createTmpPoints(){let e=0,t=0,s=[],o=this._route.itinerary.itineraryPoints.iterator,i=0,r=o.done;for(s.push({distance:e,elev:o.value.elev}),i+=o.value.distance,r=o.done;!r;){for(e+=this._smoothDistance;e>=i&&!r;)i+=o.value.distance,r=o.done;if(!r){let r=(o.value.elev-o.previous.elev)/o.previous.distance;t=o.value.elev-(i-e)*r,s.push({distance:e,elev:t})}}return s.push({distance:i,elev:this._route.itinerary.itineraryPoints.last.elev}),s}_createSmoothPoints(){let e=this._createTmpPoints(),t=new Map,s=(e[this._smoothPoints].elev-e[0].elev)/this._smoothPoints,o=0;for(o=0;o<this._smoothPoints;o++)t.set(o*this._smoothDistance,{distance:o*this._smoothDistance,elev:e[0].elev+s*o});for(o=this._smoothPoints;o<e.length-this._smoothPoints;o++){let s=0;for(let t=o-this._smoothPoints;o+this._smoothPoints>=t;t++)s+=e[t].elev;t.set(e[o].distance,{distance:e[o].distance,elev:s/(2*this._smoothPoints+1)})}return o--,s=this._smoothDistance*(e[e.length-1].elev-e[e.length-1-this._smoothPoints].elev)/(e[e.length-1].distance-e[e.length-1-this._smoothPoints].distance),t.set(e[o].distance+this._smoothDistance,{distance:e[o].distance+this._smoothDistance,elev:e[o].elev+s}),t.set(e[o].distance+2*this._smoothDistance,{distance:e[o].distance+2*this._smoothDistance,elev:e[o].elev+2*s}),t}_createProfilePolyline(){let e="",t=0,s=0,o=0;this._route.itinerary.itineraryPoints.forEach((i=>{s=(a.margin+this._HScale*t).toFixed(0),o=(a.margin+this._VScale*(this._maxElev-i.elev)).toFixed(0),e+=s+","+o+" ",t+=i.distance}));let i=document.createElementNS(u,"polyline");i.setAttributeNS(null,"points",e),i.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-profilePolyline"),this._svg.appendChild(i)}_createFramePolyline(){let e=te+","+ie+" "+te+","+se+" "+oe+","+se+" "+oe+","+ie,t=document.createElementNS(u,"polyline");t.setAttributeNS(null,"points",e),t.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-framePolyline"),this._svg.appendChild(t)}_createDistanceTexts(){let e=Number.MAX_VALUE,s=0;a.hScales.forEach((t=>{let o=Math.abs(this._route.distance/8-t);o<e&&(e=o,s=t)}));let o=Math.ceil(this._route.chainedDistance/s)*s;for(;o<this._route.distance+this._route.chainedDistance;){let e=document.createElementNS(u,"text");e.appendChild(document.createTextNode(t.metersInKm<s||0<this._route.chainedDistance?o/t.metersInKm+" km":o+" m ")),e.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-distLegend"),e.setAttributeNS(null,"x",a.margin+(o-this._route.chainedDistance)*this._HScale),e.setAttributeNS(null,"y",ne),e.setAttributeNS(null,"text-anchor","start"),this._svg.appendChild(e),o+=s}}_createElevTexts(){let e=Number.MAX_VALUE,t=0;a.vScales.forEach((s=>{let o=Math.abs(this._deltaElev/4-s);o<e&&(e=o,t=s)}));let s=Math.ceil(this._minElev/t)*t;for(;s<this._maxElev;){let e=a.margin+(this._maxElev-s)*this._VScale,o=document.createElementNS(u,"text");o.appendChild(document.createTextNode(s.toFixed(0))),o.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-elevLegend"),o.setAttributeNS(null,"x",re),o.setAttributeNS(null,"y",e),o.setAttributeNS(null,"text-anchor","start"),this._svg.appendChild(o);let i=document.createElementNS(u,"text");i.appendChild(document.createTextNode(s.toFixed(0))),i.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-elevLegend"),i.setAttributeNS(null,"x",ae),i.setAttributeNS(null,"y",e),i.setAttributeNS(null,"text-anchor","end"),this._svg.appendChild(i),s+=t}}_createSvgElement(){this._svg=document.createElementNS(u,"svg"),this._svg.setAttributeNS(null,"viewBox","0 0 "+(a.width+2*a.margin)+" "+(a.height+2*a.margin)),this._svg.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile")}constructor(){}smooth(t){this._route=t;let s=this._route.itinerary.itineraryPoints.iterator,o=0,i=0;for(;!s.done;)o+=s.value.distance,i+=s.next?Math.abs(s.value.elev-s.next.elev):0;if(this._smoothDistance=10*Math.floor(e.route.elev.smoothCoefficient/(i/o)),o<=2*this._smoothPoints*this._smoothDistance)return;let r=this._createSmoothPoints();s=this._route.itinerary.itineraryPoints.iterator,s.done;let a=s.value.distance;for(;!s.done;){let e=r.get(Math.floor(a/this._smoothDistance)*this._smoothDistance),t=r.get(Math.ceil(a/this._smoothDistance)*this._smoothDistance);if(e&&t){let o=a-e.distance,i=(t.elev-e.elev)/(t.distance-e.distance);s.value.elev=e.elev+o*i}a+=s.value.distance}}createSvg(e){return this._route=e,this._minElev=Number.MAX_VALUE,this._maxElev=0,this._route.itinerary.itineraryPoints.forEach((e=>{this._maxElev=Math.max(this._maxElev,e.elev),this._minElev=Math.min(this._minElev,e.elev)})),this._deltaElev=this._maxElev-this._minElev,this._VScale=a.height/this._deltaElev,this._HScale=a.width/this._route.distance,this._createSvgElement(),this._createProfilePolyline(),this._createFramePolyline(),this._createElevTexts(),this._createDistanceTexts(),this._svg}}const de=new class{constructor(){}getNoteTextAndIconHTML(t,s){let o=X.create("div",{dataset:{ObjId:s.note.objId}}),i=X.create("div",{className:t+(s.route?"Route-ManeuversAndNotes-IconCell":"Travel-Notes-IconCell")},o),r=1;_.sanitizeToHtmlElement(s.note.iconContent,i),"TravelNotes-Roadbook-"===t&&i.firstChild?("svg"===i.firstChild.tagName?(i.firstChild.setAttributeNS(null,"viewBox","0 0 "+n.svgViewboxDim+" "+n.svgViewboxDim),r=e.note.svgIcon.roadbookFactor):i.firstChild.classList.contains("TravelNotes-MapNoteCategory-0073")&&(r=e.note.svgIcon.roadbookFactor),i.setAttribute("tanwidth",String(s.note.iconWidth*r)+"px"),i.setAttribute("tanheight",String(s.note.iconWidth*r)+"px")):(i.style.width=String(s.note.iconWidth)+"px",i.style.height=String(s.note.iconHeight)+"px");let a=this.getNoteTextHTML(t,s);return a.className=t+(s.route?"Route-ManeuversAndNotes-Cell":"Travel-Notes-Cell"),o.appendChild(a),o}getNoteTextHTML(e,t){let s=t.note,o=X.create("div");if(0!==s.tooltipContent.length&&_.sanitizeToHtmlElement(s.tooltipContent,X.create("div",{className:e+"NoteHtml-TooltipContent"},o)),0!==s.popupContent.length&&_.sanitizeToHtmlElement(s.popupContent,X.create("div",{className:e+"NoteHtml-PopupContent"},o)),0!==s.address.length&&_.sanitizeToHtmlElement("<span>"+I.getText("NoteHTMLViewsFactory - Address")+"</span> : "+s.address,X.create("div",{className:e+"NoteHtml-Address"},o)),0!==s.url.length&&_.sanitizeToHtmlElement("<span>"+I.getText("NoteHTMLViewsFactory - Link")+"</span><a href="+s.url+' target="_blank" >'+s.url.substr(0,40)+"...</a>",X.create("div",{className:e+"NoteHtml-Url"},o)),0!==s.phone.length){let t=s.phone;if(s.phone.match(/^\+[0-9, ,*,\u0023]*$/)){let e=s.phone.replaceAll(/\u0020/g,""),o=s.phone.replaceAll(/\u0020/g," ");t=I.getText("NoteHTMLViewsFactory - Phone")+" : "+I.getText("NoteHTMLViewsFactory - call")+'<a target="_blank" href="tel:'+e+'" >'+o+"</a>"+I.getText("NoteHTMLViewsFactory - Send a sms to")+'<a target="_blank" href="sms:'+e+'" >'+o+"</a>"}else t=I.getText("NoteHTMLViewsFactory - Phone")+" : "+s.phone;_.sanitizeToHtmlElement(t,X.create("div",{className:e+"NoteHtml-Phone"},o))}if(_.sanitizeToHtmlElement(T.formatLatLng(s.latLng),X.create("div",{className:e+"NoteHtml-LatLng"},o)),t.route){t.route.chain&&_.sanitizeToHtmlElement("<span>"+I.getText("NoteHTMLViewsFactory - Distance from start of travel")+"</span> : "+T.formatDistance(s.chainedDistance+s.distance),X.create("div",{className:e+"NoteHtml-Distance"},o)),_.sanitizeToHtmlElement("<span>"+I.getText("NoteHTMLViewsFactory - Distance from start of route")+"</span> : "+T.formatDistance(s.distance),X.create("div",{className:e+"NoteHtml-Distance"},o));let i=t.route.notes.next(s.objId);if(i){let t=i.distance-s.distance;9<t&&_.sanitizeToHtmlElement("<span>"+I.getText("NoteHTMLViewsFactory - Next note after")+"</span> : "+T.formatDistance(t),X.create("div",{className:e+"NoteHtml-NextDistance"},o))}}return o}getTravelNotesHTML(e){let t=X.create("div",{className:e+"Travel-Notes"}),s=F.travel.notes.iterator;for(;!s.done;){let o=this.getNoteTextAndIconHTML(e,{note:s.value,route:null});o.className=e+"Travel-Notes-Row",t.appendChild(o)}return t}};const he=new class{_getManeuverHTML(e,s){let o=X.create("div");X.create("div",{className:e+"Route-ManeuversAndNotes-IconCell TravelNotes-ManeuverNote-"+s.maneuver.iconName},o);let i=X.create("div",{className:e+"Route-ManeuversAndNotes-Cell"},o);return _.sanitizeToHtmlElement(s.maneuver.instruction,X.create("div",null,i)),s.route.chain&&_.sanitizeToHtmlElement("<span>"+I.getText("RouteHTMLViewsFactory - Distance from start of travel")+"</span> : "+T.formatDistance(s.route.chainedDistance+s.maneuverDistance),X.create("div",{className:e+"Route-Maneuver-Distance"},i)),_.sanitizeToHtmlElement("<span>"+I.getText("RouteHTMLViewsFactory - Distance from start of route")+"</span> : "+T.formatDistance(s.maneuverDistance),X.create("div",{className:e+"Route-Maneuver-Distance"},i)),t.defaultValue<s.maneuver.distance&&_.sanitizeToHtmlElement("<span>"+I.getText("RouteHTMLViewsFactory - Next maneuver after")+"</span> : "+T.formatDistance(s.maneuver.distance),X.create("div",{className:e+"Route-Maneuver-Distance"},i)),o}constructor(){}getRouteProfileHTML(e,t){let s=X.create("div",{className:e+"RouteProfile"});return _.sanitizeToHtmlElement(I.getText("RouteHTMLViewsFactory - Profile"),s),s.appendChild((new le).createSvg(t)),s}getRouteManeuversAndNotesHTML(e,t,s){let o=[],i=t.notes.iterator;for(;!i.done;)o.push({data:i.value,distance:i.value.distance});let r=t.itinerary.maneuvers.iterator,a=0;for(;!r.done;)o.push({data:r.value,distance:a}),a+=r.value.distance;o.sort(((e,t)=>e.distance-t.distance));let n=X.create("div",{className:e+"Route-ManeuversAndNotes"});return o.forEach((o=>{let i=null;"Note"===o.data.objType.name?(i=de.getNoteTextAndIconHTML(e,{note:o.data,route:t}),i.className=e+"Route-Notes-Row"):(i=this._getManeuverHTML(e,{route:t,maneuver:o.data,maneuverDistance:o.distance}),i.className=e+"Route-Maneuvers-Row"),s&&(i.dataset.tanObjId=o.data.objId,i.dataset.tanMarkerObjId=v.nextObjId,i.dataset.tanObjType=o.data.objType.name),n.appendChild(i)})),n}getRouteHeaderHTML(e,t){let s=X.create("div",{className:e+"Route-Header",id:"route"+t.objId});return _.sanitizeToHtmlElement(t.computedName,X.create("div",{className:e+"Route-Header-Name"},s)),0!==t.distance&&_.sanitizeToHtmlElement("<span>"+I.getText("RouteHTMLViewsFactory - Route distance")+"</span> : "+T.formatDistance(t.distance),X.create("div",{className:e+"Route-Header-Distance"},s)),F.travel.readOnly||"bike"===t.itinerary.transitMode||_.sanitizeToHtmlElement("<span>"+I.getText("RouteHTMLViewsFactory - Duration")+"</span> : "+T.formatTime(t.duration),X.create("div",{className:e+"Route-Header-Duration"},s)),t.itinerary.hasProfile&&(_.sanitizeToHtmlElement("<span>"+I.getText("RouteHTMLViewsFactory - Ascent")+"</span> : "+String(t.itinerary.ascent.toFixed(0))+" m.",X.create("div",{className:e+"Route-Header-Ascent"},s)),_.sanitizeToHtmlElement("<span>"+I.getText("RouteHTMLViewsFactory - Descent")+"</span> : "+String(t.itinerary.descent.toFixed(0))+" m.",X.create("div",{className:e+"Route-Header-Descent"},s))),s}getRouteFooterHTML(e,t){let s="";""!==t.itinerary.provider&&""!==t.itinerary.transitMode&&(s=I.getText("RouteHTMLViewsFactory - Itinerary computed by {provider} and optimized for {transitMode}",{provider:t.itinerary.provider,transitMode:I.getText("RouteHTMLViewsFactory - TransitMode "+t.itinerary.transitMode)}));let o=X.create("div",{className:e+"RouteFooter"});return _.sanitizeToHtmlElement(s,o),o}};class ce{_baseDialog=null;constructor(e){this._baseDialog=e}destructor(){this._baseDialog=null}handleEvent(){this._baseDialog.onOk()}}class ue{_baseDialog=null;constructor(e){this._baseDialog=e}destructor(){this._baseDialog=null}handleEvent(){this._baseDialog.onCancel()}}class pe{_dragData=null;constructor(e){this._dragData=e}destructor(){this._dragData=null}handleEvent(e){this._dragData.dragStartX=e.screenX,this._dragData.dragStartY=e.screenY,e.dataTransfer.dropEffect="move",e.dataTransfer.effectAllowed="move"}}class ge{_dragData=null;_containerDiv=null;_backgroundDiv=null;constructor(e,t,s){this._dragData=e,this._containerDiv=t,this._backgroundDiv=s}destructor(){this._dragData=null,this._containerDiv=null,this._backgroundDiv=null}handleEvent(e){this._dragData.dialogX+=e.screenX-this._dragData.dragStartX,this._dragData.dialogX=Math.min(Math.max(this._dragData.dialogX,g),this._backgroundDiv.clientWidth-this._containerDiv.clientWidth-g),this._dragData.dialogY+=e.screenY-this._dragData.dragStartY,this._dragData.dialogY=Math.max(this._dragData.dialogY,g);let t=this._backgroundDiv.clientHeight-Math.max(this._dragData.dialogY,0)-g;this._containerDiv.style.left=String(this._dragData.dialogX)+"px",this._containerDiv.style.top=String(this._dragData.dialogY)+"px",this._containerDiv.style["max-height"]=String(t)+"px"}}class _e{_baseDialog=null;constructor(e){this._baseDialog=e}destructor(){this._baseDialog=null}handleEvent(e){this._baseDialog.keyboardELEnabled&&("Escape"===e.key||"Esc"===e.key?this._baseDialog.onCancel():"Enter"===e.key&&this._baseDialog.onOk())}}class me{_mapCenter=[i.defaultValue,i.defaultValue];constructor(){}handleEvent(e){if("start"===e.action)return void(this._mapCenter=F.map.getCenter());let t=U.screenCoordToLatLng(e.startX,e.startY),s=U.screenCoordToLatLng(e.endX,e.endY);F.map.panTo([this._mapCenter.lat+t[0]-s[0],this._mapCenter.lng+t[1]-s[1]])}}class ve{_initialZoom=0;_startPoint=null;constructor(){}handleEvent(e){if("start"===e.action)return this._initialZoom=F.map.getZoom(),void(this._startPoint=window.L.point(e.clientX,e.clientY));let t=Math.floor(this._initialZoom+(e.startY-e.endY)/50);t=Math.min(F.map.getMaxZoom(),t),t=Math.max(F.map.getMinZoom(),t),F.map.setZoomAround(this._startPoint,t)}}class ye{constructor(){}handleEvent(e){if("TravelNotes-Background"!==e.target.id)return;let t=F.map.getZoom()+(0>e.deltaY?1:-1);t=Math.min(F.map.getMaxZoom(),t),t=Math.max(F.map.getMinZoom(),t),F.map.setZoomAround(window.L.point(e.clientX,e.clientY),t)}}class be{constructor(){}handleEvent(e){e.preventDefault()}}class fe{constructor(){}handleEvent(e){e.preventDefault()}}class we{_panOngoing=!1;_startPanX=0;_startPanY=0;_target=null;_button=0;_eventType="";_dispatchEvent(e,t){let s=new Event(this._eventType);s.startX=this._startPanX,s.startY=this._startPanY,s.endX=e.screenX,s.endY=e.screenY,s.clientX=e.clientX,s.clientY=e.clientY,s.action=t,this._target.dispatchEvent(s)}constructor(e,t){switch(this._target=e,this._button=t,t){case 0:this._eventType="leftpan";break;case 1:this._eventType="middlepan";break;case 2:this._eventType="rightpan";break;default:this._button=h}}handleEvent(e){switch(e.type){case"mousedown":e.button===this._button&&e.target===this._target&&(this._startPanX=e.screenX,this._startPanY=e.screenY,this._panOngoing=!0,this._dispatchEvent(e,"start"));break;case"mouseup":e.button!==this._button||!this._panOngoing||this._startPanX===e.screenX&&this._startPanY===e.screenY||this._dispatchEvent(e,"end"),this._panOngoing=!1;break;case"mousemove":this._panOngoing&&(document.selection?document.selection.empty():window.getSelection().removeAllRanges(),this._dispatchEvent(e,"move"))}}}class Ie{static get LEFT_BUTTON(){return 0}static get MIDDLE_BUTTON(){return 1}static get RIGHT_BUTTON(){return 2}_target=null;_eventListener=null;constructor(e,t=0){this._target=e,this._eventListener=new we(e,t),this._target.addEventListener("mousedown",this._eventListener),this._target.addEventListener("mouseup",this._eventListener),this._target.addEventListener("mousemove",this._eventListener)}detach(){this._target.removeEventListener("mousedown",this._eventListener),this._target.removeEventListener("mouseup",this._eventListener),this._target.removeEventListener("mousemove",this._eventListener),this._eventListener=null,this._target=null}}class Te{_backgroundDiv={};_containerDiv={};_errorDiv={};_waitDiv={};_okButton={};_cancelButton={};_topBar={};_secondButton=null;_leftPanEventDispatcher=null;_rightPanEventDispatcher=null;_keyboardELEnabled=!0;_dragData=Object.seal({dragStartX:0,dragStartY:0,dialogX:0,dialogY:0});_eventListeners={onKeydown:null,onTopBarDragStart:null,onTopBarDragEnd:null,onCancelButtonClick:null,onOkButtonClick:null,onLeftPan:null,onRightPan:null,onWheel:null,onContextMenu:null,onDragOver:null};_options=null;_onPromiseOkFct=null;_onPromiseErrorFct=null;_createBackgroundDiv(){this._backgroundDiv=X.create("div",{id:"TravelNotes-Background",className:"TravelNotes-Background"}),this._leftPanEventDispatcher=new Ie(this._backgroundDiv,Ie.LEFT_BUTTON),this._rightPanEventDispatcher=new Ie(this._backgroundDiv,Ie.RIGHT_BUTTON),this._eventListeners.onLeftPan=new me,this._backgroundDiv.addEventListener("leftpan",this._eventListeners.onLeftPan,!1),this._eventListeners.onRightPan=new ve,this._backgroundDiv.addEventListener("rightpan",this._eventListeners.onRightPan,!1),this._eventListeners.onDragOver=new fe,this._backgroundDiv.addEventListener("dragover",this._eventListeners.onDragOver,!1),this._eventListeners.onWheel=new ye,this._backgroundDiv.addEventListener("wheel",this._eventListeners.onWheel,!1),this._eventListeners.onContextMenu=new be,this._backgroundDiv.addEventListener("contextmenu",this._eventListeners.onContextMenu,!1)}_createContainerDiv(){this._containerDiv=X.create("div",{className:"TravelNotes-BaseDialog-Container"},this._backgroundDiv)}_createTopBar(){this._topBar=X.create("div",{className:"TravelNotes-BaseDialog-TopBar",draggable:!0},this._containerDiv),this._eventListeners.onTopBarDragStart=new pe(this._dragData),this._eventListeners.onTopBarDragEnd=new ge(this._dragData,this._containerDiv,this._backgroundDiv),this._topBar.addEventListener("dragstart",this._eventListeners.onTopBarDragStart,!1),this._topBar.addEventListener("dragend",this._eventListeners.onTopBarDragEnd,!1),this._eventListeners.onCancelButtonClick=new ue(this),this._cancelButton=X.create("div",{textContent:"❌",className:"TravelNotes-BaseDialog-CancelButton",title:I.getText("BaseDialog - Cancel")},this._topBar),this._cancelButton.addEventListener("click",this._eventListeners.onCancelButtonClick,!1)}_createHeaderDiv(){X.create("text",{value:this.title},X.create("div",{className:"TravelNotes-BaseDialog-HeaderDiv"},this._containerDiv))}_createContentDiv(){let e=X.create("div",{className:"TravelNotes-BaseDialog-ContentDiv"},this._containerDiv);this.contentHTMLElements.forEach((t=>e.appendChild(t)))}_createErrorDiv(){this._errorDiv=X.create("div",{className:"TravelNotes-BaseDialog-ErrorDiv TravelNotes-Hidden"},this._containerDiv)}_createWaitDiv(){X.create("div",{className:"TravelNotes-WaitAnimationBullet"},X.create("div",{className:"TravelNotes-WaitAnimation"},this._waitDiv=X.create("div",{className:"TravelNotes-BaseDialog-WaitDiv  TravelNotes-Hidden"},this._containerDiv)))}_createFooterDiv(){let e=X.create("div",{className:"TravelNotes-BaseDialog-FooterDiv"},this._containerDiv);this._okButton=X.create("div",{textContent:this._options.firstButtonText||"🆗",className:"TravelNotes-BaseDialog-Button"},e),this._eventListeners.onOkButtonClick=new ce(this),this._okButton.addEventListener("click",this._eventListeners.onOkButtonClick,!1),this._options.secondButtonText&&(this._secondButton=X.create("div",{textContent:this._options.secondButtonText,className:"TravelNotes-BaseDialog-Button"},e),this._secondButton.addEventListener("click",this._eventListeners.onCancelButtonClick,!1)),this.footerHTMLElements.forEach((t=>e.appendChild(t)))}_createHTML(){this._createBackgroundDiv(),this._createContainerDiv(),this._createTopBar(),this._createHeaderDiv(),this._createContentDiv(),this._createErrorDiv(),this._createWaitDiv(),this._createFooterDiv()}_centerDialog(){this._dragData.dialogX=(this._backgroundDiv.clientWidth-this._containerDiv.clientWidth)/2,this._dragData.dialogY=(this._backgroundDiv.clientHeight-this._containerDiv.clientHeight)/2,this._dragData.dialogX=Math.min(Math.max(this._dragData.dialogX,g),this._backgroundDiv.clientWidth-this._containerDiv.clientWidth-g),this._dragData.dialogY=Math.max(this._dragData.dialogY,g);let e=this._backgroundDiv.clientHeight-Math.max(this._dragData.dialogY,0)-g;this._containerDiv.style.left=String(this._dragData.dialogX)+"px",this._containerDiv.style.top=String(this._dragData.dialogY)+"px",this._containerDiv.style["max-height"]=String(e)+"px"}_show(e,t){this._onPromiseOkFct=e,this._onPromiseErrorFct=t,this._createHTML(),document.body.appendChild(this._backgroundDiv),this._centerDialog(),document.addEventListener("keydown",this._eventListeners.onKeydown,{capture:!0}),this.onShow()}constructor(e={}){this._options=e,this._eventListeners.onKeydown=new _e(this),this._keyboardELEnabled=!0}_BaseDialogDestructor(){this._backgroundDiv.removeEventListener("dragover",this._eventListeners.onDragOver,!1),this._backgroundDiv.removeEventListener("leftpan",this._eventListeners.onLeftPan,!1),this._backgroundDiv.removeEventListener("rightpan",this._eventListeners.onRightPan,!1),this._backgroundDiv.removeEventListener("wheel",this._eventListeners.onWheel,!1),this._backgroundDiv.removeEventListener("contextmenu",this._eventListeners.onContextMenu,!1),document.removeEventListener("keydown",this._eventListeners.onKeydown,{capture:!0}),this._topBar.removeEventListener("dragstart",this._eventListeners.onTopBarDragStart,!1),this._topBar.removeEventListener("dragend",this._eventListeners.onTopBarDragEnd,!1),this._cancelButton.removeEventListener("click",this._eventListeners.onCancelButtonClick,!1),this._okButton.removeEventListener("click",this._eventListeners.onOkButtonClick,!1),this._options.secondButtonText&&this._secondButton.removeEventListener("click",this._eventListeners.onCancelButtonClick,!1),document.removeEventListener("keydown",this._eventListeners.onKeydown,{capture:!0}),this._eventListeners.onKeydown.destructor(),this._eventListeners.onTopBarDragStart.destructor(),this._eventListeners.onTopBarDragEnd.destructor(),this._eventListeners.onCancelButtonClick.destructor(),this._eventListeners.onOkButtonClick.destructor(),this._leftPanEventDispatcher.detach(),this._rightPanEventDispatcher.detach(),document.body.removeChild(this._backgroundDiv)}onCancel(){this._BaseDialogDestructor(),this._onPromiseErrorFct("Canceled by user")}canClose(){return!0}onOk(e){return!!this.canClose()&&(this._BaseDialogDestructor(),this._onPromiseOkFct(e),!0)}onShow(){}get title(){return""}get contentHTMLElements(){return[]}get footerHTMLElements(){return[]}show(){return new Promise(((e,t)=>this._show(e,t)))}showWait(){this._waitDiv.classList.remove("TravelNotes-Hidden"),this._okButton.classList.add("TravelNotes-Hidden")}hideWait(){this._waitDiv.classList.add("TravelNotes-Hidden"),this._okButton.classList.remove("TravelNotes-Hidden")}showError(e){this._errorDiv.textContent="",_.sanitizeToHtmlElement(e,this._errorDiv),this._errorDiv.classList.remove("TravelNotes-Hidden")}hideError(){this._errorDiv.textContent="",this._errorDiv.classList.add("TravelNotes-Hidden")}get keyboardELEnabled(){return this._keyboardELEnabled}set keyboardELEnabled(e){this._keyboardELEnabled=e}}const Le=new class{_mainHTMLElement=null;_messageHTMLElement=null;_timerId=null;_showHelpInput=null;_showHelpHTMLElement=null;_showHelp=e.errorsUI.showHelp;_onHelpInputChange(){this._showHelp=!this._showHelpInput.checked}_hide(){this._timerId&&(clearTimeout(this._timerId),this._timerId=null),this._mainHTMLElement.classList.remove("TravelNotes-ErrorsUI-Error"),this._mainHTMLElement.classList.remove("TravelNotes-ErrorsUI-Warning"),this._mainHTMLElement.classList.remove("TravelNotes-ErrorsUI-Info"),this._mainHTMLElement.classList.remove("TravelNotes-ErrorsUI-Help"),this._mainHTMLElement.classList.add("TravelNotes-Hidden"),this._showHelpHTMLElement.classList.add("TravelNotes-Hidden"),this._messageHTMLElement.textContent=""}_show(t,s){if("Error"===s&&!e.errorsUI.showError||"Warning"===s&&!e.errorsUI.showWarning||"Info"===s&&!e.errorsUI.showInfo||"Help"===s&&!e.errorsUI.showHelp||"Help"===s&&!this._showHelp)return;this._timerId&&(clearTimeout(this._timerId),this._timerId=null),_.sanitizeToHtmlElement(t,this._messageHTMLElement),this._mainHTMLElement.classList.add("TravelNotes-ErrorsUI-"+s),this._mainHTMLElement.classList.remove("TravelNotes-Hidden");let o=e.errorsUI.timeOut;"Help"===s&&(this._showHelpHTMLElement.classList.remove("TravelNotes-Hidden"),o=e.errorsUI.helpTimeOut),this._timerId=setTimeout((()=>this._hide()),o)}constructor(){}createUI(){if(this._mainHTMLElement)return;this._mainHTMLElement=X.create("div",{id:"TravelNotes-ErrorsUI",className:"TravelNotes-Hidden"},document.body);let e=X.create("div",null,this._mainHTMLElement);X.create("span",{id:"TravelNotes-ErrorsUI-CancelButton",textContent:"❌"},e).addEventListener("click",(()=>this._hide()),!1),this._messageHTMLElement=X.create("div",{id:"TravelNotes-ErrorsUI-Message"},this._mainHTMLElement),this._showHelpHTMLElement=X.create("div",{id:"TravelNotes-ErrorsUI-HelpInputDiv",className:"TravelNotes-Hidden"},this._mainHTMLElement),this._showHelpInput=X.create("input",{id:"TravelNotes-ErrorsUI-HelpInput",type:"checkbox"},this._showHelpHTMLElement),this._showHelpInput.addEventListener("change",(()=>this._onHelpInputChange()),!1),X.create("label",{id:"TravelNotes-ErrorsUI-HelpInputLabel",htmlFor:"TravelNotes-ErrorsUI-HelpInput",textContent:I.getText("ErrorUI - Dont show again")},this._showHelpHTMLElement)}showError(e){this._show(e,"Error")}showWarning(e){this._show(e,"Warning")}showInfo(e){this._show(e,"Info")}showHelp(e){this._show(e,"Help")}};
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file PasswordDialogEventListeners.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/class Ee{_passwordInput=null;constructor(e){this._passwordInput=e}destructor(){this._passwordInput=null}handleEvent(e){e.stopPropagation,this._passwordInput.type="text"}}class Pe{_passwordInput=null;constructor(e){this._passwordInput=e}destructor(){this._passwordInput=null}handleEvent(e){e.stopPropagation,this._passwordInput.type="password",this._passwordInput.focus()}}class Ne extends Te{_passwordDiv=null;_passwordInput=null;_eyeSpan=null;_verifyPassword=!1;_onMouseDownEyeEventListener=null;_onMouseUpEyeEventListener=null;constructor(e){super(),this._verifyPassword=e,this._passwordDiv=X.create("div",{id:"TravelNotes-PasswordDialog-PasswordDiv"}),this._passwordInput=X.create("input",{type:"password"},this._passwordDiv),this._onMouseDownEyeEventListener=new Ee(this._passwordInput),this._onMouseUpEyeEventListener=new Pe(this._passwordInput),this._eyeSpan=X.create("span",{id:"TravelNotes-PasswordDialog-EyeSpan",textContent:"👁️"},this._passwordDiv),this._eyeSpan.addEventListener("mousedown",this._onMouseDownEyeEventListener,!1),this._eyeSpan.addEventListener("mouseup",this._onMouseUpEyeEventListener,!1)}_destructor(){this._eyeSpan.removeEventListener("mousedown",this._onMouseDownEyeEventListener,!1),this._eyeSpan.removeEventListener("mouseup",this._onMouseUpEyeEventListener,!1),this._onMouseDownEyeEventListener.destructor(),this._onMouseUpEyeEventListener.destructor()}canClose(){return this.hideError(),!(this._verifyPassword&&(this._passwordInput.value.length<12||!this._passwordInput.value.match(/[0-9]+/)||!this._passwordInput.value.match(/[a-z]+/)||!this._passwordInput.value.match(/[A-Z]+/)||!this._passwordInput.value.match(/[^0-9a-zA-Z]/)))||(this.showError("<p>"+I.getText("PasswordDialog - Password rules1")+"</p><ul><li>"+I.getText("PasswordDialog - Password rules2")+"</li><li>"+I.getText("PasswordDialog - Password rules3")+"</li><li>"+I.getText("PasswordDialog - Password rules4")+"</li><li>"+I.getText("PasswordDialog - Password rules5")+"</li><li>"+I.getText("PasswordDialog - Password rules6")+"</li></ul>"),this._passwordInput.focus(),!1)}onCancel(){this._destructor(),super.onCancel()}onOk(){this._destructor(),super.onOk((new window.TextEncoder).encode(this._passwordInput.value))}onShow(){this._passwordInput.focus()}get contentHTMLElements(){return[this._passwordDiv]}get title(){return I.getText("PasswordDialog - password")}}
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file DataEncryptor.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/class De{_salt=null;_importKey(e){return window.crypto.subtle.importKey("raw",e,{name:"PBKDF2"},!1,["deriveKey"])}_deriveKey(e,t){return window.crypto.subtle.deriveKey({name:"PBKDF2",salt:(new window.TextEncoder).encode(t),iterations:1e6,hash:"SHA-256"},e,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}_decrypt(e,t){return window.crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(t.slice(0,16))},e,new Uint8Array(t.slice(16)))}_encrypt(e,t,s){return window.crypto.subtle.encrypt({name:"AES-GCM",iv:t},e,s)}constructor(e){this._salt=e||"Tire la chevillette la bobinette cherra. Le Petit Chaperon rouge tira la chevillette."}encryptData(e,t,s,o){let i=window.crypto.getRandomValues(new Uint8Array(16));o.then(this._importKey).then((e=>this._deriveKey(e,this._salt))).then((t=>this._encrypt(t,i,e))).then((e=>{t(new Blob([i,new Uint8Array(e)],{type:"application/octet-stream"}))})).catch(s)}decryptData(e,t,s,o){o.then(this._importKey).then((e=>this._deriveKey(e,this._salt))).then((t=>this._decrypt(t,e))).then(t).catch(s)}}class je{constructor(){}handleEvent(e){e.stopPropagation();let t=new Event("apikeydeleted");t.data={objId:Number.parseInt(e.target.dataset.tanObjId)},e.target.parentNode.parentNode.dispatchEvent(t)}}class Ae{_rootHTMLElement=null;_providerNameInput=null;_providerKeyInput=null;_objId=d;constructor(t){this._objId=v.nextObjId,this._rootHTMLElement=X.create("div",{className:"TravelNotes-APIKeysDialog-ApiKeyRow"}),this._providerNameInput=X.create("input",{className:"TravelNotes-APIKeysDialog-ApiKeyName TravelNotes-APIKeysDialog-Input",value:t.providerName,placeholder:I.getText("APIKeysDialog - provider name")},this._rootHTMLElement),this._providerKeyInput=X.create("input",{className:"TravelNotes-APIKeysDialog-ApiKeyValue TravelNotes-APIKeysDialog-Input",value:t.providerKey,placeholder:I.getText("APIKeysDialog - API key"),type:e.APIKeysDialog.showAPIKeys?"text":"password"},this._rootHTMLElement),X.create("div",{className:"TravelNotes-BaseDialog-Button TravelNotes-APIKeysDialog-AtRightButton TravelNotes-APIKeysDialog-DeleteRowButton",title:I.getText("APIKeysDialog - delete API key"),textContent:"❌",dataset:{ObjId:this._objId}},this._rootHTMLElement).addEventListener("click",new je,!1)}get objId(){return this._objId}get HTMLElements(){return[this._rootHTMLElement]}get providerName(){return this._providerNameInput.value}get providerKey(){return this._providerKeyInput.value}get APIKey(){return Object.seal({providerName:this._providerNameInput.value,providerKey:this._providerKeyInput.value})}}class xe{_APIKeysDialog=null;constructor(e){this._APIKeysDialog=e}destructor(){this._APIKeysDialog=null}onErrorDecrypt(e){this._APIKeysDialog.hideWait(),this._APIKeysDialog.keyboardELEnabled=!0,e&&"Canceled by user"!==e&&this._APIKeysDialog.showError(I.getText("APIKeysDialog - An error occurs when reading the file"))}onOkDecrypt(e){try{this._APIKeysDialog.addAPIKeys(JSON.parse((new TextDecoder).decode(e)))}catch(e){return void this.onErrorDecrypt(e)}this._APIKeysDialog.hideWait(),this._APIKeysDialog.hideError(),this._APIKeysDialog.keyboardELEnabled=!0}onOkEncrypt(e){this._APIKeysDialog.hideError(),this._APIKeysDialog.hideWait(),T.saveFile("APIKeys",e),this._APIKeysDialog.keyboardELEnabled=!0}onErrorEncrypt(){this._APIKeysDialog.showError(I.getText("APIKeysDialog - An error occurs when saving the keys")),this._APIKeysDialog.hideWait(),this._APIKeysDialog.keyboardELEnabled=!0}}class Ke{_APIKeysControls=null;constructor(e){this._APIKeysControls=e}destructor(){this._APIKeysControls=null}getAPIKeysJsonString(){let e=[];return this._APIKeysControls.forEach((t=>{e.push(t.APIKey)})),JSON.stringify(e)}}class Me{_APIKeysDialog=null;_APIKeysControls=null;constructor(e,t){this._APIKeysDialog=e,this._APIKeysControls=t}destructor(){this._APIKeysDialog=null,this._APIKeysControls=null}handleEvent(e){e.stopPropagation(),this._APIKeysControls.delete(e.data.objId),this._APIKeysDialog.refreshAPIKeys()}}class Oe{_APIKeysDialog=null;constructor(e){this._APIKeysDialog=e}destructor(){this._APIKeysDialog=null}handleEvent(e){e.stopPropagation();let t=new FileReader;t.onload=()=>{try{this._APIKeysDialog.addAPIKeys(JSON.parse(t.result))}catch(e){this._APIKeysDialog.showError(e.message),e instanceof Error&&console.error(e)}},t.readAsText(e.target.files[0])}}class Ce{_APIKeysDialog=null;_openUnsecureFileInputEventListener=null;constructor(e){this._APIKeysDialog=e,this._openUnsecureFileInputEventListener=new Oe(this._APIKeysDialog)}destructor(){this._APIKeysDialog=null,this._openUnsecureFileInputEventListener.destructor()}handleEvent(e){e.stopPropagation(),this._APIKeysDialog.hideError(),T.openFile(this._openUnsecureFileInputEventListener,".json")}}class Se{_APIKeysDialog=null;_dataEncryptorHandlers=null;constructor(e){this._APIKeysDialog=e,this._dataEncryptorHandlers=new xe(this._APIKeysDialog)}destructor(){this._APIKeysDialog=null,this._dataEncryptorHandlers.destructor()}handleEvent(e){e.stopPropagation(),this._APIKeysDialog.hideError(),this._APIKeysDialog.showWait(),this._APIKeysDialog.keyboardELEnabled=!1,fetch(window.location.href.substr(0,window.location.href.lastIndexOf("/")+1)+"APIKeys").then((e=>{c===e.status&&e.ok?e.arrayBuffer().then((e=>{(new De).decryptData(e,(e=>{this._dataEncryptorHandlers.onOkDecrypt(e)}),(e=>{this._dataEncryptorHandlers.onErrorDecrypt(e)}),new Ne(!1).show())})):this._dataEncryptorHandlers.onErrorDecrypt(new Error("Invalid http status"))})).catch((e=>{this._dataEncryptorHandlers.onErrorDecrypt(e),e instanceof Error&&console.error(e)}))}}class He{_APIKeysDialog=null;_dataEncryptorHandlers=null;constructor(e){this._APIKeysDialog=e,this._dataEncryptorHandlers=new xe(this._APIKeysDialog)}destructor(){this._APIKeysDialog=null,this._dataEncryptorHandlers.destructor()}handleEvent(e){e.stopPropagation(),this._APIKeysDialog.showWait(),this._APIKeysDialog.keyboardELEnabled=!1;let t=new FileReader;t.onload=()=>{(new De).decryptData(t.result,(e=>{this._dataEncryptorHandlers.onOkDecrypt(e)}),(e=>{this._dataEncryptorHandlers.onErrorDecrypt(e)}),new Ne(!1).show())},t.readAsArrayBuffer(e.target.files[0])}}class Fe{_APIKeysDialog=null;_openSecureFileInputEventListener=null;constructor(e){this._APIKeysDialog=e,this._openSecureFileInputEventListener=new He(this._APIKeysDialog)}destructor(){this._APIKeysDialog=null,this._openSecureFileInputEventListener.destructor()}handleEvent(e){e.stopPropagation(),this._APIKeysDialog.hideError(),T.openFile(this._openSecureFileInputEventListener)}}class ke{_APIKeysDialog=null;_APIKeysControls=null;_saveAPIKeysHelper=null;_dataEncryptorHandlers=null;constructor(e,t){this._APIKeysDialog=e,this._APIKeysControls=t,this._saveAPIKeysHelper=new Ke(this._APIKeysControls),this._dataEncryptorHandlers=new xe(this._APIKeysDialog)}destructor(){this._APIKeysDialog=null,this._APIKeysControls=null,this._saveAPIKeysHelper.destructor(),this._dataEncryptorHandlers.destructor()}handleEvent(e){e.stopPropagation(),this._APIKeysDialog.validateAPIKeys()&&(this._APIKeysDialog.showWait(),this._APIKeysDialog.keyboardELEnabled=!1,(new De).encryptData((new window.TextEncoder).encode(this._saveAPIKeysHelper.getAPIKeysJsonString()),(e=>this._dataEncryptorHandlers.onOkEncrypt(e)),(()=>this._dataEncryptorHandlers.onErrorEncrypt()),new Ne(!0).show()))}}class Be{_APIKeysDialog=null;_APIKeysControls=null;_saveAPIKeysHelper=null;constructor(e,t){this._APIKeysDialog=e,this._APIKeysControls=t,this._saveAPIKeysHelper=new Ke(this._APIKeysControls)}destructor(){this._APIKeysDialog=null,this._APIKeysControls=null,this._saveAPIKeysHelper.destructor()}handleEvent(e){e.stopPropagation(),this._APIKeysDialog.validateAPIKeys()&&T.saveFile("APIKeys.json",this._saveAPIKeysHelper.getAPIKeysJsonString(),"application/json")}}class Re{_APIKeysDialog=null;_APIKeysControls=null;constructor(e,t){this._APIKeysDialog=e,this._APIKeysControls=t}destructor(){this._APIKeysDialog=null,this._APIKeysControls=null}handleEvent(e){e.stopPropagation();let t=Object.seal({providerName:"",providerKey:""}),s=new Ae(t);this._APIKeysControls.set(s.objId,s),this._APIKeysDialog.refreshAPIKeys()}}class Ue{_APIKeysDialog=null;_APIKeysControls=null;_haveAPIKeysFile=!1;_rootHTMLElement=null;_reloadKeysFromServerButton=null;_saveKeysToSecureFileButton=null;_restoreKeysFromSecureFileButton=null;_newAPIKeyButton=null;_saveKeysToUnsecureFileButton=null;_restoreKeysFromUnsecureFileButton=null;_reloadKeysFromServerButtonEventListener=null;_saveKeysToSecureFileButtonEventListener=null;_restoreKeysFromSecureFileButtonEventListener=null;_newAPIKeyButtonEventListener=null;_saveKeysToUnsecureFileButtonEventListener=null;_restoreKeysFromUnsecureFileButtonEventListener=null;_createReloadKeysFromServerButton(){this._reloadKeysFromServerButton=X.create("div",{className:"TravelNotes-BaseDialog-Button",title:I.getText("APIKeysDialog - Reload from server"),textContent:"🔄"},this._rootHTMLElement),this._reloadKeysFromServerButtonEventListener=new Se(this._APIKeysDialog),this._reloadKeysFromServerButton.addEventListener("click",this._reloadKeysFromServerButtonEventListener,!1)}_createSaveKeysToSecureFileButton(){this._saveKeysToSecureFileButton=X.create("div",{className:"TravelNotes-BaseDialog-Button",title:I.getText("APIKeysDialog - Save to file"),textContent:"💾"},this._rootHTMLElement),this._saveKeysToSecureFileButtonEventListener=new ke(this._APIKeysDialog,this._APIKeysControls),this._saveKeysToSecureFileButton.addEventListener("click",this._saveKeysToSecureFileButtonEventListener,!1)}_createRestoreKeysFromSecureFileButton(){this._restoreKeysFromSecureFileButton=X.create("div",{className:"TravelNotes-BaseDialog-Button",title:I.getText("APIKeysDialog - Open file"),textContent:"📂"},this._rootHTMLElement),this._restoreKeysFromSecureFileButtonEventListener=new Fe(this._APIKeysDialog),this._restoreKeysFromSecureFileButton.addEventListener("click",this._restoreKeysFromSecureFileButtonEventListener,!1)}_createNewAPIKeyButton(){this._newAPIKeyButton=X.create("div",{className:"TravelNotes-BaseDialog-Button",title:I.getText("APIKeysDialog - new API key"),textContent:"+"},this._rootHTMLElement),this._newAPIKeyButtonEventListener=new Re(this._APIKeysDialog,this._APIKeysControls),this._newAPIKeyButton.addEventListener("click",this._newAPIKeyButtonEventListener,!1)}_createSaveKeysToUnsecureFileButton(){this._saveKeysToUnsecureFileButton=X.create("div",{className:"TravelNotes-BaseDialog-Button TravelNotes-APIKeysDialog-AtRightButton",title:I.getText("APIKeysDialog - Save to json file"),textContent:"💾"},this._rootHTMLElement),this._saveKeysToUnsecureFileButtonEventListener=new Be(this._APIKeysDialog,this._APIKeysControls),this._saveKeysToUnsecureFileButton.addEventListener("click",this._saveKeysToUnsecureFileButtonEventListener,!1)}_createRestoreKeysFromUnsecureFileButton(){this._restoreKeysFromUnsecureFileButton=X.create("div",{className:"TravelNotes-BaseDialog-Button",title:I.getText("APIKeysDialog - Open json file"),textContent:"📂"},this._rootHTMLElement),this._restoreKeysFromUnsecureFileButtonEventListener=new Ce(this._APIKeysDialog),this._restoreKeysFromUnsecureFileButton.addEventListener("click",this._restoreKeysFromUnsecureFileButtonEventListener,!1)}_addToolbarButtons(){window.crypto&&window.crypto.subtle&&window.crypto.subtle.importKey&&window.isSecureContext&&(this._haveAPIKeysFile&&this._createReloadKeysFromServerButton(),this._createSaveKeysToSecureFileButton(),this._createRestoreKeysFromSecureFileButton()),this._createNewAPIKeyButton(),e.APIKeysDialog.haveUnsecureButtons&&(this._createSaveKeysToUnsecureFileButton(),this._createRestoreKeysFromUnsecureFileButton())}constructor(e,t,s){this._APIKeysDialog=e,this._APIKeysControls=t,this._haveAPIKeysFile=s,this._rootHTMLElement=X.create("div",{id:"TravelNotes-APIKeysDialog-ToolbarDiv"}),this._addToolbarButtons()}destructor(){this._reloadKeysFromServerButton&&(this._reloadKeysFromServerButton.removeEventListener("click",this._reloadKeysFromServerButtonEventListener,!1),this._reloadKeysFromServerButtonEventListener.destructor()),this._saveKeysToSecureFileButton&&(this._saveKeysToSecureFileButton.removeEventListener("click",this._saveKeysToSecureFileButtonEventListener,!1),this._saveKeysToSecureFileButtonEventListener.destructor()),this._restoreKeysFromSecureFileButton&&(this._restoreKeysFromSecureFileButton.removeEventListener("click",this._restoreKeysFromSecureFileButtonEventListener,!1),this._restoreKeysFromSecureFileButtonEventListener.destructor()),this._newAPIKeyButton&&(this._newAPIKeyButton.removeEventListener("click",this._newAPIKeyButtonEventListener,!1),this._newAPIKeyButtonEventListener.destructor()),this._saveKeysToUnsecureFileButton&&(this._saveKeysToUnsecureFileButton.removeEventListener("click",this._saveKeysToUnsecureFileButtonEventListener,!1),this._saveKeysToUnsecureFileButtonEventListener.destructor()),this._restoreKeysFromUnsecureFileButton&&(this._restoreKeysFromUnsecureFileButton.removeEventListener("click",this._restoreKeysFromUnsecureFileButtonEventListener,!1),this._restoreKeysFromUnsecureFileButtonEventListener.destructor())}get rootHTMLElement(){return this._rootHTMLElement}}class ze extends Te{_APIKeysControls=new Map;_toolbar=null;_APIKeysControlsContainer=null;_onAPIKeyDeletedEventListener=null;_createAPIKeysControlsContainer(){this._APIKeysControlsContainer=X.create("div"),this._onAPIKeyDeletedEventListener=new Me(this,this._APIKeysControls),this._APIKeysControlsContainer.addEventListener("apikeydeleted",this._onAPIKeyDeletedEventListener,!1)}constructor(e,t){super(),this._toolbar=new Ue(this,this._APIKeysControls,t),this._createAPIKeysControlsContainer(),this.addAPIKeys(e)}_destructor(){this._toolbar.destructor(),this._APIKeysControlsContainer.removeEventListener("apikeydeleted",this._onAPIKeyDeletedEventListener,!1),this._onAPIKeyDeletedEventListener.destructor()}validateAPIKeys(){this.hideError();let e=!1,t=[];this._APIKeysControls.forEach((s=>{e=e||""===s.providerName||""===s.providerKey,t.push(s.providerName)}));let s=!1;return t.forEach((e=>{s=s||t.indexOf(e)!==t.lastIndexOf(e)})),e?(this.showError(I.getText("APIKeysDialog - empty API key name or value")),!1):!s||(this.showError(I.getText("APIKeysDialog - duplicate API key name found")),!1)}addAPIKeys(e){this._APIKeysControls.clear(),e.forEach((e=>{let t=new Ae(e);this._APIKeysControls.set(t.objId,t)})),this.refreshAPIKeys()}refreshAPIKeys(){for(;this._APIKeysControlsContainer.firstChild;)this._APIKeysControlsContainer.removeChild(this._APIKeysControlsContainer.firstChild);this._APIKeysControls.forEach((e=>{this._APIKeysControlsContainer.appendChild(e.HTMLElements[0])}))}canClose(){return this.validateAPIKeys()}onCancel(){this._destructor(),super.onCancel()}onOk(){let e=[];this._APIKeysControls.forEach((t=>e.push(t.APIKey))),super.onOk(e)&&this._destructor()}get title(){return I.getText("APIKeysDialog - API keys")}get contentHTMLElements(){return[this._toolbar.rootHTMLElement,this._APIKeysControlsContainer]}}const Ve=new class{_haveAPIKeysFile=!1;_APIKeysMap=new Map;_onOkDecryptServerFile(e){let t=JSON.parse((new TextDecoder).decode(e));this._resetAPIKeys(t)}_onErrorDecryptServerFile(e){e instanceof Error&&console.error(e),e&&"Canceled by user"!==e&&Le.showError(I.getText("APIKeysManager - An error occurs when reading the APIKeys file"))}_onServerFileFound(e){window.isSecureContext&&window.crypto&&window.crypto.subtle&&window.crypto.subtle.importKey&&(new De).decryptData(e,(e=>this._onOkDecryptServerFile(e)),(e=>this._onErrorDecryptServerFile(e)),new Ne(!1).show())}_getAPIKey(e){return this._APIKeysMap.get(e.toLowerCase())}_setAPIKey(e,t){this._APIKeysMap.set(e.toLowerCase(),t)}_setAPIKeysFromSessionStorage(){let e=0;for(let t=0;t<sessionStorage.length;t++){let s=sessionStorage.key(t);"ProviderKey"===s.substr(s.length-"ProviderKey".length)&&(this._setAPIKey(s.substr(0,s.length-"ProviderKey".length),atob(sessionStorage.getItem(s))),e++)}return F.providers.forEach((e=>{e.providerKey=this._getAPIKey(e.name)||""})),e}_resetAPIKeys(t){sessionStorage.clear(),this._APIKeysMap.clear();let s=T.storageAvailable("sessionStorage")&&e.APIKeys.saveToSessionStorage;t.forEach((e=>{s&&sessionStorage.setItem(e.providerName.toLowerCase()+"ProviderKey",btoa(e.providerKey)),this._setAPIKey(e.providerName,e.providerKey)})),F.providers.forEach((e=>{e.providerKey=this._getAPIKey(e.name)||""})),k.dispatch("providersadded")}constructor(){}hasKey(e){return this._APIKeysMap.has(e.toLowerCase())}getUrl(e){if(e.providerKeyNeeded){let t=this._APIKeysMap.get(e.providerName.toLowerCase());return t?e.url.replace("{providerKey}",t):null}return e.url}setKeysFromServerFile(){let e=!1;0!==this._setAPIKeysFromSessionStorage()&&(k.dispatch("providersadded"),e=!0),fetch(window.location.href.substr(0,window.location.href.lastIndexOf("/")+1)+"APIKeys").then((t=>{c===t.status&&t.ok&&(this._haveAPIKeysFile=!0,e||t.arrayBuffer().then((e=>this._onServerFileFound(e))))})).catch((e=>{e instanceof Error&&console.error(e)}))}setKeysFromDialog(){let e=[];this._APIKeysMap.forEach(((t,s)=>{e.push(Object.seal({providerName:s,providerKey:t}))})),e.sort(((e,t)=>e.providerName.localeCompare(t.providerName))),new ze(e,this._haveAPIKeysFile).show().then((e=>this._resetAPIKeys(e))).catch((e=>{e instanceof Error&&console.error(e)}))}addProvider(e){let t=new e,s=t.name.toLowerCase(),o=this._getAPIKey(s);t.providerKeyNeeded&&!o&&T.storageAvailable("sessionStorage")&&(o=sessionStorage.getItem(s),o&&(o=atob(o))),t.providerKeyNeeded&&o&&(t.providerKey=o),F.providers.set(t.name.toLowerCase(),t)}};class We{_name=null;_service=null;_url=null;_wmsOptions=null;_bounds=null;_minZoom=null;_maxZoom=null;_toolbar=null;_providerName=null;_providerKeyNeeded=!1;_attribution=null;_getCapabilitiesUrl=null;constructor(e){if(!e.name||"string"!=typeof e.name)throw new Error("invalid name for layer");if(this._name=_.sanitizeToJsString(e.name),!e.service||"wms"!==e.service&&"wmts"!==e.service)throw new Error("invalid service for layer "+this._name);if(this._service=e.service,!e.url||"string"!=typeof e.url)throw new Error("invalid url for layer "+this._name);if(this._url=e.url,"wms"===this._service){if(!(e.wmsOptions&&e.wmsOptions.layers&&"string"==typeof e.wmsOptions.layers&&e.wmsOptions.format&&"string"==typeof e.wmsOptions.format&&e.wmsOptions.transparent&&"boolean"==typeof e.wmsOptions.transparent))throw new Error("invalid wmsOptions for layer "+this._name);this._wmsOptions=e.wmsOptions,this._wmsOptions.layers=_.sanitizeToJsString(this._wmsOptions.layers),this._wmsOptions.format=_.sanitizeToJsString(this._wmsOptions.format)}try{e.bounds&&"number"==typeof e.bounds[0][0]&&"number"==typeof e.bounds[0][1]&&"number"==typeof e.bounds[1][0]&&"number"==typeof e.bounds[1][1]&&(this._bounds=e.bounds)}catch(e){throw new Error("invalid bounds for layer "+this._name)}if(e.minZoom&&"number"==typeof e.minZoom&&(this._minZoom=e.minZoom),e.maxZoom&&"number"==typeof e.maxZoom&&(this._maxZoom=e.maxZoom),!(e.toolbar&&e.toolbar.text&&"string"==typeof e.toolbar.text&&e.toolbar.color&&"string"==typeof e.toolbar.color&&e.toolbar.backgroundColor&&"string"==typeof e.toolbar.backgroundColor))throw new Error("invalid toolbar for layer "+this._name);if(this._toolbar=e.toolbar,this._toolbar.text=_.sanitizeToJsString(this._toolbar.text),this._toolbar.color=_.sanitizeToColor(this._toolbar.color)||"#000000",this._toolbar.backgroundColor=_.sanitizeToColor(this._toolbar.backgroundColor)||"#ffffff",!e.providerName||"string"!=typeof e.providerName)throw new Error("invalid providerName for layer "+this._name);if(this._providerName=_.sanitizeToJsString(e.providerName),"boolean"!=typeof e.providerKeyNeeded)throw new Error("invalid providerKeyNeeded for layer "+this._name);if(this._providerKeyNeeded=e.providerKeyNeeded,""===e.attribution)this._attribution="";else{if(!e.attribution||"string"!=typeof e.attribution)throw new Error("invalid attribution for map layer "+this._name);this._attribution=_.sanitizeToHtmlString(e.attribution).htmlString}if(e.getCapabilitiesUrl&&"string"==typeof e.getCapabilitiesUrl&&(this._getCapabilitiesUrl=_.sanitizeToUrl(e.getCapabilitiesUrl).url,""===this._getCapabilitiesUrl))throw new Error("invalid getCapabilitiesUrl for map layer "+this._name)}get name(){return this._name}get service(){return this._service}get url(){return this._url}get wmsOptions(){return this._wmsOptions}get bounds(){return this._bounds}get minZoom(){return this._minZoom}get maxZoom(){return this._maxZoom}get toolbar(){return this._toolbar}get providerName(){return this._providerName}get providerKeyNeeded(){return this._providerKeyNeeded}get attribution(){return this._attribution}get getCapabilitiesUrl(){return this._getCapabilitiesUrl}}new class{_mapLayers=new Map;_defaultMapLayer=null;_mapLayersAdded=!1;constructor(){this._defaultMapLayer=new We({service:"wmts",url:"https://{s}.tile.osm.org/{z}/{x}/{y}.png",name:"OSM - Color",toolbar:{text:"OSM",color:"#ff0000",backgroundColor:"#ffffff"},providerName:"OSM",providerKeyNeeded:!1,attribution:""}),this._mapLayers.set(this._defaultMapLayer.name,this._defaultMapLayer)}getMapLayer(e){let t=this._mapLayers.get(e)||this._defaultMapLayer;return t.providerKeyNeeded&&(Ve.hasKey(t.providerName.toLowerCase())||(t=this._defaultMapLayer)),t}forEach(e){this._mapLayers.forEach(e)}addMapLayers(e){this._mapLayersAdded||(e.forEach((e=>{let t=new We(e);this._mapLayers.get(t.name)||this._mapLayers.set(t.name,t)})),this._mapLayersAdded=!0)}get defaultMapLayer(){return this._defaultMapLayer}};class Ze{static handleEvent(e){let t=V.getRoute(e.target.objId),s=U.getClosestLatLngDistance(t,[e.latlng.lat,e.latlng.lng]).distance;s+=t.chainedDistance,s=T.formatDistance(s);let o=F.mapObjects.get(e.target.objId);o.closeTooltip();let i=t.computedName;F.travel.readOnly||(i+=0===i.length?"":" - ",i+=s),o.setTooltipContent(i),o.openTooltip(e.latlng)}}class Xe{_currentLayer=null;_geolocationCircle=null;_getDashArray(t){t.dashArray>=e.route.dashChoices.length&&(t.dashArray=0);let s=e.route.dashChoices[t.dashArray].iDashArray;if(s){let e="",o=0;for(o=0;o<s.length-1;o++)e+=s[o]*t.width+",";return e+=s[o]*t.width,e}return null}_addNote(t){let s=V.getNoteAndRoute(t).note,o=window.L.marker(s.latLng,{icon:window.L.divIcon({iconSize:[e.note.grip.size,e.note.grip.size],iconAnchor:[e.note.grip.size/2,e.note.grip.size/2],html:"<div></div>",className:"TravelNotes-Map-Note-Bullet"}),opacity:e.note.grip.opacity,draggable:!F.travel.readOnly});o.objId=s.objId;let i=window.L.divIcon({iconSize:[s.iconWidth,s.iconHeight],iconAnchor:[s.iconWidth/2,s.iconHeight/2],popupAnchor:[0,-s.iconHeight/2],html:s.iconContent,className:"TravelNotes-Map-AllNotes "}),r=window.L.marker(s.iconLatLng,{zIndexOffset:100,icon:i,draggable:!F.travel.readOnly});r.objId=s.objId,r.bindPopup((e=>_.clone(de.getNoteTextHTML("TravelNotes-Map-",V.getNoteAndRoute(e.objId))))),0!==s.tooltipContent.length&&(r.bindTooltip((e=>V.getNoteAndRoute(e.objId).note.tooltipContent)),r.getTooltip().options.offset[0]=s.iconWidth/2);let a=window.L.polyline([s.latLng,s.iconLatLng],e.note.polyline);a.objId=s.objId;let n=window.L.layerGroup([r,a,o]);return n.markerId=window.L.Util.stamp(r),n.polylineId=window.L.Util.stamp(a),n.bulletId=window.L.Util.stamp(o),this.addToMap(s.objId,n),e.note.haveBackground&&document.querySelectorAll(".TravelNotes-MapNote,.TravelNotes-SvgIcon").forEach((e=>e.classList.add("TravelNotes-Map-Note-Background"))),Object.freeze({marker:r,polyline:a,bullet:o})}constructor(){}addToMap(e,t){t.objId=e,t.addTo(F.map),F.mapObjects.set(e,t)}addRoute(e){let t=V.getRoute(e),s=[],o=t.itinerary.itineraryPoints.iterator;for(;!o.done;)s.push(o.value.latLng);let i=window.L.polyline(s,{color:t.color,weight:t.width,dashArray:this._getDashArray(t)});this.addToMap(t.objId,i),r.notEdited===t.editionStatus&&(i.bindTooltip(t.computedName,{sticky:!0,direction:"right"}),window.L.DomEvent.on(i,"mouseover",Ze.handleEvent),window.L.DomEvent.on(i,"mousemove",Ze.handleEvent)),i.bindPopup((e=>_.clone(he.getRouteHeaderHTML("TravelNotes-Map-",V.getRoute(e.objId))))),window.L.DomEvent.on(i,"click",(e=>e.target.openPopup(e.latlng)));let a=t.notes.iterator;for(;!a.done;)this._addNote(a.value.objId);return t}addNote(e){return this._addNote(e)}getDashArray(e){return this._getDashArray(e)}zoomTo(t,s){if(s){let e=[];s.forEach((t=>e=e.concat(t))),F.map.fitBounds(U.getLatLngBounds(e))}else F.map.setView(t,e.itineraryPoint.zoomFactor)}setLayer(e,t){let s=null;s="wmts"===e.service.toLowerCase()?window.L.tileLayer(t):window.L.tileLayer.wms(t,e.wmsOptions),this._currentLayer&&F.map.removeLayer(this._currentLayer),F.map.addLayer(s),this._currentLayer=s,F.travel.readOnly||(F.map.getZoom()<(e.minZoom||0)&&F.map.setZoom(e.minZoom||0),F.map.setMinZoom(e.minZoom||0),F.map.getZoom()>(e.maxZoom||18)&&F.map.setZoom(e.maxZoom||18),F.map.setMaxZoom(e.maxZoom||18),e.bounds?(F.map.getBounds().intersects(e.bounds)&&!F.map.getBounds().contains(e.bounds)||(F.map.setMaxBounds(null),F.map.fitBounds(e.bounds),F.map.setZoom(e.minZoom||0)),F.map.setMaxBounds(e.bounds)):F.map.setMaxBounds(null)),F.map.fire("baselayerchange",s)}onGeolocationStatusChanged(e){s.active!==e&&this._geolocationCircle&&(F.map.removeLayer(this._geolocationCircle),this._geolocationCircle=null)}onGeolocationPositionChanged(t){let s=e.geoLocation.zoomToPosition;this._geolocationCircle&&(F.map.removeLayer(this._geolocationCircle),s=!1),this._geolocationCircle=window.L.circleMarker(window.L.latLng(t.coords.latitude,t.coords.longitude),e.geoLocation.marker).bindTooltip(T.formatLatLng([t.coords.latitude,t.coords.longitude])).addTo(F.map),s&&F.map.setView(window.L.latLng(t.coords.latitude,t.coords.longitude),e.geoLocation.zoomFactor)}}class Ye{constructor(){}handleEvent(e){if(e.stopPropagation(),"Z"===e.key||"z"===e.key)(new W).zoomToTravel();else if("G"===e.key||"g"===e.key)G.switch();else{let t=e.key.charCodeAt(0);47<t&&58>t&&Q.setMapLayer(e.key)}}}class Ge{_travelUrl=null;_language=null;_addLayerToolbar=!1;_originAndPath=window.location.href.substr(0,window.location.href.lastIndexOf("/")+1)+"TravelNotes";static _mapEditorViewer=new Xe;_addEventsListeners(){document.addEventListener("keydown",new Ye,!0),document.addEventListener("routeupdated",(e=>{e.data&&Ge._mapEditorViewer.addRoute(e.data.addedRouteObjId)}),!1),document.addEventListener("noteupdated",(e=>{e.data&&Ge._mapEditorViewer.addNote(e.data.addedNoteObjId)}),!1),document.addEventListener("zoomto",(e=>{e.data&&Ge._mapEditorViewer.zoomTo(e.data.latLng,e.data.geometry)}),!1),document.addEventListener("layerchange",(e=>{e.data&&Ge._mapEditorViewer.setLayer(e.data.layer,e.data.layer.url)})),document.addEventListener("geolocationpositionchanged",(e=>{e.data&&Ge._mapEditorViewer.onGeolocationPositionChanged(e.data.position)}),!1),document.addEventListener("geolocationstatuschanged",(e=>{e.data&&Ge._mapEditorViewer.onGeolocationStatusChanged(e.data.status)}),!1)}_readURL(){let e=new URL(window.location),t=e.searchParams.get("fil");if(t&&0!==t.length)try{if(t=atob(t),t.match(/[^\w-%:./]/))throw new Error("invalid char in the url encoded in the fil parameter");let s=new URL(t);if(!(e.protocol&&s.protocol&&e.protocol===s.protocol&&e.hostname&&s.hostname&&e.hostname===s.hostname))throw new Error("The distant file is not on the same site than the app");this._travelUrl=encodeURI(s.href)}catch(e){e instanceof Error&&console.error(e)}let s=e.searchParams.get("lng");s&&s.match(/^[A-Z,a-z]{2}$/)&&(this._language=s.toLowerCase()),""===e.searchParams.get("lay")&&(this._addLayerToolbar=!0)}async _loadConfig(){let e=await fetch(this._originAndPath+"Config.json");if(c===e.status&&e.ok){let t=await e.json();return t.travelNotes.language=this._language||t.travelNotes.language,"wwwouaiebe.github.io"===window.location.hostname&&(t.note.haveBackground=!0),(new m).overload(t),!0}return!1}async _loadTranslations(){let e=await fetch(this._originAndPath+this._language.toUpperCase()+".json");return!(c!==e.status||!e.ok)&&(I.setTranslations(await e.json()),!0)}async _loadMapLayers(){let e=await fetch(this._originAndPath+"Layers.json");return!(c!==e.status||!e.ok)&&(Q.addMapLayers(await e.json()),!0)}_loadTravelNotesViewer(){let e=document.createElement("div");e.id="TravelNotes-Map",document.body.appendChild(e),F.map=window.L.map("TravelNotes-Map",{attributionControl:!1,zoomControl:!1}),F.map.setView([i.defaultValue,i.defaultValue],2),ee.addReadOnlyMap(this._travelUrl,this._addLayerToolbar)}constructor(){}async loadApp(){this._readURL(),await this._loadConfig()?(this._language=this._language||e.travelNotes.language,await this._loadTranslations()?await this._loadMapLayers()?(this._addEventsListeners(),this._loadTravelNotesViewer()):document.body.textContent="Not possible to load the TravelNotesLayers.json file. ":document.body.textContent="Not possible to load the TravelNotesConfig"+this._language.toUpperCase()+".json file. "):document.body.textContent="Not possible to load the TravelNotesConfig.json file. "}}(new Ge).loadApp()}();