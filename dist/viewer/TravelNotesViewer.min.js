/**
 * 
 * @source: https://github.com/wwwouaiebe/leaflet.TravelNotes
 * 
 * @licstart  The following is the entire license notice for the
 * JavaScript code in this page.
 * 
 * leaflet.travelnotes - version 2.3.0
 * Build 02577 - 2021-09-01T12:31:43+0200 
 * Copyright 2017 2021 wwwouaiebe 
 * Contact: https://www.ouaie.be/
 * License: GPL-3.0
 * 
 * The JavaScript code in this page is free software: you can
 * redistribute it and/or modify it under the terms of the GNU
 * General Public License (GNU GPL) as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option)
 * any later version.  The code is distributed WITHOUT ANY WARRANTY;
 * without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.
 * 
 * As additional permission under GNU GPL version 3 section 7, you
 * may distribute non-source (e.g., minimized or compacted) forms of
 * that code without the copy of the GNU GPL normally required by
 * section 4, provided you include this license notice and a URL
 * through which recipients can access the Corresponding Source.
 * 
 * @licend  The above is the entire license notice
 * for the JavaScript code in this page.
 * 
 */


!function(){"use strict";
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file Config.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/let t={APIKeys:{saveToSessionStorage:!0},APIKeysDialog:{haveUnsecureButtons:!0,showAPIKeys:!0,showButton:!0},contextMenu:{timeout:1500},errorsUI:{helpTimeOut:3e4,showError:!0,showHelp:!0,showInfo:!0,showWarning:!0,timeOut:1e4},geoCoder:{distances:{city:1200,hamlet:200,town:1500,village:400},osmCityAdminLevel:{DEFAULT:"8",GB:"10"}},geoLocation:{marker:{color:"#ff0000",radius:11},options:{enableHighAccuracy:!1,maximumAge:0,timeout:1/0},zoomFactor:17,zoomToPosition:!0},itineraryPaneUI:{showManeuvers:!1,showNotes:!0},itineraryPoint:{marker:{color:"#ff0000",fill:!1,radius:7,weight:2},zoomFactor:17},layersToolbarUI:{haveLayersToolbarUI:!0,toolbarTimeOut:1500,theDevil:{addButton:!1}},map:{center:{lat:50.50923,lng:5.49542},zoom:12},mouseUI:{haveMouseUI:!0},nominatim:{url:"https://nominatim.openstreetmap.org/",language:"*"},note:{grip:{size:10,opacity:0,moveOpacity:1},haveBackground:!1,maxManeuversNotes:100,polyline:{color:"#808080",weight:1},reverseGeocoding:!1,svgIcon:{angleDistance:10,angleDirection:{right:35,slightRight:80,continue:100,slightLeft:145,left:200,sharpLeft:270,sharpRight:340},rcnRefDistance:20,roadbookFactor:1,zoom:17}},noteDialog:{areaHeight:{icon:2,popupContent:8},mask:{iconsDimension:!0,iconTextArea:!1,tooltip:!1,popupContent:!1,address:!1,link:!1,phone:!0},theDevil:{addButton:!1,zoomFactor:17}},osmSearch:{nextSearchLimit:{color:"#ff0000",fill:!1,weight:1},previousSearchLimit:{color:"#006400",fill:!1,weight:1},searchPointMarker:{color:"#006400",fill:!1,radius:20,weight:4},searchPointPolyline:{color:"#006400",fill:!1,weight:4},showSearchNoteDialog:!1},overpassApi:{timeOut:40,url:"https://lz4.overpass-api.de/api/interpreter"},printRouteMap:{isEnabled:!0,maxTiles:240,paperWidth:287,paperHeight:200,pageBreak:!1,printNotes:!0,borderWidth:30,zoomFactor:15,entryPointMarker:{color:"#00ff00",weight:4,radius:10,fill:!0,fillOpacity:1},exitPointMarker:{color:"#ff0000",weight:4,radius:10,fill:!0,fillOpacity:1}},route:{color:"#ff0000",dashArray:0,dashChoices:[{text:"——————",iDashArray:[0]},{text:"— — — — —",iDashArray:[4,2]},{text:"—‧—‧—‧—‧—",iDashArray:[4,2,0,2]},{text:"················",iDashArray:[0,2]}],elev:{smooth:!0,smoothCoefficient:.25,smoothPoints:3},showDragTooltip:3,width:3},routeEditor:{showEditedRouteInRoadbook:!0},travelEditor:{startMinimized:!0,startupRouteEdition:!0,timeout:1e3},travelNotes:{autoLoad:!0,haveBeforeUnloadWarning:!0,language:"fr"},travelNotesToolbarUI:{contactMail:{url:"https://github.com/wwwouaiebe/leaflet.TravelNotes/issues"}},wayPoint:{reverseGeocoding:!1,geocodingIncludeName:!1}};
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file Constants.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/const e=Object.freeze({minColorValue:0,maxColorValue:255,rowsNumber:6,cellsNumber:6,deltaColor:51,sliderMaxValue:100,sliderStep:20,initialRed:0});Object.freeze({notSaved:"🔴",modified:"🟡",saved:"🟢"});const o=Object.freeze({fixed:2,invalid:-1,defaultValue:0,metersInKm:1e3}),i=Object.freeze({refusedByUser:-1,disabled:0,inactive:1,active:2});Object.freeze({invalidPane:"43a6a53e-008a-4910-80a6-7a87d301ea15",itineraryPane:"8fbf0da7-4e6f-4bc7-8e20-1388461ccde7",travelNotesPane:"dffe782b-07df-4b81-a318-f287c0cf5ec6",searchPane:"228f00d7-43a8-4c13-897d-70400cb6dd58"});const n=Object.freeze({fixed:2,defaultValue:0}),s=Object.freeze({defaultValue:0,fixed:6,maxLat:90,minLat:-90,maxLng:180,minLng:-180}),a=Object.freeze({notEdited:0,editedNoChange:1,editedChanged:2}),r=Object.freeze({margin:100,height:500,width:1e3,yDeltaText:30,xDeltaText:10,vScales:[1,2,5,10,20,50,100,200,500,1e3,2e3,5e3],hScales:[1,2,5,10,20,50,100,200,500,1e3,2e3,5e3,1e4,2e4,5e4,1e5]}),l=Object.freeze({width:40,height:40,svgViewboxDim:200}),d=Object.freeze({d0:0,d90:90,d180:180,d270:270,d360:360,d540:540,toRadians:Math.PI/180,fromRadians:180/Math.PI}),h=Object.freeze({atStart:-1,onRoute:0,atEnd:1}),c=-1,u=-1,p=16,g=200,v="http://www.w3.org/2000/svg",m=6371e3,y=20;const b=Object.freeze(new class{#validityMap=new Map;#parser=new DOMParser;#addHtmlEntities(t){return t.replaceAll(/</g,"&lt;").replaceAll(/>/g,"&gt;").replaceAll(/"/g,"&quot;").replaceAll(/\u0027/g,"&apos;").replaceAll(/\u0a00/g,"&nbsp;")}#stringify(t){let e="",o="",i=t.childNodes;for(let n=0;n<i.length;n++){let i=t.childNodes[n],s=i.nodeName.toLowerCase(),a=this.#validityMap.get(s);if(a){a=a.concat(["id","class","dir","title","tanwidth","tanheight"]);let t="svg"===s||"text"===s||"polyline"===s;e+="<"+s,i.hasAttribute("target")&&(e+=' rel="noopener noreferrer"'),a.forEach((n=>{if(t)i.hasAttributeNS(null,n)&&(e+=" "+n+'="'+this.#addHtmlEntities(i.getAttribute(n))+'"',i.removeAttribute(n));else if(i.hasAttribute(n))if("href"===n||"src"===n){let t=this.sanitizeToUrl(i.getAttribute(n),n).url;""===t?o+="\nAn invalid url ("+i.getAttribute(n)+") was removed from a "+n+" attribute":e+=" "+n+'="'+t+'"',i.removeAttribute(n)}else e+=" "+n+'="'+this.#addHtmlEntities(i.getAttribute(n))+'"',i.removeAttribute(n)})),e+=">";let n="",r="";[n,r]=this.#stringify(i),e+=n,o+=r,e+="</"+s+">"}else"#text"===s?e+=this.#addHtmlEntities(i.nodeValue):o+="\nAn invalid tag "+s+" was removed";if(i.hasAttributes)for(let t=0;t<i.attributes.length;t++)"rel"!==i.attributes[t].name&&(o+="\nAn unsecure attribute "+i.attributes[t].name+'="'+i.attributes[t].value+'" was removed.')}return[e,o]}#cloneNode(t,e){let o=t.childNodes;for(let i=0;i<o.length;i++){let o=t.childNodes[i],n=o.nodeName.toLowerCase(),s=this.#validityMap.get(n);if(s){s=s.concat(["id","class","dir","title","tanwidth","tanheight"]);let t="svg"===n||"text"===n||"polyline"===n,i=t?document.createElementNS(v,n):document.createElement(n);if(s.forEach((e=>{if(t)o.hasAttributeNS(null,e)&&(i.setAttributeNS(null,e,o.getAttribute(e)),o.removeAttributeNS(null,e));else if(o.hasAttribute(e))if("href"===e||"src"===e){let t=this.sanitizeToUrl(o.getAttribute(e),e).url;""!==t&&i.setAttribute(e,t)}else i.setAttribute(e,o.getAttribute(e))})),o.hasAttribute("style")){o.getAttribute("style").split(";").forEach((t=>{let e=t.split(":");2!==e.length||"width"!==e[0].trim()&&"height"!==e[0].trim()||(i.style[e[0].trim()]=e[1].trim())}))}o.hasAttribute("target")&&i.setAttribute("rel","noopener noreferrer"),e.appendChild(i),this.#cloneNode(o,i)}else"#text"===n&&e.appendChild(document.createTextNode(o.nodeValue))}}constructor(){this.#validityMap.set("a",["href","target"]),this.#validityMap.set("div",[]),this.#validityMap.set("del",[]),this.#validityMap.set("em",[]),this.#validityMap.set("figcaption",[]),this.#validityMap.set("figure",[]),this.#validityMap.set("h1",[]),this.#validityMap.set("h2",[]),this.#validityMap.set("h3",[]),this.#validityMap.set("h4",[]),this.#validityMap.set("h5",[]),this.#validityMap.set("h6",[]),this.#validityMap.set("hr",[]),this.#validityMap.set("img",["src","alt","width","height"]),this.#validityMap.set("ins",[]),this.#validityMap.set("li",[]),this.#validityMap.set("mark",[]),this.#validityMap.set("ol",[]),this.#validityMap.set("p",[]),this.#validityMap.set("s",[]),this.#validityMap.set("small",[]),this.#validityMap.set("strong",[]),this.#validityMap.set("span",[]),this.#validityMap.set("sub",[]),this.#validityMap.set("sup",[]),this.#validityMap.set("ul",[]),this.#validityMap.set("svg",["xmlns","viewBox","class"]),this.#validityMap.set("text",["x","y","text-anchor"]),this.#validityMap.set("polyline",["points","class","transform"])}sanitizeToColor(t){let e=t.match(/^\u0023[0-9,A-F,a-f]{6}$/);return e?e[0]:null}sanitizeToUrl(t,e="href"){let o=this.#parser.parseFromString("<div>"+t+"</div>","text/html");if(!o||"#document"!==o.nodeName)return{url:"",errorsString:"Parsing error"};let i=o.body.firstChild,n="";for(let t=0;t<i.childNodes.length;t++){if("#text"!==i.childNodes[t].nodeName)return{url:"",errorsString:"Invalid characters found in the url"};n+=i.childNodes[t].nodeValue}if(n=n.replaceAll(/</g,"").replaceAll(/>/g,"").replaceAll(/"/g,"").replaceAll(/\u0027/g,"").replaceAll(/&lt;/g,"").replaceAll(/&gt;/g,"").replaceAll(/&quot;/g,"").replaceAll(/&apos;/g,"").replaceAll(/%3C/g,"").replaceAll(/%3c/g,"").replaceAll(/%3E/g,"").replaceAll(/%3e/g,"").replaceAll(/%22/g,"").replaceAll(/%27/g,""),n!==t)return{url:"",errorsString:"Invalid characters found in the url"};let s=["https:"];if("http:"!==window.location.protocol&&"href"!==e||s.push("http:"),"href"===e){s.push("mailto:"),s.push("sms:"),s.push("tel:");let t=n.match(/^\u0023\w*/);if(t&&n===t[0])return{url:n,errorsString:""}}"src"===e&&s.push("data:");let a=null;try{a=new URL(n)}catch(t){return{url:"",errorsString:"Invalid url string"}}if(u===s.indexOf(a.protocol))return{url:"",errorsString:"Invalid protocol "+a.protocol};if(u!==["sms:","tel:"].indexOf(a.protocol)&&a.pathname.match(/^\+[0-9,*,\u0023]*$/))return{url:n,errorsString:""};try{encodeURIComponent(a.href)}catch(t){return{url:"",errorsString:"Invalid character in url"}}return{url:n,errorsString:""}}sanitizeToJsString(t){let e=this.#parser.parseFromString("<div>"+t+"</div>","text/html");if(!e||"#document"!==e.nodeName)return"";let o=e.body.firstChild,i="";for(let t=0;t<o.childNodes.length;t++){if("#text"!==o.childNodes[t].nodeName)return"";i+=o.childNodes[t].nodeValue}return i=i.replaceAll(/</g,"≺").replaceAll(/>/g,"≻").replaceAll(/"/g,"″").replaceAll(/\u0027/g,"′"),i}sanitizeToHtmlElement(t,e){let o=this.#parser.parseFromString("<div>"+t+"</div>","text/html");o&&"#document"===o.nodeName?this.#cloneNode(o.body.firstChild,e):e.textContent=""}sanitizeToHtmlString(t){let e="",o="",i=this.#parser.parseFromString("<div>"+t.replace("&nbsp;","਀")+"</div>","text/html");return i&&"#document"===i.nodeName?([e,o]=this.#stringify(i.body.firstChild,o),{htmlString:e,errorsString:o}):{htmlString:"",errorsString:"Parsing error"}}});class w{#copyObjectTo(t,e){if("object"==typeof t&&"object"==typeof e){for(let o in e)"object"==typeof e[o]?this.#copyObjectTo(t[o],e[o]):typeof t[o]==typeof e[o]&&("string"==typeof e[o]?e[o]="color"===o?b.sanitizeToColor(t[o])||e[o]:"url"===o?b.sanitizeToUrl(t[o]).url:b.sanitizeToJsString(t[o]):e[o]=t[o]||e[o]);for(let o in t)"object"==typeof t[o]?("[object Array]"===Object.prototype.toString.call(t[o])?e[o]=e[o]||[]:e[o]=e[o]||{},this.#copyObjectTo(t[o],e[o])):"string"==typeof e.property?e[o]=b.sanitizeToHtmlString(t[o],[]).htmlString:e[o]=t[o]}}#freeze(t){for(let e in t)"object"==typeof t[e]&&this.#freeze(t[e]);Object.freeze(t)}overload(e){this.#copyObjectTo(e,t),this.#freeze(t)}}class D{static#objId=0;static get nextObjId(){return++D.#objId}}
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file Version.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/const I="2.3.0";class f{#objTypeName="";#validObjTypeNames=["Itinerary","ItineraryPoint","Maneuver","Note","Route","Travel","WayPoint"];constructor(t){if(u===this.#validObjTypeNames.indexOf(t))throw new Error("Invalid ObjType name : "+t);this.#objTypeName=t,Object.freeze(this)}get name(){return this.#objTypeName}get version(){return I}get jsonObject(){return{name:this.#objTypeName,version:I}}validate(t){if(!Object.getOwnPropertyNames(t).includes("name"))throw new Error("No name for "+this.#objTypeName);if(this.#objTypeName!==t.name)throw new Error("Invalid name for "+this.#objTypeName);if(!Object.getOwnPropertyNames(t).includes("version"))throw new Error("No version for "+this.#objTypeName)}}class L{#collection=null;#index=u;constructor(t){this.#collection=t,Object.freeze(this)}get value(){return this.#index<this.#collection.length?this.#collection.at(this.#index):null}get previous(){return 0>=this.#index?null:this.#collection.at(this.#index-1)}get next(){return this.#index<this.#collection.length-1?this.#collection.at(this.#index+1):null}get done(){return++this.#index>=this.#collection.length}get first(){return 0===this.#index}get last(){return this.#index>=this.#collection.length-1}get index(){return this.#index}}class T{#array=[];#objName="";#classCollection=null;#indexOfObjId(t){return this.#array.findIndex((e=>e.objId===t))}#nextOrPrevious(t,e,o){let i=this.#indexOfObjId(t);if(u===i)throw new Error("invalid objId for next or previous function");if(1!==o&&-1!==o)throw new Error("invalid direction");let n=e;for(n||(n=()=>!0),i+=o;u<i&&i<this.#array.length&&!n(this.#array[i]);)i+=o;return u===i||this.#array.length===i?null:this.#array[i]}constructor(t){this.#classCollection=t;let e=new t;if(!e.objType||!e.objType.name)throw new Error("invalid object name for collection");this.#objName=e.objType.name,Object.freeze(this)}add(t){if(!t.objType||!t.objType.name||t.objType.name!==this.#objName)throw new Error("invalid object name for add function");this.#array.push(t)}at(t){return t<this.#array.length&&t>u?this.#array[t]:null}forEach(t){let e=null,o=this.iterator;for(;!o.done;)e=t(o.value,e);return e}getAt(t){let e=this.#indexOfObjId(t);return u===e?null:this.#array[e]}moveTo(t,e,o){let i=this.#indexOfObjId(t),n=this.#indexOfObjId(e);if(u===i||u===n)throw new Error("invalid objId for function  myMoveTo");o||n++,this.#array.splice(n,0,this.#array[i]),n<i&&i++,this.#array.splice(i,1)}next(t,e){return this.#nextOrPrevious(t,e,1)}previous(t,e){return this.#nextOrPrevious(t,e,-1)}remove(t){let e=this.#indexOfObjId(t);if(u===e)throw new Error("invalid objId for remove function");this.#array.splice(this.#indexOfObjId(t),1)}removeAll(t){t?this.#array.splice(1,this.#array.length-2):this.#array.length=0}replace(t,e){let o=this.#indexOfObjId(t);if(u===o)throw new Error("invalid objId for replace function");if(!e.objType||!e.objType.name||e.objType.name!==this.#objName)throw new Error("invalid object name for replace function");this.#array[o]=e}reverse(){this.#array.reverse()}sort(t){this.#array.sort(t)}swap(t,e){let o=this.#indexOfObjId(t);if(u===o||0===o&&e||this.#array.length-1===o&&!e)throw new Error("invalid objId for swap function");let i=this.#array[o];this.#array[o]=this.#array[o+(e?-1:1)],this.#array[o+(e?-1:1)]=i}get first(){return this.#array[0]}get iterator(){return new L(this)}get last(){return this.#array[this.#array.length-1]}get length(){return this.#array.length}get jsonObject(){let t=[],e=this.iterator;for(;!e.done;)t.push(e.value.jsonObject);return t}set jsonObject(t){this.#array.length=0;let e=null;t.forEach((t=>{e=new this.#classCollection,e.jsonObject=t,this.add(e)}))}}const N=new class{#translations=new Map;constructor(){Object.freeze(this)}setTranslations(t){t.forEach((t=>this.#translations.set(t.msgid,b.sanitizeToJsString(t.msgstr))))}getText(t,e){let o=this.#translations.get(t);return e&&o&&Object.getOwnPropertyNames(e).forEach((t=>o=o.replace("{"+t+"}",e[t]))),o||t}};const E=new class{constructor(){Object.freeze(this)}get UUID(){let t=new Uint8Array(16);const e=["","","","-","","-","","-","","-","","","","","",""];window.crypto.getRandomValues(t),t[6]=15&t[6]|64,t[8]=63&t[8]|128;let o="";for(let i=0;i<16;i++)o+=t[i].toString(p).padStart(2,"0")+e[i];return o}storageAvailable(t){try{let e=window[t],o="__storage_test__";return e.setItem(o,o),e.removeItem(o),!0}catch(t){return!1}}openFile(t,e){let o=document.createElement("input");o.type="file",e&&(o.accept=e),o.addEventListener("change",t,!1),o.click()}saveFile(t,e,o){try{let i=null;i=o?window.URL.createObjectURL(new File([e],t,{type:o})):URL.createObjectURL(e);let n=document.createElement("a");n.setAttribute("href",i),n.setAttribute("download",t),n.click(),window.URL.revokeObjectURL(i)}catch(t){t instanceof Error&&console.error(t)}}formatTime(t){let e=Math.floor(t);if(0===e)return"";let o=Math.floor(e/86400),i=Math.floor(e%86400/3600),n=Math.floor(e%3600/60),s=Math.floor(e%60);return 0<o?o+" "+N.getText("Utilities - Day")+" "+i+" "+N.getText("Utilities - Hour"):0<i?i+" "+N.getText("Utilities - Hour")+" "+n+" "+N.getText("Utilities - Minute"):0<n?n+" "+N.getText("Utilities - Minute"):s+" "+N.getText("Utilities - Second")}formatDistance(t){let e=Math.floor(t);return 0>=e?"0 km":Math.floor(e/o.metersInKm)+","+Math.floor(e%o.metersInKm/10).toFixed(0).padStart(2,"0").padEnd(3,"0")+" km"}formatLat(t){return t>0?t.toFixed(s.fixed)+" N":(-t).toFixed(s.fixed)+" S"}formatLng(t){return t>0?t.toFixed(s.fixed)+" E":(-t).toFixed(s.fixed)+" W"}formatLatLng(t){return 0===t[0]&&0===t[1]?"":this.formatLat(t[0])+" - "+this.formatLng(t[1])}},P=new f("WayPoint");class C{#objId=c;#upgradeObject(t){switch(t.objType.version){case"1.0.0":case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":case"1.5.0":case"1.6.0":case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":t.address=t.name,t.name="";case"1.12.0":case"1.13.0":case"2.0.0":case"2.1.0":case"2.2.0":t.objType.version="2.3.0";break;default:throw new Error("invalid version for "+P.name)}}#validateObject(t){if(!Object.getOwnPropertyNames(t).includes("objType"))throw new Error("No objType for "+P.name);P.validate(t.objType),P.version!==t.objType.version&&this.#upgradeObject(t);let e=Object.getOwnPropertyNames(t);return["address","name","lat","lng","objId"].forEach((t=>{if(!e.includes(t))throw new Error("No "+t+" for "+P.name)})),t}constructor(){this.name="",this.address="",this.lat=s.defaultValue,this.lng=s.defaultValue,this.#objId=D.nextObjId,Object.seal(this)}get fullName(){let t=""===this.name?this.address:this.name+", "+this.address;return""===t&&(t=E.formatLatLng([this.lat,this.lng])),t}get latLng(){return[this.lat,this.lng]}set latLng(t){this.lat=t[0],this.lng=t[1]}get objId(){return this.#objId}get objType(){return P}get jsonObject(){return{name:this.name,address:this.address,lat:parseFloat(this.lat.toFixed(s.fixed)),lng:parseFloat(this.lng.toFixed(s.fixed)),objId:this.#objId,objType:P.jsonObject}}set jsonObject(t){let e=this.#validateObject(t);this.address=e.address||"",this.name=e.name||"",this.lat=e.lat||s.defaultValue,this.lng=e.lng||s.defaultValue,this.#objId=D.nextObjId,this.validateData()}validateData(){"string"==typeof this.address?this.address=b.sanitizeToJsString(this.address):this.address="","string"==typeof this.name?this.name=b.sanitizeToJsString(this.name):this.name="","number"!=typeof this.lat&&(this.lat=s.defaultValue),"number"!=typeof this.lng&&(this.lng=s.defaultValue)}}const x=new f("ItineraryPoint");class A{#objId=c;#upgradeObject(t){switch(t.objType.version){case"1.0.0":case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":case"1.5.0":case"1.6.0":t.elev=n.defaultValue;case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":case"1.12.0":case"1.13.0":case"2.0.0":case"2.1.0":case"2.2.0":t.objType.version="2.3.0";break;default:throw new Error("invalid version for "+x.name)}}#validateObject(t){if(!Object.getOwnPropertyNames(t).includes("objType"))throw new Error("No objType for "+x.name);x.validate(t.objType),x.version!==t.objType.version&&this.#upgradeObject(t);let e=Object.getOwnPropertyNames(t);return["lat","lng","distance","elev","objId"].forEach((t=>{if(!e.includes(t))throw new Error("No "+t+" for "+x.name)})),t}constructor(){this.lat=s.defaultValue,this.lng=s.defaultValue,this.distance=o.defaultValue,this.elev=n.defaultValue,this.#objId=D.nextObjId,Object.seal(this)}get latLng(){return[this.lat,this.lng]}set latLng(t){this.lat=t[0],this.lng=t[1]}get objType(){return x}get objId(){return this.#objId}get jsonObject(){return{lat:parseFloat(this.lat.toFixed(s.fixed)),lng:parseFloat(this.lng.toFixed(s.fixed)),distance:parseFloat(this.distance.toFixed(o.fixed)),elev:parseFloat(this.elev.toFixed(n.fixed)),objId:this.#objId,objType:x.jsonObject}}set jsonObject(t){let e=this.#validateObject(t);this.lat=e.lat||s.defaultValue,this.lng=e.lng||s.defaultValue,this.distance=e.distance||o.defaultValue,this.elev=e.elev||n.defaultValue,this.#objId=D.nextObjId,this.validateData()}validateData(){"number"!=typeof this.lat&&(this.lat=s.defaultValue),"number"!=typeof this.lng&&(this.lng=s.defaultValue),"number"!=typeof this.distance&&(this.distance=o.defaultValue),"number"!=typeof this.elev&&(this.elev=n.defaultValue)}}const j=new f("Maneuver");class M{#objId=c;#upgradeObject(t){switch(t.objType.version){case"1.0.0":case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":case"1.5.0":case"1.6.0":case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":"kArriveDefault"===t.iconName&&(t.distance=o.defaultValue);case"1.12.0":case"1.13.0":case"2.0.0":case"2.1.0":case"2.2.0":t.objType.version="2.3.0";break;default:throw new Error("invalid version for "+j.name)}}#validateObject(t){if(!Object.getOwnPropertyNames(t).includes("objType"))throw new Error("No objType for "+j.name);j.validate(t.objType),j.version!==t.objType.version&&this.#upgradeObject(t);let e=Object.getOwnPropertyNames(t);return["iconName","instruction","distance","duration","itineraryPointObjId","objId"].forEach((t=>{if(!e.includes(t))throw new Error("No "+t+" for "+j.name)})),t}constructor(){this.iconName="",this.instruction="",this.itineraryPointObjId=c,this.distance=o.defaultValue,this.duration=o.defaultValue,this.#objId=D.nextObjId,Object.seal(this)}get objType(){return j}get objId(){return this.#objId}get jsonObject(){return{iconName:this.iconName,instruction:this.instruction,distance:parseFloat(this.distance.toFixed(o.fixed)),duration:this.duration,itineraryPointObjId:this.itineraryPointObjId,objId:this.#objId,objType:j.jsonObject}}set jsonObject(t){let e=this.#validateObject(t);this.iconName=e.iconName||"",this.instruction=e.instruction||"",this.distance=e.distance||o.defaultValue,this.duration=e.duration||o.defaultValue,this.itineraryPointObjId=e.itineraryPointObjId||c,this.#objId=D.nextObjId,this.validateData()}validateData(){"string"==typeof this.iconName?this.iconName=b.sanitizeToJsString(this.iconName):this.iconName="","string"==typeof this.instruction?this.instruction=b.sanitizeToJsString(this.instruction):this.instruction="","number"!=typeof this.distance&&(this.distance=o.defaultValue),"number"!=typeof this.duration&&(this.duration=o.defaultValue),"number"!=typeof this.itineraryPointObjId&&(this.itineraryPointObjId=c)}}const O=new f("Itinerary");class S{#objId=c;#upgradeObject(t){switch(t.objType.version){case"1.0.0":case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":case"1.5.0":case"1.6.0":t.hasProfile=!1,t.ascent=0,t.descent=0;case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":case"1.12.0":case"1.13.0":case"2.0.0":case"2.1.0":case"2.2.0":t.objType.version="2.3.0";break;default:throw new Error("invalid version for "+O.name)}}#validateObject(t){if(!Object.getOwnPropertyNames(t).includes("objType"))throw new Error("No objType for "+O.name);O.validate(t.objType),O.version!==t.objType.version&&this.#upgradeObject(t);let e=Object.getOwnPropertyNames(t);return["hasProfile","ascent","descent","itineraryPoints","maneuvers","provider","transitMode","objId"].forEach((t=>{if(!e.includes(t))throw new Error("No "+t+" for "+O.name)})),t}constructor(){this.hasProfile=!1,this.ascent=0,this.descent=0,this.provider="",this.transitMode="",this.itineraryPoints=new T(A),this.maneuvers=new T(M),this.#objId=D.nextObjId,Object.seal(this)}get objType(){return O}get objId(){return this.#objId}get jsonObject(){return{hasProfile:this.hasProfile,ascent:this.ascent,descent:this.descent,itineraryPoints:this.itineraryPoints.jsonObject,maneuvers:this.maneuvers.jsonObject,provider:this.provider,transitMode:this.transitMode,objId:this.#objId,objType:O.jsonObject}}set jsonObject(t){let e=this.#validateObject(t);this.hasProfile=e.hasProfile||!1,this.ascent=e.ascent||0,this.descent=e.descent||0,this.itineraryPoints.jsonObject=e.itineraryPoints||[],this.maneuvers.jsonObject=e.maneuvers||[],this.provider=e.provider||"",this.transitMode=e.transitMode||"",this.#objId=D.nextObjId;let o=new Map,i=0,n=this.itineraryPoints.iterator;for(;!n.done;)o.set(e.itineraryPoints[i].objId,n.value.objId),i++;let s=this.maneuvers.iterator;for(;!s.done;)s.value.itineraryPointObjId=o.get(s.value.itineraryPointObjId);this.validateData()}validateData(){"boolean"!=typeof this.hasProfile&&(this.hasProfile=!1),"number"!=typeof this.ascent&&(this.ascent=0),"number"!=typeof this.descent&&(this.descent=0),"string"==typeof this.provider?this.provider=b.sanitizeToJsString(this.provider):this.provider="","string"==typeof this.transitMode?this.transitMode=b.sanitizeToJsString(this.transitMode):this.transitMode=""}}const R=new f("Note");class k{#objId=c;#UpdateStyles(t){return t.replaceAll(/style='color:white;background-color:red'/g,"class='TravelNotes-Note-WhiteRed'").replaceAll(/style='color:white;background-color:green'/g,"class='TravelNotes-Note-WhiteGreen'").replaceAll(/style='color:white;background-color:blue'/g,"class='TravelNotes-Note-WhiteBlue'").replaceAll(/style='color:white;background-color:brown'/g,"class='TravelNotes-Note-WhiteBrown'").replaceAll(/style='color:white;background-color:black'/g,"class='TravelNotes-Note-WhiteBlack'").replaceAll(/style='border:solid 0.1em'/g,"class='TravelNotes-Note-BlackWhite'").replaceAll(/style='background-color:white;'/g,"class='TravelNotes-Note-Knooppunt'").replaceAll(/style='fill:green;font:bold 120px sans-serif;'/g,"").replaceAll(/style='fill:none;stroke:green;stroke-width:10;'/g,"")}#upgradeObject(t){switch(t.objType.version){case"1.0.0":case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":case"1.5.0":case"1.6.0":case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":case"1.12.0":case"1.13.0":"string"==typeof t.iconHeight&&(t.iconHeight=Number.parseInt(t.iconHeight)),"string"==typeof t.iconWidth&&(t.iconWidth=Number.parseInt(t.iconWidth)),t.iconContent=this.#UpdateStyles(t.iconContent),t.popupContent=this.#UpdateStyles(t.popupContent),t.tooltipContent=this.#UpdateStyles(t.tooltipContent),t.phone=this.#UpdateStyles(t.phone),t.address=this.#UpdateStyles(t.address);case"2.0.0":case"2.1.0":case"2.2.0":t.objType.version="2.3.0";break;default:throw new Error("invalid version for "+R.name)}}#validateObject(t){if(!Object.getOwnPropertyNames(t).includes("objType"))throw new Error("No objType for "+R.name);R.validate(t.objType),R.version!==t.objType.version&&this.#upgradeObject(t);let e=Object.getOwnPropertyNames(t);return["iconHeight","iconWidth","iconContent","popupContent","tooltipContent","phone","url","address","iconLat","iconLng","lat","lng","distance","chainedDistance","objId"].forEach((t=>{if(!e.includes(t))throw new Error("No "+t+" for "+R.name)})),t}constructor(){this.iconHeight=l.height,this.iconWidth=l.width,this.iconContent="",this.popupContent="",this.tooltipContent="",this.phone="",this.url="",this.address="",this.iconLat=s.defaultValue,this.iconLng=s.defaultValue,this.lat=s.defaultValue,this.lng=s.defaultValue,this.distance=o.invalid,this.chainedDistance=o.defaultValue,this.#objId=D.nextObjId,Object.seal(this)}get isRouteNote(){return this.distance!==o.invalid}get iconLatLng(){return[this.iconLat,this.iconLng]}set iconLatLng(t){this.iconLat=t[0],this.iconLng=t[1]}get latLng(){return[this.lat,this.lng]}set latLng(t){this.lat=t[0],this.lng=t[1]}get objType(){return R}get objId(){return this.#objId}get jsonObject(){return{iconHeight:this.iconHeight,iconWidth:this.iconWidth,iconContent:this.iconContent,popupContent:this.popupContent,tooltipContent:this.tooltipContent,phone:this.phone,url:this.url,address:this.address,iconLat:parseFloat(this.iconLat.toFixed(s.fixed)),iconLng:parseFloat(this.iconLng.toFixed(s.fixed)),lat:parseFloat(this.lat.toFixed(s.fixed)),lng:parseFloat(this.lng.toFixed(s.fixed)),distance:parseFloat(this.distance.toFixed(o.fixed)),chainedDistance:parseFloat(this.chainedDistance.toFixed(o.fixed)),objId:this.#objId,objType:R.jsonObject}}set jsonObject(t){let e=this.#validateObject(t);this.iconHeight=e.iconHeight||l.height,this.iconWidth=e.iconWidth||l.width,this.iconContent=e.iconContent||"",this.popupContent=e.popupContent||"",this.tooltipContent=e.tooltipContent||"",this.phone=e.phone||"",this.url=e.url||"",this.address=e.address||"",this.iconLat=e.iconLat||s.defaultValue,this.iconLng=e.iconLng||s.defaultValue,this.lat=e.lat||s.defaultValue,this.lng=e.lng||s.defaultValue,this.distance=e.distance||o.invalid,this.chainedDistance=e.chainedDistance||o.defaultValue,this.#objId=D.nextObjId,this.validateData(!0)}validateData(t){if("number"!=typeof this.iconHeight&&(this.iconHeight=l.height),"number"!=typeof this.iconWidth&&(this.iconWidth=l.width),"string"==typeof this.iconContent){let e=b.sanitizeToHtmlString(this.iconContent);t&&""!==e.errorsString&&console.log(e.errorsString+" ("+this.iconContent+")"),this.iconContent=e.htmlString}else this.iconContent="";if("string"==typeof this.popupContent){let e=b.sanitizeToHtmlString(this.popupContent);t&&""!==e.errorsString&&console.log(e.errorsString+" ("+this.popupContent+")"),this.popupContent=e.htmlString}else this.popupContent="";if("string"==typeof this.tooltipContent){let e=b.sanitizeToHtmlString(this.tooltipContent);t&&""!==e.errorsString&&console.log(e.errorsString+" ("+this.tooltipContent+")"),this.tooltipContent=e.htmlString}else this.tooltipContent="";if("string"==typeof this.phone){let e=b.sanitizeToHtmlString(this.phone);t&&""!==e.errorsString&&console.log(e.errorsString+" ("+this.phone+")"),this.phone=e.htmlString}else this.phone="";if("string"==typeof this.url&&""!==this.url){let e=b.sanitizeToUrl(this.url);t&&""!==e.errorsString&&console.log(e.errorsString+" ("+this.url+")"),this.url=encodeURI(e.url)}else this.url="";"string"==typeof this.address?this.address=b.sanitizeToHtmlString(this.address).htmlString:this.address="","number"!=typeof this.iconLat&&(this.iconLat=s.defaultValue),"number"!=typeof this.iconLng&&(this.iconLng=s.defaultValue),"number"!=typeof this.lat&&(this.lat=s.defaultValue),"number"!=typeof this.lng&&(this.lng=s.defaultValue),"number"!=typeof this.distance&&(this.distance=o.invalid),"number"!=typeof this.chainedDistance&&(this.chainedDistance=o.defaultValue)}}const B=new f("Route");class H{#objId=c;#upgradeObject(t){switch(t.objType.version){case"1.0.0":t.dashArray=0,t.hidden=!1;case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":t.edited=a.notEdited;case"1.5.0":case"1.6.0":case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":t.editionStatus=t.edited;case"1.12.0":case"1.13.0":case"2.0.0":case"2.1.0":case"2.2.0":t.objType.version="2.3.0";break;default:throw new Error("invalid version for "+B.name)}}#validateObject(t){if(!Object.getOwnPropertyNames(t).includes("objType"))throw new Error("No objType for "+B.name);B.validate(t.objType),B.version!==t.objType.version&&this.#upgradeObject(t);let e=Object.getOwnPropertyNames(t);return["name","wayPoints","notes","itinerary","width","color","dashArray","chain","distance","duration","editionStatus","hidden","chainedDistance","objId"].forEach((t=>{if(!e.includes(t))throw new Error("No "+t+" for "+B.name)})),t}constructor(){this.name="",this.wayPoints=new T(C),this.wayPoints.add(new C),this.wayPoints.add(new C),this.notes=new T(k),this.itinerary=new S,this.width=t.route.width,this.color=t.route.color,this.dashArray=t.route.dashArray,this.chain=!0,this.chainedDistance=o.defaultValue,this.distance=o.defaultValue,this.duration=o.defaultValue,this.editionStatus=a.notEdited,this.hidden=!1,this.#objId=D.nextObjId,Object.seal(this)}get computedName(){let t=this.name;return""===t&&(t=(""===this.wayPoints.first.fullName?"???":this.wayPoints.first.fullName)+" ⮞ "+(""===this.wayPoints.last.fullName?"???":this.wayPoints.last.fullName)),t}get objId(){return this.#objId}get objType(){return B}haveValidWayPoints(){let t=!0;return this.wayPoints.forEach((e=>{t=t&&s.defaultValue!==e.lat&&s.defaultValue!==e.lng})),t}get jsonObject(){return{name:this.name,wayPoints:this.wayPoints.jsonObject,notes:this.notes.jsonObject,itinerary:this.itinerary.jsonObject,width:this.width,color:this.color,dashArray:this.dashArray,chain:this.chain,distance:parseFloat(this.distance.toFixed(o.fixed)),duration:this.duration,editionStatus:this.editionStatus,hidden:this.hidden,chainedDistance:parseFloat(this.chainedDistance.toFixed(o.fixed)),objId:this.#objId,objType:B.jsonObject}}set jsonObject(e){let o=this.#validateObject(e);this.name=o.name||"",this.wayPoints.jsonObject=o.wayPoints||[],this.notes.jsonObject=o.notes||[],this.itinerary.jsonObject=o.itinerary||(new S).jsonObject,this.width=o.width||t.route.width,this.color=o.color||"#000000",this.dashArray=o.dashArray||0,this.chain=o.chain||!1,this.distance=o.distance,this.duration=o.duration,this.editionStatus=o.editionStatus||a.notEdited,this.hidden=o.hidden||!1,this.chainedDistance=o.chainedDistance,this.#objId=D.nextObjId,this.validateData()}validateData(){"string"==typeof this.name?this.name=b.sanitizeToJsString(this.name):this.name="","number"!=typeof this.width&&(this.width=t.route.width),"string"==typeof this.color?this.color=b.sanitizeToColor(this.color)||t.route.color:this.color=t.route.color,"number"!=typeof this.dashArray&&(this.dashArray=0),this.dashArray>=t.route.dashChoices.length&&(this.dashArray=0),"boolean"!=typeof this.chain&&(this.chain=!1),"number"!=typeof this.distance&&(this.distance=o.defaultValue),"number"!=typeof this.duration&&(this.duration=o.defaultValue),"number"!=typeof this.editionStatus&&(this.editionStatus=a.notEdited),"boolean"!=typeof this.hidden&&(this.hidden=!1),"number"!=typeof this.chainedDistance&&(this.chainedDistance=o.defaultValue)}}const K=new f("Travel");class F{#objId=c;#upgradeObject(t){switch(t.objType.version){case"1.0.0":case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":t.editedRoute=new H;case"1.5.0":if(t.userData.layerId){let e=[{layerId:"0",layerName:"OSM - Color"},{layerId:"1",layerName:"OSM - Black and White"},{layerId:"2",layerName:"Thunderforest - Transport"},{layerId:"3",layerName:"Thunderforest - OpenCycleMap"},{layerId:"4",layerName:"Thunderforest - Outdoors"},{layerId:"5",layerName:"Esri - Aerial view"},{layerId:"6",layerName:"Kartverket - Norway"},{layerId:"7",layerName:"IGN-NGI - Belgium now"},{layerId:"12",layerName:"Thunderforest - Landscape"},{layerId:"24",layerName:"Lantmäteriet - Sweden"},{layerId:"25",layerName:"Maanmittauslaitos - Finland"}].find((e=>e.layerId===t.userData.layerId));t.layerName=e?e.layerName:"OSM - Color"}else t.layerName="OSM - Color";case"1.6.0":case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":case"1.12.0":case"1.13.0":case"2.0.0":case"2.1.0":case"2.2.0":t.objType.version="2.3.0";break;default:throw new Error("invalid version for "+K.name)}}#validateObject(t){if(!Object.getOwnPropertyNames(t).includes("objType"))throw new Error("No objType for "+K.name);K.validate(t.objType),K.version!==t.objType.version&&this.#upgradeObject(t);let e=Object.getOwnPropertyNames(t);return["name","editedRoute","routes","objId"].forEach((t=>{if(!e.includes(t))throw new Error("No "+t+" for "+K.name)})),t}constructor(){this.editedRoute=new H,this.routes=new T(H),this.notes=new T(k),this.layerName="OSM - Color",this.name="",this.readOnly=!1,this.#objId=D.nextObjId,Object.seal(this)}get objId(){return this.#objId}get objType(){return K}get jsonObject(){return{editedRoute:this.editedRoute.jsonObject,layerName:this.layerName,name:this.name,routes:this.routes.jsonObject,notes:this.notes.jsonObject,readOnly:this.readOnly,objId:this.#objId,objType:K.jsonObject}}set jsonObject(t){let e=this.#validateObject(t);this.editedRoute.jsonObject=e.editedRoute,this.layerName=t.layerName||"OSM - Color",this.name=e.name||"",this.readOnly=e.readOnly||!1,this.routes.jsonObject=e.routes||[],this.notes.jsonObject=e.notes||[],this.#objId=D.nextObjId,this.validateData()}validateData(){"string"==typeof this.layerName?this.layerName=b.sanitizeToJsString(this.layerName):this.layerName="OSM - Color","string"==typeof this.name?this.name=b.sanitizeToJsString(this.name):this.name="TravelNotes","boolean"!=typeof this.readOnly&&(this.readOnly=!0)}}const V=new class{#providers=new Map;#mapObjects=new Map;#routing=Object.seal({provider:"",transitMode:""});#UUID=E.UUID;constructor(){this.map=null,this.travel=new F,this.editedRouteObjId=c,this.searchData=[],Object.seal(this)}get providers(){return this.#providers}get mapObjects(){return this.#mapObjects}get routing(){return this.#routing}get UUID(){return this.#UUID}};
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file EventDispatcher.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/const U=new class{constructor(){Object.freeze(this)}dispatch(t,e){let o=new Event(t);e&&(o.data=e),document.dispatchEvent(o)}};const z=new class{#python2Round(t){return Math.floor(Math.abs(t)+.5)*(0<=t?1:-1)}#encodeDelta(t,e,o){let i=this.#python2Round(t*o),n=this.#python2Round(e*o),s=i-n;s<<=1,0>i-n&&(s=~s);let a="";for(;32<=s;)a+=String.fromCharCode(63+(32|31&s)),s>>=5;return a+=String.fromCharCode(s+63),a}#index=0;#decodeDelta(t){let e=null,o=0,i=0;do{e=t.charCodeAt(this.#index++)-63,i|=(31&e)<<o,o+=5}while(32<=e);return 1&i?~(i>>1):i>>1}constructor(){Object.freeze(this)}encode(t,e){if(!t.length)return"";let o=e.length,i=Array.from(e,(t=>Math.pow(10,t))),n="";for(let e=0;e<o;e++)n+=this.#encodeDelta(t[0][e],0,i[e]);for(let e=1;e<t.length;e++){let s=t[e],a=t[e-1];for(let t=0;t<o;t++)n+=this.#encodeDelta(s[t],a[t],i[t])}return n}decode(t,e){let o=e.length;if(!t||0===t.length)return[];this.#index=0;let i=[],n=Array.from(e,(t=>Math.pow(10,t))),s=new Array(o).fill(0);for(;this.#index<t.length;){let e=new Array(o).fill(0);for(let i=0;i<o;i++)s[i]+=this.#decodeDelta(t),e[i]=s[i]/n[i];i.push(e)}return i}};class W{#compressRoute(t){let e={};0!==t.itinerary.itineraryPoints.length&&(e=t.itinerary.itineraryPoints[0].objType);let o={values:"",objType:e},i=[];t.itinerary.itineraryPoints.forEach((t=>{i.push([t.lat,t.lng,t.distance,t.elev,t.objId])})),o.values=z.encode(i,[s.fixed,s.fixed,2,2,0]),t.itinerary.itineraryPoints=o}#decompressRoute(t){let e=[];if(t.itinerary.itineraryPoints.values)z.decode(t.itinerary.itineraryPoints.values,[s.fixed,s.fixed,2,2,0]).forEach((i=>{let a={lat:s.defaultValue,lng:s.defaultValue,distance:o.defaultValue,elev:n.defaultValue,objId:c};[a.lat,a.lng,a.distance,a.elev,a.objId]=i,a.objType=t.itinerary.itineraryPoints.objType,e.push(a)}));else{t.itinerary.itineraryPoints.latLngs=z.decode(t.itinerary.itineraryPoints.latLngs,[s.fixed,s.fixed]);let o=0;t.itinerary.itineraryPoints.latLngs.forEach((i=>{let s={};s.lat=i[0],s.lng=i[1],s.distance=t.itinerary.itineraryPoints.distances[o],t.itinerary.itineraryPoints.elevs?s.elev=t.itinerary.itineraryPoints.elevs[o]:s.elev=n.defaultValue,s.objId=t.itinerary.itineraryPoints.objIds[o],s.objType=t.itinerary.itineraryPoints.objType,e.push(s),o++}))}t.itinerary.itineraryPoints=e}#decompressTravel(t){t.routes.forEach(this.#decompressRoute),t.editedRoute&&this.#decompressRoute(t.editedRoute)}constructor(){Object.freeze(this)}decompress(t){this.#decompressTravel(t),V.travel.jsonObject=t,V.editedRouteObjId=c,V.travel.routes.forEach((t=>{a.notEdited!==t.editionStatus&&(V.editedRouteObjId=t.objId)}))}decompressMerge(t){this.#decompressTravel(t);let e=new F;e.jsonObject=t;let o=e.routes.iterator;for(;!o.done;)V.travel.routes.add(o.value);let i=e.notes.iterator;for(;!i.done;)V.travel.notes.add(i.value)}compress(t){let e=t.jsonObject;return e.routes.forEach(this.#compressRoute),this.#compressRoute(e.editedRoute),e}}const G=new class{constructor(){Object.freeze(this)}getLatLngElevAtDist(t,e){if(t.distance<=e||0>=e)return null;let o=0,i=t.itinerary.itineraryPoints.iterator;for(;o<e&&!i.done;)o+=i.value.distance;let n=i.value;i.done;let s=(n.distance-o+e)/n.distance;return Object.freeze({latLng:[n.lat+(i.value.lat-n.lat)*s,n.lng+(i.value.lng-n.lng)*s],elev:n.elev+(i.value.elev-n.elev)*s,ascent:100*(i.value.elev-n.elev)/n.distance,routeDistance:e})}getClosestLatLngDistance(t,e){if(0===t.itinerary.itineraryPoints.length)return null;let i=t.itinerary.itineraryPoints.iterator;i.done;let n=Number.MAX_VALUE,s=window.L.Projection.SphericalMercator.project(window.L.latLng(e[0],e[1])),a=window.L.Projection.SphericalMercator.project(window.L.latLng(i.value.lat,i.value.lng)),r=null,l=o.defaultValue,d=i.value.distance;for(;!i.done;){let t=window.L.Projection.SphericalMercator.project(window.L.latLng(i.value.lat,i.value.lng)),e=window.L.LineUtil.pointToSegmentDistance(s,a,t);e<n&&(n=e,r=window.L.Projection.SphericalMercator.unproject(window.L.LineUtil.closestPointOnSegment(s,a,t)),l=d-r.distanceTo(window.L.latLng(i.value.lat,i.value.lng))),d+=i.value.distance,a=t}return Object.freeze({latLng:[r.lat,r.lng],distance:l})}getLatLngBounds(t){let e=window.L.latLng([s.maxLat,s.maxLng]),o=window.L.latLng([s.minLat,s.minLng]);return t.forEach((t=>{e.lat=Math.min(e.lat,t[0]),e.lng=Math.min(e.lng,t[1]),o.lat=Math.max(o.lat,t[0]),o.lng=Math.max(o.lng,t[1])})),window.L.latLngBounds(e,o)}getSquareBoundingBox(t,e){let o=e/m*d.fromRadians,i=t[0]*d.toRadians,n=Math.acos((Math.cos(e/m)-Math.sin(i)**2)/Math.cos(i)**2)*d.fromRadians;return window.L.latLngBounds(window.L.latLng([t[0]-o,t[1]-n]),window.L.latLng([t[0]+o,t[1]+n]))}project(t,e){let o=V.map.project(window.L.latLng(t),e);return[o.x,o.y]}screenCoordToLatLng(t,e){let o=V.map.containerPointToLatLng(window.L.point(t,e));return[o.lat,o.lng]}addPoints(t,e){return[t[0]+e[0],t[1]+e[1]]}subtrackPoints(t,e){return[t[0]-e[0],t[1]-e[1]]}};const X=new class{#normalizeLng(t){return(t+d.d540)%d.d360-d.d180}constructor(){Object.freeze(this)}arcFromSummitArcArc(t,e,o){return Math.acos(Math.cos(e)*Math.cos(o)+Math.sin(e)*Math.sin(o)*Math.cos(t))}summitFromArcArcArc(t,e,o){return Math.acos((Math.cos(o)-Math.cos(t)*Math.cos(e))/(Math.sin(t)*Math.sin(e)))}pointsDistance(t,e){if(t[0]===e[0]&&t[1]===e[1])return 0;let o=t[0]*d.toRadians,i=e[0]*d.toRadians,n=(this.#normalizeLng(e[1])-this.#normalizeLng(t[1]))*d.toRadians;return Math.acos(Math.sin(o)*Math.sin(i)+Math.cos(o)*Math.cos(i)*Math.cos(n))*m}};const Z=new class{#setNearestRouteData(t,e,o){if(t.objId!==V.editedRouteObjId){let i=G.getClosestLatLngDistance(t,e);if(i){let n=X.pointsDistance(e,i.latLng);n<o.distance&&(o.route=t,o.distance=n,o.latLngOnRoute=i.latLng,o.distanceOnRoute=i.distance)}}}constructor(){Object.freeze(this)}getNearestRouteData(t){let e={distance:Number.MAX_VALUE,route:null,distanceOnRoute:0,latLngOnRoute:[s.defaultValue,s.defaultValue]};return V.travel.routes.forEach((o=>this.#setNearestRouteData(o,t,e))),c!==V.editedRouteObjId&&this.#setNearestRouteData(V.travel.editedRoute,t,e),Object.freeze(e)}getRoute(t){let e=null;return e=V.travel.routes.getAt(t),e||t===V.travel.editedRoute.objId&&(e=V.travel.editedRoute),e}getNoteAndRoute(t){let e=null,o=null;if(e=V.travel.notes.getAt(t),!e){let i=V.travel.routes.iterator;for(;!i.done&&!e;)e=i.value.notes.getAt(t),e&&(o=i.value);e||(e=V.travel.editedRoute.notes.getAt(t),e&&(o=V.travel.editedRoute))}return Object.freeze({note:e,route:o})}getWayPoint(t){let e=V.travel.editedRoute.wayPoints.getAt(t);if(!e){let o=V.travel.routes.iterator;for(;!o.done&&!e;)e=o.value.wayPoints.getAt(t)}return e}};class Y{#geometry=[];#pushNoteGeometry(t){this.#geometry.push(t.latLng),this.#geometry.push(t.iconLatLng)}#pushRouteGeometry(t){t.itinerary.itineraryPoints.forEach((t=>this.#geometry.push(t.latLng))),t.notes.forEach((t=>this.#pushNoteGeometry(t)))}constructor(){Object.freeze(this)}zoomToLatLng(t){U.dispatch("zoomto",{latLng:t})}zoomToManeuver(t){let e=V.travel.editedRoute.itinerary.maneuvers.getAt(t).itineraryPointObjId,o=V.travel.editedRoute.itinerary.itineraryPoints.getAt(e).latLng;U.dispatch("zoomto",{latLng:o})}zoomToNote(t){this.#geometry=[],this.#pushNoteGeometry(Z.getNoteAndRoute(t).note),U.dispatch("zoomto",{geometry:[this.#geometry]})}zoomToRoute(t){this.#geometry=[],this.#pushRouteGeometry(Z.getRoute(t)),U.dispatch("zoomto",{geometry:[this.#geometry]})}zoomToTravel(){this.#geometry=[],V.travel.routes.forEach((t=>this.#pushRouteGeometry(t))),c!==V.travel.editedRouteObjId&&this.#pushRouteGeometry(V.travel.editedRoute),V.travel.notes.forEach((t=>this.#pushNoteGeometry(t))),U.dispatch("zoomto",{geometry:[this.#geometry]})}zoomToPoi(t){U.dispatch("zoomto",t)}}class _{constructor(){Object.freeze(this)}openDistantFile(t){(new W).decompress(t),V.travel.readOnly=!0,document.title="Travel & Notes"+(""===V.travel.name?"":" - "+V.travel.name);let e=V.travel.routes.iterator;for(;!e.done;)a.notEdited===e.value.editionStatus&&U.dispatch("routeupdated",{removedRouteObjId:c,addedRouteObjId:e.value.objId});c!==V.editedRouteObjId&&U.dispatch("routeupdated",{removedRouteObjId:c,addedRouteObjId:V.travel.editedRoute.objId});let o=V.travel.notes.iterator;for(;!o.done;)U.dispatch("noteupdated",{removedNoteObjId:c,addedNoteObjId:o.value.objId});(new Y).zoomToTravel()}}
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file HTMLElementsFactory.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/const J=new class{#addProperties(t,e){for(let o in e)try{if("dataset"===o){let o=e.dataset;for(let e in o)t.dataset["tan"+e]=o[e]}else t[o]=e[o]}catch(t){t instanceof Error&&console.error(t)}t.target&&(t.rel="noopener noreferrer")}constructor(){Object.freeze(this)}create(t,e,o){let i=null;return"text"===t.toLowerCase()?i=document.createTextNode(e.value||""):(i="select"===t.toLowerCase()?document.createElement(t):Object.seal(document.createElement(t)),e&&this.#addProperties(i,e)),o&&o.appendChild(i),i}};const q=new class{#attributionsDiv=null;constructor(){Object.freeze(this)}createUI(){this.#attributionsDiv=J.create("div",{id:"TravelNotes-AttributionsUI"},document.body)}set attributions(t){let e='© <a href="https://leafletjs.com/" target="_blank" title="Leaflet">Leaflet</a> | © <a href="https://www.openstreetmap.org/copyright" target="_blank" title="OpenStreetMap contributors">OpenStreetMap contributors</a> '+t+'| © <a href="https://github.com/wwwouaiebe" target="_blank" title="https://github.com/wwwouaiebe">Travel & Notes</a>';for(;this.#attributionsDiv.firstChild;)this.#attributionsDiv.removeChild(this.#attributionsDiv.firstChild);b.sanitizeToHtmlElement(e,this.#attributionsDiv)}};const Q=new class{#status="geolocation"in navigator?i.inactive:i.disabled;#watchId=null;#showPosition(t){U.dispatch("geolocationpositionchanged",{position:t})}#stop(){i.active===this.#status&&(this.#status=i.inactive),U.dispatch("geolocationstatuschanged",{status:this.#status}),navigator.geolocation.clearWatch(this.#watchId),this.#watchId=null}#error(t){1===t.code&&(this.#status=i.refusedByUser),this.#stop()}#start(){this.#status=i.active,U.dispatch("geolocationstatuschanged",{status:this.#status}),navigator.geolocation.getCurrentPosition(this.#showPosition,this.#error,t.geoLocation.options),this.#watchId=navigator.geolocation.watchPosition(this.#showPosition,this.#error,t.geoLocation.options)}constructor(){Object.freeze(this)}get status(){return this.#status}switch(){switch(this.#status){case i.inactive:this.#start();break;case i.active:this.#stop()}return this.#status}};class ${#mapLayers=null;constructor(t){this.#mapLayers=t}handleEvent(t){t.stopPropagation();let e=this.#mapLayers[Number.parseInt(t.target.dataset.tanMapLayerId)];U.dispatch("layerchange",{layer:e}),q.attributions=e.attribution}}class tt{handleEvent(t){t.stopPropagation(),Q.switch()}}class et{handleEvent(t){t.stopPropagation(),(new Y).zoomToTravel()}}const ot=new class{#mapLayersToolbar=null;#mapLayers=[{service:"wmts",url:"https://{s}.tile.osm.org/{z}/{x}/{y}.png",name:"OSM - Color",toolbar:{text:"OSM",color:"red",backgroundColor:"white"},providerName:"OSM",providerKeyNeeded:!1,attribution:""}];constructor(){Object.freeze(this)}createUI(){this.#mapLayersToolbar=J.create("div",{id:"TravelNotes-ViewerLayersToolbarUI"},document.body),J.create("div",{className:"TravelNotes-ViewerLayersToolbarUI-Button",title:"My position",textContent:"🌐",style:"color:black;background-color:white"},this.#mapLayersToolbar).addEventListener("click",new tt,!1),J.create("div",{className:"TravelNotes-ViewerLayersToolbarUI-Button",title:"Zoom on the travel",textContent:"🔍",style:"color:black;background-color:white"},this.#mapLayersToolbar).addEventListener("click",new et,!1);let t=new $(this.#mapLayers);for(let e=0;e<this.#mapLayers.length;e++){let o=this.#mapLayers[e];J.create("div",{className:"TravelNotes-ViewerLayersToolbarUI-Button",title:o.name,dataset:{MapLayerId:e},textContent:o.toolbar.text,style:"color:"+o.toolbar.color+";background-color:"+o.toolbar.backgroundColor},this.#mapLayersToolbar).addEventListener("click",t,!1)}}setMapLayer(t){let e=t.match(/^[0-9]$/)?this.#mapLayers[Number.parseInt(t)]||this.#mapLayers[0]:this.#mapLayers.find((e=>e.name===t))||this.#mapLayers[0];U.dispatch("layerchange",{layer:e}),q.attributions=e.attribution}addMapLayers(t){t.forEach((t=>{t.providerKeyNeeded||this.#mapLayers.push(t)}))}};const it=new class{#travelNotesLoaded=!1;async#loadDistantTravel(t){let e=await fetch(t);if(g===e.status&&e.ok){let t=await e.json();(new _).openDistantFile(t)}else V.map.setView([s.defaultValue,s.defaultValue],2),document.title="Travel & Notes"}constructor(){Object.freeze(this)}addReadOnlyMap(t,e){this.#travelNotesLoaded||(this.#travelNotesLoaded=!0,q.createUI(),e&&ot.createUI(),ot.setMapLayer("OSM - Color"),t&&this.loadDistantTravel(t))}},nt=r.margin.toFixed(0),st=(r.margin+r.height).toFixed(0),at=(r.margin+r.width).toFixed(0),rt=r.margin.toFixed(0),lt=(r.margin+r.width+r.xDeltaText).toFixed(0),dt=(r.margin-r.xDeltaText).toFixed(0),ht=r.margin+r.height+r.margin/2;class ct{#route=null;#smoothDistance=0;#smoothPoints=t.route.elev.smoothPoints;#svg=null;#VScale=1;#HScale=1;#minElev=Number.MAX_VALUE;#maxElev=0;#deltaElev=0;#createTmpPoints(){let t=0,e=0,o=[],i=this.#route.itinerary.itineraryPoints.iterator,n=0,s=i.done;for(o.push({distance:t,elev:i.value.elev}),n+=i.value.distance,s=i.done;!s;){for(t+=this.#smoothDistance;t>=n&&!s;)n+=i.value.distance,s=i.done;if(!s){let s=(i.value.elev-i.previous.elev)/i.previous.distance;e=i.value.elev-(n-t)*s,o.push({distance:t,elev:e})}}return o.push({distance:n,elev:this.#route.itinerary.itineraryPoints.last.elev}),o}#createSmoothPoints(){let t=this.#createTmpPoints(),e=new Map,o=(t[this.#smoothPoints].elev-t[0].elev)/this.#smoothPoints,i=0;for(i=0;i<this.#smoothPoints;i++)e.set(i*this.#smoothDistance,{distance:i*this.#smoothDistance,elev:t[0].elev+o*i});for(i=this.#smoothPoints;i<t.length-this.#smoothPoints;i++){let o=0;for(let e=i-this.#smoothPoints;i+this.#smoothPoints>=e;e++)o+=t[e].elev;e.set(t[i].distance,{distance:t[i].distance,elev:o/(2*this.#smoothPoints+1)})}return i--,o=this.#smoothDistance*(t[t.length-1].elev-t[t.length-1-this.#smoothPoints].elev)/(t[t.length-1].distance-t[t.length-1-this.#smoothPoints].distance),e.set(t[i].distance+this.#smoothDistance,{distance:t[i].distance+this.#smoothDistance,elev:t[i].elev+o}),e.set(t[i].distance+2*this.#smoothDistance,{distance:t[i].distance+2*this.#smoothDistance,elev:t[i].elev+2*o}),e}#createProfilePolyline(){let t="",e=0,o=0,i=0;this.#route.itinerary.itineraryPoints.forEach((n=>{o=(r.margin+this.#HScale*e).toFixed(0),i=(r.margin+this.#VScale*(this.#maxElev-n.elev)).toFixed(0),t+=o+","+i+" ",e+=n.distance}));let n=document.createElementNS(v,"polyline");n.setAttributeNS(null,"points",t),n.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-profilePolyline"),this.#svg.appendChild(n)}#createFramePolyline(){let t=nt+","+rt+" "+nt+","+st+" "+at+","+st+" "+at+","+rt,e=document.createElementNS(v,"polyline");e.setAttributeNS(null,"points",t),e.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-framePolyline"),this.#svg.appendChild(e)}#createDistanceTexts(){let t=Number.MAX_VALUE,e=0;r.hScales.forEach((o=>{let i=Math.abs(this.#route.distance/8-o);i<t&&(t=i,e=o)}));let i=Math.ceil(this.#route.chainedDistance/e)*e;for(;i<this.#route.distance+this.#route.chainedDistance;){let t=document.createElementNS(v,"text");t.appendChild(document.createTextNode(o.metersInKm<e||0<this.#route.chainedDistance?i/o.metersInKm+" km":i+" m ")),t.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-distLegend"),t.setAttributeNS(null,"x",r.margin+(i-this.#route.chainedDistance)*this.#HScale),t.setAttributeNS(null,"y",ht),t.setAttributeNS(null,"text-anchor","start"),this.#svg.appendChild(t),i+=e}}#createElevTexts(){let t=Number.MAX_VALUE,e=0;r.vScales.forEach((o=>{let i=Math.abs(this.#deltaElev/4-o);i<t&&(t=i,e=o)}));let o=Math.ceil(this.#minElev/e)*e;for(;o<this.#maxElev;){let t=r.margin+(this.#maxElev-o)*this.#VScale,i=document.createElementNS(v,"text");i.appendChild(document.createTextNode(o.toFixed(0))),i.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-elevLegend"),i.setAttributeNS(null,"x",lt),i.setAttributeNS(null,"y",t),i.setAttributeNS(null,"text-anchor","start"),this.#svg.appendChild(i);let n=document.createElementNS(v,"text");n.appendChild(document.createTextNode(o.toFixed(0))),n.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-elevLegend"),n.setAttributeNS(null,"x",dt),n.setAttributeNS(null,"y",t),n.setAttributeNS(null,"text-anchor","end"),this.#svg.appendChild(n),o+=e}}#createSvgElement(){this.#svg=document.createElementNS(v,"svg"),this.#svg.setAttributeNS(null,"viewBox","0 0 "+(r.width+2*r.margin)+" "+(r.height+2*r.margin)),this.#svg.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile")}constructor(){Object.freeze(this)}smooth(e){this.#route=e;let o=this.#route.itinerary.itineraryPoints.iterator,i=0,n=0;for(;!o.done;)i+=o.value.distance,n+=o.next?Math.abs(o.value.elev-o.next.elev):0;if(this.#smoothDistance=10*Math.floor(t.route.elev.smoothCoefficient/(n/i)),i<=2*this.#smoothPoints*this.#smoothDistance)return;let s=this.#createSmoothPoints();o=this.#route.itinerary.itineraryPoints.iterator,o.done;let a=o.value.distance;for(;!o.done;){let t=s.get(Math.floor(a/this.#smoothDistance)*this.#smoothDistance),e=s.get(Math.ceil(a/this.#smoothDistance)*this.#smoothDistance);if(t&&e){let i=a-t.distance,n=(e.elev-t.elev)/(e.distance-t.distance);o.value.elev=t.elev+i*n}a+=o.value.distance}}createSvg(t){return this.#route=t,this.#minElev=Number.MAX_VALUE,this.#maxElev=0,this.#route.itinerary.itineraryPoints.forEach((t=>{this.#maxElev=Math.max(this.#maxElev,t.elev),this.#minElev=Math.min(this.#minElev,t.elev)})),this.#deltaElev=this.#maxElev-this.#minElev,this.#VScale=r.height/this.#deltaElev,this.#HScale=r.width/this.#route.distance,this.#createSvgElement(),this.#createProfilePolyline(),this.#createFramePolyline(),this.#createElevTexts(),this.#createDistanceTexts(),this.#svg}}const ut=new class{constructor(){Object.freeze(this)}getNoteTextAndIconHTML(e,o){let i=J.create("div",{dataset:{ObjId:o.note.objId}}),n=J.create("div",{className:e+(o.route?"Route-ManeuversAndNotes-IconCell":"Travel-Notes-IconCell")},i),s=1;b.sanitizeToHtmlElement(o.note.iconContent,n),"TravelNotes-Roadbook-"===e&&n.firstChild?("svg"===n.firstChild.tagName?(n.firstChild.setAttributeNS(null,"viewBox","0 0 "+l.svgViewboxDim+" "+l.svgViewboxDim),s=t.note.svgIcon.roadbookFactor):n.firstChild.classList.contains("TravelNotes-MapNoteCategory-0073")&&(s=t.note.svgIcon.roadbookFactor),n.setAttribute("tanwidth",String(o.note.iconWidth*s)+"px"),n.setAttribute("tanheight",String(o.note.iconWidth*s)+"px")):(n.style.width=String(o.note.iconWidth)+"px",n.style.height=String(o.note.iconHeight)+"px");let a=this.getNoteTextHTML(e,o);return a.className=e+(o.route?"Route-ManeuversAndNotes-Cell":"Travel-Notes-Cell"),i.appendChild(a),i}getNoteTextHTML(t,e){let o=e.note,i=J.create("div");if(0!==o.tooltipContent.length&&b.sanitizeToHtmlElement(o.tooltipContent,J.create("div",{className:t+"NoteHtml-TooltipContent"},i)),0!==o.popupContent.length&&b.sanitizeToHtmlElement(o.popupContent,J.create("div",{className:t+"NoteHtml-PopupContent"},i)),0!==o.address.length&&b.sanitizeToHtmlElement("<span>"+N.getText("NoteHTMLViewsFactory - Address")+"</span> : "+o.address,J.create("div",{className:t+"NoteHtml-Address"},i)),0!==o.url.length&&b.sanitizeToHtmlElement("<span>"+N.getText("NoteHTMLViewsFactory - Link")+"</span><a href="+o.url+' target="_blank" >'+o.url.substr(0,40)+"...</a>",J.create("div",{className:t+"NoteHtml-Url"},i)),0!==o.phone.length){let e=o.phone;if(o.phone.match(/^\+[0-9, ,*,\u0023]*$/)){let t=o.phone.replaceAll(/\u0020/g,""),i=o.phone.replaceAll(/\u0020/g," ");e=N.getText("NoteHTMLViewsFactory - Phone")+" : "+N.getText("NoteHTMLViewsFactory - call")+'<a target="_blank" href="tel:'+t+'" >'+i+"</a>"+N.getText("NoteHTMLViewsFactory - Send a sms to")+'<a target="_blank" href="sms:'+t+'" >'+i+"</a>"}else e=N.getText("NoteHTMLViewsFactory - Phone")+" : "+o.phone;b.sanitizeToHtmlElement(e,J.create("div",{className:t+"NoteHtml-Phone"},i))}if(b.sanitizeToHtmlElement(E.formatLatLng(o.latLng),J.create("div",{className:t+"NoteHtml-LatLng"},i)),e.route){e.route.chain&&b.sanitizeToHtmlElement("<span>"+N.getText("NoteHTMLViewsFactory - Distance from start of travel")+"</span> : "+E.formatDistance(o.chainedDistance+o.distance),J.create("div",{className:t+"NoteHtml-Distance"},i)),b.sanitizeToHtmlElement("<span>"+N.getText("NoteHTMLViewsFactory - Distance from start of route")+"</span> : "+E.formatDistance(o.distance),J.create("div",{className:t+"NoteHtml-Distance"},i));let n=e.route.notes.next(o.objId);if(n){let e=n.distance-o.distance;9<e&&b.sanitizeToHtmlElement("<span>"+N.getText("NoteHTMLViewsFactory - Next note after")+"</span> : "+E.formatDistance(e),J.create("div",{className:t+"NoteHtml-NextDistance"},i))}}return i}getTravelNotesHTML(t){let e=J.create("div",{className:t+"Travel-Notes"}),o=V.travel.notes.iterator;for(;!o.done;){let i=this.getNoteTextAndIconHTML(t,{note:o.value,route:null});i.className=t+"Travel-Notes-Row",e.appendChild(i)}return e}};const pt=new class{#getManeuverHTML(t,e){let i=J.create("div");J.create("div",{className:t+"Route-ManeuversAndNotes-IconCell TravelNotes-ManeuverNote-"+e.maneuver.iconName},i);let n=J.create("div",{className:t+"Route-ManeuversAndNotes-Cell"},i);return b.sanitizeToHtmlElement(e.maneuver.instruction,J.create("div",null,n)),e.route.chain&&b.sanitizeToHtmlElement("<span>"+N.getText("RouteHTMLViewsFactory - Distance from start of travel")+"</span> : "+E.formatDistance(e.route.chainedDistance+e.maneuverDistance),J.create("div",{className:t+"Route-Maneuver-Distance"},n)),b.sanitizeToHtmlElement("<span>"+N.getText("RouteHTMLViewsFactory - Distance from start of route")+"</span> : "+E.formatDistance(e.maneuverDistance),J.create("div",{className:t+"Route-Maneuver-Distance"},n)),o.defaultValue<e.maneuver.distance&&b.sanitizeToHtmlElement("<span>"+N.getText("RouteHTMLViewsFactory - Next maneuver after")+"</span> : "+E.formatDistance(e.maneuver.distance),J.create("div",{className:t+"Route-Maneuver-Distance"},n)),i}constructor(){Object.freeze(this)}getRouteProfileHTML(t,e){let o=J.create("div",{className:t+"RouteProfile"});return b.sanitizeToHtmlElement(N.getText("RouteHTMLViewsFactory - Profile"),o),o.appendChild((new ct).createSvg(e)),o}getRouteManeuversAndNotesHTML(t,e,o){let i=[],n=e.notes.iterator;for(;!n.done;)i.push({data:n.value,distance:n.value.distance});let s=e.itinerary.maneuvers.iterator,a=0;for(;!s.done;)i.push({data:s.value,distance:a}),a+=s.value.distance;i.sort(((t,e)=>t.distance-e.distance));let r=J.create("div",{className:t+"Route-ManeuversAndNotes"});return i.forEach((i=>{let n=null;"Note"===i.data.objType.name?(n=ut.getNoteTextAndIconHTML(t,{note:i.data,route:e}),n.className=t+"Route-Notes-Row"):(n=this.#getManeuverHTML(t,{route:e,maneuver:i.data,maneuverDistance:i.distance}),n.className=t+"Route-Maneuvers-Row"),o&&(n.dataset.tanObjId=i.data.objId,n.dataset.tanMarkerObjId=D.nextObjId,n.dataset.tanObjType=i.data.objType.name),r.appendChild(n)})),r}getRouteHeaderHTML(t,e){let o=J.create("div",{className:t+"Route-Header",id:"route"+e.objId});return b.sanitizeToHtmlElement(e.computedName,J.create("div",{className:t+"Route-Header-Name"},o)),0!==e.distance&&b.sanitizeToHtmlElement("<span>"+N.getText("RouteHTMLViewsFactory - Route distance")+"</span> : "+E.formatDistance(e.distance),J.create("div",{className:t+"Route-Header-Distance"},o)),V.travel.readOnly||"bike"===e.itinerary.transitMode||b.sanitizeToHtmlElement("<span>"+N.getText("RouteHTMLViewsFactory - Duration")+"</span> : "+E.formatTime(e.duration),J.create("div",{className:t+"Route-Header-Duration"},o)),e.itinerary.hasProfile&&(b.sanitizeToHtmlElement("<span>"+N.getText("RouteHTMLViewsFactory - Ascent")+"</span> : "+String(e.itinerary.ascent.toFixed(0))+" m.",J.create("div",{className:t+"Route-Header-Ascent"},o)),b.sanitizeToHtmlElement("<span>"+N.getText("RouteHTMLViewsFactory - Descent")+"</span> : "+String(e.itinerary.descent.toFixed(0))+" m.",J.create("div",{className:t+"Route-Header-Descent"},o))),o}getRouteFooterHTML(t,e){let o="";""!==e.itinerary.provider&&""!==e.itinerary.transitMode&&(o=N.getText("RouteHTMLViewsFactory - Itinerary computed by {provider} and optimized for {transitMode}",{provider:e.itinerary.provider,transitMode:N.getText("RouteHTMLViewsFactory - TransitMode "+e.itinerary.transitMode)}));let i=J.create("div",{className:t+"RouteFooter"});return b.sanitizeToHtmlElement(o,i),i}};
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file BaseContextMenuEventListeners.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/class gt{#menuOperator=null;constructor(t){this.#menuOperator=t}destructor(){this.#menuOperator=null}handleEvent(t){t.stopPropagation(),this.#menuOperator.onKeydownKeyboard(t.key)}}class vt{#menuOperator=null;constructor(t){this.#menuOperator=t}destructor(){this.#menuOperator=null}handleEvent(t){t.stopPropagation(),this.#menuOperator.onCancelMenu()}}class mt{#menuOperator=null;constructor(t){this.#menuOperator=t}destructor(){this.#menuOperator=null}handleEvent(t){t.stopPropagation(),this.#menuOperator.onMouseLeaveMenuItem(t.target)}}class yt{#menuOperator=null;constructor(t){this.#menuOperator=t}destructor(){this.#menuOperator=null}handleEvent(t){t.stopPropagation(),this.#menuOperator.onMouseEnterMenuItem(t.target)}}class bt{#menuOperator=null;constructor(t){this.#menuOperator=t}destructor(){this.#menuOperator=null}handleEvent(t){t.stopPropagation(),this.#menuOperator.selectItem(Number.parseInt(t.target.dataset.tanObjId))}}class wt{#menuOperator=null;constructor(t){this.#menuOperator=t}destructor(){this.#menuOperator=null}handleEvent(t){t.stopPropagation(),this.#menuOperator.onMouseLeaveContainer()}}class Dt{#menuOperator=null;constructor(t){this.#menuOperator=t}destructor(){this.#menuOperator=null}handleEvent(t){t.stopPropagation(),this.#menuOperator.onMouseEnterContainer()}}class It{#contextMenu=null;#eventListeners={onKeydownKeyboard:null,onMouseLeaveContainer:null,onMouseEnterContainer:null,onMouseClickCancelButton:null,onClickMenuItem:null,onMouseLeaveMenuItem:null,onMouseEnterMenuItem:null};#keyboardSelectedItem=u;#timerId=null;#unselectItems(){this.#contextMenu.htmlElements.menuItemHTMLElements.forEach((t=>{t.classList.remove("TravelNotes-ContextMenu-ItemSelected")}))}#changeKeyboardSelectedItem(t){switch(this.#unselectItems(),t){case u:case 1:this.#keyboardSelectedItem+=t,u===this.#keyboardSelectedItem&&(this.#keyboardSelectedItem=this.#contextMenu.htmlElements.menuItemHTMLElements.length-1),this.#contextMenu.htmlElements.menuItemHTMLElements.length===this.#keyboardSelectedItem&&(this.#keyboardSelectedItem=0);break;case 0:this.#keyboardSelectedItem=0;break;default:this.#keyboardSelectedItem=this.#contextMenu.htmlElements.menuItemHTMLElements.length-1}this.#contextMenu.htmlElements.menuItemHTMLElements[this.#keyboardSelectedItem].classList.add("TravelNotes-ContextMenu-ItemSelected")}constructor(t){this.#contextMenu=t,this.#eventListeners.onKeydownKeyboard=new gt(this),this.#eventListeners.onMouseLeaveContainer=new wt(this),this.#eventListeners.onMouseEnterContainer=new Dt(this),this.#eventListeners.onMouseClickCancelButton=new vt(this),this.#eventListeners.onClickMenuItem=new bt(this),this.#eventListeners.onMouseLeaveMenuItem=new mt(this),this.#eventListeners.onMouseEnterMenuItem=new yt(this),document.addEventListener("keydown",this.#eventListeners.onKeydownKeyboard,!0),this.#contextMenu.htmlElements.container.addEventListener("mouseleave",this.#eventListeners.onMouseLeaveContainer),this.#contextMenu.htmlElements.container.addEventListener("mouseenter",this.#eventListeners.onMouseEnterContainer),this.#contextMenu.htmlElements.cancelButton.addEventListener("click",this.#eventListeners.onMouseClickCancelButton),this.#contextMenu.htmlElements.menuItemHTMLElements.forEach((t=>{t.addEventListener("click",this.#eventListeners.onClickMenuItem),t.addEventListener("mouseleave",this.#eventListeners.onMouseLeaveMenuItem),t.addEventListener("mouseenter",this.#eventListeners.onMouseEnterMenuItem)}))}destructor(){this.#timerId&&(clearTimeout(this.#timerId),this.#timerId=null),document.removeEventListener("keydown",this.#eventListeners.onKeydownKeyboard,!0),this.#contextMenu.htmlElements.container.removeEventListener("mouseleave",this.#eventListeners.onMouseLeaveContainer),this.#contextMenu.htmlElements.container.removeEventListener("mouseenter",this.#eventListeners.onMouseEnterContainer),this.#contextMenu.htmlElements.cancelButton.removeEventListener("click",this.#eventListeners.onMouseClickCancelButton),this.#contextMenu.htmlElements.menuItemHTMLElements.forEach((t=>{t.removeEventListener("click",this.#eventListeners.onClickMenuItem),t.removeEventListener("mouseleave",this.#eventListeners.onMouseLeaveMenuItem),t.removeEventListener("mouseenter",this.#eventListeners.onMouseEnterMenuItem)}));for(const t in this.#eventListeners)this.#eventListeners[t].destructor();this.#contextMenu.htmlElements.parentNode.removeChild(this.#contextMenu.htmlElements.container),this.#contextMenu=null}onMouseLeaveContainer(){this.#timerId=setTimeout((()=>this.onCancelMenu()),t.contextMenu.timeout)}onMouseEnterContainer(){this.#timerId&&(clearTimeout(this.#timerId),this.#timerId=null)}onKeydownKeyboard(t){switch(t){case"Escape":case"Esc":this.onCancelMenu();break;case"ArrowDown":case"ArrowRight":case"Tab":this.#changeKeyboardSelectedItem(1);break;case"ArrowUp":case"ArrowLeft":this.#changeKeyboardSelectedItem(u);break;case"Home":this.#changeKeyboardSelectedItem(0);break;case"End":this.#changeKeyboardSelectedItem(2);break;case"Enter":if(u===this.#keyboardSelectedItem||this.#contextMenu.htmlElements.menuItemHTMLElements[this.#keyboardSelectedItem].classList.contains("TravelNotes-ContextMenu-ItemDisabled"))return;this.#contextMenu.onOk(this.#keyboardSelectedItem)}}onCancelMenu(){this.#contextMenu.onCancel("Canceled by user")}selectItem(t){this.#contextMenu.htmlElements.menuItemHTMLElements[t].classList.contains("TravelNotes-ContextMenu-ItemDisabled")||this.#contextMenu.onOk(t)}onMouseLeaveMenuItem(t){t.classList.remove("TravelNotes-ContextMenu-ItemSelected")}onMouseEnterMenuItem(t){this.#unselectItems(),this.#keyboardSelectedItem=Number.parseInt(t.dataset.tanObjId),t.classList.add("TravelNotes-ContextMenu-ItemSelected")}}class ft{static#currentMenu=null;#onPromiseOk=null;#onPromiseError=null;#htmlElements={parentNode:null,container:null,cancelButton:null,menuItemHTMLElements:[]};#eventData={clientX:0,clientY:0,lat:s.defaultValue,lng:s.defaultValue,targetObjId:c,haveParentNode:!1};#menuOperator=null;#createContainer(){this.#htmlElements.container=J.create("div",{className:"TravelNotes-ContextMenu-Container"},this.#htmlElements.parentNode)}#createCancelButton(){this.#htmlElements.cancelButton=J.create("div",{textContent:"❌",className:"TravelNotes-ContextMenu-CloseButton",title:N.getText("ContextMenu - Close")},this.#htmlElements.container)}#createMenuItemsHTMLElements(){let t=0;this.menuItems.forEach((e=>{let o=J.create("div",{textContent:e.itemText,className:"TravelNotes-ContextMenu-Item",dataset:{ObjId:String(t++)}},this.#htmlElements.container);e.isActive||o.classList.add("TravelNotes-ContextMenu-ItemDisabled"),this.#htmlElements.menuItemHTMLElements.push(o)}))}#moveContainer(){let t=V.map.getContainer().clientWidth,e=V.map.getContainer().clientHeight,o=Math.min(this.#eventData.clientY,e-this.#htmlElements.container.clientHeight-20),i=Math.min(this.#eventData.clientX,t-this.#htmlElements.container.clientWidth-20);this.#htmlElements.container.style.top=String(o)+"px",this.#eventData.haveParentNode?this.#htmlElements.container.style.right=String(20)+"px":this.#htmlElements.container.style.left=String(i)+"px"}#createMenu(t,e){this.#onPromiseOk=t,this.#onPromiseError=e,this.#createContainer(),this.#createCancelButton(),this.#createMenuItemsHTMLElements(),this.#moveContainer(),this.#menuOperator=new It(this)}onOk(t){this.#menuOperator.destructor(),ft.#currentMenu=null,this.#onPromiseOk(t)}onCancel(){this.#menuOperator.destructor(),ft.#currentMenu=null,this.#onPromiseError()}show(){ft.#currentMenu&&new Promise(((t,e)=>{this.#createMenu(t,e)})).then((t=>this.doAction(t))).catch((t=>{t&&console.error(t)}))}constructor(t,e){ft.#currentMenu?ft.#currentMenu.onCancel():(this.#eventData.clientX=t.clientX||t.originalEvent.clientX||0,this.#eventData.clientY=t.clientY||t.originalEvent.clientY||0,this.#eventData.lat=t.latlng?t.latlng.lat:s.defaultValue,this.#eventData.lng=t.latlng?t.latlng.lng:s.defaultValue,t.target.objId?this.#eventData.targetObjId=t.target.objId:t.target.dataset&&t.target.dataset.tanObjId&&(this.#eventData.targetObjId=Number.parseInt(t.target.dataset.tanObjId)),this.#eventData.haveParentNode=null!==e,Object.freeze(this.#eventData),this.#htmlElements.parentNode=e||document.body,ft.#currentMenu=this,Object.seal(this))}get menuItems(){return[]}get htmlElements(){return this.#htmlElements}get eventData(){return this.#eventData}}class Lt{#baseDialog=null;constructor(t){Object.seal(this),this.#baseDialog=t}destructor(){this.#baseDialog=null}handleEvent(){this.#baseDialog.onOk()}}class Tt{#baseDialog=null;constructor(t){Object.seal(this),this.#baseDialog=t}destructor(){this.#baseDialog=null}handleEvent(){this.#baseDialog.onCancel()}}class Nt{#dragData=null;constructor(t){Object.seal(this),this.#dragData=t}destructor(){this.#dragData=null}handleEvent(t){this.#dragData.dragStartX=t.screenX,this.#dragData.dragStartY=t.screenY,t.dataTransfer.dropEffect="move",t.dataTransfer.effectAllowed="move"}}class Et{#dragData=null;#containerDiv=null;#backgroundDiv=null;constructor(t,e,o){Object.seal(this),this.#dragData=t,this.#containerDiv=e,this.#backgroundDiv=o}destructor(){this.#dragData=null,this.#containerDiv=null,this.#backgroundDiv=null}handleEvent(t){this.#dragData.dialogX+=t.screenX-this.#dragData.dragStartX,this.#dragData.dialogX=Math.min(Math.max(this.#dragData.dialogX,y),this.#backgroundDiv.clientWidth-this.#containerDiv.clientWidth-y),this.#dragData.dialogY+=t.screenY-this.#dragData.dragStartY,this.#dragData.dialogY=Math.max(this.#dragData.dialogY,y);let e=this.#backgroundDiv.clientHeight-Math.max(this.#dragData.dialogY,0)-y;this.#containerDiv.style.left=String(this.#dragData.dialogX)+"px",this.#containerDiv.style.top=String(this.#dragData.dialogY)+"px",this.#containerDiv.style["max-height"]=String(e)+"px"}}class Pt{#baseDialog=null;constructor(t){Object.seal(this),this.#baseDialog=t}destructor(){this.#baseDialog=null}handleEvent(t){this.#baseDialog.keyboardEventListenerEnabled&&("Escape"===t.key||"Esc"===t.key?this.#baseDialog.onCancel():"Enter"===t.key&&this.#baseDialog.onOk())}}class Ct{#mapCenter=[s.defaultValue,s.defaultValue];handleEvent(t){if("start"===t.action)return void(this.#mapCenter=V.map.getCenter());let e=G.screenCoordToLatLng(t.startX,t.startY),o=G.screenCoordToLatLng(t.endX,t.endY);V.map.panTo([this.#mapCenter.lat+e[0]-o[0],this.#mapCenter.lng+e[1]-o[1]])}}class xt{#initialZoom=0;#startPoint=null;handleEvent(t){if("start"===t.action)return this.#initialZoom=V.map.getZoom(),void(this.#startPoint=window.L.point(t.clientX,t.clientY));let e=Math.floor(this.#initialZoom+(t.startY-t.endY)/50);e=Math.min(V.map.getMaxZoom(),e),e=Math.max(V.map.getMinZoom(),e),V.map.setZoomAround(this.#startPoint,e)}}class At{handleEvent(t){if("TravelNotes-Background"!==t.target.id)return;let e=V.map.getZoom()+(0>t.deltaY?1:-1);e=Math.min(V.map.getMaxZoom(),e),e=Math.max(V.map.getMinZoom(),e),V.map.setZoomAround(window.L.point(t.clientX,t.clientY),e)}}class jt{handleEvent(t){t.preventDefault()}}class Mt{handleEvent(t){t.preventDefault()}}class Ot{#panOngoing=!1;#startPanX=0;#startPanY=0;#target=null;#button=0;#eventType="";#dispatchEvent(t,e){let o=new Event(this.#eventType);o.startX=this.#startPanX,o.startY=this.#startPanY,o.endX=t.screenX,o.endY=t.screenY,o.clientX=t.clientX,o.clientY=t.clientY,o.action=e,this.#target.dispatchEvent(o)}constructor(t,e){switch(this.#target=t,this.#button=e,e){case 0:this.#eventType="leftpan";break;case 1:this.#eventType="middlepan";break;case 2:this.#eventType="rightpan";break;default:this.#button=u}}handleEvent(t){switch(t.type){case"mousedown":t.button===this.#button&&(this.#startPanX=t.screenX,this.#startPanY=t.screenY,this.#panOngoing=!0,this.#dispatchEvent(t,"start"));break;case"mouseup":t.button!==this.#button||!this.#panOngoing||this.#startPanX===t.screenX&&this.#startPanY===t.screenY||this.#dispatchEvent(t,"end"),this.#panOngoing=!1;break;case"mousemove":this.#panOngoing&&(document.selection?document.selection.empty():window.getSelection().removeAllRanges(),this.#dispatchEvent(t,"move"))}}}class St{static get LEFT_BUTTON(){return 0}static get MIDDLE_BUTTON(){return 1}static get RIGHT_BUTTON(){return 2}#target=null;#eventListener=null;constructor(t,e=0){this.#target=t,this.#eventListener=new Ot(t,e),this.#target.addEventListener("mousedown",this.#eventListener),this.#target.addEventListener("mouseup",this.#eventListener),this.#target.addEventListener("mousemove",this.#eventListener)}detach(){this.#target.removeEventListener("mousedown",this.#eventListener),this.#target.removeEventListener("mouseup",this.#eventListener),this.#target.removeEventListener("mousemove",this.#eventListener),this.#eventListener=null,this.#target=null}}class Rt{#backgroundDiv={};#containerDiv={};#errorDiv={};#waitDiv={};#okButton={};#cancelButton={};#topBar={};#secondButton=null;#leftPanEventDispatcher=null;#rightPanEventDispatcher=null;keyboardEventListenerEnabled=!0;#dragData=Object.seal({dragStartX:0,dragStartY:0,dialogX:0,dialogY:0});#eventListeners={onKeydown:null,onTopBarDragStart:null,onTopBarDragEnd:null,onCancelButtonClick:null,onOkButtonClick:null,onLeftPan:null,onRightPan:null,onWheel:null,onContextMenu:null,onDragOver:null};#options=null;#onPromiseOkFct=null;#onPromiseErrorFct=null;#createBackgroundDiv(){this.#backgroundDiv=J.create("div",{id:"TravelNotes-Background",className:"TravelNotes-Background"}),this.#leftPanEventDispatcher=new St(this.#backgroundDiv,St.LEFT_BUTTON),this.#rightPanEventDispatcher=new St(this.#backgroundDiv,St.RIGHT_BUTTON),this.#eventListeners.onLeftPan=new Ct,this.#backgroundDiv.addEventListener("leftpan",this.#eventListeners.onLeftPan,!1),this.#eventListeners.onRightPan=new xt,this.#backgroundDiv.addEventListener("rightpan",this.#eventListeners.onRightPan,!1),this.#eventListeners.onDragOver=new Mt,this.#backgroundDiv.addEventListener("dragover",this.#eventListeners.onDragOver,!1),this.#eventListeners.onWheel=new At,this.#backgroundDiv.addEventListener("wheel",this.#eventListeners.onWheel,!1),this.#eventListeners.onContextMenu=new jt,this.#backgroundDiv.addEventListener("contextmenu",this.#eventListeners.onContextMenu,!1)}#createContainerDiv(){this.#containerDiv=J.create("div",{className:"TravelNotes-BaseDialog-Container"},this.#backgroundDiv)}#createTopBar(){this.#topBar=J.create("div",{className:"TravelNotes-BaseDialog-TopBar",draggable:!0},this.#containerDiv),this.#eventListeners.onTopBarDragStart=new Nt(this.#dragData),this.#eventListeners.onTopBarDragEnd=new Et(this.#dragData,this.#containerDiv,this.#backgroundDiv),this.#topBar.addEventListener("dragstart",this.#eventListeners.onTopBarDragStart,!1),this.#topBar.addEventListener("dragend",this.#eventListeners.onTopBarDragEnd,!1),this.#eventListeners.onCancelButtonClick=new Tt(this),this.#cancelButton=J.create("div",{textContent:"❌",className:"TravelNotes-BaseDialog-CancelButton",title:N.getText("BaseDialog - Cancel")},this.#topBar),this.#cancelButton.addEventListener("click",this.#eventListeners.onCancelButtonClick,!1)}#createHeaderDiv(){J.create("text",{value:this.title},J.create("div",{className:"TravelNotes-BaseDialog-HeaderDiv"},this.#containerDiv))}#createContentDiv(){let t=J.create("div",{className:"TravelNotes-BaseDialog-ContentDiv"},this.#containerDiv);this.contentHTMLElements.forEach((e=>t.appendChild(e)))}#createErrorDiv(){this.#errorDiv=J.create("div",{className:"TravelNotes-BaseDialog-ErrorDiv TravelNotes-Hidden"},this.#containerDiv)}#createWaitDiv(){J.create("div",{className:"TravelNotes-WaitAnimationBullet"},J.create("div",{className:"TravelNotes-WaitAnimation"},this.#waitDiv=J.create("div",{className:"TravelNotes-BaseDialog-WaitDiv  TravelNotes-Hidden"},this.#containerDiv)))}#createFooterDiv(){let t=J.create("div",{className:"TravelNotes-BaseDialog-FooterDiv"},this.#containerDiv);this.#okButton=J.create("div",{textContent:this.#options.firstButtonText||"🆗",className:"TravelNotes-BaseDialog-Button"},t),this.#eventListeners.onOkButtonClick=new Lt(this),this.#okButton.addEventListener("click",this.#eventListeners.onOkButtonClick,!1),this.#options.secondButtonText&&(this.#secondButton=J.create("div",{textContent:this.#options.secondButtonText,className:"TravelNotes-BaseDialog-Button"},t),this.#secondButton.addEventListener("click",this.#eventListeners.onCancelButtonClick,!1)),this.footerHTMLElements.forEach((e=>t.appendChild(e)))}#createHTML(){this.#createBackgroundDiv(),this.#createContainerDiv(),this.#createTopBar(),this.#createHeaderDiv(),this.#createContentDiv(),this.#createErrorDiv(),this.#createWaitDiv(),this.#createFooterDiv()}#centerDialog(){this.#dragData.dialogX=(this.#backgroundDiv.clientWidth-this.#containerDiv.clientWidth)/2,this.#dragData.dialogY=(this.#backgroundDiv.clientHeight-this.#containerDiv.clientHeight)/2,this.#dragData.dialogX=Math.min(Math.max(this.#dragData.dialogX,y),this.#backgroundDiv.clientWidth-this.#containerDiv.clientWidth-y),this.#dragData.dialogY=Math.max(this.#dragData.dialogY,y);let t=this.#backgroundDiv.clientHeight-Math.max(this.#dragData.dialogY,0)-y;this.#containerDiv.style.left=String(this.#dragData.dialogX)+"px",this.#containerDiv.style.top=String(this.#dragData.dialogY)+"px",this.#containerDiv.style["max-height"]=String(t)+"px"}#show(t,e){this.#onPromiseOkFct=t,this.#onPromiseErrorFct=e,this.#createHTML(),document.body.appendChild(this.#backgroundDiv),this.#centerDialog(),document.addEventListener("keydown",this.#eventListeners.onKeydown,{capture:!0}),this.onShow()}constructor(t={}){Object.seal(this),this.#options=t,this.#eventListeners.onKeydown=new Pt(this)}#destructor(){this.#backgroundDiv.removeEventListener("dragover",this.#eventListeners.onDragOver,!1),this.#backgroundDiv.removeEventListener("leftpan",this.#eventListeners.onLeftPan,!1),this.#backgroundDiv.removeEventListener("rightpan",this.#eventListeners.onRightPan,!1),this.#backgroundDiv.removeEventListener("wheel",this.#eventListeners.onWheel,!1),this.#backgroundDiv.removeEventListener("contextmenu",this.#eventListeners.onContextMenu,!1),document.removeEventListener("keydown",this.#eventListeners.onKeydown,{capture:!0}),this.#topBar.removeEventListener("dragstart",this.#eventListeners.onTopBarDragStart,!1),this.#topBar.removeEventListener("dragend",this.#eventListeners.onTopBarDragEnd,!1),this.#cancelButton.removeEventListener("click",this.#eventListeners.onCancelButtonClick,!1),this.#okButton.removeEventListener("click",this.#eventListeners.onOkButtonClick,!1),this.#options.secondButtonText&&this.#secondButton.removeEventListener("click",this.#eventListeners.onCancelButtonClick,!1),document.removeEventListener("keydown",this.#eventListeners.onKeydown,{capture:!0}),this.#eventListeners.onKeydown.destructor(),this.#eventListeners.onTopBarDragStart.destructor(),this.#eventListeners.onTopBarDragEnd.destructor(),this.#eventListeners.onCancelButtonClick.destructor(),this.#eventListeners.onOkButtonClick.destructor(),this.#leftPanEventDispatcher.detach(),this.#rightPanEventDispatcher.detach(),document.body.removeChild(this.#backgroundDiv)}onCancel(){this.#destructor(),this.#onPromiseErrorFct("Canceled by user")}canClose(){return!0}onOk(t){this.canClose()&&(this.#destructor(),this.#onPromiseOkFct(t))}onShow(){}get title(){return""}get contentHTMLElements(){return[]}get footerHTMLElements(){return[]}show(){return new Promise(((t,e)=>this.#show(t,e)))}showWait(){this.#waitDiv.classList.remove("TravelNotes-Hidden"),this.#okButton.classList.add("TravelNotes-Hidden")}hideWait(){this.#waitDiv.classList.add("TravelNotes-Hidden"),this.#okButton.classList.remove("TravelNotes-Hidden")}showError(t){b.sanitizeToHtmlElement(t,this.#errorDiv),this.#errorDiv.classList.remove("TravelNotes-Hidden")}hideError(){this.#errorDiv.textContent="",this.#errorDiv.classList.add("TravelNotes-Hidden")}}const kt=new class{#editionButtons=[];#preDefinedIconsMap=new Map;#preDefinedIcons=[];constructor(){}get buttons(){return this.#editionButtons}get icons(){return this.#preDefinedIcons}getIconData(t){return this.#preDefinedIcons[t][1]}getIconContentFromName(t){let e=this.#preDefinedIconsMap.get(t);return e?e.icon:""}loadJson(t){t.editionButtons&&(this.#editionButtons=this.#editionButtons.concat(t.editionButtons)),t.preDefinedIconsList.forEach((t=>{t.name=b.sanitizeToJsString(t.name)||"?",t.icon=b.sanitizeToHtmlString(t.icon).htmlString||"?",t.tooltip=b.sanitizeToJsString(t.tooltip)||"?",t.width=t.width||l.width,t.height=t.height||l.height,this.#preDefinedIconsMap.set(t.name,t)})),this.#preDefinedIcons=Array.from(this.#preDefinedIconsMap).sort(((t,e)=>t[0].localeCompare(e[0])))}};class Bt{#route=null;#overpassAPIDataLoader=null;#MapIconData=null;#svgElement=null;#createSvg(){this.#svgElement=document.createElementNS(v,"svg"),this.#svgElement.setAttributeNS(null,"viewBox",String(l.svgViewboxDim/4)+" "+l.svgViewboxDim/4+" "+l.svgViewboxDim/2+" "+l.svgViewboxDim/2),this.#svgElement.setAttributeNS(null,"class","TravelNotes-SvgIcon")}#createRoute(){let e=-1,o=u,i=u,n=[];if(this.#route.itinerary.itineraryPoints.forEach((s=>{e++;let a=G.addPoints(G.project(s.latLng,t.note.svgIcon.zoom),this.#MapIconData.translation);n.push(a),a[0]>=0&&a[1]>=0&&a[0]<=l.svgViewboxDim&&a[1]<=l.svgViewboxDim&&(u===o&&(o=e),i=e)})),u!==o&&u!==i){0<o&&o--,this.#route.itinerary.itineraryPoints.length-1>i&&i++;let t="";for(e=o;e<=i;e++)t+=n[e][0].toFixed(0)+","+n[e][1].toFixed(0)+" ";let s=document.createElementNS(v,"polyline");s.setAttributeNS(null,"points",t),s.setAttributeNS(null,"class","TravelNotes-OSM-Itinerary"),s.setAttributeNS(null,"transform","rotate("+this.#MapIconData.rotation+","+l.svgViewboxDim/2+","+l.svgViewboxDim/2+")"),this.#svgElement.appendChild(s)}}#createWays(){this.#overpassAPIDataLoader.ways.forEach((e=>{let o=u,i=u,n=-1,s=[];if(e.nodes.forEach((e=>{n++;let a=this.#overpassAPIDataLoader.nodes.get(e),r=G.addPoints(G.project([a.lat,a.lon],t.note.svgIcon.zoom),this.#MapIconData.translation);s.push(r),r[0]>=0&&r[1]>=0&&r[0]<=l.svgViewboxDim&&r[1]<=l.svgViewboxDim&&(u===o&&(o=n),i=n)})),u!==o&&u!==i){0<o&&o--,e.nodes.length-1>i&&i++;let t="";for(n=o;n<=i;n++)t+=s[n][0].toFixed(0)+","+s[n][1].toFixed(0)+" ";let a=document.createElementNS(v,"polyline");a.setAttributeNS(null,"points",t),a.setAttributeNS(null,"class","TravelNotes-OSM-Highway TravelNotes-OSM-Highway-"+e.tags.highway),a.setAttributeNS(null,"transform","rotate("+this.#MapIconData.rotation+","+l.svgViewboxDim/2+","+l.svgViewboxDim/2+")"),this.#svgElement.appendChild(a)}}))}#createRcnRef(){if(""===this.#MapIconData.rcnRef)return;let t=document.createElementNS(v,"text");t.textContent=this.#MapIconData.rcnRef,t.setAttributeNS(null,"x",String(l.svgViewboxDim/2)),t.setAttributeNS(null,"y",String(.6*l.svgViewboxDim)),t.setAttributeNS(null,"class","TravelNotes-OSM-RcnRef"),this.#svgElement.appendChild(t)}constructor(){Object.freeze(this)}buildSvg(t,e,o){return this.#route=t,this.#overpassAPIDataLoader=e,this.#MapIconData=o,this.#createSvg(),this.#createRoute(),this.#createWays(),this.#createRcnRef(),this.#svgElement}}class Ht{#options={searchPlaces:!0,searchWays:!0,searchRelations:!0,setGeometry:!0};#nodes=new Map;#ways=new Map;#relations=new Map;#adminNames=null;#osmCityAdminLevel=null;#place=null;#places=null;#latLngDistance=Object.seal({latLng:[s.defaultValue,s.defaultValue],distance:o.defaultValue});#city=null;#statusOk=!0;#setGeometry(){this.#ways.forEach((t=>{t.geometry=[[]],t.lat=s.defaultValue,t.lon=s.defaultValue;let e=0;t.nodes.forEach((o=>{let i=this.#nodes.get(o);t.geometry[0].push([i.lat,i.lon]),t.lat+=i.lat,t.lon+=i.lon,e++})),0!==e&&(t.lat/=e,t.lon/=e)})),this.#relations.forEach((t=>{t.geometry=[[]],t.lat=s.defaultValue,t.lon=s.defaultValue;let e=0;t.members.forEach((o=>{if("way"===o.type){let i=this.#ways.get(o.ref);t.geometry.push(i.geometry[0]),t.lat+=i.lat,t.lon+=i.lon,e++}})),0!==e&&(t.lat/=e,t.lon/=e)}))}#parseData(e){e.forEach((e=>{switch(e.type){case"node":if(this.#nodes.set(e.id,e),e.tags&&this.#options.searchPlaces&&e.tags.place&&this.#places[e.tags.place]&&e.tags.name){let t=X.pointsDistance(this.#latLngDistance.latLng,[e.lat,e.lon]),o=this.#places[e.tags.place];o.maxDistance>t&&o.distance>t&&(o.distance=t,o.name=e.tags.name)}break;case"way":this.#options.searchWays&&this.#ways.set(e.id,e);break;case"relation":this.#options.searchRelations&&this.#relations.set(e.id,e);break;case"area":if(this.#options.searchPlaces){let o=e.tags.name;t.nominatim.language&&"*"!==t.nominatim.language&&e.tags["name:"+t.nominatim.language]&&(o=e.tags["name:"+t.nominatim.language]),this.#adminNames[Number.parseInt(e.tags.admin_level)]=o,"2"===e.tags.admin_level&&(this.#osmCityAdminLevel=t.geoCoder.osmCityAdminLevel[e.tags["ISO3166-1"]]||this.#osmCityAdminLevel)}}})),this.#options.setGeometry&&this.#setGeometry(),this.#options.searchPlaces&&this.#setPlaceAndCity()}#setPlaceAndCity(){let t=null;for(let e=2;e<this.#adminNames.length;e++)void 0!==this.#adminNames[e]&&(this.#osmCityAdminLevel>=e?this.#city=this.#adminNames[e]:t=this.#adminNames[e]);let e=Number.MAX_VALUE;Object.values(this.#places).forEach((t=>{t.distance<e&&(e=t.distance,this.#place=t.name)})),this.#place=t||this.#place,this.#place===this.#city&&(this.#place=null)}async#parseSearchResults(t){for(let e=0;e<t.length;e++)if("fulfilled"===t[e].status&&g===t[e].value.status&&t[e].value.ok){let o=await t[e].value.json();this.#parseData(o.elements),this.#statusOk=this.#statusOk&&!0}else this.#statusOk=!1,console.error("An error occurs when calling theOverpassAPI: "),console.error(t[e])}constructor(t){if(t)for(const[e,o]of Object.entries(t))this.#options[e]=o}async loadData(e,i){this.#statusOk=!0,this.#adminNames=[],this.#osmCityAdminLevel=t.geoCoder.osmCityAdminLevel.DEFAULT,this.#place=null,this.#places={hamlet:{name:null,distance:Number.MAX_VALUE,maxDistance:t.geoCoder.distances.hamlet},village:{name:null,distance:Number.MAX_VALUE,maxDistance:t.geoCoder.distances.village},city:{name:null,distance:Number.MAX_VALUE,maxDistance:t.geoCoder.distances.city},town:{name:null,distance:Number.MAX_VALUE,maxDistance:t.geoCoder.distances.town}},this.#latLngDistance.latLng=i,this.#latLngDistance.distance=o.defaultValue,this.#city=null,this.#nodes.clear(),this.#ways.clear(),this.#relations.clear();let n=[];e.forEach((e=>{n.push(fetch(t.overpassApi.url+"?data=[out:json][timeout:"+t.overpassApi.timeOut+"];"+e))})),await Promise.allSettled(n).then((t=>this.#parseSearchResults(t)))}get nodes(){return this.#nodes}get ways(){return this.#ways}get relations(){return this.#relations}get place(){return this.#place}get city(){return this.#city}get country(){return this.#adminNames[2]}get statusOk(){return this.#statusOk}}class Kt{#overpassAPIDataLoader=null;#computeData=null;#mapIconData=null;#rcnRefNode=null;#svgPointId=u;#incomingNodeId=u;#outgoingNodeId=u;#iconNode=null;#incomingStreet="";#outgoingStreet="";#roundabout={isMini:!1,isEntry:!1,isExit:!1};#getWayName(t){return(t.tags.name?t.tags.name:"")+(t.tags.name&&t.tags.ref?" ":"")+(t.tags.ref?"["+t.tags.ref+"]":"")}#latLngCompare(t){const e=5e-6;let o=!1;return this.#computeData.route.wayPoints.forEach((i=>{Math.abs(t.lat-i.lat)<e&&Math.abs(t.lng-i.lng)<e&&(o=!0)})),!o&&(this.#computeData.mapIconPosition.latLng[0]!==t.lat||this.#computeData.mapIconPosition.latLng[1]!==t.lng)}#findNodes(){let t=this.#computeData.route.itinerary.itineraryPoints.previous(this.#computeData.mapIconPosition.nearestItineraryPointObjId,(t=>this.#latLngCompare(t))),e=this.#computeData.route.itinerary.itineraryPoints.next(this.#computeData.mapIconPosition.nearestItineraryPointObjId,(t=>this.#latLngCompare(t))),i=Number.MAX_VALUE,n=Number.MAX_VALUE,s=Number.MAX_VALUE,a=o.defaultValue;this.#overpassAPIDataLoader.nodes.forEach((o=>{"bike"===this.#computeData.route.itinerary.transitMode&&o.tags&&o.tags.rcn_ref&&(this.#rcnRefNode=o),c!==this.#computeData.mapIconPosition.nearestItineraryPointObjId&&(a=X.pointsDistance([o.lat,o.lon],this.#computeData.mapIconPosition.latLng),a<i&&(this.#svgPointId=o.id,i=a)),t&&(a=X.pointsDistance([o.lat,o.lon],t.latLng),a<n&&(this.#incomingNodeId=o.id,n=a)),e&&(a=X.pointsDistance([o.lat,o.lon],e.latLng),a<s&&(this.#outgoingNodeId=o.id,s=a))})),this.#iconNode=this.#overpassAPIDataLoader.nodes.get(this.#svgPointId)}#moveIconToRcnRef(){if(this.#rcnRefNode){let e=X.pointsDistance([this.#rcnRefNode.lat,this.#rcnRefNode.lon],[this.#iconNode.lat,this.#iconNode.lon]);t.note.svgIcon.rcnRefDistance>e&&(this.#iconNode=this.#rcnRefNode)}}#findMiniRoundabout(){this.#roundabout.isMini=this.#iconNode&&this.#iconNode.tags&&this.#iconNode.tags.highway&&"mini_roundabout"===this.#iconNode.tags.highway}#addRcnRefNumber(){"bike"===this.#computeData.route.itinerary.transitMode&&this.#iconNode&&this.#iconNode.tags&&this.#iconNode.tags.rcn_ref&&this.#iconNode.tags["network:type"]&&"node_network"===this.#iconNode.tags["network:type"]&&(this.#mapIconData.rcnRef=this.#iconNode.tags.rcn_ref,this.#mapIconData.tooltip+=N.getText("MapIconDataBuilder - rcnRef",{rcnRef:this.#mapIconData.rcnRef}))}#findStreets(){this.#overpassAPIDataLoader.ways.forEach((t=>{if(!t.nodes.includes(this.#svgPointId))return;let e=this.#getWayName(t),o=""!==e,i=t.nodes.includes(this.#incomingNodeId),n=t.nodes.includes(this.#outgoingNodeId),s=2*t.nodes.filter((t=>t===this.#svgPointId)).length;if(t.nodes[0]===this.#svgPointId&&s--,t.nodes[t.nodes.length-1]===this.#svgPointId&&s--,i&&(this.#incomingStreet=o?e:"???",s--,t.tags.junction&&"roundabout"===t.tags.junction&&(this.#roundabout.isExit=!0)),0!==s&&(n&&(this.#outgoingStreet=o?e:"???",s--,t.tags.junction&&"roundabout"===t.tags.junction&&(this.#roundabout.isEntry=!0)),0!==s&&o))for(;0!==s;)this.#mapIconData.streets=""===this.#mapIconData.streets?e:this.#mapIconData.streets+" ⪥  "+e,s--}))}#addStreetInfo(){h.atStart===this.#computeData.positionOnRoute?this.#mapIconData.streets="🟢 "+this.#outgoingStreet:h.atEnd===this.#computeData.positionOnRoute?this.#mapIconData.streets=this.#incomingStreet+" 🔴 ":this.#mapIconData.streets=this.#incomingStreet+(""===this.#mapIconData.streets?"":" ⪥  "+this.#mapIconData.streets)+" "+this.#computeData.directionArrow+" "+this.#outgoingStreet}#addRoundaboutInfo(){this.#roundabout.isEntry&&!this.#roundabout.isExit?this.#mapIconData.tooltip+=N.getText("MapIconDataBuilder - entry roundabout"):!this.#roundabout.isEntry&&this.#roundabout.isExit?this.#mapIconData.tooltip+=N.getText("MapIconDataBuilder - exit roundabout"):this.#roundabout.isEntry&&this.#roundabout.isExit&&(this.#mapIconData.tooltip+=N.getText("MapIconDataBuilder - continue roundabout")),this.#roundabout.isMini&&(this.#mapIconData.tooltip+=N.getText("MapIconDataBuilder - at the small roundabout on the ground"))}constructor(t,e,o){this.#overpassAPIDataLoader=t,this.#computeData=e,this.#mapIconData=o}findData(){this.#findNodes(),this.#moveIconToRcnRef(),this.#findMiniRoundabout(),this.#addRcnRefNumber(),this.#findStreets(),this.#addStreetInfo(),this.#addRoundaboutInfo()}}class Ft{#computeData=null;#mapIconData=null;constructor(t,e){this.#computeData=t,this.#mapIconData=e}findData(){null!==this.#computeData.direction&&(this.#computeData.direction<t.note.svgIcon.angleDirection.right?(this.#mapIconData.tooltip=N.getText("MapIconDataBuilder - Turn right"),this.#computeData.directionArrow="🢂"):this.#computeData.direction<t.note.svgIcon.angleDirection.slightRight?(this.#mapIconData.tooltip=N.getText("MapIconDataBuilder - Turn slight right"),this.#computeData.directionArrow="🢅"):this.#computeData.direction<t.note.svgIcon.angleDirection.continue?(this.#mapIconData.tooltip=N.getText("MapIconDataBuilder - Continue"),this.#computeData.directionArrow="🢁"):this.#computeData.direction<t.note.svgIcon.angleDirection.slightLeft?(this.#mapIconData.tooltip=N.getText("MapIconDataBuilder - Turn slight left"),this.#computeData.directionArrow="🢄"):this.#computeData.direction<t.note.svgIcon.angleDirection.left?(this.#mapIconData.tooltip=N.getText("MapIconDataBuilder - Turn left"),this.#computeData.directionArrow="🢀"):this.#computeData.direction<t.note.svgIcon.angleDirection.sharpLeft?(this.#mapIconData.tooltip=N.getText("MapIconDataBuilder - Turn sharp left"),this.#computeData.directionArrow="🢇"):this.#computeData.direction<t.note.svgIcon.angleDirection.sharpRight?(this.#mapIconData.tooltip=N.getText("MapIconDataBuilder - Turn sharp right"),this.#computeData.directionArrow="🢆"):(this.#mapIconData.tooltip=N.getText("MapIconDataBuilder - Turn right"),this.#computeData.directionArrow="🢂")),h.atStart===this.#computeData.positionOnRoute?this.#mapIconData.tooltip=N.getText("MapIconDataBuilder - Start"):h.atEnd===this.#computeData.positionOnRoute&&(this.#mapIconData.tooltip=N.getText("MapIconDataBuilder - Stop"))}}class Vt{#computeData=null;#mapIconData=null;#rotationItineraryPoint=null;#directionItineraryPoint=null;#iconPoint=null;#computeTranslation(){this.#mapIconData.translation=G.subtrackPoints([l.svgViewboxDim/2,l.svgViewboxDim/2],G.project(this.#computeData.mapIconPosition.latLng,t.note.svgIcon.zoom))}#searchPoints(){this.#rotationItineraryPoint=this.#computeData.route.itinerary.itineraryPoints.first,this.#directionItineraryPoint=this.#computeData.route.itinerary.itineraryPoints.last;let e=o.defaultValue,i=!1;this.#computeData.route.itinerary.itineraryPoints.forEach((o=>{this.#computeData.mapIconPosition.distance-e>t.note.svgIcon.angleDistance&&(this.#rotationItineraryPoint=o),e-this.#computeData.mapIconPosition.distance>t.note.svgIcon.angleDistance&&!i&&(this.#directionItineraryPoint=o,i=!0),e+=o.distance})),this.#iconPoint=G.addPoints(G.project(this.#computeData.mapIconPosition.latLng,t.note.svgIcon.zoom),this.#mapIconData.translation)}#findRotation(){if(this.#computeData.mapIconPosition.nearestItineraryPointObjId!==this.#computeData.route.itinerary.itineraryPoints.first.objId){let e=G.addPoints(G.project(this.#rotationItineraryPoint.latLng,t.note.svgIcon.zoom),this.#mapIconData.translation);this.#mapIconData.rotation=Math.atan((this.#iconPoint[1]-e[1])/(e[0]-this.#iconPoint[0]))*d.d180/Math.PI,0>this.#mapIconData.rotation&&(this.#mapIconData.rotation+=d.d360),this.#mapIconData.rotation-=d.d270,0>e[0]-this.#iconPoint[0]&&(this.#mapIconData.rotation+=d.d180)}}#findDirection(){if(this.#computeData.mapIconPosition.nearestItineraryPointObjId!==this.#computeData.route.itinerary.itineraryPoints.last.objId){let e=G.addPoints(G.project(this.#directionItineraryPoint.latLng,t.note.svgIcon.zoom),this.#mapIconData.translation);for(this.#computeData.direction=Math.atan((this.#iconPoint[1]-e[1])/(e[0]-this.#iconPoint[0]))*d.d180/Math.PI,0>e[0]-this.#iconPoint[0]&&(this.#computeData.direction+=d.d180),this.#computeData.direction-=this.#mapIconData.rotation;d.d0>this.#computeData.direction;)this.#computeData.direction+=d.d360;for(;d.d360<this.#computeData.direction;)this.#computeData.direction-=d.d360}}#findPositionOnRoute(){this.#computeData.mapIconPosition.nearestItineraryPointObjId===this.#computeData.route.itinerary.itineraryPoints.first.objId&&(this.#mapIconData.rotation=-this.#computeData.direction-d.d90,this.#computeData.direction=null,this.#computeData.positionOnRoute=h.atStart),this.#computeData.mapIconPosition.latLng[0]===this.#computeData.route.itinerary.itineraryPoints.last.lat&&this.#computeData.mapIconPosition.latLng[1]===this.#computeData.route.itinerary.itineraryPoints.last.lng&&(this.#computeData.direction=null,this.#computeData.positionOnRoute=h.atEnd)}findData(){this.#computeTranslation(),this.#searchPoints(),this.#findRotation(),this.#findDirection(),this.#findPositionOnRoute()}constructor(t,e){this.#computeData=t,this.#mapIconData=e}}class Ut{#overpassAPIDataLoader=null;#mapIconData=Object.seal({translation:[0,0],rotation:0,rcnRef:"",tooltip:"",streets:""});#computeData={mapIconPosition:null,route:null,positionOnRoute:h.onRoute,direction:null,directionArrow:" "};constructor(){Object.freeze(this)}buildData(t,e,o){return this.#computeData.mapIconPosition=o,this.#computeData.route=t,this.#computeData.positionOnRoute=h.onRoute,this.#computeData.direction=null,this.#computeData.directionArrow=" ",this.#overpassAPIDataLoader=e,this.#mapIconData.translation=[0,0],this.#mapIconData.rotation=0,this.#mapIconData.rcnRef="",this.#mapIconData.tooltip="",this.#mapIconData.streets="",new Vt(this.#computeData,this.#mapIconData).findData(),new Ft(this.#computeData,this.#mapIconData).findData(),new Kt(this.#overpassAPIDataLoader,this.#computeData,this.#mapIconData).findData(),this.#mapIconData}}class zt{#route=null;#overpassAPIDataLoader=new Ht({searchRelations:!1,setGeometry:!1});#mapIconPosition=Object.seal({latLng:[s.defaultValue,s.defaultValue],distance:o.defaultValue,nearestItineraryPointObjId:c});#queryDistance=Math.max(t.geoCoder.distances.hamlet,t.geoCoder.distances.village,t.geoCoder.distances.city,t.geoCoder.distances.town);#requestStarted=!1;#searchNearestItineraryPoint(){let t=null,e=Number.MAX_VALUE,i=o.defaultValue;this.#route.itinerary.itineraryPoints.forEach((o=>{let n=X.pointsDistance(this.#mapIconPosition.latLng,o.latLng);e>n&&(e=n,t=o,this.#mapIconPosition.distance=i),i+=o.distance})),this.#mapIconPosition.latLng=t.latLng,this.#mapIconPosition.nearestItineraryPointObjId=t.objId}#buildIconAndAdress(){let t=(new Ut).buildData(this.#route,this.#overpassAPIDataLoader,this.#mapIconPosition),e=(new Bt).buildSvg(this.#route,this.#overpassAPIDataLoader,t);this.#requestStarted=!1;let o=t.streets;return""!==this.#overpassAPIDataLoader.city&&(o+=' <span class="TravelNotes-NoteHtml-Address-City">'+this.#overpassAPIDataLoader.city+"</span>"),this.#overpassAPIDataLoader.place&&this.#overpassAPIDataLoader.place!==this.#overpassAPIDataLoader.city&&(o+=" ("+this.#overpassAPIDataLoader.place+")"),Object.freeze({statusOk:!0,noteData:{iconContent:e.outerHTML,tooltipContent:t.tooltip,address:o,iconWidth:l.width,iconHeight:l.height,latLng:this.#mapIconPosition.latLng}})}async#exeGetIconAndAdress(){if(this.#requestStarted)return Object.freeze({statusOk:!1,noteData:null});this.#requestStarted=!0,this.#searchNearestItineraryPoint();let t=this.#mapIconPosition.latLng[0].toFixed(s.fixed)+","+this.#mapIconPosition.latLng[1].toFixed(s.fixed),e=["way[highway](around:"+(1.5*l.svgViewboxDim).toFixed(0)+","+t+")->.a;(.a >;.a;)->.a;.a out;is_in("+t+')->.e;area.e[admin_level][boundary="administrative"];out;node(around:'+this.#queryDistance+","+t+")[place];out;"];return await this.#overpassAPIDataLoader.loadData(e,this.#mapIconPosition.latLng),this.#overpassAPIDataLoader.statusOk?this.#buildIconAndAdress():Object.freeze({statusOk:!1})}async#exeGetIconAndAdressWithPromise(t,e){let o=await this.#exeGetIconAndAdress();o.statusOk?t(o):e("An error occurs...")}constructor(){Object.freeze(this)}async getIconAndAdressAsync(t,e){return this.#mapIconPosition.latLng=t,this.#route=Z.getRoute(e),this.#exeGetIconAndAdress()}getIconAndAdressWithPromise(t,e){return this.#mapIconPosition.latLng=t,this.#route=Z.getRoute(e),new Promise(((t,e)=>this.#exeGetIconAndAdressWithPromise(t,e)))}}class Wt{#noteDialog=null;constructor(t){this.#noteDialog=t}destructor(){this.#noteDialog=null}handleEvent(t){if(!this.#noteDialog.focusControl)return;let e=t.target;for(;!e.dataset.tanHtmlBefore;)e=e.parentNode;let o=this.#noteDialog.focusControl.selectionStart,i=this.#noteDialog.focusControl.selectionEnd;this.#noteDialog.focusControl.value=this.#noteDialog.focusControl.value.slice(0,o)+e.dataset.tanHtmlBefore+(0===e.dataset.tanHtmlAfter.length?"":this.#noteDialog.focusControl.value.slice(o,i))+e.dataset.tanHtmlAfter+this.#noteDialog.focusControl.value.slice(i),o===i||0===e.dataset.tanHtmlAfter.length?(o+=e.dataset.tanHtmlBefore.length,i=o):i+=e.dataset.tanHtmlBefore.length+e.dataset.tanHtmlAfter.length,this.#noteDialog.focusControl.setSelectionRange(o,i),this.#noteDialog.focusControl.focus();let n={};n[this.#noteDialog.focusControl.dataset.tanName]=this.#noteDialog.focusControl.value,this.#noteDialog.updatePreview(n)}}class Gt{#noteDialog=null;#updatePreviewAndControls(t){this.#noteDialog.setControlsValues(t),this.#noteDialog.updatePreview(t)}#onMapIcon(){c!==this.#noteDialog.mapIconData.routeObjId?(this.#noteDialog.showWait(),(new zt).getIconAndAdressWithPromise(this.#noteDialog.mapIconData.latLng,this.#noteDialog.mapIconData.routeObjId).then((t=>{this.#noteDialog.hideWait(),this.#updatePreviewAndControls(t.noteData)})).catch((()=>{this.#noteDialog.hideWait(),this.#noteDialog.showError(N.getText("Notedialog - an error occurs when creating the SVG icon"))}))):this.#noteDialog.showError(N.getText("Notedialog - not possible to create a SVG icon for a travel note"))}constructor(t){this.#noteDialog=t}destructor(){this.#noteDialog=null}handleEvent(t){t.stopPropagation();let e=kt.getIconData(t.target.selectedIndex);"SvgIcon"!==e.icon?this.#updatePreviewAndControls({iconContent:e.icon,iconHeight:e.height,iconWidth:e.width,tooltipContent:e.tooltip}):this.#onMapIcon()}}class Xt{#noteDialog=null;constructor(t){this.#noteDialog=t}destructor(){this.#noteDialog=null}handleEvent(t){t.target.textContent="▼"===t.target.textContent?"▶":"▼",this.#noteDialog.toogleContents()}}class Zt{#noteDialogToolbar=null;constructor(t){this.#noteDialogToolbar=t}handleEvent(t){t.stopPropagation();let e=new FileReader;e.onload=()=>{let t={};try{t=JSON.parse(e.result),kt.loadJson(t),this.#noteDialogToolbar.update()}catch(t){t instanceof Error&&console.error(t)}},e.readAsText(t.target.files[0])}}class Yt{#noteDialogToolbar=null;constructor(t){this.#noteDialogToolbar=t}destructor(){this.#noteDialogToolbar=null}handleEvent(t){t.stopPropagation(),E.openFile(new Zt(this.#noteDialogToolbar),".json")}}class _t{#noteDialog=null;#rootHTMLElement=null;#iconSelect=null;#toogleContentsButton=null;#openFileButton=null;#editionButtons=[];#eventListeners={onEditionButtonClick:null,onIconSelectChange:null,onToogleContentsButtonClick:null,onOpenFileButtonClick:null};#addIconsSelector(){this.#iconSelect=J.create("select",{className:"TravelNotes-NoteDialog-Select",id:"TravelNotes-NoteDialog-IconSelect"},this.#rootHTMLElement),this.#iconSelect.addEventListener("change",this.#eventListeners.onIconSelectChange,!1),kt.icons.forEach((t=>{this.#iconSelect.add(J.create("option",{text:t[0]}))})),this.#iconSelect.selectedIndex=u}#addToolbarButtons(){this.#toogleContentsButton=J.create("div",{className:"TravelNotes-BaseDialog-Button",title:N.getText("NoteDialog - show hidden contents"),textContent:"▼"},this.#rootHTMLElement),this.#toogleContentsButton.addEventListener("click",this.#eventListeners.onToogleContentsButtonClick,!1),this.#openFileButton=J.create("div",{className:"TravelNotes-BaseDialog-Button",title:N.getText("NoteDialog - Open a configuration file"),textContent:"📂"},this.#rootHTMLElement),this.#openFileButton.addEventListener("click",this.#eventListeners.onOpenFileButtonClick,!1)}#addEditionButtons(){kt.buttons.forEach((t=>{let e=J.create("div",{dataset:{HtmlBefore:t.htmlBefore||"",HtmlAfter:t.htmlAfter||""},className:"TravelNotes-NoteDialog-EditorButton"},this.#rootHTMLElement);b.sanitizeToHtmlElement(t.title||"?",e),e.addEventListener("click",this.#eventListeners.onEditionButtonClick,!1),this.#editionButtons.push(e)}))}#addToolbarElements(){this.#addIconsSelector(),this.#addToolbarButtons(),this.#addEditionButtons()}#removeEventListeners(){this.#iconSelect.removeEventListener("change",this.#eventListeners.onIconSelectChange,!1),this.#toogleContentsButton.removeEventListener("click",this.#eventListeners.onToogleContentsButtonClick,!1),this.#openFileButton.removeEventListener("click",this.#eventListeners.onOpenFileButtonClick,!1),this.#editionButtons.forEach((t=>{t.removeEventListener("click",this.#eventListeners.onEditionButtonClick,!1)}))}constructor(t){this.#noteDialog=t,this.#rootHTMLElement=J.create("div",{id:"TravelNotes-NoteDialog-ToolbarDiv"}),this.#eventListeners.onIconSelectChange=new Gt(this.#noteDialog),this.#eventListeners.onToogleContentsButtonClick=new Xt(this.#noteDialog),this.#eventListeners.onOpenFileButtonClick=new Yt(this),this.#eventListeners.onEditionButtonClick=new Wt(this.#noteDialog),this.#addToolbarElements()}destructor(){this.#removeEventListeners(),this.#eventListeners.onEditionButtonClick.destructor(),this.#eventListeners.onIconSelectChange.destructor(),this.#eventListeners.onToogleContentsButtonClick.destructor(),this.#eventListeners.onOpenFileButtonClick.destructor(),this.#noteDialog=null}update(){this.#removeEventListeners(),this.#rootHTMLElement.textContent="",this.#editionButtons=[],this.#addToolbarElements()}get rootHTMLElement(){return this.#rootHTMLElement}}class Jt{#nominatimStatusOk=!0;#queryDistance=Math.max(t.geoCoder.distances.hamlet,t.geoCoder.distances.village,t.geoCoder.distances.city,t.geoCoder.distances.town);#latLng=null;#overpassAPIDataLoader=null;#nominatimData=null;#mergeData(){let t=null;this.#overpassAPIDataLoader.city&&(t=this.#overpassAPIDataLoader.city,this.#overpassAPIDataLoader.place&&(t+=" ("+this.#overpassAPIDataLoader.place+")"),t||(t=this.#overpassAPIDataLoader.country));let e=null,o=null;return this.#nominatimData&&(e=this.#nominatimData.street,o=this.#nominatimData.nameDetails||"",t||(t=this.#nominatimData.country)),t=t||"",e=e||"",o=o||"",(e.includes(o)||t.includes(o))&&(o=""),Object.freeze({name:b.sanitizeToJsString(o),street:b.sanitizeToJsString(e),city:b.sanitizeToJsString(t),statusOk:this.#nominatimStatusOk})}#parseNominatimData(t){let e="";t.error?this.#nominatimStatusOk=!1:(t.address.house_number&&(e+=t.address.house_number+" "),t.address.road?e+=t.address.road+" ":t.address.pedestrian&&(e+=t.address.pedestrian+" "),this.#nominatimData={street:e,nameDetails:t.namedetails.name,country:t.address.country})}async#loadNominatimData(){let e=t.nominatim.url+"reverse?format=json&lat="+this.#latLng[0]+"&lon="+this.#latLng[1]+"&zoom=18&addressdetails=1&namedetails=1",o=t.nominatim.language;o&&"*"!==o&&(e+="&accept-language="+o);let i=new Headers;o&&"*"===o&&i.append("accept-language","");let n=await fetch(e,{headers:i});if(g===n.status&&n.ok){this.#nominatimStatusOk=this.#nominatimStatusOk&&!0;let t=await n.json();this.#parseNominatimData(t)}else this.#nominatimStatusOk=!1}#getOverpassQueries(){return["is_in("+this.#latLng[0]+","+this.#latLng[1]+')->.e;area.e[admin_level][boundary="administrative"];out;node(around:'+this.#queryDistance+","+this.#latLng[0]+","+this.#latLng[1]+")[place];out;"]}async#execGetAddress(){return this.#nominatimStatusOk=!0,this.#nominatimData=null,this.#overpassAPIDataLoader=new Ht({searchWays:!1,searchRelations:!1,setGeometry:!0}),await this.#overpassAPIDataLoader.loadData(this.#getOverpassQueries(),this.#latLng),await this.#loadNominatimData(),this.#mergeData()}async#exeGetAdressWithPromise(t,e){let o=await this.#execGetAddress();o.statusOk?t(o):e("An error occurs...")}constructor(){Object.freeze(this)}async getAddressAsync(t){return this.#latLng=t,this.#execGetAddress()}getAddressWithPromise(t){return this.#latLng=t,new Promise(((t,e)=>this.#exeGetAdressWithPromise(t,e)))}}class qt{#noteDialog=null;#onAddressUpdatedByGeoCoder(t){this.#noteDialog.hideWait();let e=t.street;""!==t.city&&(e+=' <span class="TravelNotes-NoteHtml-Address-City">'+t.city+"</span>"),this.#noteDialog.setControlsValues({address:e}),this.#noteDialog.updatePreview({address:e})}constructor(t){this.#noteDialog=t}destructor(){this.#noteDialog=null}setAddressWithGeoCoder(t){this.#noteDialog.showWait(),this.#noteDialog.hideError(),(new Jt).getAddressWithPromise(t).then((t=>{this.#onAddressUpdatedByGeoCoder(t)})).catch((t=>{t&&console.error(t),this.#noteDialog.hideWait(),this.#noteDialog.showError(N.getText("Notedialog - an error occurs when searching the adress"))}))}}class Qt{#noteDialog=null;#latLng=null;#geoCoderHelper=null;constructor(t,e){this.#noteDialog=t,this.#latLng=e,this.#geoCoderHelper=new qt(this.#noteDialog)}destructor(){this.#noteDialog=null,this.#geoCoderHelper.destructor()}handleEvent(t){t.stopPropagation(),this.#geoCoderHelper.setAddressWithGeoCoder(this.#latLng)}}class $t{#noteDialog=null;#disableFocusControl=!1;constructor(t,e){this.#noteDialog=t,this.#disableFocusControl=e}destructor(){this.#noteDialog=null}handleEvent(t){t.stopPropagation(),this.#disableFocusControl?this.#noteDialog.focusControl=null:this.#noteDialog.focusControl=t.target}}class te{#noteDialog=null;constructor(t){this.#noteDialog=t}destructor(){this.#noteDialog=null}handleEvent(t){if(t.stopPropagation(),""===t.target.value)return;""===b.sanitizeToUrl(t.target.value).errorsString?this.#noteDialog.hideError():this.#noteDialog.showError(N.getText("NoteDialog - invalidUrl"))}}class ee{#noteDialog=null;constructor(t){this.#noteDialog=t}destructor(){this.#noteDialog=null}handleEvent(t){t.stopPropagation();let e={};e[t.target.dataset.tanName]=t.target.value,this.#noteDialog.updatePreview(e)}}class oe{#noteDialog=null;#iconDimsDiv=null;#iconWidthInput=null;#iconHeightInput=null;#eventListeners={onInputUpdated:null};constructor(t){this.#noteDialog=t,this.#iconDimsDiv=J.create("div",{className:"TravelNotes-NoteDialog-DataDiv"}),J.create("text",{value:N.getText("NoteDialog - Icon width")},this.#iconDimsDiv),this.#iconWidthInput=J.create("input",{type:"number",className:"TravelNotes-NoteDialog-NumberInput",value:l.width,dataset:{Name:"iconWidth"}},this.#iconDimsDiv),J.create("text",{value:N.getText("NoteDialog - Icon height")},this.#iconDimsDiv),this.#iconHeightInput=J.create("input",{type:"number",className:"TravelNotes-NoteDialog-NumberInput",value:l.height,dataset:{Name:"iconHeight"}},this.#iconDimsDiv),this.#eventListeners.onInputUpdated=new ee(this.#noteDialog),this.#iconWidthInput.addEventListener("input",this.#eventListeners.onInputUpdated),this.#iconHeightInput.addEventListener("input",this.#eventListeners.onInputUpdated)}destructor(){this.#iconWidthInput.removeEventListener("input",this.#eventListeners.onInputUpdated),this.#iconHeightInput.removeEventListener("input",this.#eventListeners.onInputUpdated),this.#eventListeners.onInputUpdated.destructor(),this.#noteDialog=null}get HTMLElements(){return[this.#iconDimsDiv]}get iconWidth(){return Number.parseInt(this.#iconWidthInput.value)}set iconWidth(t){this.#iconWidthInput.value=t}get iconHeight(){return Number.parseInt(this.#iconHeightInput.value)}set iconHeight(t){this.#iconHeightInput.value=t}}class ie{#noteDialog=null;#iconDiv=null;#iconTextArea=null;#eventListeners={onFocusControl:null,onInputUpdated:null};constructor(e){this.#noteDialog=e,this.#iconDiv=J.create("div",{className:"TravelNotes-NoteDialog-DataDiv",textContent:N.getText("NoteDialog - Icon content")}),this.#iconTextArea=J.create("textarea",{className:"TravelNotes-NoteDialog-TextArea",placeholder:"?????",rows:t.noteDialog.areaHeight.icon,dataset:{Name:"iconContent"}},this.#iconDiv),this.#eventListeners.onFocusControl=new $t(this.#noteDialog,!1),this.#eventListeners.onInputUpdated=new ee(this.#noteDialog),this.#iconTextArea.addEventListener("focus",this.#eventListeners.onFocusControl),this.#iconTextArea.addEventListener("input",this.#eventListeners.onInputUpdated)}destructor(){this.#iconTextArea.removeEventListener("focus",this.#eventListeners.onFocusControl),this.#iconTextArea.removeEventListener("input",this.#eventListeners.onInputUpdated),this.#eventListeners.onFocusControl.destructor(),this.#eventListeners.onInputUpdated.destructor(),this.#noteDialog=null}get HTMLElements(){return[this.#iconDiv]}get iconContent(){return this.#iconTextArea.value}set iconContent(t){this.#iconTextArea.value=t}}class ne{#noteDialog=null;#tooltipDiv=null;#tooltipInput=null;#eventListeners={onFocusControl:null,onInputUpdated:null};constructor(t){this.#noteDialog=t,this.#tooltipDiv=J.create("div",{className:"TravelNotes-NoteDialog-DataDiv",textContent:N.getText("NoteDialog - Tooltip content")}),this.#tooltipInput=J.create("input",{type:"text",className:"TravelNotes-NoteDialog-InputText",dataset:{Name:"tooltipContent"}},this.#tooltipDiv),this.#eventListeners.onFocusControl=new $t(this.#noteDialog,!1),this.#eventListeners.onInputUpdated=new ee(this.#noteDialog),this.#tooltipInput.addEventListener("focus",this.#eventListeners.onFocusControl),this.#tooltipInput.addEventListener("input",this.#eventListeners.onInputUpdated)}destructor(){this.#tooltipInput.removeEventListener("focus",this.#eventListeners.onFocusControl),this.#tooltipInput.removeEventListener("input",this.#eventListeners.onInputUpdated),this.#eventListeners.onFocusControl.destructor(),this.#eventListeners.onInputUpdated.destructor(),this.#noteDialog=null}get HTMLElements(){return[this.#tooltipDiv]}get tooltipContent(){return this.#tooltipInput.value}set tooltipContent(t){this.#tooltipInput.value=t}}class se{#noteDialog=null;#popupDiv=null;#popupTextArea=null;#eventListeners={onFocusControl:null,onInputUpdated:null};constructor(e){this.#noteDialog=e,this.#popupDiv=J.create("div",{className:"TravelNotes-NoteDialog-DataDiv",textContent:N.getText("NoteDialog - Text")}),this.#popupTextArea=J.create("textarea",{className:"TravelNotes-NoteDialog-TextArea",rows:t.noteDialog.areaHeight.popupContent,dataset:{Name:"popupContent"}},this.#popupDiv),this.#eventListeners.onFocusControl=new $t(this.#noteDialog,!1),this.#eventListeners.onInputUpdated=new ee(this.#noteDialog),this.#popupTextArea.addEventListener("focus",this.#eventListeners.onFocusControl),this.#popupTextArea.addEventListener("input",this.#eventListeners.onInputUpdated)}destructor(){this.#popupTextArea.removeEventListener("focus",this.#eventListeners.onFocusControl),this.#popupTextArea.removeEventListener("input",this.#eventListeners.onInputUpdated),this.#eventListeners.onFocusControl.destructor(),this.#eventListeners.onInputUpdated.destructor(),this.#noteDialog=null}get HTMLElements(){return[this.#popupDiv]}get popupContent(){return this.#popupTextArea.value}set popupContent(t){this.#popupTextArea.value=t}}class ae{#noteDialog=null;#addressHeaderDiv=null;#addressInputDiv=null;#addressInput=null;#addressButton=null;#latLng=null;#eventListeners={onFocusControl:null,onInputUpdated:null,onAddressButtonClick:null};constructor(t,e){this.#noteDialog=t,this.#latLng=e,this.#addressHeaderDiv=J.create("div",{className:"TravelNotes-NoteDialog-DataDiv"}),this.#addressButton=J.create("div",{className:"TravelNotes-BaseDialog-Button",title:N.getText("NoteDialog - Reset address"),textContent:"🔄"},this.#addressHeaderDiv),J.create("text",{value:N.getText("NoteDialog - Address")},this.#addressHeaderDiv),this.#addressInputDiv=J.create("div",{className:"TravelNotes-NoteDialog-DataDiv"}),this.#addressInput=J.create("input",{type:"text",className:"TravelNotes-NoteDialog-InputText",dataset:{Name:"address"}},this.#addressInputDiv),this.#eventListeners.onFocusControl=new $t(this.#noteDialog,!1),this.#eventListeners.onInputUpdated=new ee(this.#noteDialog),this.#eventListeners.onAddressButtonClick=new Qt(this.#noteDialog,this.#latLng),this.#addressInput.addEventListener("focus",this.#eventListeners.onFocusControl),this.#addressInput.addEventListener("input",this.#eventListeners.onInputUpdated),this.#addressButton.addEventListener("click",this.#eventListeners.onAddressButtonClick)}destructor(){this.#addressInput.removeEventListener("focus",this.#eventListeners.onFocusControl),this.#addressInput.removeEventListener("input",this.#eventListeners.onInputUpdated),this.#addressButton.removeEventListener("click",this.#eventListeners.onAddressButtonClick),this.#eventListeners.onFocusControl.destructor(),this.#eventListeners.onInputUpdated.destructor(),this.#eventListeners.onAddressButtonClick.destructor()}get HTMLElements(){return[this.#addressHeaderDiv,this.#addressInputDiv]}get address(){return this.#addressInput.value}set address(t){this.#addressInput.value=t}}class re{#noteDialog=null;#linkHeaderDiv=null;#linkInputDiv=null;#linkInput=null;#eventListeners={onFocusControl:null,onInputUpdated:null,onBlurUrlInput:null};#createTheDevilButton(e){t.noteDialog.theDevil.addButton&&J.create("text",{value:"👿"},J.create("a",{href:"https://www.google.com/maps/@"+e[0].toFixed(s.fixed)+","+e[1].toFixed(s.fixed)+","+t.noteDialog.theDevil.zoomFactor+"z",target:"_blank",title:"Reminder! The devil will know everything about you"},J.create("div",{className:"TravelNotes-BaseDialog-Button",title:"Reminder! The devil will know everything about you"},this.#linkHeaderDiv)))}constructor(t,e){this.#noteDialog=t,this.#linkHeaderDiv=J.create("div",{className:"TravelNotes-NoteDialog-DataDiv"}),this.#createTheDevilButton(e),J.create("text",{value:N.getText("NoteDialog - Link")},this.#linkHeaderDiv),this.#linkInputDiv=J.create("div",{className:"TravelNotes-NoteDialog-DataDiv"}),this.#linkInput=J.create("input",{type:"text",className:"TravelNotes-NoteDialog-InputText",dataset:{Name:"url"}},this.#linkInputDiv),this.#eventListeners.onFocusControl=new $t(this.#noteDialog,!0),this.#eventListeners.onInputUpdated=new ee(this.#noteDialog),this.#eventListeners.onBlurUrlInput=new te(this.#noteDialog),this.#linkInput.addEventListener("focus",this.#eventListeners.onFocusControl),this.#linkInput.addEventListener("input",this.#eventListeners.onInputUpdated),this.#linkInput.addEventListener("blur",this.#eventListeners.onBlurUrlInput)}destructor(){this.#linkInput.removeEventListener("focus",this.#eventListeners.onFocusControl),this.#linkInput.removeEventListener("input",this.#eventListeners.onInputUpdated),this.#linkInput.removeEventListener("blur",this.#eventListeners.onBlurUrlInput),this.#eventListeners.onFocusControl.destructor(),this.#eventListeners.onInputUpdated.destructor(),this.#eventListeners.onBlurUrlInput.destructor(),this.#noteDialog=null}get HTMLElements(){return[this.#linkHeaderDiv,this.#linkInputDiv]}get url(){return this.#linkInput.value}set url(t){this.#linkInput.value=t}}class le{#noteDialog=null;#phoneHeaderDiv=null;#phoneInputDiv=null;#phoneInput=null;#eventListeners={onFocusControl:null,onInputUpdated:null};constructor(t){this.#noteDialog=t,this.#phoneHeaderDiv=J.create("div",{className:"TravelNotes-NoteDialog-DataDiv"}),J.create("text",{value:" "+N.getText("NoteDialog - Phone")},this.#phoneHeaderDiv),this.#phoneInputDiv=J.create("div",{className:"TravelNotes-NoteDialog-DataDiv"}),this.#phoneInput=J.create("input",{type:"text",className:"TravelNotes-NoteDialog-InputText",dataset:{Name:"phone"}},this.#phoneInputDiv),this.#eventListeners.onFocusControl=new $t(this.#noteDialog,!1),this.#eventListeners.onInputUpdated=new ee(this.#noteDialog),this.#phoneInput.addEventListener("focus",this.#eventListeners.onFocusControl),this.#phoneInput.addEventListener("input",this.#eventListeners.onInputUpdated)}destructor(){this.#phoneInput.removeEventListener("focus",this.#eventListeners.onFocusControl),this.#phoneInput.removeEventListener("input",this.#eventListeners.onInputUpdated),this.#eventListeners.onFocusControl.destructor(),this.#eventListeners.onInputUpdated.destructor(),this.#noteDialog=null}get HTMLElements(){return[this.#phoneHeaderDiv,this.#phoneInputDiv]}get phone(){return this.#phoneInput.value}set phone(t){this.#phoneInput.value=t}}class de{#previewNote=null;#previewDiv=null;constructor(t){this.#previewNote=t,this.#previewDiv=J.create("div",{className:"TravelNotes-NoteDialog-PreviewDiv"}),this.#previewDiv.appendChild(ut.getNoteTextAndIconHTML("TravelNotes-NoteDialog-",{note:this.#previewNote,route:null}))}update(){this.#previewDiv.textContent="",this.#previewDiv.appendChild(ut.getNoteTextAndIconHTML("TravelNotes-NoteDialog-",{note:this.#previewNote,route:null}))}get HTMLElements(){return[this.#previewDiv]}}class he extends Rt{#note=null;#startGeoCoder=!1;#routeObjId=null;#previewNote=null;#iconDimsControl=null;#iconControl=null;#tooltipControl=null;#popupControl=null;#addressControl=null;#linkControl=null;#phoneControl=null;#previewControl=null;#toolbar=null;#focusControl=null;constructor(t,e,o){super(),this.#note=t,this.#startGeoCoder=o,this.#routeObjId=e,this.#previewNote=new k,this.#previewNote.jsonObject=t.jsonObject,this.#toolbar=new _t(this),this.#iconDimsControl=new oe(this),this.#iconControl=new ie(this),this.#tooltipControl=new ne(this),this.#popupControl=new se(this),this.#addressControl=new ae(this,t.latLng,o),this.#linkControl=new re(this,t.latLng),this.#phoneControl=new le(this),this.#previewControl=new de(this.#previewNote),this.setControlsValues(t)}#destructor(){this.#toolbar.destructor(),this.#iconDimsControl.destructor(),this.#iconControl.destructor(),this.#tooltipControl.destructor(),this.#popupControl.destructor(),this.#addressControl.destructor(),this.#linkControl.destructor(),this.#phoneControl.destructor()}set focusControl(t){this.#focusControl=t}get focusControl(){return this.#focusControl}get mapIconData(){return Object.freeze({latLng:this.#previewNote.latLng,routeObjId:this.#routeObjId})}updatePreview(t){for(const e in t)this.#previewNote[e]=t[e];this.#previewControl.update()}onShow(){this.#startGeoCoder&&new qt(this).setAddressWithGeoCoder(this.#previewNote.latLng),this.toogleContents()}canClose(){return""===this.#iconControl.iconContent?(this.showError(N.getText("Notedialog - The icon content cannot be empty")),!1):""!==this.#linkControl.url&&""===b.sanitizeToUrl(this.#linkControl.url).url?(this.showError(N.getText("NoteDialog - invalidUrl")),!1):(this.getControlsValues(this.#note),this.#note.latLng=this.#previewNote.latLng,this.#note.validateData(),!0)}onCancel(){this.#destructor(),super.onCancel()}onOk(){this.#destructor(),super.onOk()}get title(){return N.getText("NoteDialog - Note")}get contentHTMLElements(){return[].concat(this.#toolbar.rootHTMLElement,this.#iconDimsControl.HTMLElements,this.#iconControl.HTMLElements,this.#tooltipControl.HTMLElements,this.#popupControl.HTMLElements,this.#addressControl.HTMLElements,this.#linkControl.HTMLElements,this.#phoneControl.HTMLElements)}get footerHTMLElements(){return this.#previewControl.HTMLElements}setControlsValues(t){this.#iconDimsControl.iconHeight=t.iconHeight||this.#iconDimsControl.iconHeight,this.#iconDimsControl.iconWidth=t.iconWidth||this.#iconDimsControl.iconWidth,this.#iconControl.iconContent=t.iconContent||this.#iconControl.iconContent,this.#tooltipControl.tooltipContent=t.tooltipContent||this.#tooltipControl.tooltipContent,this.#popupControl.popupContent=t.popupContent||this.#popupControl.popupContent,this.#addressControl.address=t.address||this.#addressControl.address,this.#linkControl.url=t.url||this.#linkControl.url,this.#phoneControl.phone=t.phone||this.#phoneControl.phone}getControlsValues(t){t.iconWidth=this.#iconDimsControl.iconHeight,t.iconHeight=this.#iconDimsControl.iconWidth,t.iconContent=this.#iconControl.iconContent,t.tooltipContent=this.#tooltipControl.tooltipContent,t.popupContent=this.#popupControl.popupContent,t.address=this.#addressControl.address,t.url=this.#linkControl.url,t.phone=this.#phoneControl.phone}toogleContents(){t.noteDialog.mask.iconsDimension&&this.#iconDimsControl.HTMLElements[0].classList.toggle("TravelNotes-Hidden"),t.noteDialog.mask.iconTextArea&&this.#iconControl.HTMLElements[0].classList.toggle("TravelNotes-Hidden"),t.noteDialog.mask.popupContent&&this.#popupControl.HTMLElements[0].classList.toggle("TravelNotes-Hidden"),t.noteDialog.mask.tooltip&&this.#tooltipControl.HTMLElements[0].classList.toggle("TravelNotes-Hidden"),t.noteDialog.mask.address&&(this.#addressControl.HTMLElements[0].classList.toggle("TravelNotes-Hidden"),this.#addressControl.HTMLElements[1].classList.toggle("TravelNotes-Hidden")),t.noteDialog.mask.link&&(this.#linkControl.HTMLElements[0].classList.toggle("TravelNotes-Hidden"),this.#linkControl.HTMLElements[1].classList.toggle("TravelNotes-Hidden")),t.noteDialog.mask.phone&&(this.#phoneControl.HTMLElements[0].classList.toggle("TravelNotes-Hidden"),this.#phoneControl.HTMLElements[1].classList.toggle("TravelNotes-Hidden"))}}class ce{#backgroundDiv=null;#messageDiv=null;constructor(){Object.freeze(this)}createUI(){if(document.getElementById("TravelNotes-WaitUI"))return;this.#backgroundDiv=J.create("div",{className:"TravelNotes-Background"},document.body);let t=J.create("div",{id:"TravelNotes-WaitUI"},this.#backgroundDiv);this.#messageDiv=J.create("div",{id:"TravelNotes-WaitUI-MessageDiv"},t),J.create("div",{className:"TravelNotes-WaitAnimationBullet"},J.create("div",{className:"TravelNotes-WaitAnimation"},t))}showInfo(t){this.#messageDiv.textContent=t}close(){document.body.removeChild(this.#backgroundDiv),this.#backgroundDiv=null}}const ue=new class{#mainHTMLElement=null;#messageHTMLElement=null;#timerId=null;#showHelpInput=null;#showHelpHTMLElement=null;#showHelp=t.errorsUI.showHelp;#onHelpInputChange(){this.#showHelp=!this.#showHelpInput.checked}#hide(){this.#timerId&&(clearTimeout(this.#timerId),this.#timerId=null),this.#mainHTMLElement.classList.remove("TravelNotes-ErrorsUI-Error"),this.#mainHTMLElement.classList.remove("TravelNotes-ErrorsUI-Warning"),this.#mainHTMLElement.classList.remove("TravelNotes-ErrorsUI-Info"),this.#mainHTMLElement.classList.remove("TravelNotes-ErrorsUI-Help"),this.#mainHTMLElement.classList.add("TravelNotes-Hidden"),this.#showHelpHTMLElement.classList.add("TravelNotes-Hidden"),this.#messageHTMLElement.textContent=""}#show(e,o){if("Error"===o&&!t.errorsUI.showError||"Warning"===o&&!t.errorsUI.showWarning||"Info"===o&&!t.errorsUI.showInfo||"Help"===o&&!t.errorsUI.showHelp||"Help"===o&&!this.#showHelp)return;this.#timerId&&(clearTimeout(this.#timerId),this.#timerId=null),b.sanitizeToHtmlElement(e,this.#messageHTMLElement),this.#mainHTMLElement.classList.add("TravelNotes-ErrorsUI-"+o),this.#mainHTMLElement.classList.remove("TravelNotes-Hidden");let i=t.errorsUI.timeOut;"Help"===o&&(this.#showHelpHTMLElement.classList.remove("TravelNotes-Hidden"),i=t.errorsUI.helpTimeOut),this.#timerId=setTimeout((()=>this.#hide()),i)}constructor(){Object.freeze(this)}createUI(){if(this.#mainHTMLElement)return;this.#mainHTMLElement=J.create("div",{id:"TravelNotes-ErrorsUI",className:"TravelNotes-Hidden"},document.body);let t=J.create("div",null,this.#mainHTMLElement);J.create("span",{id:"TravelNotes-ErrorsUI-CancelButton",textContent:"❌"},t).addEventListener("click",(()=>this.#hide()),!1),this.#messageHTMLElement=J.create("div",{id:"TravelNotes-ErrorsUI-Message"},this.#mainHTMLElement),this.#showHelpHTMLElement=J.create("div",{id:"TravelNotes-ErrorsUI-HelpInputDiv",className:"TravelNotes-Hidden"},this.#mainHTMLElement),this.#showHelpInput=J.create("input",{id:"TravelNotes-ErrorsUI-HelpInput",type:"checkbox"},this.#showHelpHTMLElement),this.#showHelpInput.addEventListener("change",(()=>this.#onHelpInputChange()),!1),J.create("label",{id:"TravelNotes-ErrorsUI-HelpInputLabel",htmlFor:"TravelNotes-ErrorsUI-HelpInput",textContent:N.getText("ErrorUI - Dont show again")},this.#showHelpHTMLElement)}showError(t){this.#show(t,"Error")}showWarning(t){this.#show(t,"Warning")}showInfo(t){this.#show(t,"Info")}showHelp(t){this.#show(t,"Help")}};const pe=new class{#waitUI=null;#showSearchNoteDialog=null;#maneuverCounter=0;#addNote(t,e,o){if(o)if(c===e)V.travel.notes.add(t),U.dispatch("showtravelnotes");else{let o=Z.getRoute(e);o.notes.add(t),t.chainedDistance=o.chainedDistance,o.notes.sort(((t,e)=>t.distance-e.distance)),U.dispatch("showitinerary")}else c===e?U.dispatch("updatetravelnotes"):U.dispatch("updateitinerary");U.dispatch("noteupdated",{removedNoteObjId:t.objId,addedNoteObjId:t.objId}),U.dispatch("roadbookupdate")}#noteDialog(t,e,o){new he(t,e,o).show().then((()=>this.#addNote(t,e,o))).catch((t=>{console.error(t)}))}#newNote(t){let e=new k;return e.latLng=t,e.iconLatLng=t,e}constructor(){Object.freeze(this)}get osmSearchNoteDialog(){return null===this.#showSearchNoteDialog&&(this.#showSearchNoteDialog=t.osmSearch.showSearchNoteDialog),this.#showSearchNoteDialog}changeOsmSearchNoteDialog(){this.#showSearchNoteDialog=!this.osmSearchNoteDialog}newRouteNote(t){let e=Z.getRoute(t.routeObjId),o=G.getClosestLatLngDistance(e,[t.lat,t.lng]),i=this.#newNote(o.latLng);i.distance=o.distance,this.#noteDialog(i,e.objId,!0)}async newSearchNote(t){let e=c,o=new k;if(t.isTravelNote)o.latLng=[t.osmElement.lat,t.osmElement.lon];else{let i=Z.getNearestRouteData([t.osmElement.lat,t.osmElement.lon]);if(!i.route)return void ue.showError(N.getText("NoteEditor - No route was found"));o.latLng=i.latLngOnRoute,o.distance=i.distanceOnRoute,e=i.route.objId}if(o.iconLatLng=[t.osmElement.lat,t.osmElement.lon],o.iconHeight=l.height,o.iconWidth=l.width,t.osmElement.tags.rcn_ref?o.iconContent="<div class='TravelNotes-MapNote TravelNotes-MapNoteCategory-0073'><svg viewBox='0 0 20 20'><text x='10' y='14'>"+t.osmElement.tags.rcn_ref+"</text></svg></div>":o.iconContent=kt.getIconContentFromName(t.osmElement.description),o.url=t.osmElement.tags.website||"",o.phone=t.osmElement.tags.phone||"",o.tooltipContent=t.osmElement.description||"",o.popupContent=t.osmElement.tags.name||"",t.osmElement.tags["addr:street"]&&t.osmElement.tags["addr:city"])o.address=(t.osmElement.tags["addr:housenumber"]?t.osmElement.tags["addr:housenumber"]+" ":"")+t.osmElement.tags["addr:street"]+' <span class="TravelNotes-NoteHtml-Address-City">'+t.osmElement.tags["addr:city"]+"</span>";else{this.#waitUI=new ce,this.#waitUI.createUI(),this.#waitUI.showInfo("Creating address");let e=null;try{e=await(new Jt).getAddressAsync([t.osmElement.lat,t.osmElement.lon])}catch(t){console.error(t)}this.#waitUI.close(),e.statusOk&&(o.address=e.street,""!==e.city&&(o.address+=' <span class="TravelNotes-NoteHtml-Address-City">'+e.city+"</span>"))}this.osmSearchNoteDialog||""===o.iconContent?this.#noteDialog(o,e,!0):this.#addNote(o,e,!0)}newTravelNote(t){let e=this.#newNote(t);this.#noteDialog(e,c,!0)}editNote(t){let e=Z.getNoteAndRoute(t),o=null===e.route?c:e.route.objId;this.#noteDialog(e.note,o,!1)}removeNote(t){let e=Z.getNoteAndRoute(t);e.route?(e.route.notes.remove(t),U.dispatch("updateitinerary")):(V.travel.notes.remove(t),U.dispatch("updatetravelnotes")),U.dispatch("noteupdated",{removedNoteObjId:t,addedNoteObjId:c}),U.dispatch("roadbookupdate")}hideNotes(){let t=V.travel.notes.iterator;for(;!t.done;)U.dispatch("removeobject",{objId:t.value.objId});let e=V.travel.routes.iterator;for(;!e.done;)for(t=e.value.notes.iterator;!t.done;)U.dispatch("removeobject",{objId:t.value.objId});if(c!==V.editedRouteObjId)for(t=V.travel.editedRoute.notes.iterator;!t.done;)U.dispatch("removeobject",{objId:t.value.objId})}showNotes(){this.hideNotes();let t=V.travel.notes.iterator;for(;!t.done;)U.dispatch("noteupdated",{removedNoteObjId:c,addedNoteObjId:t.value.objId});let e=V.travel.routes.iterator;for(;!e.done;)e.value.hidden||U.dispatch("routeupdated",{removedRouteObjId:e.value.objId,addedRouteObjId:e.value.objId})}attachNoteToRoute(t){let e=Z.getNoteAndRoute(t).note,o=Z.getNearestRouteData(e.latLng);o.route&&(V.travel.notes.remove(t),e.distance=o.distance,e.latLng=o.latLngOnRoute,e.chainedDistance=o.route.chainedDistance,o.route.notes.add(e),o.route.notes.sort(((t,e)=>t.distance-e.distance)),U.dispatch("noteupdated",{removedNoteObjId:t,addedNoteObjId:t}),U.dispatch("updateitinerary"),U.dispatch("updatetravelnotes"),U.dispatch("roadbookupdate"))}detachNoteFromRoute(t){let e=Z.getNoteAndRoute(t);e.route.notes.remove(t),e.note.distance=o.invalid,e.note.chainedDistance=o.defaultValue,V.travel.notes.add(e.note),U.dispatch("updateitinerary"),U.dispatch("updatetravelnotes"),U.dispatch("roadbookupdate")}travelNoteDropped(t,e,o){V.travel.notes.moveTo(t,e,o),U.dispatch("updatetravelnotes"),U.dispatch("roadbookupdate")}};
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file PasswordDialogEventListeners.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/class ge{#passwordInput=null;constructor(t){this.#passwordInput=t}destructor(){this.#passwordInput=null}handleEvent(t){t.stopPropagation,this.#passwordInput.type="text"}}class ve{#passwordInput=null;constructor(t){this.#passwordInput=t}destructor(){this.#passwordInput=null}handleEvent(t){t.stopPropagation,this.#passwordInput.type="password",this.#passwordInput.focus()}}class me extends Rt{#passwordDiv=null;#passwordInput=null;#eyeSpan=null;#verifyPassword=!1;#onMouseDownEyeEventListener=null;#onMouseUpEyeEventListener=null;constructor(t){super(),this.#verifyPassword=t,this.#passwordDiv=J.create("div",{id:"TravelNotes-PasswordDialog-PasswordDiv"}),this.#passwordInput=J.create("input",{type:"password"},this.#passwordDiv),this.#onMouseDownEyeEventListener=new ge(this.#passwordInput),this.#onMouseUpEyeEventListener=new ve(this.#passwordInput),this.#eyeSpan=J.create("span",{id:"TravelNotes-PasswordDialog-EyeSpan",textContent:"👁️"},this.#passwordDiv),this.#eyeSpan.addEventListener("mousedown",this.#onMouseDownEyeEventListener,!1),this.#eyeSpan.addEventListener("mouseup",this.#onMouseUpEyeEventListener,!1)}#destructor(){this.#eyeSpan.removeEventListener("mousedown",this.#onMouseDownEyeEventListener,!1),this.#eyeSpan.removeEventListener("mouseup",this.#onMouseUpEyeEventListener,!1),this.#onMouseDownEyeEventListener.destructor(),this.#onMouseUpEyeEventListener.destructor()}canClose(){return this.hideError(),!(this.#verifyPassword&&(this.#passwordInput.value.length<12||!this.#passwordInput.value.match(/[0-9]+/)||!this.#passwordInput.value.match(/[a-z]+/)||!this.#passwordInput.value.match(/[A-Z]+/)||!this.#passwordInput.value.match(/[^0-9a-zA-Z]/)))||(this.showError("<p>"+N.getText("PasswordDialog - Password rules1")+"</p><ul><li>"+N.getText("PasswordDialog - Password rules2")+"</li><li>"+N.getText("PasswordDialog - Password rules3")+"</li><li>"+N.getText("PasswordDialog - Password rules4")+"</li><li>"+N.getText("PasswordDialog - Password rules5")+"</li><li>"+N.getText("PasswordDialog - Password rules6")+"</li></ul>"),this.#passwordInput.focus(),!1)}onCancel(){this.#destructor(),super.onCancel()}onOk(){this.#destructor(),super.onOk((new window.TextEncoder).encode(this.#passwordInput.value))}onShow(){this.#passwordInput.focus()}get contentHTMLElements(){return[this.#passwordDiv]}get title(){return N.getText("PasswordDialog - password")}}
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file DataEncryptor.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/class ye{#salt=null;#importKey(t){return window.crypto.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"])}#deriveKey(t,e){return window.crypto.subtle.deriveKey({name:"PBKDF2",salt:(new window.TextEncoder).encode(e),iterations:1e6,hash:"SHA-256"},t,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}#decrypt(t,e){return window.crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(e.slice(0,16))},t,new Uint8Array(e.slice(16)))}#encrypt(t,e,o){return window.crypto.subtle.encrypt({name:"AES-GCM",iv:e},t,o)}constructor(t){this.#salt=t||"Tire la chevillette la bobinette cherra. Le Petit Chaperon rouge tira la chevillette.",Object.freeze(this)}encryptData(t,e,o,i){let n=window.crypto.getRandomValues(new Uint8Array(16));i.then(this.#importKey).then((t=>this.#deriveKey(t,this.#salt))).then((e=>this.#encrypt(e,n,t))).then((t=>{e(new Blob([n,new Uint8Array(t)],{type:"application/octet-stream"}))})).catch(o)}decryptData(t,e,o,i){i.then(this.#importKey).then((t=>this.#deriveKey(t,this.#salt))).then((e=>this.#decrypt(e,t))).then(e).catch(o)}}class be{handleEvent(t){t.stopPropagation();let e=new Event("apikeydeleted");e.data={objId:Number.parseInt(t.target.dataset.tanObjId)},t.target.parentNode.parentNode.dispatchEvent(e)}}class we{#rootHTMLElement=null;#providerNameInput=null;#providerKeyInput=null;#objId=c;constructor(e){this.#objId=D.nextObjId,this.#rootHTMLElement=J.create("div",{className:"TravelNotes-APIKeysDialog-ApiKeyRow"}),this.#providerNameInput=J.create("input",{className:"TravelNotes-APIKeysDialog-ApiKeyName TravelNotes-APIKeysDialog-Input",value:e.providerName,placeholder:N.getText("APIKeysDialog - provider name")},this.#rootHTMLElement),this.#providerKeyInput=J.create("input",{className:"TravelNotes-APIKeysDialog-ApiKeyValue TravelNotes-APIKeysDialog-Input",value:e.providerKey,placeholder:N.getText("APIKeysDialog - API key"),type:t.APIKeysDialog.showAPIKeys?"text":"password"},this.#rootHTMLElement),J.create("div",{className:"TravelNotes-BaseDialog-Button TravelNotes-APIKeysDialog-AtRightButton TravelNotes-APIKeysDialog-DeleteRowButton",title:N.getText("APIKeysDialog - delete API key"),textContent:"❌",dataset:{ObjId:this.#objId}},this.#rootHTMLElement).addEventListener("click",new be,!1)}get objId(){return this.#objId}get HTMLElements(){return[this.#rootHTMLElement]}get providerName(){return this.#providerNameInput.value}get providerKey(){return this.#providerKeyInput.value}get APIKey(){return Object.seal({providerName:this.#providerNameInput.value,providerKey:this.#providerKeyInput.value})}}class De{#APIKeysDialog=null;constructor(t){this.#APIKeysDialog=t}destructor(){this.#APIKeysDialog=null}onErrorDecrypt(t){this.#APIKeysDialog.hideWait(),this.#APIKeysDialog.keyboardEventListenerEnabled=!0,t&&"Canceled by user"!==t&&this.#APIKeysDialog.showError(N.getText("APIKeysDialog - An error occurs when reading the file"))}onOkDecrypt(t){try{this.#APIKeysDialog.addAPIKeys(JSON.parse((new TextDecoder).decode(t)))}catch(t){return void this.onErrorDecrypt(t)}this.#APIKeysDialog.hideWait(),this.#APIKeysDialog.hideError(),this.#APIKeysDialog.keyboardEventListenerEnabled=!0}onOkEncrypt(t){this.#APIKeysDialog.hideError(),this.#APIKeysDialog.hideWait(),E.saveFile("APIKeys",t),this.#APIKeysDialog.keyboardEventListenerEnabled=!0}onErrorEncrypt(){this.#APIKeysDialog.showError(N.getText("APIKeysDialog - An error occurs when saving the keys")),this.#APIKeysDialog.hideWait(),this.#APIKeysDialog.keyboardEventListenerEnabled=!0}}class Ie{#APIKeysControls=null;constructor(t){this.#APIKeysControls=t}destructor(){this.#APIKeysControls=null}getAPIKeysJsonString(){let t=[];return this.#APIKeysControls.forEach((e=>{t.push(e.APIKey)})),JSON.stringify(t)}}class fe{#APIKeysDialog=null;#APIKeysControls=null;constructor(t,e){this.#APIKeysDialog=t,this.#APIKeysControls=e}destructor(){this.#APIKeysDialog=null,this.#APIKeysControls=null}handleEvent(t){t.stopPropagation(),this.#APIKeysControls.delete(t.data.objId),this.#APIKeysDialog.refreshAPIKeys()}}class Le{#APIKeysDialog=null;constructor(t){this.#APIKeysDialog=t}destructor(){this.#APIKeysDialog=null}handleEvent(t){t.stopPropagation();let e=new FileReader;e.onload=()=>{try{this.#APIKeysDialog.addAPIKeys(JSON.parse(e.result))}catch(t){this.#APIKeysDialog.showError(t.message),t instanceof Error&&console.error(t)}},e.readAsText(t.target.files[0])}}class Te{#APIKeysDialog=null;#openUnsecureFileInputEventListener=null;constructor(t){this.#APIKeysDialog=t,this.#openUnsecureFileInputEventListener=new Le(this.#APIKeysDialog)}destructor(){this.#APIKeysDialog=null,this.#openUnsecureFileInputEventListener.destructor()}handleEvent(t){t.stopPropagation(),this.#APIKeysDialog.hideError(),E.openFile(this.#openUnsecureFileInputEventListener,".json")}}class Ne{#APIKeysDialog=null;#dataEncryptorHandlers=null;constructor(t){this.#APIKeysDialog=t,this.#dataEncryptorHandlers=new De(this.#APIKeysDialog)}destructor(){this.#APIKeysDialog=null,this.#dataEncryptorHandlers.destructor()}handleEvent(t){t.stopPropagation(),this.#APIKeysDialog.hideError(),this.#APIKeysDialog.showWait(),this.#APIKeysDialog.keyboardEventListenerEnabled=!1,fetch(window.location.href.substr(0,window.location.href.lastIndexOf("/")+1)+"APIKeys").then((t=>{g===t.status&&t.ok?t.arrayBuffer().then((t=>{(new ye).decryptData(t,(t=>{this.#dataEncryptorHandlers.onOkDecrypt(t)}),(t=>{this.#dataEncryptorHandlers.onErrorDecrypt(t)}),new me(!1).show())})):this.#dataEncryptorHandlers.onErrorDecrypt(new Error("Invalid http status"))})).catch((t=>{this.#dataEncryptorHandlers.onErrorDecrypt(t),t instanceof Error&&console.error(t)}))}}class Ee{#APIKeysDialog=null;#dataEncryptorHandlers=null;constructor(t){this.#APIKeysDialog=t,this.#dataEncryptorHandlers=new De(this.#APIKeysDialog)}destructor(){this.#APIKeysDialog=null,this.#dataEncryptorHandlers.destructor()}handleEvent(t){t.stopPropagation(),this.#APIKeysDialog.showWait(),this.#APIKeysDialog.keyboardEventListenerEnabled=!1;let e=new FileReader;e.onload=()=>{(new ye).decryptData(e.result,(t=>{this.#dataEncryptorHandlers.onOkDecrypt(t)}),(t=>{this.#dataEncryptorHandlers.onErrorDecrypt(t)}),new me(!1).show())},e.readAsArrayBuffer(t.target.files[0])}}class Pe{#APIKeysDialog=null;#openSecureFileInputEventListener=null;constructor(t){this.#APIKeysDialog=t,this.#openSecureFileInputEventListener=new Ee(this.#APIKeysDialog)}destructor(){this.#APIKeysDialog=null,this.#openSecureFileInputEventListener.destructor()}handleEvent(t){t.stopPropagation(),this.#APIKeysDialog.hideError(),E.openFile(this.#openSecureFileInputEventListener)}}class Ce{#APIKeysDialog=null;#APIKeysControls=null;#saveAPIKeysHelper=null;#dataEncryptorHandlers=null;constructor(t,e){this.#APIKeysDialog=t,this.#APIKeysControls=e,this.#saveAPIKeysHelper=new Ie(this.#APIKeysControls),this.#dataEncryptorHandlers=new De(this.#APIKeysDialog)}destructor(){this.#APIKeysDialog=null,this.#APIKeysControls=null,this.#saveAPIKeysHelper.destructor(),this.#dataEncryptorHandlers.destructor()}handleEvent(t){t.stopPropagation(),this.#APIKeysDialog.validateAPIKeys()&&(this.#APIKeysDialog.showWait(),this.#APIKeysDialog.keyboardEventListenerEnabled=!1,(new ye).encryptData((new window.TextEncoder).encode(this.#saveAPIKeysHelper.getAPIKeysJsonString()),(t=>this.#dataEncryptorHandlers.onOkEncrypt(t)),(()=>this.#dataEncryptorHandlers.onErrorEncrypt()),new me(!0).show()))}}class xe{#APIKeysDialog=null;#APIKeysControls=null;#saveAPIKeysHelper=null;constructor(t,e){this.#APIKeysDialog=t,this.#APIKeysControls=e,this.#saveAPIKeysHelper=new Ie(this.#APIKeysControls)}destructor(){this.#APIKeysDialog=null,this.#APIKeysControls=null,this.#saveAPIKeysHelper.destructor()}handleEvent(t){t.stopPropagation(),this.#APIKeysDialog.validateAPIKeys()&&E.saveFile("APIKeys.json",this.#saveAPIKeysHelper.getAPIKeysJsonString(),"application/json")}}class Ae{#APIKeysDialog=null;#APIKeysControls=null;constructor(t,e){this.#APIKeysDialog=t,this.#APIKeysControls=e}destructor(){this.#APIKeysDialog=null,this.#APIKeysControls=null}handleEvent(t){t.stopPropagation();let e=Object.seal({providerName:"",providerKey:""}),o=new we(e);this.#APIKeysControls.set(o.objId,o),this.#APIKeysDialog.refreshAPIKeys()}}class je{#APIKeysDialog=null;#APIKeysControls=null;#haveAPIKeysFile=!1;#rootHTMLElement=null;#reloadKeysFromServerButton=null;#saveKeysToSecureFileButton=null;#restoreKeysFromSecureFileButton=null;#newAPIKeyButton=null;#saveKeysToUnsecureFileButton=null;#restoreKeysFromUnsecureFileButton=null;#reloadKeysFromServerButtonEventListener=null;#saveKeysToSecureFileButtonEventListener=null;#restoreKeysFromSecureFileButtonEventListener=null;#newAPIKeyButtonEventListener=null;#saveKeysToUnsecureFileButtonEventListener=null;#restoreKeysFromUnsecureFileButtonEventListener=null;#createReloadKeysFromServerButton(){this.#reloadKeysFromServerButton=J.create("div",{className:"TravelNotes-BaseDialog-Button",title:N.getText("APIKeysDialog - Reload from server"),textContent:"🔄"},this.#rootHTMLElement),this.#reloadKeysFromServerButtonEventListener=new Ne(this.#APIKeysDialog),this.#reloadKeysFromServerButton.addEventListener("click",this.#reloadKeysFromServerButtonEventListener,!1)}#createSaveKeysToSecureFileButton(){this.#saveKeysToSecureFileButton=J.create("div",{className:"TravelNotes-BaseDialog-Button",title:N.getText("APIKeysDialog - Save to file"),textContent:"💾"},this.#rootHTMLElement),this.#saveKeysToSecureFileButtonEventListener=new Ce(this.#APIKeysDialog,this.#APIKeysControls),this.#saveKeysToSecureFileButton.addEventListener("click",this.#saveKeysToSecureFileButtonEventListener,!1)}#createRestoreKeysFromSecureFileButton(){this.#restoreKeysFromSecureFileButton=J.create("div",{className:"TravelNotes-BaseDialog-Button",title:N.getText("APIKeysDialog - Open file"),textContent:"📂"},this.#rootHTMLElement),this.#restoreKeysFromSecureFileButtonEventListener=new Pe(this.#APIKeysDialog),this.#restoreKeysFromSecureFileButton.addEventListener("click",this.#restoreKeysFromSecureFileButtonEventListener,!1)}#createNewAPIKeyButton(){this.#newAPIKeyButton=J.create("div",{className:"TravelNotes-BaseDialog-Button",title:N.getText("APIKeysDialog - new API key"),textContent:"+"},this.#rootHTMLElement),this.#newAPIKeyButtonEventListener=new Ae(this.#APIKeysDialog,this.#APIKeysControls),this.#newAPIKeyButton.addEventListener("click",this.#newAPIKeyButtonEventListener,!1)}#createSaveKeysToUnsecureFileButton(){this.#saveKeysToUnsecureFileButton=J.create("div",{className:"TravelNotes-BaseDialog-Button TravelNotes-APIKeysDialog-AtRightButton",title:N.getText("APIKeysDialog - Save to json file"),textContent:"💾"},this.#rootHTMLElement),this.#saveKeysToUnsecureFileButtonEventListener=new xe(this.#APIKeysDialog,this.#APIKeysControls),this.#saveKeysToUnsecureFileButton.addEventListener("click",this.#saveKeysToUnsecureFileButtonEventListener,!1)}#createRestoreKeysFromUnsecureFileButton(){this.#restoreKeysFromUnsecureFileButton=J.create("div",{className:"TravelNotes-BaseDialog-Button",title:N.getText("APIKeysDialog - Open json file"),textContent:"📂"},this.#rootHTMLElement),this.#restoreKeysFromUnsecureFileButtonEventListener=new Te(this.#APIKeysDialog),this.#restoreKeysFromUnsecureFileButton.addEventListener("click",this.#restoreKeysFromUnsecureFileButtonEventListener,!1)}#addToolbarButtons(){window.crypto&&window.crypto.subtle&&window.crypto.subtle.importKey&&window.isSecureContext&&(this.#haveAPIKeysFile&&this.#createReloadKeysFromServerButton(),this.#createSaveKeysToSecureFileButton(),this.#createRestoreKeysFromSecureFileButton()),this.#createNewAPIKeyButton(),t.APIKeysDialog.haveUnsecureButtons&&(this.#createSaveKeysToUnsecureFileButton(),this.#createRestoreKeysFromUnsecureFileButton())}constructor(t,e,o){this.#APIKeysDialog=t,this.#APIKeysControls=e,this.#haveAPIKeysFile=o,this.#rootHTMLElement=J.create("div",{id:"TravelNotes-APIKeysDialog-ToolbarDiv"}),this.#addToolbarButtons()}destructor(){this.#reloadKeysFromServerButton&&(this.#reloadKeysFromServerButton.removeEventListener("click",this.#reloadKeysFromServerButtonEventListener,!1),this.#reloadKeysFromServerButtonEventListener.destructor()),this.#saveKeysToSecureFileButton&&(this.#saveKeysToSecureFileButton.removeEventListener("click",this.#saveKeysToSecureFileButtonEventListener,!1),this.#saveKeysToSecureFileButtonEventListener.destructor()),this.#restoreKeysFromSecureFileButton&&(this.#restoreKeysFromSecureFileButton.removeEventListener("click",this.#restoreKeysFromSecureFileButtonEventListener,!1),this.#restoreKeysFromSecureFileButtonEventListener.destructor()),this.#newAPIKeyButton&&(this.#newAPIKeyButton.removeEventListener("click",this.#newAPIKeyButtonEventListener,!1),this.#newAPIKeyButtonEventListener.destructor()),this.#saveKeysToUnsecureFileButton&&(this.#saveKeysToUnsecureFileButton.removeEventListener("click",this.#saveKeysToUnsecureFileButtonEventListener,!1),this.#saveKeysToUnsecureFileButtonEventListener.destructor()),this.#restoreKeysFromUnsecureFileButton&&(this.#restoreKeysFromUnsecureFileButton.removeEventListener("click",this.#restoreKeysFromUnsecureFileButtonEventListener,!1),this.#restoreKeysFromUnsecureFileButtonEventListener.destructor())}get rootHTMLElement(){return this.#rootHTMLElement}}class Me extends Rt{#APIKeysControls=new Map;#toolbar=null;#APIKeysControlsContainer=null;#onAPIKeyDeletedEventListener=null;#createAPIKeysControlsContainer(){this.#APIKeysControlsContainer=J.create("div"),this.#onAPIKeyDeletedEventListener=new fe(this,this.#APIKeysControls),this.#APIKeysControlsContainer.addEventListener("apikeydeleted",this.#onAPIKeyDeletedEventListener,!1)}constructor(t,e){super(),this.#toolbar=new je(this,this.#APIKeysControls,e),this.#createAPIKeysControlsContainer(),this.addAPIKeys(t)}#destructor(){this.#toolbar.destructor(),this.#APIKeysControlsContainer.removeEventListener("apikeydeleted",this.#onAPIKeyDeletedEventListener,!1),this.#onAPIKeyDeletedEventListener.destructor()}validateAPIKeys(){this.hideError();let t=!1,e=[];this.#APIKeysControls.forEach((o=>{t=t||""===o.providerName||""===o.providerKey,e.push(o.providerName)}));let o=!1;return e.forEach((t=>{o=o||e.indexOf(t)!==e.lastIndexOf(t)})),t?(this.showError(N.getText("APIKeysDialog - empty API key name or value")),!1):!o||(this.showError(N.getText("APIKeysDialog - duplicate API key name found")),!1)}addAPIKeys(t){this.#APIKeysControls.clear(),t.forEach((t=>{let e=new we(t);this.#APIKeysControls.set(e.objId,e)})),this.refreshAPIKeys()}refreshAPIKeys(){for(;this.#APIKeysControlsContainer.firstChild;)this.#APIKeysControlsContainer.removeChild(this.#APIKeysControlsContainer.firstChild);this.#APIKeysControls.forEach((t=>{this.#APIKeysControlsContainer.appendChild(t.HTMLElements[0])}))}canClose(){return this.validateAPIKeys()}onCancel(){this.#destructor(),super.onCancel()}onOk(){let t=[];this.#APIKeysControls.forEach((e=>t.push(e.APIKey))),this.#destructor(),super.onOk(t)}get title(){return N.getText("APIKeysDialog - API keys")}get contentHTMLElements(){return[this.#toolbar.rootHTMLElement,this.#APIKeysControlsContainer]}}
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file BaseRouteProvider.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/class Oe{#userLanguage="fr";#providerKey="";#route=null;#getRoute(t,e){}constructor(){Object.seal(this)}get icon(){return"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAIAAAC0Ujn1AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAArSURBVEhL7cyxDQAgAAQh91/67ektTI4BOHumGtWoRjWqUY1qVKMaP9bbBZKXggu6NeCUAAAAAElFTkSuQmCC"}getPromiseRoute(t){return this.#route=t,new Promise(((t,e)=>this.#getRoute(t,e)))}get name(){return""}get title(){return""}get transitModes(){return[]}get providerKeyNeeded(){return!0}get providerKey(){return this.#providerKey.length}set providerKey(t){this.#providerKey=t}get userLanguage(){return this.#userLanguage}set userLanguage(t){this.#userLanguage=t}}const Se=new class{#haveAPIKeysFile=!1;#APIKeysMap=new Map;#onOkDecryptServerFile(t){let e=JSON.parse((new TextDecoder).decode(t));this.#resetAPIKeys(e)}#onErrorDecryptServerFile(t){t instanceof Error&&console.error(t),t&&"Canceled by user"!==t&&ue.showError(N.getText("APIKeysManager - An error occurs when reading the APIKeys file"))}#onServerFileFound(t){window.isSecureContext&&window.crypto&&window.crypto.subtle&&window.crypto.subtle.importKey&&(new ye).decryptData(t,(t=>this.#onOkDecryptServerFile(t)),(t=>this.#onErrorDecryptServerFile(t)),new me(!1).show())}#getAPIKey(t){return this.#APIKeysMap.get(t.toLowerCase())}#setAPIKey(t,e){this.#APIKeysMap.set(t.toLowerCase(),e)}#setAPIKeysFromSessionStorage(){let t=0;for(let e=0;e<sessionStorage.length;e++){let o=sessionStorage.key(e);"ProviderKey"===o.substr(o.length-"ProviderKey".length)&&(this.#setAPIKey(o.substr(0,o.length-"ProviderKey".length),atob(sessionStorage.getItem(o))),t++)}return V.providers.forEach((t=>{t.providerKey=this.#getAPIKey(t.name)||""})),t}#resetAPIKeys(e){sessionStorage.clear(),this.#APIKeysMap.clear();let o=E.storageAvailable("sessionStorage")&&t.APIKeys.saveToSessionStorage;e.forEach((t=>{o&&sessionStorage.setItem(t.providerName.toLowerCase()+"ProviderKey",btoa(t.providerKey)),this.#setAPIKey(t.providerName,t.providerKey)})),V.providers.forEach((t=>{t.providerKey=this.#getAPIKey(t.name)||""})),U.dispatch("providersadded")}constructor(){Object.freeze(this)}hasKey(t){return this.#APIKeysMap.has(t.toLowerCase())}getUrl(t){if(t.providerKeyNeeded){let e=this.#APIKeysMap.get(t.providerName.toLowerCase());return e?t.url.replace("{providerKey}",e):null}return t.url}setKeysFromServerFile(){let t=!1;0!==this.#setAPIKeysFromSessionStorage()&&(U.dispatch("providersadded"),t=!0),fetch(window.location.href.substr(0,window.location.href.lastIndexOf("/")+1)+"APIKeys").then((e=>{g===e.status&&e.ok&&(this.#haveAPIKeysFile=!0,t||e.arrayBuffer().then((t=>this.#onServerFileFound(t))))})).catch((t=>{t instanceof Error&&console.error(t)}))}setKeysFromDialog(){let t=[];this.#APIKeysMap.forEach(((e,o)=>{t.push(Object.seal({providerName:o,providerKey:e}))})),t.sort(((t,e)=>t.providerName.localeCompare(e.providerName))),new Me(t,this.#haveAPIKeysFile).show().then((t=>this.#resetAPIKeys(t))).catch((t=>{t instanceof Error&&console.error(t)}))}addProvider(t){if(!Object.prototype.isPrototypeOf.call(Oe,t))return void console.error("Invalid provider class given : "+t.name);let e=new t,o=e.name.toLowerCase(),i=this.#getAPIKey(o);e.providerKeyNeeded&&!i&&E.storageAvailable("sessionStorage")&&(i=sessionStorage.getItem(o),i&&(i=atob(i))),e.providerKeyNeeded&&i&&(e.providerKey=i),V.providers.set(e.name.toLowerCase(),e)}};class Re{#myGpxString="";#timeStamp="";#route=null;#addHeader(){this.#myGpxString='<?xml version="1.0"?>\n',this.#myGpxString+='<gpx xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd" version="1.1" creator="leaflet.TravelNotes">'}#addWayPoints(){let t=this.#route.wayPoints.iterator;for(;!t.done;)this.#myGpxString+='\n\t<wpt lat="'+t.value.lat+'" lon="'+t.value.lng+'" '+this.#timeStamp+"/>"}#addRoute(){this.#myGpxString+="\n\t<rte>";let t=this.#route.itinerary.maneuvers.iterator;for(;!t.done;){let e=this.#route.itinerary.itineraryPoints.getAt(t.value.itineraryPointObjId),o=t.value.instruction.replaceAll(/\u0027/g,"&apos;").replaceAll(/"/g,"&quot;").replaceAll(/</g,"&lt;").replaceAll(/>/g,"&gt;");this.#myGpxString+='\n\t\t<rtept lat="'+e.lat+'" lon="'+e.lng+'" '+this.#timeStamp+'desc="'+o+'" />'}this.#myGpxString+="\n\t</rte>"}#addTrack(){this.#myGpxString+="\n\t<trk>",this.#myGpxString+="\n\t\t<trkseg>";let t=this.#route.itinerary.itineraryPoints.iterator;for(;!t.done;)this.#myGpxString+='\n\t\t\t<trkpt lat="'+t.value.lat+'" lon="'+t.value.lng+'" '+this.#timeStamp+" />";this.#myGpxString+="\n\t\t</trkseg>",this.#myGpxString+="\n\t</trk>"}#addFooter(){this.#myGpxString+="\n</gpx>"}#saveGpxToFile(){let t=(""===V.travel.name?"":V.travel.name+" - ")+this.#route.computedName;""===t&&(t="TravelNote"),t+=".gpx",E.saveFile(t,this.#myGpxString)}constructor(){Object.freeze(this)}routeToGpx(t){this.#route=Z.getRoute(t),this.#route&&(this.#timeStamp='time="'+(new Date).toISOString()+'" ',this.#addHeader(),this.#addWayPoints(),this.#addRoute(),this.#addTrack(),this.#addFooter(),this.#saveGpxToFile())}}class ke{#red=e.maxColorValue;#green=e.maxColorValue;#blue=e.maxColorValue;constructor(t,o,i){this.#red="number"==typeof t&&e.maxColorValue>=t&&e.minColorValue<=t?t:e.maxColorValue,this.#green="number"==typeof o&&e.maxColorValue>=o&&e.minColorValue<=o?o:e.maxColorValue,this.#blue="number"==typeof i&&e.maxColorValue>=i&&e.minColorValue<=i?i:e.maxColorValue,Object.seal(this)}get red(){return this.#red}set red(t){"number"==typeof t&&e.maxColorValue>=t&&e.minColorValue<=t&&(this.#red=t)}get green(){return this.#green}set green(t){"number"==typeof t&&e.maxColorValue>=t&&e.minColorValue<=t&&(this.#green=t)}get blue(){return this.#blue}set blue(t){"number"==typeof t&&e.maxColorValue>=t&&e.minColorValue<=t&&(this.#blue=t)}get cssColor(){return"#"+this.#red.toString(p).padStart(2,"0")+this.#green.toString(p).padStart(2,"0")+this.#blue.toString(p).padStart(2,"0")}set cssColor(t){"#"===t[0]?(this.#red=Number.parseInt(t.substr(1,2),p),this.#green=Number.parseInt(t.substr(3,2),p),this.#blue=Number.parseInt(t.substr(5,2),p)):"rgb"===t.substr(0,3)&&([this.#red,this.#green,this.#blue]=Array.from(t.match(/[0-9]{1,3}/g),(t=>Number.parseInt(t))))}clone(){return new ke(this.#red,this.#green,this.#blue)}copyTo(t){t.red=this.#red,t.green=this.#green,t.blue=this.#blue}}class Be{#redSlider=null;#colorButtons=null;constructor(t,e){this.#redSlider=t,this.#colorButtons=e}destructor(){this.#redSlider=null,this.#colorButtons=null}handleEvent(t){t.stopPropagation();let o=new ke;o.red=Math.ceil(t.target.valueAsNumber*(e.maxColorValue/e.sliderMaxValue));for(let t=0;t<e.rowsNumber;++t){o.blue=t*e.deltaColor;for(let i=0;i<e.rowsNumber;++i)o.green=i*e.deltaColor,this.#colorButtons[e.rowsNumber*t+i].style["background-color"]=o.cssColor}}}class He{#colorControl=null;#inputs=null;constructor(t,e){this.#colorControl=t,this.#inputs=e}destructor(){this.#colorControl=null,this.#inputs=null}handleEvent(t){t.stopPropagation();let e=new ke(Number.parseInt(this.#inputs.red.value),Number.parseInt(this.#inputs.green.value),Number.parseInt(this.#inputs.blue.value));this.#colorControl.color=e}}class Ke{#colorControl=null;constructor(t){this.#colorControl=t}destructor(){this.#colorControl=null}handleEvent(t){t.stopPropagation();let e=new ke;e.cssColor=t.target.style["background-color"],this.#colorControl.color=e}}class Fe{#colorDiv=null;#colorButtons=[];#inputs={red:null,green:null,blue:null};#redSliderInput=null;#rgbDiv=null;#colorSampleDiv=null;#newColor=new ke;#eventListeners={onColorButtonClick:null,onColorInput:null,onRedSliderInput:null};#createColorButtonsDiv(){let t=J.create("div",null,this.#colorDiv),o=new ke(e.initialRed,e.minColorValue,e.minColorValue);this.#eventListeners.onColorButtonClick=new Ke(this);for(let i=0;i<e.rowsNumber;++i){let i=J.create("div",null,t);o.green=e.minColorValue;for(let t=0;t<e.cellsNumber;++t){let t=J.create("div",{className:"TravelNotes-ColorControl-CellColorDiv"},i);t.style["background-color"]=o.cssColor,t.addEventListener("click",this.#eventListeners.onColorButtonClick,!1),o.green+=e.deltaColor,this.#colorButtons.push(t)}o.blue+=e.deltaColor}}#createRedSliderDiv(){let t=J.create("div",null,this.#colorDiv);this.#redSliderInput=J.create("input",{type:"range",value:Math.ceil(e.initialRed*(e.sliderMaxValue/e.maxColorValue)),min:0,max:e.sliderMaxValue,step:e.sliderStep},t),this.#eventListeners.onRedSliderInput=new Be(this.#redSliderInput,this.#colorButtons),this.#redSliderInput.addEventListener("input",this.#eventListeners.onRedSliderInput,!1),this.#redSliderInput.focus()}#createColorInput(t,o){J.create("text",{value:t},this.#rgbDiv);let i=J.create("input",{type:"number",className:"TravelNotes-ColorControl-NumberInput",value:o,min:e.minColorValue,max:e.maxColorValue},this.#rgbDiv);return i.addEventListener("input",this.#eventListeners.onColorInput,!1),i}#createColorInputsDiv(){this.#rgbDiv=J.create("div",null,this.#colorDiv),this.#eventListeners.onColorInput=new He(this,this.#inputs),this.#inputs.red=this.#createColorInput(N.getText("ColorControl - Red"),this.#newColor.red),this.#inputs.green=this.#createColorInput(N.getText("ColorControl - Green"),this.#newColor.green),this.#inputs.blue=this.#createColorInput(N.getText("ColorControl - Blue"),this.#newColor.blue)}#createColorSampleDiv(){this.#colorSampleDiv=J.create("div",{id:"TravelNotes-ColorControl-ColorSampleDiv"},this.#colorDiv),this.#colorSampleDiv.style["background-color"]=this.#newColor.cssColor}constructor(t){this.#newColor.cssColor=t,this.#colorDiv=J.create("div",{id:"TravelNotes-ColorControl-ColorDiv"}),this.#createColorButtonsDiv(),this.#createRedSliderDiv(),this.#createColorInputsDiv(),this.#createColorSampleDiv()}destructor(){this.#colorButtons.forEach((t=>{t.removeEventListener("click",this.#eventListeners.onColorButtonClick,!1)})),this.#eventListeners.onColorButtonClick.destructor();for(const t in this.#inputs)this.#inputs[t].removeEventListener("input",this.#eventListeners.onColorInput,!1);this.#eventListeners.onColorInput.destructor(),this.#redSliderInput.removeEventListener("input",this.#eventListeners.onRedSliderInput,!1),this.#eventListeners.onRedSliderInput.destructor()}get HTMLElements(){return[this.#colorDiv]}get cssColor(){return this.#newColor.cssColor}set color(t){this.#inputs.red.value=t.red,this.#inputs.green.value=t.green,this.#inputs.blue.value=t.blue,this.#colorSampleDiv.style["background-color"]=t.cssColor,t.copyTo(this.#newColor)}}class Ve extends Rt{#route=null;#colorControl=null;#nameInput=null;#widthInput=null;#dashSelect=null;#chainInput=null;#createNameDiv(){let t=J.create("div",{textContent:N.getText("RoutePropertiesDialog - Name")}),e=J.create("div",{className:"TravelNotes-RoutePropertiesDialog-DataDiv",id:"TravelNotes-RoutePropertiesDialog-NameInputDiv"});return this.#nameInput=J.create("input",{type:"text",id:"TravelNotes-RoutePropertiesDialog-NameInput",value:this.#route.computedName},e),[t,e]}#createWidthDiv(){let t=J.create("div",{className:"TravelNotes-RoutePropertiesDialog-DataDiv"});return J.create("text",{value:N.getText("RoutePropertiesDialog - Width")},J.create("span",null,t)),this.#widthInput=J.create("input",{type:"number",id:"TravelNotes-RoutePropertiesDialog-WidthInput",value:this.#route.width,min:1,max:40},t),t}#createDashDiv(){let e=J.create("div",{className:"TravelNotes-RoutePropertiesDialog-DataDiv"});J.create("text",{value:N.getText("RoutePropertiesDialog - Linetype")},J.create("span",null,e)),this.#dashSelect=J.create("select",null,e);let o=t.route.dashChoices;for(let t=0;t<o.length;t++)this.#dashSelect.add(J.create("option",{text:o[t].text}));return this.#dashSelect.selectedIndex=this.#route.dashArray<o.length?this.#route.dashArray:0,e}#createChainDiv(){let t=J.create("div",{className:"TravelNotes-RoutePropertiesDialog-DataDiv",id:"TravelNotes-RoutePropertiesDialog-ChainDiv"});return J.create("text",{value:N.getText("RoutePropertiesDialog - Chained route")},J.create("span",null,t)),this.#chainInput=J.create("input",{type:"checkbox",checked:this.#route.chain},t),t}#createColorHeaderDiv(){return J.create("div",{textContent:N.getText("RoutePropertiesDialog - Color"),id:"TravelNotes-RoutePropertiesDialog-ColorHeaderDiv"})}constructor(t){super(),this.#route=t,this.#colorControl=new Fe(t.color)}onCancel(){this.#colorControl.destructor(),super.onCancel()}onOk(){this.#route.color=this.#colorControl.cssColor,this.#route.computedName!==this.#nameInput.value&&(this.#route.name=this.#nameInput.value),this.#route.width=parseInt(this.#widthInput.value),this.#route.chain=this.#chainInput.checked,this.#route.dashArray=this.#dashSelect.selectedIndex,this.#route.validateData(),this.#colorControl.destructor(),super.onOk()}get title(){return N.getText("RoutePropertiesDialog - Route properties")}get contentHTMLElements(){return[].concat(this.#createNameDiv(),this.#createWidthDiv(),this.#createDashDiv(),this.#createChainDiv(),this.#createColorHeaderDiv(),this.#colorControl.HTMLElements)}}class Ue extends Rt{#paperWidthInput=null;#paperHeightInput=null;#borderWidthInput=null;#pageBreakInput=null;#printNotesInput=null;#zoomFactorInput=null;#createPaperWidthDiv(){let e=J.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv"});return J.create("text",{value:N.getText("PrintRouteMapDialog - Paper width")},e),this.#paperWidthInput=J.create("input",{type:"number",className:"TravelNotes-PrintRouteMapDialog-NumberInput"},e),this.#paperWidthInput.value=t.printRouteMap.paperWidth,J.create("text",{value:N.getText("PrintRouteMapDialog - Paper width units")},e),e}#createPaperHeightDiv(){let e=J.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv"});return J.create("text",{value:N.getText("PrintRouteMapDialog - Paper height")},e),this.#paperHeightInput=J.create("input",{type:"number",className:"TravelNotes-PrintRouteMapDialog-NumberInput",value:t.printRouteMap.paperHeight},e),J.create("text",{value:N.getText("PrintRouteMapDialog - Paper height units")},e),e}#createBorderWidthDiv(){let e=J.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv"});return J.create("text",{value:N.getText("PrintRouteMapDialog - Border width")},e),this.#borderWidthInput=J.create("input",{type:"number",className:"TravelNotes-PrintRouteMapDialog-NumberInput",value:t.printRouteMap.borderWidth},e),J.create("text",{value:N.getText("PrintRouteMapDialog - Border width units")},e),e}#createZoomFactorDiv(){let e=J.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv"});return J.create("text",{value:N.getText("PrintRouteMapDialog - Zoom factor")},e),this.#zoomFactorInput=J.create("input",{type:"number",className:"TravelNotes-PrintRouteMapDialog-NumberInput",value:Math.min(t.printRouteMap.zoomFactor,15),min:V.map.getMinZoom(),max:Math.min(V.map.getMaxZoom(),15)},e),e}#createPageBreakDiv(){let e=J.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv"});return this.#pageBreakInput=J.create("input",{type:"checkbox",checked:t.printRouteMap.pageBreak},e),J.create("text",{value:N.getText("PrintRouteMapDialog - Page break")},e),e}#createPrintNotesDiv(){let e=J.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv"});return this.#printNotesInput=J.create("input",{type:"checkbox",checked:t.printRouteMap.printNotes},e),J.create("text",{value:N.getText("PrintRouteMapDialog - Print notes")},e),e}constructor(){super()}onOk(){super.onOk(Object.freeze({paperWidth:parseInt(this.#paperWidthInput.value),paperHeight:parseInt(this.#paperHeightInput.value),borderWidth:parseInt(this.#borderWidthInput.value),zoomFactor:parseInt(this.#zoomFactorInput.value),pageBreak:this.#pageBreakInput.checked,printNotes:this.#printNotesInput.checked}))}get contentHTMLElements(){return[this.#createPaperWidthDiv(),this.#createPaperHeightDiv(),this.#createBorderWidthDiv(),this.#createZoomFactorDiv(),this.#createPageBreakDiv(),this.#createPrintNotesDiv()]}get title(){return N.getText("PrintRouteMapDialog - Print")}}
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file FloatWindow.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/
class ze{#dragData=null;constructor(t){Object.seal(this),this.#dragData=t}handleEvent(t){this.#dragData.dragStartX=t.screenX,this.#dragData.dragStartY=t.screenY,t.dataTransfer.dropEffect="move",t.dataTransfer.effectAllowed="move"}}class We{#dragData=null;#containerDiv=null;constructor(t){Object.seal(this),this.#dragData=t}handleEvent(t){let e=t.target.parentNode;this.#dragData.windowX+=t.screenX-this.#dragData.dragStartX,this.#dragData.windowY+=t.screenY-this.#dragData.dragStartY,this.#dragData.windowX=Math.min(Math.max(this.#dragData.windowX,20),V.map.getContainer().clientWidth-e.clientWidth-20),this.#dragData.windowY=Math.max(this.#dragData.windowY,20);let o=V.map.getContainer().clientHeight-Math.max(this.#dragData.windowY,0)-20;e.style.top=String(this.#dragData.windowY)+"px",e.style.left=String(this.#dragData.windowX)+"px",e.style["max-height"]=String(o)+"px"}}class Ge extends ft{constructor(t,e=null){super(t,e)}doAction(t){switch(t){case 0:pe.newRouteNote({routeObjId:this.eventData.targetObjId,lat:this.eventData.lat,lng:this.eventData.lng});break;case 1:(new Y).zoomToLatLng([this.eventData.lat,this.eventData.lng])}}get menuItems(){return[{itemText:N.getText("ProfileContextMenu - Add a note to the route at this point"),isActive:!0},{itemText:N.getText("ProfileContextMenu - Zoom to this point"),isActive:!0}]}}
/**
	@------------------------------------------------------------------------------------------------------------------------------

	@file ProfileWindow.js
	@copyright Copyright - 2017 2021 - wwwouaiebe - Contact: https://www.ouaie.be/
	@license GNU General Public License
	@private

	@------------------------------------------------------------------------------------------------------------------------------
	*/class Xe{getlatLngElevOnRouteAtMousePosition(t,e){let o=Z.getRoute(Number.parseInt(e.dataset.tanObjId)),i=e.getBoundingClientRect(),n=(t.clientX-i.x-r.margin/(2*r.margin+r.width)*i.width)/(r.width/(2*r.margin+r.width)*i.width)*o.distance;return 0<n&&n<o.distance?G.getLatLngElevAtDist(o,n):null}}class Ze extends Xe{constructor(){super()}handleEvent(t){t.preventDefault(),t.stopPropagation();let e=t.target;for(;!e.dataset.tanObjId;)e=e.parentNode;let o=this.getlatLngElevOnRouteAtMousePosition(t,e);o&&(t.latlng={lat:o.latLng[0],lng:o.latLng[1]},new Ge(t).show())}}class Ye{handleEvent(t){t.preventDefault(),t.stopPropagation();let e=t.target;for(;!e.dataset.tanObjId;)e=e.parentNode;U.dispatch("removeobject",{objId:Number.parseInt(e.dataset.tanMarkerObjId)})}}class _e extends Xe{constructor(){super()}#marker=null;#distanceText=null;#elevText=null;#ascentText=null;#textAnchor=null;#markerX=null;#profileSvg=null;#createSvgText(t,e){let o=document.createElementNS(v,"text");return o.appendChild(document.createTextNode(t)),o.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-elevText"),o.setAttributeNS(null,"x",this.#markerX),o.setAttributeNS(null,"y",e),o.setAttributeNS(null,"text-anchor",this.#textAnchor),this.#profileSvg.appendChild(o),o}handleEvent(t){for(t.preventDefault(),t.stopPropagation(),this.#profileSvg=t.target;!this.#profileSvg.dataset.tanObjId;)this.#profileSvg=this.#profileSvg.parentNode;let e=this.getlatLngElevOnRouteAtMousePosition(t,this.#profileSvg);if(e){let o=Number.parseInt(this.#profileSvg.dataset.tanMarkerObjId);U.dispatch("removeobject",{objId:o}),U.dispatch("additinerarypointmarker",{objId:o,latLng:e.latLng}),this.#marker&&(this.#profileSvg.removeChild(this.#marker),this.#profileSvg.removeChild(this.#distanceText),this.#profileSvg.removeChild(this.#elevText),this.#profileSvg.removeChild(this.#ascentText));let i=this.#profileSvg.getBoundingClientRect();this.#markerX=(2*r.margin+r.width)*(t.clientX-i.x)/i.width;let n=r.margin+r.height;this.#marker=document.createElementNS(v,"polyline"),this.#marker.setAttributeNS(null,"points",String(this.#markerX)+","+r.margin+" "+this.#markerX+","+n),this.#marker.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-markerPolyline"),this.#profileSvg.appendChild(this.#marker);let s=Z.getRoute(Number.parseInt(this.#profileSvg.dataset.tanObjId));this.#textAnchor=e.routeDistance>s.distance/2?"end":"start",this.#markerX+=e.routeDistance>s.distance/2?-r.xDeltaText:r.xDeltaText,this.#distanceText=this.#createSvgText(E.formatDistance(e.routeDistance),r.margin+r.yDeltaText),this.#elevText=this.#createSvgText("Alt. "+e.elev.toFixed(0)+" m.",r.margin+2*r.yDeltaText),this.#ascentText=this.#createSvgText("Pente "+e.ascent.toFixed(0)+" % ",r.margin+3*r.yDeltaText)}}}class Je extends class{#dragData=Object.seal({dragStartX:0,dragStartY:0,windowX:0,windowY:0});#containerDiv=null;#topBar=null;#headerDiv=null;#contentDiv=null;#eventListeners={onTopBarDragStart:null,onTopBarDragEnd:null};#createContainerDiv(){this.#containerDiv=J.create("div",{className:"TravelNotes-FloatWindow-Container"},document.body)}#createTopBar(){this.#topBar=J.create("div",{className:"TravelNotes-FloatWindow-TopBar",draggable:!0},this.#containerDiv),this.#topBar.addEventListener("dragstart",this.#eventListeners.onTopBarDragStart,!1),this.#topBar.addEventListener("dragend",this.#eventListeners.onTopBarDragEnd,!1),J.create("div",{textContent:"❌",className:"TravelNotes-FloatWindow-CancelButton",title:N.getText("FloatWindow - Close")},this.#topBar).addEventListener("click",(()=>this.close()),!1)}#createHeaderDiv(){this.#headerDiv=J.create("div",{className:"TravelNotes-FloatWindow-HeaderDiv"},this.#containerDiv)}#createContentDiv(){this.#contentDiv=J.create("div",{className:"TravelNotes-FloatWindow-ContentDiv"},this.#containerDiv)}constructor(){this.#eventListeners.onTopBarDragStart=new ze(this.#dragData),this.#eventListeners.onTopBarDragEnd=new We(this.#dragData),this.#createContainerDiv(),this.#createTopBar(),this.#createHeaderDiv(),this.#createContentDiv(),Object.seal(this)}close(){this.#topBar.removeEventListener("dragstart",this.#eventListeners.onTopBarDragStart,!1),this.#topBar.removeEventListener("dragend",this.#eventListeners.onTopBarDragEnd,!1),this.#eventListeners.onTopBarDragStart=null,this.#eventListeners.onTopBarDragEnd=null,document.body.removeChild(this.#containerDiv)}update(){}get header(){return this.#headerDiv}get content(){return this.#contentDiv}}{#svg=null;#ascentDiv=null;#route=null;#eventListeners={onSvgContextMenu:null,onSvgMouseMove:null,onSvgMouseLeave:null};#markerObjId=D.nextObjId;#clean(){this.#svg&&(this.#svg.removeEventListener("contextmenu",this.#eventListeners.onSvgContextMenu,!1),this.#svg.removeEventListener("mousemove",this.#eventListeners.onSvgMouseMove,!1),this.#svg.removeEventListener("mouseleave",this.#eventListeners.onSvgMouseLeave,!1),U.dispatch("removeobject",{objId:this.#markerObjId}),this.content.removeChild(this.#ascentDiv),this.content.removeChild(this.#svg)),this.#svg=null,this.#ascentDiv=null}constructor(){super(),this.#eventListeners.onSvgContextMenu=new Ze,this.#eventListeners.onSvgMouseMove=new _e,this.#eventListeners.onSvgMouseLeave=new Ye}close(){this.#clean(),U.dispatch("profileclosed",{objId:this.#route.objId}),super.close()}update(t){this.#clean(),this.#route=t,this.#svg=(new ct).createSvg(this.#route),this.#svg.dataset.tanObjId=t.objId,this.#svg.dataset.tanMarkerObjId=this.#markerObjId,this.header.textContent=N.getText("ProfileWindow - Profile {name}",{name:this.#route.computedName}),this.content.appendChild(this.#svg),this.#svg.addEventListener("contextmenu",this.#eventListeners.onSvgContextMenu,!1),this.#svg.addEventListener("mousemove",this.#eventListeners.onSvgMouseMove,!1),this.#svg.addEventListener("mouseleave",this.#eventListeners.onSvgMouseLeave,!1),this.#ascentDiv=J.create("div",{className:"TravelNotes-ProfileWindow-Ascent",textContent:N.getText("ProfileWindow - Ascent: {ascent} m. - Descent: {descent} m. - Distance: {distance}",{ascent:this.#route.itinerary.ascent.toFixed(0),descent:this.#route.itinerary.descent.toFixed(0),distance:E.formatDistance(this.#route.distance)})}),this.content.appendChild(this.#ascentDiv)}}const qe=new class{#profileWindows=new Map;constructor(){Object.freeze(this)}createProfile(e){let o=this.#profileWindows.get(e.objId);if(e.itinerary.hasProfile){t.route.elev.smooth&&(new ct).smooth(e),e.itinerary.ascent=0,e.itinerary.descent=0;let i=e.itinerary.itineraryPoints.first.elev;e.itinerary.itineraryPoints.forEach((t=>{let o=t.elev-i;0>o?e.itinerary.descent-=o:e.itinerary.ascent+=o,i=t.elev})),o&&o.update(e)}else o&&o.close()}updateProfile(t,e){let o=this.#profileWindows.get(t);o&&(this.#profileWindows.delete(t),e&&e.itinerary.hasProfile?(o.update(e),this.#profileWindows.set(e.objId,o)):o.close())}deleteProfile(t){let e=this.#profileWindows.get(t);e&&e.close()}deleteAllProfiles(){this.#profileWindows.forEach((t=>t.close()))}showProfile(t){let e=this.#profileWindows.get(t);e||(e=new Je);let o=Z.getRoute(t);e.update(o),this.#profileWindows.set(t,e)}onProfileClosed(t){this.#profileWindows.delete(t)}},Qe=1e-6;class $e{#views=[];#route=null;#printSize=null;#isItineraryHorOrVer(t,e,o){return e.lng===o.lng?{lat:e.lat>o.lat?t.bottomLeft.lat:t.upperRight.lat,lng:e.lng}:e.lat===o.lat?{lat:e.lat,lng:e.lng<o.lng?t.upperRight.lng:t.bottomLeft.lng}:null}#isFirstPointOnView(t,e){return e.lat-t.bottomLeft.lat<Qe||t.upperRight.lat-e.lat<Qe||e.lng-t.bottomLeft.lng<Qe||t.upperRight.lng-e.lng<Qe?{lat:e.lat,lng:e.lng}:null}#haveViewOnlyOnePoint(t,e,o){if(t.bottomLeft.lat===t.upperRight.lat&&t.bottomLeft.lng===t.upperRight.lng){let t=Math.min(Math.abs(this.#printSize[0]/(o.lat-e.lat)),Math.abs(this.#printSize[1]/(o.lng-e.lng)));return{lat:e.lat+t*(o.lat-e.lat),lng:e.lng+t*(o.lng-e.lng)}}return null}#computeIntermediatePoint(t,e,o){let i=this.#haveViewOnlyOnePoint(t,e,o);if(i)return i;if(i=this.#isFirstPointOnView(t,e),i)return i;if(i=this.#isItineraryHorOrVer(t,e,o),i)return i;let n=(e.lat-o.lat)/(e.lng-o.lng),s=e.lat-n*e.lng;if(i={lat:n*t.upperRight.lng+s,lng:t.upperRight.lng},i.lat<=t.upperRight.lat&&i.lat>=t.bottomLeft.lat&&i.lng<o.lng)return i;if(i={lat:t.upperRight.lat,lng:(t.upperRight.lat-s)/n},i.lng>=t.bottomLeft.lng&&i.lng<=t.upperRight.lng&&i.lat<o.lat)return i;if(i={lat:n*t.bottomLeft.lng+s,lng:t.bottomLeft.lng},i.lat<=t.upperRight.lat&&i.lat>=t.bottomLeft.lat&&i.lng>o.lng)return i;if(i={lat:t.bottomLeft.lat,lng:(t.bottomLeft.lat-s)/n},i.lng>=t.bottomLeft.lng&&i.lng<=t.upperRight.lng&&i.lat>o.lat)return i;throw new Error("intermediate point not found")}#computeViews(){this.#views=[];let t=this.#route.itinerary.itineraryPoints.iterator,e=t.done,o={bottomLeft:{lat:t.value.lat,lng:t.value.lng},upperRight:{lat:t.value.lat,lng:t.value.lng}},i={lat:t.value.lat,lng:t.value.lng},n=t.value;e=t.done;let s=t.value;for(;!e;){let a={bottomLeft:{lat:Math.min(o.bottomLeft.lat,s.lat),lng:Math.min(o.bottomLeft.lng,s.lng)},upperRight:{lat:Math.max(o.upperRight.lat,s.lat),lng:Math.max(o.upperRight.lng,s.lng)}},r=[a.upperRight.lat-a.bottomLeft.lat,a.upperRight.lng-a.bottomLeft.lng];this.#printSize[0]>r[0]&&this.#printSize[1]>r[1]?(o=a,n=t.value,e=t.done,s=t.value,e&&(o.entryPoint=i,o.exitPoint=n,this.#views.push(o))):(n=this.#computeIntermediatePoint(o,n,s),o.bottomLeft={lat:Math.min(o.bottomLeft.lat,n.lat),lng:Math.min(o.bottomLeft.lng,n.lng)},o.upperRight={lat:Math.max(o.upperRight.lat,n.lat),lng:Math.max(o.upperRight.lng,n.lng)},o.entryPoint=i,o.exitPoint=n,this.#views.push(o),o={bottomLeft:{lat:n.lat,lng:n.lng},upperRight:{lat:n.lat,lng:n.lng}},i={lat:n.lat,lng:n.lng})}}constructor(t,e){this.#route=t,this.#printSize=e,this.#computeViews()}get views(){return this.#views}}class to{#name=null;#service=null;#url=null;#wmsOptions=null;#bounds=null;#minZoom=null;#maxZoom=null;#toolbar=null;#providerName=null;#providerKeyNeeded=!1;#attribution=null;#getCapabilitiesUrl=null;constructor(t){if(!t.name||"string"!=typeof t.name)throw new Error("invalid name for layer");if(this.#name=b.sanitizeToJsString(t.name),!t.service||"wms"!==t.service&&"wmts"!==t.service)throw new Error("invalid service for layer "+this.#name);if(this.#service=t.service,!t.url||"string"!=typeof t.url)throw new Error("invalid url for layer "+this.#name);if(this.#url=t.url,"wms"===this.#service){if(!(t.wmsOptions&&t.wmsOptions.layers&&"string"==typeof t.wmsOptions.layers&&t.wmsOptions.format&&"string"==typeof t.wmsOptions.format&&t.wmsOptions.transparent&&"boolean"==typeof t.wmsOptions.transparent))throw new Error("invalid wmsOptions for layer "+this.#name);this.#wmsOptions=t.wmsOptions,this.#wmsOptions.layers=b.sanitizeToJsString(this.#wmsOptions.layers),this.#wmsOptions.format=b.sanitizeToJsString(this.#wmsOptions.format)}try{t.bounds&&"number"==typeof t.bounds[0][0]&&"number"==typeof t.bounds[0][1]&&"number"==typeof t.bounds[1][0]&&"number"==typeof t.bounds[1][1]&&(this.#bounds=t.bounds)}catch(t){throw new Error("invalid bounds for layer "+this.#name)}if(t.minZoom&&"number"==typeof t.minZoom&&(this.#minZoom=t.minZoom),t.maxZoom&&"number"==typeof t.maxZoom&&(this.#maxZoom=t.maxZoom),!(t.toolbar&&t.toolbar.text&&"string"==typeof t.toolbar.text&&t.toolbar.color&&"string"==typeof t.toolbar.color&&t.toolbar.backgroundColor&&"string"==typeof t.toolbar.backgroundColor))throw new Error("invalid toolbar for layer "+this.#name);if(this.#toolbar=t.toolbar,this.#toolbar.text=b.sanitizeToJsString(this.#toolbar.text),this.#toolbar.color=b.sanitizeToColor(this.#toolbar.color)||"#000000",this.#toolbar.backgroundColor=b.sanitizeToColor(this.#toolbar.backgroundColor)||"#ffffff",!t.providerName||"string"!=typeof t.providerName)throw new Error("invalid providerName for layer "+this.#name);if(this.#providerName=b.sanitizeToJsString(t.providerName),"boolean"!=typeof t.providerKeyNeeded)throw new Error("invalid providerKeyNeeded for layer "+this.#name);if(this.#providerKeyNeeded=t.providerKeyNeeded,""===t.attribution)this.#attribution="";else{if(!t.attribution||"string"!=typeof t.attribution)throw new Error("invalid attribution for map layer "+this.#name);this.#attribution=b.sanitizeToHtmlString(t.attribution).htmlString}if(t.getCapabilitiesUrl&&"string"==typeof t.getCapabilitiesUrl&&(this.#getCapabilitiesUrl=b.sanitizeToUrl(t.getCapabilitiesUrl).url,""===this.#getCapabilitiesUrl))throw new Error("invalid getCapabilitiesUrl for map layer "+this.#name);Object.freeze(this)}get name(){return this.#name}get service(){return this.#service}get url(){return this.#url}get wmsOptions(){return this.#wmsOptions}get bounds(){return this.#bounds}get minZoom(){return this.#minZoom}get maxZoom(){return this.#maxZoom}get toolbar(){return this.#toolbar}get providerName(){return this.#providerName}get providerKeyNeeded(){return this.#providerKeyNeeded}get attribution(){return this.#attribution}get getCapabilitiesUrl(){return this.#getCapabilitiesUrl}}const eo=new class{#mapLayers=new Map;#defaultMapLayer=null;#mapLayersAdded=!1;constructor(){this.#defaultMapLayer=new to({service:"wmts",url:"https://{s}.tile.osm.org/{z}/{x}/{y}.png",name:"OSM - Color",toolbar:{text:"OSM",color:"#ff0000",backgroundColor:"#ffffff"},providerName:"OSM",providerKeyNeeded:!1,attribution:""}),this.#mapLayers.set(this.#defaultMapLayer.name,this.#defaultMapLayer),Object.freeze(this)}getMapLayer(t){let e=this.#mapLayers.get(t)||this.#defaultMapLayer;return e.providerKeyNeeded&&(Se.hasKey(e.providerName.toLowerCase())||(e=this.#defaultMapLayer)),e}forEach(t){this.#mapLayers.forEach(t)}addMapLayers(t){this.#mapLayersAdded||(t.forEach((t=>{let e=new to(t);this.#mapLayers.get(e.name)||this.#mapLayers.set(e.name,e)})),this.#mapLayersAdded=!0)}get defaultMapLayer(){return this.#defaultMapLayer}};class oo{handleEvent(){window.print()}}class io{#printPageBuilder=null;constructor(t){this.#printPageBuilder=t}handleEvent(){this.#printPageBuilder.onAfterPrint(),this.#printPageBuilder=null}}class no{#printData=null;#route=null;#views=[];#printToolbar=null;#printButton=null;#cancelButton=null;#viewsCounter=0;#viewsDiv=[];#routePolyline=null;#eventsListeners={onPrint:null,onAfterPrint:null};onAfterPrint(){this.#viewsDiv.forEach((t=>document.body.removeChild(t))),this.#viewsDiv.length=0,this.#printButton.removeEventListener("click",this.#eventsListeners.onPrint,!1),this.#cancelButton.removeEventListener("click",this.#eventsListeners.onAfterPrint,!1),document.body.removeChild(this.#printToolbar);let t=document.body.children;for(let e=0;e<t.length;e++)t.item(e).classList.remove("TravelNotes-Hidden");V.map.invalidateSize(!1),document.title="Travel & Notes"+(""===V.travel.name?"":" - "+V.travel.name),window.removeEventListener("afterprint",this.#eventsListeners.onAfterPrint,!0),this.#eventsListeners.onAfterPrint=null,this.#eventsListeners.onPrint=null}#getMapLayer(){let t=eo.getMapLayer(V.travel.layerName),e=Se.getUrl(t),o=null;return o="wmts"===t.service.toLowerCase()?window.L.tileLayer(e):window.L.tileLayer.wms(e,t.wmsOptions),o.options.attribution=b.sanitizeToHtmlString(' © <a href="https://www.openstreetmap.org/copyright" target="_blank" title="OpenStreetMap contributors">OpenStreetMap contributors</a> '+t.attribution+'| © <a href="https://github.com/wwwouaiebe" target="_blank" title="https://github.com/wwwouaiebe">Travel & Notes</a> ').htmlString,o}#getNotesMarkers(){let t=[];return this.#route.notes.forEach((e=>{let o=window.L.divIcon({iconSize:[e.iconWidth,e.iconHeight],iconAnchor:[e.iconWidth/2,e.iconHeight/2],popupAnchor:[0,-e.iconHeight/2],html:e.iconContent,className:"TravelNotes-Map-AllNotes "}),i=window.L.marker(e.iconLatLng,{zIndexOffset:100,icon:o,draggable:!0});t.push(i)})),t}#createViewOnPage(e){this.#viewsCounter++;let o="TravelNotes-RouteViewDiv"+this.#viewsCounter,i=document.createElement("div");i.className="TravelNotes-routeViewDiv",i.id=o,document.body.appendChild(i),this.#viewsDiv.push(i),this.#printData.pageBreak&&i.classList.add("TravelNotes-PrintPageBreak"),i.style.width=String(this.#printData.paperWidth)+"mm",i.style.height=String(this.#printData.paperHeight)+"mm";let n=this.#printData.printNotes?this.#getNotesMarkers():[];n.push(this.#getMapLayer()),n.push(window.L.circleMarker([e.entryPoint.lat,e.entryPoint.lng],t.printRouteMap.entryPointMarker)),n.push(window.L.circleMarker([e.exitPoint.lat,e.exitPoint.lng],t.printRouteMap.exitPointMarker)),n.push(this.#routePolyline),window.L.map(o,{attributionControl:!0,zoomControl:!1,center:[(e.bottomLeft.lat+e.upperRight.lat)/2,(e.bottomLeft.lng+e.upperRight.lng)/2],zoom:this.#printData.zoomFactor,minZoom:this.#printData.zoomFactor,maxZoom:this.#printData.zoomFactor,layers:n})}#createToolbar(){this.#printToolbar=J.create("div",{id:"TravelNotes-PrintToolbar"},document.body),this.#printButton=J.create("div",{className:"TravelNotes-UI-Button",title:N.getText("PrintPageBuilder - Print"),textContent:"🖨️"},this.#printToolbar),this.#printButton.addEventListener("click",this.#eventsListeners.onPrint,!1),this.#cancelButton=J.create("div",{className:"TravelNotes-UI-Button",title:N.getText("PrintPageBuilder - Cancel print"),textContent:"❌"},this.#printToolbar),this.#cancelButton.addEventListener("click",this.#eventsListeners.onAfterPrint,!1)}preparePage(){let t=document.body.children;for(let e=0;e<t.length;e++)t.item(e).classList.add("TravelNotes-Hidden");document.title=""===V.travel.name?"maps":V.travel.name+" - "+this.#route.computedName+" - maps",this.#createToolbar(),window.addEventListener("afterprint",this.#eventsListeners.onAfterPrint,!0);let e=[],o=this.#route.itinerary.itineraryPoints.iterator;for(;!o.done;)e.push(o.value.latLng);this.#routePolyline=window.L.polyline(e,{color:this.#route.color,weight:this.#route.width}),this.#viewsCounter=0,this.#views.forEach((t=>this.#createViewOnPage(t)))}constructor(t,e,o){this.#route=t,this.#views=e,this.#printData=o,this.#eventsListeners.onPrint=new oo,this.#eventsListeners.onAfterPrint=new io(this),Object.seal(this)}}class so{#tilesPerPage=0;#computeViewSize(t){let e=J.create("div",{},document.body);e.style.position="absolute",e.style.top="0",e.style.left="0",e.style.width=String(t.paperWidth-2*t.borderWidth)+"mm",e.style.height=String(t.paperHeight-2*t.borderWidth)+"mm",this.#tilesPerPage=Math.ceil(e.clientWidth/256)*Math.ceil(e.clientHeight/256);let o=G.screenCoordToLatLng(0,0),i=G.screenCoordToLatLng(e.clientWidth,e.clientHeight);document.body.removeChild(e);let n=V.map.getZoomScale(V.map.getZoom(),t.zoomFactor);return[Math.abs(o[0]-i[0])*n,Math.abs(o[1]-i[1])*n]}constructor(){Object.freeze(this)}print(e,o){let i=Z.getRoute(o);if(!i)return;let n=new $e(i,this.#computeViewSize(e));t.printRouteMap.maxTiles<n.views.length*this.#tilesPerPage?ue.showError(N.getText("RoutePrinter - The maximum of allowed pages is reached.")):new no(i,n.views,e).preparePage()}}const ao=new class{constructor(){Object.freeze(this)}addRoute(){let t=new H;V.travel.routes.add(t),a.editedChanged===V.travel.editedRoute.editionStatus?(this.chainRoutes(),U.dispatch("setrouteslist"),U.dispatch("roadbookupdate")):this.editRoute(t.objId)}editRoute(t){if(a.editedChanged===V.travel.editedRoute.editionStatus)return void ue.showError(N.getText("RouteEditor - Not possible to edit a route without a save or cancel"));let e=Z.getRoute(t),o=e.itinerary.provider,i=V.providers.get(o.toLowerCase());if(o&&""!==o&&(!i||i.providerKeyNeeded&&!Se.hasKey(o)))return void ue.showError(N.getText("RouteEditor - Not possible to edit a route created with this provider",{provider:o}));c!==V.editedRouteObjId&&this.cancelEdition(),o&&""!==o&&U.dispatch("setprovider",{provider:o});let n=e.itinerary.transitMode;n&&""!==n&&U.dispatch("settransitmode",{transitMode:n}),V.travel.editedRoute=new H,e.editionStatus=a.editedNoChange,V.travel.editedRoute.jsonObject=e.jsonObject,V.editedRouteObjId=e.objId,V.travel.editedRoute.hidden=!1,e.hidden=!1,qe.updateProfile(V.editedRouteObjId,V.travel.editedRoute),this.chainRoutes(),U.dispatch("routeupdated",{removedRouteObjId:e.objId,addedRouteObjId:V.travel.editedRoute.objId}),U.dispatch("roadbookupdate"),U.dispatch("showitinerary"),U.dispatch("setrouteslist")}removeRoute(t){let e=t;if(e===V.editedRouteObjId||e===V.travel.editedRoute.objId){if(a.editedChanged===V.travel.editedRoute.editionStatus)return void ue.showError(N.getText("TravelEditor - Cannot remove an edited route"));e=V.editedRouteObjId,this.cancelEdition()}U.dispatch("routeupdated",{removedRouteObjId:e,addedRouteObjId:c}),V.travel.routes.remove(e),qe.deleteProfile(e),this.chainRoutes(),U.dispatch("roadbookupdate"),U.dispatch("setrouteslist")}saveGpx(t){(new Re).routeToGpx(t)}chainRoutes(){let t=V.travel.routes.iterator,e=o.defaultValue;for(;!t.done;){t.value.chain?(t.value.chainedDistance=e,e+=t.value.distance):t.value.chainedDistance=o.defaultValue;let i=t.value.notes.iterator;for(;!i.done;)i.value.chainedDistance=t.value.chainedDistance}}saveEdition(){let t=new H;t.jsonObject=V.travel.editedRoute.jsonObject,V.travel.routes.replace(V.editedRouteObjId,t),V.editedRouteObjId=t.objId,this.cancelEdition()}cancelEdition(){let t=Z.getRoute(V.editedRouteObjId);t.editionStatus=a.notEdited,qe.updateProfile(V.travel.editedRoute.objId,t),U.dispatch("routeupdated",{removedRouteObjId:V.travel.editedRoute.objId,addedRouteObjId:V.editedRouteObjId}),V.editedRouteObjId=c,V.travel.editedRoute=new H,this.chainRoutes(),U.dispatch("roadbookupdate"),U.dispatch("setrouteslist"),U.dispatch("showitinerary")}routeProperties(t){let e=Z.getRoute(t);new Ve(e).show().then((()=>{this.chainRoutes(),e.haveValidWayPoints()&&U.dispatch("routepropertiesupdated",{routeObjId:e.objId}),U.dispatch("roadbookupdate"),U.dispatch("setrouteslist"),U.dispatch("updateitinerary")})).catch((t=>{t instanceof Error&&console.error(t)}))}printRouteMap(t){(new Ue).show().then((e=>(new so).print(e,t))).catch((t=>{t instanceof Error&&console.error(t)}))}showRoute(t){Z.getRoute(t).hidden=!1,U.dispatch("routeupdated",{removedRouteObjId:c,addedRouteObjId:t}),U.dispatch("setrouteslist")}hideRoute(t){Z.getRoute(t).hidden=!0,U.dispatch("routeupdated",{removedRouteObjId:t,addedRouteObjId:c}),U.dispatch("setrouteslist")}showRoutes(){let t=V.travel.routes.iterator;for(;!t.done;)t.value.hidden&&(t.value.hidden=!1,U.dispatch("routeupdated",{removedRouteObjId:c,addedRouteObjId:t.value.objId}));U.dispatch("setrouteslist")}hideRoutes(){let t=V.travel.routes.iterator;for(;!t.done;)t.value.hidden||t.value.objId===V.editedRouteObjId||(t.value.hidden=!0,U.dispatch("routeupdated",{removedRouteObjId:t.value.objId,addedRouteObjId:c}));U.dispatch("setrouteslist")}};class ro extends Rt{#wayPoint=null;#addressInput=null;#resetAddressButton=null;#nameInput=null;async handleEvent(e){if(e.stopPropagation(),!t.wayPoint.reverseGeocoding)return;this.showWait();let o=new Jt,i=await o.getAddressAsync(this.#wayPoint.latLng);if(this.hideWait(),i.statusOk){t.wayPoint.geocodingIncludeName&&(this.#nameInput.value=i.name);let e=i.street;""!==i.city&&(e+=" "+i.city),this.#addressInput.value=e}}#createAddressControl(){let t=J.create("div");this.#resetAddressButton=J.create("div",{className:"TravelNotes-BaseDialog-Button",title:N.getText("WayPointPropertiesDialog - Reset address"),textContent:"🔄"},t),this.#resetAddressButton.addEventListener("click",this,!1),J.create("text",{value:N.getText("WayPointPropertiesDialog - Address")},t);let e=J.create("div");return this.#addressInput=J.create("input",{type:"text",value:this.#wayPoint.address,className:"TravelNotes-WayPointPropertiesDialog-Input"},e),[t,e]}#createNameControl(){let t=J.create("div",{textContent:N.getText("WayPointPropertiesDialog - Name")}),e=J.create("div");return this.#nameInput=J.create("input",{type:"text",value:this.#wayPoint.name,className:"TravelNotes-WayPointPropertiesDialog-Input"},e),[t,e]}constructor(t){super(),this.#wayPoint=t}onCancel(){this.#resetAddressButton.removeEventListener("click",this,!1),super.onCancel()}onOk(){this.#wayPoint.address=this.#addressInput.value,this.#wayPoint.name=this.#nameInput.value,this.#resetAddressButton.removeEventListener("click",this,!1),super.onOk()}get contentHTMLElements(){return[].concat(this.#createNameControl(),this.#createAddressControl())}get title(){return N.getText("WayPointPropertiesDialog - Waypoint properties")}}const lo=new class{#routingRequestStarted=!1;#zoomToRouteAfterRouting=!1;#computeRouteDistances(t){let e=t.itinerary.itineraryPoints.iterator,i=t.itinerary.maneuvers.iterator;for(e.done,i.done,i.value.distance=o.defaultValue,i.done,t.distance=o.defaultValue,t.duration=o.defaultValue;!e.done;)e.previous.distance=X.pointsDistance(e.previous.latLng,e.value.latLng),t.distance+=e.previous.distance,i.previous.distance+=e.previous.distance,i.value.itineraryPointObjId===e.value.objId&&(t.duration+=i.previous.duration,i.value.distance=o.defaultValue,i.next&&i.value.itineraryPointObjId===i.next.itineraryPointObjId&&(i.done,i.value.distance=o.defaultValue),i.done)}#onRoutingError(t){this.#routingRequestStarted=!1,ue.showError(t),t instanceof Error&&console.error(t)}#onRoutingOk(){this.#routingRequestStarted=!1,V.travel.editedRoute.itinerary.validateData();let t=V.travel.editedRoute.itinerary.maneuvers.iterator;for(;!t.done;)t.value.validateData();let e=V.travel.editedRoute.itinerary.itineraryPoints.iterator;for(;!e.done;)e.value.validateData();if(this.#computeRouteDistances(V.travel.editedRoute),"circle"!==V.travel.editedRoute.itinerary.transitMode){let t=V.travel.editedRoute.wayPoints.iterator;for(;!t.done;)t.first?t.value.latLng=V.travel.editedRoute.itinerary.itineraryPoints.first.latLng:t.last?t.value.latLng=V.travel.editedRoute.itinerary.itineraryPoints.last.latLng:t.value.latLng=G.getClosestLatLngDistance(V.travel.editedRoute,t.value.latLng).latLng}let o=V.travel.editedRoute.notes.iterator;for(;!o.done;){let t=G.getClosestLatLngDistance(V.travel.editedRoute,o.value.latLng);o.value.latLng=t.latLng,o.value.distance=t.distance}ao.chainRoutes(),V.travel.editedRoute.notes.sort(((t,e)=>t.distance-e.distance)),this.#zoomToRouteAfterRouting&&(new Y).zoomToRoute(V.travel.editedRoute.objId),qe.createProfile(V.travel.editedRoute),U.dispatch("routeupdated",{removedRouteObjId:V.travel.editedRoute.objId,addedRouteObjId:V.travel.editedRoute.objId}),U.dispatch("roadbookupdate"),U.dispatch("showitinerary"),U.dispatch("setrouteslist")}startRouting(){if(!this.#routingRequestStarted&&V.travel.editedRoute.haveValidWayPoints()){this.#zoomToRouteAfterRouting=0===V.travel.editedRoute.itinerary.itineraryPoints.length,this.#routingRequestStarted=!0;let t=V.providers.get(V.routing.provider.toLowerCase());V.travel.editedRoute.itinerary.provider=t.name,V.travel.editedRoute.itinerary.transitMode=V.routing.transitMode,t.getPromiseRoute(V.travel.editedRoute,null).then((()=>this.#onRoutingOk())).catch((()=>this.#onRoutingError()))}}};new class{#renameWayPoint(t,e){let o=V.travel.editedRoute.wayPoints.getAt(e);o?(V.travel.editedRoute.editionStatus=a.editedChanged,o.name=t.name,o.address=t.address,U.dispatch("setrouteslist"),U.dispatch("showitinerary"),U.dispatch("roadbookupdate")):console.error("waypoint not found")}async#renameWayPointWithGeocoder(e,o){if(!t.wayPoint.reverseGeocoding)return U.dispatch("setrouteslist"),U.dispatch("showitinerary"),void U.dispatch("roadbookupdate");let i=await(new Jt).getAddressAsync(e);if(i.statusOk){let e=i.street;""!==i.city&&(e+=" "+i.city);let n="";t.wayPoint.geocodingIncludeName&&(n=i.name),this.#renameWayPoint(Object.seal({name:n,address:e}),o)}}constructor(){Object.freeze(this)}addWayPoint(t){V.travel.editedRoute.editionStatus=a.editedChanged;let e=new C;e.latLng=t,V.travel.editedRoute.wayPoints.add(e),this.#renameWayPointWithGeocoder(t,e.objId),U.dispatch("addwaypoint",{wayPoint:V.travel.editedRoute.wayPoints.last,letter:V.travel.editedRoute.wayPoints.length-2}),V.travel.editedRoute.wayPoints.swap(e.objId,!0),lo.startRouting()}addWayPointOnRoute(t,e){let o=G.getClosestLatLngDistance(V.travel.editedRoute,t).distance;V.travel.editedRoute.editionStatus=a.editedChanged;let i=new C;i.latLng=e;let n="",s=V.travel.editedRoute.wayPoints.iterator;for(;!s.done;){if(o<G.getClosestLatLngDistance(V.travel.editedRoute,s.value.latLng).distance){n=String(s.index),V.travel.editedRoute.wayPoints.add(i),V.travel.editedRoute.wayPoints.moveTo(i.objId,s.value.objId,!0),this.#renameWayPointWithGeocoder(e,i.objId),U.dispatch("addwaypoint",{wayPoint:i,letter:n}),lo.startRouting();break}}}reverseWayPoints(){V.travel.editedRoute.editionStatus=a.editedChanged;let t=V.travel.editedRoute.wayPoints.iterator;for(;!t.done;)U.dispatch("removeobject",{objId:t.value.objId});for(V.travel.editedRoute.wayPoints.reverse(),t=V.travel.editedRoute.wayPoints.iterator;!t.done;)U.dispatch("addwaypoint",{wayPoint:t.value,letter:t.first?"A":t.last?"B":t.index});U.dispatch("setrouteslist"),U.dispatch("showitinerary"),U.dispatch("roadbookupdate"),lo.startRouting()}removeWayPoint(t){V.travel.editedRoute.editionStatus=a.editedChanged,U.dispatch("removeobject",{objId:t}),V.travel.editedRoute.wayPoints.remove(t),lo.startRouting()}setStartPoint(t){V.travel.editedRoute.editionStatus=a.editedChanged,s.defaultValue!==V.travel.editedRoute.wayPoints.first.lat&&U.dispatch("removeobject",{objId:V.travel.editedRoute.wayPoints.first.objId}),V.travel.editedRoute.wayPoints.first.latLng=t,this.#renameWayPointWithGeocoder(t,V.travel.editedRoute.wayPoints.first.objId),U.dispatch("addwaypoint",{wayPoint:V.travel.editedRoute.wayPoints.first,letter:"A"}),lo.startRouting()}setEndPoint(t){V.travel.editedRoute.editionStatus=a.editedChanged,s.defaultValue!==V.travel.editedRoute.wayPoints.last.lat&&U.dispatch("removeobject",{objId:V.travel.editedRoute.wayPoints.last.objId}),V.travel.editedRoute.wayPoints.last.latLng=t,this.#renameWayPointWithGeocoder(t,V.travel.editedRoute.wayPoints.last.objId),U.dispatch("addwaypoint",{wayPoint:V.travel.editedRoute.wayPoints.last,letter:"B"}),lo.startRouting()}wayPointDragEnd(t){V.travel.editedRoute.editionStatus=a.editedChanged,this.#renameWayPointWithGeocoder(V.travel.editedRoute.wayPoints.getAt(t).latLng,t),lo.startRouting()}wayPointProperties(t){let e=V.travel.editedRoute.wayPoints.getAt(t);new ro(e).show().then((()=>{U.dispatch("setrouteslist"),U.dispatch("showitinerary"),U.dispatch("roadbookupdate")})).catch((t=>{t instanceof Error&&console.error(t)}))}};class ho{static handleEvent(t){let e=Z.getRoute(t.target.objId),o=G.getClosestLatLngDistance(e,[t.latlng.lat,t.latlng.lng]).distance;o+=e.chainedDistance,o=E.formatDistance(o);let i=V.mapObjects.get(t.target.objId);i.closeTooltip();let n=e.computedName;V.travel.readOnly||(n+=0===n.length?"":" - ",n+=o),i.setTooltipContent(n),i.openTooltip(t.latlng)}}class co{#currentLayer=null;#geolocationCircle=null;#getDashArray(e){e.dashArray>=t.route.dashChoices.length&&(e.dashArray=0);let o=t.route.dashChoices[e.dashArray].iDashArray;if(o){let t="",i=0;for(i=0;i<o.length-1;i++)t+=o[i]*e.width+",";return t+=o[i]*e.width,t}return null}#addNote(e){let o=Z.getNoteAndRoute(e).note,i=window.L.marker(o.latLng,{icon:window.L.divIcon({iconSize:[t.note.grip.size,t.note.grip.size],iconAnchor:[t.note.grip.size/2,t.note.grip.size/2],html:"<div></div>",className:"TravelNotes-Map-Note-Bullet"}),opacity:t.note.grip.opacity,draggable:!V.travel.readOnly});i.objId=o.objId;let n=window.L.divIcon({iconSize:[o.iconWidth,o.iconHeight],iconAnchor:[o.iconWidth/2,o.iconHeight/2],popupAnchor:[0,-o.iconHeight/2],html:o.iconContent,className:"TravelNotes-Map-AllNotes "}),s=window.L.marker(o.iconLatLng,{zIndexOffset:100,icon:n,draggable:!V.travel.readOnly});s.objId=o.objId,s.bindPopup((t=>ut.getNoteTextHTML("TravelNotes-Map-",Z.getNoteAndRoute(t.objId)))),0!==o.tooltipContent.length&&(s.bindTooltip((t=>Z.getNoteAndRoute(t.objId).note.tooltipContent)),s.getTooltip().options.offset[0]=o.iconWidth/2);let a=window.L.polyline([o.latLng,o.iconLatLng],t.note.polyline);a.objId=o.objId;let r=window.L.layerGroup([s,a,i]);return r.markerId=window.L.Util.stamp(s),r.polylineId=window.L.Util.stamp(a),r.bulletId=window.L.Util.stamp(i),this.addToMap(o.objId,r),t.note.haveBackground&&document.querySelectorAll(".TravelNotes-MapNote,.TravelNotes-SvgIcon").forEach((t=>t.classList.add("TravelNotes-Map-Note-Background"))),Object.freeze({marker:s,polyline:a,bullet:i})}constructor(){Object.freeze(this)}addToMap(t,e){e.objId=t,e.addTo(V.map),V.mapObjects.set(t,e)}addRoute(t){let e=Z.getRoute(t),o=[],i=e.itinerary.itineraryPoints.iterator;for(;!i.done;)o.push(i.value.latLng);let n=window.L.polyline(o,{color:e.color,weight:e.width,dashArray:this.#getDashArray(e)});this.addToMap(e.objId,n),a.notEdited===e.editionStatus&&(n.bindTooltip(e.computedName,{sticky:!0,direction:"right"}),window.L.DomEvent.on(n,"mouseover",ho.handleEvent),window.L.DomEvent.on(n,"mousemove",ho.handleEvent)),n.bindPopup((t=>{let e=Z.getRoute(t.objId);return pt.getRouteHeaderHTML("TravelNotes-Map-",e)})),window.L.DomEvent.on(n,"click",(t=>t.target.openPopup(t.latlng)));let s=e.notes.iterator;for(;!s.done;)this.#addNote(s.value.objId);return e}addNote(t){return this.#addNote(t)}getDashArray(t){return this.#getDashArray(t)}zoomTo(e,o){if(o){let t=[];o.forEach((e=>t=t.concat(e))),V.map.fitBounds(G.getLatLngBounds(t))}else V.map.setView(e,t.itineraryPoint.zoomFactor)}setLayer(t,e){let o=null;o="wmts"===t.service.toLowerCase()?window.L.tileLayer(e):window.L.tileLayer.wms(e,t.wmsOptions),this.#currentLayer&&V.map.removeLayer(this.#currentLayer),V.map.addLayer(o),this.#currentLayer=o,V.travel.readOnly||(V.map.getZoom()<(t.minZoom||0)&&V.map.setZoom(t.minZoom||0),V.map.setMinZoom(t.minZoom||0),V.map.getZoom()>(t.maxZoom||18)&&V.map.setZoom(t.maxZoom||18),V.map.setMaxZoom(t.maxZoom||18),t.bounds?(V.map.getBounds().intersects(t.bounds)&&!V.map.getBounds().contains(t.bounds)||(V.map.setMaxBounds(null),V.map.fitBounds(t.bounds),V.map.setZoom(t.minZoom||0)),V.map.setMaxBounds(t.bounds)):V.map.setMaxBounds(null)),V.map.fire("baselayerchange",o)}onGeolocationStatusChanged(t){i.active!==t&&this.#geolocationCircle&&(V.map.removeLayer(this.#geolocationCircle),this.#geolocationCircle=null)}onGeolocationPositionChanged(e){let o=t.geoLocation.zoomToPosition;this.#geolocationCircle&&(V.map.removeLayer(this.#geolocationCircle),o=!1),this.#geolocationCircle=window.L.circleMarker(window.L.latLng(e.coords.latitude,e.coords.longitude),t.geoLocation.marker).bindTooltip(E.formatLatLng([e.coords.latitude,e.coords.longitude])).addTo(V.map),o&&V.map.setView(window.L.latLng(e.coords.latitude,e.coords.longitude),t.geoLocation.zoomFactor)}}class uo{handleEvent(t){if(t.stopPropagation(),"Z"===t.key||"z"===t.key)(new Y).zoomToTravel();else if("G"===t.key||"g"===t.key)Q.switch();else{let e=t.key.charCodeAt(0);47<e&&58>e&&ot.setMapLayer(t.key)}}}class po{#travelUrl=null;#language=null;#addLayerToolbar=!1;#originAndPath=window.location.href.substr(0,window.location.href.lastIndexOf("/")+1)+"TravelNotes";static#mapEditorViewer=new co;#addEventsListeners(){document.addEventListener("keydown",new uo,!0),document.addEventListener("routeupdated",(t=>{t.data&&po.#mapEditorViewer.addRoute(t.data.addedRouteObjId)}),!1),document.addEventListener("noteupdated",(t=>{t.data&&po.#mapEditorViewer.addNote(t.data.addedNoteObjId)}),!1),document.addEventListener("zoomto",(t=>{t.data&&po.#mapEditorViewer.zoomTo(t.data.latLng,t.data.geometry)}),!1),document.addEventListener("layerchange",(t=>{t.data&&po.#mapEditorViewer.setLayer(t.data.layer,t.data.layer.url)})),document.addEventListener("geolocationpositionchanged",(t=>{t.data&&po.#mapEditorViewer.onGeolocationPositionChanged(t.data.position)}),!1),document.addEventListener("geolocationstatuschanged",(t=>{t.data&&po.#mapEditorViewer.onGeolocationStatusChanged(t.data.status)}),!1)}#readURL(){let t=new URL(window.location),e=t.searchParams.get("fil");if(e&&0!==e.length)try{if(e=atob(e),e.match(/[^\w-%:./]/))throw new Error("invalid char in the url encoded in the fil parameter");let o=new URL(e);if(!(t.protocol&&o.protocol&&t.protocol===o.protocol&&t.hostname&&o.hostname&&t.hostname===o.hostname))throw new Error("The distant file is not on the same site than the app");this.#travelUrl=encodeURI(o.href)}catch(t){t instanceof Error&&console.error(t)}let o=t.searchParams.get("lng");o&&o.match(/^[A-Z,a-z]{2}$/)&&(this.#language=o.toLowerCase()),""===t.searchParams.get("lay")&&(this.#addLayerToolbar=!0)}async#loadConfig(){let t=await fetch(this.#originAndPath+"Config.json");if(g===t.status&&t.ok){let e=await t.json();return e.travelNotes.language=this.#language||e.travelNotes.language,"wwwouaiebe.github.io"===window.location.hostname&&(e.note.haveBackground=!0),(new w).overload(e),!0}return!1}async#loadTranslations(){let t=await fetch(this.#originAndPath+this.#language.toUpperCase()+".json");return!(g!==t.status||!t.ok)&&(N.setTranslations(await t.json()),!0)}async#loadMapLayers(){let t=await fetch(this.#originAndPath+"Layers.json");return!(g!==t.status||!t.ok)&&(ot.addMapLayers(await t.json()),!0)}#loadTravelNotesViewer(){let t=document.createElement("div");t.id="TravelNotes-Map",document.body.appendChild(t),V.map=window.L.map("TravelNotes-Map",{attributionControl:!1,zoomControl:!1}),V.map.setView([s.defaultValue,s.defaultValue],2),it.addReadOnlyMap(this.#travelUrl,this.#addLayerToolbar)}constructor(){Object.seal(this)}async loadApp(){this.#readURL(),await this.#loadConfig()?(this.#language=this.#language||t.travelNotes.language,await this.#loadTranslations()?await this.#loadMapLayers()?(this.#addEventsListeners(),this.#loadTravelNotesViewer()):document.body.textContent="Not possible to load the TravelNotesLayers.json file. ":document.body.textContent="Not possible to load the TravelNotesConfig"+this.#language.toUpperCase()+".json file. "):document.body.textContent="Not possible to load the TravelNotesConfig.json file. "}}(new po).loadApp()}();